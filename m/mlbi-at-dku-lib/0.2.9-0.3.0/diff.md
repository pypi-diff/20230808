# Comparing `tmp/mlbi_at_dku_lib-0.2.9.tar.gz` & `tmp/mlbi_at_dku_lib-0.3.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "mlbi_at_dku_lib-0.2.9.tar", last modified: Wed Jul 12 11:54:52 2023, max compression
+gzip compressed data, was "mlbi_at_dku_lib-0.3.0.tar", last modified: Tue Aug  8 15:35:52 2023, max compression
```

## Comparing `mlbi_at_dku_lib-0.2.9.tar` & `mlbi_at_dku_lib-0.3.0.tar`

### file list

```diff
@@ -1,29 +1,29 @@
-drwxrwxr-x   0 syoon     (1001) syoon     (1001)        0 2023-07-12 11:54:52.523246 mlbi_at_dku_lib-0.2.9/
--rw-rw-r--   0 syoon     (1001) syoon     (1001)    35821 2023-07-02 05:13:01.000000 mlbi_at_dku_lib-0.2.9/LICENSE
--rw-rw-r--   0 syoon     (1001) syoon     (1001)      102 2023-07-02 06:59:42.000000 mlbi_at_dku_lib-0.2.9/MANIFEST.in
--rw-rw-r--   0 syoon     (1001) syoon     (1001)    41231 2023-07-12 11:54:52.523246 mlbi_at_dku_lib-0.2.9/PKG-INFO
--rw-rw-r--   0 syoon     (1001) syoon     (1001)      175 2023-07-02 05:13:01.000000 mlbi_at_dku_lib-0.2.9/README.md
--rw-rw-r--   0 syoon     (1001) syoon     (1001)      827 2023-07-12 11:49:16.000000 mlbi_at_dku_lib-0.2.9/pyproject.toml
--rw-rw-r--   0 syoon     (1001) syoon     (1001)       38 2023-07-12 11:54:52.523246 mlbi_at_dku_lib-0.2.9/setup.cfg
--rw-rw-r--   0 syoon     (1001) syoon     (1001)       49 2023-07-02 05:17:52.000000 mlbi_at_dku_lib-0.2.9/setup.py
-drwxrwxr-x   0 syoon     (1001) syoon     (1001)        0 2023-07-12 11:54:52.459248 mlbi_at_dku_lib-0.2.9/src/
-drwxrwxr-x   0 syoon     (1001) syoon     (1001)        0 2023-07-12 11:54:52.459248 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/
--rw-rw-r--   0 syoon     (1001) syoon     (1001)      163 2023-07-02 05:13:02.000000 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/__init__.py
--rw-rw-r--   0 syoon     (1001) syoon     (1001)    21388 2023-07-12 11:45:27.000000 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/cpdb.py
-drwxrwxr-x   0 syoon     (1001) syoon     (1001)        0 2023-07-12 11:54:52.511247 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/data/
--rw-rw-r--   0 syoon     (1001) syoon     (1001) 20978082 2023-07-02 05:45:36.000000 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/data/GTmap_hg19.csv
--rw-rw-r--   0 syoon     (1001) syoon     (1001) 22541574 2023-07-02 05:45:36.000000 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/data/GTmap_hg38.csv
--rw-rw-r--   0 syoon     (1001) syoon     (1001) 11979098 2023-07-02 05:45:36.000000 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/data/GTmap_mm10.csv
--rw-rw-r--   0 syoon     (1001) syoon     (1001)    14644 2023-07-11 14:20:18.000000 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/deg.py
--rw-rw-r--   0 syoon     (1001) syoon     (1001)     6033 2023-07-11 04:52:53.000000 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/deiso.py
--rw-rw-r--   0 syoon     (1001) syoon     (1001)    12716 2023-07-02 05:13:02.000000 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/gsea.py
--rw-rw-r--   0 syoon     (1001) syoon     (1001)   157732 2023-07-12 11:53:08.000000 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/hicat.py
--rw-rw-r--   0 syoon     (1001) syoon     (1001)    36606 2023-07-12 11:49:13.000000 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/icnv.py
--rw-rw-r--   0 syoon     (1001) syoon     (1001)    30776 2023-07-11 14:11:49.000000 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/misc.py
-drwxrwxr-x   0 syoon     (1001) syoon     (1001)        0 2023-07-12 11:54:52.459248 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib.egg-info/
--rw-rw-r--   0 syoon     (1001) syoon     (1001)    41231 2023-07-12 11:54:52.000000 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib.egg-info/PKG-INFO
--rw-rw-r--   0 syoon     (1001) syoon     (1001)      662 2023-07-12 11:54:52.000000 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib.egg-info/SOURCES.txt
--rw-rw-r--   0 syoon     (1001) syoon     (1001)        1 2023-07-12 11:54:52.000000 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib.egg-info/dependency_links.txt
--rw-rw-r--   0 syoon     (1001) syoon     (1001)       52 2023-07-12 11:54:52.000000 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib.egg-info/entry_points.txt
--rw-rw-r--   0 syoon     (1001) syoon     (1001)       54 2023-07-12 11:54:52.000000 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib.egg-info/requires.txt
--rw-rw-r--   0 syoon     (1001) syoon     (1001)       16 2023-07-12 11:54:52.000000 mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib.egg-info/top_level.txt
+drwxrwxr-x   0 syoon     (1001) syoon     (1001)        0 2023-08-08 15:35:52.438177 mlbi_at_dku_lib-0.3.0/
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)    35821 2023-07-02 05:13:01.000000 mlbi_at_dku_lib-0.3.0/LICENSE
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)      102 2023-07-02 06:59:42.000000 mlbi_at_dku_lib-0.3.0/MANIFEST.in
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)    41231 2023-08-08 15:35:52.438177 mlbi_at_dku_lib-0.3.0/PKG-INFO
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)      175 2023-07-02 05:13:01.000000 mlbi_at_dku_lib-0.3.0/README.md
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)      827 2023-08-08 15:35:28.000000 mlbi_at_dku_lib-0.3.0/pyproject.toml
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)       38 2023-08-08 15:35:52.438177 mlbi_at_dku_lib-0.3.0/setup.cfg
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)       49 2023-07-02 05:17:52.000000 mlbi_at_dku_lib-0.3.0/setup.py
+drwxrwxr-x   0 syoon     (1001) syoon     (1001)        0 2023-08-08 15:35:52.374179 mlbi_at_dku_lib-0.3.0/src/
+drwxrwxr-x   0 syoon     (1001) syoon     (1001)        0 2023-08-08 15:35:52.374179 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)      163 2023-07-02 05:13:02.000000 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/__init__.py
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)    21388 2023-07-12 11:45:27.000000 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/cpdb.py
+drwxrwxr-x   0 syoon     (1001) syoon     (1001)        0 2023-08-08 15:35:52.426178 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/data/
+-rw-rw-r--   0 syoon     (1001) syoon     (1001) 20978082 2023-07-02 05:45:36.000000 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/data/GTmap_hg19.csv
+-rw-rw-r--   0 syoon     (1001) syoon     (1001) 22541574 2023-07-02 05:45:36.000000 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/data/GTmap_hg38.csv
+-rw-rw-r--   0 syoon     (1001) syoon     (1001) 11979098 2023-07-02 05:45:36.000000 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/data/GTmap_mm10.csv
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)    14747 2023-07-13 16:58:06.000000 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/deg.py
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)    10966 2023-08-08 15:33:37.000000 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/deiso.py
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)    12716 2023-07-02 05:13:02.000000 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/gsea.py
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)   157995 2023-07-14 18:22:21.000000 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/hicat.py
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)    36606 2023-07-12 11:49:13.000000 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/icnv.py
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)    30776 2023-07-11 14:11:49.000000 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/misc.py
+drwxrwxr-x   0 syoon     (1001) syoon     (1001)        0 2023-08-08 15:35:52.374179 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib.egg-info/
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)    41231 2023-08-08 15:35:52.000000 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib.egg-info/PKG-INFO
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)      662 2023-08-08 15:35:52.000000 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib.egg-info/SOURCES.txt
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)        1 2023-08-08 15:35:52.000000 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib.egg-info/dependency_links.txt
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)       52 2023-08-08 15:35:52.000000 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib.egg-info/entry_points.txt
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)       54 2023-08-08 15:35:52.000000 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib.egg-info/requires.txt
+-rw-rw-r--   0 syoon     (1001) syoon     (1001)       16 2023-08-08 15:35:52.000000 mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib.egg-info/top_level.txt
```

### Comparing `mlbi_at_dku_lib-0.2.9/LICENSE` & `mlbi_at_dku_lib-0.3.0/LICENSE`

 * *Files identical despite different names*

### Comparing `mlbi_at_dku_lib-0.2.9/PKG-INFO` & `mlbi_at_dku_lib-0.3.0/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: mlbi_at_dku_lib
-Version: 0.2.9
+Version: 0.3.0
 Summary: Toolkits for single-cell RNA-Seq data analysis. (Wrapper functions for CellPhoneDB, GSEApy and InferCNVpy)
 Author-email: Seokhyun Yoon <syoon@dku.edu>
 License:                     GNU GENERAL PUBLIC LICENSE
                                Version 3, 29 June 2007
         
          Copyright (C) 2007 Free Software Foundation, Inc. <https://fsf.org/>
          Everyone is permitted to copy and distribute verbatim copies
```

### Comparing `mlbi_at_dku_lib-0.2.9/pyproject.toml` & `mlbi_at_dku_lib-0.3.0/pyproject.toml`

 * *Files 2% similar despite different names*

```diff
@@ -2,15 +2,15 @@
 
 [build-system]
 requires      = ["setuptools>=61.0.0", "wheel"]
 build-backend = "setuptools.build_meta"
 
 [project]
 name = "mlbi_at_dku_lib"
-version = "0.2.9"
+version = "0.3.0"
 description = "Toolkits for single-cell RNA-Seq data analysis. (Wrapper functions for CellPhoneDB, GSEApy and InferCNVpy)"
 readme = "README.md"
 authors = [{ name = "Seokhyun Yoon", email = "syoon@dku.edu" }]
 license = { file = "LICENSE" }
 classifiers = [
     "Programming Language :: Python",
     "Programming Language :: Python :: 3",
```

### Comparing `mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/cpdb.py` & `mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/cpdb.py`

 * *Files identical despite different names*

### Comparing `mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/data/GTmap_hg19.csv` & `mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/data/GTmap_hg19.csv`

 * *Files identical despite different names*

### Comparing `mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/data/GTmap_hg38.csv` & `mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/data/GTmap_hg38.csv`

 * *Files identical despite different names*

### Comparing `mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/data/GTmap_mm10.csv` & `mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/data/GTmap_mm10.csv`

 * *Files identical despite different names*

### Comparing `mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/deg.py` & `mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/deg.py`

 * *Files 2% similar despite different names*

```diff
@@ -271,15 +271,15 @@
 
 
 ######## DEG ##########
 
 MIN_VALUE = 1e-10
 MIN_VALUE_EF = 1e-10
 
-def perform_deg( df_cbyg_in, groups, target_group, min_ef = 0.05, exp_only = False ):
+def perform_deg( df_cbyg_in, groups, target_group, n = 2, min_ef = 0.05, exp_only = False ):
     
     # b = groups == ref_group
     b = groups != target_group
     
     b1 = (df_cbyg_in.loc[~b,:] > 0).mean(axis = 0) >= min_ef 
     b2 = (df_cbyg_in.loc[b,:] > 0).mean(axis = 0) >= min_ef 
     bx = b1 | b2
@@ -287,21 +287,23 @@
     
     g_mec_ref = (df_cbyg.loc[b,:] > 0).mean(axis = 0)
     g_mec_test = (df_cbyg.loc[~b,:] > 0).mean(axis = 0)
     
     eft = (g_mec_test)
     efr = (g_mec_ref)
     efc = (eft + MIN_VALUE_EF)/(efr + MIN_VALUE_EF)
+    score = (eft)*((1-efr)**n)
     
     df = pd.DataFrame(index = df_cbyg.columns)
     
-    df['EFC'] = list(efc)
-    df['log10_EFC'] = list(np.round(np.log10(efc), 3))
     df['EF_test'] = list(eft)
     df['EF_ref'] = list(efr)
+    df['EFR'] = list(efc)
+    df['EFS'] = list(score)
+    # df['log10_EFC'] = list(np.round(np.log10(efc), 3))
     # df['Score'] = df['log10_EFC']*(np.sum(~b)*eft + np.sum(b)*efr)
         
     #'''
     g_mean_ref = df_cbyg.loc[b,:].mean(axis = 0)
     g_mean_test = df_cbyg.loc[~b,:].mean(axis = 0)
     g_std_ref = df_cbyg.loc[b,:].std(axis = 0)
     g_std_test = df_cbyg.loc[~b,:].std(axis = 0)
@@ -313,19 +315,19 @@
         g_std_test = g_std_test/np.sqrt(eft + MIN_VALUE)
     
     # fc = (g_mean_test + MIN_VALUE)/(g_mean_ref + MIN_VALUE)
     fc = (np.expm1(g_mean_test) + MIN_VALUE)/(np.expm1(g_mean_ref) + MIN_VALUE)
     stat = np.abs(g_mean_test - g_mean_ref)
     
     if exp_only: 
-        stat = stat/((g_std_ref/np.sqrt(np.sum(b)*efr + MIN_VALUE)) \
-                    + g_std_test/np.sqrt(np.sum(~b)*eft + MIN_VALUE))
+        stat = stat/( MIN_VALUE + g_std_ref/(np.sqrt(np.sum(b)*efr) + MIN_VALUE) \
+                    + g_std_test/(np.sqrt(np.sum(~b)*eft) + MIN_VALUE) )
     else:
-        stat = stat/(g_std_ref/np.sqrt(np.sum(b) + MIN_VALUE) \
-                   + g_std_test/np.sqrt(np.sum(~b) + MIN_VALUE))
+        stat = stat/( MIN_VALUE + g_std_ref/(np.sqrt(np.sum(b)) + MIN_VALUE) \
+                    + g_std_test/(np.sqrt(np.sum(~b)) + MIN_VALUE) )
         
     df['mean_test'] = list(g_mean_test)
     df['mean_ref'] = list(g_mean_ref)
     df['log2_FC'] = list(np.round(np.log2(fc), 3))
     
     if exp_only:
         pv = stats.t.sf(stat*np.sqrt(2), df = (np.sum(b)*efr + np.sum(~b)*eft)-2)*2
@@ -335,15 +337,15 @@
     pv = pv 
         
     pv_adj = pv * df_cbyg.shape[1]
     df['pval'] = list(pv)
     df['pval_adj'] = list(pv_adj)
     df['pval_adj'].clip(upper = 1, inplace = True)
     #'''
-    df = df.sort_values(by = 'EFC', ascending = False)
+    df = df.sort_values(by = 'EFR', ascending = False)
         
     return df
 
 
 def deg_multi( df_cbyg_in, groups_in, ref_group = None, samples_in = None,
                min_ef = 0.05, exp_only = False, min_frac = 0.1 ):
```

### Comparing `mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/gsea.py` & `mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/gsea.py`

 * *Files identical despite different names*

### Comparing `mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/hicat.py` & `mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/hicat.py`

 * *Files 0% similar despite different names*

```diff
@@ -1064,16 +1064,16 @@
 00004270: 2c20 666c 7573 6820 3d20 5472 7565 290a  , flush = True).
 00004280: 2020 2020 6466 203d 206c 6f61 645f 6d61      df = load_ma
 00004290: 726b 6572 5f66 696c 6528 2066 696c 6520  rker_file( file 
 000042a0: 290a 2020 2020 0a20 2020 2069 6620 7461  ).    .    if ta
 000042b0: 7267 6574 5f63 656c 6c73 2069 7320 4e6f  rget_cells is No
 000042c0: 6e65 3a0a 2020 2020 2020 2020 7461 7267  ne:.        targ
 000042d0: 6574 5f63 656c 6c73 203d 206c 6973 7428  et_cells = list(
-000042e0: 6466 5b27 6365 6c6c 5f74 7970 655f 6d61  df['cell_type_ma
-000042f0: 6a6f 7227 5d2e 756e 6971 7565 2829 290a  jor'].unique()).
+000042e0: 6466 5b27 6365 6c6c 5f74 7970 655f 6d69  df['cell_type_mi
+000042f0: 6e6f 7227 5d2e 756e 6971 7565 2829 290a  nor'].unique()).
 00004300: 2020 2020 656c 6966 206c 656e 2874 6172      elif len(tar
 00004310: 6765 745f 6365 6c6c 7329 203d 3d20 303a  get_cells) == 0:
 00004320: 0a20 2020 2020 2020 2074 6172 6765 745f  .        target_
 00004330: 6365 6c6c 7320 3d20 6c69 7374 2864 665b  cells = list(df[
 00004340: 2763 656c 6c5f 7479 7065 5f6d 696e 6f72  'cell_type_minor
 00004350: 275d 2e75 6e69 7175 6528 2929 0a20 2020  '].unique()).   
 00004360: 2065 6c73 653a 0a20 2020 2020 2020 2023   else:.        #
@@ -1186,8674 +1186,8690 @@
 00004a10: 2573 2720 2520 286b 6579 2c20 6c65 6e28  %s' % (key, len(
 00004a20: 6d6b 725f 6c73 745f 6469 6374 5b6b 6579  mkr_lst_dict[key
 00004a30: 5d29 2c20 7329 290a 2020 2020 2020 2020  ]), s)).        
 00004a40: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
 00004a50: 2020 7072 696e 7428 2725 7320 2825 6929    print('%s (%i)
 00004a60: 3a20 2720 2520 286b 6579 2c20 6c65 6e28  : ' % (key, len(
 00004a70: 6d6b 725f 6c73 745f 6469 6374 5b6b 6579  mkr_lst_dict[key
-00004a80: 5d29 2929 0a0a 2020 2020 2020 2020 2020  ])))..          
-00004a90: 2020 0a64 6566 206c 6f61 645f 6d61 726b    .def load_mark
-00004aa0: 6572 735f 616c 6c28 6669 6c65 2c20 7461  ers_all(file, ta
-00004ab0: 7267 6574 5f63 656c 6c73 203d 205b 5d2c  rget_cells = [],
-00004ac0: 2070 6e73 6831 3220 3d20 2731 3131 3131   pnsh12 = '11111
-00004ad0: 3127 2c20 636f 6d62 5f6d 6b72 7320 3d20  1', comb_mkrs = 
-00004ae0: 5472 7565 2c20 2076 6572 626f 7365 203d  True,  verbose =
-00004af0: 2046 616c 7365 293a 0a20 2020 200a 2020   False):.    .  
-00004b00: 2020 6966 2076 6572 626f 7365 3a20 7072    if verbose: pr
-00004b10: 696e 7428 274c 6f61 6420 6d61 726b 6572  int('Load marker
-00004b20: 7320 2e2e 2027 2c20 656e 6420 3d20 2727  s .. ', end = ''
-00004b30: 2c20 666c 7573 6820 3d20 5472 7565 290a  , flush = True).
-00004b40: 2020 2020 6466 203d 206c 6f61 645f 6d61      df = load_ma
-00004b50: 726b 6572 5f66 696c 6528 2066 696c 6520  rker_file( file 
-00004b60: 290a 2020 2020 0a20 2020 2069 6620 6c65  ).    .    if le
-00004b70: 6e28 7461 7267 6574 5f63 656c 6c73 2920  n(target_cells) 
-00004b80: 3d3d 2030 3a0a 2020 2020 2020 2020 7461  == 0:.        ta
-00004b90: 7267 6574 5f63 656c 6c73 203d 206c 6973  rget_cells = lis
-00004ba0: 7428 6466 5b27 6365 6c6c 5f74 7970 655f  t(df['cell_type_
-00004bb0: 6d61 6a6f 7227 5d2e 756e 6971 7565 2829  major'].unique()
-00004bc0: 290a 2020 2020 0a20 2020 206d 616a 6f72  ).    .    major
-00004bd0: 5f74 7970 655f 6c73 7420 3d20 6c69 7374  _type_lst = list
-00004be0: 2864 665b 2763 656c 6c5f 7479 7065 5f6d  (df['cell_type_m
-00004bf0: 616a 6f72 275d 2e75 6e69 7175 6528 2929  ajor'].unique())
-00004c00: 0a20 2020 200a 2020 2020 6d6b 725f 6c73  .    .    mkr_ls
-00004c10: 7420 3d20 7b7d 0a20 2020 206d 6b72 5f6c  t = {}.    mkr_l
-00004c20: 7374 5f6e 6567 203d 207b 7d0a 2020 2020  st_neg = {}.    
-00004c30: 6d6b 725f 6c73 745f 7365 6320 3d20 7b7d  mkr_lst_sec = {}
-00004c40: 0a20 2020 206d 616a 6f72 5f64 6963 7420  .    major_dict 
-00004c50: 3d20 7b7d 0a20 2020 206d 696e 6f72 5f64  = {}.    minor_d
-00004c60: 6963 7420 3d20 7b7d 0a20 2020 2070 6e73  ict = {}.    pns
-00004c70: 6831 325f 7420 3d20 2725 7330 3025 7327  h12_t = '%s00%s'
-00004c80: 2025 2028 706e 7368 3132 5b30 5d2c 2070   % (pnsh12[0], p
-00004c90: 6e73 6831 325b 333a 5d29 0a20 2020 2066  nsh12[3:]).    f
-00004ca0: 6f72 2063 2069 6e20 7461 7267 6574 5f63  or c in target_c
-00004cb0: 656c 6c73 3a0a 2020 2020 2020 2020 6966  ells:.        if
-00004cc0: 2063 2069 6e20 6d61 6a6f 725f 7479 7065   c in major_type
-00004cd0: 5f6c 7374 3a0a 2020 2020 2020 2020 2020  _lst:.          
-00004ce0: 2020 6220 3d20 6466 5b27 6365 6c6c 5f74    b = df['cell_t
-00004cf0: 7970 655f 6d61 6a6f 7227 5d20 3d3d 2063  ype_major'] == c
-00004d00: 0a20 2020 2020 2020 2020 2020 2063 656c  .            cel
-00004d10: 6c5f 7479 7065 5f6c 7374 203d 206c 6973  l_type_lst = lis
-00004d20: 7428 6466 2e6c 6f63 5b62 2c20 2763 656c  t(df.loc[b, 'cel
-00004d30: 6c5f 7479 7065 5f6d 696e 6f72 275d 2e75  l_type_minor'].u
-00004d40: 6e69 7175 6528 2929 0a20 2020 2020 2020  nique()).       
-00004d50: 2020 2020 2066 6f72 2063 3220 696e 2063       for c2 in c
-00004d60: 656c 6c5f 7479 7065 5f6c 7374 3a0a 2020  ell_type_lst:.  
-00004d70: 2020 2020 2020 2020 2020 2020 2020 6d6b                mk
-00004d80: 7273 203d 2067 6574 5f6d 6172 6b65 7273  rs = get_markers
-00004d90: 5f66 726f 6d5f 6466 2864 662c 205b 6332  _from_df(df, [c2
-00004da0: 5d2c 2070 6e73 6831 3220 3d20 706e 7368  ], pnsh12 = pnsh
-00004db0: 3132 5f74 2c20 7665 7262 6f73 6520 3d20  12_t, verbose = 
-00004dc0: 7665 7262 6f73 6529 0a20 2020 2020 2020  verbose).       
-00004dd0: 2020 2020 2020 2020 206d 6b72 5f6c 7374           mkr_lst
-00004de0: 2e75 7064 6174 6528 6d6b 7273 290a 0a20  .update(mkrs).. 
-00004df0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00004e00: 6620 706e 7368 3132 5b31 5d20 3d3d 2027  f pnsh12[1] == '
-00004e10: 3127 3a0a 2020 2020 2020 2020 2020 2020  1':.            
-00004e20: 2020 2020 2020 2020 706e 7368 3132 5f6e          pnsh12_n
-00004e30: 203d 2027 3031 3025 7327 2025 2028 706e   = '010%s' % (pn
-00004e40: 7368 3132 5b33 3a5d 290a 2020 2020 2020  sh12[3:]).      
-00004e50: 2020 2020 2020 2020 2020 2020 2020 6d6b                mk
-00004e60: 7273 5f6e 6567 203d 2067 6574 5f6d 6172  rs_neg = get_mar
-00004e70: 6b65 7273 5f66 726f 6d5f 6466 2864 662c  kers_from_df(df,
-00004e80: 205b 6332 5d2c 2070 6e73 6831 3220 3d70   [c2], pnsh12 =p
-00004e90: 6e73 6831 325f 6e2c 2076 6572 626f 7365  nsh12_n, verbose
-00004ea0: 203d 2076 6572 626f 7365 290a 2020 2020   = verbose).    
-00004eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004ec0: 6d6b 725f 6c73 745f 6e65 672e 7570 6461  mkr_lst_neg.upda
-00004ed0: 7465 286d 6b72 735f 6e65 6729 0a20 2020  te(mkrs_neg).   
-00004ee0: 2020 2020 2020 2020 2020 2020 200a 2020               .  
-00004ef0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00004f00: 2070 6e73 6831 325b 325d 203d 3d20 2731   pnsh12[2] == '1
-00004f10: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
-00004f20: 2020 2020 2020 2070 6e73 6831 325f 6e20         pnsh12_n 
-00004f30: 3d20 2730 3031 2573 2720 2520 2870 6e73  = '001%s' % (pns
-00004f40: 6831 325b 333a 5d29 0a20 2020 2020 2020  h12[3:]).       
-00004f50: 2020 2020 2020 2020 2020 2020 206d 6b72               mkr
-00004f60: 735f 7365 6320 3d20 6765 745f 6d61 726b  s_sec = get_mark
-00004f70: 6572 735f 6672 6f6d 5f64 6628 6466 2c20  ers_from_df(df, 
-00004f80: 5b63 325d 2c20 706e 7368 3132 203d 706e  [c2], pnsh12 =pn
-00004f90: 7368 3132 5f6e 2c20 7665 7262 6f73 6520  sh12_n, verbose 
-00004fa0: 3d20 7665 7262 6f73 6529 0a20 2020 2020  = verbose).     
-00004fb0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00004fc0: 6b72 5f6c 7374 5f73 6563 2e75 7064 6174  kr_lst_sec.updat
-00004fd0: 6528 6d6b 7273 5f73 6563 290a 2020 2020  e(mkrs_sec).    
-00004fe0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-00004ff0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00005000: 206b 6579 2069 6e20 6d6b 7273 2e6b 6579   key in mkrs.key
-00005010: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00005020: 2020 2020 2020 2020 206d 696e 6f72 5f64           minor_d
-00005030: 6963 745b 6b65 795d 203d 2063 320a 2020  ict[key] = c2.  
-00005040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005050: 2020 6d61 6a6f 725f 6469 6374 5b6b 6579    major_dict[key
-00005060: 5d20 3d20 630a 2020 2020 2020 2020 2020  ] = c.          
-00005070: 2020 0a20 2020 2069 6620 6c65 6e28 6d6b    .    if len(mk
-00005080: 725f 6c73 742e 6b65 7973 2829 2920 3d3d  r_lst.keys()) ==
-00005090: 2030 3a0a 2020 2020 2020 2020 7265 7475   0:.        retu
-000050a0: 726e 206d 6b72 5f6c 7374 2c20 6d6b 725f  rn mkr_lst, mkr_
-000050b0: 6c73 745f 6e65 672c 206d 6b72 5f6c 7374  lst_neg, mkr_lst
-000050c0: 5f73 6563 0a0a 2020 2020 6966 2063 6f6d  _sec..    if com
-000050d0: 625f 6d6b 7273 3a0a 2020 2020 2020 2020  b_mkrs:.        
-000050e0: 6d6b 725f 6c73 742c 206d 616a 6f72 5f64  mkr_lst, major_d
-000050f0: 6963 742c 206d 696e 6f72 5f64 6963 7420  ict, minor_dict 
-00005100: 3d20 636f 6d62 5f6d 6172 6b65 7273 286d  = comb_markers(m
-00005110: 6b72 5f6c 7374 2c20 6d61 6a6f 725f 6469  kr_lst, major_di
-00005120: 6374 2c20 6d69 6e6f 725f 6469 6374 290a  ct, minor_dict).
-00005130: 2020 2020 2020 2020 6d6b 725f 6c73 745f          mkr_lst_
-00005140: 6e65 6720 3d20 636f 6d62 5f6d 6172 6b65  neg = comb_marke
-00005150: 7273 286d 6b72 5f6c 7374 5f6e 6567 290a  rs(mkr_lst_neg).
-00005160: 2020 2020 2020 2020 6d6b 725f 6c73 745f          mkr_lst_
-00005170: 7365 6320 3d20 636f 6d62 5f6d 6172 6b65  sec = comb_marke
-00005180: 7273 286d 6b72 5f6c 7374 5f73 6563 290a  rs(mkr_lst_sec).
-00005190: 0a20 2020 2073 6d20 3d20 2727 0a20 2020  .    sm = ''.   
-000051a0: 2063 656c 6c5f 7479 7065 7320 3d20 6c69   cell_types = li
-000051b0: 7374 286d 6b72 5f6c 7374 2e6b 6579 7328  st(mkr_lst.keys(
-000051c0: 2929 0a20 2020 2063 656c 6c5f 7479 7065  )).    cell_type
-000051d0: 732e 736f 7274 2829 0a20 2020 2066 6f72  s.sort().    for
-000051e0: 206b 6579 2069 6e20 6365 6c6c 5f74 7970   key in cell_typ
-000051f0: 6573 3a0a 2020 2020 2020 2020 736d 203d  es:.        sm =
-00005200: 2073 6d20 2b20 2725 732c 2720 2520 6b65   sm + '%s,' % ke
-00005210: 790a 2020 2020 2020 2020 0a20 2020 2069  y.        .    i
-00005220: 6620 7665 7262 6f73 653a 2070 7269 6e74  f verbose: print
-00005230: 2827 2025 6920 7479 7065 732e 205c 6e25  (' %i types. \n%
-00005240: 7327 2025 2028 6c65 6e28 6d6b 725f 6c73  s' % (len(mkr_ls
-00005250: 742e 6b65 7973 2829 292c 2073 6d5b 3a2d  t.keys()), sm[:-
-00005260: 315d 2929 0a20 2020 2020 2020 200a 2020  1])).        .  
-00005270: 2020 7265 7475 726e 206d 6b72 5f6c 7374    return mkr_lst
-00005280: 2c20 6d6b 725f 6c73 745f 6e65 672c 206d  , mkr_lst_neg, m
-00005290: 6b72 5f6c 7374 5f73 6563 2c20 6d61 6a6f  kr_lst_sec, majo
-000052a0: 725f 6469 6374 2c20 6d69 6e6f 725f 6469  r_dict, minor_di
-000052b0: 6374 0a0a 0a64 6566 2073 6176 655f 6d61  ct...def save_ma
-000052c0: 726b 6572 735f 616c 6c28 6d6b 725f 6c73  rkers_all(mkr_ls
-000052d0: 742c 206d 6b72 5f6c 7374 5f6e 6567 2c20  t, mkr_lst_neg, 
-000052e0: 6d6b 725f 6c73 745f 7365 632c 206d 616a  mkr_lst_sec, maj
-000052f0: 6f72 5f64 6963 742c 206d 696e 6f72 5f64  or_dict, minor_d
-00005300: 6963 742c 2066 696c 6529 3a0a 2020 2020  ict, file):.    
-00005310: 0a20 2020 2063 6f6c 7320 3d20 5b27 6365  .    cols = ['ce
-00005320: 6c6c 5f74 7970 655f 6d61 6a6f 7227 2c20  ll_type_major', 
-00005330: 2763 656c 6c5f 7479 7065 5f6d 696e 6f72  'cell_type_minor
-00005340: 272c 2027 6365 6c6c 5f74 7970 655f 7375  ', 'cell_type_su
-00005350: 6273 6574 272c 2027 6578 7027 2c20 276d  bset', 'exp', 'm
-00005360: 6172 6b65 7273 275d 200a 2020 2020 6466  arkers'] .    df
-00005370: 5f70 6f73 203d 2070 642e 4461 7461 4672  _pos = pd.DataFr
-00005380: 616d 6528 636f 6c75 6d6e 7320 3d20 636f  ame(columns = co
-00005390: 6c73 290a 2020 2020 6466 5f6e 6567 203d  ls).    df_neg =
-000053a0: 2070 642e 4461 7461 4672 616d 6528 636f   pd.DataFrame(co
-000053b0: 6c75 6d6e 7320 3d20 636f 6c73 290a 2020  lumns = cols).  
-000053c0: 2020 6466 5f73 6563 203d 2070 642e 4461    df_sec = pd.Da
-000053d0: 7461 4672 616d 6528 636f 6c75 6d6e 7320  taFrame(columns 
-000053e0: 3d20 636f 6c73 290a 0a20 2020 206d 6b72  = cols)..    mkr
-000053f0: 5f6c 7374 5f74 6d70 203d 206d 6b72 5f6c  _lst_tmp = mkr_l
-00005400: 7374 0a20 2020 2063 745f 6c73 7420 3d20  st.    ct_lst = 
-00005410: 6c69 7374 286d 6b72 5f6c 7374 5f74 6d70  list(mkr_lst_tmp
-00005420: 2e6b 6579 7328 2929 0a20 2020 206d 6b72  .keys()).    mkr
-00005430: 7320 3d20 5b5d 0a20 2020 2063 745f 6c73  s = [].    ct_ls
-00005440: 745f 6e65 7720 3d20 5b5d 0a20 2020 2066  t_new = [].    f
-00005450: 6f72 2063 2069 6e20 6374 5f6c 7374 3a0a  or c in ct_lst:.
-00005460: 2020 2020 2020 2020 6966 206c 656e 286d          if len(m
-00005470: 6b72 5f6c 7374 5f74 6d70 5b63 5d29 203e  kr_lst_tmp[c]) >
-00005480: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00005490: 6d6b 725f 6c73 745f 746d 705b 635d 2e73  mkr_lst_tmp[c].s
-000054a0: 6f72 7428 290a 2020 2020 2020 2020 2020  ort().          
-000054b0: 2020 7320 3d20 6d6b 725f 6c73 745f 746d    s = mkr_lst_tm
-000054c0: 705b 635d 5b30 5d0a 2020 2020 2020 2020  p[c][0].        
-000054d0: 2020 2020 6966 206c 656e 286d 6b72 5f6c      if len(mkr_l
-000054e0: 7374 5f74 6d70 5b63 5d29 203e 2031 3a0a  st_tmp[c]) > 1:.
-000054f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005500: 666f 7220 6d6b 7220 696e 206d 6b72 5f6c  for mkr in mkr_l
-00005510: 7374 5f74 6d70 5b63 5d5b 313a 5d3a 0a20  st_tmp[c][1:]:. 
-00005520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005530: 2020 2073 203d 2073 202b 2027 2c25 7327     s = s + ',%s'
-00005540: 2025 206d 6b72 0a20 2020 2020 2020 2020   % mkr.         
-00005550: 2020 206d 6b72 732e 6170 7065 6e64 2873     mkrs.append(s
-00005560: 290a 2020 2020 2020 2020 2020 2020 6374  ).            ct
-00005570: 5f6c 7374 5f6e 6577 2e61 7070 656e 6428  _lst_new.append(
-00005580: 6329 0a20 2020 200a 2020 2020 6466 5f70  c).    .    df_p
-00005590: 6f73 5b27 6365 6c6c 5f74 7970 655f 7375  os['cell_type_su
-000055a0: 6273 6574 275d 203d 2063 745f 6c73 745f  bset'] = ct_lst_
-000055b0: 6e65 770a 2020 2020 6466 5f70 6f73 5b27  new.    df_pos['
-000055c0: 6d61 726b 6572 7327 5d20 3d20 6d6b 7273  markers'] = mkrs
-000055d0: 0a20 2020 2064 665f 706f 735b 2765 7870  .    df_pos['exp
-000055e0: 275d 203d 205b 2770 6f73 275d 2a6c 656e  '] = ['pos']*len
-000055f0: 286d 6b72 7329 0a20 2020 200a 2020 2020  (mkrs).    .    
-00005600: 6d6b 725f 6c73 745f 746d 7020 3d20 6d6b  mkr_lst_tmp = mk
-00005610: 725f 6c73 745f 6e65 670a 2020 2020 6374  r_lst_neg.    ct
-00005620: 5f6c 7374 203d 206c 6973 7428 6d6b 725f  _lst = list(mkr_
-00005630: 6c73 745f 746d 702e 6b65 7973 2829 290a  lst_tmp.keys()).
-00005640: 2020 2020 6d6b 7273 203d 205b 5d0a 2020      mkrs = [].  
-00005650: 2020 6374 5f6c 7374 5f6e 6577 203d 205b    ct_lst_new = [
-00005660: 5d0a 2020 2020 666f 7220 6320 696e 2063  ].    for c in c
-00005670: 745f 6c73 743a 0a20 2020 2020 2020 2069  t_lst:.        i
-00005680: 6620 6c65 6e28 6d6b 725f 6c73 745f 746d  f len(mkr_lst_tm
-00005690: 705b 635d 2920 3e20 303a 0a20 2020 2020  p[c]) > 0:.     
-000056a0: 2020 2020 2020 206d 6b72 5f6c 7374 5f74         mkr_lst_t
-000056b0: 6d70 5b63 5d2e 736f 7274 2829 0a20 2020  mp[c].sort().   
-000056c0: 2020 2020 2020 2020 2073 203d 206d 6b72           s = mkr
-000056d0: 5f6c 7374 5f74 6d70 5b63 5d5b 305d 0a20  _lst_tmp[c][0]. 
-000056e0: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-000056f0: 6e28 6d6b 725f 6c73 745f 746d 705b 635d  n(mkr_lst_tmp[c]
-00005700: 2920 3e20 313a 0a20 2020 2020 2020 2020  ) > 1:.         
-00005710: 2020 2020 2020 2066 6f72 206d 6b72 2069         for mkr i
-00005720: 6e20 6d6b 725f 6c73 745f 746d 705b 635d  n mkr_lst_tmp[c]
-00005730: 5b31 3a5d 3a0a 2020 2020 2020 2020 2020  [1:]:.          
-00005740: 2020 2020 2020 2020 2020 7320 3d20 7320            s = s 
-00005750: 2b20 272c 2573 2720 2520 6d6b 720a 2020  + ',%s' % mkr.  
-00005760: 2020 2020 2020 2020 2020 6d6b 7273 2e61            mkrs.a
-00005770: 7070 656e 6428 7329 0a20 2020 2020 2020  ppend(s).       
-00005780: 2020 2020 2063 745f 6c73 745f 6e65 772e       ct_lst_new.
-00005790: 6170 7065 6e64 2863 290a 2020 2020 2020  append(c).      
-000057a0: 2020 2020 2020 0a20 2020 200a 2020 2020        .    .    
-000057b0: 6466 5f6e 6567 5b27 6365 6c6c 5f74 7970  df_neg['cell_typ
-000057c0: 655f 7375 6273 6574 275d 203d 2063 745f  e_subset'] = ct_
-000057d0: 6c73 745f 6e65 770a 2020 2020 6466 5f6e  lst_new.    df_n
-000057e0: 6567 5b27 6d61 726b 6572 7327 5d20 3d20  eg['markers'] = 
-000057f0: 6d6b 7273 0a20 2020 2064 665f 6e65 675b  mkrs.    df_neg[
-00005800: 2765 7870 275d 203d 205b 276e 6567 275d  'exp'] = ['neg']
-00005810: 2a6c 656e 286d 6b72 7329 0a20 2020 200a  *len(mkrs).    .
-00005820: 2020 2020 6466 203d 2070 642e 636f 6e63      df = pd.conc
-00005830: 6174 285b 6466 5f70 6f73 2c20 6466 5f6e  at([df_pos, df_n
-00005840: 6567 5d2c 2061 7869 7320 3d20 3029 0a20  eg], axis = 0). 
-00005850: 2020 200a 2020 2020 6d6b 725f 6c73 745f     .    mkr_lst_
-00005860: 746d 7020 3d20 6d6b 725f 6c73 745f 7365  tmp = mkr_lst_se
-00005870: 630a 2020 2020 6374 5f6c 7374 203d 206c  c.    ct_lst = l
-00005880: 6973 7428 6d6b 725f 6c73 745f 746d 702e  ist(mkr_lst_tmp.
-00005890: 6b65 7973 2829 290a 2020 2020 6d6b 7273  keys()).    mkrs
-000058a0: 203d 205b 5d0a 2020 2020 6374 5f6c 7374   = [].    ct_lst
-000058b0: 5f6e 6577 203d 205b 5d0a 2020 2020 666f  _new = [].    fo
-000058c0: 7220 6320 696e 2063 745f 6c73 743a 0a20  r c in ct_lst:. 
-000058d0: 2020 2020 2020 2069 6620 6c65 6e28 6d6b         if len(mk
-000058e0: 725f 6c73 745f 746d 705b 635d 2920 3e20  r_lst_tmp[c]) > 
-000058f0: 303a 0a20 2020 2020 2020 2020 2020 206d  0:.            m
-00005900: 6b72 5f6c 7374 5f74 6d70 5b63 5d2e 736f  kr_lst_tmp[c].so
-00005910: 7274 2829 0a20 2020 2020 2020 2020 2020  rt().           
-00005920: 2073 203d 206d 6b72 5f6c 7374 5f74 6d70   s = mkr_lst_tmp
-00005930: 5b63 5d5b 305d 0a20 2020 2020 2020 2020  [c][0].         
-00005940: 2020 2069 6620 6c65 6e28 6d6b 725f 6c73     if len(mkr_ls
-00005950: 745f 746d 705b 635d 2920 3e20 313a 0a20  t_tmp[c]) > 1:. 
-00005960: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00005970: 6f72 206d 6b72 2069 6e20 6d6b 725f 6c73  or mkr in mkr_ls
-00005980: 745f 746d 705b 635d 5b31 3a5d 3a0a 2020  t_tmp[c][1:]:.  
-00005990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000059a0: 2020 7320 3d20 7320 2b20 272c 2573 2720    s = s + ',%s' 
-000059b0: 2520 6d6b 720a 2020 2020 2020 2020 2020  % mkr.          
-000059c0: 2020 6d6b 7273 2e61 7070 656e 6428 7329    mkrs.append(s)
-000059d0: 0a20 2020 2020 2020 2020 2020 2063 745f  .            ct_
-000059e0: 6c73 745f 6e65 772e 6170 7065 6e64 2863  lst_new.append(c
-000059f0: 290a 2020 2020 2020 2020 2020 2020 0a20  ).            . 
-00005a00: 2020 200a 2020 2020 6466 5f73 6563 5b27     .    df_sec['
-00005a10: 6365 6c6c 5f74 7970 655f 7375 6273 6574  cell_type_subset
-00005a20: 275d 203d 2063 745f 6c73 745f 6e65 770a  '] = ct_lst_new.
-00005a30: 2020 2020 6466 5f73 6563 5b27 6d61 726b      df_sec['mark
-00005a40: 6572 7327 5d20 3d20 6d6b 7273 0a20 2020  ers'] = mkrs.   
-00005a50: 2064 665f 7365 635b 2765 7870 275d 203d   df_sec['exp'] =
-00005a60: 205b 2773 6563 275d 2a6c 656e 286d 6b72   ['sec']*len(mkr
-00005a70: 7329 0a20 2020 200a 2020 2020 6466 203d  s).    .    df =
-00005a80: 2070 642e 636f 6e63 6174 285b 6466 2c20   pd.concat([df, 
-00005a90: 6466 5f73 6563 5d2c 2061 7869 7320 3d20  df_sec], axis = 
-00005aa0: 3029 0a20 2020 200a 2020 2020 6466 5b27  0).    .    df['
-00005ab0: 6365 6c6c 5f74 7970 655f 6d61 6a6f 7227  cell_type_major'
-00005ac0: 5d20 3d20 6466 5b27 6365 6c6c 5f74 7970  ] = df['cell_typ
-00005ad0: 655f 7375 6273 6574 275d 2e63 6f70 7928  e_subset'].copy(
-00005ae0: 6465 6570 203d 2054 7275 6529 0a20 2020  deep = True).   
-00005af0: 2064 665b 2763 656c 6c5f 7479 7065 5f6d   df['cell_type_m
-00005b00: 696e 6f72 275d 203d 2064 665b 2763 656c  inor'] = df['cel
-00005b10: 6c5f 7479 7065 5f73 7562 7365 7427 5d2e  l_type_subset'].
-00005b20: 636f 7079 2864 6565 7020 3d20 5472 7565  copy(deep = True
-00005b30: 290a 2020 2020 6466 5b27 6365 6c6c 5f74  ).    df['cell_t
-00005b40: 7970 655f 6d61 6a6f 7227 5d2e 7265 706c  ype_major'].repl
-00005b50: 6163 6528 6d61 6a6f 725f 6469 6374 2c20  ace(major_dict, 
-00005b60: 696e 706c 6163 6520 3d20 5472 7565 290a  inplace = True).
-00005b70: 2020 2020 6466 5b27 6365 6c6c 5f74 7970      df['cell_typ
-00005b80: 655f 6d69 6e6f 7227 5d2e 7265 706c 6163  e_minor'].replac
-00005b90: 6528 6d69 6e6f 725f 6469 6374 2c20 696e  e(minor_dict, in
-00005ba0: 706c 6163 6520 3d20 5472 7565 290a 2020  place = True).  
-00005bb0: 2020 6466 2e73 6f72 745f 7661 6c75 6573    df.sort_values
-00005bc0: 2862 7920 3d20 5b27 6365 6c6c 5f74 7970  (by = ['cell_typ
-00005bd0: 655f 6d61 6a6f 7227 2c20 2763 656c 6c5f  e_major', 'cell_
-00005be0: 7479 7065 5f6d 616a 6f72 272c 2027 6365  type_major', 'ce
-00005bf0: 6c6c 5f74 7970 655f 7375 6273 6574 275d  ll_type_subset']
-00005c00: 2c20 696e 706c 6163 6520 3d20 5472 7565  , inplace = True
-00005c10: 290a 0a20 2020 2069 6620 6669 6c65 2069  )..    if file i
-00005c20: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00005c30: 7265 7475 726e 2064 660a 2020 2020 656c  return df.    el
-00005c40: 7365 3a0a 2020 2020 2020 2020 6466 2e74  se:.        df.t
-00005c50: 6f5f 6373 7628 6669 6c65 2c20 7365 7020  o_csv(file, sep 
-00005c60: 3d20 275c 7427 2c20 696e 6465 7820 3d20  = '\t', index = 
-00005c70: 4661 6c73 6529 0a20 2020 2020 2020 2072  False).        r
-00005c80: 6574 7572 6e20 6466 0a20 2020 200a 2727  eturn df.    .''
-00005c90: 270a 706f 7320 3d20 5472 7565 0a6e 6567  '.pos = True.neg
-00005ca0: 203d 2046 616c 7365 0a73 6563 203d 2054   = False.sec = T
-00005cb0: 7275 650a 686c 615f 6472 203d 2054 7275  rue.hla_dr = Tru
-00005cc0: 650a 6d68 6331 203d 2054 7275 650a 6d68  e.mhc1 = True.mh
-00005cd0: 6332 203d 2054 7275 650a 2727 2720 2020  c2 = True.'''   
-00005ce0: 200a 0a64 6566 2054 6964 656e 5f63 6865   ..def Tiden_che
-00005cf0: 636b 5f6b 6579 5f67 656e 6573 2820 6765  ck_key_genes( ge
-00005d00: 6e65 5f6c 7374 2c20 6b65 795f 6765 6e65  ne_lst, key_gene
-00005d10: 7320 293a 0a20 2020 200a 2020 2020 6220  s ):.    .    b 
-00005d20: 3d20 5472 7565 0a20 2020 2066 6f72 2067  = True.    for g
-00005d30: 2069 6e20 6c69 7374 286b 6579 5f67 656e   in list(key_gen
-00005d40: 6573 293a 0a20 2020 2020 2020 2069 6620  es):.        if 
-00005d50: 6720 6e6f 7420 696e 2067 656e 655f 6c73  g not in gene_ls
-00005d60: 743a 0a20 2020 2020 2020 2020 2020 2062  t:.            b
-00005d70: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-00005d80: 2020 2020 2062 7265 616b 0a20 2020 2072       break.    r
-00005d90: 6574 7572 6e20 620a 0a64 6566 2054 6964  eturn b..def Tid
-00005da0: 656e 5f70 7269 6e74 5f65 7272 6f72 2865  en_print_error(e
-00005db0: 7272 6f72 5f63 6f64 6520 3d20 3029 3a20  rror_code = 0): 
-00005dc0: 2020 200a 2020 2020 6966 2065 7272 6f72     .    if error
-00005dd0: 5f63 6f64 6520 3d3d 2031 3a0a 2020 2020  _code == 1:.    
-00005de0: 2020 2020 7072 696e 7428 2745 5252 4f52      print('ERROR
-00005df0: 3a20 4f6e 6520 6f72 206d 6f72 6520 6f66  : One or more of
-00005e00: 206b 6579 2067 656e 6573 2066 6f72 2054   key genes for T
-00005e10: 2063 656c 6c20 7375 6274 7970 696e 6720   cell subtyping 
-00005e20: 2843 4434 2c20 4344 3841 2c20 4344 3842  (CD4, CD8A, CD8B
-00005e30: 2920 6172 6520 6e6f 7420 696e 2074 6865  ) are not in the
-00005e40: 2067 656e 6520 6c69 7374 2e27 290a 2020   gene list.').  
-00005e50: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00005e60: 7072 696e 7428 2745 5252 4f52 3a20 585f  print('ERROR: X_
-00005e70: 6365 6c6c 5f62 795f 6765 6e65 206d 7573  cell_by_gene mus
-00005e80: 7420 6265 2061 2044 6174 6146 7261 6d65  t be a DataFrame
-00005e90: 2077 6974 6820 6974 7320 636f 6c75 6d6e   with its column
-00005ea0: 7320 6265 696e 6720 6765 6e65 206e 616d  s being gene nam
-00005eb0: 6573 2068 6176 696e 6720 4344 342c 2043  es having CD4, C
-00005ec0: 4438 412c 2043 4438 4227 290a 2020 2020  D8A, CD8B').    
-00005ed0: 2020 2020 7072 696e 7428 2720 2020 4f72      print('   Or
-00005ee0: 2c20 6765 6e65 5f6e 616d 6573 206d 7573  , gene_names mus
-00005ef0: 7420 6265 2070 726f 7669 6465 6420 7769  t be provided wi
-00005f00: 7468 2069 7473 206c 656e 6774 6820 6571  th its length eq
-00005f10: 7561 6c20 746f 2074 6865 2063 6f6c 756d  ual to the colum
-00005f20: 6e20 7369 7a65 206f 6620 585f 6365 6c6c  n size of X_cell
-00005f30: 5f62 795f 6765 6e65 2c20 636f 6e74 6169  _by_gene, contai
-00005f40: 6e69 6e67 2043 4434 2c20 4344 3841 2c20  ning CD4, CD8A, 
-00005f50: 4344 3842 2e27 290a 0a20 2020 2020 2020  CD8B.')..       
-00005f60: 200a 6465 6620 6765 745f 7374 6174 3228   .def get_stat2(
-00005f70: 6466 5f73 636f 7265 293a 0a0a 2020 2020  df_score):..    
-00005f80: 6466 203d 2064 665f 7363 6f72 650a 2020  df = df_score.  
-00005f90: 2020 6d61 7876 203d 206c 6973 7428 6466    maxv = list(df
-00005fa0: 2e6d 6178 2861 7869 7320 3d20 3129 290a  .max(axis = 1)).
-00005fb0: 2020 2020 7375 6274 7970 6520 3d20 6c69      subtype = li
-00005fc0: 7374 2864 662e 6964 786d 6178 2861 7869  st(df.idxmax(axi
-00005fd0: 7320 3d20 3129 290a 2020 2020 2374 635f  s = 1)).    #tc_
-00005fe0: 7375 6274 7970 6520 3d20 5b74 7261 6e73  subtype = [trans
-00005ff0: 5f64 6963 745b 6b5d 2066 6f72 206b 2069  _dict[k] for k i
-00006000: 6e20 7463 5f73 7562 7479 7065 5d0a 0a20  n tc_subtype].. 
-00006010: 2020 206d 6178 7632 203d 205b 5d0a 2020     maxv2 = [].  
-00006020: 2020 6964 7832 203d 205b 5d0a 2020 2020    idx2 = [].    
-00006030: 7375 6274 7970 655f 6c73 7420 3d20 6c69  subtype_lst = li
-00006040: 7374 2864 662e 636f 6c75 6d6e 732e 7661  st(df.columns.va
-00006050: 6c75 6573 290a 0a20 2020 2066 6f72 2069  lues)..    for i
-00006060: 2069 6e20 7261 6e67 6528 6466 2e73 6861   in range(df.sha
-00006070: 7065 5b30 5d29 3a0a 2020 2020 2020 2020  pe[0]):.        
-00006080: 7820 3d20 6e70 2e61 7272 6179 2864 662e  x = np.array(df.
-00006090: 696c 6f63 5b69 5d29 0a20 2020 2020 2020  iloc[i]).       
-000060a0: 206f 6472 203d 2028 2d78 292e 6172 6773   odr = (-x).args
-000060b0: 6f72 7428 290a 2020 2020 2020 2020 6966  ort().        if
-000060c0: 206c 656e 2878 2920 3e20 313a 0a20 2020   len(x) > 1:.   
-000060d0: 2020 2020 2020 2020 206d 6178 7632 2e61           maxv2.a
-000060e0: 7070 656e 6428 785b 6f64 725b 315d 5d29  ppend(x[odr[1]])
-000060f0: 0a20 2020 2020 2020 2020 2020 2069 6478  .            idx
-00006100: 322e 6170 7065 6e64 2873 7562 7479 7065  2.append(subtype
-00006110: 5f6c 7374 5b6f 6472 5b31 5d5d 290a 2020  _lst[odr[1]]).  
-00006120: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00006130: 2020 2020 2020 2020 6d61 7876 322e 6170          maxv2.ap
-00006140: 7065 6e64 2830 290a 2020 2020 2020 2020  pend(0).        
-00006150: 2020 2020 6964 7832 2e61 7070 656e 6428      idx2.append(
-00006160: 4e6f 6e65 290a 0a20 2020 2023 2064 665f  None)..    # df_
-00006170: 7265 7320 3d20 7064 2e44 6174 6146 7261  res = pd.DataFra
-00006180: 6d65 287b 2743 4434 2b20 5420 6365 6c6c  me({'CD4+ T cell
-00006190: 2073 7562 7479 7065 273a 2074 635f 7375   subtype': tc_su
-000061a0: 6274 7970 652c 2027 4e65 674c 6f67 5076  btype, 'NegLogPv
-000061b0: 616c 273a 206e 6567 5f6c 6f67 5f70 7661  al': neg_log_pva
-000061c0: 6c7d 2c20 696e 6465 7820 3d20 6466 2e69  l}, index = df.i
-000061d0: 6e64 6578 2e76 616c 7565 7329 0a20 2020  ndex.values).   
-000061e0: 2064 665f 7265 7320 3d20 7064 2e44 6174   df_res = pd.Dat
-000061f0: 6146 7261 6d65 287b 2763 656c 6c5f 7479  aFrame({'cell_ty
-00006200: 7065 273a 2073 7562 7479 7065 2c20 2763  pe': subtype, 'c
-00006210: 656c 6c5f 7479 7065 2872 6576 2927 3a20  ell_type(rev)': 
-00006220: 7375 6274 7970 652c 200a 2020 2020 2020  subtype, .      
-00006230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006240: 2020 2020 2027 6365 6c6c 5f74 7970 6528       'cell_type(
-00006250: 3173 7429 273a 2073 7562 7479 7065 2c20  1st)': subtype, 
-00006260: 2763 656c 6c5f 7479 7065 2832 6e64 2927  'cell_type(2nd)'
-00006270: 3a20 6964 7832 2c20 0a20 2020 2020 2020  : idx2, .       
-00006280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006290: 2020 2020 2743 6c61 7269 7479 273a 205b      'Clarity': [
-000062a0: 272d 275d 2a64 662e 7368 6170 655b 305d  '-']*df.shape[0]
-000062b0: 2c20 2753 636f 7265 273a 206d 6178 762c  , 'Score': maxv,
-000062c0: 2027 5363 6f72 6528 326e 6429 273a 206d   'Score(2nd)': m
-000062d0: 6178 7632 7d2c 200a 2020 2020 2020 2020  axv2}, .        
-000062e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000062f0: 2020 696e 6465 7820 3d20 6466 2e69 6e64    index = df.ind
-00006300: 6578 2e76 616c 7565 7329 0a20 2020 2064  ex.values).    d
-00006310: 665f 7265 735b 2764 5363 6f72 6527 5d20  f_res['dScore'] 
-00006320: 3d20 6466 5f72 6573 5b27 5363 6f72 6527  = df_res['Score'
-00006330: 5d20 2d20 6466 5f72 6573 5b27 5363 6f72  ] - df_res['Scor
-00006340: 6528 326e 6429 275d 0a20 2020 200a 2020  e(2nd)'].    .  
-00006350: 2020 7265 7475 726e 2064 665f 7265 730a    return df_res.
-00006360: 0a0a 6465 6620 706c 6f74 5f47 5341 5f73  ..def plot_GSA_s
-00006370: 636f 7265 5f68 6973 7428 6466 5f73 636f  core_hist(df_sco
-00006380: 7265 2c20 7469 746c 6520 3d20 2747 5341  re, title = 'GSA
-00006390: 272c 2068 6973 7474 7970 6520 3d20 2762  ', histtype = 'b
-000063a0: 6172 2729 3a0a 2020 2020 0a20 2020 2064  ar'):.    .    d
-000063b0: 665f 7375 6d20 3d20 6765 745f 7374 6174  f_sum = get_stat
-000063c0: 3228 6466 5f73 636f 7265 290a 2020 2020  2(df_score).    
-000063d0: 7363 6f72 655f 6e61 6d65 203d 2027 5363  score_name = 'Sc
-000063e0: 6f72 6527 0a20 2020 2074 6172 6765 745f  ore'.    target_
-000063f0: 7479 7065 7320 3d20 6c69 7374 2864 665f  types = list(df_
-00006400: 7375 6d5b 2763 656c 6c5f 7479 7065 2831  sum['cell_type(1
-00006410: 7374 2927 5d2e 756e 6971 7565 2829 290a  st)'].unique()).
-00006420: 2020 2020 7468 7265 7368 6f6c 6473 203d      thresholds =
-00006430: 207b 7d0a 2020 2020 6d31 6d32 5f72 6174   {}.    m1m2_rat
-00006440: 696f 203d 207b 7d0a 2020 2020 706c 6f74  io = {}.    plot
-00006450: 5f68 6973 7420 3d20 5472 7565 0a20 2020  _hist = True.   
-00006460: 200a 2020 2020 666f 7220 7420 696e 2074   .    for t in t
-00006470: 6172 6765 745f 7479 7065 733a 0a20 2020  arget_types:.   
-00006480: 2020 2020 2074 6172 6765 7420 3d20 740a       target = t.
-00006490: 0a20 2020 2020 2020 2062 3120 3d20 2864  .        b1 = (d
-000064a0: 665f 7375 6d5b 2763 656c 6c5f 7479 7065  f_sum['cell_type
-000064b0: 2831 7374 2927 5d20 3d3d 2074 6172 6765  (1st)'] == targe
-000064c0: 7429 2023 2620 2864 665f 7375 6d5b 272d  t) #& (df_sum['-
-000064d0: 6c6f 6750 275d 203e 202d 6e70 2e6c 6f67  logP'] > -np.log
-000064e0: 3130 2870 7661 6c5f 7468 2929 0a20 2020  10(pval_th)).   
-000064f0: 2020 2020 2076 3120 3d20 6466 5f73 756d       v1 = df_sum
-00006500: 2e6c 6f63 5b62 312c 2073 636f 7265 5f6e  .loc[b1, score_n
-00006510: 616d 655d 0a20 2020 2020 2020 206d 3120  ame].        m1 
-00006520: 3d20 6466 5f73 756d 2e6c 6f63 5b62 312c  = df_sum.loc[b1,
-00006530: 2073 636f 7265 5f6e 616d 655d 2e6d 6178   score_name].max
-00006540: 2829 2023 2e6d 6561 6e28 290a 2020 2020  () #.mean().    
-00006550: 2020 2020 6e31 203d 206e 702e 7375 6d28      n1 = np.sum(
-00006560: 6231 290a 0a20 2020 2020 2020 2062 3220  b1)..        b2 
-00006570: 3d20 2864 665f 7375 6d5b 2763 656c 6c5f  = (df_sum['cell_
-00006580: 7479 7065 2832 6e64 2927 5d20 3d3d 2074  type(2nd)'] == t
-00006590: 6172 6765 7429 2023 2026 2028 6466 5f73  arget) # & (df_s
-000065a0: 756d 5b27 2d6c 6f67 5028 326e 6429 275d  um['-logP(2nd)']
-000065b0: 203e 202d 6e70 2e6c 6f67 3130 2870 7661   > -np.log10(pva
-000065c0: 6c5f 7468 2929 0a20 2020 2020 2020 2069  l_th)).        i
-000065d0: 6620 6e70 2e73 756d 2862 3229 203e 2030  f np.sum(b2) > 0
-000065e0: 3a0a 2020 2020 2020 2020 2020 2020 7632  :.            v2
-000065f0: 203d 2064 665f 7375 6d2e 6c6f 635b 6232   = df_sum.loc[b2
-00006600: 2c20 2725 7328 326e 6429 2720 2520 7363  , '%s(2nd)' % sc
-00006610: 6f72 655f 6e61 6d65 5d0a 2020 2020 2020  ore_name].      
-00006620: 2020 2020 2020 6d32 203d 2064 665f 7375        m2 = df_su
-00006630: 6d2e 6c6f 635b 6232 2c20 2725 7328 326e  m.loc[b2, '%s(2n
-00006640: 6429 2720 2520 7363 6f72 655f 6e61 6d65  d)' % score_name
-00006650: 5d2e 6d61 7828 2920 232e 6d65 616e 2829  ].max() #.mean()
-00006660: 0a20 2020 2020 2020 2020 2020 206e 3220  .            n2 
-00006670: 3d20 6e70 2e73 756d 2862 3229 0a20 2020  = np.sum(b2).   
-00006680: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-00006690: 2020 6966 2070 6c6f 745f 6869 7374 3a0a    if plot_hist:.
-000066a0: 2020 2020 2020 2020 2020 2020 7831 203d              x1 =
-000066b0: 2064 665f 7375 6d2e 6c6f 635b 6231 2c20   df_sum.loc[b1, 
-000066c0: 7363 6f72 655f 6e61 6d65 5d0a 2020 2020  score_name].    
-000066d0: 2020 2020 2020 2020 6d6e 7620 3d20 7831          mnv = x1
-000066e0: 2e6d 696e 2829 0a20 2020 2020 2020 2020  .min().         
-000066f0: 2020 206d 7876 203d 2078 312e 6d61 7828     mxv = x1.max(
-00006700: 290a 2020 2020 2020 2020 2020 2020 5820  ).            X 
-00006710: 3d20 7831 0a20 2020 2020 2020 2020 2020  = x1.           
-00006720: 2069 6620 6e70 2e73 756d 2862 3229 203e   if np.sum(b2) >
-00006730: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00006740: 2020 2020 7832 203d 2064 665f 7375 6d2e      x2 = df_sum.
-00006750: 6c6f 635b 6232 2c20 2725 7328 326e 6429  loc[b2, '%s(2nd)
-00006760: 2720 2520 7363 6f72 655f 6e61 6d65 5d0a  ' % score_name].
-00006770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006780: 6d6e 7620 3d20 6d69 6e28 6d6e 762c 2078  mnv = min(mnv, x
-00006790: 322e 6d69 6e28 2929 0a20 2020 2020 2020  2.min()).       
-000067a0: 2020 2020 2020 2020 206d 7876 203d 206d           mxv = m
-000067b0: 6178 286d 7876 2c20 7832 2e6d 696e 2829  ax(mxv, x2.min()
-000067c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000067d0: 2020 5820 3d20 6e70 2e61 7272 6179 285b    X = np.array([
-000067e0: 7831 2c78 325d 290a 2020 2020 2020 2020  x1,x2]).        
-000067f0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00006800: 2020 2020 2069 6620 6d6e 7620 3c20 6d78       if mnv < mx
-00006810: 763a 0a20 2020 2020 2020 2020 2020 2020  v:.             
-00006820: 2020 2062 696e 7320 3d20 6e70 2e61 7261     bins = np.ara
-00006830: 6e67 6528 6d6e 762c 206d 7876 2c20 286d  nge(mnv, mxv, (m
-00006840: 7876 2d6d 6e76 292f 3530 290a 2020 2020  xv-mnv)/50).    
-00006850: 2020 2020 2020 2020 2020 2020 706c 742e              plt.
-00006860: 6669 6775 7265 2866 6967 7369 7a65 203d  figure(figsize =
-00006870: 2028 352c 3329 290a 2020 2020 2020 2020   (5,3)).        
-00006880: 2020 2020 2020 2020 2320 6466 5f73 756d          # df_sum
-00006890: 2e6c 6f63 5b62 312c 2073 636f 7265 5f6e  .loc[b1, score_n
-000068a0: 616d 655d 2e68 6973 7428 6269 6e73 203d  ame].hist(bins =
-000068b0: 2035 302c 206c 6f67 203d 2054 7275 652c   50, log = True,
-000068c0: 2061 6c70 6861 203d 2030 2e37 290a 2020   alpha = 0.7).  
-000068d0: 2020 2020 2020 2020 2020 2020 2020 706c                pl
-000068e0: 742e 6869 7374 2858 2c20 6269 6e73 203d  t.hist(X, bins =
-000068f0: 2062 696e 732c 206c 6f67 203d 2054 7275   bins, log = Tru
-00006900: 652c 2061 6c70 6861 203d 2030 2e38 2c20  e, alpha = 0.8, 
-00006910: 6869 7374 7479 7065 203d 2068 6973 7474  histtype = histt
-00006920: 7970 6529 0a20 2020 2020 2020 2020 2020  ype).           
-00006930: 2020 2020 2070 6c74 2e74 6974 6c65 2827       plt.title('
-00006940: 4869 7374 6f67 7261 6d20 666f 7220 2573  Histogram for %s
-00006950: 2025 7320 7363 6f72 6527 2025 2028 742c   %s score' % (t,
-00006960: 2074 6974 6c65 2929 0a20 2020 2020 2020   title)).       
-00006970: 2020 2020 2020 2020 2070 6c74 2e78 6c61           plt.xla
-00006980: 6265 6c28 2773 636f 7265 2729 0a20 2020  bel('score').   
-00006990: 2020 2020 2020 2020 2020 2020 2070 6c74               plt
-000069a0: 2e79 6c61 6265 6c28 274e 756d 6265 7220  .ylabel('Number 
-000069b0: 6f66 2063 656c 6c73 2729 0a20 2020 2020  of cells').     
-000069c0: 2020 2020 2020 2020 2020 2069 6620 6e70             if np
-000069d0: 2e73 756d 2862 3229 203e 2030 3a0a 2020  .sum(b2) > 0:.  
-000069e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000069f0: 2020 2320 6466 5f73 756d 2e6c 6f63 5b62    # df_sum.loc[b
-00006a00: 322c 2027 2573 2832 6e64 2927 2025 2073  2, '%s(2nd)' % s
-00006a10: 636f 7265 5f6e 616d 655d 2e68 6973 7428  core_name].hist(
-00006a20: 6269 6e73 203d 2035 302c 206c 6f67 203d  bins = 50, log =
-00006a30: 2054 7275 652c 2061 6c70 6861 203d 2030   True, alpha = 0
-00006a40: 2e35 290a 2020 2020 2020 2020 2020 2020  .5).            
-00006a50: 2020 2020 2020 2020 2320 706c 742e 6869          # plt.hi
-00006a60: 7374 2878 322c 2062 696e 7320 3d20 6269  st(x2, bins = bi
-00006a70: 6e73 2c20 6c6f 6720 3d20 5472 7565 2c20  ns, log = True, 
-00006a80: 616c 7068 6120 3d20 302e 352c 2064 656e  alpha = 0.5, den
-00006a90: 7369 7479 203d 2054 7275 6529 0a20 2020  sity = True).   
-00006aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006ab0: 2070 6c74 2e6c 6567 656e 6428 5b27 5072   plt.legend(['Pr
-00006ac0: 696d 6172 7927 2c20 2753 6563 6f6e 6461  imary', 'Seconda
-00006ad0: 7279 275d 290a 2020 2020 2020 2020 2020  ry']).          
-00006ae0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00006af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b00: 706c 742e 6c65 6765 6e64 285b 2750 7269  plt.legend(['Pri
-00006b10: 6d61 7279 275d 290a 2020 2020 2020 2020  mary']).        
-00006b20: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00006b30: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00006b40: 2748 6973 746f 6772 616d 2066 6f72 2025  'Histogram for %
-00006b50: 7320 2573 206e 6f74 2061 7661 696c 6162  s %s not availab
-00006b60: 6c65 2e27 2025 2028 742c 2074 6974 6c65  le.' % (t, title
-00006b70: 2929 0a20 2020 2072 6574 7572 6e20 0a0a  )).    return ..
-00006b80: 0a64 6566 2070 6c6f 745f 4753 415f 7363  .def plot_GSA_sc
-00006b90: 6f72 655f 7669 6f6c 696e 2864 665f 7363  ore_violin(df_sc
-00006ba0: 6f72 652c 2074 6974 6c65 203d 2027 4753  ore, title = 'GS
-00006bb0: 4127 2c20 7370 6c69 7420 3d20 5472 7565  A', split = True
-00006bc0: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-00006bd0: 2020 2020 2020 2020 2020 2020 2073 6361               sca
-00006be0: 6c65 203d 2027 7769 6474 6827 2c20 696e  le = 'width', in
-00006bf0: 6e65 7220 3d20 2771 7561 7274 696c 6527  ner = 'quartile'
-00006c00: 2c20 6c6f 6720 3d20 5472 7565 2c20 0a20  , log = True, . 
-00006c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c20: 2020 2020 2020 2020 2077 6964 7468 203d           width =
-00006c30: 2031 2c20 6669 675f 7363 616c 6520 3d20   1, fig_scale = 
-00006c40: 3129 3a0a 2020 2020 0a20 2020 2064 665f  1):.    .    df_
-00006c50: 7375 6d20 3d20 6765 745f 7374 6174 3228  sum = get_stat2(
-00006c60: 6466 5f73 636f 7265 290a 2020 2020 6966  df_score).    if
-00006c70: 206c 6f67 3a0a 2020 2020 2020 2020 6466   log:.        df
-00006c80: 5f73 636f 7265 203d 206e 702e 6c6f 6732  _score = np.log2
-00006c90: 2864 665f 7363 6f72 6520 2b20 3129 0a20  (df_score + 1). 
-00006ca0: 2020 2020 2020 200a 2020 2020 7363 6f72         .    scor
-00006cb0: 655f 6e61 6d65 203d 2027 5363 6f72 6527  e_name = 'Score'
-00006cc0: 0a20 2020 2074 6172 6765 745f 7479 7065  .    target_type
-00006cd0: 7320 3d20 6c69 7374 2864 665f 7363 6f72  s = list(df_scor
-00006ce0: 652e 636f 6c75 6d6e 732e 7661 6c75 6573  e.columns.values
-00006cf0: 2920 2320 6c69 7374 2864 665f 7375 6d5b  ) # list(df_sum[
-00006d00: 2763 656c 6c5f 7479 7065 2831 7374 2927  'cell_type(1st)'
-00006d10: 5d2e 756e 6971 7565 2829 290a 2020 2020  ].unique()).    
-00006d20: 7468 7265 7368 6f6c 6473 203d 207b 7d0a  thresholds = {}.
-00006d30: 2020 2020 6d31 6d32 5f72 6174 696f 203d      m1m2_ratio =
-00006d40: 207b 7d0a 2020 2020 706c 6f74 5f68 6973   {}.    plot_his
-00006d50: 7420 3d20 5472 7565 0a20 2020 200a 2020  t = True.    .  
-00006d60: 2020 636e 7420 3d20 300a 2020 2020 666f    cnt = 0.    fo
-00006d70: 7220 7420 696e 2074 6172 6765 745f 7479  r t in target_ty
-00006d80: 7065 733a 0a20 2020 2020 2020 2074 6172  pes:.        tar
-00006d90: 6765 7420 3d20 740a 0a20 2020 2020 2020  get = t..       
-00006da0: 2062 3120 3d20 2864 665f 7375 6d5b 2763   b1 = (df_sum['c
-00006db0: 656c 6c5f 7479 7065 2831 7374 2927 5d20  ell_type(1st)'] 
-00006dc0: 3d3d 2074 6172 6765 7429 200a 2020 2020  == target) .    
-00006dd0: 2020 2020 6232 203d 2028 6466 5f73 756d      b2 = (df_sum
-00006de0: 5b27 6365 6c6c 5f74 7970 6528 3173 7429  ['cell_type(1st)
-00006df0: 275d 2021 3d20 7461 7267 6574 2920 0a20  '] != target) . 
-00006e00: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-00006e10: 2020 2020 5820 3d20 4e6f 6e65 0a20 2020      X = None.   
-00006e20: 2020 2020 2069 6620 706c 6f74 5f68 6973       if plot_his
-00006e30: 743a 0a20 2020 2020 2020 2020 2020 2078  t:.            x
-00006e40: 3120 3d20 6466 5f73 636f 7265 2e6c 6f63  1 = df_score.loc
-00006e50: 5b62 312c 2074 5d0a 2020 2020 2020 2020  [b1, t].        
-00006e60: 2020 2020 6966 206c 656e 2878 3129 203e      if len(x1) >
-00006e70: 2031 303a 0a20 2020 2020 2020 2020 2020   10:.           
-00006e80: 2020 2020 2069 6620 6e70 2e73 756d 2862       if np.sum(b
-00006e90: 3229 203e 2031 303a 0a20 2020 2020 2020  2) > 10:.       
-00006ea0: 2020 2020 2020 2020 2020 2020 2058 203d               X =
-00006eb0: 2070 642e 4461 7461 4672 616d 6528 207b   pd.DataFrame( {
-00006ec0: 2753 636f 7265 273a 2078 317d 2029 0a20  'Score': x1} ). 
-00006ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006ee0: 2020 2058 5b27 6365 6c6c 2074 7970 6527     X['cell type'
-00006ef0: 5d20 3d20 2754 6172 6765 7427 0a20 2020  ] = 'Target'.   
-00006f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f10: 2058 5b27 4365 6c6c 2074 7970 6527 5d20   X['Cell type'] 
-00006f20: 3d20 740a 2020 2020 2020 2020 2020 2020  = t.            
-00006f30: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00006f40: 2020 2020 2020 2020 2020 2020 2078 3220               x2 
-00006f50: 3d20 6466 5f73 636f 7265 2e6c 6f63 5b62  = df_score.loc[b
-00006f60: 322c 2074 5d20 2320 6466 5f73 756d 2e6c  2, t] # df_sum.l
-00006f70: 6f63 5b62 322c 2027 2573 2832 6e64 2927  oc[b2, '%s(2nd)'
-00006f80: 2025 2073 636f 7265 5f6e 616d 655d 0a20   % score_name]. 
-00006f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006fa0: 2020 2023 2058 203d 206e 702e 6172 7261     # X = np.arra
-00006fb0: 7928 5b78 312c 7832 5d29 0a20 2020 2020  y([x1,x2]).     
-00006fc0: 2020 2020 2020 2020 2020 2020 2020 2058                 X
-00006fd0: 3220 3d20 7064 2e44 6174 6146 7261 6d65  2 = pd.DataFrame
-00006fe0: 2820 7b27 5363 6f72 6527 3a20 7832 7d20  ( {'Score': x2} 
-00006ff0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00007000: 2020 2020 2020 5832 5b27 6365 6c6c 2074        X2['cell t
-00007010: 7970 6527 5d20 3d20 274e 6f6e 2d74 6172  ype'] = 'Non-tar
-00007020: 6765 7427 0a20 2020 2020 2020 2020 2020  get'.           
-00007030: 2020 2020 2020 2020 2058 325b 2743 656c           X2['Cel
-00007040: 6c20 7479 7065 275d 203d 2074 0a20 2020  l type'] = t.   
-00007050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007060: 2058 203d 2070 642e 636f 6e63 6174 285b   X = pd.concat([
-00007070: 582c 5832 5d2c 2061 7869 7320 3d20 3029  X,X2], axis = 0)
-00007080: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
-00007090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000070a0: 2020 6966 2058 2069 7320 6e6f 7420 4e6f    if X is not No
-000070b0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000070c0: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-000070d0: 6e74 203d 3d20 303a 0a20 2020 2020 2020  nt == 0:.       
-000070e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000070f0: 2020 2020 2064 6620 3d20 580a 2020 2020       df = X.    
-00007100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007110: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00007120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007130: 2020 2020 2020 6466 203d 2070 642e 636f        df = pd.co
-00007140: 6e63 6174 285b 6466 2c58 5d2c 2061 7869  ncat([df,X], axi
-00007150: 7320 3d20 3029 0a20 2020 2020 2020 2020  s = 0).         
-00007160: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00007170: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
-00007180: 2020 2020 0a20 2020 2069 6620 2863 6e74      .    if (cnt
-00007190: 203e 2030 2920 2620 5345 4142 4f52 4e3a   > 0) & SEABORN:
-000071a0: 0a20 2020 2020 2020 206e 6e20 3d20 6c65  .        nn = le
-000071b0: 6e28 6c69 7374 2864 665b 2743 656c 6c20  n(list(df['Cell 
-000071c0: 7479 7065 275d 2e75 6e69 7175 6528 2929  type'].unique())
-000071d0: 290a 2020 2020 2020 2020 706c 742e 6669  ).        plt.fi
-000071e0: 6775 7265 2866 6967 7369 7a65 203d 2028  gure(figsize = (
-000071f0: 312e 332a 6e6e 2a66 6967 5f73 6361 6c65  1.3*nn*fig_scale
-00007200: 2c20 342a 6669 675f 7363 616c 6529 2c20  , 4*fig_scale), 
-00007210: 6470 693d 3130 3029 0a20 2020 2020 2020  dpi=100).       
-00007220: 2073 6e73 2e76 696f 6c69 6e70 6c6f 7428   sns.violinplot(
-00007230: 783d 2243 656c 6c20 7479 7065 222c 2079  x="Cell type", y
-00007240: 3d22 5363 6f72 6522 2c20 6875 653d 2263  ="Score", hue="c
-00007250: 656c 6c20 7479 7065 222c 2069 6e6e 6572  ell type", inner
-00007260: 203d 2069 6e6e 6572 2c0a 2020 2020 2020   = inner,.      
-00007270: 2020 2020 2020 2020 2020 2020 2020 6461                da
-00007280: 7461 3d64 662c 2070 616c 6574 7465 3d22  ta=df, palette="
-00007290: 6d75 7465 6422 2c20 7370 6c69 743d 7370  muted", split=sp
-000072a0: 6c69 742c 2073 6361 6c65 203d 2073 6361  lit, scale = sca
-000072b0: 6c65 2c20 0a20 2020 2020 2020 2020 2020  le, .           
-000072c0: 2020 2020 2020 2020 2077 6964 7468 203d           width =
-000072d0: 2077 6964 7468 2c20 666f 6e74 7369 7a65   width, fontsize
-000072e0: 203d 2031 322a 6669 675f 7363 616c 652c   = 12*fig_scale,
-000072f0: 206c 696e 6577 6964 7468 203d 2030 2e37   linewidth = 0.7
-00007300: 352c 2067 7269 6473 697a 6520 3d20 3330  5, gridsize = 30
-00007310: 290a 2020 2020 2020 2020 706c 742e 7874  ).        plt.xt
-00007320: 6963 6b73 2872 6f74 6174 696f 6e20 3d20  icks(rotation = 
-00007330: 3230 2c20 6861 203d 2027 6365 6e74 6572  20, ha = 'center
-00007340: 272c 2066 6f6e 7473 697a 6520 3d20 3132  ', fontsize = 12
-00007350: 2a66 6967 5f73 6361 6c65 2920 2020 0a20  *fig_scale)   . 
-00007360: 2020 2020 2020 2070 6c74 2e79 7469 636b         plt.ytick
-00007370: 7328 666f 6e74 7369 7a65 203d 2031 322a  s(fontsize = 12*
-00007380: 6669 675f 7363 616c 6529 0a20 2020 2020  fig_scale).     
-00007390: 2020 2070 6c74 2e74 6974 6c65 2874 6974     plt.title(tit
-000073a0: 6c65 2c20 666f 6e74 7369 7a65 203d 2031  le, fontsize = 1
-000073b0: 332a 6669 675f 7363 616c 6529 0a20 2020  3*fig_scale).   
-000073c0: 2020 2020 2070 6c74 2e6c 6567 656e 6428       plt.legend(
-000073d0: 666f 6e74 7369 7a65 203d 2031 302a 6669  fontsize = 10*fi
-000073e0: 675f 7363 616c 6529 0a20 2020 2020 2020  g_scale).       
-000073f0: 2023 2070 6c74 2e78 6c61 6265 6c28 2743   # plt.xlabel('C
-00007400: 656c 6c20 7479 7065 272c 2066 6f6e 7473  ell type', fonts
-00007410: 697a 6520 3d20 3132 290a 2020 2020 2020  ize = 12).      
-00007420: 2020 706c 742e 786c 6162 656c 284e 6f6e    plt.xlabel(Non
-00007430: 6529 0a20 2020 2020 2020 2069 6620 6c6f  e).        if lo
-00007440: 673a 0a20 2020 2020 2020 2020 2020 2070  g:.            p
-00007450: 6c74 2e79 6c61 6265 6c28 274c 6f67 3228  lt.ylabel('Log2(
-00007460: 312b 5363 6f72 6529 272c 2066 6f6e 7473  1+Score)', fonts
-00007470: 697a 6520 3d20 3132 2a66 6967 5f73 6361  ize = 12*fig_sca
-00007480: 6c65 290a 2020 2020 2020 2020 656c 7365  le).        else
-00007490: 3a0a 2020 2020 2020 2020 2020 2020 706c  :.            pl
-000074a0: 742e 796c 6162 656c 2827 5363 6f72 6527  t.ylabel('Score'
-000074b0: 2c20 666f 6e74 7369 7a65 203d 2031 322a  , fontsize = 12*
-000074c0: 6669 675f 7363 616c 6529 0a20 2020 2020  fig_scale).     
-000074d0: 2020 2070 6c74 2e73 686f 7728 290a 2020     plt.show().  
-000074e0: 2020 656c 6966 206e 6f74 2053 4541 424f    elif not SEABO
-000074f0: 524e 3a0a 2020 2020 2020 2020 7072 696e  RN:.        prin
-00007500: 7428 2757 4152 4e49 4e47 3a20 7365 6162  t('WARNING: seab
-00007510: 6f72 6e20 6973 206e 6f74 2069 6e73 7461  orn is not insta
-00007520: 6c6c 6564 2e27 290a 2020 2020 7265 7475  lled.').    retu
-00007530: 726e 200a 0a0a 6465 6620 706c 6f74 5f72  rn ...def plot_r
-00007540: 6f63 5f72 6573 756c 7428 6466 5f73 636f  oc_result(df_sco
-00007550: 7265 2c20 795f 7472 7565 2c20 6365 6c6c  re, y_true, cell
-00007560: 5f74 7970 652c 206d 6574 686f 6420 3d20  _type, method = 
-00007570: 2767 6d6d 272c 2066 6967 5f73 6361 6c65  'gmm', fig_scale
-00007580: 203d 2031 293a 0a20 2020 200a 2020 2020   = 1):.    .    
-00007590: 6c61 6265 6c20 3d20 6c69 7374 2864 665f  label = list(df_
-000075a0: 7363 6f72 652e 636f 6c75 6d6e 732e 7661  score.columns.va
-000075b0: 6c75 6573 290a 2020 2020 0a20 2020 2062  lues).    .    b
-000075c0: 7320 3d20 795f 7472 7565 203d 3d20 6c61  s = y_true == la
-000075d0: 6265 6c5b 305d 200a 2020 2020 666f 7220  bel[0] .    for 
-000075e0: 6c20 696e 206c 6162 656c 5b31 3a5d 3a0a  l in label[1:]:.
-000075f0: 2020 2020 2020 2020 6273 203d 2062 7320          bs = bs 
-00007600: 7c20 2879 5f74 7275 6520 3d3d 206c 290a  | (y_true == l).
-00007610: 2020 2020 0a20 2020 2070 6c74 2e66 6967      .    plt.fig
-00007620: 7572 6528 6669 6773 697a 653d 2834 2a66  ure(figsize=(4*f
-00007630: 6967 5f73 6361 6c65 2c20 342a 6669 675f  ig_scale, 4*fig_
-00007640: 7363 616c 6529 2c20 6470 693d 3130 3029  scale), dpi=100)
-00007650: 0a20 2020 2063 6c73 7420 3d20 5b27 6461  .    clst = ['da
-00007660: 726b 6f72 616e 6765 272c 2027 7265 6427  rkorange', 'red'
-00007670: 2c20 2767 6f6c 6427 2c20 2779 656c 6c6f  , 'gold', 'yello
-00007680: 7727 2c20 2766 6972 6562 7269 636b 272c  w', 'firebrick',
-00007690: 2027 6f72 616e 6765 272c 205c 0a20 2020   'orange', \.   
-000076a0: 2020 2020 2020 2020 2027 6d61 6765 6e74           'magent
-000076b0: 6127 2c20 2763 7269 6d73 6f6e 272c 2027  a', 'crimson', '
-000076c0: 7669 6f6c 6574 272c 2027 6d65 6469 756d  violet', 'medium
-000076d0: 6f72 6368 6964 272c 2027 7075 7270 6c65  orchid', 'purple
-000076e0: 272c 205c 0a20 2020 2020 2020 2020 2020  ', \.           
-000076f0: 2027 626c 7565 7669 6f6c 6574 272c 2027   'blueviolet', '
-00007700: 6c69 6d65 272c 2027 7475 7271 756f 6973  lime', 'turquois
-00007710: 6527 5d2a 340a 0a20 2020 2061 6c6c 5f63  e']*4..    all_c
-00007720: 656c 6c73 203d 2027 270a 2020 2020 6670  ells = ''.    fp
-00007730: 7273 203d 205b 5d0a 2020 2020 7470 7273  rs = [].    tprs
-00007740: 203d 205b 5d0a 2020 2020 6175 6373 203d   = [].    aucs =
-00007750: 205b 5d0a 2020 2020 6365 6c6c 733d 205b   [].    cells= [
-00007760: 5d0a 2020 2020 7373 203d 2030 0a20 2020  ].    ss = 0.   
-00007770: 2066 6f72 206b 2c20 6c20 696e 2065 6e75   for k, l in enu
-00007780: 6d65 7261 7465 286c 6162 656c 293a 0a20  merate(label):. 
-00007790: 2020 2020 2020 2023 6966 2028 6b25 3420         #if (k%4 
-000077a0: 3d3d 2030 2920 2620 286b 3e30 293a 0a20  == 0) & (k>0):. 
-000077b0: 2020 2020 2020 2069 6620 286b 3e30 2920         if (k>0) 
-000077c0: 2620 2828 6c65 6e28 616c 6c5f 6365 6c6c  & ((len(all_cell
-000077d0: 7329 202b 206c 656e 286c 2920 2b20 3220  s) + len(l) + 2 
-000077e0: 2d20 7373 2920 3e20 3435 293a 0a20 2020  - ss) > 45):.   
-000077f0: 2020 2020 2020 2020 2073 7320 3d20 6c65           ss = le
-00007800: 6e28 616c 6c5f 6365 6c6c 7329 202b 2031  n(all_cells) + 1
-00007810: 0a20 2020 2020 2020 2020 2020 2061 6c6c  .            all
-00007820: 5f63 656c 6c73 203d 2061 6c6c 5f63 656c  _cells = all_cel
-00007830: 6c73 202b 2027 5c6e 270a 2020 2020 2020  ls + '\n'.      
-00007840: 2020 616c 6c5f 6365 6c6c 7320 3d20 616c    all_cells = al
-00007850: 6c5f 6365 6c6c 7320 2b20 2725 732c 2027  l_cells + '%s, '
-00007860: 2025 206c 0a20 2020 2020 2020 200a 2020   % l.        .  
-00007870: 2020 2020 2020 0a20 2020 2020 2020 2079        .        y
-00007880: 5f63 6f6e 665f 3120 3d20 6466 5f73 636f  _conf_1 = df_sco
-00007890: 7265 2e6c 6f63 5b62 732c 206c 5d0a 2020  re.loc[bs, l].  
-000078a0: 2020 2020 2020 0a20 2020 2020 2020 206c        .        l
-000078b0: 6162 656c 5f74 6d70 203d 2063 6f70 792e  abel_tmp = copy.
-000078c0: 6465 6570 636f 7079 286c 6162 656c 290a  deepcopy(label).
-000078d0: 2020 2020 2020 2020 6c61 6265 6c5f 746d          label_tm
-000078e0: 702e 7265 6d6f 7665 286c 290a 2020 2020  p.remove(l).    
-000078f0: 2020 2020 795f 636f 6e66 5f30 203d 2064      y_conf_0 = d
-00007900: 665f 7363 6f72 652e 6c6f 635b 6273 2c20  f_score.loc[bs, 
-00007910: 6c61 6265 6c5f 746d 705d 2e6d 6178 2861  label_tmp].max(a
-00007920: 7869 7320 3d20 3129 0a0a 2020 2020 2020  xis = 1)..      
-00007930: 2020 795f 6f64 6420 3d20 795f 636f 6e66    y_odd = y_conf
-00007940: 5f31 2023 202d 2079 5f63 6f6e 665f 300a  _1 # - y_conf_0.
-00007950: 0a20 2020 2020 2020 2062 6e20 3d20 7e6e  .        bn = ~n
-00007960: 702e 6973 6e61 6e28 795f 6f64 6429 0a20  p.isnan(y_odd). 
-00007970: 2020 2020 2020 2079 5f6f 6464 203d 2079         y_odd = y
-00007980: 5f6f 6464 5b62 6e5d 0a20 2020 2020 2020  _odd[bn].       
-00007990: 200a 2020 2020 2020 2020 7920 3d20 795f   .        y = y_
-000079a0: 7472 7565 5b62 7326 626e 5d0a 0a20 2020  true[bs&bn]..   
-000079b0: 2020 2020 2074 6172 6765 7420 3d20 6c0a       target = l.
-000079c0: 2020 2020 2020 2020 6966 2028 7920 3d3d          if (y ==
-000079d0: 2074 6172 6765 7429 2e73 756d 2829 203e   target).sum() >
-000079e0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-000079f0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00007a00: 2020 2020 2066 7072 2c20 7470 722c 205f       fpr, tpr, _
-00007a10: 203d 2072 6f63 5f63 7572 7665 2879 2e72   = roc_curve(y.r
-00007a20: 6176 656c 2829 2c20 795f 6f64 642e 7261  avel(), y_odd.ra
-00007a30: 7665 6c28 292c 2070 6f73 5f6c 6162 656c  vel(), pos_label
-00007a40: 203d 2074 6172 6765 7429 0a20 2020 2020   = target).     
-00007a50: 2020 2020 2020 2020 2020 2072 6f63 5f61             roc_a
-00007a60: 7563 203d 2061 7563 2866 7072 2c20 7470  uc = auc(fpr, tp
-00007a70: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-00007a80: 2020 2066 7072 732e 6170 7065 6e64 2866     fprs.append(f
-00007a90: 7072 290a 2020 2020 2020 2020 2020 2020  pr).            
-00007aa0: 2020 2020 7470 7273 2e61 7070 656e 6428      tprs.append(
-00007ab0: 7470 7229 0a20 2020 2020 2020 2020 2020  tpr).           
-00007ac0: 2020 2020 2061 7563 732e 6170 7065 6e64       aucs.append
-00007ad0: 2872 6f63 5f61 7563 290a 2020 2020 2020  (roc_auc).      
-00007ae0: 2020 2020 2020 2020 2020 6365 6c6c 732e            cells.
-00007af0: 6170 7065 6e64 2874 6172 6765 7429 0a20  append(target). 
-00007b00: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00007b10: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-00007b20: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
-00007b30: 2020 2020 2020 2020 2320 7072 696e 7428          # print(
-00007b40: 7929 0a20 2020 2020 2020 2020 2020 2020  y).             
-00007b50: 2020 2023 2070 7269 6e74 2879 5f6f 6464     # print(y_odd
-00007b60: 290a 0a20 2020 2061 6c6c 5f63 656c 6c73  )..    all_cells
-00007b70: 203d 2063 656c 6c5f 7479 7065 0a20 2020   = cell_type.   
-00007b80: 206f 6472 203d 206e 702e 6172 7261 7928   odr = np.array(
-00007b90: 6175 6373 292e 6172 6773 6f72 7428 290a  aucs).argsort().
-00007ba0: 2020 2020 666f 7220 6b2c 206f 2069 6e20      for k, o in 
-00007bb0: 656e 756d 6572 6174 6528 7265 7665 7273  enumerate(revers
-00007bc0: 6564 286f 6472 2929 3a0a 2020 2020 2020  ed(odr)):.      
-00007bd0: 2020 7469 746c 6520 3d20 2225 7320 2841    title = "%s (A
-00007be0: 5543 203d 2025 302e 3366 2922 2025 2028  UC = %0.3f)" % (
-00007bf0: 6c61 6265 6c5b 6f5d 2c20 6175 6373 5b6f  label[o], aucs[o
-00007c00: 5d29 0a20 2020 2020 2020 2070 6c74 2e70  ]).        plt.p
-00007c10: 6c6f 7428 6670 7273 5b6f 5d2c 2074 7072  lot(fprs[o], tpr
-00007c20: 735b 6f5d 2c20 6c61 6265 6c3d 7469 746c  s[o], label=titl
-00007c30: 6529 2023 2c20 636f 6c6f 723d 636c 7374  e) #, color=clst
-00007c40: 5b6b 5d29 0a20 2020 2020 2020 2020 2020  [k]).           
-00007c50: 200a 2020 2020 706c 742e 706c 6f74 285b   .    plt.plot([
-00007c60: 302c 2031 5d2c 205b 302c 2031 5d2c 2063  0, 1], [0, 1], c
-00007c70: 6f6c 6f72 3d22 6e61 7679 222c 206c 773d  olor="navy", lw=
-00007c80: 322c 206c 696e 6573 7479 6c65 3d22 2d2d  2, linestyle="--
-00007c90: 2229 0a20 2020 2070 6c74 2e78 6c69 6d28  ").    plt.xlim(
-00007ca0: 5b30 2e30 2c20 312e 305d 290a 2020 2020  [0.0, 1.0]).    
-00007cb0: 706c 742e 796c 696d 285b 302e 302c 2031  plt.ylim([0.0, 1
-00007cc0: 2e30 355d 290a 2020 2020 706c 742e 786c  .05]).    plt.xl
-00007cd0: 6162 656c 2822 4661 6c73 6520 506f 7369  abel("False Posi
-00007ce0: 7469 7665 2052 6174 6522 2c20 666f 6e74  tive Rate", font
-00007cf0: 7369 7a65 203d 2031 322a 6669 675f 7363  size = 12*fig_sc
-00007d00: 616c 6529 2023 2c20 666f 6e74 7369 7a65  ale) #, fontsize
-00007d10: 203d 2031 3129 0a20 2020 2070 6c74 2e79   = 11).    plt.y
-00007d20: 6c61 6265 6c28 2254 7275 6520 506f 7369  label("True Posi
-00007d30: 7469 7665 2052 6174 6522 2c20 666f 6e74  tive Rate", font
-00007d40: 7369 7a65 203d 2031 322a 6669 675f 7363  size = 12*fig_sc
-00007d50: 616c 6529 2023 2c20 666f 6e74 7369 7a65  ale) #, fontsize
-00007d60: 203d 2031 3129 0a0a 2020 2020 6966 206d   = 11)..    if m
-00007d70: 6574 686f 6420 3d3d 2027 676d 6d27 3a0a  ethod == 'gmm':.
-00007d80: 2020 2020 2020 2020 4d65 7468 6f64 203d          Method =
-00007d90: 2027 4761 7573 7369 616e 204d 6978 7475   'Gaussian Mixtu
-00007da0: 7265 204d 6f64 656c 270a 2020 2020 2020  re Model'.      
-00007db0: 2020 7469 746c 6520 3d20 2252 4f43 2066    title = "ROC f
-00007dc0: 6f72 2069 6465 6e74 6966 7969 6e67 2025  or identifying %
-00007dd0: 735c 6e75 7369 6e67 2025 7322 2025 2028  s\nusing %s" % (
-00007de0: 616c 6c5f 6365 6c6c 732c 204d 6574 686f  all_cells, Metho
-00007df0: 6429 0a20 2020 2065 6c69 6620 6d65 7468  d).    elif meth
-00007e00: 6f64 203d 3d20 276c 6f67 7265 6727 3a0a  od == 'logreg':.
-00007e10: 2020 2020 2020 2020 4d65 7468 6f64 203d          Method =
-00007e20: 2027 4c6f 6769 7374 6963 2052 6567 7265   'Logistic Regre
-00007e30: 7373 696f 6e20 4d6f 6465 6c27 0a20 2020  ssion Model'.   
-00007e40: 2020 2020 2074 6974 6c65 203d 2022 524f       title = "RO
-00007e50: 4320 666f 7220 6964 656e 7469 6679 696e  C for identifyin
-00007e60: 6720 2573 5c6e 7573 696e 6720 2573 2220  g %s\nusing %s" 
-00007e70: 2520 2861 6c6c 5f63 656c 6c73 2c20 4d65  % (all_cells, Me
-00007e80: 7468 6f64 290a 2020 2020 656c 7365 3a0a  thod).    else:.
-00007e90: 2020 2020 2020 2020 4d65 7468 6f64 203d          Method =
-00007ea0: 206d 6574 686f 640a 2020 2020 2020 2020   method.        
-00007eb0: 7469 746c 6520 3d20 2252 4f43 2066 6f72  title = "ROC for
-00007ec0: 2069 6465 6e74 6966 7969 6e67 5c6e 2573   identifying\n%s
-00007ed0: 2075 7369 6e67 2025 7322 2025 2028 616c   using %s" % (al
-00007ee0: 6c5f 6365 6c6c 732c 204d 6574 686f 6429  l_cells, Method)
-00007ef0: 0a0a 2020 2020 706c 742e 7469 746c 6528  ..    plt.title(
-00007f00: 7469 746c 652c 2066 6f6e 7473 697a 6520  title, fontsize 
-00007f10: 3d20 3133 2a66 6967 5f73 6361 6c65 2029  = 13*fig_scale )
-00007f20: 0a20 2020 2070 6c74 2e6c 6567 656e 6428  .    plt.legend(
-00007f30: 6c6f 633d 226c 6f77 6572 2072 6967 6874  loc="lower right
-00007f40: 222c 2066 6f6e 7473 697a 6520 3d20 3130  ", fontsize = 10
-00007f50: 2a66 6967 5f73 6361 6c65 290a 2020 2020  *fig_scale).    
-00007f60: 2320 706c 742e 6c65 6765 6e64 286c 6f63  # plt.legend(loc
-00007f70: 3d22 7570 7065 7220 6c65 6674 222c 2062  ="upper left", b
-00007f80: 626f 785f 746f 5f61 6e63 686f 723d 2831  box_to_anchor=(1
-00007f90: 2e30 332c 2031 2929 2023 202c 2066 6f6e  .03, 1)) # , fon
-00007fa0: 7473 697a 6520 3d20 3132 290a 2020 2020  tsize = 12).    
-00007fb0: 706c 742e 7368 6f77 2829 0a20 2020 200a  plt.show().    .
-00007fc0: 2020 2020 7265 7475 726e 2063 656c 6c73      return cells
-00007fd0: 2c20 6175 6373 0a0a 0a64 6566 2073 686f  , aucs...def sho
-00007fe0: 775f 7375 6d6d 6172 7928 2064 665f 7072  w_summary( df_pr
-00007ff0: 6564 2c20 7375 6d6d 6172 792c 2070 7468  ed, summary, pth
-00008000: 5f66 6974 5f70 6e74 203d 2030 2e33 2c20  _fit_pnt = 0.3, 
-00008010: 6c65 7665 6c20 3d20 332c 200a 2020 2020  level = 3, .    
-00008020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008030: 7370 6c69 7420 3d20 5472 7565 2c20 7363  split = True, sc
-00008040: 616c 6520 3d20 2761 7265 6127 2c20 696e  ale = 'area', in
-00008050: 6e65 7220 3d20 2771 7561 7274 696c 6527  ner = 'quartile'
-00008060: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-00008070: 2020 2020 2020 2076 6c6f 6720 3d20 5472         vlog = Tr
-00008080: 7565 2c20 7677 6964 7468 203d 2031 2c20  ue, vwidth = 1, 
-00008090: 6669 675f 7363 616c 6520 3d20 3120 293a  fig_scale = 1 ):
-000080a0: 0a20 2020 200a 2020 2020 736d 7279 5f72  .    .    smry_r
-000080b0: 6573 203d 2073 756d 6d61 7279 5b27 4753  es = summary['GS
-000080c0: 415f 7375 6d6d 6172 7927 5d0a 2020 2020  A_summary'].    
-000080d0: 7076 616c 5f74 682c 2070 7468 5f6d 756c  pval_th, pth_mul
-000080e0: 742c 2070 7468 5f6d 696e 203d 2073 756d  t, pth_min = sum
-000080f0: 6d61 7279 5b27 7061 7261 6d65 7465 7273  mary['parameters
-00008100: 275d 0a20 2020 200a 2020 2020 2323 2043  '].    .    ## C
-00008110: 6c75 7374 6572 2066 696c 7465 720a 2020  luster filter.  
-00008120: 2020 795f 636c 7573 7420 3d20 6466 5f70    y_clust = df_p
-00008130: 7265 645b 2763 6c75 7374 6572 275d 2e61  red['cluster'].a
-00008140: 7374 7970 6528 696e 7429 202d 2031 0a20  stype(int) - 1. 
-00008150: 2020 2073 636f 7265 203d 2073 6d72 795f     score = smry_
-00008160: 7265 735b 274d 616a 6f72 5f54 7970 6527  res['Major_Type'
-00008170: 5d5b 272d 6c6f 6750 275d 0a20 2020 2070  ]['-logP'].    p
-00008180: 7468 203d 2070 7661 6c5f 7468 2023 2073  th = pval_th # s
-00008190: 6d72 795f 7265 735b 2750 7661 6c5f 7468  mry_res['Pval_th
-000081a0: 7265 7368 6f6c 6427 5d0a 2020 2020 2327  reshold'].    #'
-000081b0: 2727 0a20 2020 2069 6620 6c65 7665 6c20  ''.    if level 
-000081c0: 3e20 303a 0a20 2020 2020 2020 2066 696e  > 0:.        fin
-000081d0: 645f 7063 745f 6375 746f 6666 2873 636f  d_pct_cutoff(sco
-000081e0: 7265 2c20 795f 636c 7573 742c 2070 7468  re, y_clust, pth
-000081f0: 203d 202d 6e70 2e6c 6f67 3130 2870 7468   = -np.log10(pth
-00008200: 292c 200a 2020 2020 2020 2020 2020 2020  ), .            
-00008210: 2020 2020 2020 2020 2020 2020 7063 745f              pct_
-00008220: 6669 745f 706e 7420 3d20 7074 685f 6669  fit_pnt = pth_fi
-00008230: 745f 706e 742c 2070 6374 5f6d 696e 5f72  t_pnt, pct_min_r
-00008240: 6620 3d20 7074 685f 6d69 6e2c 200a 2020  f = pth_min, .  
-00008250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008260: 2020 2020 2020 6669 6773 697a 6520 3d20        figsize = 
-00008270: 2835 2a66 6967 5f73 6361 6c65 2c34 2a66  (5*fig_scale,4*f
-00008280: 6967 5f73 6361 6c65 292c 2070 7269 6e74  ig_scale), print
-00008290: 5f72 6570 6f72 7420 3d20 5472 7565 290a  _report = True).
-000082a0: 2020 2020 2327 2727 0a0a 2020 2020 2323      #'''..    ##
-000082b0: 2047 5341 2052 4f43 0a20 2020 2073 6d72   GSA ROC.    smr
-000082c0: 795f 7363 6f72 6520 3d20 7375 6d6d 6172  y_score = summar
-000082d0: 795b 2747 5341 5f73 636f 7265 7327 5d0a  y['GSA_scores'].
-000082e0: 2020 2020 6b65 7973 203d 206c 6973 7428      keys = list(
-000082f0: 736d 7279 5f73 636f 7265 2e6b 6579 7328  smry_score.keys(
-00008300: 2929 0a0a 2020 2020 6b65 7920 3d20 274d  ))..    key = 'M
-00008310: 616a 6f72 5f54 7970 6527 0a20 2020 2064  ajor_Type'.    d
-00008320: 665f 7363 6f72 6520 3d20 736d 7279 5f73  f_score = smry_s
-00008330: 636f 7265 5b6b 6579 5d0a 2020 2020 7973  core[key].    ys
-00008340: 203d 2073 6d72 795f 7265 735b 6b65 795d   = smry_res[key]
-00008350: 5b27 6365 6c6c 5f74 7970 6527 5d0a 2020  ['cell_type'].  
-00008360: 2020 2320 6966 206c 6576 656c 203e 2031    # if level > 1
-00008370: 3a0a 2020 2020 6365 6c6c 732c 2061 7563  :.    cells, auc
-00008380: 7320 3d20 706c 6f74 5f72 6f63 5f72 6573  s = plot_roc_res
-00008390: 756c 7428 6466 5f73 636f 7265 2c20 7973  ult(df_score, ys
-000083a0: 2c20 6b65 792c 2027 4753 4127 2c20 6669  , key, 'GSA', fi
-000083b0: 675f 7363 616c 6520 3d20 6669 675f 7363  g_scale = fig_sc
-000083c0: 616c 6529 2020 2020 0a20 2020 2064 665f  ale)    .    df_
-000083d0: 6175 635f 6d61 6a20 3d20 7064 2e44 6174  auc_maj = pd.Dat
-000083e0: 6146 7261 6d65 287b 2741 5543 2075 7369  aFrame({'AUC usi
-000083f0: 6e67 2047 5341 273a 2061 7563 737d 2c20  ng GSA': aucs}, 
-00008400: 696e 6465 7820 3d20 6365 6c6c 7329 0a20  index = cells). 
-00008410: 2020 2020 2020 200a 2020 2020 2323 2049         .    ## I
-00008420: 4420 6d6f 6465 6c20 524f 430a 2020 2020  D model ROC.    
-00008430: 736d 7279 5f73 636f 7265 203d 2073 756d  smry_score = sum
-00008440: 6d61 7279 5b27 4964 656e 7469 6669 6361  mary['Identifica
-00008450: 7469 6f6e 5f6d 6f64 656c 5f73 636f 7265  tion_model_score
-00008460: 7327 5d0a 2020 2020 6b65 7973 203d 206c  s'].    keys = l
-00008470: 6973 7428 736d 7279 5f73 636f 7265 2e6b  ist(smry_score.k
-00008480: 6579 7328 2929 0a0a 2020 2020 6b65 7920  eys())..    key 
-00008490: 3d20 274d 616a 6f72 5f54 7970 6527 0a20  = 'Major_Type'. 
-000084a0: 2020 2064 665f 7363 6f72 6520 3d20 736d     df_score = sm
-000084b0: 7279 5f73 636f 7265 5b6b 6579 5d0a 2020  ry_score[key].  
-000084c0: 2020 7973 203d 2073 6d72 795f 7265 735b    ys = smry_res[
-000084d0: 6b65 795d 5b27 6365 6c6c 5f74 7970 6527  key]['cell_type'
-000084e0: 5d0a 2020 2020 2320 6966 206c 6576 656c  ].    # if level
-000084f0: 203e 2031 3a0a 2020 2020 6365 6c6c 732c   > 1:.    cells,
-00008500: 2061 7563 7320 3d20 706c 6f74 5f72 6f63   aucs = plot_roc
-00008510: 5f72 6573 756c 7428 6466 5f73 636f 7265  _result(df_score
-00008520: 2c20 7973 2c20 6b65 792c 2027 676d 6d27  , ys, key, 'gmm'
-00008530: 2c20 6669 675f 7363 616c 6520 3d20 6669  , fig_scale = fi
-00008540: 675f 7363 616c 6529 2020 2020 0a20 2020  g_scale)    .   
-00008550: 2064 665f 6175 635f 6d61 6a5b 2741 5543   df_auc_maj['AUC
-00008560: 2075 7369 6e67 2047 4d4d 275d 203d 2061   using GMM'] = a
-00008570: 7563 730a 0a20 2020 2023 2320 4753 4120  ucs..    ## GSA 
-00008580: 7363 6f72 6520 6869 7374 6f67 7261 6d0a  score histogram.
-00008590: 2020 2020 6966 206c 6576 656c 203e 2032      if level > 2
-000085a0: 3a0a 2020 2020 2020 2020 736d 7279 5f73  :.        smry_s
-000085b0: 636f 7265 203d 2073 756d 6d61 7279 5b27  core = summary['
-000085c0: 4753 415f 7363 6f72 6573 275d 0a20 2020  GSA_scores'].   
-000085d0: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
-000085e0: 736d 7279 5f73 636f 7265 2e6b 6579 7328  smry_score.keys(
-000085f0: 293a 0a20 2020 2020 2020 2020 2020 2064  ):.            d
-00008600: 665f 7363 6f72 6520 3d20 736d 7279 5f73  f_score = smry_s
-00008610: 636f 7265 5b6b 6579 5d0a 2020 2020 2020  core[key].      
-00008620: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00008630: 6e63 6528 6466 5f73 636f 7265 2c20 7064  nce(df_score, pd
-00008640: 2e44 6174 6146 7261 6d65 293a 0a20 2020  .DataFrame):.   
-00008650: 2020 2020 2020 2020 2020 2020 2070 6c6f               plo
-00008660: 745f 4753 415f 7363 6f72 655f 7669 6f6c  t_GSA_score_viol
-00008670: 696e 2864 665f 7363 6f72 652c 2074 6974  in(df_score, tit
-00008680: 6c65 203d 206b 6579 2c20 7370 6c69 7420  le = key, split 
-00008690: 3d20 7370 6c69 742c 200a 2020 2020 2020  = split, .      
-000086a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000086b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000086c0: 7363 616c 6520 3d20 7363 616c 652c 2069  scale = scale, i
-000086d0: 6e6e 6572 203d 2069 6e6e 6572 2c20 0a20  nner = inner, . 
-000086e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000086f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008700: 2020 2020 206c 6f67 203d 2076 6c6f 672c       log = vlog,
-00008710: 2077 6964 7468 203d 2076 7769 6474 682c   width = vwidth,
-00008720: 2066 6967 5f73 6361 6c65 203d 2066 6967   fig_scale = fig
-00008730: 5f73 6361 6c65 290a 0a20 2020 2023 2320  _scale)..    ## 
-00008740: 4753 4120 7363 6f72 6520 6869 7374 6f67  GSA score histog
-00008750: 7261 6d0a 2020 2020 6966 206c 6576 656c  ram.    if level
-00008760: 203e 2032 3a0a 2020 2020 2020 2020 6966   > 2:.        if
-00008770: 2027 5265 665f 7363 6f72 6573 2720 696e   'Ref_scores' in
-00008780: 206c 6973 7428 7375 6d6d 6172 792e 6b65   list(summary.ke
-00008790: 7973 2829 293a 0a20 2020 2020 2020 2020  ys()):.         
-000087a0: 2020 2073 6d72 795f 7363 6f72 6520 3d20     smry_score = 
-000087b0: 7375 6d6d 6172 795b 2752 6566 5f73 636f  summary['Ref_sco
-000087c0: 7265 7327 5d0a 2020 2020 2020 2020 656c  res'].        el
-000087d0: 7365 3a20 0a20 2020 2020 2020 2020 2020  se: .           
-000087e0: 2073 6d72 795f 7363 6f72 6520 3d20 7375   smry_score = su
-000087f0: 6d6d 6172 795b 2747 5341 5f73 636f 7265  mmary['GSA_score
-00008800: 7327 5d0a 2020 2020 2020 2020 736d 7279  s'].        smry
-00008810: 5f72 6573 203d 2073 756d 6d61 7279 5b27  _res = summary['
-00008820: 4753 415f 7375 6d6d 6172 7927 5d0a 2020  GSA_summary'].  
-00008830: 2020 2020 2020 636e 7420 3d20 300a 2020        cnt = 0.  
-00008840: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
-00008850: 2073 6d72 795f 7363 6f72 652e 6b65 7973   smry_score.keys
-00008860: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00008870: 6466 5f73 636f 7265 203d 2073 6d72 795f  df_score = smry_
-00008880: 7363 6f72 655b 6b65 795d 0a20 2020 2020  score[key].     
-00008890: 2020 2020 2020 2079 7320 3d20 736d 7279         ys = smry
-000088a0: 5f72 6573 5b6b 6579 5d5b 2763 656c 6c5f  _res[key]['cell_
-000088b0: 7479 7065 275d 0a20 2020 2020 2020 2020  type'].         
-000088c0: 2020 2069 6620 2827 6d69 6e6f 7227 2069     if ('minor' i
-000088d0: 6e20 6b65 7929 2026 2028 6b65 7920 213d  n key) & (key !=
-000088e0: 2027 4d61 6a6f 725f 5479 7065 2729 2026   'Major_Type') &
-000088f0: 2028 6c65 7665 6c20 3e20 3129 2026 2028   (level > 1) & (
-00008900: 6466 5f73 636f 7265 2e73 6861 7065 5b31  df_score.shape[1
-00008910: 5d20 3e20 3129 3a0a 2020 2020 2020 2020  ] > 1):.        
-00008920: 2020 2020 2020 2020 6365 6c6c 732c 2061          cells, a
-00008930: 7563 7320 3d20 706c 6f74 5f72 6f63 5f72  ucs = plot_roc_r
-00008940: 6573 756c 7428 6466 5f73 636f 7265 2c20  esult(df_score, 
-00008950: 7973 2c20 6b65 792c 2027 4753 4127 2920  ys, key, 'GSA') 
-00008960: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-00008970: 2020 2020 6966 2063 6e74 203d 3d20 303a      if cnt == 0:
-00008980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008990: 2020 2020 2064 665f 6175 635f 6d69 6e20       df_auc_min 
-000089a0: 3d20 7064 2e44 6174 6146 7261 6d65 287b  = pd.DataFrame({
-000089b0: 2741 5543 2075 7369 6e67 2047 5341 273a  'AUC using GSA':
-000089c0: 2061 7563 737d 2c20 696e 6465 7820 3d20   aucs}, index = 
-000089d0: 6365 6c6c 7329 0a20 2020 2020 2020 2020  cells).         
-000089e0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000089f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a00: 2064 665f 6175 635f 6d69 6e20 3d20 7064   df_auc_min = pd
-00008a10: 2e63 6f6e 6361 7428 5b64 665f 6175 635f  .concat([df_auc_
-00008a20: 6d69 6e2c 2070 642e 4461 7461 4672 616d  min, pd.DataFram
-00008a30: 6528 7b27 4155 4327 3a20 6175 6373 7d2c  e({'AUC': aucs},
-00008a40: 2069 6e64 6578 203d 2063 656c 6c73 295d   index = cells)]
-00008a50: 2c20 6178 6973 203d 2030 290a 2020 2020  , axis = 0).    
-00008a60: 2020 2020 2020 2020 2020 2020 636e 7420              cnt 
-00008a70: 2b3d 2031 0a20 2020 2020 2020 2069 6620  += 1.        if 
-00008a80: 636e 7420 3d3d 2030 3a0a 2020 2020 2020  cnt == 0:.      
-00008a90: 2020 2020 2020 6466 5f61 7563 5f6d 696e        df_auc_min
-00008aa0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00008ab0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00008ac0: 2063 6e74 203d 2030 0a20 2020 2020 2020   cnt = 0.       
-00008ad0: 2066 6f72 206b 6579 2069 6e20 736d 7279   for key in smry
-00008ae0: 5f73 636f 7265 2e6b 6579 7328 293a 0a20  _score.keys():. 
-00008af0: 2020 2020 2020 2020 2020 2064 665f 7363             df_sc
-00008b00: 6f72 6520 3d20 736d 7279 5f73 636f 7265  ore = smry_score
-00008b10: 5b6b 6579 5d0a 2020 2020 2020 2020 2020  [key].          
-00008b20: 2020 7973 203d 2073 6d72 795f 7265 735b    ys = smry_res[
-00008b30: 6b65 795d 5b27 6365 6c6c 5f74 7970 6527  key]['cell_type'
-00008b40: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
-00008b50: 2028 276d 696e 6f72 2720 6e6f 7420 696e   ('minor' not in
-00008b60: 206b 6579 2920 2620 286b 6579 2021 3d20   key) & (key != 
-00008b70: 274d 616a 6f72 5f54 7970 6527 2920 2620  'Major_Type') & 
-00008b80: 286c 6576 656c 203e 2031 2920 2620 2864  (level > 1) & (d
-00008b90: 665f 7363 6f72 652e 7368 6170 655b 315d  f_score.shape[1]
-00008ba0: 203e 2031 293a 0a20 2020 2020 2020 2020   > 1):.         
-00008bb0: 2020 2020 2020 2063 656c 6c73 2c20 6175         cells, au
-00008bc0: 6373 203d 2070 6c6f 745f 726f 635f 7265  cs = plot_roc_re
-00008bd0: 7375 6c74 2864 665f 7363 6f72 652c 2079  sult(df_score, y
-00008be0: 732c 206b 6579 2c20 2747 5341 2729 2020  s, key, 'GSA')  
-00008bf0: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
-00008c00: 2020 2069 6620 636e 7420 3d3d 2030 3a0a     if cnt == 0:.
-00008c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008c20: 2020 2020 6466 5f61 7563 203d 2070 642e      df_auc = pd.
-00008c30: 4461 7461 4672 616d 6528 7b27 4155 4327  DataFrame({'AUC'
-00008c40: 3a20 6175 6373 7d2c 2069 6e64 6578 203d  : aucs}, index =
-00008c50: 2063 656c 6c73 290a 2020 2020 2020 2020   cells).        
-00008c60: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00008c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008c80: 2020 6466 5f61 7563 203d 2070 642e 636f    df_auc = pd.co
-00008c90: 6e63 6174 285b 6466 5f61 7563 2c20 7064  ncat([df_auc, pd
-00008ca0: 2e44 6174 6146 7261 6d65 287b 2741 5543  .DataFrame({'AUC
-00008cb0: 273a 2061 7563 737d 2c20 696e 6465 7820  ': aucs}, index 
-00008cc0: 3d20 6365 6c6c 7329 5d2c 2061 7869 7320  = cells)], axis 
-00008cd0: 3d20 3029 0a20 2020 2020 2020 2020 2020  = 0).           
-00008ce0: 2020 2020 2063 6e74 202b 3d20 310a 2020       cnt += 1.  
-00008cf0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-00008d00: 2020 2020 2020 2069 6620 636e 7420 3d3d         if cnt ==
-00008d10: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00008d20: 6466 5f61 7563 203d 204e 6f6e 650a 2020  df_auc = None.  
-00008d30: 2020 2020 2020 2020 2020 2020 2020 200a                 .
-00008d40: 2020 2020 2323 2047 5341 2073 636f 7265      ## GSA score
-00008d50: 2068 6973 746f 6772 616d 0a20 2020 2069   histogram.    i
-00008d60: 6620 6c65 7665 6c20 3e20 323a 0a20 2020  f level > 2:.   
-00008d70: 2020 2020 2069 6620 2752 6566 5f73 636f       if 'Ref_sco
-00008d80: 7265 7327 2069 6e20 6c69 7374 2873 756d  res' in list(sum
-00008d90: 6d61 7279 2e6b 6579 7328 2929 3a0a 2020  mary.keys()):.  
-00008da0: 2020 2020 2020 2020 2020 736d 7279 5f73            smry_s
-00008db0: 636f 7265 203d 2073 756d 6d61 7279 5b27  core = summary['
-00008dc0: 5265 665f 7363 6f72 6573 275d 0a20 2020  Ref_scores'].   
-00008dd0: 2020 2020 2020 2020 2066 6f72 206b 6579           for key
-00008de0: 2069 6e20 736d 7279 5f73 636f 7265 2e6b   in smry_score.k
-00008df0: 6579 7328 293a 0a20 2020 2020 2020 2020  eys():.         
-00008e00: 2020 2020 2020 2064 665f 7363 6f72 6520         df_score 
-00008e10: 3d20 736d 7279 5f73 636f 7265 5b6b 6579  = smry_score[key
-00008e20: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00008e30: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00008e40: 6466 5f73 636f 7265 2c20 7064 2e44 6174  df_score, pd.Dat
-00008e50: 6146 7261 6d65 293a 0a20 2020 2020 2020  aFrame):.       
-00008e60: 2020 2020 2020 2020 2020 2020 2070 6c6f               plo
-00008e70: 745f 4753 415f 7363 6f72 655f 7669 6f6c  t_GSA_score_viol
-00008e80: 696e 2864 665f 7363 6f72 652c 2074 6974  in(df_score, tit
-00008e90: 6c65 203d 206b 6579 2c20 7370 6c69 7420  le = key, split 
-00008ea0: 3d20 7370 6c69 742c 200a 2020 2020 2020  = split, .      
-00008eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ed0: 2020 2020 7363 616c 6520 3d20 7363 616c      scale = scal
-00008ee0: 652c 2069 6e6e 6572 203d 2069 6e6e 6572  e, inner = inner
-00008ef0: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-00008f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f10: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-00008f20: 203d 2046 616c 7365 2c20 7769 6474 6820   = False, width 
-00008f30: 3d20 7677 6964 7468 2c20 6669 675f 7363  = vwidth, fig_sc
-00008f40: 616c 6520 3d20 6669 675f 7363 616c 6529  ale = fig_scale)
-00008f50: 0a0a 2020 2020 7265 7475 726e 2064 665f  ..    return df_
-00008f60: 6175 635f 6d61 6a2c 2064 665f 6175 635f  auc_maj, df_auc_
-00008f70: 6d69 6e2c 2064 665f 6175 630a 0a20 2020  min, df_auc..   
-00008f80: 200a 6465 6620 585f 6e6f 726d 616c 697a   .def X_normaliz
-00008f90: 6528 5829 3a20 2020 200a 2020 2020 7265  e(X):    .    re
-00008fa0: 7475 726e 2058 2e64 6976 2858 2e73 756d  turn X.div(X.sum
-00008fb0: 2861 7869 733d 3129 2a30 2e30 3030 3120  (axis=1)*0.0001 
-00008fc0: 2b20 302e 3030 3031 2c20 6178 6973 203d  + 0.0001, axis =
-00008fd0: 2030 290a 0a0a 6465 6620 585f 7363 616c   0)...def X_scal
-00008fe0: 6528 582c 206d 6178 5f76 616c 203d 2031  e(X, max_val = 1
-00008ff0: 3029 3a20 2020 200a 2020 2020 6d20 3d20  0):    .    m = 
-00009000: 582e 6d65 616e 2861 7869 7320 3d20 3029  X.mean(axis = 0)
-00009010: 0a20 2020 2073 203d 2058 2e73 7464 2861  .    s = X.std(a
-00009020: 7869 7320 3d20 3029 0a20 2020 200a 2020  xis = 0).    .  
-00009030: 2020 5873 203d 2058 2e73 7562 286d 292e    Xs = X.sub(m).
-00009040: 6d75 6c28 2873 203e 2030 292f 2873 2b20  mul((s > 0)/(s+ 
-00009050: 302e 3030 3031 2929 0a20 2020 2058 732e  0.0001)).    Xs.
-00009060: 636c 6970 2875 7070 6572 203d 206d 6178  clip(upper = max
-00009070: 5f76 616c 2c20 6c6f 7765 7220 3d20 2d6d  _val, lower = -m
-00009080: 6178 5f76 616c 2c20 696e 706c 6163 6520  ax_val, inplace 
-00009090: 3d20 5472 7565 290a 2020 2020 0a20 2020  = True).    .   
-000090a0: 2072 6574 7572 6e20 5873 0a0a 0a64 6566   return Xs...def
-000090b0: 2073 656c 6563 745f 7661 7269 6162 6c65   select_variable
-000090c0: 5f67 656e 6573 5f6f 6c64 2858 2c20 6c6f  _genes_old(X, lo
-000090d0: 675f 7472 616e 7366 6f72 6d65 6420 3d20  g_transformed = 
-000090e0: 4661 6c73 652c 204e 5f67 656e 6573 203d  False, N_genes =
-000090f0: 2032 3030 3029 3a0a 2020 2020 0a20 2020   2000):.    .   
-00009100: 2027 2727 0a20 2020 2069 6620 6c6f 675f   '''.    if log_
-00009110: 7472 616e 7366 6f72 6d65 643a 0a20 2020  transformed:.   
-00009120: 2020 2020 2058 7320 3d20 3130 2a2a 580a       Xs = 10**X.
-00009130: 2020 2020 2020 2020 5873 203d 2058 7320          Xs = Xs 
-00009140: 2d20 5873 2e6d 696e 2829 2e6d 696e 2829  - Xs.min().min()
-00009150: 0a20 2020 2065 6c73 653a 0a20 2020 2027  .    else:.    '
-00009160: 2727 0a20 2020 2058 7320 3d20 5820 0a20  ''.    Xs = X . 
-00009170: 2020 2020 2020 200a 2020 2020 736d 203d         .    sm =
-00009180: 2028 5873 203e 2030 292e 7375 6d28 6178   (Xs > 0).sum(ax
-00009190: 6973 203d 2030 290a 2020 2020 6d20 3d20  is = 0).    m = 
-000091a0: 5873 2e6d 6561 6e28 6178 6973 203d 2030  Xs.mean(axis = 0
-000091b0: 290a 2020 2020 7320 3d20 5873 2e76 6172  ).    s = Xs.var
-000091c0: 2861 7869 7320 3d20 3029 0a0a 2020 2020  (axis = 0)..    
-000091d0: 7468 203d 206d 6178 2831 302c 2058 732e  th = max(10, Xs.
-000091e0: 7368 6170 655b 305d 2a30 2e30 3032 290a  shape[0]*0.002).
-000091f0: 2020 2020 6220 3d20 286d 203e 2030 2920      b = (m > 0) 
-00009200: 2620 2873 203e 2030 2920 2620 2873 6d20  & (s > 0) & (sm 
-00009210: 3e20 7468 290a 2020 2020 0a20 2020 2070  > th).    .    p
-00009220: 7269 6e74 286e 702e 7375 6d28 6d20 3e20  rint(np.sum(m > 
-00009230: 3029 2c6e 702e 7375 6d28 7320 3e20 3029  0),np.sum(s > 0)
-00009240: 2c6e 702e 7375 6d28 736d 203e 2074 6829  ,np.sum(sm > th)
-00009250: 2c20 6c65 6e28 6d29 290a 2020 2020 0a20  , len(m)).    . 
-00009260: 2020 206d 203d 206d 5b62 5d0a 2020 2020     m = m[b].    
-00009270: 7320 3d20 735b 625d 0a20 2020 2058 7320  s = s[b].    Xs 
-00009280: 3d20 5873 2e6c 6f63 5b3a 2c62 5d0a 2020  = Xs.loc[:,b].  
-00009290: 2020 2020 2020 0a20 2020 2023 2320 5365        .    ## Se
-000092a0: 6c65 6374 2067 656e 6573 0a20 2020 2078  lect genes.    x
-000092b0: 736d 203d 2058 732e 7375 6d28 6178 6973  sm = Xs.sum(axis
-000092c0: 203d 2030 290a 2020 2020 6f64 7220 3d20   = 0).    odr = 
-000092d0: 6e70 2e61 7272 6179 2878 736d 292e 6172  np.array(xsm).ar
-000092e0: 6773 6f72 7428 290a 2020 2020 6c63 203d  gsort().    lc =
-000092f0: 2069 6e74 286c 656e 286f 6472 292a 302e   int(len(odr)*0.
-00009300: 3129 0a20 2020 2075 6320 3d20 696e 7428  1).    uc = int(
-00009310: 6c65 6e28 6f64 7229 2a30 2e39 290a 2020  len(odr)*0.9).  
-00009320: 2020 7873 6d5f 7365 6c20 3d20 7873 6d5b    xsm_sel = xsm[
-00009330: 6f64 725b 6c63 3a75 635d 5d0a 2020 2020  odr[lc:uc]].    
-00009340: 6d69 6e5f 7873 6d20 3d20 7873 6d5f 7365  min_xsm = xsm_se
-00009350: 6c2e 6d69 6e28 290a 2020 2020 6d61 785f  l.min().    max_
-00009360: 7873 6d20 3d20 7873 6d5f 7365 6c2e 6d61  xsm = xsm_sel.ma
-00009370: 7828 290a 2020 2020 4e73 203d 2031 300a  x().    Ns = 10.
-00009380: 2020 2020 6478 203d 2028 6d61 785f 7873      dx = (max_xs
-00009390: 6d20 2d20 6d69 6e5f 7873 6d29 2f4e 730a  m - min_xsm)/Ns.
-000093a0: 2020 2020 0a20 2020 2072 6e67 203d 206e      .    rng = n
-000093b0: 702e 6172 616e 6765 286d 696e 5f78 736d  p.arange(min_xsm
-000093c0: 2c20 6d61 785f 7873 6d2b 284e 732f 3229  , max_xsm+(Ns/2)
-000093d0: 2c20 6478 290a 2020 2020 6e73 7320 3d20  , dx).    nss = 
-000093e0: 5b5d 0a20 2020 2066 6f72 206e 2069 6e20  [].    for n in 
-000093f0: 7261 6e67 6528 4e73 293a 0a20 2020 2020  range(Ns):.     
-00009400: 2020 206c 6320 3d20 726e 675b 6e5d 0a20     lc = rng[n]. 
-00009410: 2020 2020 2020 2075 6320 3d20 726e 675b         uc = rng[
-00009420: 6e2b 315d 0a20 2020 2020 2020 2062 7820  n+1].        bx 
-00009430: 3d20 2878 736d 203e 3d20 6c63 2920 2620  = (xsm >= lc) & 
-00009440: 2878 736d 203c 2075 6329 0a20 2020 2020  (xsm < uc).     
-00009450: 2020 206e 7373 2e61 7070 656e 6428 6e70     nss.append(np
-00009460: 2e73 756d 2862 7829 290a 2020 2020 2020  .sum(bx)).      
-00009470: 2020 0a20 2020 204e 5f74 6f5f 7365 6c20    .    N_to_sel 
-00009480: 3d20 696e 7428 6e70 2e6d 6561 6e28 6e73  = int(np.mean(ns
-00009490: 7329 290a 2020 2020 6966 204e 5f74 6f5f  s)).    if N_to_
-000094a0: 7365 6c20 3c20 3430 303a 0a20 2020 2020  sel < 400:.     
-000094b0: 2020 204e 5f74 6f5f 7365 6c20 3d20 696e     N_to_sel = in
-000094c0: 7428 3430 3029 0a20 2020 2023 2070 7269  t(400).    # pri
-000094d0: 6e74 284e 5f74 6f5f 7365 6c2c 206e 702e  nt(N_to_sel, np.
-000094e0: 6d61 7828 6e73 7329 2c20 6e70 2e6d 696e  max(nss), np.min
-000094f0: 286e 7373 292c 206e 702e 6d65 6469 616e  (nss), np.median
-00009500: 286e 7373 2929 0a20 2020 2020 2020 200a  (nss)).        .
-00009510: 2020 2020 6267 203d 2078 736d 203c 2030      bg = xsm < 0
-00009520: 0a20 2020 2069 6478 203d 2062 672e 696e  .    idx = bg.in
-00009530: 6465 782e 7661 6c75 6573 0a20 2020 206e  dex.values.    n
-00009540: 702e 7261 6e64 6f6d 2e73 6565 6428 3029  p.random.seed(0)
-00009550: 0a20 2020 2066 6f72 206e 2069 6e20 7261  .    for n in ra
-00009560: 6e67 6528 4e73 293a 0a20 2020 2020 2020  nge(Ns):.       
-00009570: 206c 6320 3d20 726e 675b 6e5d 0a20 2020   lc = rng[n].   
-00009580: 2020 2020 2075 6320 3d20 726e 675b 6e2b       uc = rng[n+
-00009590: 315d 0a20 2020 2020 2020 2062 7820 3d20  1].        bx = 
-000095a0: 2878 736d 203e 3d20 6c63 2920 2620 2878  (xsm >= lc) & (x
-000095b0: 736d 203c 2075 6329 0a20 2020 2020 2020  sm < uc).       
-000095c0: 2069 6620 6e70 2e73 756d 2862 7829 203c   if np.sum(bx) <
-000095d0: 3d20 4e5f 746f 5f73 656c 3a0a 2020 2020  = N_to_sel:.    
-000095e0: 2020 2020 2020 2020 6267 5b62 785d 203d          bg[bx] =
-000095f0: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
-00009600: 2020 2320 7072 696e 7428 2725 692f 2569    # print('%i/%i
-00009610: 2c27 2025 2028 6e70 2e73 756d 2862 7829  ,' % (np.sum(bx)
-00009620: 2c20 4e5f 746f 5f73 656c 2929 0a20 2020  , N_to_sel)).   
-00009630: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00009640: 2020 2020 2020 2069 6c73 7420 3d20 6c69         ilst = li
-00009650: 7374 2869 6478 5b62 785d 290a 2020 2020  st(idx[bx]).    
-00009660: 2020 2020 2020 2020 6c73 745f 7365 6c20          lst_sel 
-00009670: 3d20 6e70 2e72 616e 646f 6d2e 6368 6f69  = np.random.choi
-00009680: 6365 2869 6c73 742c 204e 5f74 6f5f 7365  ce(ilst, N_to_se
-00009690: 6c2c 2072 6570 6c61 6365 203d 2046 616c  l, replace = Fal
-000096a0: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
-000096b0: 6267 5b6c 7374 5f73 656c 5d20 3d20 5472  bg[lst_sel] = Tr
-000096c0: 7565 0a20 2020 2020 2020 2020 2020 2023  ue.            #
-000096d0: 2070 7269 6e74 2827 2569 2f25 692c 2720   print('%i/%i,' 
-000096e0: 2520 286c 656e 286c 7374 5f73 656c 292c  % (len(lst_sel),
-000096f0: 204e 5f74 6f5f 7365 6c29 290a 2020 2020   N_to_sel)).    
-00009700: 2020 2020 2020 2020 0a20 2020 2058 735f          .    Xs_
-00009710: 7365 6c20 3d20 5873 2e6c 6f63 5b3a 2c62  sel = Xs.loc[:,b
-00009720: 675d 2020 2020 0a20 2020 2020 2020 200a  g]    .        .
-00009730: 2020 2020 2323 2046 6974 0a20 2020 206d      ## Fit.    m
-00009740: 5f73 656c 203d 2058 735f 7365 6c2e 6d65  _sel = Xs_sel.me
-00009750: 616e 2861 7869 7320 3d20 3029 0a20 2020  an(axis = 0).   
-00009760: 2073 5f73 656c 203d 2058 735f 7365 6c2e   s_sel = Xs_sel.
-00009770: 7661 7228 6178 6973 203d 2030 290a 0a20  var(axis = 0).. 
-00009780: 2020 206c 6d5f 7365 6c20 3d20 6e70 2e6c     lm_sel = np.l
-00009790: 6f67 3130 286d 5f73 656c 202b 2030 2e30  og10(m_sel + 0.0
-000097a0: 3030 3030 3129 0a20 2020 206c 735f 7365  00001).    ls_se
-000097b0: 6c20 3d20 6e70 2e6c 6f67 3130 2873 5f73  l = np.log10(s_s
-000097c0: 656c 202b 2030 2e30 3030 3030 3129 0a20  el + 0.000001). 
-000097d0: 2020 200a 2020 2020 7a20 3d20 6e70 2e70     .    z = np.p
-000097e0: 6f6c 7966 6974 286c 6d5f 7365 6c2c 206c  olyfit(lm_sel, l
-000097f0: 735f 7365 6c2c 2032 290a 2020 2020 7020  s_sel, 2).    p 
-00009800: 3d20 6e70 2e70 6f6c 7931 6428 7a29 0a20  = np.poly1d(z). 
-00009810: 2020 200a 2020 2020 2323 2053 656c 6563     .    ## Selec
-00009820: 7420 6765 6e65 730a 2020 2020 6d20 3d20  t genes.    m = 
-00009830: 5873 2e6d 6561 6e28 6178 6973 203d 2030  Xs.mean(axis = 0
-00009840: 290a 2020 2020 7320 3d20 5873 2e76 6172  ).    s = Xs.var
-00009850: 2861 7869 7320 3d20 3029 0a0a 2020 2020  (axis = 0)..    
-00009860: 6c6d 203d 206e 702e 6c6f 6731 3028 6d20  lm = np.log10(m 
-00009870: 2b20 302e 3030 3030 3031 290a 2020 2020  + 0.000001).    
-00009880: 6c73 203d 206e 702e 6c6f 6731 3028 7320  ls = np.log10(s 
-00009890: 2b20 302e 3030 3030 3031 290a 2020 2020  + 0.000001).    
-000098a0: 0a20 2020 2073 5f66 6974 203d 2031 302a  .    s_fit = 10*
-000098b0: 2a28 7028 6c6d 2929 0a0a 2020 2020 5874  *(p(lm))..    Xt
-000098c0: 203d 2058 732e 7375 6228 6d29 2e6d 756c   = Xs.sub(m).mul
-000098d0: 2831 2f6e 702e 7371 7274 2873 5f66 6974  (1/np.sqrt(s_fit
-000098e0: 2929 0a20 2020 2058 742e 636c 6970 2875  )).    Xt.clip(u
-000098f0: 7070 6572 203d 206e 702e 7371 7274 2858  pper = np.sqrt(X
-00009900: 742e 7368 6170 655b 305d 292c 2069 6e70  t.shape[0]), inp
-00009910: 6c61 6365 203d 2054 7275 6529 0a0a 2020  lace = True)..  
-00009920: 2020 7372 203d 2058 742e 7374 6428 6178    sr = Xt.std(ax
-00009930: 6973 203d 2030 290a 2020 2020 6f64 7220  is = 0).    odr 
-00009940: 3d20 6e70 2e61 7272 6179 2873 7229 2e61  = np.array(sr).a
-00009950: 7267 736f 7274 2829 0a20 2020 2073 5f74  rgsort().    s_t
-00009960: 6820 3d20 7372 5b6f 6472 5b2d 4e5f 6765  h = sr[odr[-N_ge
-00009970: 6e65 735d 5d0a 2020 2020 6765 6e65 7320  nes]].    genes 
-00009980: 3d20 6c69 7374 2858 742e 636f 6c75 6d6e  = list(Xt.column
-00009990: 732e 7661 6c75 6573 5b73 7220 3e3d 2073  s.values[sr >= s
-000099a0: 5f74 685d 290a 2020 2020 0a20 2020 2072  _th]).    .    r
-000099b0: 6574 7572 6e20 6765 6e65 730a 0a0a 6465  eturn genes...de
-000099c0: 6620 7365 6c65 6374 5f76 6172 6961 626c  f select_variabl
-000099d0: 655f 6765 6e65 7328 6c6f 6731 705f 582c  e_genes(log1p_X,
-000099e0: 204e 5f67 656e 6573 203d 2032 3030 3029   N_genes = 2000)
-000099f0: 3a0a 2020 2020 0a20 2020 2058 6120 3d20  :.    .    Xa = 
-00009a00: 6c6f 6731 705f 5820 0a20 2020 2020 2020  log1p_X .       
-00009a10: 200a 2020 2020 2320 736d 203d 2028 5861   .    # sm = (Xa
-00009a20: 203e 2030 292e 7375 6d28 6178 6973 203d   > 0).sum(axis =
-00009a30: 2030 290a 2020 2020 6d61 203d 2058 612e   0).    ma = Xa.
-00009a40: 6d65 616e 2861 7869 7320 3d20 3029 0a20  mean(axis = 0). 
-00009a50: 2020 2073 6120 3d20 5861 2e73 7464 2861     sa = Xa.std(a
-00009a60: 7869 7320 3d20 3029 0a20 2020 200a 2020  xis = 0).    .  
-00009a70: 2020 2323 2053 656c 6563 7420 6765 6e65    ## Select gene
-00009a80: 730a 2020 2020 7873 6d20 3d20 2858 6129  s.    xsm = (Xa)
-00009a90: 2e73 756d 2861 7869 7320 3d20 3029 0a20  .sum(axis = 0). 
-00009aa0: 2020 206f 6472 203d 206e 702e 6172 7261     odr = np.arra
-00009ab0: 7928 7873 6d29 2e61 7267 736f 7274 2829  y(xsm).argsort()
-00009ac0: 0a20 2020 206c 6320 3d20 696e 7428 6c65  .    lc = int(le
-00009ad0: 6e28 6f64 7229 2a30 2e30 3529 0a20 2020  n(odr)*0.05).   
-00009ae0: 2075 6320 3d20 696e 7428 6c65 6e28 6f64   uc = int(len(od
-00009af0: 7229 2a30 2e39 3529 0a20 2020 206d 696e  r)*0.95).    min
-00009b00: 5f78 736d 203d 2078 736d 5b6f 6472 5b6c  _xsm = xsm[odr[l
-00009b10: 635d 5d0a 2020 2020 6d61 785f 7873 6d20  c]].    max_xsm 
-00009b20: 3d20 7873 6d5b 6f64 725b 7563 5d5d 0a20  = xsm[odr[uc]]. 
-00009b30: 2020 2062 203d 2028 6d61 203e 2030 2920     b = (ma > 0) 
-00009b40: 2620 2878 736d 203e 206d 696e 5f78 736d  & (xsm > min_xsm
-00009b50: 2920 2620 2878 736d 203c 206d 6178 5f78  ) & (xsm < max_x
-00009b60: 736d 290a 2020 2020 0a20 2020 206d 203d  sm).    .    m =
-00009b70: 206d 615b 625d 0a20 2020 2073 203d 2073   ma[b].    s = s
-00009b80: 615b 625d 0a20 2020 2058 7320 3d20 5861  a[b].    Xs = Xa
-00009b90: 2e6c 6f63 5b3a 2c62 5d0a 2020 2020 2020  .loc[:,b].      
-00009ba0: 2020 0a20 2020 2023 2320 4669 740a 2020    .    ## Fit.  
-00009bb0: 2020 6d5f 7365 6c20 3d20 6d20 2320 5873    m_sel = m # Xs
-00009bc0: 5f73 656c 2e6d 6561 6e28 6178 6973 203d  _sel.mean(axis =
-00009bd0: 2030 290a 2020 2020 735f 7365 6c20 3d20   0).    s_sel = 
-00009be0: 7320 2320 5873 5f73 656c 2e73 7464 2861  s # Xs_sel.std(a
-00009bf0: 7869 7320 3d20 3029 0a0a 2020 2020 6c6d  xis = 0)..    lm
-00009c00: 5f73 656c 203d 206e 702e 6c6f 6731 3028  _sel = np.log10(
-00009c10: 6d5f 7365 6c20 2b20 3165 2d31 3029 0a20  m_sel + 1e-10). 
-00009c20: 2020 206c 735f 7365 6c20 3d20 6e70 2e6c     ls_sel = np.l
-00009c30: 6f67 3130 2873 5f73 656c 202b 2031 652d  og10(s_sel + 1e-
-00009c40: 3130 290a 2020 2020 0a20 2020 207a 203d  10).    .    z =
-00009c50: 206e 702e 706f 6c79 6669 7428 6c6d 5f73   np.polyfit(lm_s
-00009c60: 656c 2c20 6c73 5f73 656c 2c20 3229 0a20  el, ls_sel, 2). 
-00009c70: 2020 2070 203d 206e 702e 706f 6c79 3164     p = np.poly1d
-00009c80: 287a 290a 2020 2020 0a20 2020 2023 2320  (z).    .    ## 
-00009c90: 5365 6c65 6374 2067 656e 6573 0a20 2020  Select genes.   
-00009ca0: 206d 203d 206d 6120 2320 5873 2e6d 6561   m = ma # Xs.mea
-00009cb0: 6e28 6178 6973 203d 2030 290a 2020 2020  n(axis = 0).    
-00009cc0: 2320 7320 3d20 5873 2e73 7464 2861 7869  # s = Xs.std(axi
-00009cd0: 7320 3d20 3029 0a0a 2020 2020 6c6d 203d  s = 0)..    lm =
-00009ce0: 206e 702e 6c6f 6731 3028 6d20 2b20 3165   np.log10(m + 1e
-00009cf0: 2d31 3029 0a20 2020 2023 206c 7320 3d20  -10).    # ls = 
-00009d00: 6e70 2e6c 6f67 3130 2873 202b 2031 652d  np.log10(s + 1e-
-00009d10: 3130 290a 2020 2020 0a20 2020 2073 5f66  10).    .    s_f
-00009d20: 6974 203d 2031 302a 2a28 7028 6c6d 2929  it = 10**(p(lm))
-00009d30: 0a0a 2020 2020 5874 203d 2058 612e 7375  ..    Xt = Xa.su
-00009d40: 6228 6d2c 2061 7869 7320 3d20 3129 2e6d  b(m, axis = 1).m
-00009d50: 756c 2831 2f28 735f 6669 7420 2b20 3165  ul(1/(s_fit + 1e
-00009d60: 2d31 3029 2c20 6178 6973 203d 2031 290a  -10), axis = 1).
-00009d70: 2020 2020 7563 203d 206e 702e 7371 7274      uc = np.sqrt
-00009d80: 2858 742e 7368 6170 655b 305d 290a 2020  (Xt.shape[0]).  
-00009d90: 2020 5874 2e63 6c69 7028 7570 7065 7220    Xt.clip(upper 
-00009da0: 3d20 7563 2c20 6c6f 7765 7220 3d20 2d75  = uc, lower = -u
-00009db0: 632c 2069 6e70 6c61 6365 203d 2054 7275  c, inplace = Tru
-00009dc0: 6529 0a0a 2020 2020 7372 203d 2058 742e  e)..    sr = Xt.
-00009dd0: 7661 7228 6178 6973 203d 2030 290a 2020  var(axis = 0).  
-00009de0: 2020 0a20 2020 206d 696e 5f6c 6d20 3d20    .    min_lm = 
-00009df0: 6c6d 2e6d 696e 2829 0a20 2020 206d 6178  lm.min().    max
-00009e00: 5f6c 6d20 3d20 6c6d 2e6d 6178 2829 0a20  _lm = lm.max(). 
-00009e10: 2020 204e 7320 3d20 3430 0a20 2020 2064     Ns = 40.    d
-00009e20: 7820 3d20 286d 6178 5f6c 6d20 2d20 6d69  x = (max_lm - mi
-00009e30: 6e5f 6c6d 292f 4e73 0a20 2020 200a 2020  n_lm)/Ns.    .  
-00009e40: 2020 726e 6720 3d20 6e70 2e61 7261 6e67    rng = np.arang
-00009e50: 6528 6d69 6e5f 6c6d 2c20 6d61 785f 6c6d  e(min_lm, max_lm
-00009e60: 2b28 4e73 2f32 292c 2064 7829 0a20 2020  +(Ns/2), dx).   
-00009e70: 2066 6f72 206e 2069 6e20 7261 6e67 6528   for n in range(
-00009e80: 4e73 293a 0a20 2020 2020 2020 206c 6320  Ns):.        lc 
-00009e90: 3d20 726e 675b 6e5d 0a20 2020 2020 2020  = rng[n].       
-00009ea0: 2075 6320 3d20 726e 675b 6e2b 315d 0a20   uc = rng[n+1]. 
-00009eb0: 2020 2020 2020 2062 7820 3d20 286c 6d20         bx = (lm 
-00009ec0: 3e3d 206c 6329 2026 2028 6c6d 203c 2075  >= lc) & (lm < u
-00009ed0: 6329 0a20 2020 2020 2020 206d 7372 203d  c).        msr =
-00009ee0: 206e 702e 6d65 616e 2873 725b 6278 5d29   np.mean(sr[bx])
-00009ef0: 0a20 2020 2020 2020 2073 725b 6278 5d20  .        sr[bx] 
-00009f00: 3d20 7372 5b62 785d 202d 206d 7372 0a20  = sr[bx] - msr. 
-00009f10: 2020 200a 2020 2020 6f64 7220 3d20 6e70     .    odr = np
-00009f20: 2e61 7272 6179 2873 7229 2e61 7267 736f  .array(sr).argso
-00009f30: 7274 2829 0a20 2020 2073 5f74 6820 3d20  rt().    s_th = 
-00009f40: 7372 5b6f 6472 5b2d 4e5f 6765 6e65 735d  sr[odr[-N_genes]
-00009f50: 5d0a 2020 2020 6278 203d 2073 7220 3e3d  ].    bx = sr >=
-00009f60: 2073 5f74 680a 2020 2020 6765 6e65 7320   s_th.    genes 
-00009f70: 3d20 6c69 7374 2858 742e 636f 6c75 6d6e  = list(Xt.column
-00009f80: 732e 7661 6c75 6573 5b62 785d 290a 2020  s.values[bx]).  
-00009f90: 2020 0a20 2020 2072 6574 7572 6e20 6765    .    return ge
-00009fa0: 6e65 730a 0a0a 6465 6620 585f 7072 6570  nes...def X_prep
-00009fb0: 726f 6365 7373 696e 6728 2058 732c 206c  rocessing( Xs, l
-00009fc0: 6f67 5f74 7261 6e73 666f 726d 6564 2c20  og_transformed, 
-00009fd0: 4e5f 6765 6e65 7320 3d20 3230 3030 2029  N_genes = 2000 )
-00009fe0: 3a0a 2020 2020 0a20 2020 2069 6620 6e6f  :.    .    if no
-00009ff0: 7420 6c6f 675f 7472 616e 7366 6f72 6d65  t log_transforme
-0000a000: 643a 0a20 2020 2020 2020 2058 7820 3d20  d:.        Xx = 
-0000a010: 6e70 2e6c 6f67 3228 3120 2b20 585f 6e6f  np.log2(1 + X_no
-0000a020: 726d 616c 697a 6528 5873 2929 0a20 2020  rmalize(Xs)).   
-0000a030: 2065 6c73 653a 0a20 2020 2020 2020 2058   else:.        X
-0000a040: 7820 3d20 5873 0a20 2020 2020 2020 200a  x = Xs.        .
-0000a050: 2020 2020 6966 2058 732e 7368 6170 655b      if Xs.shape[
-0000a060: 315d 203c 3d20 4e5f 6765 6e65 733a 0a20  1] <= N_genes:. 
-0000a070: 2020 2020 2020 2058 7820 3d20 585f 7363         Xx = X_sc
-0000a080: 616c 6528 5878 2c20 6d61 785f 7661 6c20  ale(Xx, max_val 
-0000a090: 3d20 3130 290a 2020 2020 656c 7365 3a0a  = 10).    else:.
-0000a0a0: 2020 2020 2020 2020 6765 6e65 5f73 656c          gene_sel
-0000a0b0: 203d 2073 656c 6563 745f 7661 7269 6162   = select_variab
-0000a0c0: 6c65 5f67 656e 6573 2858 782c 204e 5f67  le_genes(Xx, N_g
-0000a0d0: 656e 6573 203d 204e 5f67 656e 6573 2029  enes = N_genes )
-0000a0e0: 0a20 2020 2020 2020 2058 7820 3d20 585f  .        Xx = X_
-0000a0f0: 7363 616c 6528 5878 2e6c 6f63 5b3a 2c67  scale(Xx.loc[:,g
-0000a100: 656e 655f 7365 6c5d 2c20 6d61 785f 7661  ene_sel], max_va
-0000a110: 6c20 3d20 3130 290a 2020 2020 7265 7475  l = 10).    retu
-0000a120: 726e 2058 780a 0a0a 6465 6620 636c 7573  rn Xx...def clus
-0000a130: 7465 7269 6e67 5f61 6c67 2858 5f70 6361  tering_alg(X_pca
-0000a140: 2c20 636c 7573 745f 616c 676f 203d 2027  , clust_algo = '
-0000a150: 6c76 272c 204e 5f63 6c75 7374 6572 7320  lv', N_clusters 
-0000a160: 3d20 3235 2c20 7265 736f 6c75 7469 6f6e  = 25, resolution
-0000a170: 203d 2031 2c20 4e5f 6e65 6967 6862 6f72   = 1, N_neighbor
-0000a180: 7320 3d20 3130 293a 0a20 2020 200a 2020  s = 10):.    .  
-0000a190: 2020 6966 2063 6c75 7374 5f61 6c67 6f5b    if clust_algo[
-0000a1a0: 3a32 5d20 3d3d 2027 676d 273a 0a20 2020  :2] == 'gm':.   
-0000a1b0: 2020 2020 2067 6d6d 203d 206d 6978 7475       gmm = mixtu
-0000a1c0: 7265 2e47 6175 7373 6961 6e4d 6978 7475  re.GaussianMixtu
-0000a1d0: 7265 286e 5f63 6f6d 706f 6e65 6e74 7320  re(n_components 
-0000a1e0: 3d20 696e 7428 4e5f 636c 7573 7465 7273  = int(N_clusters
-0000a1f0: 292c 2072 616e 646f 6d5f 7374 6174 6520  ), random_state 
-0000a200: 3d20 3029 0a20 2020 2020 2020 2063 6c75  = 0).        clu
-0000a210: 7374 6572 5f6c 6162 656c 203d 2067 6d6d  ster_label = gmm
-0000a220: 2e66 6974 5f70 7265 6469 6374 286e 702e  .fit_predict(np.
-0000a230: 6172 7261 7928 585f 7063 6129 290a 2020  array(X_pca)).  
-0000a240: 2020 2020 2020 7265 7475 726e 2063 6c75        return clu
-0000a250: 7374 6572 5f6c 6162 656c 2c20 676d 6d0a  ster_label, gmm.
-0000a260: 2020 2020 656c 6966 2063 6c75 7374 5f61      elif clust_a
-0000a270: 6c67 6f5b 3a32 5d20 3d3d 2027 6b6d 273a  lgo[:2] == 'km':
-0000a280: 0a20 2020 2020 2020 206b 6d20 3d20 636c  .        km = cl
-0000a290: 7573 7465 722e 4b4d 6561 6e73 286e 5f63  uster.KMeans(n_c
-0000a2a0: 6c75 7374 6572 7320 3d20 696e 7428 4e5f  lusters = int(N_
-0000a2b0: 636c 7573 7465 7273 292c 2072 616e 646f  clusters), rando
-0000a2c0: 6d5f 7374 6174 6520 3d20 3029 0a20 2020  m_state = 0).   
-0000a2d0: 2020 2020 206b 6d2e 6669 7428 585f 7063       km.fit(X_pc
-0000a2e0: 6129 0a20 2020 2020 2020 2063 6c75 7374  a).        clust
-0000a2f0: 6572 5f6c 6162 656c 203d 206b 6d2e 6c61  er_label = km.la
-0000a300: 6265 6c73 5f0a 2020 2020 2020 2020 7265  bels_.        re
-0000a310: 7475 726e 2063 6c75 7374 6572 5f6c 6162  turn cluster_lab
-0000a320: 656c 2c20 6b6d 0a20 2020 2065 6c73 653a  el, km.    else:
-0000a330: 0a20 2020 2020 2020 2061 646a 203d 206b  .        adj = k
-0000a340: 6e65 6967 6862 6f72 735f 6772 6170 6828  neighbors_graph(
-0000a350: 585f 7063 612c 2069 6e74 284e 5f6e 6569  X_pca, int(N_nei
-0000a360: 6768 626f 7273 292c 206d 6f64 653d 2763  ghbors), mode='c
-0000a370: 6f6e 6e65 6374 6976 6974 7927 2c20 696e  onnectivity', in
-0000a380: 636c 7564 655f 7365 6c66 3d54 7275 6529  clude_self=True)
-0000a390: 0a20 2020 2020 2020 206c 6f75 7661 696e  .        louvain
-0000a3a0: 203d 204c 6f75 7661 696e 2872 6573 6f6c   = Louvain(resol
-0000a3b0: 7574 696f 6e20 3d20 7265 736f 6c75 7469  ution = resoluti
-0000a3c0: 6f6e 290a 2020 2020 2020 2020 6966 2068  on).        if h
-0000a3d0: 6173 6174 7472 286c 6f75 7661 696e 2c20  asattr(louvain, 
-0000a3e0: 2766 6974 5f70 7265 6469 6374 2729 3a0a  'fit_predict'):.
-0000a3f0: 2020 2020 2020 2020 2020 2020 636c 7573              clus
-0000a400: 7465 725f 6c61 6265 6c20 3d20 6c6f 7576  ter_label = louv
-0000a410: 6169 6e2e 6669 745f 7072 6564 6963 7428  ain.fit_predict(
-0000a420: 6164 6a29 2020 2020 2020 2020 0a20 2020  adj)        .   
-0000a430: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000a440: 2020 2020 2020 2063 6c75 7374 6572 5f6c         cluster_l
-0000a450: 6162 656c 203d 206c 6f75 7661 696e 2e66  abel = louvain.f
-0000a460: 6974 5f74 7261 6e73 666f 726d 2861 646a  it_transform(adj
-0000a470: 2920 2020 2020 2020 200a 2020 2020 2020  )        .      
-0000a480: 2020 7265 7475 726e 2063 6c75 7374 6572    return cluster
-0000a490: 5f6c 6162 656c 2c20 6c6f 7576 6169 6e0a  _label, louvain.
-0000a4a0: 2020 2020 2727 270a 2020 2020 656c 6966      '''.    elif
-0000a4b0: 2063 6c75 7374 5f61 6c67 6f5b 3a32 5d20   clust_algo[:2] 
-0000a4c0: 3d3d 2027 6c64 273a 0a20 2020 2020 2020  == 'ld':.       
-0000a4d0: 206c 6569 6465 6e20 3d20 4c65 6964 656e   leiden = Leiden
-0000a4e0: 436c 7573 7465 7269 6e67 2829 0a20 2020  Clustering().   
-0000a4f0: 2020 2020 206c 6569 6465 6e2e 6669 7428       leiden.fit(
-0000a500: 5829 0a20 2020 2020 2020 2063 6c75 7374  X).        clust
-0000a510: 6572 5f6c 6162 656c 203d 206c 6569 6465  er_label = leide
-0000a520: 6e2e 6c61 6265 6c73 5f0a 2020 2020 2020  n.labels_.      
-0000a530: 2020 7265 7475 726e 2063 6c75 7374 6572    return cluster
-0000a540: 5f6c 6162 656c 2c20 6b6d 0a20 2020 2027  _label, km.    '
-0000a550: 2727 0a0a 0a64 6566 2047 5341 5f63 656c  ''...def GSA_cel
-0000a560: 6c5f 7375 6274 7970 696e 6728 2058 5f63  l_subtyping( X_c
-0000a570: 656c 6c5f 6279 5f67 656e 652c 206d 6b72  ell_by_gene, mkr
-0000a580: 735f 706f 732c 206d 6b72 735f 6e65 672c  s_pos, mkrs_neg,
-0000a590: 2076 6572 626f 7365 203d 2046 616c 7365   verbose = False
-0000a5a0: 2029 3a0a 2020 2020 0a20 2020 2058 203d   ):.    .    X =
-0000a5b0: 2058 5f63 656c 6c5f 6279 5f67 656e 6520   X_cell_by_gene 
-0000a5c0: 2020 200a 2020 2020 6765 6e65 7320 3d20     .    genes = 
-0000a5d0: 6c69 7374 2858 2e63 6f6c 756d 6e73 2e76  list(X.columns.v
-0000a5e0: 616c 7565 7329 0a0a 2020 2020 6d6b 725f  alues)..    mkr_
-0000a5f0: 6c73 745f 6469 6374 203d 2063 6f70 792e  lst_dict = copy.
-0000a600: 6465 6570 636f 7079 286d 6b72 735f 706f  deepcopy(mkrs_po
-0000a610: 7329 0a20 2020 206d 6b72 5f6c 7374 5f64  s).    mkr_lst_d
-0000a620: 6963 745f 6e65 6720 3d20 636f 7079 2e64  ict_neg = copy.d
-0000a630: 6565 7063 6f70 7928 6d6b 7273 5f6e 6567  eepcopy(mkrs_neg
-0000a640: 290a 2020 2020 666f 7220 6b65 7920 696e  ).    for key in
-0000a650: 206c 6973 7428 6d6b 725f 6c73 745f 6469   list(mkr_lst_di
-0000a660: 6374 2e6b 6579 7328 2929 3a0a 2020 2020  ct.keys()):.    
-0000a670: 2020 2020 6d6b 7273 203d 206d 6b72 5f6c      mkrs = mkr_l
-0000a680: 7374 5f64 6963 745b 6b65 795d 0a20 2020  st_dict[key].   
-0000a690: 2020 2020 206d 6b72 7332 203d 206c 6973       mkrs2 = lis
-0000a6a0: 7428 7365 7428 6d6b 7273 292e 696e 7465  t(set(mkrs).inte
-0000a6b0: 7273 6563 7469 6f6e 2867 656e 6573 2929  rsection(genes))
-0000a6c0: 2020 2020 0a20 2020 2020 2020 2069 6620      .        if 
-0000a6d0: 6c65 6e28 6d6b 7273 3229 203c 206c 656e  len(mkrs2) < len
-0000a6e0: 286d 6b72 7329 3a0a 2020 2020 2020 2020  (mkrs):.        
-0000a6f0: 2020 2020 6d6b 725f 6c73 745f 6469 6374      mkr_lst_dict
-0000a700: 5b6b 6579 5d20 3d20 6d6b 7273 320a 2020  [key] = mkrs2.  
-0000a710: 2020 2020 2020 2020 2020 7320 3d20 2727            s = ''
-0000a720: 0a20 2020 2020 2020 2020 2020 2063 6e74  .            cnt
-0000a730: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
-0000a740: 2066 6f72 206d 6b72 2069 6e20 6d6b 7273   for mkr in mkrs
-0000a750: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000a760: 2020 6966 206d 6b72 206e 6f74 2069 6e20    if mkr not in 
-0000a770: 6d6b 7273 323a 0a20 2020 2020 2020 2020  mkrs2:.         
-0000a780: 2020 2020 2020 2020 2020 2073 203d 2073             s = s
-0000a790: 202b 2027 2573 2c27 2025 206d 6b72 0a20   + '%s,' % mkr. 
-0000a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a7b0: 2020 2063 6e74 202b 3d20 310a 2020 2020     cnt += 1.    
-0000a7c0: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
-0000a7d0: 2920 3e20 313a 0a20 2020 2020 2020 2020  ) > 1:.         
-0000a7e0: 2020 2020 2020 2073 203d 2073 5b3a 2d31         s = s[:-1
-0000a7f0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0000a800: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-0000a810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a820: 2020 7072 696e 7428 2720 2020 5741 524e    print('   WARN
-0000a830: 494e 473a 2025 3135 7320 706f 735f 6d6b  ING: %15s pos_mk
-0000a840: 7273 2069 6e20 6462 3a20 2533 692c 2077  rs in db: %3i, w
-0000a850: 6865 7265 2025 3269 206d 6973 7369 6e67  here %2i missing
-0000a860: 2028 2573 2927 2025 2028 6b65 792c 206c   (%s)' % (key, l
-0000a870: 656e 286d 6b72 7329 2c20 636e 742c 2073  en(mkrs), cnt, s
-0000a880: 2929 0a20 2020 2020 2020 2020 2020 2027  )).            '
-0000a890: 2727 0a20 2020 2020 2020 2020 2020 2065  ''.            e
-0000a8a0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000a8b0: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-0000a8c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a8d0: 2020 2020 2070 7269 6e74 2827 2531 3573       print('%15s
-0000a8e0: 2070 6f73 5f6d 6b72 7320 696e 2064 6220   pos_mkrs in db 
-0000a8f0: 3d20 2532 6927 2025 2028 6b65 792c 206c  = %2i' % (key, l
-0000a900: 656e 286d 6b72 7329 2929 0a20 2020 2020  en(mkrs))).     
-0000a910: 2020 2020 2020 2023 2727 270a 2020 2020         #'''.    
-0000a920: 2020 2020 6966 206b 6579 2069 6e20 6d6b      if key in mk
-0000a930: 725f 6c73 745f 6469 6374 5f6e 6567 2e6b  r_lst_dict_neg.k
-0000a940: 6579 7328 293a 0a20 2020 2020 2020 2020  eys():.         
-0000a950: 2020 206d 6b72 7333 203d 206d 6b72 5f6c     mkrs3 = mkr_l
-0000a960: 7374 5f64 6963 745f 6e65 675b 6b65 795d  st_dict_neg[key]
-0000a970: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000a980: 6c65 6e28 6d6b 7273 3329 203e 2030 3a0a  len(mkrs3) > 0:.
-0000a990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a9a0: 6d6b 7273 3420 3d20 6c69 7374 2873 6574  mkrs4 = list(set
-0000a9b0: 286d 6b72 7333 292e 696e 7465 7273 6563  (mkrs3).intersec
-0000a9c0: 7469 6f6e 2867 656e 6573 2929 2020 2020  tion(genes))    
-0000a9d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a9e0: 2069 6620 6c65 6e28 6d6b 7273 3429 203c   if len(mkrs4) <
-0000a9f0: 206c 656e 286d 6b72 7333 293a 0a20 2020   len(mkrs3):.   
-0000aa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aa10: 206d 6b72 5f6c 7374 5f64 6963 745f 6e65   mkr_lst_dict_ne
-0000aa20: 675b 6b65 795d 203d 206d 6b72 7332 0a20  g[key] = mkrs2. 
-0000aa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aa40: 2020 2073 203d 2027 270a 2020 2020 2020     s = ''.      
-0000aa50: 2020 2020 2020 2020 2020 2020 2020 636e                cn
-0000aa60: 7420 3d20 300a 2020 2020 2020 2020 2020  t = 0.          
-0000aa70: 2020 2020 2020 2020 2020 666f 7220 6d6b            for mk
-0000aa80: 7220 696e 206d 6b72 7333 3a0a 2020 2020  r in mkrs3:.    
-0000aa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aaa0: 2020 2020 6966 206d 6b72 206e 6f74 2069      if mkr not i
-0000aab0: 6e20 6d6b 7273 343a 0a20 2020 2020 2020  n mkrs4:.       
-0000aac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aad0: 2020 2020 2073 203d 2073 202b 2027 2573       s = s + '%s
-0000aae0: 2c27 2025 206d 6b72 0a20 2020 2020 2020  ,' % mkr.       
-0000aaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab00: 2020 2020 2063 6e74 202b 3d20 310a 2020       cnt += 1.  
-0000ab10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab20: 2020 6966 206c 656e 2873 2920 3e20 313a    if len(s) > 1:
-0000ab30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ab40: 2020 2020 2020 2020 2073 203d 2073 5b3a           s = s[:
-0000ab50: 2d31 5d0a 2020 2020 2020 2020 2020 2020  -1].            
-0000ab60: 2020 2020 2020 2020 2020 2020 6966 2076              if v
-0000ab70: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-0000ab80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab90: 2020 2020 7072 696e 7428 2720 2020 5741      print('   WA
-0000aba0: 524e 494e 473a 2025 3135 7320 6e65 675f  RNING: %15s neg_
-0000abb0: 6d6b 7273 2069 6e20 6462 3a20 2533 692c  mkrs in db: %3i,
-0000abc0: 2077 6865 7265 2025 3269 206d 6973 7369   where %2i missi
-0000abd0: 6e67 2028 2573 2927 2025 2028 6b65 792c  ng (%s)' % (key,
-0000abe0: 206c 656e 286d 6b72 7329 2c20 636e 742c   len(mkrs), cnt,
-0000abf0: 2073 2929 0a0a 2020 2020 2020 2020 2020   s))..          
-0000ac00: 2020 0a20 2020 2069 6620 7665 7262 6f73    .    if verbos
-0000ac10: 653a 2070 7269 6e74 2827 4753 4120 2e2e  e: print('GSA ..
-0000ac20: 2027 2c20 656e 6420 3d20 2727 290a 2020   ', end = '').  
-0000ac30: 2020 7374 6172 745f 7469 6d65 203d 2074    start_time = t
-0000ac40: 696d 652e 7469 6d65 2829 0a20 2020 200a  ime.time().    .
-0000ac50: 2020 2020 2323 2047 6574 2073 7461 7473      ## Get stats
-0000ac60: 2066 6f72 2043 4434 2b20 5420 6365 6c6c   for CD4+ T cell
-0000ac70: 7320 6f6e 6c79 0a0a 2020 2020 5862 203d  s only..    Xb =
-0000ac80: 2058 203e 2030 0a20 2020 204e 203d 2058   X > 0.    N = X
-0000ac90: 622e 7368 6170 655b 315d 0a20 2020 206b  b.shape[1].    k
-0000aca0: 203d 2058 622e 7375 6d28 6178 6973 203d   = Xb.sum(axis =
-0000acb0: 2031 290a 0a20 2020 206d 6b72 5f73 7461   1)..    mkr_sta
-0000acc0: 7420 3d20 7b7d 0a20 2020 2064 6620 3d20  t = {}.    df = 
-0000acd0: 7064 2e44 6174 6146 7261 6d65 2869 6e64  pd.DataFrame(ind
-0000ace0: 6578 203d 2058 622e 696e 6465 782e 7661  ex = Xb.index.va
-0000acf0: 6c75 6573 290a 2020 2020 6466 6e20 3d20  lues).    dfn = 
-0000ad00: 7064 2e44 6174 6146 7261 6d65 2869 6e64  pd.DataFrame(ind
-0000ad10: 6578 203d 2058 622e 696e 6465 782e 7661  ex = Xb.index.va
-0000ad20: 6c75 6573 290a 0a20 2020 206e 5f6d 6b72  lues)..    n_mkr
-0000ad30: 203d 207b 7d0a 2020 2020 666f 7220 6b65   = {}.    for ke
-0000ad40: 7920 696e 206c 6973 7428 6d6b 725f 6c73  y in list(mkr_ls
-0000ad50: 745f 6469 6374 2e6b 6579 7328 2929 3a0a  t_dict.keys()):.
-0000ad60: 2020 2020 2020 2020 6e5f 6d6b 725b 6b65          n_mkr[ke
-0000ad70: 795d 203d 206c 656e 286d 6b72 5f6c 7374  y] = len(mkr_lst
-0000ad80: 5f64 6963 745b 6b65 795d 290a 2020 2020  _dict[key]).    
-0000ad90: 2020 2020 6966 206b 6579 2069 6e20 6d6b      if key in mk
-0000ada0: 725f 6c73 745f 6469 6374 5f6e 6567 2e6b  r_lst_dict_neg.k
-0000adb0: 6579 7328 293a 0a20 2020 2020 2020 2020  eys():.         
-0000adc0: 2020 206e 5f6d 6b72 5b6b 6579 5d20 3d20     n_mkr[key] = 
-0000add0: 6e5f 6d6b 725b 6b65 795d 202b 206c 656e  n_mkr[key] + len
-0000ade0: 286d 6b72 5f6c 7374 5f64 6963 745f 6e65  (mkr_lst_dict_ne
-0000adf0: 675b 6b65 795d 290a 2020 2020 2020 2020  g[key]).        
-0000ae00: 2020 2020 0a20 2020 2066 6f72 206b 6579      .    for key
-0000ae10: 2069 6e20 6c69 7374 286d 6b72 5f6c 7374   in list(mkr_lst
-0000ae20: 5f64 6963 742e 6b65 7973 2829 293a 0a20  _dict.keys()):. 
-0000ae30: 2020 2020 2020 206d 6b72 7320 3d20 6d6b         mkrs = mk
-0000ae40: 725f 6c73 745f 6469 6374 5b6b 6579 5d0a  r_lst_dict[key].
-0000ae50: 2020 2020 2020 2020 6220 3d20 5862 5b6d          b = Xb[m
-0000ae60: 6b72 735d 0a20 2020 2020 2020 206e 203d  krs].        n =
-0000ae70: 2062 2e73 756d 2861 7869 7320 3d20 3129   b.sum(axis = 1)
-0000ae80: 0a20 2020 2020 2020 204d 203d 206c 656e  .        M = len
-0000ae90: 286d 6b72 7329 0a20 2020 2020 2020 200a  (mkrs).        .
-0000aea0: 2020 2020 2020 2020 6966 206b 6579 2069          if key i
-0000aeb0: 6e20 6d6b 725f 6c73 745f 6469 6374 5f6e  n mkr_lst_dict_n
-0000aec0: 6567 2e6b 6579 7328 293a 0a20 2020 2020  eg.keys():.     
-0000aed0: 2020 2020 2020 206d 6b72 735f 6e65 6720         mkrs_neg 
-0000aee0: 3d20 6d6b 725f 6c73 745f 6469 6374 5f6e  = mkr_lst_dict_n
-0000aef0: 6567 5b6b 6579 5d0a 2020 2020 2020 2020  eg[key].        
-0000af00: 2020 2020 625f 6e65 6720 3d20 7e58 625b      b_neg = ~Xb[
-0000af10: 6d6b 7273 5f6e 6567 5d0a 2020 2020 2020  mkrs_neg].      
-0000af20: 2020 2020 2020 6e20 3d20 6e20 2b20 625f        n = n + b_
-0000af30: 6e65 672e 7375 6d28 6178 6973 203d 2031  neg.sum(axis = 1
-0000af40: 290a 2020 2020 2020 2020 2020 2020 4d20  ).            M 
-0000af50: 3d20 4d20 2b20 6c65 6e28 6d6b 7273 5f6e  = M + len(mkrs_n
-0000af60: 6567 290a 0a20 2020 2020 2020 206e 6567  eg)..        neg
-0000af70: 5f6c 6f67 5f70 7661 6c20 3d20 2d68 7970  _log_pval = -hyp
-0000af80: 6572 6765 6f6d 2e6c 6f67 7366 286e 2d31  ergeom.logsf(n-1
-0000af90: 2c20 4e2c 204d 2c20 6b29 2a6e 702e 6c6f  , N, M, k)*np.lo
-0000afa0: 6731 3028 6e70 2e65 7870 2831 2929 0a20  g10(np.exp(1)). 
-0000afb0: 2020 2020 2020 2064 665b 6b65 795d 203d         df[key] =
-0000afc0: 206e 6567 5f6c 6f67 5f70 7661 6c0a 2020   neg_log_pval.  
-0000afd0: 2020 2020 2020 6466 6e5b 6b65 795d 203d        dfn[key] =
-0000afe0: 206e 0a0a 2020 2020 2323 2047 6574 2066   n..    ## Get f
-0000aff0: 696e 616c 2072 6573 756c 7473 0a20 2020  inal results.   
-0000b000: 206e 756d 203d 206c 6973 7428 6e70 2e61   num = list(np.a
-0000b010: 7261 6e67 6528 6466 2e73 6861 7065 5b31  range(df.shape[1
-0000b020: 5d29 290a 2020 2020 6e61 6d65 203d 206c  ])).    name = l
-0000b030: 6973 7428 6466 2e63 6f6c 756d 6e73 2e76  ist(df.columns.v
-0000b040: 616c 7565 7329 0a20 2020 2074 7261 6e73  alues).    trans
-0000b050: 5f64 6963 7420 3d20 6469 6374 287a 6970  _dict = dict(zip
-0000b060: 286e 756d 2c6e 616d 6529 290a 2020 2020  (num,name)).    
-0000b070: 0a20 2020 2069 6620 6c65 6e28 6d6b 725f  .    if len(mkr_
-0000b080: 6c73 745f 6469 6374 2e6b 6579 7328 2929  lst_dict.keys())
-0000b090: 203d 3d20 313a 0a20 2020 2020 2020 2063   == 1:.        c
-0000b0a0: 203d 206e 616d 655b 305d 0a20 2020 2020   = name[0].     
-0000b0b0: 2020 206e 6567 5f6c 6f67 5f70 7661 6c20     neg_log_pval 
-0000b0c0: 3d20 6466 5b63 5d0a 2020 2020 2020 2020  = df[c].        
-0000b0d0: 7375 6274 7970 6520 3d20 5b63 5d2a 6466  subtype = [c]*df
-0000b0e0: 2e73 6861 7065 5b30 5d0a 2020 2020 2020  .shape[0].      
-0000b0f0: 2020 0a20 2020 2020 2020 2023 2064 665f    .        # df_
-0000b100: 7265 7320 3d20 7064 2e44 6174 6146 7261  res = pd.DataFra
-0000b110: 6d65 287b 2743 4434 2b20 5420 6365 6c6c  me({'CD4+ T cell
-0000b120: 2073 7562 7479 7065 273a 2074 635f 7375   subtype': tc_su
-0000b130: 6274 7970 652c 2027 4e65 674c 6f67 5076  btype, 'NegLogPv
-0000b140: 616c 273a 206e 6567 5f6c 6f67 5f70 7661  al': neg_log_pva
-0000b150: 6c7d 2c20 696e 6465 7820 3d20 6466 2e69  l}, index = df.i
-0000b160: 6e64 6578 2e76 616c 7565 7329 0a20 2020  ndex.values).   
-0000b170: 2020 2020 2064 665f 7265 7320 3d20 7064       df_res = pd
-0000b180: 2e44 6174 6146 7261 6d65 287b 2763 656c  .DataFrame({'cel
-0000b190: 6c5f 7479 7065 273a 2073 7562 7479 7065  l_type': subtype
-0000b1a0: 2c20 2763 656c 6c5f 7479 7065 2872 6576  , 'cell_type(rev
-0000b1b0: 2927 3a20 7375 6274 7970 652c 200a 2020  )': subtype, .  
-0000b1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1d0: 2020 2020 2020 2020 2020 2020 2027 6365               'ce
-0000b1e0: 6c6c 5f74 7970 6528 3173 7429 273a 2073  ll_type(1st)': s
-0000b1f0: 7562 7479 7065 2c20 274f 7665 726c 6170  ubtype, 'Overlap
-0000b200: 273a 2064 666e 5b63 5d7d 2c0a 2020 2020  ': dfn[c]},.    
-0000b210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b220: 2020 2020 2020 2020 2020 2023 2064 7479             # dty
-0000b230: 7065 3d7b 2763 656c 6c5f 7479 7065 273a  pe={'cell_type':
-0000b240: 2073 7472 2c20 2763 656c 6c5f 7479 7065   str, 'cell_type
-0000b250: 2872 6576 2927 3a20 7374 722c 2027 6365  (rev)': str, 'ce
-0000b260: 6c6c 5f74 7970 6528 3173 7429 273a 2073  ll_type(1st)': s
-0000b270: 7472 2c20 274f 7665 726c 6170 273a 2069  tr, 'Overlap': i
-0000b280: 6e74 7d2c 0a20 2020 2020 2020 2020 2020  nt},.           
-0000b290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b2a0: 2020 2020 696e 6465 7820 3d20 6466 2e69      index = df.i
-0000b2b0: 6e64 6578 2e76 616c 7565 7329 0a20 2020  ndex.values).   
-0000b2c0: 2020 2020 2064 665f 7265 735b 2763 656c       df_res['cel
-0000b2d0: 6c5f 7479 7065 2832 6e64 2927 5d20 3d20  l_type(2nd)'] = 
-0000b2e0: 4e6f 6e65 0a20 2020 2020 2020 2064 665f  None.        df_
-0000b2f0: 7265 735b 2763 656c 6c5f 7479 7065 2832  res['cell_type(2
-0000b300: 6e64 2927 5d20 3d20 6466 5f72 6573 5b27  nd)'] = df_res['
-0000b310: 6365 6c6c 5f74 7970 6528 326e 6429 275d  cell_type(2nd)']
-0000b320: 2e61 7374 7970 6528 7374 7229 0a20 2020  .astype(str).   
-0000b330: 2020 2020 2064 665f 7265 735b 274f 7665       df_res['Ove
-0000b340: 726c 6170 2832 6e64 2927 5d20 3d20 4e6f  rlap(2nd)'] = No
-0000b350: 6e65 0a20 2020 2020 2020 2064 665f 7265  ne.        df_re
-0000b360: 735b 274f 7665 726c 6170 2832 6e64 2927  s['Overlap(2nd)'
-0000b370: 5d20 3d20 6466 5f72 6573 5b27 4f76 6572  ] = df_res['Over
-0000b380: 6c61 7028 326e 6429 275d 2e61 7374 7970  lap(2nd)'].astyp
-0000b390: 6528 7374 7229 0a20 2020 2020 2020 2064  e(str).        d
-0000b3a0: 665f 7265 735b 2743 6c61 7269 7479 275d  f_res['Clarity']
-0000b3b0: 203d 205b 272d 275d 2a64 662e 7368 6170   = ['-']*df.shap
-0000b3c0: 655b 305d 0a20 2020 2020 2020 2064 665f  e[0].        df_
-0000b3d0: 7265 735b 272d 6c6f 6750 275d 203d 2064  res['-logP'] = d
-0000b3e0: 665b 635d 0a20 2020 2020 2020 2064 665f  f[c].        df_
-0000b3f0: 7265 735b 272d 6c6f 6750 2832 6e64 2927  res['-logP(2nd)'
-0000b400: 5d20 3d20 300a 2020 2020 2020 2020 2020  ] = 0.          
-0000b410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b420: 2020 2020 200a 2020 2020 2020 2020 6466       .        df
-0000b430: 5f72 6573 5b27 2d6c 6f67 502d 6c6f 6750  _res['-logP-logP
-0000b440: 2832 6e64 2927 5d20 3d20 6466 5b63 5d0a  (2nd)'] = df[c].
-0000b450: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000b460: 2020 6e65 675f 6c6f 675f 7076 616c 203d    neg_log_pval =
-0000b470: 2064 662e 6d61 7828 6178 6973 203d 2031   df.max(axis = 1
-0000b480: 290a 2020 2020 2020 2020 7375 6274 7970  ).        subtyp
-0000b490: 6520 3d20 6c69 7374 2864 662e 6964 786d  e = list(df.idxm
-0000b4a0: 6178 2861 7869 7320 3d20 3129 290a 2020  ax(axis = 1)).  
-0000b4b0: 2020 2020 2020 2374 635f 7375 6274 7970        #tc_subtyp
-0000b4c0: 6520 3d20 5b74 7261 6e73 5f64 6963 745b  e = [trans_dict[
-0000b4d0: 6b5d 2066 6f72 206b 2069 6e20 7463 5f73  k] for k in tc_s
-0000b4e0: 7562 7479 7065 5d0a 0a20 2020 2020 2020  ubtype]..       
-0000b4f0: 206d 6178 7620 3d20 5b5d 0a20 2020 2020   maxv = [].     
-0000b500: 2020 206d 6178 7632 203d 205b 5d0a 2020     maxv2 = [].  
-0000b510: 2020 2020 2020 6964 7832 203d 205b 5d0a        idx2 = [].
-0000b520: 2020 2020 2020 2020 4e6e 203d 205b 5d0a          Nn = [].
-0000b530: 2020 2020 2020 2020 4e31 203d 205b 5d0a          N1 = [].
-0000b540: 2020 2020 2020 2020 4e32 203d 205b 5d0a          N2 = [].
-0000b550: 2020 2020 2020 2020 7375 6274 7970 655f          subtype_
-0000b560: 6c73 7420 3d20 6c69 7374 2864 662e 636f  lst = list(df.co
-0000b570: 6c75 6d6e 732e 7661 6c75 6573 290a 0a20  lumns.values).. 
-0000b580: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
-0000b590: 7261 6e67 6528 6466 2e73 6861 7065 5b30  range(df.shape[0
-0000b5a0: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
-0000b5b0: 7820 3d20 6e70 2e61 7272 6179 2864 662e  x = np.array(df.
-0000b5c0: 696c 6f63 5b69 5d29 0a20 2020 2020 2020  iloc[i]).       
-0000b5d0: 2020 2020 206e 203d 206e 702e 6172 7261       n = np.arra
-0000b5e0: 7928 6466 6e2e 696c 6f63 5b69 5d29 0a20  y(dfn.iloc[i]). 
-0000b5f0: 2020 2020 2020 2020 2020 206f 6472 203d             odr =
-0000b600: 2028 2d78 292e 6172 6773 6f72 7428 290a   (-x).argsort().
-0000b610: 2020 2020 2020 2020 2020 2020 6d61 7876              maxv
-0000b620: 2e61 7070 656e 6428 785b 6f64 725b 305d  .append(x[odr[0]
-0000b630: 5d29 0a20 2020 2020 2020 2020 2020 206d  ]).            m
-0000b640: 6178 7632 2e61 7070 656e 6428 785b 6f64  axv2.append(x[od
-0000b650: 725b 315d 5d29 0a20 2020 2020 2020 2020  r[1]]).         
-0000b660: 2020 2069 6478 322e 6170 7065 6e64 2873     idx2.append(s
-0000b670: 7562 7479 7065 5f6c 7374 5b6f 6472 5b31  ubtype_lst[odr[1
-0000b680: 5d5d 290a 0a20 2020 2020 2020 2020 2020  ]])..           
-0000b690: 206b 3120 3d20 6e5f 6d6b 725b 7375 6274   k1 = n_mkr[subt
-0000b6a0: 7970 655f 6c73 745b 6f64 725b 305d 5d5d  ype_lst[odr[0]]]
-0000b6b0: 0a20 2020 2020 2020 2020 2020 206b 3220  .            k2 
-0000b6c0: 3d20 6e5f 6d6b 725b 7375 6274 7970 655f  = n_mkr[subtype_
-0000b6d0: 6c73 745b 6f64 725b 315d 5d5d 0a20 2020  lst[odr[1]]].   
-0000b6e0: 2020 2020 2020 2020 206e 3120 3d20 6e5b           n1 = n[
-0000b6f0: 6f64 725b 305d 5d0a 2020 2020 2020 2020  odr[0]].        
-0000b700: 2020 2020 6e32 203d 206e 5b6f 6472 5b31      n2 = n[odr[1
-0000b710: 5d5d 0a20 2020 2020 2020 2020 2020 2073  ]].            s
-0000b720: 3120 3d20 2725 692f 2569 2720 2520 286e  1 = '%i/%i' % (n
-0000b730: 312c 206b 3129 0a20 2020 2020 2020 2020  1, k1).         
-0000b740: 2020 2073 3220 3d20 2725 692f 2569 2720     s2 = '%i/%i' 
-0000b750: 2520 286e 322c 206b 3229 0a20 2020 2020  % (n2, k2).     
-0000b760: 2020 2020 2020 204e 312e 6170 7065 6e64         N1.append
-0000b770: 2873 3129 0a20 2020 2020 2020 2020 2020  (s1).           
-0000b780: 204e 322e 6170 7065 6e64 2873 3229 0a20   N2.append(s2). 
-0000b790: 2020 2020 2020 2020 2020 204e 6e2e 6170             Nn.ap
-0000b7a0: 7065 6e64 286e 3129 0a20 2020 2020 2020  pend(n1).       
-0000b7b0: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-0000b7c0: 2020 6e6c 7374 203d 205b 2725 692f 2569    nlst = ['%i/%i
-0000b7d0: 2720 2520 286e 6e2c 206e 5f6d 6b72 5b73  ' % (nn, n_mkr[s
-0000b7e0: 7562 7479 7065 5f6c 7374 5b6a 5d5d 2920  ubtype_lst[j]]) 
-0000b7f0: 666f 7220 6a2c 206e 6e20 696e 2065 6e75  for j, nn in enu
-0000b800: 6d65 7261 7465 286c 6973 7428 6e29 295d  merate(list(n))]
-0000b810: 0a20 2020 2020 2020 2020 2020 2064 666e  .            dfn
-0000b820: 2e69 6c6f 635b 695d 203d 206e 6c73 740a  .iloc[i] = nlst.
-0000b830: 0a20 2020 2020 2020 2023 2064 665f 7265  .        # df_re
-0000b840: 7320 3d20 7064 2e44 6174 6146 7261 6d65  s = pd.DataFrame
-0000b850: 287b 2743 4434 2b20 5420 6365 6c6c 2073  ({'CD4+ T cell s
-0000b860: 7562 7479 7065 273a 2074 635f 7375 6274  ubtype': tc_subt
-0000b870: 7970 652c 2027 4e65 674c 6f67 5076 616c  ype, 'NegLogPval
-0000b880: 273a 206e 6567 5f6c 6f67 5f70 7661 6c7d  ': neg_log_pval}
-0000b890: 2c20 696e 6465 7820 3d20 6466 2e69 6e64  , index = df.ind
-0000b8a0: 6578 2e76 616c 7565 7329 0a20 2020 2020  ex.values).     
-0000b8b0: 2020 2064 665f 7265 7320 3d20 7064 2e44     df_res = pd.D
-0000b8c0: 6174 6146 7261 6d65 287b 2763 656c 6c5f  ataFrame({'cell_
-0000b8d0: 7479 7065 273a 2073 7562 7479 7065 2c20  type': subtype, 
-0000b8e0: 2763 656c 6c5f 7479 7065 2872 6576 2927  'cell_type(rev)'
-0000b8f0: 3a20 7375 6274 7970 652c 200a 2020 2020  : subtype, .    
-0000b900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b910: 2020 2020 2020 2020 2020 2027 6365 6c6c             'cell
-0000b920: 5f74 7970 6528 3173 7429 273a 2073 7562  _type(1st)': sub
-0000b930: 7479 7065 2c20 274f 7665 726c 6170 273a  type, 'Overlap':
-0000b940: 204e 312c 0a20 2020 2020 2020 2020 2020   N1,.           
-0000b950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b960: 2020 2020 2763 656c 6c5f 7479 7065 2832      'cell_type(2
-0000b970: 6e64 2927 3a20 6964 7832 2c20 274f 7665  nd)': idx2, 'Ove
-0000b980: 726c 6170 2832 6e64 2927 3a20 4e32 2c0a  rlap(2nd)': N2,.
-0000b990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b9a0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0000b9b0: 436c 6172 6974 7927 3a20 5b27 2d27 5d2a  Clarity': ['-']*
-0000b9c0: 6466 2e73 6861 7065 5b30 5d2c 2027 2d6c  df.shape[0], '-l
-0000b9d0: 6f67 5027 3a20 6d61 7876 2c20 272d 6c6f  ogP': maxv, '-lo
-0000b9e0: 6750 2832 6e64 2927 3a20 6d61 7876 327d  gP(2nd)': maxv2}
-0000b9f0: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-0000ba00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ba10: 2069 6e64 6578 203d 2064 662e 696e 6465   index = df.inde
-0000ba20: 782e 7661 6c75 6573 290a 2020 2020 2020  x.values).      
-0000ba30: 2020 6466 5f72 6573 5b27 2d6c 6f67 502d    df_res['-logP-
-0000ba40: 6c6f 6750 2832 6e64 2927 5d20 3d20 6466  logP(2nd)'] = df
-0000ba50: 5f72 6573 5b27 2d6c 6f67 5027 5d20 2d20  _res['-logP'] - 
-0000ba60: 6466 5f72 6573 5b27 2d6c 6f67 5028 326e  df_res['-logP(2n
-0000ba70: 6429 275d 0a0a 2020 2020 2020 2020 6220  d)']..        b 
-0000ba80: 3d20 6e70 2e61 7272 6179 284e 6e29 203d  = np.array(Nn) =
-0000ba90: 3d20 300a 2020 2020 2020 2020 6466 5f72  = 0.        df_r
-0000baa0: 6573 2e6c 6f63 5b62 2c27 6365 6c6c 5f74  es.loc[b,'cell_t
-0000bab0: 7970 6527 5d20 3d20 2775 6e61 7373 6967  ype'] = 'unassig
-0000bac0: 6e65 6427 0a20 2020 2020 2020 2064 665f  ned'.        df_
-0000bad0: 7265 732e 6c6f 635b 622c 2763 656c 6c5f  res.loc[b,'cell_
-0000bae0: 7479 7065 2872 6576 2927 5d20 3d20 2775  type(rev)'] = 'u
-0000baf0: 6e61 7373 6967 6e65 6427 0a20 2020 2020  nassigned'.     
-0000bb00: 2020 2064 665f 7265 732e 6c6f 635b 622c     df_res.loc[b,
-0000bb10: 2763 656c 6c5f 7479 7065 2831 7374 2927  'cell_type(1st)'
-0000bb20: 5d20 3d20 2775 6e61 7373 6967 6e65 6427  ] = 'unassigned'
-0000bb30: 0a20 2020 2020 2020 2064 665f 7265 732e  .        df_res.
-0000bb40: 6c6f 635b 622c 2763 656c 6c5f 7479 7065  loc[b,'cell_type
-0000bb50: 2832 6e64 2927 5d20 3d20 2775 6e61 7373  (2nd)'] = 'unass
-0000bb60: 6967 6e65 6427 0a20 2020 2020 2020 0a20  igned'.       . 
-0000bb70: 2020 2023 2069 6620 7665 7262 6f73 653a     # if verbose:
-0000bb80: 2070 7269 6e74 2827 646f 6e65 2e20 2825   print('done. (%
-0000bb90: 6920 7329 2720 2520 726f 756e 6428 7469  i s)' % round(ti
-0000bba0: 6d65 2e74 696d 6528 2920 2d20 7374 6172  me.time() - star
-0000bbb0: 745f 7469 6d65 2929 0a20 2020 2064 665f  t_time)).    df_
-0000bbc0: 7363 6f72 6520 3d20 6466 0a20 2020 2072  score = df.    r
-0000bbd0: 6574 7572 6e20 6466 5f72 6573 2c20 6466  eturn df_res, df
-0000bbe0: 5f73 636f 7265 2c20 6466 6e0a 0a0a 6465  _score, dfn...de
-0000bbf0: 6620 435f 6d61 6a6f 725f 676d 6d28 585f  f C_major_gmm(X_
-0000bc00: 7063 612c 2079 732c 2063 6c61 7373 5f6e  pca, ys, class_n
-0000bc10: 616d 6573 2c20 6d65 7468 6f64 203d 2027  ames, method = '
-0000bc20: 676d 6d27 2c20 4e5f 636f 6d70 6f6e 656e  gmm', N_componen
-0000bc30: 7473 203d 2038 2c20 7665 7262 6f73 6520  ts = 8, verbose 
-0000bc40: 3d20 4661 6c73 6520 293a 0a20 2020 200a  = False ):.    .
-0000bc50: 2020 2020 6966 2076 6572 626f 7365 3a20      if verbose: 
-0000bc60: 7072 696e 7428 2746 6974 7469 6e67 2047  print('Fitting G
-0000bc70: 4d4d 202e 2e20 272c 2065 6e64 203d 2027  MM .. ', end = '
-0000bc80: 2729 0a20 2020 2073 7461 7274 5f74 696d  ').    start_tim
-0000bc90: 6520 3d20 7469 6d65 2e74 696d 6528 290a  e = time.time().
-0000bca0: 0a20 2020 2062 7320 3d20 2879 7320 3d3d  .    bs = (ys ==
-0000bcb0: 2063 6c61 7373 5f6e 616d 6573 5b30 5d29   class_names[0])
-0000bcc0: 0a20 2020 2066 6f72 2063 6e61 6d65 2069  .    for cname i
-0000bcd0: 6e20 6c69 7374 2863 6c61 7373 5f6e 616d  n list(class_nam
-0000bce0: 6573 5b31 3a5d 293a 0a20 2020 2020 2020  es[1:]):.       
-0000bcf0: 2062 7320 3d20 6273 207c 2028 7973 203d   bs = bs | (ys =
-0000bd00: 3d20 636e 616d 6529 0a20 2020 2020 2020  = cname).       
-0000bd10: 200a 2020 2020 5820 3d20 6e70 2e61 7272   .    X = np.arr
-0000bd20: 6179 2858 5f70 6361 2e6c 6f63 5b62 732c  ay(X_pca.loc[bs,
-0000bd30: 3a5d 290a 2020 2020 7920 3d20 7973 5b62  :]).    y = ys[b
-0000bd40: 735d 0a0a 2020 2020 2323 2053 656c 6563  s]..    ## Selec
-0000bd50: 7420 7472 6169 6e69 6e67 2063 656c 6c73  t training cells
-0000bd60: 0a20 2020 2064 665f 7363 6f72 6520 3d20  .    df_score = 
-0000bd70: 7064 2e44 6174 6146 7261 6d65 2869 6e64  pd.DataFrame(ind
-0000bd80: 6578 203d 2058 5f70 6361 2e69 6e64 6578  ex = X_pca.index
-0000bd90: 2e76 616c 7565 7329 0a20 2020 2063 6e74  .values).    cnt
-0000bda0: 203d 2030 0a20 2020 2066 6f72 2063 6e61   = 0.    for cna
-0000bdb0: 6d65 2069 6e20 6c69 7374 2863 6c61 7373  me in list(class
-0000bdc0: 5f6e 616d 6573 293a 0a20 2020 200a 2020  _names):.    .  
-0000bdd0: 2020 2020 2020 585f 746d 7020 3d20 585b        X_tmp = X[
-0000bde0: 7920 3d3d 2063 6e61 6d65 2c3a 5d0a 2020  y == cname,:].  
-0000bdf0: 2020 2020 2020 795f 746d 7020 3d20 795b        y_tmp = y[
-0000be00: 7920 3d3d 2063 6e61 6d65 5d0a 2020 2020  y == cname].    
-0000be10: 2020 2020 0a20 2020 2020 2020 2023 204e      .        # N
-0000be20: 5f63 6f6d 7020 3d20 6d69 6e28 6d61 7828  _comp = min(max(
-0000be30: 696e 7428 4e5f 636f 6d70 6f6e 656e 7473  int(N_components
-0000be40: 202a 206c 656e 2879 5f74 6d70 292f 737a   * len(y_tmp)/sz
-0000be50: 6d78 292c 3129 2c20 6c65 6e28 795f 746d  mx),1), len(y_tm
-0000be60: 7029 290a 2020 2020 2020 2020 2320 6966  p)).        # if
-0000be70: 206c 656e 2879 5f74 6d70 2920 3c20 3530   len(y_tmp) < 50
-0000be80: 3a20 4e5f 636f 6d70 203d 2031 0a20 2020  : N_comp = 1.   
-0000be90: 2020 2020 2023 2727 270a 2020 2020 2020       #'''.      
-0000bea0: 2020 7371 7274 4e20 3d20 6d61 7828 696e    sqrtN = max(in
-0000beb0: 7428 6e70 2e73 7172 7428 585f 7063 612e  t(np.sqrt(X_pca.
-0000bec0: 7368 6170 655b 305d 292f 3229 2c20 3129  shape[0])/2), 1)
-0000bed0: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-0000bee0: 795f 746d 7029 203c 3d20 4e5f 636f 6d70  y_tmp) <= N_comp
-0000bef0: 6f6e 656e 7473 3a0a 2020 2020 2020 2020  onents:.        
-0000bf00: 2020 2020 4e5f 636f 6d70 203d 2031 0a20      N_comp = 1. 
-0000bf10: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000bf20: 2020 2020 2020 2020 204e 5f63 6f6d 7020           N_comp 
-0000bf30: 3d20 6d69 6e28 4e5f 636f 6d70 6f6e 656e  = min(N_componen
-0000bf40: 7473 2c20 7371 7274 4e29 0a20 2020 2020  ts, sqrtN).     
-0000bf50: 2020 2023 2727 270a 0a20 2020 2020 2020     #'''..       
-0000bf60: 2069 6620 6c65 6e28 795f 746d 7029 203e   if len(y_tmp) >
-0000bf70: 204e 5f63 6f6d 703a 0a20 2020 2020 2020   N_comp:.       
-0000bf80: 2020 2020 2069 6620 6d65 7468 6f64 203d       if method =
-0000bf90: 3d20 2767 6d6d 273a 0a20 2020 2020 2020  = 'gmm':.       
-0000bfa0: 2020 2020 2020 2020 2067 6d6d 203d 206d           gmm = m
-0000bfb0: 6978 7475 7265 2e47 6175 7373 6961 6e4d  ixture.GaussianM
-0000bfc0: 6978 7475 7265 286e 5f63 6f6d 706f 6e65  ixture(n_compone
-0000bfd0: 6e74 7320 3d20 696e 7428 4e5f 636f 6d70  nts = int(N_comp
-0000bfe0: 292c 2072 616e 646f 6d5f 7374 6174 6520  ), random_state 
-0000bff0: 3d20 3029 0a20 2020 2020 2020 2020 2020  = 0).           
-0000c000: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000c010: 2020 2020 2020 2067 6d6d 203d 206d 6978         gmm = mix
-0000c020: 7475 7265 2e42 6179 6573 6961 6e47 6175  ture.BayesianGau
-0000c030: 7373 6961 6e4d 6978 7475 7265 286e 5f63  ssianMixture(n_c
-0000c040: 6f6d 706f 6e65 6e74 7320 3d20 696e 7428  omponents = int(
-0000c050: 4e5f 636f 6d70 292c 200a 2020 2020 2020  N_comp), .      
-0000c060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c090: 6d61 785f 6974 6572 203d 2031 3030 302c  max_iter = 1000,
-0000c0a0: 2072 616e 646f 6d5f 7374 6174 6520 3d20   random_state = 
-0000c0b0: 3029 0a0a 2020 2020 2020 2020 2020 2020  0)..            
-0000c0c0: 676d 6d2e 6669 7428 6e70 2e61 7272 6179  gmm.fit(np.array
-0000c0d0: 2858 5f74 6d70 2929 0a20 2020 2020 2020  (X_tmp)).       
-0000c0e0: 2020 2020 2079 5f63 6f6e 6620 3d20 676d       y_conf = gm
-0000c0f0: 6d2e 7363 6f72 655f 7361 6d70 6c65 7328  m.score_samples(
-0000c100: 6e70 2e61 7272 6179 2858 5f70 6361 2929  np.array(X_pca))
-0000c110: 0a20 2020 2020 2020 2020 2020 2064 665f  .            df_
-0000c120: 7363 6f72 655b 2725 7327 2025 2063 6e61  score['%s' % cna
-0000c130: 6d65 5d20 3d20 6c69 7374 2879 5f63 6f6e  me] = list(y_con
-0000c140: 6629 0a20 2020 2020 2020 2020 2020 2063  f).            c
-0000c150: 6e74 202b 3d20 310a 2020 2020 0a20 2020  nt += 1.    .   
-0000c160: 2069 6620 636e 7420 3e20 313a 0a20 2020   if cnt > 1:.   
-0000c170: 2020 2020 2079 5f70 7265 6420 3d20 6466       y_pred = df
-0000c180: 5f73 636f 7265 2e69 6478 6d61 7828 6178  _score.idxmax(ax
-0000c190: 6973 203d 2031 290a 2020 2020 656c 7365  is = 1).    else
-0000c1a0: 3a0a 2020 2020 2020 2020 795f 7072 6564  :.        y_pred
-0000c1b0: 203d 2070 642e 5365 7269 6573 2869 6e64   = pd.Series(ind
-0000c1c0: 6578 203d 2058 5f70 6361 2e69 6e64 6578  ex = X_pca.index
-0000c1d0: 2e76 616c 7565 732c 2064 7479 7065 203d  .values, dtype =
-0000c1e0: 2066 6c6f 6174 290a 2020 2020 2020 2020   float).        
-0000c1f0: 6966 2063 6e74 203d 3d20 313a 0a20 2020  if cnt == 1:.   
-0000c200: 2020 2020 2020 2020 2079 5f70 7265 645b           y_pred[
-0000c210: 3a5d 203d 2064 665f 7363 6f72 652e 636f  :] = df_score.co
-0000c220: 6c75 6d6e 732e 7661 6c75 6573 5b30 5d0a  lumns.values[0].
-0000c230: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000c240: 2020 2020 2020 2020 2020 795f 7072 6564            y_pred
-0000c250: 5b3a 5d20 3d20 2775 6e61 7373 6967 6e65  [:] = 'unassigne
-0000c260: 6427 0a20 2020 2020 2020 200a 2020 2020  d'.        .    
-0000c270: 795f 7072 6564 5b7e 6273 5d20 3d20 2775  y_pred[~bs] = 'u
-0000c280: 6e61 7373 6967 6e65 6427 0a20 2020 200a  nassigned'.    .
-0000c290: 2020 2020 2320 6966 2076 6572 626f 7365      # if verbose
-0000c2a0: 3a20 7072 696e 7428 2747 4d4d 2063 6f72  : print('GMM cor
-0000c2b0: 7265 6374 696f 6e3a 2025 6920 2d3e 2025  rection: %i -> %
-0000c2c0: 692c 2025 6927 2025 2028 6c65 6e28 6273  i, %i' % (len(bs
-0000c2d0: 292c 206e 702e 7375 6d28 6273 292c 206e  ), np.sum(bs), n
-0000c2e0: 702e 7375 6d28 795f 7072 6564 203d 3d20  p.sum(y_pred == 
-0000c2f0: 2775 6e61 7373 6967 6e65 6427 2920 2929  'unassigned') ))
-0000c300: 2020 2020 0a20 2020 2023 2069 6620 7665      .    # if ve
-0000c310: 7262 6f73 653a 2070 7269 6e74 2827 646f  rbose: print('do
-0000c320: 6e65 2e20 2825 6920 7329 2720 2520 726f  ne. (%i s)' % ro
-0000c330: 756e 6428 7469 6d65 2e74 696d 6528 2920  und(time.time() 
-0000c340: 2d20 7374 6172 745f 7469 6d65 2929 0a20  - start_time)). 
-0000c350: 2020 2072 6574 7572 6e20 795f 7072 6564     return y_pred
-0000c360: 2c20 6466 5f73 636f 7265 0a0a 0a64 6566  , df_score...def
-0000c370: 2043 5f6d 616a 6f72 5f6c 6f67 7265 6728   C_major_logreg(
-0000c380: 585f 7063 612c 2079 732c 2063 6c61 7373  X_pca, ys, class
-0000c390: 5f6e 616d 6573 2c20 7665 7262 6f73 6520  _names, verbose 
-0000c3a0: 3d20 4661 6c73 6520 293a 0a20 2020 200a  = False ):.    .
-0000c3b0: 2020 2020 6966 2076 6572 626f 7365 3a20      if verbose: 
-0000c3c0: 7072 696e 7428 2746 6974 7469 6e67 204c  print('Fitting L
-0000c3d0: 6f67 6973 7469 6320 5265 6772 6573 7369  ogistic Regressi
-0000c3e0: 6f6e 206d 6f64 656c 202e 2e20 272c 2065  on model .. ', e
-0000c3f0: 6e64 203d 2027 2729 0a20 2020 2073 7461  nd = '').    sta
-0000c400: 7274 5f74 696d 6520 3d20 7469 6d65 2e74  rt_time = time.t
-0000c410: 696d 6528 290a 0a20 2020 2062 7320 3d20  ime()..    bs = 
-0000c420: 2879 7320 3d3d 2063 6c61 7373 5f6e 616d  (ys == class_nam
-0000c430: 6573 5b30 5d29 0a20 2020 2066 6f72 2063  es[0]).    for c
-0000c440: 6e61 6d65 2069 6e20 6c69 7374 2863 6c61  name in list(cla
-0000c450: 7373 5f6e 616d 6573 5b31 3a5d 293a 0a20  ss_names[1:]):. 
-0000c460: 2020 2020 2020 2062 7320 3d20 6273 207c         bs = bs |
-0000c470: 2028 7973 203d 3d20 636e 616d 6529 0a20   (ys == cname). 
-0000c480: 2020 2020 2020 200a 2020 2020 5820 3d20         .    X = 
-0000c490: 6e70 2e61 7272 6179 2858 5f70 6361 2e6c  np.array(X_pca.l
-0000c4a0: 6f63 5b62 732c 3a5d 290a 2020 2020 7920  oc[bs,:]).    y 
-0000c4b0: 3d20 7973 5b62 735d 0a0a 2020 2020 4e43  = ys[bs]..    NC
-0000c4c0: 5620 3d20 4c4f 4752 4547 5f4e 4356 0a20  V = LOGREG_NCV. 
-0000c4d0: 2020 204d 4158 5f49 5445 5220 3d20 4c4f     MAX_ITER = LO
-0000c4e0: 4752 4547 5f4d 4158 5f49 5445 520a 2020  GREG_MAX_ITER.  
-0000c4f0: 2020 7061 7261 6d5f 6772 6964 203d 204c    param_grid = L
-0000c500: 4f47 5245 475f 5041 5241 4d5f 4752 4944  OGREG_PARAM_GRID
-0000c510: 0a0a 2020 2020 6e5f 7361 6d70 6c65 732c  ..    n_samples,
-0000c520: 206e 5f66 6561 7475 7265 7320 3d20 582e   n_features = X.
-0000c530: 7368 6170 650a 2020 2020 6376 203d 206d  shape.    cv = m
-0000c540: 6f64 5f73 656c 2e53 7472 6174 6966 6965  od_sel.Stratifie
-0000c550: 644b 466f 6c64 286e 5f73 706c 6974 733d  dKFold(n_splits=
-0000c560: 4e43 5629 0a20 2020 2063 6c61 7373 6966  NCV).    classif
-0000c570: 6965 7220 3d20 6c6d 2e4c 6f67 6973 7469  ier = lm.Logisti
-0000c580: 6352 6567 7265 7373 696f 6e28 7065 6e61  cRegression(pena
-0000c590: 6c74 7920 3d20 2765 6c61 7374 6963 6e65  lty = 'elasticne
-0000c5a0: 7427 2c20 0a20 2020 2020 2020 2020 2020  t', .           
-0000c5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5c0: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
-0000c5d0: 6974 6572 203d 204d 4158 5f49 5445 522c  iter = MAX_ITER,
-0000c5e0: 2073 6f6c 7665 7220 3d20 2773 6167 6127   solver = 'saga'
-0000c5f0: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-0000c600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c610: 2020 2020 2020 2020 2020 636c 6173 735f            class_
-0000c620: 7765 6967 6874 203d 2027 6261 6c61 6e63  weight = 'balanc
-0000c630: 6564 272c 746f 6c20 3d20 4c4f 4752 4547  ed',tol = LOGREG
-0000c640: 5f54 4f4c 290a 0a20 2020 2077 6974 6820  _TOL)..    with 
-0000c650: 7761 726e 696e 6773 2e63 6174 6368 5f77  warnings.catch_w
-0000c660: 6172 6e69 6e67 7328 293a 0a20 2020 2020  arnings():.     
-0000c670: 2020 2077 6172 6e69 6e67 732e 7369 6d70     warnings.simp
-0000c680: 6c65 6669 6c74 6572 2822 6967 6e6f 7265  lefilter("ignore
-0000c690: 2229 0a20 2020 2020 2020 2023 2077 6172  ").        # war
-0000c6a0: 6e69 6e67 732e 6669 6c74 6572 7761 726e  nings.filterwarn
-0000c6b0: 696e 6773 2822 6967 6e6f 7265 222c 2063  ings("ignore", c
-0000c6c0: 6174 6567 6f72 793d 436f 6e76 6572 6765  ategory=Converge
-0000c6d0: 6e63 6557 6172 6e69 6e67 290a 2020 2020  nceWarning).    
-0000c6e0: 2020 2020 6773 203d 206d 6f64 5f73 656c      gs = mod_sel
-0000c6f0: 2e47 7269 6453 6561 7263 6843 5628 636c  .GridSearchCV(cl
-0000c700: 6173 7369 6669 6572 2c20 7061 7261 6d5f  assifier, param_
-0000c710: 6772 6964 2c20 6376 3d63 762c 2073 636f  grid, cv=cv, sco
-0000c720: 7269 6e67 3d27 6261 6c61 6e63 6564 5f61  ring='balanced_a
-0000c730: 6363 7572 6163 7927 2c20 7265 6669 7420  ccuracy', refit 
-0000c740: 3d20 5472 7565 2c20 6e5f 6a6f 6273 203d  = True, n_jobs =
-0000c750: 204e 4356 2c20 7665 7262 6f73 6520 3d20   NCV, verbose = 
-0000c760: 3029 0a0a 2020 2020 2020 2020 6773 2e66  0)..        gs.f
-0000c770: 6974 2858 2c79 290a 2020 2020 2020 2020  it(X,y).        
-0000c780: 7072 696e 7428 6773 2e62 6573 745f 7061  print(gs.best_pa
-0000c790: 7261 6d73 5f2c 2067 732e 6265 7374 5f73  rams_, gs.best_s
-0000c7a0: 636f 7265 5f29 0a0a 2020 2020 636c 6173  core_)..    clas
-0000c7b0: 7369 6669 6572 203d 2067 732e 6265 7374  sifier = gs.best
-0000c7c0: 5f65 7374 696d 6174 6f72 5f0a 2020 2020  _estimator_.    
-0000c7d0: 795f 7072 6564 203d 2063 6c61 7373 6966  y_pred = classif
-0000c7e0: 6965 722e 7072 6564 6963 7428 585f 7063  ier.predict(X_pc
-0000c7f0: 6129 0a20 2020 2079 5f70 726f 6220 3d20  a).    y_prob = 
-0000c800: 636c 6173 7369 6669 6572 2e70 7265 6469  classifier.predi
-0000c810: 6374 5f70 726f 6261 2858 5f70 6361 290a  ct_proba(X_pca).
-0000c820: 0a20 2020 2063 6f6c 7320 3d20 6c69 7374  .    cols = list
-0000c830: 2863 6c61 7373 6966 6965 722e 636c 6173  (classifier.clas
-0000c840: 7365 735f 290a 2020 2020 6466 5f73 636f  ses_).    df_sco
-0000c850: 7265 203d 2070 642e 4461 7461 4672 616d  re = pd.DataFram
-0000c860: 6528 6e70 2e6c 6f67 3130 2879 5f70 726f  e(np.log10(y_pro
-0000c870: 6220 2b20 3165 2d31 3030 292c 2069 6e64  b + 1e-100), ind
-0000c880: 6578 203d 2058 5f70 6361 2e69 6e64 6578  ex = X_pca.index
-0000c890: 2e76 616c 7565 732c 2063 6f6c 756d 6e73  .values, columns
-0000c8a0: 203d 2063 6f6c 7329 0a20 2020 2020 2020   = cols).       
-0000c8b0: 2020 2020 200a 2020 2020 795f 7072 6564       .    y_pred
-0000c8c0: 203d 2064 665f 7363 6f72 652e 6964 786d   = df_score.idxm
-0000c8d0: 6178 2861 7869 7320 3d20 3129 0a20 2020  ax(axis = 1).   
-0000c8e0: 200a 2020 2020 2320 6966 2076 6572 626f   .    # if verbo
-0000c8f0: 7365 3a20 7072 696e 7428 2764 6f6e 652e  se: print('done.
-0000c900: 2028 2569 2073 2927 2025 2072 6f75 6e64   (%i s)' % round
-0000c910: 2874 696d 652e 7469 6d65 2829 202d 2073  (time.time() - s
-0000c920: 7461 7274 5f74 696d 6529 290a 2020 2020  tart_time)).    
-0000c930: 7265 7475 726e 2079 5f70 7265 642c 2064  return y_pred, d
-0000c940: 665f 7363 6f72 650a 2020 2020 2020 0a20  f_score.      . 
-0000c950: 2020 200a 6465 6620 6765 745f 7468 7265     .def get_thre
-0000c960: 7368 6f6c 6428 7661 6c75 6573 2c20 7461  shold(values, ta
-0000c970: 7267 6574 5f46 5052 203d 2030 2e30 352c  rget_FPR = 0.05,
-0000c980: 2075 7070 6572 203d 2054 7275 6529 3a0a   upper = True):.
-0000c990: 2020 2020 0a20 2020 207a 203d 206e 702e      .    z = np.
-0000c9a0: 6172 7261 7928 7661 6c75 6573 290a 2020  array(values).  
-0000c9b0: 2020 6f64 7220 3d20 7a2e 6172 6773 6f72    odr = z.argsor
-0000c9c0: 7428 290a 2020 2020 6e20 3d20 696e 7428  t().    n = int(
-0000c9d0: 726f 756e 6428 6c65 6e28 6f64 7229 2a74  round(len(odr)*t
-0000c9e0: 6172 6765 745f 4650 5229 290a 2020 2020  arget_FPR)).    
-0000c9f0: 6966 206e 203e 3d20 6c65 6e28 6f64 7229  if n >= len(odr)
-0000ca00: 3a0a 2020 2020 2020 2020 6e20 3d20 696e  :.        n = in
-0000ca10: 7428 6c65 6e28 6f64 7229 2d31 290a 2020  t(len(odr)-1).  
-0000ca20: 2020 6966 2075 7070 6572 3a0a 2020 2020    if upper:.    
-0000ca30: 2020 2020 7468 203d 207a 5b6f 6472 5b2d      th = z[odr[-
-0000ca40: 6e5d 5d0a 2020 2020 656c 7365 3a0a 2020  n]].    else:.  
-0000ca50: 2020 2020 2020 7468 203d 207a 5b6f 6472        th = z[odr
-0000ca60: 5b6e 5d5d 0a20 2020 2072 6574 7572 6e20  [n]].    return 
-0000ca70: 7468 0a0a 0a64 6566 2067 6574 5f74 6872  th...def get_thr
-0000ca80: 6573 686f 6c64 5f4e 2876 616c 7565 732c  eshold_N(values,
-0000ca90: 204e 4e20 3d20 312c 2075 7070 6572 203d   NN = 1, upper =
-0000caa0: 2054 7275 6529 3a0a 2020 2020 0a20 2020   True):.    .   
-0000cab0: 207a 203d 206e 702e 6172 7261 7928 7661   z = np.array(va
-0000cac0: 6c75 6573 290a 2020 2020 6f64 7220 3d20  lues).    odr = 
-0000cad0: 7a2e 6172 6773 6f72 7428 290a 2020 2020  z.argsort().    
-0000cae0: 6e20 3d20 696e 7428 4e4e 290a 2020 2020  n = int(NN).    
-0000caf0: 6966 206e 203e 3d20 6c65 6e28 6f64 7229  if n >= len(odr)
-0000cb00: 3a0a 2020 2020 2020 2020 6e20 3d20 696e  :.        n = in
-0000cb10: 7428 6c65 6e28 6f64 7229 2d31 290a 2020  t(len(odr)-1).  
-0000cb20: 2020 6966 2075 7070 6572 3a0a 2020 2020    if upper:.    
-0000cb30: 2020 2020 7468 203d 207a 5b6f 6472 5b2d      th = z[odr[-
-0000cb40: 6e5d 5d0a 2020 2020 656c 7365 3a0a 2020  n]].    else:.  
-0000cb50: 2020 2020 2020 7468 203d 207a 5b6f 6472        th = z[odr
-0000cb60: 5b6e 5d5d 0a20 2020 2072 6574 7572 6e20  [n]].    return 
-0000cb70: 7468 0a0a 2327 2727 0a0a 6465 6620 6765  th..#'''..def ge
-0000cb80: 745f 6e6f 726d 616c 5f70 6466 2820 782c  t_normal_pdf( x,
-0000cb90: 206d 752c 2076 6172 2c20 6e62 696e 7329   mu, var, nbins)
-0000cba0: 3a0a 2020 2020 0a20 2020 2079 203d 206e  :.    .    y = n
-0000cbb0: 702e 6172 7261 7928 7829 0a20 2020 206d  p.array(x).    m
-0000cbc0: 6e5f 7820 3d20 792e 6d69 6e28 290a 2020  n_x = y.min().  
-0000cbd0: 2020 6d78 5f78 203d 2079 2e6d 6178 2829    mx_x = y.max()
-0000cbe0: 0a20 2020 204c 203d 2031 3030 0a20 2020  .    L = 100.   
-0000cbf0: 2023 2064 7820 3d20 6c65 6e28 7929 2a28   # dx = len(y)*(
-0000cc00: 6d78 5f78 2d6d 6e5f 7829 2f4c 0a20 2020  mx_x-mn_x)/L.   
-0000cc10: 2064 7820 3d20 286d 785f 782d 6d6e 5f78   dx = (mx_x-mn_x
-0000cc20: 292f 6e62 696e 730a 2020 2020 7873 203d  )/nbins.    xs =
-0000cc30: 206e 702e 6172 616e 6765 286d 6e5f 782c   np.arange(mn_x,
-0000cc40: 6d78 5f78 2c20 6478 2029 0a20 2020 2070  mx_x, dx ).    p
-0000cc50: 6466 203d 2028 6478 2a6c 656e 2879 2929  df = (dx*len(y))
-0000cc60: 2a6e 702e 6578 7028 2d28 2878 732d 6d75  *np.exp(-((xs-mu
-0000cc70: 292a 2a32 292f 2832 2a76 6172 2b31 652d  )**2)/(2*var+1e-
-0000cc80: 3130 2929 2f28 6e70 2e73 7172 7428 322a  10))/(np.sqrt(2*
-0000cc90: 6d61 7468 2e70 692a 7661 7229 2b31 652d  math.pi*var)+1e-
-0000cca0: 3130 2920 2b20 3165 2d31 300a 2020 2020  10) + 1e-10.    
-0000ccb0: 7265 7475 726e 2070 6466 2c20 7873 0a0a  return pdf, xs..
-0000ccc0: 0a64 6566 2067 6574 5f74 6872 6573 686f  .def get_thresho
-0000ccd0: 6c64 5f75 7369 6e67 5f70 6172 616d 2820  ld_using_param( 
-0000cce0: 7061 7261 6d2c 2054 6172 6765 745f 4650  param, Target_FP
-0000ccf0: 5220 3d20 302e 3120 293a 0a20 2020 200a  R = 0.1 ):.    .
-0000cd00: 2020 2020 7730 2c20 6d30 2c20 7630 2c20      w0, m0, v0, 
-0000cd10: 7731 2c20 6d31 2c20 7631 203d 2070 6172  w1, m1, v1 = par
-0000cd20: 616d 200a 2020 2020 6d78 7620 3d20 6d31  am .    mxv = m1
-0000cd30: 2b6e 702e 7371 7274 2876 3129 0a20 2020  +np.sqrt(v1).   
-0000cd40: 206d 6e76 203d 206d 300a 2020 2020 7a20   mnv = m0.    z 
-0000cd50: 3d20 6e70 2e61 7261 6e67 6528 6d6e 762c  = np.arange(mnv,
-0000cd60: 6d78 762c 2028 6d78 762d 6d6e 7629 2f31  mxv, (mxv-mnv)/1
-0000cd70: 3030 3029 0a0a 2020 2020 6530 203d 2031  000)..    e0 = 1
-0000cd80: 202d 2030 2e35 2a28 3120 2b20 6572 6628   - 0.5*(1 + erf(
-0000cd90: 287a 202d 206d 3029 2f6e 702e 7371 7274  (z - m0)/np.sqrt
-0000cda0: 2876 3029 2929 0a20 2020 2065 3120 3d20  (v0))).    e1 = 
-0000cdb0: 3120 2d20 302e 352a 2831 202b 2065 7266  1 - 0.5*(1 + erf
-0000cdc0: 2828 7a20 2d20 6d31 292f 6e70 2e73 7172  ((z - m1)/np.sqr
-0000cdd0: 7428 7631 2929 290a 2020 2020 6670 7220  t(v1))).    fpr 
-0000cde0: 3d20 6530 2f65 310a 2020 2020 0a20 2020  = e0/e1.    .   
-0000cdf0: 2069 6620 6670 722e 6d69 6e28 2920 3c20   if fpr.min() < 
-0000ce00: 5461 7267 6574 5f46 5052 3a0a 2020 2020  Target_FPR:.    
-0000ce10: 2020 2020 6920 3d20 6e70 2e61 6273 2866      i = np.abs(f
-0000ce20: 7072 2d54 6172 6765 745f 4650 5229 2e61  pr-Target_FPR).a
-0000ce30: 7267 6d69 6e28 290a 2020 2020 2020 2020  rgmin().        
-0000ce40: 7468 7265 7368 6f6c 6420 3d20 7a5b 695d  threshold = z[i]
-0000ce50: 0a20 2020 2065 6c73 653a 200a 2020 2020  .    else: .    
-0000ce60: 2020 2020 6920 3d20 6670 722e 6172 676d      i = fpr.argm
-0000ce70: 696e 2829 0a20 2020 2020 2020 2074 6872  in().        thr
-0000ce80: 6573 686f 6c64 203d 207a 5b69 5d0a 2020  eshold = z[i].  
-0000ce90: 2020 2020 2020 2020 2020 0a20 2020 2072            .    r
-0000cea0: 6574 7572 6e20 7468 7265 7368 6f6c 640a  eturn threshold.
-0000ceb0: 0a64 6566 2062 696d 6f64 616c 5f66 6974  .def bimodal_fit
-0000cec0: 2820 785f 7363 6f72 6520 293a 0a20 2020  ( x_score ):.   
-0000ced0: 200a 2020 2020 7820 3d20 785f 7363 6f72   .    x = x_scor
-0000cee0: 650a 0a20 2020 2067 6d6d 203d 206d 6978  e..    gmm = mix
-0000cef0: 7475 7265 2e47 6175 7373 6961 6e4d 6978  ture.GaussianMix
-0000cf00: 7475 7265 286e 5f63 6f6d 706f 6e65 6e74  ture(n_component
-0000cf10: 7320 3d20 322c 2072 616e 646f 6d5f 7374  s = 2, random_st
-0000cf20: 6174 6520 3d20 3029 0a20 2020 2079 203d  ate = 0).    y =
-0000cf30: 2067 6d6d 2e66 6974 5f70 7265 6469 6374   gmm.fit_predict
-0000cf40: 286e 702e 6172 7261 7928 7829 2e72 6573  (np.array(x).res
-0000cf50: 6861 7065 282d 312c 2031 2929 0a0a 2020  hape(-1, 1))..  
-0000cf60: 2020 6d6e 7320 3d20 5b6d 5b30 5d20 666f    mns = [m[0] fo
-0000cf70: 7220 6d20 696e 2067 6d6d 2e6d 6561 6e73  r m in gmm.means
-0000cf80: 5f5d 0a20 2020 2063 7673 203d 205b 6376  _].    cvs = [cv
-0000cf90: 5b30 2c30 5d20 666f 7220 6376 2069 6e20  [0,0] for cv in 
-0000cfa0: 676d 6d2e 636f 7661 7269 616e 6365 735f  gmm.covariances_
-0000cfb0: 5d0a 0a20 2020 2077 6773 203d 2067 6d6d  ]..    wgs = gmm
-0000cfc0: 2e77 6569 6768 7473 5f20 2020 2020 2020  .weights_       
-0000cfd0: 2020 2020 0a20 2020 2069 6620 6d6e 735b      .    if mns[
-0000cfe0: 305d 203c 206d 6e73 5b31 5d3a 0a20 2020  0] < mns[1]:.   
-0000cff0: 2020 2020 2077 302c 2077 3120 3d20 7767       w0, w1 = wg
-0000d000: 735b 305d 2c20 7767 735b 315d 0a20 2020  s[0], wgs[1].   
-0000d010: 2020 2020 206d 302c 206d 3120 3d20 6d6e       m0, m1 = mn
-0000d020: 735b 305d 2c20 6d6e 735b 315d 0a20 2020  s[0], mns[1].   
-0000d030: 2020 2020 2076 302c 2076 3120 3d20 6376       v0, v1 = cv
-0000d040: 735b 305d 2c20 6376 735b 315d 0a20 2020  s[0], cvs[1].   
-0000d050: 2065 6c73 653a 0a20 2020 2020 2020 2077   else:.        w
-0000d060: 302c 2077 3120 3d20 7767 735b 315d 2c20  0, w1 = wgs[1], 
-0000d070: 7767 735b 305d 0a20 2020 2020 2020 206d  wgs[0].        m
-0000d080: 302c 206d 3120 3d20 6d6e 735b 315d 2c20  0, m1 = mns[1], 
-0000d090: 6d6e 735b 305d 0a20 2020 2020 2020 2076  mns[0].        v
-0000d0a0: 302c 2076 3120 3d20 6376 735b 315d 2c20  0, v1 = cvs[1], 
-0000d0b0: 6376 735b 305d 0a0a 2020 2020 7265 7475  cvs[0]..    retu
-0000d0c0: 726e 2077 302c 206d 302c 2076 302c 2077  rn w0, m0, v0, w
-0000d0d0: 312c 206d 312c 2076 310a 2020 2020 0a20  1, m1, v1.    . 
-0000d0e0: 2020 200a 6465 6620 6765 745f 7468 7265     .def get_thre
-0000d0f0: 7368 6f6c 645f 6672 6f6d 5f47 5341 5f72  shold_from_GSA_r
-0000d100: 6573 756c 7428 6466 5f73 756d 2c20 7076  esult(df_sum, pv
-0000d110: 616c 5f74 6820 3d20 302e 3035 2c20 7461  al_th = 0.05, ta
-0000d120: 7267 6574 5f46 5052 203d 2030 2e30 352c  rget_FPR = 0.05,
-0000d130: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-0000d140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d150: 2020 2020 2076 6572 626f 7365 203d 2046       verbose = F
-0000d160: 616c 7365 2c20 706c 6f74 5f68 6973 7420  alse, plot_hist 
-0000d170: 3d20 4661 6c73 6529 3a0a 2020 2020 0a20  = False):.    . 
-0000d180: 2020 2074 6172 6765 745f 7479 7065 7320     target_types 
-0000d190: 3d20 6c69 7374 2864 665f 7375 6d5b 2763  = list(df_sum['c
-0000d1a0: 656c 6c5f 7479 7065 2831 7374 2927 5d2e  ell_type(1st)'].
-0000d1b0: 756e 6971 7565 2829 290a 2020 2020 7468  unique()).    th
-0000d1c0: 7265 7368 6f6c 6473 203d 207b 7d0a 2020  resholds = {}.  
-0000d1d0: 2020 6d31 6d32 5f72 6174 696f 203d 207b    m1m2_ratio = {
-0000d1e0: 7d0a 2020 2020 0a20 2020 2069 6620 7665  }.    .    if ve
-0000d1f0: 7262 6f73 653a 0a20 2020 2020 2020 2070  rbose:.        p
-0000d200: 7269 6e74 2827 5468 7265 7368 6f6c 6473  rint('Thresholds
-0000d210: 3a27 290a 2020 2020 2020 2020 0a20 2020  :').        .   
-0000d220: 2069 6620 6c65 6e28 7461 7267 6574 5f74   if len(target_t
-0000d230: 7970 6573 2920 3d3d 2031 3a0a 2020 2020  ypes) == 1:.    
-0000d240: 2020 2020 0a20 2020 2020 2020 2074 203d      .        t =
-0000d250: 2074 6172 6765 745f 7479 7065 735b 305d   target_types[0]
-0000d260: 0a20 2020 2020 2020 2078 5f73 636f 7265  .        x_score
-0000d270: 203d 2064 665f 7375 6d5b 272d 6c6f 6750   = df_sum['-logP
-0000d280: 275d 2023 206e 702e 6c6f 6731 3028 6466  '] # np.log10(df
-0000d290: 5f73 756d 5b27 2d6c 6f67 5027 5d20 2b20  _sum['-logP'] + 
-0000d2a0: 3165 2d33 290a 2020 2020 2020 2020 7061  1e-3).        pa
-0000d2b0: 7261 6d20 3d20 6269 6d6f 6461 6c5f 6669  ram = bimodal_fi
-0000d2c0: 7428 2078 5f73 636f 7265 2029 0a20 2020  t( x_score ).   
-0000d2d0: 2020 2020 2074 6872 6573 6820 3d20 6765       thresh = ge
-0000d2e0: 745f 7468 7265 7368 6f6c 645f 7573 696e  t_threshold_usin
-0000d2f0: 675f 7061 7261 6d28 2070 6172 616d 2c20  g_param( param, 
-0000d300: 5461 7267 6574 5f46 5052 203d 2074 6172  Target_FPR = tar
-0000d310: 6765 745f 4650 5220 290a 2020 2020 2020  get_FPR ).      
-0000d320: 2020 7730 2c20 6d30 2c20 7630 2c20 7731    w0, m0, v0, w1
-0000d330: 2c20 6d31 2c20 7631 203d 2070 6172 616d  , m1, v1 = param
-0000d340: 200a 2020 2020 2020 2020 2320 6d30 203d   .        # m0 =
-0000d350: 2031 302a 2a6d 300a 2020 2020 2020 2020   10**m0.        
-0000d360: 2320 6d31 203d 2031 302a 2a6d 310a 2020  # m1 = 10**m1.  
-0000d370: 2020 2020 2020 2320 7468 7265 7368 203d        # thresh =
-0000d380: 2031 302a 2a74 6872 6573 680a 2020 2020   10**thresh.    
-0000d390: 2020 2020 7468 7265 7368 6f6c 6473 5b74      thresholds[t
-0000d3a0: 5d20 3d20 7468 7265 7368 0a20 2020 2020  ] = thresh.     
-0000d3b0: 2020 206d 316d 325f 7261 7469 6f5b 745d     m1m2_ratio[t]
-0000d3c0: 203d 206d 312f 6d30 2023 2028 3130 2a2a   = m1/m0 # (10**
-0000d3d0: 6d31 292f 2831 302a 2a6d 3029 0a0a 2020  m1)/(10**m0)..  
-0000d3e0: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-0000d3f0: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
-0000d400: 696e 7428 2720 2020 2531 3673 3a20 2535  int('   %16s: %5
-0000d410: 2e33 662c 2025 352e 3366 203e 2025 352e  .3f, %5.3f > %5.
-0000d420: 3266 2c20 2535 2e32 6620 3e20 2569 2f25  2f, %5.2f > %i/%
-0000d430: 6927 2025 205c 0a20 2020 2020 2020 2020  i' % \.         
-0000d440: 2020 2020 2028 742c 206d 312c 206d 302c       (t, m1, m0,
-0000d450: 2074 6872 6573 682c 206d 312f 6d30 2c20   thresh, m1/m0, 
-0000d460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d470: 6e70 2e73 756d 2878 5f73 636f 7265 203e  np.sum(x_score >
-0000d480: 3d20 7468 7265 7368 292c 206c 656e 2878  = thresh), len(x
-0000d490: 5f73 636f 7265 2929 290a 2020 2020 656c  _score))).    el
-0000d4a0: 7365 3a0a 2020 2020 2020 2020 666f 7220  se:.        for 
-0000d4b0: 7420 696e 2074 6172 6765 745f 7479 7065  t in target_type
-0000d4c0: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-0000d4d0: 6620 7420 213d 2027 756e 6173 7369 676e  f t != 'unassign
-0000d4e0: 6564 273a 0a20 2020 2020 2020 2020 2020  ed':.           
-0000d4f0: 2020 2020 2074 6172 6765 7420 3d20 740a       target = t.
-0000d500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d510: 2062 3120 3d20 2864 665f 7375 6d5b 2763   b1 = (df_sum['c
-0000d520: 656c 6c5f 7479 7065 2831 7374 2927 5d20  ell_type(1st)'] 
-0000d530: 3d3d 2074 6172 6765 7429 2026 205c 0a20  == target) & \. 
-0000d540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d550: 2020 2020 2864 665f 7375 6d5b 272d 6c6f      (df_sum['-lo
-0000d560: 6750 275d 203e 3d20 2d6e 702e 6c6f 6731  gP'] >= -np.log1
-0000d570: 3028 7076 616c 5f74 6829 290a 2020 2020  0(pval_th)).    
-0000d580: 2020 2020 2020 2020 2020 2020 7631 203d              v1 =
-0000d590: 2064 665f 7375 6d2e 6c6f 635b 6231 2c20   df_sum.loc[b1, 
-0000d5a0: 272d 6c6f 6750 275d 0a20 2020 2020 2020  '-logP'].       
-0000d5b0: 2020 2020 2020 2020 206d 3120 3d20 6466           m1 = df
-0000d5c0: 5f73 756d 2e6c 6f63 5b62 312c 2027 2d6c  _sum.loc[b1, '-l
-0000d5d0: 6f67 5027 5d2e 6d65 616e 2829 0a20 2020  ogP'].mean().   
-0000d5e0: 2020 2020 2020 2020 2020 2020 206e 3120               n1 
-0000d5f0: 3d20 6e70 2e73 756d 2862 3129 0a0a 2020  = np.sum(b1)..  
-0000d600: 2020 2020 2020 2020 2020 2020 2020 6232                b2
-0000d610: 203d 2028 6466 5f73 756d 5b27 6365 6c6c   = (df_sum['cell
-0000d620: 5f74 7970 6528 326e 6429 275d 203d 3d20  _type(2nd)'] == 
-0000d630: 7461 7267 6574 2920 2620 5c0a 2020 2020  target) & \.    
-0000d640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d650: 2028 6466 5f73 756d 5b27 2d6c 6f67 5028   (df_sum['-logP(
-0000d660: 326e 6429 275d 203e 202d 6e70 2e6c 6f67  2nd)'] > -np.log
-0000d670: 3130 2870 7661 6c5f 7468 2929 0a20 2020  10(pval_th)).   
-0000d680: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000d690: 6e70 2e73 756d 2862 3229 203e 2030 3a0a  np.sum(b2) > 0:.
-0000d6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d6b0: 2020 2020 7632 203d 2064 665f 7375 6d2e      v2 = df_sum.
-0000d6c0: 6c6f 635b 6232 2c20 272d 6c6f 6750 2832  loc[b2, '-logP(2
-0000d6d0: 6e64 2927 5d0a 2020 2020 2020 2020 2020  nd)'].          
-0000d6e0: 2020 2020 2020 2020 2020 6d32 203d 2064            m2 = d
-0000d6f0: 665f 7375 6d2e 6c6f 635b 6232 2c20 272d  f_sum.loc[b2, '-
-0000d700: 6c6f 6750 2832 6e64 2927 5d2e 6d65 616e  logP(2nd)'].mean
-0000d710: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-0000d720: 2020 2020 2020 206e 3220 3d20 6e70 2e73         n2 = np.s
-0000d730: 756d 2862 3229 0a0a 2020 2020 2020 2020  um(b2)..        
-0000d740: 2020 2020 2020 2020 2020 2020 4e4e 203d              NN =
-0000d750: 2069 6e74 286e 312a 7461 7267 6574 5f46   int(n1*target_F
-0000d760: 5052 290a 2020 2020 2020 2020 2020 2020  PR).            
-0000d770: 2020 2020 2020 2020 7468 7265 7368 203d          thresh =
-0000d780: 2067 6574 5f74 6872 6573 686f 6c64 5f4e   get_threshold_N
-0000d790: 2876 322c 204e 4e20 3d20 4e4e 2c20 7570  (v2, NN = NN, up
-0000d7a0: 7065 7220 3d20 5472 7565 290a 2020 2020  per = True).    
-0000d7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d7c0: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-0000d7d0: 2020 2020 2020 2020 7468 5f6c 7374 203d          th_lst =
-0000d7e0: 206c 6973 7428 2835 3030 202d 206e 702e   list((500 - np.
-0000d7f0: 6172 616e 6765 2835 3030 2929 2a76 312e  arange(500))*v1.
-0000d800: 6d61 7828 292f 3530 3029 0a20 2020 2020  max()/500).     
-0000d810: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000d820: 6872 6573 6820 3d20 2d6e 702e 6c6f 6731  hresh = -np.log1
-0000d830: 3028 7076 616c 5f74 6829 0a20 2020 2020  0(pval_th).     
-0000d840: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000d850: 6f72 2074 6820 696e 2074 685f 6c73 743a  or th in th_lst:
-0000d860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d870: 2020 2020 2020 2020 207a 3120 3d20 6e70           z1 = np
-0000d880: 2e73 756d 2876 3120 3e20 7468 292f 6c65  .sum(v1 > th)/le
-0000d890: 6e28 7631 290a 2020 2020 2020 2020 2020  n(v1).          
-0000d8a0: 2020 2020 2020 2020 2020 2020 2020 7a32                z2
-0000d8b0: 203d 206e 702e 7375 6d28 7632 203e 2074   = np.sum(v2 > t
-0000d8c0: 6829 2f6c 656e 2876 3229 0a20 2020 2020  h)/len(v2).     
-0000d8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d8e0: 2020 2069 6620 7a32 2f28 7a31 2b7a 3229     if z2/(z1+z2)
-0000d8f0: 203e 2074 6172 6765 745f 4650 523a 0a20   > target_FPR:. 
-0000d900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d910: 2020 2020 2020 2020 2020 2074 6872 6573             thres
-0000d920: 6820 3d20 7468 0a20 2020 2020 2020 2020  h = th.         
-0000d930: 2020 2020 2020 2020 2020 2027 2727 0a20             '''. 
-0000d940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d950: 2020 2074 6872 6573 6820 3d20 6d61 7828     thresh = max(
-0000d960: 7468 7265 7368 2c20 2d6e 702e 6c6f 6731  thresh, -np.log1
-0000d970: 3028 7076 616c 5f74 6829 290a 2020 2020  0(pval_th)).    
-0000d980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d990: 2320 7468 5f6d 696e 203d 2067 6574 5f74  # th_min = get_t
-0000d9a0: 6872 6573 686f 6c64 2876 312c 2074 6172  hreshold(v1, tar
-0000d9b0: 6765 745f 4650 5220 3d20 302e 312c 2075  get_FPR = 0.1, u
-0000d9c0: 7070 6572 203d 2046 616c 7365 290a 2020  pper = False).  
-0000d9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d9e0: 2020 2320 6966 2074 6872 6573 6820 3c20    # if thresh < 
-0000d9f0: 7468 5f6d 696e 3a20 0a20 2020 2020 2020  th_min: .       
-0000da00: 2020 2020 2020 2020 2020 2020 2023 2020               #  
-0000da10: 2020 2074 6872 6573 6820 3d20 7468 5f6d     thresh = th_m
-0000da20: 696e 0a20 2020 2020 2020 2020 2020 2020  in.             
-0000da30: 2020 2020 2020 2069 6620 7468 7265 7368         if thresh
-0000da40: 203e 206d 313a 2074 6872 6573 6820 3d20   > m1: thresh = 
-0000da50: 6d31 0a20 2020 2020 2020 2020 2020 2020  m1.             
-0000da60: 2020 2020 2020 2065 6c69 6620 2874 6872         elif (thr
-0000da70: 6573 6820 3c20 6d32 2920 2620 286d 3120  esh < m2) & (m1 
-0000da80: 3e20 6d32 293a 2074 6872 6573 6820 3d20  > m2): thresh = 
-0000da90: 6d32 0a20 2020 2020 2020 2020 2020 2020  m2.             
-0000daa0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0000dab0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000dac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dad0: 2020 6966 206c 656e 2876 3129 203e 2031    if len(v1) > 1
-0000dae0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000daf0: 2020 2020 2020 2020 2020 7468 7265 7368            thresh
-0000db00: 203d 2067 6574 5f74 6872 6573 686f 6c64   = get_threshold
-0000db10: 2876 312c 2074 6172 6765 745f 4650 5220  (v1, target_FPR 
-0000db20: 3d20 302e 312c 2075 7070 6572 203d 2046  = 0.1, upper = F
-0000db30: 616c 7365 290a 2020 2020 2020 2020 2020  alse).          
-0000db40: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000db50: 2074 6872 6573 6820 3e20 6d31 3a20 7468   thresh > m1: th
-0000db60: 7265 7368 203d 206d 310a 2020 2020 2020  resh = m1.      
-0000db70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000db80: 2020 7468 7265 7368 203d 206d 6178 2874    thresh = max(t
-0000db90: 6872 6573 682c 202d 6e70 2e6c 6f67 3130  hresh, -np.log10
-0000dba0: 2870 7661 6c5f 7468 2929 0a20 2020 2020  (pval_th)).     
-0000dbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dbc0: 2020 206d 3220 3d20 302e 3031 0a20 2020     m2 = 0.01.   
-0000dbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dbe0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000dbf0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000dc00: 6872 6573 6820 3d20 300a 2020 2020 2020  hresh = 0.      
-0000dc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dc20: 2020 6d32 203d 2030 2e30 310a 0a20 2020    m2 = 0.01..   
-0000dc30: 2020 2020 2020 2020 2020 2020 2074 6872               thr
-0000dc40: 6573 686f 6c64 735b 745d 203d 2074 6872  esholds[t] = thr
-0000dc50: 6573 680a 2020 2020 2020 2020 2020 2020  esh.            
-0000dc60: 2020 2020 6d31 6d32 5f72 6174 696f 5b74      m1m2_ratio[t
-0000dc70: 5d20 3d20 6d31 2f6d 320a 0a20 2020 2020  ] = m1/m2..     
-0000dc80: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
-0000dc90: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
-0000dca0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0000dcb0: 2827 2020 2025 3136 733a 2025 352e 3366  ('   %16s: %5.3f
-0000dcc0: 2c20 2535 2e33 6620 3e20 2535 2e32 662c  , %5.3f > %5.2f,
-0000dcd0: 2025 352e 3266 203e 2025 692f 2569 2720   %5.2f > %i/%i' 
-0000dce0: 2520 5c0a 2020 2020 2020 2020 2020 2020  % \.            
-0000dcf0: 2020 2020 2020 2020 2020 2874 2c20 6d31            (t, m1
-0000dd00: 2c20 6d32 2c20 7468 7265 7368 2c20 6d31  , m2, thresh, m1
-0000dd10: 2f6d 322c 206e 702e 7375 6d28 7631 203e  /m2, np.sum(v1 >
-0000dd20: 3d20 7468 7265 7368 292c 206c 656e 2876  = thresh), len(v
-0000dd30: 3129 2029 2029 0a20 2020 2020 2020 2020  1) ) ).         
-0000dd40: 2020 200a 2020 2020 7265 7475 726e 2074     .    return t
-0000dd50: 6872 6573 686f 6c64 732c 206d 316d 325f  hresholds, m1m2_
-0000dd60: 7261 7469 6f0a 2327 2727 0a0a 6465 6620  ratio.#'''..def 
-0000dd70: 6765 745f 7374 6174 2864 665f 7363 6f72  get_stat(df_scor
-0000dd80: 6529 3a0a 0a20 2020 2064 6620 3d20 6466  e):..    df = df
-0000dd90: 5f73 636f 7265 0a20 2020 206d 6178 7620  _score.    maxv 
-0000dda0: 3d20 6c69 7374 2864 662e 6d61 7828 6178  = list(df.max(ax
-0000ddb0: 6973 203d 2031 2929 0a20 2020 2073 7562  is = 1)).    sub
-0000ddc0: 7479 7065 203d 206c 6973 7428 6466 2e69  type = list(df.i
-0000ddd0: 6478 6d61 7828 6178 6973 203d 2031 2929  dxmax(axis = 1))
-0000dde0: 0a20 2020 2023 7463 5f73 7562 7479 7065  .    #tc_subtype
-0000ddf0: 203d 205b 7472 616e 735f 6469 6374 5b6b   = [trans_dict[k
-0000de00: 5d20 666f 7220 6b20 696e 2074 635f 7375  ] for k in tc_su
-0000de10: 6274 7970 655d 0a0a 2020 2020 6d61 7876  btype]..    maxv
-0000de20: 3220 3d20 5b5d 0a20 2020 2069 6478 3220  2 = [].    idx2 
-0000de30: 3d20 5b5d 0a20 2020 2073 7562 7479 7065  = [].    subtype
-0000de40: 5f6c 7374 203d 206c 6973 7428 6466 2e63  _lst = list(df.c
-0000de50: 6f6c 756d 6e73 2e76 616c 7565 7329 0a0a  olumns.values)..
-0000de60: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-0000de70: 6765 2864 662e 7368 6170 655b 305d 293a  ge(df.shape[0]):
-0000de80: 0a20 2020 2020 2020 2078 203d 206e 702e  .        x = np.
-0000de90: 6172 7261 7928 6466 2e69 6c6f 635b 695d  array(df.iloc[i]
-0000dea0: 290a 2020 2020 2020 2020 6f64 7220 3d20  ).        odr = 
-0000deb0: 282d 7829 2e61 7267 736f 7274 2829 0a20  (-x).argsort(). 
-0000dec0: 2020 2020 2020 2069 6620 6c65 6e28 7829         if len(x)
-0000ded0: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
-0000dee0: 2020 6d61 7876 322e 6170 7065 6e64 2878    maxv2.append(x
-0000def0: 5b6f 6472 5b31 5d5d 290a 2020 2020 2020  [odr[1]]).      
-0000df00: 2020 2020 2020 6964 7832 2e61 7070 656e        idx2.appen
-0000df10: 6428 7375 6274 7970 655f 6c73 745b 6f64  d(subtype_lst[od
-0000df20: 725b 315d 5d29 0a20 2020 2020 2020 2065  r[1]]).        e
-0000df30: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000df40: 206d 6178 7632 2e61 7070 656e 6428 3029   maxv2.append(0)
-0000df50: 0a20 2020 2020 2020 2020 2020 2069 6478  .            idx
-0000df60: 322e 6170 7065 6e64 284e 6f6e 6529 0a0a  2.append(None)..
-0000df70: 2020 2020 2320 6466 5f72 6573 203d 2070      # df_res = p
-0000df80: 642e 4461 7461 4672 616d 6528 7b27 4344  d.DataFrame({'CD
-0000df90: 342b 2054 2063 656c 6c20 7375 6274 7970  4+ T cell subtyp
-0000dfa0: 6527 3a20 7463 5f73 7562 7479 7065 2c20  e': tc_subtype, 
-0000dfb0: 274e 6567 4c6f 6750 7661 6c27 3a20 6e65  'NegLogPval': ne
-0000dfc0: 675f 6c6f 675f 7076 616c 7d2c 2069 6e64  g_log_pval}, ind
-0000dfd0: 6578 203d 2064 662e 696e 6465 782e 7661  ex = df.index.va
-0000dfe0: 6c75 6573 290a 2020 2020 6466 5f72 6573  lues).    df_res
-0000dff0: 203d 2070 642e 4461 7461 4672 616d 6528   = pd.DataFrame(
-0000e000: 7b27 6365 6c6c 5f74 7970 6527 3a20 7375  {'cell_type': su
-0000e010: 6274 7970 652c 2027 6365 6c6c 5f74 7970  btype, 'cell_typ
-0000e020: 6528 7265 7629 273a 2073 7562 7479 7065  e(rev)': subtype
-0000e030: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-0000e040: 2020 2020 2020 2020 2020 2020 2020 2763                'c
-0000e050: 656c 6c5f 7479 7065 2831 7374 2927 3a20  ell_type(1st)': 
-0000e060: 7375 6274 7970 652c 2027 6365 6c6c 5f74  subtype, 'cell_t
-0000e070: 7970 6528 326e 6429 273a 2069 6478 322c  ype(2nd)': idx2,
-0000e080: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-0000e090: 2020 2020 2020 2020 2020 2020 2027 436c               'Cl
-0000e0a0: 6172 6974 7927 3a20 5b27 2d27 5d2a 6466  arity': ['-']*df
-0000e0b0: 2e73 6861 7065 5b30 5d2c 2027 5363 6f72  .shape[0], 'Scor
-0000e0c0: 6527 3a20 6d61 7876 2c20 2753 636f 7265  e': maxv, 'Score
-0000e0d0: 2832 6e64 2927 3a20 6d61 7876 327d 2c20  (2nd)': maxv2}, 
-0000e0e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e0f0: 2020 2020 2020 2020 2020 2069 6e64 6578             index
-0000e100: 203d 2064 662e 696e 6465 782e 7661 6c75   = df.index.valu
-0000e110: 6573 290a 2020 2020 6466 5f72 6573 5b27  es).    df_res['
-0000e120: 6453 636f 7265 275d 203d 2064 665f 7265  dScore'] = df_re
-0000e130: 735b 2753 636f 7265 275d 202d 2064 665f  s['Score'] - df_
-0000e140: 7265 735b 2753 636f 7265 2832 6e64 2927  res['Score(2nd)'
-0000e150: 5d0a 2020 2020 0a20 2020 2072 6574 7572  ].    .    retur
-0000e160: 6e20 6466 5f72 6573 0a0a 0a64 6566 2067  n df_res...def g
-0000e170: 6574 5f74 6872 6573 686f 6c64 5f66 726f  et_threshold_fro
-0000e180: 6d5f 474d 4d5f 7265 7375 6c74 2864 665f  m_GMM_result(df_
-0000e190: 7375 6d2c 2074 6172 6765 745f 4650 5220  sum, target_FPR 
-0000e1a0: 3d20 302e 3035 2c20 0a20 2020 2020 2020  = 0.05, .       
-0000e1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e1c0: 2020 2020 2020 2020 2020 2020 7665 7262              verb
-0000e1d0: 6f73 6520 3d20 4661 6c73 652c 2070 6c6f  ose = False, plo
-0000e1e0: 745f 6869 7374 203d 2046 616c 7365 293a  t_hist = False):
-0000e1f0: 0a20 2020 200a 2020 2020 7461 7267 6574  .    .    target
-0000e200: 5f74 7970 6573 203d 206c 6973 7428 6466  _types = list(df
-0000e210: 5f73 756d 5b27 6365 6c6c 5f74 7970 6528  _sum['cell_type(
-0000e220: 3173 7429 275d 2e75 6e69 7175 6528 2929  1st)'].unique())
-0000e230: 0a20 2020 2074 6872 6573 686f 6c64 7320  .    thresholds 
-0000e240: 3d20 7b7d 0a20 2020 206d 316d 325f 7261  = {}.    m1m2_ra
-0000e250: 7469 6f20 3d20 7b7d 0a20 2020 200a 2020  tio = {}.    .  
-0000e260: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-0000e270: 2020 2020 2020 7072 696e 7428 2754 6872        print('Thr
-0000e280: 6573 686f 6c64 733a 2729 0a20 2020 2020  esholds:').     
-0000e290: 2020 200a 2020 2020 666f 7220 7420 696e     .    for t in
-0000e2a0: 2074 6172 6765 745f 7479 7065 733a 0a20   target_types:. 
-0000e2b0: 2020 2020 2020 2074 6172 6765 7420 3d20         target = 
-0000e2c0: 740a 0a20 2020 2020 2020 2062 3120 3d20  t..        b1 = 
-0000e2d0: 2864 665f 7375 6d5b 2763 656c 6c5f 7479  (df_sum['cell_ty
-0000e2e0: 7065 2872 6576 2927 5d20 3d3d 2074 6172  pe(rev)'] == tar
-0000e2f0: 6765 7429 2023 2620 2864 665f 7375 6d5b  get) #& (df_sum[
-0000e300: 272d 6c6f 6750 275d 203e 202d 6e70 2e6c  '-logP'] > -np.l
-0000e310: 6f67 3130 2870 7661 6c5f 7468 2929 0a20  og10(pval_th)). 
-0000e320: 2020 2020 2020 2076 3120 3d20 6466 5f73         v1 = df_s
-0000e330: 756d 2e6c 6f63 5b62 312c 2027 5363 6f72  um.loc[b1, 'Scor
-0000e340: 6527 5d0a 2020 2020 2020 2020 6d31 203d  e'].        m1 =
-0000e350: 2064 665f 7375 6d2e 6c6f 635b 6231 2c20   df_sum.loc[b1, 
-0000e360: 2753 636f 7265 275d 2e6d 6178 2829 2023  'Score'].max() #
-0000e370: 2e6d 6561 6e28 290a 2020 2020 2020 2020  .mean().        
-0000e380: 6e31 203d 206e 702e 7375 6d28 6231 290a  n1 = np.sum(b1).
-0000e390: 0a20 2020 2020 2020 2023 2323 2323 2323  .        #######
-0000e3a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e3b0: 2323 2323 2323 230a 2020 2020 2020 2020  #######.        
-0000e3c0: 6232 203d 2028 6466 5f73 756d 5b27 6365  b2 = (df_sum['ce
-0000e3d0: 6c6c 5f74 7970 6528 326e 6429 275d 203d  ll_type(2nd)'] =
-0000e3e0: 3d20 7461 7267 6574 2920 2620 5c0a 2020  = target) & \.  
-0000e3f0: 2020 2020 2020 2020 2020 2028 6466 5f73             (df_s
-0000e400: 756d 5b27 6365 6c6c 5f74 7970 6528 7265  um['cell_type(re
-0000e410: 7629 275d 2021 3d20 2775 6e61 7373 6967  v)'] != 'unassig
-0000e420: 6e65 6427 2920 0a20 2020 2020 2020 2069  ned') .        i
-0000e430: 6620 6e70 2e73 756d 2862 3229 203e 2030  f np.sum(b2) > 0
-0000e440: 3a0a 2020 2020 2020 2020 2020 2020 7632  :.            v2
-0000e450: 203d 2064 665f 7375 6d2e 6c6f 635b 6232   = df_sum.loc[b2
-0000e460: 2c20 2753 636f 7265 2832 6e64 2927 5d0a  , 'Score(2nd)'].
-0000e470: 2020 2020 2020 2020 2020 2020 6d32 203d              m2 =
-0000e480: 2064 665f 7375 6d2e 6c6f 635b 6232 2c20   df_sum.loc[b2, 
-0000e490: 2753 636f 7265 2832 6e64 2927 5d2e 6d61  'Score(2nd)'].ma
-0000e4a0: 7828 2920 232e 6d65 616e 2829 0a20 2020  x() #.mean().   
-0000e4b0: 2020 2020 2020 2020 206e 3220 3d20 6e70           n2 = np
-0000e4c0: 2e73 756d 2862 3229 0a0a 2020 2020 2020  .sum(b2)..      
-0000e4d0: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
-0000e4e0: 2020 2020 2020 6e78 203d 2069 6e74 286e        nx = int(n
-0000e4f0: 312a 7461 7267 6574 5f46 5052 290a 2020  1*target_FPR).  
-0000e500: 2020 2020 2020 2020 2020 6f64 7220 3d20            odr = 
-0000e510: 6e70 2e61 7272 6179 2876 3229 2e61 7267  np.array(v2).arg
-0000e520: 736f 7274 2829 0a20 2020 2020 2020 2020  sort().         
-0000e530: 2020 2069 6620 6e78 203d 3d20 303a 206e     if nx == 0: n
-0000e540: 7820 3d20 310a 2020 2020 2020 2020 2020  x = 1.          
-0000e550: 2020 656c 6966 206e 7820 3e3d 206c 656e    elif nx >= len
-0000e560: 2876 3229 3a20 6e78 203d 2030 0a20 2020  (v2): nx = 0.   
-0000e570: 2020 2020 2020 2020 2074 6872 6573 6820           thresh 
-0000e580: 3d20 7632 5b6f 6472 5b2d 6e78 5d5d 200a  = v2[odr[-nx]] .
-0000e590: 2020 2020 2020 2020 2020 2020 2327 2727              #'''
-0000e5a0: 0a20 2020 2020 2020 2020 2020 204e 4e20  .            NN 
-0000e5b0: 3d20 696e 7428 6e31 2a74 6172 6765 745f  = int(n1*target_
-0000e5c0: 4650 5229 0a20 2020 2020 2020 2020 2020  FPR).           
-0000e5d0: 2074 6872 6573 6820 3d20 6765 745f 7468   thresh = get_th
-0000e5e0: 7265 7368 6f6c 645f 4e28 7632 2c20 4e4e  reshold_N(v2, NN
-0000e5f0: 203d 204e 4e2c 2075 7070 6572 203d 2054   = NN, upper = T
-0000e600: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
-0000e610: 2023 7468 7265 7368 203d 206e 702e 6d61   #thresh = np.ma
-0000e620: 7828 7632 290a 2020 2020 2020 2020 2020  x(v2).          
-0000e630: 2020 2320 6765 745f 7468 7265 7368 6f6c    # get_threshol
-0000e640: 6428 7632 2c20 7461 7267 6574 5f46 5052  d(v2, target_FPR
-0000e650: 203d 2074 6172 6765 745f 4650 522c 2075   = target_FPR, u
-0000e660: 7070 6572 203d 2054 7275 6529 0a20 2020  pper = True).   
-0000e670: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000e680: 2020 2020 2020 206d 3220 3d20 6466 5f73         m2 = df_s
-0000e690: 756d 2e6c 6f63 5b62 312c 2027 5363 6f72  um.loc[b1, 'Scor
-0000e6a0: 6527 5d2e 6d65 616e 2829 0a20 2020 2020  e'].mean().     
-0000e6b0: 2020 2020 2020 2076 3220 3d20 6466 5f73         v2 = df_s
-0000e6c0: 756d 2e6c 6f63 5b62 312c 2027 5363 6f72  um.loc[b1, 'Scor
-0000e6d0: 6527 5d0a 2020 2020 2020 2020 2020 2020  e'].            
-0000e6e0: 7468 7265 7368 203d 206d 3220 2367 6574  thresh = m2 #get
-0000e6f0: 5f74 6872 6573 686f 6c64 2876 312c 2074  _threshold(v1, t
-0000e700: 6172 6765 745f 4650 5220 3d20 7461 7267  arget_FPR = targ
-0000e710: 6574 5f46 5052 2c20 7570 7065 7220 3d20  et_FPR, upper = 
-0000e720: 4661 6c73 6529 0a20 2020 2020 2020 2020  False).         
-0000e730: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
-0000e740: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000e750: 7269 6e74 2827 5741 524e 494e 473a 2074  rint('WARNING: t
-0000e760: 6872 6573 686f 6c64 7320 666f 7220 2573  hresholds for %s
-0000e770: 2077 6173 2073 6574 2074 6f20 2536 2e32   was set to %6.2
-0000e780: 6620 2d20 3130 203d 2025 362e 3266 2720  f - 10 = %6.2f' 
-0000e790: 2520 2874 2c20 6d31 2c20 7468 7265 7368  % (t, m1, thresh
-0000e7a0: 2929 0a0a 2020 2020 2020 2020 7468 7265  ))..        thre
-0000e7b0: 7368 6f6c 6473 5b74 5d20 3d20 7468 7265  sholds[t] = thre
-0000e7c0: 7368 0a20 2020 2020 2020 206d 316d 325f  sh.        m1m2_
-0000e7d0: 7261 7469 6f5b 745d 203d 206d 312d 6d32  ratio[t] = m1-m2
-0000e7e0: 0a0a 2020 2020 2020 2020 6966 2076 6572  ..        if ver
-0000e7f0: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
-0000e800: 2020 7072 696e 7428 2720 2020 2531 3673    print('   %16s
-0000e810: 3a20 2536 2e32 662c 2025 362e 3266 203e  : %6.2f, %6.2f >
-0000e820: 2054 6872 6573 686f 6c64 3a20 2536 2e32   Threshold: %6.2
-0000e830: 6620 3e20 2569 2f25 692c 2020 2569 2f25  f > %i/%i,  %i/%
-0000e840: 6927 2025 205c 0a20 2020 2020 2020 2020  i' % \.         
-0000e850: 2020 2020 2028 742c 206d 312c 206d 322c       (t, m1, m2,
-0000e860: 2074 6872 6573 682c 206e 702e 7375 6d28   thresh, np.sum(
-0000e870: 7631 203e 3d20 7468 7265 7368 292c 206c  v1 >= thresh), l
-0000e880: 656e 2876 3129 2c20 6e70 2e73 756d 2876  en(v1), np.sum(v
-0000e890: 3220 3e3d 2074 6872 6573 6829 2c20 6c65  2 >= thresh), le
-0000e8a0: 6e28 7632 2929 290a 2020 2020 2020 2020  n(v2))).        
-0000e8b0: 2020 2020 0a20 2020 2072 6574 7572 6e20      .    return 
-0000e8c0: 7468 7265 7368 6f6c 6473 2c20 6d31 6d32  thresholds, m1m2
-0000e8d0: 5f72 6174 696f 0a0a 0a64 6566 2067 6574  _ratio...def get
-0000e8e0: 5f6d 616a 6f72 6974 6965 7328 792c 2079  _majorities(y, y
-0000e8f0: 5f63 6c75 7374 293a 0a20 2020 200a 2020  _clust):.    .  
-0000e900: 2020 6c61 6265 6c73 5f75 6e69 7175 652c    labels_unique,
-0000e910: 2063 6f75 6e74 7320 3d20 6e70 2e75 6e69   counts = np.uni
-0000e920: 7175 6528 795f 636c 7573 742c 2072 6574  que(y_clust, ret
-0000e930: 7572 6e5f 636f 756e 7473 3d54 7275 6529  urn_counts=True)
-0000e940: 0a20 2020 200a 2020 2020 6d61 6a5f 6c73  .    .    maj_ls
-0000e950: 7420 3d20 5b5d 0a20 2020 2063 6e74 5f6c  t = [].    cnt_l
-0000e960: 7374 203d 205b 5d0a 2020 2020 666f 7220  st = [].    for 
-0000e970: 6320 696e 206c 6973 7428 6c61 6265 6c73  c in list(labels
-0000e980: 5f75 6e69 7175 6529 3a0a 2020 2020 2020  _unique):.      
-0000e990: 2020 6220 3d20 6e70 2e61 7272 6179 2879    b = np.array(y
-0000e9a0: 5f63 6c75 7374 2920 3d3d 2063 0a20 2020  _clust) == c.   
-0000e9b0: 2020 2020 2063 7473 2c20 636e 7473 203d       cts, cnts =
-0000e9c0: 206e 702e 756e 6971 7565 2879 5b62 5d2c   np.unique(y[b],
-0000e9d0: 2072 6574 7572 6e5f 636f 756e 7473 3d54   return_counts=T
-0000e9e0: 7275 6529 0a20 2020 2020 2020 206f 6472  rue).        odr
-0000e9f0: 203d 2063 6e74 732e 6172 6773 6f72 7428   = cnts.argsort(
-0000ea00: 290a 2020 2020 2020 2020 6d61 6a6f 7269  ).        majori
-0000ea10: 7479 203d 2063 7473 5b6f 6472 5b2d 315d  ty = cts[odr[-1]
-0000ea20: 5d0a 2020 2020 2020 2020 6d61 6a5f 6c73  ].        maj_ls
-0000ea30: 742e 6170 7065 6e64 286d 616a 6f72 6974  t.append(majorit
-0000ea40: 7929 0a20 2020 2020 2020 2063 6e74 5f6c  y).        cnt_l
-0000ea50: 7374 2e61 7070 656e 6428 636e 7473 5b6f  st.append(cnts[o
-0000ea60: 6472 5b2d 315d 5d29 0a20 2020 2020 2020  dr[-1]]).       
-0000ea70: 200a 2020 2020 6d61 6a5f 6469 6374 203d   .    maj_dict =
-0000ea80: 2064 6963 7428 7a69 7028 6c61 6265 6c73   dict(zip(labels
-0000ea90: 5f75 6e69 7175 652c 206d 616a 5f6c 7374  _unique, maj_lst
-0000eaa0: 2929 0a20 2020 2063 6e74 5f64 6963 7420  )).    cnt_dict 
-0000eab0: 3d20 6469 6374 287a 6970 286c 6162 656c  = dict(zip(label
-0000eac0: 735f 756e 6971 7565 2c20 636e 745f 6c73  s_unique, cnt_ls
-0000ead0: 7429 290a 2020 2020 0a20 2020 2072 6574  t)).    .    ret
-0000eae0: 7572 6e20 6d61 6a5f 6469 6374 2c20 636e  urn maj_dict, cn
-0000eaf0: 745f 6469 6374 0a0a 0a64 6566 2063 6c75  t_dict...def clu
-0000eb00: 7374 6572 5f62 6173 6973 5f63 6f72 7265  ster_basis_corre
-0000eb10: 6374 696f 6e28 585f 7063 612c 2079 2c20  ction(X_pca, y, 
-0000eb20: 636f 626a 2c20 795f 636c 7573 742c 2070  cobj, y_clust, p
-0000eb30: 6d61 6a20 3d20 302e 372c 200a 2020 2020  maj = 0.7, .    
-0000eb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb50: 2020 2020 2020 2020 2063 7574 6f66 6620           cutoff 
-0000eb60: 3d20 302e 3031 2c20 7665 7262 6f73 6520  = 0.01, verbose 
-0000eb70: 3d20 4661 6c73 6520 293a 0a20 2020 200a  = False ):.    .
-0000eb80: 2020 2020 7973 203d 2070 642e 5365 7269      ys = pd.Seri
-0000eb90: 6573 2879 292e 636f 7079 2864 6565 7020  es(y).copy(deep 
-0000eba0: 3d20 5472 7565 290a 2020 2020 0a20 2020  = True).    .   
-0000ebb0: 2061 646a 5f61 6767 203d 2063 6f62 6a2e   adj_agg = cobj.
-0000ebc0: 6167 6772 6567 6174 655f 0a20 2020 2061  aggregate_.    a
-0000ebd0: 646a 5f61 6767 5f6d 6174 203d 2061 646a  dj_agg_mat = adj
-0000ebe0: 5f61 6767 2e74 6f64 656e 7365 2829 2e61  _agg.todense().a
-0000ebf0: 7374 7970 6528 696e 7429 200a 2020 2020  stype(int) .    
-0000ec00: 6c61 6265 6c73 5f75 6e69 7175 652c 2063  labels_unique, c
-0000ec10: 6f75 6e74 7320 3d20 6e70 2e75 6e69 7175  ounts = np.uniqu
-0000ec20: 6528 795f 636c 7573 742c 2072 6574 7572  e(y_clust, retur
-0000ec30: 6e5f 636f 756e 7473 3d54 7275 6529 0a0a  n_counts=True)..
-0000ec40: 2020 2020 2323 2047 6574 206e 6569 6768      ## Get neigh
-0000ec50: 626f 7220 636c 7573 7465 7273 0a20 2020  bor clusters.   
-0000ec60: 2023 2063 7574 6f66 6620 3d20 302e 3031   # cutoff = 0.01
-0000ec70: 0a20 2020 2061 6a20 3d20 7b7d 0a20 2020  .    aj = {}.   
-0000ec80: 2066 6f72 206a 2069 6e20 7261 6e67 6528   for j in range(
-0000ec90: 6c65 6e28 6c61 6265 6c73 5f75 6e69 7175  len(labels_uniqu
-0000eca0: 6529 293a 0a20 2020 2020 2020 2061 203d  e)):.        a =
-0000ecb0: 205b 5d0a 2020 2020 2020 2020 6220 3d20   [].        b = 
-0000ecc0: 5b5d 0a20 2020 2020 2020 2066 6f72 206b  [].        for k
-0000ecd0: 2069 6e20 7261 6e67 6528 6c65 6e28 6c61   in range(len(la
-0000ece0: 6265 6c73 5f75 6e69 7175 6529 293a 0a20  bels_unique)):. 
-0000ecf0: 2020 2020 2020 2020 2020 2069 6620 2861             if (a
-0000ed00: 646a 5f61 6767 5f6d 6174 5b6a 2c6b 5d20  dj_agg_mat[j,k] 
-0000ed10: 3e3d 2061 646a 5f61 6767 5f6d 6174 5b6a  >= adj_agg_mat[j
-0000ed20: 2c6a 5d2a 6375 746f 6666 2920 2620 2861  ,j]*cutoff) & (a
-0000ed30: 646a 5f61 6767 5f6d 6174 5b6a 2c6b 5d20  dj_agg_mat[j,k] 
-0000ed40: 3e3d 2061 646a 5f61 6767 5f6d 6174 5b6b  >= adj_agg_mat[k
-0000ed50: 2c6b 5d2a 6375 746f 6666 293a 0a20 2020  ,k]*cutoff):.   
-0000ed60: 2020 2020 2020 2020 2020 2020 2061 2e61               a.a
-0000ed70: 7070 656e 6428 6b29 0a20 2020 2020 2020  ppend(k).       
-0000ed80: 2020 2020 2020 2020 2062 2e61 7070 656e           b.appen
-0000ed90: 6428 6164 6a5f 6167 675f 6d61 745b 6a2c  d(adj_agg_mat[j,
-0000eda0: 6b5d 290a 2020 2020 2020 2020 6966 206c  k]).        if l
-0000edb0: 656e 2861 2920 3e20 303a 0a20 2020 2020  en(a) > 0:.     
-0000edc0: 2020 2020 2020 206f 6472 203d 2028 2d6e         odr = (-n
-0000edd0: 702e 6172 7261 7928 6229 292e 6172 6773  p.array(b)).args
-0000ede0: 6f72 7428 290a 2020 2020 2020 2020 2020  ort().          
-0000edf0: 2020 6131 203d 205b 5d0a 2020 2020 2020    a1 = [].      
-0000ee00: 2020 2020 2020 6231 203d 205b 5d0a 2020        b1 = [].  
-0000ee10: 2020 2020 2020 2020 2020 626e 203d 205b            bn = [
-0000ee20: 5d0a 2020 2020 2020 2020 2020 2020 666f  ].            fo
-0000ee30: 7220 6f20 696e 206f 6472 3a0a 2020 2020  r o in odr:.    
-0000ee40: 2020 2020 2020 2020 2020 2020 6131 2e61              a1.a
-0000ee50: 7070 656e 6428 615b 6f5d 290a 2020 2020  ppend(a[o]).    
-0000ee60: 2020 2020 2020 2020 2020 2020 6231 2e61              b1.a
-0000ee70: 7070 656e 6428 625b 6f5d 290a 2020 2020  ppend(b[o]).    
-0000ee80: 2020 2020 2020 2020 2020 2020 6e76 203d              nv =
-0000ee90: 2069 6e74 2831 302a 6e70 2e6c 6f67 3130   int(10*np.log10
-0000eea0: 2862 5b6f 5d2f 6164 6a5f 6167 675f 6d61  (b[o]/adj_agg_ma
-0000eeb0: 745b 6a2c 6a5d 202b 2031 652d 3130 2929  t[j,j] + 1e-10))
-0000eec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000eed0: 2062 6e2e 6170 7065 6e64 286e 7629 0a20   bn.append(nv). 
-0000eee0: 2020 2020 2020 2020 2020 2064 203d 2064             d = d
-0000eef0: 6963 7428 7a69 7028 6131 2c62 6e29 290a  ict(zip(a1,bn)).
-0000ef00: 2020 2020 2020 2020 2020 2020 626e 2e73              bn.s
-0000ef10: 6f72 7428 7265 7665 7273 6520 3d20 5472  ort(reverse = Tr
-0000ef20: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-0000ef30: 616a 5b6a 5d20 3d20 640a 0a20 2020 2023  aj[j] = d..    #
-0000ef40: 2320 4765 7420 636f 6d6d 756e 6974 7920  # Get community 
-0000ef50: 6c69 7374 0a20 2020 2063 6f6d 6d75 6e69  list.    communi
-0000ef60: 7469 6573 203d 205b 5d0a 2020 2020 666f  ties = [].    fo
-0000ef70: 7220 6b65 7920 696e 2061 6a2e 6b65 7973  r key in aj.keys
-0000ef80: 2829 3a0a 2020 2020 2020 2020 6420 3d20  ():.        d = 
-0000ef90: 616a 5b6b 6579 5d0a 2020 2020 2020 2020  aj[key].        
-0000efa0: 6e6f 6465 7320 3d20 6c69 7374 2864 2e6b  nodes = list(d.k
-0000efb0: 6579 7328 2929 0a20 2020 2020 2020 2069  eys()).        i
-0000efc0: 6620 6c65 6e28 6e6f 6465 7329 203e 2031  f len(nodes) > 1
-0000efd0: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
-0000efe0: 6d6d 6f6e 203d 206e 6f64 6573 0a20 2020  mmon = nodes.   
-0000eff0: 2020 2020 2020 2020 2066 6f72 206e 2069           for n i
-0000f000: 6e20 6e6f 6465 733a 0a20 2020 2020 2020  n nodes:.       
-0000f010: 2020 2020 2020 2020 2063 6f6d 6d6f 6e20           common 
-0000f020: 3d20 6c69 7374 2873 6574 2863 6f6d 6d6f  = list(set(commo
-0000f030: 6e29 2e69 6e74 6572 7365 6374 696f 6e28  n).intersection(
-0000f040: 6c69 7374 2861 6a5b 6e5d 2e6b 6579 7328  list(aj[n].keys(
-0000f050: 2929 2929 0a20 2020 2020 2020 2020 2020  )))).           
-0000f060: 2069 6620 6c65 6e28 636f 6d6d 6f6e 2920   if len(common) 
-0000f070: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
-0000f080: 2020 2020 2063 6f6d 6d75 6e69 7469 6573       communities
-0000f090: 2e61 7070 656e 6428 636f 6d6d 6f6e 290a  .append(common).
-0000f0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f0b0: 2320 7072 696e 7428 6b65 792c 2027 3a20  # print(key, ': 
-0000f0c0: 272c 2063 6f6d 6d6f 6e29 0a0a 2020 2020  ', common)..    
-0000f0d0: 746f 5f64 656c 203d 205b 5d0a 2020 2020  to_del = [].    
-0000f0e0: 666f 7220 6b2c 2063 2069 6e20 656e 756d  for k, c in enum
-0000f0f0: 6572 6174 6528 636f 6d6d 756e 6974 6965  erate(communitie
-0000f100: 7329 3a0a 2020 2020 2020 2020 6220 3d20  s):.        b = 
-0000f110: 4661 6c73 650a 2020 2020 2020 2020 666f  False.        fo
-0000f120: 7220 6b32 2c20 6332 2069 6e20 656e 756d  r k2, c2 in enum
-0000f130: 6572 6174 6528 636f 6d6d 756e 6974 6965  erate(communitie
-0000f140: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-0000f150: 6966 2028 6b32 2021 3d20 6b29 2026 2028  if (k2 != k) & (
-0000f160: 6b20 6e6f 7420 696e 2074 6f5f 6465 6c29  k not in to_del)
-0000f170: 2026 2028 6b32 206e 6f74 2069 6e20 746f   & (k2 not in to
-0000f180: 5f64 656c 293a 0a20 2020 2020 2020 2020  _del):.         
-0000f190: 2020 2020 2020 2069 6620 286c 656e 286c         if (len(l
-0000f1a0: 6973 7428 7365 7428 6329 202d 2073 6574  ist(set(c) - set
-0000f1b0: 2863 3229 2929 203d 3d20 3029 3a0a 2020  (c2))) == 0):.  
-0000f1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f1d0: 2020 746f 5f64 656c 2e61 7070 656e 6428    to_del.append(
-0000f1e0: 6b29 0a0a 2020 2020 666f 7220 6b20 696e  k)..    for k in
-0000f1f0: 2072 6576 6572 7365 6428 746f 5f64 656c   reversed(to_del
-0000f200: 293a 0a20 2020 2020 2020 2064 656c 2063  ):.        del c
-0000f210: 6f6d 6d75 6e69 7469 6573 5b6b 5d0a 2020  ommunities[k].  
-0000f220: 2020 0a20 2020 2063 6c75 7374 5f6d 616a    .    clust_maj
-0000f230: 5f64 6963 742c 2063 6c75 7374 5f63 6e74  _dict, clust_cnt
-0000f240: 5f64 6963 7420 3d20 6765 745f 6d61 6a6f  _dict = get_majo
-0000f250: 7269 7469 6573 2879 2c20 795f 636c 7573  rities(y, y_clus
-0000f260: 7429 0a20 2020 200a 2020 2020 666f 7220  t).    .    for 
-0000f270: 6b2c 2063 6f6d 6d75 6e69 7479 2069 6e20  k, community in 
-0000f280: 656e 756d 6572 6174 6528 636f 6d6d 756e  enumerate(commun
-0000f290: 6974 6965 7329 3a0a 2020 2020 2020 2020  ities):.        
-0000f2a0: 6966 2028 6c65 6e28 636f 6d6d 756e 6974  if (len(communit
-0000f2b0: 7929 203e 2031 293a 0a20 2020 2020 2020  y) > 1):.       
-0000f2c0: 2020 2020 2023 2320 6368 6563 6b20 6966       ## check if
-0000f2d0: 2027 756e 6173 7369 676e 6564 2720 636c   'unassigned' cl
-0000f2e0: 7573 7465 720a 2020 2020 2020 2020 2020  uster.          
-0000f2f0: 2020 6374 5f63 6e74 5f64 6963 7420 3d20    ct_cnt_dict = 
-0000f300: 7b7d 0a20 2020 2020 2020 2020 2020 2066  {}.            f
-0000f310: 6f72 2063 6d20 696e 2063 6f6d 6d75 6e69  or cm in communi
-0000f320: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
-0000f330: 2020 2020 6966 2063 6c75 7374 5f6d 616a      if clust_maj
-0000f340: 5f64 6963 745b 636d 5d20 696e 206c 6973  _dict[cm] in lis
-0000f350: 7428 6374 5f63 6e74 5f64 6963 742e 6b65  t(ct_cnt_dict.ke
-0000f360: 7973 2829 293a 0a20 2020 2020 2020 2020  ys()):.         
-0000f370: 2020 2020 2020 2020 2020 2063 745f 636e             ct_cn
-0000f380: 745f 6469 6374 5b63 6c75 7374 5f6d 616a  t_dict[clust_maj
-0000f390: 5f64 6963 745b 636d 5d5d 202b 3d20 636c  _dict[cm]] += cl
-0000f3a0: 7573 745f 636e 745f 6469 6374 5b63 6d5d  ust_cnt_dict[cm]
-0000f3b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f3c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000f3d0: 2020 2020 2020 2020 2020 2063 745f 636e             ct_cn
-0000f3e0: 745f 6469 6374 5b63 6c75 7374 5f6d 616a  t_dict[clust_maj
-0000f3f0: 5f64 6963 745b 636d 5d5d 203d 2063 6c75  _dict[cm]] = clu
-0000f400: 7374 5f63 6e74 5f64 6963 745b 636d 5d0a  st_cnt_dict[cm].
-0000f410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f420: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-0000f430: 206f 6472 203d 2028 2d6e 702e 6172 7261   odr = (-np.arra
-0000f440: 7928 6c69 7374 2863 745f 636e 745f 6469  y(list(ct_cnt_di
-0000f450: 6374 2e76 616c 7565 7328 2929 2929 2e61  ct.values()))).a
-0000f460: 7267 736f 7274 2829 0a20 2020 2020 2020  rgsort().       
-0000f470: 2020 2020 2063 745f 636e 745f 6469 6374       ct_cnt_dict
-0000f480: 5f6e 6577 203d 207b 7d0a 2020 2020 2020  _new = {}.      
-0000f490: 2020 2020 2020 6b65 7973 203d 206c 6973        keys = lis
-0000f4a0: 7428 6374 5f63 6e74 5f64 6963 742e 6b65  t(ct_cnt_dict.ke
-0000f4b0: 7973 2829 290a 2020 2020 2020 2020 2020  ys()).          
-0000f4c0: 2020 666f 7220 6f20 696e 206f 6472 3a0a    for o in odr:.
+00004a80: 5d29 2929 0a0a 2020 2020 0a64 6566 206c  ])))..    .def l
+00004a90: 6f61 645f 6d61 726b 6572 735f 616c 6c28  oad_markers_all(
+00004aa0: 6669 6c65 2c20 7461 7267 6574 5f63 656c  file, target_cel
+00004ab0: 6c73 203d 205b 5d2c 2070 6e73 6831 3220  ls = [], pnsh12 
+00004ac0: 3d20 2731 3131 3131 3127 2c20 636f 6d62  = '111111', comb
+00004ad0: 5f6d 6b72 7320 3d20 5472 7565 2c20 2076  _mkrs = True,  v
+00004ae0: 6572 626f 7365 203d 2046 616c 7365 293a  erbose = False):
+00004af0: 0a20 2020 200a 2020 2020 6966 2076 6572  .    .    if ver
+00004b00: 626f 7365 3a20 7072 696e 7428 274c 6f61  bose: print('Loa
+00004b10: 6420 6d61 726b 6572 7320 2e2e 2027 2c20  d markers .. ', 
+00004b20: 656e 6420 3d20 2727 2c20 666c 7573 6820  end = '', flush 
+00004b30: 3d20 5472 7565 290a 2020 2020 6466 203d  = True).    df =
+00004b40: 206c 6f61 645f 6d61 726b 6572 5f66 696c   load_marker_fil
+00004b50: 6528 2066 696c 6520 290a 2020 2020 0a20  e( file ).    . 
+00004b60: 2020 2069 6620 6c65 6e28 7461 7267 6574     if len(target
+00004b70: 5f63 656c 6c73 2920 3d3d 2030 3a0a 2020  _cells) == 0:.  
+00004b80: 2020 2020 2020 7461 7267 6574 5f63 656c        target_cel
+00004b90: 6c73 203d 206c 6973 7428 6466 5b27 6365  ls = list(df['ce
+00004ba0: 6c6c 5f74 7970 655f 6d61 6a6f 7227 5d2e  ll_type_major'].
+00004bb0: 756e 6971 7565 2829 290a 2020 2020 0a20  unique()).    . 
+00004bc0: 2020 206d 616a 6f72 5f74 7970 655f 6c73     major_type_ls
+00004bd0: 7420 3d20 6c69 7374 2864 665b 2763 656c  t = list(df['cel
+00004be0: 6c5f 7479 7065 5f6d 616a 6f72 275d 2e75  l_type_major'].u
+00004bf0: 6e69 7175 6528 2929 0a20 2020 200a 2020  nique()).    .  
+00004c00: 2020 6d6b 725f 6c73 7420 3d20 7b7d 0a20    mkr_lst = {}. 
+00004c10: 2020 206d 6b72 5f6c 7374 5f6e 6567 203d     mkr_lst_neg =
+00004c20: 207b 7d0a 2020 2020 6d6b 725f 6c73 745f   {}.    mkr_lst_
+00004c30: 7365 6320 3d20 7b7d 0a20 2020 206d 616a  sec = {}.    maj
+00004c40: 6f72 5f64 6963 7420 3d20 7b7d 0a20 2020  or_dict = {}.   
+00004c50: 206d 696e 6f72 5f64 6963 7420 3d20 7b7d   minor_dict = {}
+00004c60: 0a20 2020 2070 6e73 6831 325f 7420 3d20  .    pnsh12_t = 
+00004c70: 2725 7330 3025 7327 2025 2028 706e 7368  '%s00%s' % (pnsh
+00004c80: 3132 5b30 5d2c 2070 6e73 6831 325b 333a  12[0], pnsh12[3:
+00004c90: 5d29 0a20 2020 2066 6f72 2063 2069 6e20  ]).    for c in 
+00004ca0: 7461 7267 6574 5f63 656c 6c73 3a0a 2020  target_cells:.  
+00004cb0: 2020 2020 2020 6966 2063 2069 6e20 6d61        if c in ma
+00004cc0: 6a6f 725f 7479 7065 5f6c 7374 3a0a 2020  jor_type_lst:.  
+00004cd0: 2020 2020 2020 2020 2020 6220 3d20 6466            b = df
+00004ce0: 5b27 6365 6c6c 5f74 7970 655f 6d61 6a6f  ['cell_type_majo
+00004cf0: 7227 5d20 3d3d 2063 0a20 2020 2020 2020  r'] == c.       
+00004d00: 2020 2020 2063 656c 6c5f 7479 7065 5f6c       cell_type_l
+00004d10: 7374 203d 206c 6973 7428 6466 2e6c 6f63  st = list(df.loc
+00004d20: 5b62 2c20 2763 656c 6c5f 7479 7065 5f6d  [b, 'cell_type_m
+00004d30: 696e 6f72 275d 2e75 6e69 7175 6528 2929  inor'].unique())
+00004d40: 0a20 2020 2020 2020 2020 2020 206d 6b72  .            mkr
+00004d50: 7320 3d20 6765 745f 6d61 726b 6572 735f  s = get_markers_
+00004d60: 6672 6f6d 5f64 6628 6466 2c20 6365 6c6c  from_df(df, cell
+00004d70: 5f74 7970 655f 6c73 742c 2070 6e73 6831  _type_lst, pnsh1
+00004d80: 3220 3d20 706e 7368 3132 5f74 2c20 7665  2 = pnsh12_t, ve
+00004d90: 7262 6f73 6520 3d20 7665 7262 6f73 6529  rbose = verbose)
+00004da0: 0a20 2020 2020 2020 2020 2020 206d 6b72  .            mkr
+00004db0: 7320 3d20 636f 6d62 5f63 6f6d 6d6f 6e28  s = comb_common(
+00004dc0: 6d6b 7273 290a 2020 2020 2020 2020 2020  mkrs).          
+00004dd0: 2020 6d6b 725f 6c73 742e 7570 6461 7465    mkr_lst.update
+00004de0: 286d 6b72 7329 0a20 2020 2020 2020 200a  (mkrs).        .
+00004df0: 2020 2020 2020 2020 2020 2020 6966 2070              if p
+00004e00: 6e73 6831 325b 315d 203d 3d20 2731 273a  nsh12[1] == '1':
+00004e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004e20: 2070 6e73 6831 325f 6e20 3d20 2730 3130   pnsh12_n = '010
+00004e30: 2573 2720 2520 2870 6e73 6831 325b 333a  %s' % (pnsh12[3:
+00004e40: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00004e50: 2020 206d 6b72 735f 6e65 6720 3d20 6765     mkrs_neg = ge
+00004e60: 745f 6d61 726b 6572 735f 6672 6f6d 5f64  t_markers_from_d
+00004e70: 6628 6466 2c20 6365 6c6c 5f74 7970 655f  f(df, cell_type_
+00004e80: 6c73 742c 2070 6e73 6831 3220 3d20 706e  lst, pnsh12 = pn
+00004e90: 7368 3132 5f6e 2c20 7665 7262 6f73 6520  sh12_n, verbose 
+00004ea0: 3d20 7665 7262 6f73 6529 0a20 2020 2020  = verbose).     
+00004eb0: 2020 2020 2020 2020 2020 206d 6b72 735f             mkrs_
+00004ec0: 6e65 6720 3d20 636f 6d62 5f63 6f6d 6d6f  neg = comb_commo
+00004ed0: 6e28 6d6b 7273 5f6e 6567 290a 2020 2020  n(mkrs_neg).    
+00004ee0: 2020 2020 2020 2020 2020 2020 6d6b 725f              mkr_
+00004ef0: 6c73 745f 6e65 672e 7570 6461 7465 286d  lst_neg.update(m
+00004f00: 6b72 735f 6e65 6729 0a20 2020 2020 2020  krs_neg).       
+00004f10: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+00004f20: 2020 6966 2070 6e73 6831 325b 325d 203d    if pnsh12[2] =
+00004f30: 3d20 2731 273a 0a20 2020 2020 2020 2020  = '1':.         
+00004f40: 2020 2020 2020 2070 6e73 6831 325f 6e20         pnsh12_n 
+00004f50: 3d20 2730 3031 2573 2720 2520 2870 6e73  = '001%s' % (pns
+00004f60: 6831 325b 333a 5d29 0a20 2020 2020 2020  h12[3:]).       
+00004f70: 2020 2020 2020 2020 206d 6b72 735f 7365           mkrs_se
+00004f80: 6320 3d20 6765 745f 6d61 726b 6572 735f  c = get_markers_
+00004f90: 6672 6f6d 5f64 6628 6466 2c20 6365 6c6c  from_df(df, cell
+00004fa0: 5f74 7970 655f 6c73 742c 2070 6e73 6831  _type_lst, pnsh1
+00004fb0: 3220 3d70 6e73 6831 325f 6e2c 2076 6572  2 =pnsh12_n, ver
+00004fc0: 626f 7365 203d 2076 6572 626f 7365 290a  bose = verbose).
+00004fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004fe0: 6d6b 7273 5f73 6563 203d 2063 6f6d 625f  mkrs_sec = comb_
+00004ff0: 636f 6d6d 6f6e 286d 6b72 735f 7365 6329  common(mkrs_sec)
+00005000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005010: 206d 6b72 5f6c 7374 5f73 6563 2e75 7064   mkr_lst_sec.upd
+00005020: 6174 6528 6d6b 7273 5f73 6563 290a 2020  ate(mkrs_sec).  
+00005030: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+00005040: 2020 2020 2020 2066 6f72 2063 3220 696e         for c2 in
+00005050: 2063 656c 6c5f 7479 7065 5f6c 7374 3a0a   cell_type_lst:.
+00005060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005070: 6d6b 7273 203d 2067 6574 5f6d 6172 6b65  mkrs = get_marke
+00005080: 7273 5f66 726f 6d5f 6466 2864 662c 205b  rs_from_df(df, [
+00005090: 6332 5d2c 2070 6e73 6831 3220 3d20 706e  c2], pnsh12 = pn
+000050a0: 7368 3132 5f74 2c20 7665 7262 6f73 6520  sh12_t, verbose 
+000050b0: 3d20 7665 7262 6f73 6529 0a20 2020 2020  = verbose).     
+000050c0: 2020 2020 2020 2020 2020 206d 6b72 7320             mkrs 
+000050d0: 3d20 636f 6d62 5f63 6f6d 6d6f 6e28 6d6b  = comb_common(mk
+000050e0: 7273 2920 2020 2020 2020 2020 2020 2020  rs)             
+000050f0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+00005100: 2020 2020 666f 7220 6b65 7920 696e 206d      for key in m
+00005110: 6b72 732e 6b65 7973 2829 3a0a 2020 2020  krs.keys():.    
+00005120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005130: 6d69 6e6f 725f 6469 6374 5b6b 6579 5d20  minor_dict[key] 
+00005140: 3d20 6332 0a20 2020 2020 2020 2020 2020  = c2.           
+00005150: 2020 2020 2020 2020 206d 616a 6f72 5f64           major_d
+00005160: 6963 745b 6b65 795d 203d 2063 0a20 2020  ict[key] = c.   
+00005170: 2020 2020 2020 2020 200a 2020 2020 6966           .    if
+00005180: 206c 656e 286d 6b72 5f6c 7374 2e6b 6579   len(mkr_lst.key
+00005190: 7328 2929 203d 3d20 303a 0a20 2020 2020  s()) == 0:.     
+000051a0: 2020 2072 6574 7572 6e20 6d6b 725f 6c73     return mkr_ls
+000051b0: 742c 206d 6b72 5f6c 7374 5f6e 6567 2c20  t, mkr_lst_neg, 
+000051c0: 6d6b 725f 6c73 745f 7365 630a 0a20 2020  mkr_lst_sec..   
+000051d0: 2069 6620 636f 6d62 5f6d 6b72 733a 0a20   if comb_mkrs:. 
+000051e0: 2020 2020 2020 206d 6b72 5f6c 7374 2c20         mkr_lst, 
+000051f0: 6d61 6a6f 725f 6469 6374 2c20 6d69 6e6f  major_dict, mino
+00005200: 725f 6469 6374 203d 2063 6f6d 625f 6d61  r_dict = comb_ma
+00005210: 726b 6572 7328 6d6b 725f 6c73 742c 206d  rkers(mkr_lst, m
+00005220: 616a 6f72 5f64 6963 742c 206d 696e 6f72  ajor_dict, minor
+00005230: 5f64 6963 7429 0a20 2020 2020 2020 206d  _dict).        m
+00005240: 6b72 5f6c 7374 5f6e 6567 203d 2063 6f6d  kr_lst_neg = com
+00005250: 625f 6d61 726b 6572 7328 6d6b 725f 6c73  b_markers(mkr_ls
+00005260: 745f 6e65 6729 0a20 2020 2020 2020 206d  t_neg).        m
+00005270: 6b72 5f6c 7374 5f73 6563 203d 2063 6f6d  kr_lst_sec = com
+00005280: 625f 6d61 726b 6572 7328 6d6b 725f 6c73  b_markers(mkr_ls
+00005290: 745f 7365 6329 0a0a 2020 2020 736d 203d  t_sec)..    sm =
+000052a0: 2027 270a 2020 2020 6365 6c6c 5f74 7970   ''.    cell_typ
+000052b0: 6573 203d 206c 6973 7428 6d6b 725f 6c73  es = list(mkr_ls
+000052c0: 742e 6b65 7973 2829 290a 2020 2020 6365  t.keys()).    ce
+000052d0: 6c6c 5f74 7970 6573 2e73 6f72 7428 290a  ll_types.sort().
+000052e0: 2020 2020 666f 7220 6b65 7920 696e 2063      for key in c
+000052f0: 656c 6c5f 7479 7065 733a 0a20 2020 2020  ell_types:.     
+00005300: 2020 2073 6d20 3d20 736d 202b 2027 2573     sm = sm + '%s
+00005310: 2c27 2025 206b 6579 0a20 2020 2020 2020  ,' % key.       
+00005320: 200a 2020 2020 6966 2076 6572 626f 7365   .    if verbose
+00005330: 3a20 7072 696e 7428 2720 2569 2074 7970  : print(' %i typ
+00005340: 6573 2e20 5c6e 2573 2720 2520 286c 656e  es. \n%s' % (len
+00005350: 286d 6b72 5f6c 7374 2e6b 6579 7328 2929  (mkr_lst.keys())
+00005360: 2c20 736d 5b3a 2d31 5d29 290a 2020 2020  , sm[:-1])).    
+00005370: 2020 2020 0a20 2020 2072 6574 7572 6e20      .    return 
+00005380: 6d6b 725f 6c73 742c 206d 6b72 5f6c 7374  mkr_lst, mkr_lst
+00005390: 5f6e 6567 2c20 6d6b 725f 6c73 745f 7365  _neg, mkr_lst_se
+000053a0: 632c 206d 616a 6f72 5f64 6963 742c 206d  c, major_dict, m
+000053b0: 696e 6f72 5f64 6963 740a 0a0a 6465 6620  inor_dict...def 
+000053c0: 7361 7665 5f6d 6172 6b65 7273 5f61 6c6c  save_markers_all
+000053d0: 286d 6b72 5f6c 7374 2c20 6d6b 725f 6c73  (mkr_lst, mkr_ls
+000053e0: 745f 6e65 672c 206d 6b72 5f6c 7374 5f73  t_neg, mkr_lst_s
+000053f0: 6563 2c20 6d61 6a6f 725f 6469 6374 2c20  ec, major_dict, 
+00005400: 6d69 6e6f 725f 6469 6374 2c20 6669 6c65  minor_dict, file
+00005410: 293a 0a20 2020 200a 2020 2020 636f 6c73  ):.    .    cols
+00005420: 203d 205b 2763 656c 6c5f 7479 7065 5f6d   = ['cell_type_m
+00005430: 616a 6f72 272c 2027 6365 6c6c 5f74 7970  ajor', 'cell_typ
+00005440: 655f 6d69 6e6f 7227 2c20 2763 656c 6c5f  e_minor', 'cell_
+00005450: 7479 7065 5f73 7562 7365 7427 2c20 2765  type_subset', 'e
+00005460: 7870 272c 2027 6d61 726b 6572 7327 5d20  xp', 'markers'] 
+00005470: 0a20 2020 2064 665f 706f 7320 3d20 7064  .    df_pos = pd
+00005480: 2e44 6174 6146 7261 6d65 2863 6f6c 756d  .DataFrame(colum
+00005490: 6e73 203d 2063 6f6c 7329 0a20 2020 2064  ns = cols).    d
+000054a0: 665f 6e65 6720 3d20 7064 2e44 6174 6146  f_neg = pd.DataF
+000054b0: 7261 6d65 2863 6f6c 756d 6e73 203d 2063  rame(columns = c
+000054c0: 6f6c 7329 0a20 2020 2064 665f 7365 6320  ols).    df_sec 
+000054d0: 3d20 7064 2e44 6174 6146 7261 6d65 2863  = pd.DataFrame(c
+000054e0: 6f6c 756d 6e73 203d 2063 6f6c 7329 0a0a  olumns = cols)..
+000054f0: 2020 2020 6d6b 725f 6c73 745f 746d 7020      mkr_lst_tmp 
+00005500: 3d20 6d6b 725f 6c73 740a 2020 2020 6374  = mkr_lst.    ct
+00005510: 5f6c 7374 203d 206c 6973 7428 6d6b 725f  _lst = list(mkr_
+00005520: 6c73 745f 746d 702e 6b65 7973 2829 290a  lst_tmp.keys()).
+00005530: 2020 2020 6d6b 7273 203d 205b 5d0a 2020      mkrs = [].  
+00005540: 2020 6374 5f6c 7374 5f6e 6577 203d 205b    ct_lst_new = [
+00005550: 5d0a 2020 2020 666f 7220 6320 696e 2063  ].    for c in c
+00005560: 745f 6c73 743a 0a20 2020 2020 2020 2069  t_lst:.        i
+00005570: 6620 6c65 6e28 6d6b 725f 6c73 745f 746d  f len(mkr_lst_tm
+00005580: 705b 635d 2920 3e20 303a 0a20 2020 2020  p[c]) > 0:.     
+00005590: 2020 2020 2020 206d 6b72 5f6c 7374 5f74         mkr_lst_t
+000055a0: 6d70 5b63 5d2e 736f 7274 2829 0a20 2020  mp[c].sort().   
+000055b0: 2020 2020 2020 2020 2073 203d 206d 6b72           s = mkr
+000055c0: 5f6c 7374 5f74 6d70 5b63 5d5b 305d 0a20  _lst_tmp[c][0]. 
+000055d0: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+000055e0: 6e28 6d6b 725f 6c73 745f 746d 705b 635d  n(mkr_lst_tmp[c]
+000055f0: 2920 3e20 313a 0a20 2020 2020 2020 2020  ) > 1:.         
+00005600: 2020 2020 2020 2066 6f72 206d 6b72 2069         for mkr i
+00005610: 6e20 6d6b 725f 6c73 745f 746d 705b 635d  n mkr_lst_tmp[c]
+00005620: 5b31 3a5d 3a0a 2020 2020 2020 2020 2020  [1:]:.          
+00005630: 2020 2020 2020 2020 2020 7320 3d20 7320            s = s 
+00005640: 2b20 272c 2573 2720 2520 6d6b 720a 2020  + ',%s' % mkr.  
+00005650: 2020 2020 2020 2020 2020 6d6b 7273 2e61            mkrs.a
+00005660: 7070 656e 6428 7329 0a20 2020 2020 2020  ppend(s).       
+00005670: 2020 2020 2063 745f 6c73 745f 6e65 772e       ct_lst_new.
+00005680: 6170 7065 6e64 2863 290a 2020 2020 0a20  append(c).    . 
+00005690: 2020 2064 665f 706f 735b 2763 656c 6c5f     df_pos['cell_
+000056a0: 7479 7065 5f73 7562 7365 7427 5d20 3d20  type_subset'] = 
+000056b0: 6374 5f6c 7374 5f6e 6577 0a20 2020 2064  ct_lst_new.    d
+000056c0: 665f 706f 735b 276d 6172 6b65 7273 275d  f_pos['markers']
+000056d0: 203d 206d 6b72 730a 2020 2020 6466 5f70   = mkrs.    df_p
+000056e0: 6f73 5b27 6578 7027 5d20 3d20 5b27 706f  os['exp'] = ['po
+000056f0: 7327 5d2a 6c65 6e28 6d6b 7273 290a 2020  s']*len(mkrs).  
+00005700: 2020 0a20 2020 206d 6b72 5f6c 7374 5f74    .    mkr_lst_t
+00005710: 6d70 203d 206d 6b72 5f6c 7374 5f6e 6567  mp = mkr_lst_neg
+00005720: 0a20 2020 2063 745f 6c73 7420 3d20 6c69  .    ct_lst = li
+00005730: 7374 286d 6b72 5f6c 7374 5f74 6d70 2e6b  st(mkr_lst_tmp.k
+00005740: 6579 7328 2929 0a20 2020 206d 6b72 7320  eys()).    mkrs 
+00005750: 3d20 5b5d 0a20 2020 2063 745f 6c73 745f  = [].    ct_lst_
+00005760: 6e65 7720 3d20 5b5d 0a20 2020 2066 6f72  new = [].    for
+00005770: 2063 2069 6e20 6374 5f6c 7374 3a0a 2020   c in ct_lst:.  
+00005780: 2020 2020 2020 6966 206c 656e 286d 6b72        if len(mkr
+00005790: 5f6c 7374 5f74 6d70 5b63 5d29 203e 2030  _lst_tmp[c]) > 0
+000057a0: 3a0a 2020 2020 2020 2020 2020 2020 6d6b  :.            mk
+000057b0: 725f 6c73 745f 746d 705b 635d 2e73 6f72  r_lst_tmp[c].sor
+000057c0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+000057d0: 7320 3d20 6d6b 725f 6c73 745f 746d 705b  s = mkr_lst_tmp[
+000057e0: 635d 5b30 5d0a 2020 2020 2020 2020 2020  c][0].          
+000057f0: 2020 6966 206c 656e 286d 6b72 5f6c 7374    if len(mkr_lst
+00005800: 5f74 6d70 5b63 5d29 203e 2031 3a0a 2020  _tmp[c]) > 1:.  
+00005810: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00005820: 7220 6d6b 7220 696e 206d 6b72 5f6c 7374  r mkr in mkr_lst
+00005830: 5f74 6d70 5b63 5d5b 313a 5d3a 0a20 2020  _tmp[c][1:]:.   
+00005840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005850: 2073 203d 2073 202b 2027 2c25 7327 2025   s = s + ',%s' %
+00005860: 206d 6b72 0a20 2020 2020 2020 2020 2020   mkr.           
+00005870: 206d 6b72 732e 6170 7065 6e64 2873 290a   mkrs.append(s).
+00005880: 2020 2020 2020 2020 2020 2020 6374 5f6c              ct_l
+00005890: 7374 5f6e 6577 2e61 7070 656e 6428 6329  st_new.append(c)
+000058a0: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
+000058b0: 2020 0a20 2020 2064 665f 6e65 675b 2763    .    df_neg['c
+000058c0: 656c 6c5f 7479 7065 5f73 7562 7365 7427  ell_type_subset'
+000058d0: 5d20 3d20 6374 5f6c 7374 5f6e 6577 0a20  ] = ct_lst_new. 
+000058e0: 2020 2064 665f 6e65 675b 276d 6172 6b65     df_neg['marke
+000058f0: 7273 275d 203d 206d 6b72 730a 2020 2020  rs'] = mkrs.    
+00005900: 6466 5f6e 6567 5b27 6578 7027 5d20 3d20  df_neg['exp'] = 
+00005910: 5b27 6e65 6727 5d2a 6c65 6e28 6d6b 7273  ['neg']*len(mkrs
+00005920: 290a 2020 2020 0a20 2020 2064 6620 3d20  ).    .    df = 
+00005930: 7064 2e63 6f6e 6361 7428 5b64 665f 706f  pd.concat([df_po
+00005940: 732c 2064 665f 6e65 675d 2c20 6178 6973  s, df_neg], axis
+00005950: 203d 2030 290a 2020 2020 0a20 2020 206d   = 0).    .    m
+00005960: 6b72 5f6c 7374 5f74 6d70 203d 206d 6b72  kr_lst_tmp = mkr
+00005970: 5f6c 7374 5f73 6563 0a20 2020 2063 745f  _lst_sec.    ct_
+00005980: 6c73 7420 3d20 6c69 7374 286d 6b72 5f6c  lst = list(mkr_l
+00005990: 7374 5f74 6d70 2e6b 6579 7328 2929 0a20  st_tmp.keys()). 
+000059a0: 2020 206d 6b72 7320 3d20 5b5d 0a20 2020     mkrs = [].   
+000059b0: 2063 745f 6c73 745f 6e65 7720 3d20 5b5d   ct_lst_new = []
+000059c0: 0a20 2020 2066 6f72 2063 2069 6e20 6374  .    for c in ct
+000059d0: 5f6c 7374 3a0a 2020 2020 2020 2020 6966  _lst:.        if
+000059e0: 206c 656e 286d 6b72 5f6c 7374 5f74 6d70   len(mkr_lst_tmp
+000059f0: 5b63 5d29 203e 2030 3a0a 2020 2020 2020  [c]) > 0:.      
+00005a00: 2020 2020 2020 6d6b 725f 6c73 745f 746d        mkr_lst_tm
+00005a10: 705b 635d 2e73 6f72 7428 290a 2020 2020  p[c].sort().    
+00005a20: 2020 2020 2020 2020 7320 3d20 6d6b 725f          s = mkr_
+00005a30: 6c73 745f 746d 705b 635d 5b30 5d0a 2020  lst_tmp[c][0].  
+00005a40: 2020 2020 2020 2020 2020 6966 206c 656e            if len
+00005a50: 286d 6b72 5f6c 7374 5f74 6d70 5b63 5d29  (mkr_lst_tmp[c])
+00005a60: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
+00005a70: 2020 2020 2020 666f 7220 6d6b 7220 696e        for mkr in
+00005a80: 206d 6b72 5f6c 7374 5f74 6d70 5b63 5d5b   mkr_lst_tmp[c][
+00005a90: 313a 5d3a 0a20 2020 2020 2020 2020 2020  1:]:.           
+00005aa0: 2020 2020 2020 2020 2073 203d 2073 202b           s = s +
+00005ab0: 2027 2c25 7327 2025 206d 6b72 0a20 2020   ',%s' % mkr.   
+00005ac0: 2020 2020 2020 2020 206d 6b72 732e 6170           mkrs.ap
+00005ad0: 7065 6e64 2873 290a 2020 2020 2020 2020  pend(s).        
+00005ae0: 2020 2020 6374 5f6c 7374 5f6e 6577 2e61      ct_lst_new.a
+00005af0: 7070 656e 6428 6329 0a20 2020 2020 2020  ppend(c).       
+00005b00: 2020 2020 200a 2020 2020 0a20 2020 2064       .    .    d
+00005b10: 665f 7365 635b 2763 656c 6c5f 7479 7065  f_sec['cell_type
+00005b20: 5f73 7562 7365 7427 5d20 3d20 6374 5f6c  _subset'] = ct_l
+00005b30: 7374 5f6e 6577 0a20 2020 2064 665f 7365  st_new.    df_se
+00005b40: 635b 276d 6172 6b65 7273 275d 203d 206d  c['markers'] = m
+00005b50: 6b72 730a 2020 2020 6466 5f73 6563 5b27  krs.    df_sec['
+00005b60: 6578 7027 5d20 3d20 5b27 7365 6327 5d2a  exp'] = ['sec']*
+00005b70: 6c65 6e28 6d6b 7273 290a 2020 2020 0a20  len(mkrs).    . 
+00005b80: 2020 2064 6620 3d20 7064 2e63 6f6e 6361     df = pd.conca
+00005b90: 7428 5b64 662c 2064 665f 7365 635d 2c20  t([df, df_sec], 
+00005ba0: 6178 6973 203d 2030 290a 2020 2020 0a20  axis = 0).    . 
+00005bb0: 2020 2064 665b 2763 656c 6c5f 7479 7065     df['cell_type
+00005bc0: 5f6d 616a 6f72 275d 203d 2064 665b 2763  _major'] = df['c
+00005bd0: 656c 6c5f 7479 7065 5f73 7562 7365 7427  ell_type_subset'
+00005be0: 5d2e 636f 7079 2864 6565 7020 3d20 5472  ].copy(deep = Tr
+00005bf0: 7565 290a 2020 2020 6466 5b27 6365 6c6c  ue).    df['cell
+00005c00: 5f74 7970 655f 6d69 6e6f 7227 5d20 3d20  _type_minor'] = 
+00005c10: 6466 5b27 6365 6c6c 5f74 7970 655f 7375  df['cell_type_su
+00005c20: 6273 6574 275d 2e63 6f70 7928 6465 6570  bset'].copy(deep
+00005c30: 203d 2054 7275 6529 0a20 2020 2064 665b   = True).    df[
+00005c40: 2763 656c 6c5f 7479 7065 5f6d 616a 6f72  'cell_type_major
+00005c50: 275d 2e72 6570 6c61 6365 286d 616a 6f72  '].replace(major
+00005c60: 5f64 6963 742c 2069 6e70 6c61 6365 203d  _dict, inplace =
+00005c70: 2054 7275 6529 0a20 2020 2064 665b 2763   True).    df['c
+00005c80: 656c 6c5f 7479 7065 5f6d 696e 6f72 275d  ell_type_minor']
+00005c90: 2e72 6570 6c61 6365 286d 696e 6f72 5f64  .replace(minor_d
+00005ca0: 6963 742c 2069 6e70 6c61 6365 203d 2054  ict, inplace = T
+00005cb0: 7275 6529 0a20 2020 2064 662e 736f 7274  rue).    df.sort
+00005cc0: 5f76 616c 7565 7328 6279 203d 205b 2763  _values(by = ['c
+00005cd0: 656c 6c5f 7479 7065 5f6d 616a 6f72 272c  ell_type_major',
+00005ce0: 2027 6365 6c6c 5f74 7970 655f 6d61 6a6f   'cell_type_majo
+00005cf0: 7227 2c20 2763 656c 6c5f 7479 7065 5f73  r', 'cell_type_s
+00005d00: 7562 7365 7427 5d2c 2069 6e70 6c61 6365  ubset'], inplace
+00005d10: 203d 2054 7275 6529 0a0a 2020 2020 6966   = True)..    if
+00005d20: 2066 696c 6520 6973 204e 6f6e 653a 0a20   file is None:. 
+00005d30: 2020 2020 2020 2072 6574 7572 6e20 6466         return df
+00005d40: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00005d50: 2020 2064 662e 746f 5f63 7376 2866 696c     df.to_csv(fil
+00005d60: 652c 2073 6570 203d 2027 5c74 272c 2069  e, sep = '\t', i
+00005d70: 6e64 6578 203d 2046 616c 7365 290a 2020  ndex = False).  
+00005d80: 2020 2020 2020 7265 7475 726e 2064 660a        return df.
+00005d90: 2020 2020 0a27 2727 0a70 6f73 203d 2054      .'''.pos = T
+00005da0: 7275 650a 6e65 6720 3d20 4661 6c73 650a  rue.neg = False.
+00005db0: 7365 6320 3d20 5472 7565 0a68 6c61 5f64  sec = True.hla_d
+00005dc0: 7220 3d20 5472 7565 0a6d 6863 3120 3d20  r = True.mhc1 = 
+00005dd0: 5472 7565 0a6d 6863 3220 3d20 5472 7565  True.mhc2 = True
+00005de0: 0a27 2727 2020 2020 0a0a 6465 6620 5469  .'''    ..def Ti
+00005df0: 6465 6e5f 6368 6563 6b5f 6b65 795f 6765  den_check_key_ge
+00005e00: 6e65 7328 2067 656e 655f 6c73 742c 206b  nes( gene_lst, k
+00005e10: 6579 5f67 656e 6573 2029 3a0a 2020 2020  ey_genes ):.    
+00005e20: 0a20 2020 2062 203d 2054 7275 650a 2020  .    b = True.  
+00005e30: 2020 666f 7220 6720 696e 206c 6973 7428    for g in list(
+00005e40: 6b65 795f 6765 6e65 7329 3a0a 2020 2020  key_genes):.    
+00005e50: 2020 2020 6966 2067 206e 6f74 2069 6e20      if g not in 
+00005e60: 6765 6e65 5f6c 7374 3a0a 2020 2020 2020  gene_lst:.      
+00005e70: 2020 2020 2020 6220 3d20 4661 6c73 650a        b = False.
+00005e80: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+00005e90: 6b0a 2020 2020 7265 7475 726e 2062 0a0a  k.    return b..
+00005ea0: 6465 6620 5469 6465 6e5f 7072 696e 745f  def Tiden_print_
+00005eb0: 6572 726f 7228 6572 726f 725f 636f 6465  error(error_code
+00005ec0: 203d 2030 293a 2020 2020 0a20 2020 2069   = 0):    .    i
+00005ed0: 6620 6572 726f 725f 636f 6465 203d 3d20  f error_code == 
+00005ee0: 313a 0a20 2020 2020 2020 2070 7269 6e74  1:.        print
+00005ef0: 2827 4552 524f 523a 204f 6e65 206f 7220  ('ERROR: One or 
+00005f00: 6d6f 7265 206f 6620 6b65 7920 6765 6e65  more of key gene
+00005f10: 7320 666f 7220 5420 6365 6c6c 2073 7562  s for T cell sub
+00005f20: 7479 7069 6e67 2028 4344 342c 2043 4438  typing (CD4, CD8
+00005f30: 412c 2043 4438 4229 2061 7265 206e 6f74  A, CD8B) are not
+00005f40: 2069 6e20 7468 6520 6765 6e65 206c 6973   in the gene lis
+00005f50: 742e 2729 0a20 2020 2065 6c73 653a 0a20  t.').    else:. 
+00005f60: 2020 2020 2020 2070 7269 6e74 2827 4552         print('ER
+00005f70: 524f 523a 2058 5f63 656c 6c5f 6279 5f67  ROR: X_cell_by_g
+00005f80: 656e 6520 6d75 7374 2062 6520 6120 4461  ene must be a Da
+00005f90: 7461 4672 616d 6520 7769 7468 2069 7473  taFrame with its
+00005fa0: 2063 6f6c 756d 6e73 2062 6569 6e67 2067   columns being g
+00005fb0: 656e 6520 6e61 6d65 7320 6861 7669 6e67  ene names having
+00005fc0: 2043 4434 2c20 4344 3841 2c20 4344 3842   CD4, CD8A, CD8B
+00005fd0: 2729 0a20 2020 2020 2020 2070 7269 6e74  ').        print
+00005fe0: 2827 2020 204f 722c 2067 656e 655f 6e61  ('   Or, gene_na
+00005ff0: 6d65 7320 6d75 7374 2062 6520 7072 6f76  mes must be prov
+00006000: 6964 6564 2077 6974 6820 6974 7320 6c65  ided with its le
+00006010: 6e67 7468 2065 7175 616c 2074 6f20 7468  ngth equal to th
+00006020: 6520 636f 6c75 6d6e 2073 697a 6520 6f66  e column size of
+00006030: 2058 5f63 656c 6c5f 6279 5f67 656e 652c   X_cell_by_gene,
+00006040: 2063 6f6e 7461 696e 696e 6720 4344 342c   containing CD4,
+00006050: 2043 4438 412c 2043 4438 422e 2729 0a0a   CD8A, CD8B.')..
+00006060: 2020 2020 2020 2020 0a64 6566 2067 6574          .def get
+00006070: 5f73 7461 7432 2864 665f 7363 6f72 6529  _stat2(df_score)
+00006080: 3a0a 0a20 2020 2064 6620 3d20 6466 5f73  :..    df = df_s
+00006090: 636f 7265 0a20 2020 206d 6178 7620 3d20  core.    maxv = 
+000060a0: 6c69 7374 2864 662e 6d61 7828 6178 6973  list(df.max(axis
+000060b0: 203d 2031 2929 0a20 2020 2073 7562 7479   = 1)).    subty
+000060c0: 7065 203d 206c 6973 7428 6466 2e69 6478  pe = list(df.idx
+000060d0: 6d61 7828 6178 6973 203d 2031 2929 0a20  max(axis = 1)). 
+000060e0: 2020 2023 7463 5f73 7562 7479 7065 203d     #tc_subtype =
+000060f0: 205b 7472 616e 735f 6469 6374 5b6b 5d20   [trans_dict[k] 
+00006100: 666f 7220 6b20 696e 2074 635f 7375 6274  for k in tc_subt
+00006110: 7970 655d 0a0a 2020 2020 6d61 7876 3220  ype]..    maxv2 
+00006120: 3d20 5b5d 0a20 2020 2069 6478 3220 3d20  = [].    idx2 = 
+00006130: 5b5d 0a20 2020 2073 7562 7479 7065 5f6c  [].    subtype_l
+00006140: 7374 203d 206c 6973 7428 6466 2e63 6f6c  st = list(df.col
+00006150: 756d 6e73 2e76 616c 7565 7329 0a0a 2020  umns.values)..  
+00006160: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+00006170: 2864 662e 7368 6170 655b 305d 293a 0a20  (df.shape[0]):. 
+00006180: 2020 2020 2020 2078 203d 206e 702e 6172         x = np.ar
+00006190: 7261 7928 6466 2e69 6c6f 635b 695d 290a  ray(df.iloc[i]).
+000061a0: 2020 2020 2020 2020 6f64 7220 3d20 282d          odr = (-
+000061b0: 7829 2e61 7267 736f 7274 2829 0a20 2020  x).argsort().   
+000061c0: 2020 2020 2069 6620 6c65 6e28 7829 203e       if len(x) >
+000061d0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+000061e0: 6d61 7876 322e 6170 7065 6e64 2878 5b6f  maxv2.append(x[o
+000061f0: 6472 5b31 5d5d 290a 2020 2020 2020 2020  dr[1]]).        
+00006200: 2020 2020 6964 7832 2e61 7070 656e 6428      idx2.append(
+00006210: 7375 6274 7970 655f 6c73 745b 6f64 725b  subtype_lst[odr[
+00006220: 315d 5d29 0a20 2020 2020 2020 2065 6c73  1]]).        els
+00006230: 653a 0a20 2020 2020 2020 2020 2020 206d  e:.            m
+00006240: 6178 7632 2e61 7070 656e 6428 3029 0a20  axv2.append(0). 
+00006250: 2020 2020 2020 2020 2020 2069 6478 322e             idx2.
+00006260: 6170 7065 6e64 284e 6f6e 6529 0a0a 2020  append(None)..  
+00006270: 2020 2320 6466 5f72 6573 203d 2070 642e    # df_res = pd.
+00006280: 4461 7461 4672 616d 6528 7b27 4344 342b  DataFrame({'CD4+
+00006290: 2054 2063 656c 6c20 7375 6274 7970 6527   T cell subtype'
+000062a0: 3a20 7463 5f73 7562 7479 7065 2c20 274e  : tc_subtype, 'N
+000062b0: 6567 4c6f 6750 7661 6c27 3a20 6e65 675f  egLogPval': neg_
+000062c0: 6c6f 675f 7076 616c 7d2c 2069 6e64 6578  log_pval}, index
+000062d0: 203d 2064 662e 696e 6465 782e 7661 6c75   = df.index.valu
+000062e0: 6573 290a 2020 2020 6466 5f72 6573 203d  es).    df_res =
+000062f0: 2070 642e 4461 7461 4672 616d 6528 7b27   pd.DataFrame({'
+00006300: 6365 6c6c 5f74 7970 6527 3a20 7375 6274  cell_type': subt
+00006310: 7970 652c 2027 6365 6c6c 5f74 7970 6528  ype, 'cell_type(
+00006320: 7265 7629 273a 2073 7562 7479 7065 2c20  rev)': subtype, 
+00006330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006340: 2020 2020 2020 2020 2020 2020 2763 656c              'cel
+00006350: 6c5f 7479 7065 2831 7374 2927 3a20 7375  l_type(1st)': su
+00006360: 6274 7970 652c 2027 6365 6c6c 5f74 7970  btype, 'cell_typ
+00006370: 6528 326e 6429 273a 2069 6478 322c 200a  e(2nd)': idx2, .
+00006380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006390: 2020 2020 2020 2020 2020 2027 436c 6172             'Clar
+000063a0: 6974 7927 3a20 5b27 2d27 5d2a 6466 2e73  ity': ['-']*df.s
+000063b0: 6861 7065 5b30 5d2c 2027 5363 6f72 6527  hape[0], 'Score'
+000063c0: 3a20 6d61 7876 2c20 2753 636f 7265 2832  : maxv, 'Score(2
+000063d0: 6e64 2927 3a20 6d61 7876 327d 2c20 0a20  nd)': maxv2}, . 
+000063e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000063f0: 2020 2020 2020 2020 2069 6e64 6578 203d           index =
+00006400: 2064 662e 696e 6465 782e 7661 6c75 6573   df.index.values
+00006410: 290a 2020 2020 6466 5f72 6573 5b27 6453  ).    df_res['dS
+00006420: 636f 7265 275d 203d 2064 665f 7265 735b  core'] = df_res[
+00006430: 2753 636f 7265 275d 202d 2064 665f 7265  'Score'] - df_re
+00006440: 735b 2753 636f 7265 2832 6e64 2927 5d0a  s['Score(2nd)'].
+00006450: 2020 2020 0a20 2020 2072 6574 7572 6e20      .    return 
+00006460: 6466 5f72 6573 0a0a 0a64 6566 2070 6c6f  df_res...def plo
+00006470: 745f 4753 415f 7363 6f72 655f 6869 7374  t_GSA_score_hist
+00006480: 2864 665f 7363 6f72 652c 2074 6974 6c65  (df_score, title
+00006490: 203d 2027 4753 4127 2c20 6869 7374 7479   = 'GSA', histty
+000064a0: 7065 203d 2027 6261 7227 293a 0a20 2020  pe = 'bar'):.   
+000064b0: 200a 2020 2020 6466 5f73 756d 203d 2067   .    df_sum = g
+000064c0: 6574 5f73 7461 7432 2864 665f 7363 6f72  et_stat2(df_scor
+000064d0: 6529 0a20 2020 2073 636f 7265 5f6e 616d  e).    score_nam
+000064e0: 6520 3d20 2753 636f 7265 270a 2020 2020  e = 'Score'.    
+000064f0: 7461 7267 6574 5f74 7970 6573 203d 206c  target_types = l
+00006500: 6973 7428 6466 5f73 756d 5b27 6365 6c6c  ist(df_sum['cell
+00006510: 5f74 7970 6528 3173 7429 275d 2e75 6e69  _type(1st)'].uni
+00006520: 7175 6528 2929 0a20 2020 2074 6872 6573  que()).    thres
+00006530: 686f 6c64 7320 3d20 7b7d 0a20 2020 206d  holds = {}.    m
+00006540: 316d 325f 7261 7469 6f20 3d20 7b7d 0a20  1m2_ratio = {}. 
+00006550: 2020 2070 6c6f 745f 6869 7374 203d 2054     plot_hist = T
+00006560: 7275 650a 2020 2020 0a20 2020 2066 6f72  rue.    .    for
+00006570: 2074 2069 6e20 7461 7267 6574 5f74 7970   t in target_typ
+00006580: 6573 3a0a 2020 2020 2020 2020 7461 7267  es:.        targ
+00006590: 6574 203d 2074 0a0a 2020 2020 2020 2020  et = t..        
+000065a0: 6231 203d 2028 6466 5f73 756d 5b27 6365  b1 = (df_sum['ce
+000065b0: 6c6c 5f74 7970 6528 3173 7429 275d 203d  ll_type(1st)'] =
+000065c0: 3d20 7461 7267 6574 2920 2326 2028 6466  = target) #& (df
+000065d0: 5f73 756d 5b27 2d6c 6f67 5027 5d20 3e20  _sum['-logP'] > 
+000065e0: 2d6e 702e 6c6f 6731 3028 7076 616c 5f74  -np.log10(pval_t
+000065f0: 6829 290a 2020 2020 2020 2020 7631 203d  h)).        v1 =
+00006600: 2064 665f 7375 6d2e 6c6f 635b 6231 2c20   df_sum.loc[b1, 
+00006610: 7363 6f72 655f 6e61 6d65 5d0a 2020 2020  score_name].    
+00006620: 2020 2020 6d31 203d 2064 665f 7375 6d2e      m1 = df_sum.
+00006630: 6c6f 635b 6231 2c20 7363 6f72 655f 6e61  loc[b1, score_na
+00006640: 6d65 5d2e 6d61 7828 2920 232e 6d65 616e  me].max() #.mean
+00006650: 2829 0a20 2020 2020 2020 206e 3120 3d20  ().        n1 = 
+00006660: 6e70 2e73 756d 2862 3129 0a0a 2020 2020  np.sum(b1)..    
+00006670: 2020 2020 6232 203d 2028 6466 5f73 756d      b2 = (df_sum
+00006680: 5b27 6365 6c6c 5f74 7970 6528 326e 6429  ['cell_type(2nd)
+00006690: 275d 203d 3d20 7461 7267 6574 2920 2320  '] == target) # 
+000066a0: 2620 2864 665f 7375 6d5b 272d 6c6f 6750  & (df_sum['-logP
+000066b0: 2832 6e64 2927 5d20 3e20 2d6e 702e 6c6f  (2nd)'] > -np.lo
+000066c0: 6731 3028 7076 616c 5f74 6829 290a 2020  g10(pval_th)).  
+000066d0: 2020 2020 2020 6966 206e 702e 7375 6d28        if np.sum(
+000066e0: 6232 2920 3e20 303a 0a20 2020 2020 2020  b2) > 0:.       
+000066f0: 2020 2020 2076 3220 3d20 6466 5f73 756d       v2 = df_sum
+00006700: 2e6c 6f63 5b62 322c 2027 2573 2832 6e64  .loc[b2, '%s(2nd
+00006710: 2927 2025 2073 636f 7265 5f6e 616d 655d  )' % score_name]
+00006720: 0a20 2020 2020 2020 2020 2020 206d 3220  .            m2 
+00006730: 3d20 6466 5f73 756d 2e6c 6f63 5b62 322c  = df_sum.loc[b2,
+00006740: 2027 2573 2832 6e64 2927 2025 2073 636f   '%s(2nd)' % sco
+00006750: 7265 5f6e 616d 655d 2e6d 6178 2829 2023  re_name].max() #
+00006760: 2e6d 6561 6e28 290a 2020 2020 2020 2020  .mean().        
+00006770: 2020 2020 6e32 203d 206e 702e 7375 6d28      n2 = np.sum(
+00006780: 6232 290a 2020 2020 2020 2020 2020 2020  b2).            
+00006790: 0a20 2020 2020 2020 2069 6620 706c 6f74  .        if plot
+000067a0: 5f68 6973 743a 0a20 2020 2020 2020 2020  _hist:.         
+000067b0: 2020 2078 3120 3d20 6466 5f73 756d 2e6c     x1 = df_sum.l
+000067c0: 6f63 5b62 312c 2073 636f 7265 5f6e 616d  oc[b1, score_nam
+000067d0: 655d 0a20 2020 2020 2020 2020 2020 206d  e].            m
+000067e0: 6e76 203d 2078 312e 6d69 6e28 290a 2020  nv = x1.min().  
+000067f0: 2020 2020 2020 2020 2020 6d78 7620 3d20            mxv = 
+00006800: 7831 2e6d 6178 2829 0a20 2020 2020 2020  x1.max().       
+00006810: 2020 2020 2058 203d 2078 310a 2020 2020       X = x1.    
+00006820: 2020 2020 2020 2020 6966 206e 702e 7375          if np.su
+00006830: 6d28 6232 2920 3e20 303a 0a20 2020 2020  m(b2) > 0:.     
+00006840: 2020 2020 2020 2020 2020 2078 3220 3d20             x2 = 
+00006850: 6466 5f73 756d 2e6c 6f63 5b62 322c 2027  df_sum.loc[b2, '
+00006860: 2573 2832 6e64 2927 2025 2073 636f 7265  %s(2nd)' % score
+00006870: 5f6e 616d 655d 0a20 2020 2020 2020 2020  _name].         
+00006880: 2020 2020 2020 206d 6e76 203d 206d 696e         mnv = min
+00006890: 286d 6e76 2c20 7832 2e6d 696e 2829 290a  (mnv, x2.min()).
+000068a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000068b0: 6d78 7620 3d20 6d61 7828 6d78 762c 2078  mxv = max(mxv, x
+000068c0: 322e 6d69 6e28 2929 0a20 2020 2020 2020  2.min()).       
+000068d0: 2020 2020 2020 2020 2058 203d 206e 702e           X = np.
+000068e0: 6172 7261 7928 5b78 312c 7832 5d29 0a20  array([x1,x2]). 
+000068f0: 2020 2020 2020 2020 2020 2020 2020 200a                 .
+00006900: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+00006910: 6e76 203c 206d 7876 3a0a 2020 2020 2020  nv < mxv:.      
+00006920: 2020 2020 2020 2020 2020 6269 6e73 203d            bins =
+00006930: 206e 702e 6172 616e 6765 286d 6e76 2c20   np.arange(mnv, 
+00006940: 6d78 762c 2028 6d78 762d 6d6e 7629 2f35  mxv, (mxv-mnv)/5
+00006950: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
+00006960: 2020 2070 6c74 2e66 6967 7572 6528 6669     plt.figure(fi
+00006970: 6773 697a 6520 3d20 2835 2c33 2929 0a20  gsize = (5,3)). 
+00006980: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00006990: 2064 665f 7375 6d2e 6c6f 635b 6231 2c20   df_sum.loc[b1, 
+000069a0: 7363 6f72 655f 6e61 6d65 5d2e 6869 7374  score_name].hist
+000069b0: 2862 696e 7320 3d20 3530 2c20 6c6f 6720  (bins = 50, log 
+000069c0: 3d20 5472 7565 2c20 616c 7068 6120 3d20  = True, alpha = 
+000069d0: 302e 3729 0a20 2020 2020 2020 2020 2020  0.7).           
+000069e0: 2020 2020 2070 6c74 2e68 6973 7428 582c       plt.hist(X,
+000069f0: 2062 696e 7320 3d20 6269 6e73 2c20 6c6f   bins = bins, lo
+00006a00: 6720 3d20 5472 7565 2c20 616c 7068 6120  g = True, alpha 
+00006a10: 3d20 302e 382c 2068 6973 7474 7970 6520  = 0.8, histtype 
+00006a20: 3d20 6869 7374 7479 7065 290a 2020 2020  = histtype).    
+00006a30: 2020 2020 2020 2020 2020 2020 706c 742e              plt.
+00006a40: 7469 746c 6528 2748 6973 746f 6772 616d  title('Histogram
+00006a50: 2066 6f72 2025 7320 2573 2073 636f 7265   for %s %s score
+00006a60: 2720 2520 2874 2c20 7469 746c 6529 290a  ' % (t, title)).
+00006a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006a80: 706c 742e 786c 6162 656c 2827 7363 6f72  plt.xlabel('scor
+00006a90: 6527 290a 2020 2020 2020 2020 2020 2020  e').            
+00006aa0: 2020 2020 706c 742e 796c 6162 656c 2827      plt.ylabel('
+00006ab0: 4e75 6d62 6572 206f 6620 6365 6c6c 7327  Number of cells'
+00006ac0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00006ad0: 2020 6966 206e 702e 7375 6d28 6232 2920    if np.sum(b2) 
+00006ae0: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
+00006af0: 2020 2020 2020 2020 2023 2064 665f 7375           # df_su
+00006b00: 6d2e 6c6f 635b 6232 2c20 2725 7328 326e  m.loc[b2, '%s(2n
+00006b10: 6429 2720 2520 7363 6f72 655f 6e61 6d65  d)' % score_name
+00006b20: 5d2e 6869 7374 2862 696e 7320 3d20 3530  ].hist(bins = 50
+00006b30: 2c20 6c6f 6720 3d20 5472 7565 2c20 616c  , log = True, al
+00006b40: 7068 6120 3d20 302e 3529 0a20 2020 2020  pha = 0.5).     
+00006b50: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00006b60: 2070 6c74 2e68 6973 7428 7832 2c20 6269   plt.hist(x2, bi
+00006b70: 6e73 203d 2062 696e 732c 206c 6f67 203d  ns = bins, log =
+00006b80: 2054 7275 652c 2061 6c70 6861 203d 2030   True, alpha = 0
+00006b90: 2e35 2c20 6465 6e73 6974 7920 3d20 5472  .5, density = Tr
+00006ba0: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
+00006bb0: 2020 2020 2020 2020 706c 742e 6c65 6765          plt.lege
+00006bc0: 6e64 285b 2750 7269 6d61 7279 272c 2027  nd(['Primary', '
+00006bd0: 5365 636f 6e64 6172 7927 5d29 0a20 2020  Secondary']).   
+00006be0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00006bf0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00006c00: 2020 2020 2020 2070 6c74 2e6c 6567 656e         plt.legen
+00006c10: 6428 5b27 5072 696d 6172 7927 5d29 0a20  d(['Primary']). 
+00006c20: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00006c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006c40: 2070 7269 6e74 2827 4869 7374 6f67 7261   print('Histogra
+00006c50: 6d20 666f 7220 2573 2025 7320 6e6f 7420  m for %s %s not 
+00006c60: 6176 6169 6c61 626c 652e 2720 2520 2874  available.' % (t
+00006c70: 2c20 7469 746c 6529 290a 2020 2020 7265  , title)).    re
+00006c80: 7475 726e 200a 0a0a 6465 6620 706c 6f74  turn ...def plot
+00006c90: 5f47 5341 5f73 636f 7265 5f76 696f 6c69  _GSA_score_violi
+00006ca0: 6e28 6466 5f73 636f 7265 2c20 7469 746c  n(df_score, titl
+00006cb0: 6520 3d20 2747 5341 272c 2073 706c 6974  e = 'GSA', split
+00006cc0: 203d 2054 7275 652c 200a 2020 2020 2020   = True, .      
+00006cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ce0: 2020 2020 7363 616c 6520 3d20 2777 6964      scale = 'wid
+00006cf0: 7468 272c 2069 6e6e 6572 203d 2027 7175  th', inner = 'qu
+00006d00: 6172 7469 6c65 272c 206c 6f67 203d 2054  artile', log = T
+00006d10: 7275 652c 200a 2020 2020 2020 2020 2020  rue, .          
+00006d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006d30: 7769 6474 6820 3d20 312c 2066 6967 5f73  width = 1, fig_s
+00006d40: 6361 6c65 203d 2031 293a 0a20 2020 200a  cale = 1):.    .
+00006d50: 2020 2020 6466 5f73 756d 203d 2067 6574      df_sum = get
+00006d60: 5f73 7461 7432 2864 665f 7363 6f72 6529  _stat2(df_score)
+00006d70: 0a20 2020 2069 6620 6c6f 673a 0a20 2020  .    if log:.   
+00006d80: 2020 2020 2064 665f 7363 6f72 6520 3d20       df_score = 
+00006d90: 6e70 2e6c 6f67 3228 6466 5f73 636f 7265  np.log2(df_score
+00006da0: 202b 2031 290a 2020 2020 2020 2020 0a20   + 1).        . 
+00006db0: 2020 2073 636f 7265 5f6e 616d 6520 3d20     score_name = 
+00006dc0: 2753 636f 7265 270a 2020 2020 7461 7267  'Score'.    targ
+00006dd0: 6574 5f74 7970 6573 203d 206c 6973 7428  et_types = list(
+00006de0: 6466 5f73 636f 7265 2e63 6f6c 756d 6e73  df_score.columns
+00006df0: 2e76 616c 7565 7329 2023 206c 6973 7428  .values) # list(
+00006e00: 6466 5f73 756d 5b27 6365 6c6c 5f74 7970  df_sum['cell_typ
+00006e10: 6528 3173 7429 275d 2e75 6e69 7175 6528  e(1st)'].unique(
+00006e20: 2929 0a20 2020 2074 6872 6573 686f 6c64  )).    threshold
+00006e30: 7320 3d20 7b7d 0a20 2020 206d 316d 325f  s = {}.    m1m2_
+00006e40: 7261 7469 6f20 3d20 7b7d 0a20 2020 2070  ratio = {}.    p
+00006e50: 6c6f 745f 6869 7374 203d 2054 7275 650a  lot_hist = True.
+00006e60: 2020 2020 0a20 2020 2063 6e74 203d 2030      .    cnt = 0
+00006e70: 0a20 2020 2066 6f72 2074 2069 6e20 7461  .    for t in ta
+00006e80: 7267 6574 5f74 7970 6573 3a0a 2020 2020  rget_types:.    
+00006e90: 2020 2020 7461 7267 6574 203d 2074 0a0a      target = t..
+00006ea0: 2020 2020 2020 2020 6231 203d 2028 6466          b1 = (df
+00006eb0: 5f73 756d 5b27 6365 6c6c 5f74 7970 6528  _sum['cell_type(
+00006ec0: 3173 7429 275d 203d 3d20 7461 7267 6574  1st)'] == target
+00006ed0: 2920 0a20 2020 2020 2020 2062 3220 3d20  ) .        b2 = 
+00006ee0: 2864 665f 7375 6d5b 2763 656c 6c5f 7479  (df_sum['cell_ty
+00006ef0: 7065 2831 7374 2927 5d20 213d 2074 6172  pe(1st)'] != tar
+00006f00: 6765 7429 200a 2020 2020 2020 2020 2020  get) .          
+00006f10: 2020 0a20 2020 2020 2020 2058 203d 204e    .        X = N
+00006f20: 6f6e 650a 2020 2020 2020 2020 6966 2070  one.        if p
+00006f30: 6c6f 745f 6869 7374 3a0a 2020 2020 2020  lot_hist:.      
+00006f40: 2020 2020 2020 7831 203d 2064 665f 7363        x1 = df_sc
+00006f50: 6f72 652e 6c6f 635b 6231 2c20 745d 0a20  ore.loc[b1, t]. 
+00006f60: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+00006f70: 6e28 7831 2920 3e20 3130 3a0a 2020 2020  n(x1) > 10:.    
+00006f80: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00006f90: 702e 7375 6d28 6232 2920 3e20 3130 3a0a  p.sum(b2) > 10:.
+00006fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006fb0: 2020 2020 5820 3d20 7064 2e44 6174 6146      X = pd.DataF
+00006fc0: 7261 6d65 2820 7b27 5363 6f72 6527 3a20  rame( {'Score': 
+00006fd0: 7831 7d20 290a 2020 2020 2020 2020 2020  x1} ).          
+00006fe0: 2020 2020 2020 2020 2020 585b 2763 656c            X['cel
+00006ff0: 6c20 7479 7065 275d 203d 2027 5461 7267  l type'] = 'Targ
+00007000: 6574 270a 2020 2020 2020 2020 2020 2020  et'.            
+00007010: 2020 2020 2020 2020 585b 2743 656c 6c20          X['Cell 
+00007020: 7479 7065 275d 203d 2074 0a20 2020 2020  type'] = t.     
+00007030: 2020 2020 2020 2020 2020 2020 2020 200a                 .
+00007040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007050: 2020 2020 7832 203d 2064 665f 7363 6f72      x2 = df_scor
+00007060: 652e 6c6f 635b 6232 2c20 745d 2023 2064  e.loc[b2, t] # d
+00007070: 665f 7375 6d2e 6c6f 635b 6232 2c20 2725  f_sum.loc[b2, '%
+00007080: 7328 326e 6429 2720 2520 7363 6f72 655f  s(2nd)' % score_
+00007090: 6e61 6d65 5d0a 2020 2020 2020 2020 2020  name].          
+000070a0: 2020 2020 2020 2020 2020 2320 5820 3d20            # X = 
+000070b0: 6e70 2e61 7272 6179 285b 7831 2c78 325d  np.array([x1,x2]
+000070c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000070d0: 2020 2020 2020 5832 203d 2070 642e 4461        X2 = pd.Da
+000070e0: 7461 4672 616d 6528 207b 2753 636f 7265  taFrame( {'Score
+000070f0: 273a 2078 327d 2029 0a20 2020 2020 2020  ': x2} ).       
+00007100: 2020 2020 2020 2020 2020 2020 2058 325b               X2[
+00007110: 2763 656c 6c20 7479 7065 275d 203d 2027  'cell type'] = '
+00007120: 4e6f 6e2d 7461 7267 6574 270a 2020 2020  Non-target'.    
+00007130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007140: 5832 5b27 4365 6c6c 2074 7970 6527 5d20  X2['Cell type'] 
+00007150: 3d20 740a 2020 2020 2020 2020 2020 2020  = t.            
+00007160: 2020 2020 2020 2020 5820 3d20 7064 2e63          X = pd.c
+00007170: 6f6e 6361 7428 5b58 2c58 325d 2c20 6178  oncat([X,X2], ax
+00007180: 6973 203d 2030 290a 2020 2020 2020 2020  is = 0).        
+00007190: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+000071a0: 2020 2020 2020 2020 2069 6620 5820 6973           if X is
+000071b0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+000071c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000071d0: 2020 2069 6620 636e 7420 3d3d 2030 3a0a     if cnt == 0:.
+000071e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000071f0: 2020 2020 2020 2020 2020 2020 6466 203d              df =
+00007200: 2058 0a20 2020 2020 2020 2020 2020 2020   X.             
+00007210: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00007220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007230: 2020 2020 2020 2020 2020 2020 2064 6620               df 
+00007240: 3d20 7064 2e63 6f6e 6361 7428 5b64 662c  = pd.concat([df,
+00007250: 585d 2c20 6178 6973 203d 2030 290a 2020  X], axis = 0).  
+00007260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007270: 2020 2020 2020 636e 7420 2b3d 2031 0a20        cnt += 1. 
+00007280: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+00007290: 6966 2028 636e 7420 3e20 3029 2026 2053  if (cnt > 0) & S
+000072a0: 4541 424f 524e 3a0a 2020 2020 2020 2020  EABORN:.        
+000072b0: 6e6e 203d 206c 656e 286c 6973 7428 6466  nn = len(list(df
+000072c0: 5b27 4365 6c6c 2074 7970 6527 5d2e 756e  ['Cell type'].un
+000072d0: 6971 7565 2829 2929 0a20 2020 2020 2020  ique())).       
+000072e0: 2070 6c74 2e66 6967 7572 6528 6669 6773   plt.figure(figs
+000072f0: 697a 6520 3d20 2831 2e33 2a6e 6e2a 6669  ize = (1.3*nn*fi
+00007300: 675f 7363 616c 652c 2034 2a66 6967 5f73  g_scale, 4*fig_s
+00007310: 6361 6c65 292c 2064 7069 3d31 3030 290a  cale), dpi=100).
+00007320: 2020 2020 2020 2020 736e 732e 7669 6f6c          sns.viol
+00007330: 696e 706c 6f74 2878 3d22 4365 6c6c 2074  inplot(x="Cell t
+00007340: 7970 6522 2c20 793d 2253 636f 7265 222c  ype", y="Score",
+00007350: 2068 7565 3d22 6365 6c6c 2074 7970 6522   hue="cell type"
+00007360: 2c20 696e 6e65 7220 3d20 696e 6e65 722c  , inner = inner,
+00007370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007380: 2020 2020 2064 6174 613d 6466 2c20 7061       data=df, pa
+00007390: 6c65 7474 653d 226d 7574 6564 222c 2073  lette="muted", s
+000073a0: 706c 6974 3d73 706c 6974 2c20 7363 616c  plit=split, scal
+000073b0: 6520 3d20 7363 616c 652c 200a 2020 2020  e = scale, .    
+000073c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000073d0: 7769 6474 6820 3d20 7769 6474 682c 2066  width = width, f
+000073e0: 6f6e 7473 697a 6520 3d20 3132 2a66 6967  ontsize = 12*fig
+000073f0: 5f73 6361 6c65 2c20 6c69 6e65 7769 6474  _scale, linewidt
+00007400: 6820 3d20 302e 3735 2c20 6772 6964 7369  h = 0.75, gridsi
+00007410: 7a65 203d 2033 3029 0a20 2020 2020 2020  ze = 30).       
+00007420: 2070 6c74 2e78 7469 636b 7328 726f 7461   plt.xticks(rota
+00007430: 7469 6f6e 203d 2032 302c 2068 6120 3d20  tion = 20, ha = 
+00007440: 2763 656e 7465 7227 2c20 666f 6e74 7369  'center', fontsi
+00007450: 7a65 203d 2031 322a 6669 675f 7363 616c  ze = 12*fig_scal
+00007460: 6529 2020 200a 2020 2020 2020 2020 706c  e)   .        pl
+00007470: 742e 7974 6963 6b73 2866 6f6e 7473 697a  t.yticks(fontsiz
+00007480: 6520 3d20 3132 2a66 6967 5f73 6361 6c65  e = 12*fig_scale
+00007490: 290a 2020 2020 2020 2020 706c 742e 7469  ).        plt.ti
+000074a0: 746c 6528 7469 746c 652c 2066 6f6e 7473  tle(title, fonts
+000074b0: 697a 6520 3d20 3133 2a66 6967 5f73 6361  ize = 13*fig_sca
+000074c0: 6c65 290a 2020 2020 2020 2020 706c 742e  le).        plt.
+000074d0: 6c65 6765 6e64 2866 6f6e 7473 697a 6520  legend(fontsize 
+000074e0: 3d20 3130 2a66 6967 5f73 6361 6c65 290a  = 10*fig_scale).
+000074f0: 2020 2020 2020 2020 2320 706c 742e 786c          # plt.xl
+00007500: 6162 656c 2827 4365 6c6c 2074 7970 6527  abel('Cell type'
+00007510: 2c20 666f 6e74 7369 7a65 203d 2031 3229  , fontsize = 12)
+00007520: 0a20 2020 2020 2020 2070 6c74 2e78 6c61  .        plt.xla
+00007530: 6265 6c28 4e6f 6e65 290a 2020 2020 2020  bel(None).      
+00007540: 2020 6966 206c 6f67 3a0a 2020 2020 2020    if log:.      
+00007550: 2020 2020 2020 706c 742e 796c 6162 656c        plt.ylabel
+00007560: 2827 4c6f 6732 2831 2b53 636f 7265 2927  ('Log2(1+Score)'
+00007570: 2c20 666f 6e74 7369 7a65 203d 2031 322a  , fontsize = 12*
+00007580: 6669 675f 7363 616c 6529 0a20 2020 2020  fig_scale).     
+00007590: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000075a0: 2020 2020 2070 6c74 2e79 6c61 6265 6c28       plt.ylabel(
+000075b0: 2753 636f 7265 272c 2066 6f6e 7473 697a  'Score', fontsiz
+000075c0: 6520 3d20 3132 2a66 6967 5f73 6361 6c65  e = 12*fig_scale
+000075d0: 290a 2020 2020 2020 2020 706c 742e 7368  ).        plt.sh
+000075e0: 6f77 2829 0a20 2020 2065 6c69 6620 6e6f  ow().    elif no
+000075f0: 7420 5345 4142 4f52 4e3a 0a20 2020 2020  t SEABORN:.     
+00007600: 2020 2070 7269 6e74 2827 5741 524e 494e     print('WARNIN
+00007610: 473a 2073 6561 626f 726e 2069 7320 6e6f  G: seaborn is no
+00007620: 7420 696e 7374 616c 6c65 642e 2729 0a20  t installed.'). 
+00007630: 2020 2072 6574 7572 6e20 0a0a 0a64 6566     return ...def
+00007640: 2070 6c6f 745f 726f 635f 7265 7375 6c74   plot_roc_result
+00007650: 2864 665f 7363 6f72 652c 2079 5f74 7275  (df_score, y_tru
+00007660: 652c 2063 656c 6c5f 7479 7065 2c20 6d65  e, cell_type, me
+00007670: 7468 6f64 203d 2027 676d 6d27 2c20 6669  thod = 'gmm', fi
+00007680: 675f 7363 616c 6520 3d20 3129 3a0a 2020  g_scale = 1):.  
+00007690: 2020 0a20 2020 206c 6162 656c 203d 206c    .    label = l
+000076a0: 6973 7428 6466 5f73 636f 7265 2e63 6f6c  ist(df_score.col
+000076b0: 756d 6e73 2e76 616c 7565 7329 0a20 2020  umns.values).   
+000076c0: 200a 2020 2020 6273 203d 2079 5f74 7275   .    bs = y_tru
+000076d0: 6520 3d3d 206c 6162 656c 5b30 5d20 0a20  e == label[0] . 
+000076e0: 2020 2066 6f72 206c 2069 6e20 6c61 6265     for l in labe
+000076f0: 6c5b 313a 5d3a 0a20 2020 2020 2020 2062  l[1:]:.        b
+00007700: 7320 3d20 6273 207c 2028 795f 7472 7565  s = bs | (y_true
+00007710: 203d 3d20 6c29 0a20 2020 200a 2020 2020   == l).    .    
+00007720: 706c 742e 6669 6775 7265 2866 6967 7369  plt.figure(figsi
+00007730: 7a65 3d28 342a 6669 675f 7363 616c 652c  ze=(4*fig_scale,
+00007740: 2034 2a66 6967 5f73 6361 6c65 292c 2064   4*fig_scale), d
+00007750: 7069 3d31 3030 290a 2020 2020 636c 7374  pi=100).    clst
+00007760: 203d 205b 2764 6172 6b6f 7261 6e67 6527   = ['darkorange'
+00007770: 2c20 2772 6564 272c 2027 676f 6c64 272c  , 'red', 'gold',
+00007780: 2027 7965 6c6c 6f77 272c 2027 6669 7265   'yellow', 'fire
+00007790: 6272 6963 6b27 2c20 276f 7261 6e67 6527  brick', 'orange'
+000077a0: 2c20 5c0a 2020 2020 2020 2020 2020 2020  , \.            
+000077b0: 276d 6167 656e 7461 272c 2027 6372 696d  'magenta', 'crim
+000077c0: 736f 6e27 2c20 2776 696f 6c65 7427 2c20  son', 'violet', 
+000077d0: 276d 6564 6975 6d6f 7263 6869 6427 2c20  'mediumorchid', 
+000077e0: 2770 7572 706c 6527 2c20 5c0a 2020 2020  'purple', \.    
+000077f0: 2020 2020 2020 2020 2762 6c75 6576 696f          'bluevio
+00007800: 6c65 7427 2c20 276c 696d 6527 2c20 2774  let', 'lime', 't
+00007810: 7572 7175 6f69 7365 275d 2a34 0a0a 2020  urquoise']*4..  
+00007820: 2020 616c 6c5f 6365 6c6c 7320 3d20 2727    all_cells = ''
+00007830: 0a20 2020 2066 7072 7320 3d20 5b5d 0a20  .    fprs = []. 
+00007840: 2020 2074 7072 7320 3d20 5b5d 0a20 2020     tprs = [].   
+00007850: 2061 7563 7320 3d20 5b5d 0a20 2020 2063   aucs = [].    c
+00007860: 656c 6c73 3d20 5b5d 0a20 2020 2073 7320  ells= [].    ss 
+00007870: 3d20 300a 2020 2020 666f 7220 6b2c 206c  = 0.    for k, l
+00007880: 2069 6e20 656e 756d 6572 6174 6528 6c61   in enumerate(la
+00007890: 6265 6c29 3a0a 2020 2020 2020 2020 2369  bel):.        #i
+000078a0: 6620 286b 2534 203d 3d20 3029 2026 2028  f (k%4 == 0) & (
+000078b0: 6b3e 3029 3a0a 2020 2020 2020 2020 6966  k>0):.        if
+000078c0: 2028 6b3e 3029 2026 2028 286c 656e 2861   (k>0) & ((len(a
+000078d0: 6c6c 5f63 656c 6c73 2920 2b20 6c65 6e28  ll_cells) + len(
+000078e0: 6c29 202b 2032 202d 2073 7329 203e 2034  l) + 2 - ss) > 4
+000078f0: 3529 3a0a 2020 2020 2020 2020 2020 2020  5):.            
+00007900: 7373 203d 206c 656e 2861 6c6c 5f63 656c  ss = len(all_cel
+00007910: 6c73 2920 2b20 310a 2020 2020 2020 2020  ls) + 1.        
+00007920: 2020 2020 616c 6c5f 6365 6c6c 7320 3d20      all_cells = 
+00007930: 616c 6c5f 6365 6c6c 7320 2b20 275c 6e27  all_cells + '\n'
+00007940: 0a20 2020 2020 2020 2061 6c6c 5f63 656c  .        all_cel
+00007950: 6c73 203d 2061 6c6c 5f63 656c 6c73 202b  ls = all_cells +
+00007960: 2027 2573 2c20 2720 2520 6c0a 2020 2020   '%s, ' % l.    
+00007970: 2020 2020 0a20 2020 2020 2020 200a 2020      .        .  
+00007980: 2020 2020 2020 795f 636f 6e66 5f31 203d        y_conf_1 =
+00007990: 2064 665f 7363 6f72 652e 6c6f 635b 6273   df_score.loc[bs
+000079a0: 2c20 6c5d 0a20 2020 2020 2020 200a 2020  , l].        .  
+000079b0: 2020 2020 2020 6c61 6265 6c5f 746d 7020        label_tmp 
+000079c0: 3d20 636f 7079 2e64 6565 7063 6f70 7928  = copy.deepcopy(
+000079d0: 6c61 6265 6c29 0a20 2020 2020 2020 206c  label).        l
+000079e0: 6162 656c 5f74 6d70 2e72 656d 6f76 6528  abel_tmp.remove(
+000079f0: 6c29 0a20 2020 2020 2020 2079 5f63 6f6e  l).        y_con
+00007a00: 665f 3020 3d20 6466 5f73 636f 7265 2e6c  f_0 = df_score.l
+00007a10: 6f63 5b62 732c 206c 6162 656c 5f74 6d70  oc[bs, label_tmp
+00007a20: 5d2e 6d61 7828 6178 6973 203d 2031 290a  ].max(axis = 1).
+00007a30: 0a20 2020 2020 2020 2079 5f6f 6464 203d  .        y_odd =
+00007a40: 2079 5f63 6f6e 665f 3120 2320 2d20 795f   y_conf_1 # - y_
+00007a50: 636f 6e66 5f30 0a0a 2020 2020 2020 2020  conf_0..        
+00007a60: 626e 203d 207e 6e70 2e69 736e 616e 2879  bn = ~np.isnan(y
+00007a70: 5f6f 6464 290a 2020 2020 2020 2020 795f  _odd).        y_
+00007a80: 6f64 6420 3d20 795f 6f64 645b 626e 5d0a  odd = y_odd[bn].
+00007a90: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00007aa0: 2079 203d 2079 5f74 7275 655b 6273 2662   y = y_true[bs&b
+00007ab0: 6e5d 0a0a 2020 2020 2020 2020 7461 7267  n]..        targ
+00007ac0: 6574 203d 206c 0a20 2020 2020 2020 2069  et = l.        i
+00007ad0: 6620 2879 203d 3d20 7461 7267 6574 292e  f (y == target).
+00007ae0: 7375 6d28 2920 3e20 313a 0a20 2020 2020  sum() > 1:.     
+00007af0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00007b00: 2020 2020 2020 2020 2020 2020 6670 722c              fpr,
+00007b10: 2074 7072 2c20 5f20 3d20 726f 635f 6375   tpr, _ = roc_cu
+00007b20: 7276 6528 792e 7261 7665 6c28 292c 2079  rve(y.ravel(), y
+00007b30: 5f6f 6464 2e72 6176 656c 2829 2c20 706f  _odd.ravel(), po
+00007b40: 735f 6c61 6265 6c20 3d20 7461 7267 6574  s_label = target
+00007b50: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00007b60: 2020 726f 635f 6175 6320 3d20 6175 6328    roc_auc = auc(
+00007b70: 6670 722c 2074 7072 290a 2020 2020 2020  fpr, tpr).      
+00007b80: 2020 2020 2020 2020 2020 6670 7273 2e61            fprs.a
+00007b90: 7070 656e 6428 6670 7229 0a20 2020 2020  ppend(fpr).     
+00007ba0: 2020 2020 2020 2020 2020 2074 7072 732e             tprs.
+00007bb0: 6170 7065 6e64 2874 7072 290a 2020 2020  append(tpr).    
+00007bc0: 2020 2020 2020 2020 2020 2020 6175 6373              aucs
+00007bd0: 2e61 7070 656e 6428 726f 635f 6175 6329  .append(roc_auc)
+00007be0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007bf0: 2063 656c 6c73 2e61 7070 656e 6428 7461   cells.append(ta
+00007c00: 7267 6574 290a 2020 2020 2020 2020 2020  rget).          
+00007c10: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
+00007c20: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
+00007c30: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00007c40: 2070 7269 6e74 2879 290a 2020 2020 2020   print(y).      
+00007c50: 2020 2020 2020 2020 2020 2320 7072 696e            # prin
+00007c60: 7428 795f 6f64 6429 0a0a 2020 2020 616c  t(y_odd)..    al
+00007c70: 6c5f 6365 6c6c 7320 3d20 6365 6c6c 5f74  l_cells = cell_t
+00007c80: 7970 650a 2020 2020 6f64 7220 3d20 6e70  ype.    odr = np
+00007c90: 2e61 7272 6179 2861 7563 7329 2e61 7267  .array(aucs).arg
+00007ca0: 736f 7274 2829 0a20 2020 2066 6f72 206b  sort().    for k
+00007cb0: 2c20 6f20 696e 2065 6e75 6d65 7261 7465  , o in enumerate
+00007cc0: 2872 6576 6572 7365 6428 6f64 7229 293a  (reversed(odr)):
+00007cd0: 0a20 2020 2020 2020 2074 6974 6c65 203d  .        title =
+00007ce0: 2022 2573 2028 4155 4320 3d20 2530 2e33   "%s (AUC = %0.3
+00007cf0: 6629 2220 2520 286c 6162 656c 5b6f 5d2c  f)" % (label[o],
+00007d00: 2061 7563 735b 6f5d 290a 2020 2020 2020   aucs[o]).      
+00007d10: 2020 706c 742e 706c 6f74 2866 7072 735b    plt.plot(fprs[
+00007d20: 6f5d 2c20 7470 7273 5b6f 5d2c 206c 6162  o], tprs[o], lab
+00007d30: 656c 3d74 6974 6c65 2920 232c 2063 6f6c  el=title) #, col
+00007d40: 6f72 3d63 6c73 745b 6b5d 290a 2020 2020  or=clst[k]).    
+00007d50: 2020 2020 2020 2020 0a20 2020 2070 6c74          .    plt
+00007d60: 2e70 6c6f 7428 5b30 2c20 315d 2c20 5b30  .plot([0, 1], [0
+00007d70: 2c20 315d 2c20 636f 6c6f 723d 226e 6176  , 1], color="nav
+00007d80: 7922 2c20 6c77 3d32 2c20 6c69 6e65 7374  y", lw=2, linest
+00007d90: 796c 653d 222d 2d22 290a 2020 2020 706c  yle="--").    pl
+00007da0: 742e 786c 696d 285b 302e 302c 2031 2e30  t.xlim([0.0, 1.0
+00007db0: 5d29 0a20 2020 2070 6c74 2e79 6c69 6d28  ]).    plt.ylim(
+00007dc0: 5b30 2e30 2c20 312e 3035 5d29 0a20 2020  [0.0, 1.05]).   
+00007dd0: 2070 6c74 2e78 6c61 6265 6c28 2246 616c   plt.xlabel("Fal
+00007de0: 7365 2050 6f73 6974 6976 6520 5261 7465  se Positive Rate
+00007df0: 222c 2066 6f6e 7473 697a 6520 3d20 3132  ", fontsize = 12
+00007e00: 2a66 6967 5f73 6361 6c65 2920 232c 2066  *fig_scale) #, f
+00007e10: 6f6e 7473 697a 6520 3d20 3131 290a 2020  ontsize = 11).  
+00007e20: 2020 706c 742e 796c 6162 656c 2822 5472    plt.ylabel("Tr
+00007e30: 7565 2050 6f73 6974 6976 6520 5261 7465  ue Positive Rate
+00007e40: 222c 2066 6f6e 7473 697a 6520 3d20 3132  ", fontsize = 12
+00007e50: 2a66 6967 5f73 6361 6c65 2920 232c 2066  *fig_scale) #, f
+00007e60: 6f6e 7473 697a 6520 3d20 3131 290a 0a20  ontsize = 11).. 
+00007e70: 2020 2069 6620 6d65 7468 6f64 203d 3d20     if method == 
+00007e80: 2767 6d6d 273a 0a20 2020 2020 2020 204d  'gmm':.        M
+00007e90: 6574 686f 6420 3d20 2747 6175 7373 6961  ethod = 'Gaussia
+00007ea0: 6e20 4d69 7874 7572 6520 4d6f 6465 6c27  n Mixture Model'
+00007eb0: 0a20 2020 2020 2020 2074 6974 6c65 203d  .        title =
+00007ec0: 2022 524f 4320 666f 7220 6964 656e 7469   "ROC for identi
+00007ed0: 6679 696e 6720 2573 5c6e 7573 696e 6720  fying %s\nusing 
+00007ee0: 2573 2220 2520 2861 6c6c 5f63 656c 6c73  %s" % (all_cells
+00007ef0: 2c20 4d65 7468 6f64 290a 2020 2020 656c  , Method).    el
+00007f00: 6966 206d 6574 686f 6420 3d3d 2027 6c6f  if method == 'lo
+00007f10: 6772 6567 273a 0a20 2020 2020 2020 204d  greg':.        M
+00007f20: 6574 686f 6420 3d20 274c 6f67 6973 7469  ethod = 'Logisti
+00007f30: 6320 5265 6772 6573 7369 6f6e 204d 6f64  c Regression Mod
+00007f40: 656c 270a 2020 2020 2020 2020 7469 746c  el'.        titl
+00007f50: 6520 3d20 2252 4f43 2066 6f72 2069 6465  e = "ROC for ide
+00007f60: 6e74 6966 7969 6e67 2025 735c 6e75 7369  ntifying %s\nusi
+00007f70: 6e67 2025 7322 2025 2028 616c 6c5f 6365  ng %s" % (all_ce
+00007f80: 6c6c 732c 204d 6574 686f 6429 0a20 2020  lls, Method).   
+00007f90: 2065 6c73 653a 0a20 2020 2020 2020 204d   else:.        M
+00007fa0: 6574 686f 6420 3d20 6d65 7468 6f64 0a20  ethod = method. 
+00007fb0: 2020 2020 2020 2074 6974 6c65 203d 2022         title = "
+00007fc0: 524f 4320 666f 7220 6964 656e 7469 6679  ROC for identify
+00007fd0: 696e 675c 6e25 7320 7573 696e 6720 2573  ing\n%s using %s
+00007fe0: 2220 2520 2861 6c6c 5f63 656c 6c73 2c20  " % (all_cells, 
+00007ff0: 4d65 7468 6f64 290a 0a20 2020 2070 6c74  Method)..    plt
+00008000: 2e74 6974 6c65 2874 6974 6c65 2c20 666f  .title(title, fo
+00008010: 6e74 7369 7a65 203d 2031 332a 6669 675f  ntsize = 13*fig_
+00008020: 7363 616c 6520 290a 2020 2020 706c 742e  scale ).    plt.
+00008030: 6c65 6765 6e64 286c 6f63 3d22 6c6f 7765  legend(loc="lowe
+00008040: 7220 7269 6768 7422 2c20 666f 6e74 7369  r right", fontsi
+00008050: 7a65 203d 2031 302a 6669 675f 7363 616c  ze = 10*fig_scal
+00008060: 6529 0a20 2020 2023 2070 6c74 2e6c 6567  e).    # plt.leg
+00008070: 656e 6428 6c6f 633d 2275 7070 6572 206c  end(loc="upper l
+00008080: 6566 7422 2c20 6262 6f78 5f74 6f5f 616e  eft", bbox_to_an
+00008090: 6368 6f72 3d28 312e 3033 2c20 3129 2920  chor=(1.03, 1)) 
+000080a0: 2320 2c20 666f 6e74 7369 7a65 203d 2031  # , fontsize = 1
+000080b0: 3229 0a20 2020 2070 6c74 2e73 686f 7728  2).    plt.show(
+000080c0: 290a 2020 2020 0a20 2020 2072 6574 7572  ).    .    retur
+000080d0: 6e20 6365 6c6c 732c 2061 7563 730a 0a0a  n cells, aucs...
+000080e0: 6465 6620 7368 6f77 5f73 756d 6d61 7279  def show_summary
+000080f0: 2820 6466 5f70 7265 642c 2073 756d 6d61  ( df_pred, summa
+00008100: 7279 2c20 7074 685f 6669 745f 706e 7420  ry, pth_fit_pnt 
+00008110: 3d20 302e 332c 206c 6576 656c 203d 2033  = 0.3, level = 3
+00008120: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+00008130: 2020 2020 2020 2073 706c 6974 203d 2054         split = T
+00008140: 7275 652c 2073 6361 6c65 203d 2027 6172  rue, scale = 'ar
+00008150: 6561 272c 2069 6e6e 6572 203d 2027 7175  ea', inner = 'qu
+00008160: 6172 7469 6c65 272c 200a 2020 2020 2020  artile', .      
+00008170: 2020 2020 2020 2020 2020 2020 2020 766c                vl
+00008180: 6f67 203d 2054 7275 652c 2076 7769 6474  og = True, vwidt
+00008190: 6820 3d20 312c 2066 6967 5f73 6361 6c65  h = 1, fig_scale
+000081a0: 203d 2031 2029 3a0a 2020 2020 0a20 2020   = 1 ):.    .   
+000081b0: 2073 6d72 795f 7265 7320 3d20 7375 6d6d   smry_res = summ
+000081c0: 6172 795b 2747 5341 5f73 756d 6d61 7279  ary['GSA_summary
+000081d0: 275d 0a20 2020 2070 7661 6c5f 7468 2c20  '].    pval_th, 
+000081e0: 7074 685f 6d75 6c74 2c20 7074 685f 6d69  pth_mult, pth_mi
+000081f0: 6e20 3d20 7375 6d6d 6172 795b 2770 6172  n = summary['par
+00008200: 616d 6574 6572 7327 5d0a 2020 2020 0a20  ameters'].    . 
+00008210: 2020 2023 2320 436c 7573 7465 7220 6669     ## Cluster fi
+00008220: 6c74 6572 0a20 2020 2079 5f63 6c75 7374  lter.    y_clust
+00008230: 203d 2064 665f 7072 6564 5b27 636c 7573   = df_pred['clus
+00008240: 7465 7227 5d2e 6173 7479 7065 2869 6e74  ter'].astype(int
+00008250: 2920 2d20 310a 2020 2020 7363 6f72 6520  ) - 1.    score 
+00008260: 3d20 736d 7279 5f72 6573 5b27 4d61 6a6f  = smry_res['Majo
+00008270: 725f 5479 7065 275d 5b27 2d6c 6f67 5027  r_Type']['-logP'
+00008280: 5d0a 2020 2020 7074 6820 3d20 7076 616c  ].    pth = pval
+00008290: 5f74 6820 2320 736d 7279 5f72 6573 5b27  _th # smry_res['
+000082a0: 5076 616c 5f74 6872 6573 686f 6c64 275d  Pval_threshold']
+000082b0: 0a20 2020 2023 2727 270a 2020 2020 6966  .    #'''.    if
+000082c0: 206c 6576 656c 203e 2030 3a0a 2020 2020   level > 0:.    
+000082d0: 2020 2020 6669 6e64 5f70 6374 5f63 7574      find_pct_cut
+000082e0: 6f66 6628 7363 6f72 652c 2079 5f63 6c75  off(score, y_clu
+000082f0: 7374 2c20 7074 6820 3d20 2d6e 702e 6c6f  st, pth = -np.lo
+00008300: 6731 3028 7074 6829 2c20 0a20 2020 2020  g10(pth), .     
+00008310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008320: 2020 2070 6374 5f66 6974 5f70 6e74 203d     pct_fit_pnt =
+00008330: 2070 7468 5f66 6974 5f70 6e74 2c20 7063   pth_fit_pnt, pc
+00008340: 745f 6d69 6e5f 7266 203d 2070 7468 5f6d  t_min_rf = pth_m
+00008350: 696e 2c20 0a20 2020 2020 2020 2020 2020  in, .           
+00008360: 2020 2020 2020 2020 2020 2020 2066 6967               fig
+00008370: 7369 7a65 203d 2028 352a 6669 675f 7363  size = (5*fig_sc
+00008380: 616c 652c 342a 6669 675f 7363 616c 6529  ale,4*fig_scale)
+00008390: 2c20 7072 696e 745f 7265 706f 7274 203d  , print_report =
+000083a0: 2054 7275 6529 0a20 2020 2023 2727 270a   True).    #'''.
+000083b0: 0a20 2020 2023 2320 4753 4120 524f 430a  .    ## GSA ROC.
+000083c0: 2020 2020 736d 7279 5f73 636f 7265 203d      smry_score =
+000083d0: 2073 756d 6d61 7279 5b27 4753 415f 7363   summary['GSA_sc
+000083e0: 6f72 6573 275d 0a20 2020 206b 6579 7320  ores'].    keys 
+000083f0: 3d20 6c69 7374 2873 6d72 795f 7363 6f72  = list(smry_scor
+00008400: 652e 6b65 7973 2829 290a 0a20 2020 206b  e.keys())..    k
+00008410: 6579 203d 2027 4d61 6a6f 725f 5479 7065  ey = 'Major_Type
+00008420: 270a 2020 2020 6466 5f73 636f 7265 203d  '.    df_score =
+00008430: 2073 6d72 795f 7363 6f72 655b 6b65 795d   smry_score[key]
+00008440: 0a20 2020 2079 7320 3d20 736d 7279 5f72  .    ys = smry_r
+00008450: 6573 5b6b 6579 5d5b 2763 656c 6c5f 7479  es[key]['cell_ty
+00008460: 7065 275d 0a20 2020 2023 2069 6620 6c65  pe'].    # if le
+00008470: 7665 6c20 3e20 313a 0a20 2020 2063 656c  vel > 1:.    cel
+00008480: 6c73 2c20 6175 6373 203d 2070 6c6f 745f  ls, aucs = plot_
+00008490: 726f 635f 7265 7375 6c74 2864 665f 7363  roc_result(df_sc
+000084a0: 6f72 652c 2079 732c 206b 6579 2c20 2747  ore, ys, key, 'G
+000084b0: 5341 272c 2066 6967 5f73 6361 6c65 203d  SA', fig_scale =
+000084c0: 2066 6967 5f73 6361 6c65 2920 2020 200a   fig_scale)    .
+000084d0: 2020 2020 6466 5f61 7563 5f6d 616a 203d      df_auc_maj =
+000084e0: 2070 642e 4461 7461 4672 616d 6528 7b27   pd.DataFrame({'
+000084f0: 4155 4320 7573 696e 6720 4753 4127 3a20  AUC using GSA': 
+00008500: 6175 6373 7d2c 2069 6e64 6578 203d 2063  aucs}, index = c
+00008510: 656c 6c73 290a 2020 2020 2020 2020 0a20  ells).        . 
+00008520: 2020 2023 2320 4944 206d 6f64 656c 2052     ## ID model R
+00008530: 4f43 0a20 2020 2073 6d72 795f 7363 6f72  OC.    smry_scor
+00008540: 6520 3d20 7375 6d6d 6172 795b 2749 6465  e = summary['Ide
+00008550: 6e74 6966 6963 6174 696f 6e5f 6d6f 6465  ntification_mode
+00008560: 6c5f 7363 6f72 6573 275d 0a20 2020 206b  l_scores'].    k
+00008570: 6579 7320 3d20 6c69 7374 2873 6d72 795f  eys = list(smry_
+00008580: 7363 6f72 652e 6b65 7973 2829 290a 0a20  score.keys()).. 
+00008590: 2020 206b 6579 203d 2027 4d61 6a6f 725f     key = 'Major_
+000085a0: 5479 7065 270a 2020 2020 6466 5f73 636f  Type'.    df_sco
+000085b0: 7265 203d 2073 6d72 795f 7363 6f72 655b  re = smry_score[
+000085c0: 6b65 795d 0a20 2020 2079 7320 3d20 736d  key].    ys = sm
+000085d0: 7279 5f72 6573 5b6b 6579 5d5b 2763 656c  ry_res[key]['cel
+000085e0: 6c5f 7479 7065 275d 0a20 2020 2023 2069  l_type'].    # i
+000085f0: 6620 6c65 7665 6c20 3e20 313a 0a20 2020  f level > 1:.   
+00008600: 2063 656c 6c73 2c20 6175 6373 203d 2070   cells, aucs = p
+00008610: 6c6f 745f 726f 635f 7265 7375 6c74 2864  lot_roc_result(d
+00008620: 665f 7363 6f72 652c 2079 732c 206b 6579  f_score, ys, key
+00008630: 2c20 2767 6d6d 272c 2066 6967 5f73 6361  , 'gmm', fig_sca
+00008640: 6c65 203d 2066 6967 5f73 6361 6c65 2920  le = fig_scale) 
+00008650: 2020 200a 2020 2020 6466 5f61 7563 5f6d     .    df_auc_m
+00008660: 616a 5b27 4155 4320 7573 696e 6720 474d  aj['AUC using GM
+00008670: 4d27 5d20 3d20 6175 6373 0a0a 2020 2020  M'] = aucs..    
+00008680: 2323 2047 5341 2073 636f 7265 2068 6973  ## GSA score his
+00008690: 746f 6772 616d 0a20 2020 2069 6620 6c65  togram.    if le
+000086a0: 7665 6c20 3e20 323a 0a20 2020 2020 2020  vel > 2:.       
+000086b0: 2073 6d72 795f 7363 6f72 6520 3d20 7375   smry_score = su
+000086c0: 6d6d 6172 795b 2747 5341 5f73 636f 7265  mmary['GSA_score
+000086d0: 7327 5d0a 2020 2020 2020 2020 666f 7220  s'].        for 
+000086e0: 6b65 7920 696e 2073 6d72 795f 7363 6f72  key in smry_scor
+000086f0: 652e 6b65 7973 2829 3a0a 2020 2020 2020  e.keys():.      
+00008700: 2020 2020 2020 6466 5f73 636f 7265 203d        df_score =
+00008710: 2073 6d72 795f 7363 6f72 655b 6b65 795d   smry_score[key]
+00008720: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00008730: 6973 696e 7374 616e 6365 2864 665f 7363  isinstance(df_sc
+00008740: 6f72 652c 2070 642e 4461 7461 4672 616d  ore, pd.DataFram
+00008750: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00008760: 2020 2020 706c 6f74 5f47 5341 5f73 636f      plot_GSA_sco
+00008770: 7265 5f76 696f 6c69 6e28 6466 5f73 636f  re_violin(df_sco
+00008780: 7265 2c20 7469 746c 6520 3d20 6b65 792c  re, title = key,
+00008790: 2073 706c 6974 203d 2073 706c 6974 2c20   split = split, 
+000087a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000087b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000087c0: 2020 2020 2020 2073 6361 6c65 203d 2073         scale = s
+000087d0: 6361 6c65 2c20 696e 6e65 7220 3d20 696e  cale, inner = in
+000087e0: 6e65 722c 200a 2020 2020 2020 2020 2020  ner, .          
+000087f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008800: 2020 2020 2020 2020 2020 2020 6c6f 6720              log 
+00008810: 3d20 766c 6f67 2c20 7769 6474 6820 3d20  = vlog, width = 
+00008820: 7677 6964 7468 2c20 6669 675f 7363 616c  vwidth, fig_scal
+00008830: 6520 3d20 6669 675f 7363 616c 6529 0a0a  e = fig_scale)..
+00008840: 2020 2020 2323 2047 5341 2073 636f 7265      ## GSA score
+00008850: 2068 6973 746f 6772 616d 0a20 2020 2069   histogram.    i
+00008860: 6620 6c65 7665 6c20 3e20 323a 0a20 2020  f level > 2:.   
+00008870: 2020 2020 2069 6620 2752 6566 5f73 636f       if 'Ref_sco
+00008880: 7265 7327 2069 6e20 6c69 7374 2873 756d  res' in list(sum
+00008890: 6d61 7279 2e6b 6579 7328 2929 3a0a 2020  mary.keys()):.  
+000088a0: 2020 2020 2020 2020 2020 736d 7279 5f73            smry_s
+000088b0: 636f 7265 203d 2073 756d 6d61 7279 5b27  core = summary['
+000088c0: 5265 665f 7363 6f72 6573 275d 0a20 2020  Ref_scores'].   
+000088d0: 2020 2020 2065 6c73 653a 200a 2020 2020       else: .    
+000088e0: 2020 2020 2020 2020 736d 7279 5f73 636f          smry_sco
+000088f0: 7265 203d 2073 756d 6d61 7279 5b27 4753  re = summary['GS
+00008900: 415f 7363 6f72 6573 275d 0a20 2020 2020  A_scores'].     
+00008910: 2020 2073 6d72 795f 7265 7320 3d20 7375     smry_res = su
+00008920: 6d6d 6172 795b 2747 5341 5f73 756d 6d61  mmary['GSA_summa
+00008930: 7279 275d 0a20 2020 2020 2020 2063 6e74  ry'].        cnt
+00008940: 203d 2030 0a20 2020 2020 2020 2066 6f72   = 0.        for
+00008950: 206b 6579 2069 6e20 736d 7279 5f73 636f   key in smry_sco
+00008960: 7265 2e6b 6579 7328 293a 0a20 2020 2020  re.keys():.     
+00008970: 2020 2020 2020 2064 665f 7363 6f72 6520         df_score 
+00008980: 3d20 736d 7279 5f73 636f 7265 5b6b 6579  = smry_score[key
+00008990: 5d0a 2020 2020 2020 2020 2020 2020 7973  ].            ys
+000089a0: 203d 2073 6d72 795f 7265 735b 6b65 795d   = smry_res[key]
+000089b0: 5b27 6365 6c6c 5f74 7970 6527 5d0a 2020  ['cell_type'].  
+000089c0: 2020 2020 2020 2020 2020 6966 2028 276d            if ('m
+000089d0: 696e 6f72 2720 696e 206b 6579 2920 2620  inor' in key) & 
+000089e0: 286b 6579 2021 3d20 274d 616a 6f72 5f54  (key != 'Major_T
+000089f0: 7970 6527 2920 2620 286c 6576 656c 203e  ype') & (level >
+00008a00: 2031 2920 2620 2864 665f 7363 6f72 652e   1) & (df_score.
+00008a10: 7368 6170 655b 315d 203e 2031 293a 0a20  shape[1] > 1):. 
+00008a20: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00008a30: 656c 6c73 2c20 6175 6373 203d 2070 6c6f  ells, aucs = plo
+00008a40: 745f 726f 635f 7265 7375 6c74 2864 665f  t_roc_result(df_
+00008a50: 7363 6f72 652c 2079 732c 206b 6579 2c20  score, ys, key, 
+00008a60: 2747 5341 2729 2020 2020 0a20 2020 2020  'GSA')    .     
+00008a70: 2020 2020 2020 2020 2020 2069 6620 636e             if cn
+00008a80: 7420 3d3d 2030 3a0a 2020 2020 2020 2020  t == 0:.        
+00008a90: 2020 2020 2020 2020 2020 2020 6466 5f61              df_a
+00008aa0: 7563 5f6d 696e 203d 2070 642e 4461 7461  uc_min = pd.Data
+00008ab0: 4672 616d 6528 7b27 4155 4320 7573 696e  Frame({'AUC usin
+00008ac0: 6720 4753 4127 3a20 6175 6373 7d2c 2069  g GSA': aucs}, i
+00008ad0: 6e64 6578 203d 2063 656c 6c73 290a 2020  ndex = cells).  
+00008ae0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00008af0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00008b00: 2020 2020 2020 2020 6466 5f61 7563 5f6d          df_auc_m
+00008b10: 696e 203d 2070 642e 636f 6e63 6174 285b  in = pd.concat([
+00008b20: 6466 5f61 7563 5f6d 696e 2c20 7064 2e44  df_auc_min, pd.D
+00008b30: 6174 6146 7261 6d65 287b 2741 5543 273a  ataFrame({'AUC':
+00008b40: 2061 7563 737d 2c20 696e 6465 7820 3d20   aucs}, index = 
+00008b50: 6365 6c6c 7329 5d2c 2061 7869 7320 3d20  cells)], axis = 
+00008b60: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
+00008b70: 2020 2063 6e74 202b 3d20 310a 2020 2020     cnt += 1.    
+00008b80: 2020 2020 6966 2063 6e74 203d 3d20 303a      if cnt == 0:
+00008b90: 0a20 2020 2020 2020 2020 2020 2064 665f  .            df_
+00008ba0: 6175 635f 6d69 6e20 3d20 4e6f 6e65 0a20  auc_min = None. 
+00008bb0: 2020 2020 2020 2020 2020 2020 2020 200a                 .
+00008bc0: 2020 2020 2020 2020 636e 7420 3d20 300a          cnt = 0.
+00008bd0: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
+00008be0: 696e 2073 6d72 795f 7363 6f72 652e 6b65  in smry_score.ke
+00008bf0: 7973 2829 3a0a 2020 2020 2020 2020 2020  ys():.          
+00008c00: 2020 6466 5f73 636f 7265 203d 2073 6d72    df_score = smr
+00008c10: 795f 7363 6f72 655b 6b65 795d 0a20 2020  y_score[key].   
+00008c20: 2020 2020 2020 2020 2079 7320 3d20 736d           ys = sm
+00008c30: 7279 5f72 6573 5b6b 6579 5d5b 2763 656c  ry_res[key]['cel
+00008c40: 6c5f 7479 7065 275d 0a20 2020 2020 2020  l_type'].       
+00008c50: 2020 2020 2069 6620 2827 6d69 6e6f 7227       if ('minor'
+00008c60: 206e 6f74 2069 6e20 6b65 7929 2026 2028   not in key) & (
+00008c70: 6b65 7920 213d 2027 4d61 6a6f 725f 5479  key != 'Major_Ty
+00008c80: 7065 2729 2026 2028 6c65 7665 6c20 3e20  pe') & (level > 
+00008c90: 3129 2026 2028 6466 5f73 636f 7265 2e73  1) & (df_score.s
+00008ca0: 6861 7065 5b31 5d20 3e20 3129 3a0a 2020  hape[1] > 1):.  
+00008cb0: 2020 2020 2020 2020 2020 2020 2020 6365                ce
+00008cc0: 6c6c 732c 2061 7563 7320 3d20 706c 6f74  lls, aucs = plot
+00008cd0: 5f72 6f63 5f72 6573 756c 7428 6466 5f73  _roc_result(df_s
+00008ce0: 636f 7265 2c20 7973 2c20 6b65 792c 2027  core, ys, key, '
+00008cf0: 4753 4127 2920 2020 200a 2020 2020 2020  GSA')    .      
+00008d00: 2020 2020 2020 2020 2020 6966 2063 6e74            if cnt
+00008d10: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
+00008d20: 2020 2020 2020 2020 2020 2064 665f 6175             df_au
+00008d30: 6320 3d20 7064 2e44 6174 6146 7261 6d65  c = pd.DataFrame
+00008d40: 287b 2741 5543 273a 2061 7563 737d 2c20  ({'AUC': aucs}, 
+00008d50: 696e 6465 7820 3d20 6365 6c6c 7329 0a20  index = cells). 
+00008d60: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00008d70: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00008d80: 2020 2020 2020 2020 2064 665f 6175 6320           df_auc 
+00008d90: 3d20 7064 2e63 6f6e 6361 7428 5b64 665f  = pd.concat([df_
+00008da0: 6175 632c 2070 642e 4461 7461 4672 616d  auc, pd.DataFram
+00008db0: 6528 7b27 4155 4327 3a20 6175 6373 7d2c  e({'AUC': aucs},
+00008dc0: 2069 6e64 6578 203d 2063 656c 6c73 295d   index = cells)]
+00008dd0: 2c20 6178 6973 203d 2030 290a 2020 2020  , axis = 0).    
+00008de0: 2020 2020 2020 2020 2020 2020 636e 7420              cnt 
+00008df0: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
+00008e00: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
+00008e10: 2063 6e74 203d 3d20 303a 0a20 2020 2020   cnt == 0:.     
+00008e20: 2020 2020 2020 2064 665f 6175 6320 3d20         df_auc = 
+00008e30: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00008e40: 2020 2020 2020 0a20 2020 2023 2320 4753        .    ## GS
+00008e50: 4120 7363 6f72 6520 6869 7374 6f67 7261  A score histogra
+00008e60: 6d0a 2020 2020 6966 206c 6576 656c 203e  m.    if level >
+00008e70: 2032 3a0a 2020 2020 2020 2020 6966 2027   2:.        if '
+00008e80: 5265 665f 7363 6f72 6573 2720 696e 206c  Ref_scores' in l
+00008e90: 6973 7428 7375 6d6d 6172 792e 6b65 7973  ist(summary.keys
+00008ea0: 2829 293a 0a20 2020 2020 2020 2020 2020  ()):.           
+00008eb0: 2073 6d72 795f 7363 6f72 6520 3d20 7375   smry_score = su
+00008ec0: 6d6d 6172 795b 2752 6566 5f73 636f 7265  mmary['Ref_score
+00008ed0: 7327 5d0a 2020 2020 2020 2020 2020 2020  s'].            
+00008ee0: 666f 7220 6b65 7920 696e 2073 6d72 795f  for key in smry_
+00008ef0: 7363 6f72 652e 6b65 7973 2829 3a0a 2020  score.keys():.  
+00008f00: 2020 2020 2020 2020 2020 2020 2020 6466                df
+00008f10: 5f73 636f 7265 203d 2073 6d72 795f 7363  _score = smry_sc
+00008f20: 6f72 655b 6b65 795d 0a20 2020 2020 2020  ore[key].       
+00008f30: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+00008f40: 7374 616e 6365 2864 665f 7363 6f72 652c  stance(df_score,
+00008f50: 2070 642e 4461 7461 4672 616d 6529 3a0a   pd.DataFrame):.
+00008f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008f70: 2020 2020 706c 6f74 5f47 5341 5f73 636f      plot_GSA_sco
+00008f80: 7265 5f76 696f 6c69 6e28 6466 5f73 636f  re_violin(df_sco
+00008f90: 7265 2c20 7469 746c 6520 3d20 6b65 792c  re, title = key,
+00008fa0: 2073 706c 6974 203d 2073 706c 6974 2c20   split = split, 
+00008fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008fd0: 2020 2020 2020 2020 2020 2073 6361 6c65             scale
+00008fe0: 203d 2073 6361 6c65 2c20 696e 6e65 7220   = scale, inner 
+00008ff0: 3d20 696e 6e65 722c 200a 2020 2020 2020  = inner, .      
+00009000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009020: 2020 2020 6c6f 6720 3d20 4661 6c73 652c      log = False,
+00009030: 2077 6964 7468 203d 2076 7769 6474 682c   width = vwidth,
+00009040: 2066 6967 5f73 6361 6c65 203d 2066 6967   fig_scale = fig
+00009050: 5f73 6361 6c65 290a 0a20 2020 2072 6574  _scale)..    ret
+00009060: 7572 6e20 6466 5f61 7563 5f6d 616a 2c20  urn df_auc_maj, 
+00009070: 6466 5f61 7563 5f6d 696e 2c20 6466 5f61  df_auc_min, df_a
+00009080: 7563 0a0a 2020 2020 0a64 6566 2058 5f6e  uc..    .def X_n
+00009090: 6f72 6d61 6c69 7a65 2858 293a 2020 2020  ormalize(X):    
+000090a0: 0a20 2020 2072 6574 7572 6e20 582e 6469  .    return X.di
+000090b0: 7628 582e 7375 6d28 6178 6973 3d31 292a  v(X.sum(axis=1)*
+000090c0: 302e 3030 3031 202b 2030 2e30 3030 312c  0.0001 + 0.0001,
+000090d0: 2061 7869 7320 3d20 3029 0a0a 0a64 6566   axis = 0)...def
+000090e0: 2058 5f73 6361 6c65 2858 2c20 6d61 785f   X_scale(X, max_
+000090f0: 7661 6c20 3d20 3130 293a 2020 2020 0a20  val = 10):    . 
+00009100: 2020 206d 203d 2058 2e6d 6561 6e28 6178     m = X.mean(ax
+00009110: 6973 203d 2030 290a 2020 2020 7320 3d20  is = 0).    s = 
+00009120: 582e 7374 6428 6178 6973 203d 2030 290a  X.std(axis = 0).
+00009130: 2020 2020 0a20 2020 2058 7320 3d20 582e      .    Xs = X.
+00009140: 7375 6228 6d29 2e6d 756c 2828 7320 3e20  sub(m).mul((s > 
+00009150: 3029 2f28 732b 2030 2e30 3030 3129 290a  0)/(s+ 0.0001)).
+00009160: 2020 2020 5873 2e63 6c69 7028 7570 7065      Xs.clip(uppe
+00009170: 7220 3d20 6d61 785f 7661 6c2c 206c 6f77  r = max_val, low
+00009180: 6572 203d 202d 6d61 785f 7661 6c2c 2069  er = -max_val, i
+00009190: 6e70 6c61 6365 203d 2054 7275 6529 0a20  nplace = True). 
+000091a0: 2020 200a 2020 2020 7265 7475 726e 2058     .    return X
+000091b0: 730a 0a0a 6465 6620 7365 6c65 6374 5f76  s...def select_v
+000091c0: 6172 6961 626c 655f 6765 6e65 735f 6f6c  ariable_genes_ol
+000091d0: 6428 582c 206c 6f67 5f74 7261 6e73 666f  d(X, log_transfo
+000091e0: 726d 6564 203d 2046 616c 7365 2c20 4e5f  rmed = False, N_
+000091f0: 6765 6e65 7320 3d20 3230 3030 293a 0a20  genes = 2000):. 
+00009200: 2020 200a 2020 2020 2727 270a 2020 2020     .    '''.    
+00009210: 6966 206c 6f67 5f74 7261 6e73 666f 726d  if log_transform
+00009220: 6564 3a0a 2020 2020 2020 2020 5873 203d  ed:.        Xs =
+00009230: 2031 302a 2a58 0a20 2020 2020 2020 2058   10**X.        X
+00009240: 7320 3d20 5873 202d 2058 732e 6d69 6e28  s = Xs - Xs.min(
+00009250: 292e 6d69 6e28 290a 2020 2020 656c 7365  ).min().    else
+00009260: 3a0a 2020 2020 2727 270a 2020 2020 5873  :.    '''.    Xs
+00009270: 203d 2058 200a 2020 2020 2020 2020 0a20   = X .        . 
+00009280: 2020 2073 6d20 3d20 2858 7320 3e20 3029     sm = (Xs > 0)
+00009290: 2e73 756d 2861 7869 7320 3d20 3029 0a20  .sum(axis = 0). 
+000092a0: 2020 206d 203d 2058 732e 6d65 616e 2861     m = Xs.mean(a
+000092b0: 7869 7320 3d20 3029 0a20 2020 2073 203d  xis = 0).    s =
+000092c0: 2058 732e 7661 7228 6178 6973 203d 2030   Xs.var(axis = 0
+000092d0: 290a 0a20 2020 2074 6820 3d20 6d61 7828  )..    th = max(
+000092e0: 3130 2c20 5873 2e73 6861 7065 5b30 5d2a  10, Xs.shape[0]*
+000092f0: 302e 3030 3229 0a20 2020 2062 203d 2028  0.002).    b = (
+00009300: 6d20 3e20 3029 2026 2028 7320 3e20 3029  m > 0) & (s > 0)
+00009310: 2026 2028 736d 203e 2074 6829 0a20 2020   & (sm > th).   
+00009320: 200a 2020 2020 7072 696e 7428 6e70 2e73   .    print(np.s
+00009330: 756d 286d 203e 2030 292c 6e70 2e73 756d  um(m > 0),np.sum
+00009340: 2873 203e 2030 292c 6e70 2e73 756d 2873  (s > 0),np.sum(s
+00009350: 6d20 3e20 7468 292c 206c 656e 286d 2929  m > th), len(m))
+00009360: 0a20 2020 200a 2020 2020 6d20 3d20 6d5b  .    .    m = m[
+00009370: 625d 0a20 2020 2073 203d 2073 5b62 5d0a  b].    s = s[b].
+00009380: 2020 2020 5873 203d 2058 732e 6c6f 635b      Xs = Xs.loc[
+00009390: 3a2c 625d 0a20 2020 2020 2020 200a 2020  :,b].        .  
+000093a0: 2020 2323 2053 656c 6563 7420 6765 6e65    ## Select gene
+000093b0: 730a 2020 2020 7873 6d20 3d20 5873 2e73  s.    xsm = Xs.s
+000093c0: 756d 2861 7869 7320 3d20 3029 0a20 2020  um(axis = 0).   
+000093d0: 206f 6472 203d 206e 702e 6172 7261 7928   odr = np.array(
+000093e0: 7873 6d29 2e61 7267 736f 7274 2829 0a20  xsm).argsort(). 
+000093f0: 2020 206c 6320 3d20 696e 7428 6c65 6e28     lc = int(len(
+00009400: 6f64 7229 2a30 2e31 290a 2020 2020 7563  odr)*0.1).    uc
+00009410: 203d 2069 6e74 286c 656e 286f 6472 292a   = int(len(odr)*
+00009420: 302e 3929 0a20 2020 2078 736d 5f73 656c  0.9).    xsm_sel
+00009430: 203d 2078 736d 5b6f 6472 5b6c 633a 7563   = xsm[odr[lc:uc
+00009440: 5d5d 0a20 2020 206d 696e 5f78 736d 203d  ]].    min_xsm =
+00009450: 2078 736d 5f73 656c 2e6d 696e 2829 0a20   xsm_sel.min(). 
+00009460: 2020 206d 6178 5f78 736d 203d 2078 736d     max_xsm = xsm
+00009470: 5f73 656c 2e6d 6178 2829 0a20 2020 204e  _sel.max().    N
+00009480: 7320 3d20 3130 0a20 2020 2064 7820 3d20  s = 10.    dx = 
+00009490: 286d 6178 5f78 736d 202d 206d 696e 5f78  (max_xsm - min_x
+000094a0: 736d 292f 4e73 0a20 2020 200a 2020 2020  sm)/Ns.    .    
+000094b0: 726e 6720 3d20 6e70 2e61 7261 6e67 6528  rng = np.arange(
+000094c0: 6d69 6e5f 7873 6d2c 206d 6178 5f78 736d  min_xsm, max_xsm
+000094d0: 2b28 4e73 2f32 292c 2064 7829 0a20 2020  +(Ns/2), dx).   
+000094e0: 206e 7373 203d 205b 5d0a 2020 2020 666f   nss = [].    fo
+000094f0: 7220 6e20 696e 2072 616e 6765 284e 7329  r n in range(Ns)
+00009500: 3a0a 2020 2020 2020 2020 6c63 203d 2072  :.        lc = r
+00009510: 6e67 5b6e 5d0a 2020 2020 2020 2020 7563  ng[n].        uc
+00009520: 203d 2072 6e67 5b6e 2b31 5d0a 2020 2020   = rng[n+1].    
+00009530: 2020 2020 6278 203d 2028 7873 6d20 3e3d      bx = (xsm >=
+00009540: 206c 6329 2026 2028 7873 6d20 3c20 7563   lc) & (xsm < uc
+00009550: 290a 2020 2020 2020 2020 6e73 732e 6170  ).        nss.ap
+00009560: 7065 6e64 286e 702e 7375 6d28 6278 2929  pend(np.sum(bx))
+00009570: 0a20 2020 2020 2020 200a 2020 2020 4e5f  .        .    N_
+00009580: 746f 5f73 656c 203d 2069 6e74 286e 702e  to_sel = int(np.
+00009590: 6d65 616e 286e 7373 2929 0a20 2020 2069  mean(nss)).    i
+000095a0: 6620 4e5f 746f 5f73 656c 203c 2034 3030  f N_to_sel < 400
+000095b0: 3a0a 2020 2020 2020 2020 4e5f 746f 5f73  :.        N_to_s
+000095c0: 656c 203d 2069 6e74 2834 3030 290a 2020  el = int(400).  
+000095d0: 2020 2320 7072 696e 7428 4e5f 746f 5f73    # print(N_to_s
+000095e0: 656c 2c20 6e70 2e6d 6178 286e 7373 292c  el, np.max(nss),
+000095f0: 206e 702e 6d69 6e28 6e73 7329 2c20 6e70   np.min(nss), np
+00009600: 2e6d 6564 6961 6e28 6e73 7329 290a 2020  .median(nss)).  
+00009610: 2020 2020 2020 0a20 2020 2062 6720 3d20        .    bg = 
+00009620: 7873 6d20 3c20 300a 2020 2020 6964 7820  xsm < 0.    idx 
+00009630: 3d20 6267 2e69 6e64 6578 2e76 616c 7565  = bg.index.value
+00009640: 730a 2020 2020 6e70 2e72 616e 646f 6d2e  s.    np.random.
+00009650: 7365 6564 2830 290a 2020 2020 666f 7220  seed(0).    for 
+00009660: 6e20 696e 2072 616e 6765 284e 7329 3a0a  n in range(Ns):.
+00009670: 2020 2020 2020 2020 6c63 203d 2072 6e67          lc = rng
+00009680: 5b6e 5d0a 2020 2020 2020 2020 7563 203d  [n].        uc =
+00009690: 2072 6e67 5b6e 2b31 5d0a 2020 2020 2020   rng[n+1].      
+000096a0: 2020 6278 203d 2028 7873 6d20 3e3d 206c    bx = (xsm >= l
+000096b0: 6329 2026 2028 7873 6d20 3c20 7563 290a  c) & (xsm < uc).
+000096c0: 2020 2020 2020 2020 6966 206e 702e 7375          if np.su
+000096d0: 6d28 6278 2920 3c3d 204e 5f74 6f5f 7365  m(bx) <= N_to_se
+000096e0: 6c3a 0a20 2020 2020 2020 2020 2020 2062  l:.            b
+000096f0: 675b 6278 5d20 3d20 5472 7565 0a20 2020  g[bx] = True.   
+00009700: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
+00009710: 2827 2569 2f25 692c 2720 2520 286e 702e  ('%i/%i,' % (np.
+00009720: 7375 6d28 6278 292c 204e 5f74 6f5f 7365  sum(bx), N_to_se
+00009730: 6c29 290a 2020 2020 2020 2020 656c 7365  l)).        else
+00009740: 3a0a 2020 2020 2020 2020 2020 2020 696c  :.            il
+00009750: 7374 203d 206c 6973 7428 6964 785b 6278  st = list(idx[bx
+00009760: 5d29 0a20 2020 2020 2020 2020 2020 206c  ]).            l
+00009770: 7374 5f73 656c 203d 206e 702e 7261 6e64  st_sel = np.rand
+00009780: 6f6d 2e63 686f 6963 6528 696c 7374 2c20  om.choice(ilst, 
+00009790: 4e5f 746f 5f73 656c 2c20 7265 706c 6163  N_to_sel, replac
+000097a0: 6520 3d20 4661 6c73 6529 0a20 2020 2020  e = False).     
+000097b0: 2020 2020 2020 2062 675b 6c73 745f 7365         bg[lst_se
+000097c0: 6c5d 203d 2054 7275 650a 2020 2020 2020  l] = True.      
+000097d0: 2020 2020 2020 2320 7072 696e 7428 2725        # print('%
+000097e0: 692f 2569 2c27 2025 2028 6c65 6e28 6c73  i/%i,' % (len(ls
+000097f0: 745f 7365 6c29 2c20 4e5f 746f 5f73 656c  t_sel), N_to_sel
+00009800: 2929 0a20 2020 2020 2020 2020 2020 200a  )).            .
+00009810: 2020 2020 5873 5f73 656c 203d 2058 732e      Xs_sel = Xs.
+00009820: 6c6f 635b 3a2c 6267 5d20 2020 200a 2020  loc[:,bg]    .  
+00009830: 2020 2020 2020 0a20 2020 2023 2320 4669        .    ## Fi
+00009840: 740a 2020 2020 6d5f 7365 6c20 3d20 5873  t.    m_sel = Xs
+00009850: 5f73 656c 2e6d 6561 6e28 6178 6973 203d  _sel.mean(axis =
+00009860: 2030 290a 2020 2020 735f 7365 6c20 3d20   0).    s_sel = 
+00009870: 5873 5f73 656c 2e76 6172 2861 7869 7320  Xs_sel.var(axis 
+00009880: 3d20 3029 0a0a 2020 2020 6c6d 5f73 656c  = 0)..    lm_sel
+00009890: 203d 206e 702e 6c6f 6731 3028 6d5f 7365   = np.log10(m_se
+000098a0: 6c20 2b20 302e 3030 3030 3031 290a 2020  l + 0.000001).  
+000098b0: 2020 6c73 5f73 656c 203d 206e 702e 6c6f    ls_sel = np.lo
+000098c0: 6731 3028 735f 7365 6c20 2b20 302e 3030  g10(s_sel + 0.00
+000098d0: 3030 3031 290a 2020 2020 0a20 2020 207a  0001).    .    z
+000098e0: 203d 206e 702e 706f 6c79 6669 7428 6c6d   = np.polyfit(lm
+000098f0: 5f73 656c 2c20 6c73 5f73 656c 2c20 3229  _sel, ls_sel, 2)
+00009900: 0a20 2020 2070 203d 206e 702e 706f 6c79  .    p = np.poly
+00009910: 3164 287a 290a 2020 2020 0a20 2020 2023  1d(z).    .    #
+00009920: 2320 5365 6c65 6374 2067 656e 6573 0a20  # Select genes. 
+00009930: 2020 206d 203d 2058 732e 6d65 616e 2861     m = Xs.mean(a
+00009940: 7869 7320 3d20 3029 0a20 2020 2073 203d  xis = 0).    s =
+00009950: 2058 732e 7661 7228 6178 6973 203d 2030   Xs.var(axis = 0
+00009960: 290a 0a20 2020 206c 6d20 3d20 6e70 2e6c  )..    lm = np.l
+00009970: 6f67 3130 286d 202b 2030 2e30 3030 3030  og10(m + 0.00000
+00009980: 3129 0a20 2020 206c 7320 3d20 6e70 2e6c  1).    ls = np.l
+00009990: 6f67 3130 2873 202b 2030 2e30 3030 3030  og10(s + 0.00000
+000099a0: 3129 0a20 2020 200a 2020 2020 735f 6669  1).    .    s_fi
+000099b0: 7420 3d20 3130 2a2a 2870 286c 6d29 290a  t = 10**(p(lm)).
+000099c0: 0a20 2020 2058 7420 3d20 5873 2e73 7562  .    Xt = Xs.sub
+000099d0: 286d 292e 6d75 6c28 312f 6e70 2e73 7172  (m).mul(1/np.sqr
+000099e0: 7428 735f 6669 7429 290a 2020 2020 5874  t(s_fit)).    Xt
+000099f0: 2e63 6c69 7028 7570 7065 7220 3d20 6e70  .clip(upper = np
+00009a00: 2e73 7172 7428 5874 2e73 6861 7065 5b30  .sqrt(Xt.shape[0
+00009a10: 5d29 2c20 696e 706c 6163 6520 3d20 5472  ]), inplace = Tr
+00009a20: 7565 290a 0a20 2020 2073 7220 3d20 5874  ue)..    sr = Xt
+00009a30: 2e73 7464 2861 7869 7320 3d20 3029 0a20  .std(axis = 0). 
+00009a40: 2020 206f 6472 203d 206e 702e 6172 7261     odr = np.arra
+00009a50: 7928 7372 292e 6172 6773 6f72 7428 290a  y(sr).argsort().
+00009a60: 2020 2020 735f 7468 203d 2073 725b 6f64      s_th = sr[od
+00009a70: 725b 2d4e 5f67 656e 6573 5d5d 0a20 2020  r[-N_genes]].   
+00009a80: 2067 656e 6573 203d 206c 6973 7428 5874   genes = list(Xt
+00009a90: 2e63 6f6c 756d 6e73 2e76 616c 7565 735b  .columns.values[
+00009aa0: 7372 203e 3d20 735f 7468 5d29 0a20 2020  sr >= s_th]).   
+00009ab0: 200a 2020 2020 7265 7475 726e 2067 656e   .    return gen
+00009ac0: 6573 0a0a 0a64 6566 2073 656c 6563 745f  es...def select_
+00009ad0: 7661 7269 6162 6c65 5f67 656e 6573 286c  variable_genes(l
+00009ae0: 6f67 3170 5f58 2c20 4e5f 6765 6e65 7320  og1p_X, N_genes 
+00009af0: 3d20 3230 3030 293a 0a20 2020 200a 2020  = 2000):.    .  
+00009b00: 2020 5861 203d 206c 6f67 3170 5f58 200a    Xa = log1p_X .
+00009b10: 2020 2020 2020 2020 0a20 2020 2023 2073          .    # s
+00009b20: 6d20 3d20 2858 6120 3e20 3029 2e73 756d  m = (Xa > 0).sum
+00009b30: 2861 7869 7320 3d20 3029 0a20 2020 206d  (axis = 0).    m
+00009b40: 6120 3d20 5861 2e6d 6561 6e28 6178 6973  a = Xa.mean(axis
+00009b50: 203d 2030 290a 2020 2020 7361 203d 2058   = 0).    sa = X
+00009b60: 612e 7374 6428 6178 6973 203d 2030 290a  a.std(axis = 0).
+00009b70: 2020 2020 0a20 2020 2023 2320 5365 6c65      .    ## Sele
+00009b80: 6374 2067 656e 6573 0a20 2020 2078 736d  ct genes.    xsm
+00009b90: 203d 2028 5861 292e 7375 6d28 6178 6973   = (Xa).sum(axis
+00009ba0: 203d 2030 290a 2020 2020 6f64 7220 3d20   = 0).    odr = 
+00009bb0: 6e70 2e61 7272 6179 2878 736d 292e 6172  np.array(xsm).ar
+00009bc0: 6773 6f72 7428 290a 2020 2020 6c63 203d  gsort().    lc =
+00009bd0: 2069 6e74 286c 656e 286f 6472 292a 302e   int(len(odr)*0.
+00009be0: 3035 290a 2020 2020 7563 203d 2069 6e74  05).    uc = int
+00009bf0: 286c 656e 286f 6472 292a 302e 3935 290a  (len(odr)*0.95).
+00009c00: 2020 2020 6d69 6e5f 7873 6d20 3d20 7873      min_xsm = xs
+00009c10: 6d5b 6f64 725b 6c63 5d5d 0a20 2020 206d  m[odr[lc]].    m
+00009c20: 6178 5f78 736d 203d 2078 736d 5b6f 6472  ax_xsm = xsm[odr
+00009c30: 5b75 635d 5d0a 2020 2020 6220 3d20 286d  [uc]].    b = (m
+00009c40: 6120 3e20 3029 2026 2028 7873 6d20 3e20  a > 0) & (xsm > 
+00009c50: 6d69 6e5f 7873 6d29 2026 2028 7873 6d20  min_xsm) & (xsm 
+00009c60: 3c20 6d61 785f 7873 6d29 0a20 2020 200a  < max_xsm).    .
+00009c70: 2020 2020 6d20 3d20 6d61 5b62 5d0a 2020      m = ma[b].  
+00009c80: 2020 7320 3d20 7361 5b62 5d0a 2020 2020    s = sa[b].    
+00009c90: 5873 203d 2058 612e 6c6f 635b 3a2c 625d  Xs = Xa.loc[:,b]
+00009ca0: 0a20 2020 2020 2020 200a 2020 2020 2323  .        .    ##
+00009cb0: 2046 6974 0a20 2020 206d 5f73 656c 203d   Fit.    m_sel =
+00009cc0: 206d 2023 2058 735f 7365 6c2e 6d65 616e   m # Xs_sel.mean
+00009cd0: 2861 7869 7320 3d20 3029 0a20 2020 2073  (axis = 0).    s
+00009ce0: 5f73 656c 203d 2073 2023 2058 735f 7365  _sel = s # Xs_se
+00009cf0: 6c2e 7374 6428 6178 6973 203d 2030 290a  l.std(axis = 0).
+00009d00: 0a20 2020 206c 6d5f 7365 6c20 3d20 6e70  .    lm_sel = np
+00009d10: 2e6c 6f67 3130 286d 5f73 656c 202b 2031  .log10(m_sel + 1
+00009d20: 652d 3130 290a 2020 2020 6c73 5f73 656c  e-10).    ls_sel
+00009d30: 203d 206e 702e 6c6f 6731 3028 735f 7365   = np.log10(s_se
+00009d40: 6c20 2b20 3165 2d31 3029 0a20 2020 200a  l + 1e-10).    .
+00009d50: 2020 2020 7a20 3d20 6e70 2e70 6f6c 7966      z = np.polyf
+00009d60: 6974 286c 6d5f 7365 6c2c 206c 735f 7365  it(lm_sel, ls_se
+00009d70: 6c2c 2032 290a 2020 2020 7020 3d20 6e70  l, 2).    p = np
+00009d80: 2e70 6f6c 7931 6428 7a29 0a20 2020 200a  .poly1d(z).    .
+00009d90: 2020 2020 2323 2053 656c 6563 7420 6765      ## Select ge
+00009da0: 6e65 730a 2020 2020 6d20 3d20 6d61 2023  nes.    m = ma #
+00009db0: 2058 732e 6d65 616e 2861 7869 7320 3d20   Xs.mean(axis = 
+00009dc0: 3029 0a20 2020 2023 2073 203d 2058 732e  0).    # s = Xs.
+00009dd0: 7374 6428 6178 6973 203d 2030 290a 0a20  std(axis = 0).. 
+00009de0: 2020 206c 6d20 3d20 6e70 2e6c 6f67 3130     lm = np.log10
+00009df0: 286d 202b 2031 652d 3130 290a 2020 2020  (m + 1e-10).    
+00009e00: 2320 6c73 203d 206e 702e 6c6f 6731 3028  # ls = np.log10(
+00009e10: 7320 2b20 3165 2d31 3029 0a20 2020 200a  s + 1e-10).    .
+00009e20: 2020 2020 735f 6669 7420 3d20 3130 2a2a      s_fit = 10**
+00009e30: 2870 286c 6d29 290a 0a20 2020 2058 7420  (p(lm))..    Xt 
+00009e40: 3d20 5861 2e73 7562 286d 2c20 6178 6973  = Xa.sub(m, axis
+00009e50: 203d 2031 292e 6d75 6c28 312f 2873 5f66   = 1).mul(1/(s_f
+00009e60: 6974 202b 2031 652d 3130 292c 2061 7869  it + 1e-10), axi
+00009e70: 7320 3d20 3129 0a20 2020 2075 6320 3d20  s = 1).    uc = 
+00009e80: 6e70 2e73 7172 7428 5874 2e73 6861 7065  np.sqrt(Xt.shape
+00009e90: 5b30 5d29 0a20 2020 2058 742e 636c 6970  [0]).    Xt.clip
+00009ea0: 2875 7070 6572 203d 2075 632c 206c 6f77  (upper = uc, low
+00009eb0: 6572 203d 202d 7563 2c20 696e 706c 6163  er = -uc, inplac
+00009ec0: 6520 3d20 5472 7565 290a 0a20 2020 2073  e = True)..    s
+00009ed0: 7220 3d20 5874 2e76 6172 2861 7869 7320  r = Xt.var(axis 
+00009ee0: 3d20 3029 0a20 2020 200a 2020 2020 6d69  = 0).    .    mi
+00009ef0: 6e5f 6c6d 203d 206c 6d2e 6d69 6e28 290a  n_lm = lm.min().
+00009f00: 2020 2020 6d61 785f 6c6d 203d 206c 6d2e      max_lm = lm.
+00009f10: 6d61 7828 290a 2020 2020 4e73 203d 2034  max().    Ns = 4
+00009f20: 300a 2020 2020 6478 203d 2028 6d61 785f  0.    dx = (max_
+00009f30: 6c6d 202d 206d 696e 5f6c 6d29 2f4e 730a  lm - min_lm)/Ns.
+00009f40: 2020 2020 0a20 2020 2072 6e67 203d 206e      .    rng = n
+00009f50: 702e 6172 616e 6765 286d 696e 5f6c 6d2c  p.arange(min_lm,
+00009f60: 206d 6178 5f6c 6d2b 284e 732f 3229 2c20   max_lm+(Ns/2), 
+00009f70: 6478 290a 2020 2020 666f 7220 6e20 696e  dx).    for n in
+00009f80: 2072 616e 6765 284e 7329 3a0a 2020 2020   range(Ns):.    
+00009f90: 2020 2020 6c63 203d 2072 6e67 5b6e 5d0a      lc = rng[n].
+00009fa0: 2020 2020 2020 2020 7563 203d 2072 6e67          uc = rng
+00009fb0: 5b6e 2b31 5d0a 2020 2020 2020 2020 6278  [n+1].        bx
+00009fc0: 203d 2028 6c6d 203e 3d20 6c63 2920 2620   = (lm >= lc) & 
+00009fd0: 286c 6d20 3c20 7563 290a 2020 2020 2020  (lm < uc).      
+00009fe0: 2020 6d73 7220 3d20 6e70 2e6d 6561 6e28    msr = np.mean(
+00009ff0: 7372 5b62 785d 290a 2020 2020 2020 2020  sr[bx]).        
+0000a000: 7372 5b62 785d 203d 2073 725b 6278 5d20  sr[bx] = sr[bx] 
+0000a010: 2d20 6d73 720a 2020 2020 0a20 2020 206f  - msr.    .    o
+0000a020: 6472 203d 206e 702e 6172 7261 7928 7372  dr = np.array(sr
+0000a030: 292e 6172 6773 6f72 7428 290a 2020 2020  ).argsort().    
+0000a040: 735f 7468 203d 2073 725b 6f64 725b 2d4e  s_th = sr[odr[-N
+0000a050: 5f67 656e 6573 5d5d 0a20 2020 2062 7820  _genes]].    bx 
+0000a060: 3d20 7372 203e 3d20 735f 7468 0a20 2020  = sr >= s_th.   
+0000a070: 2067 656e 6573 203d 206c 6973 7428 5874   genes = list(Xt
+0000a080: 2e63 6f6c 756d 6e73 2e76 616c 7565 735b  .columns.values[
+0000a090: 6278 5d29 0a20 2020 200a 2020 2020 7265  bx]).    .    re
+0000a0a0: 7475 726e 2067 656e 6573 0a0a 0a64 6566  turn genes...def
+0000a0b0: 2058 5f70 7265 7072 6f63 6573 7369 6e67   X_preprocessing
+0000a0c0: 2820 5873 2c20 6c6f 675f 7472 616e 7366  ( Xs, log_transf
+0000a0d0: 6f72 6d65 642c 204e 5f67 656e 6573 203d  ormed, N_genes =
+0000a0e0: 2032 3030 3020 293a 0a20 2020 200a 2020   2000 ):.    .  
+0000a0f0: 2020 6966 206e 6f74 206c 6f67 5f74 7261    if not log_tra
+0000a100: 6e73 666f 726d 6564 3a0a 2020 2020 2020  nsformed:.      
+0000a110: 2020 5878 203d 206e 702e 6c6f 6732 2831    Xx = np.log2(1
+0000a120: 202b 2058 5f6e 6f72 6d61 6c69 7a65 2858   + X_normalize(X
+0000a130: 7329 290a 2020 2020 656c 7365 3a0a 2020  s)).    else:.  
+0000a140: 2020 2020 2020 5878 203d 2058 730a 2020        Xx = Xs.  
+0000a150: 2020 2020 2020 0a20 2020 2069 6620 5873        .    if Xs
+0000a160: 2e73 6861 7065 5b31 5d20 3c3d 204e 5f67  .shape[1] <= N_g
+0000a170: 656e 6573 3a0a 2020 2020 2020 2020 5878  enes:.        Xx
+0000a180: 203d 2058 5f73 6361 6c65 2858 782c 206d   = X_scale(Xx, m
+0000a190: 6178 5f76 616c 203d 2031 3029 0a20 2020  ax_val = 10).   
+0000a1a0: 2065 6c73 653a 0a20 2020 2020 2020 2067   else:.        g
+0000a1b0: 656e 655f 7365 6c20 3d20 7365 6c65 6374  ene_sel = select
+0000a1c0: 5f76 6172 6961 626c 655f 6765 6e65 7328  _variable_genes(
+0000a1d0: 5878 2c20 4e5f 6765 6e65 7320 3d20 4e5f  Xx, N_genes = N_
+0000a1e0: 6765 6e65 7320 290a 2020 2020 2020 2020  genes ).        
+0000a1f0: 5878 203d 2058 5f73 6361 6c65 2858 782e  Xx = X_scale(Xx.
+0000a200: 6c6f 635b 3a2c 6765 6e65 5f73 656c 5d2c  loc[:,gene_sel],
+0000a210: 206d 6178 5f76 616c 203d 2031 3029 0a20   max_val = 10). 
+0000a220: 2020 2072 6574 7572 6e20 5878 0a0a 0a64     return Xx...d
+0000a230: 6566 2063 6c75 7374 6572 696e 675f 616c  ef clustering_al
+0000a240: 6728 585f 7063 612c 2063 6c75 7374 5f61  g(X_pca, clust_a
+0000a250: 6c67 6f20 3d20 276c 7627 2c20 4e5f 636c  lgo = 'lv', N_cl
+0000a260: 7573 7465 7273 203d 2032 352c 2072 6573  usters = 25, res
+0000a270: 6f6c 7574 696f 6e20 3d20 312c 204e 5f6e  olution = 1, N_n
+0000a280: 6569 6768 626f 7273 203d 2031 3029 3a0a  eighbors = 10):.
+0000a290: 2020 2020 0a20 2020 2069 6620 636c 7573      .    if clus
+0000a2a0: 745f 616c 676f 5b3a 325d 203d 3d20 2767  t_algo[:2] == 'g
+0000a2b0: 6d27 3a0a 2020 2020 2020 2020 676d 6d20  m':.        gmm 
+0000a2c0: 3d20 6d69 7874 7572 652e 4761 7573 7369  = mixture.Gaussi
+0000a2d0: 616e 4d69 7874 7572 6528 6e5f 636f 6d70  anMixture(n_comp
+0000a2e0: 6f6e 656e 7473 203d 2069 6e74 284e 5f63  onents = int(N_c
+0000a2f0: 6c75 7374 6572 7329 2c20 7261 6e64 6f6d  lusters), random
+0000a300: 5f73 7461 7465 203d 2030 290a 2020 2020  _state = 0).    
+0000a310: 2020 2020 636c 7573 7465 725f 6c61 6265      cluster_labe
+0000a320: 6c20 3d20 676d 6d2e 6669 745f 7072 6564  l = gmm.fit_pred
+0000a330: 6963 7428 6e70 2e61 7272 6179 2858 5f70  ict(np.array(X_p
+0000a340: 6361 2929 0a20 2020 2020 2020 2072 6574  ca)).        ret
+0000a350: 7572 6e20 636c 7573 7465 725f 6c61 6265  urn cluster_labe
+0000a360: 6c2c 2067 6d6d 0a20 2020 2065 6c69 6620  l, gmm.    elif 
+0000a370: 636c 7573 745f 616c 676f 5b3a 325d 203d  clust_algo[:2] =
+0000a380: 3d20 276b 6d27 3a0a 2020 2020 2020 2020  = 'km':.        
+0000a390: 6b6d 203d 2063 6c75 7374 6572 2e4b 4d65  km = cluster.KMe
+0000a3a0: 616e 7328 6e5f 636c 7573 7465 7273 203d  ans(n_clusters =
+0000a3b0: 2069 6e74 284e 5f63 6c75 7374 6572 7329   int(N_clusters)
+0000a3c0: 2c20 7261 6e64 6f6d 5f73 7461 7465 203d  , random_state =
+0000a3d0: 2030 290a 2020 2020 2020 2020 6b6d 2e66   0).        km.f
+0000a3e0: 6974 2858 5f70 6361 290a 2020 2020 2020  it(X_pca).      
+0000a3f0: 2020 636c 7573 7465 725f 6c61 6265 6c20    cluster_label 
+0000a400: 3d20 6b6d 2e6c 6162 656c 735f 0a20 2020  = km.labels_.   
+0000a410: 2020 2020 2072 6574 7572 6e20 636c 7573       return clus
+0000a420: 7465 725f 6c61 6265 6c2c 206b 6d0a 2020  ter_label, km.  
+0000a430: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000a440: 6164 6a20 3d20 6b6e 6569 6768 626f 7273  adj = kneighbors
+0000a450: 5f67 7261 7068 2858 5f70 6361 2c20 696e  _graph(X_pca, in
+0000a460: 7428 4e5f 6e65 6967 6862 6f72 7329 2c20  t(N_neighbors), 
+0000a470: 6d6f 6465 3d27 636f 6e6e 6563 7469 7669  mode='connectivi
+0000a480: 7479 272c 2069 6e63 6c75 6465 5f73 656c  ty', include_sel
+0000a490: 663d 5472 7565 290a 2020 2020 2020 2020  f=True).        
+0000a4a0: 6c6f 7576 6169 6e20 3d20 4c6f 7576 6169  louvain = Louvai
+0000a4b0: 6e28 7265 736f 6c75 7469 6f6e 203d 2072  n(resolution = r
+0000a4c0: 6573 6f6c 7574 696f 6e29 0a20 2020 2020  esolution).     
+0000a4d0: 2020 2069 6620 6861 7361 7474 7228 6c6f     if hasattr(lo
+0000a4e0: 7576 6169 6e2c 2027 6669 745f 7072 6564  uvain, 'fit_pred
+0000a4f0: 6963 7427 293a 0a20 2020 2020 2020 2020  ict'):.         
+0000a500: 2020 2063 6c75 7374 6572 5f6c 6162 656c     cluster_label
+0000a510: 203d 206c 6f75 7661 696e 2e66 6974 5f70   = louvain.fit_p
+0000a520: 7265 6469 6374 2861 646a 2920 2020 2020  redict(adj)     
+0000a530: 2020 200a 2020 2020 2020 2020 656c 7365     .        else
+0000a540: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
+0000a550: 7573 7465 725f 6c61 6265 6c20 3d20 6c6f  uster_label = lo
+0000a560: 7576 6169 6e2e 6669 745f 7472 616e 7366  uvain.fit_transf
+0000a570: 6f72 6d28 6164 6a29 2020 2020 2020 2020  orm(adj)        
+0000a580: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000a590: 636c 7573 7465 725f 6c61 6265 6c2c 206c  cluster_label, l
+0000a5a0: 6f75 7661 696e 0a20 2020 2027 2727 0a20  ouvain.    '''. 
+0000a5b0: 2020 2065 6c69 6620 636c 7573 745f 616c     elif clust_al
+0000a5c0: 676f 5b3a 325d 203d 3d20 276c 6427 3a0a  go[:2] == 'ld':.
+0000a5d0: 2020 2020 2020 2020 6c65 6964 656e 203d          leiden =
+0000a5e0: 204c 6569 6465 6e43 6c75 7374 6572 696e   LeidenClusterin
+0000a5f0: 6728 290a 2020 2020 2020 2020 6c65 6964  g().        leid
+0000a600: 656e 2e66 6974 2858 290a 2020 2020 2020  en.fit(X).      
+0000a610: 2020 636c 7573 7465 725f 6c61 6265 6c20    cluster_label 
+0000a620: 3d20 6c65 6964 656e 2e6c 6162 656c 735f  = leiden.labels_
+0000a630: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000a640: 636c 7573 7465 725f 6c61 6265 6c2c 206b  cluster_label, k
+0000a650: 6d0a 2020 2020 2727 270a 0a0a 6465 6620  m.    '''...def 
+0000a660: 4753 415f 6365 6c6c 5f73 7562 7479 7069  GSA_cell_subtypi
+0000a670: 6e67 2820 585f 6365 6c6c 5f62 795f 6765  ng( X_cell_by_ge
+0000a680: 6e65 2c20 6d6b 7273 5f70 6f73 2c20 6d6b  ne, mkrs_pos, mk
+0000a690: 7273 5f6e 6567 2c20 7665 7262 6f73 6520  rs_neg, verbose 
+0000a6a0: 3d20 4661 6c73 6520 293a 0a20 2020 200a  = False ):.    .
+0000a6b0: 2020 2020 5820 3d20 585f 6365 6c6c 5f62      X = X_cell_b
+0000a6c0: 795f 6765 6e65 2020 2020 0a20 2020 2067  y_gene    .    g
+0000a6d0: 656e 6573 203d 206c 6973 7428 582e 636f  enes = list(X.co
+0000a6e0: 6c75 6d6e 732e 7661 6c75 6573 290a 0a20  lumns.values).. 
+0000a6f0: 2020 206d 6b72 5f6c 7374 5f64 6963 7420     mkr_lst_dict 
+0000a700: 3d20 636f 7079 2e64 6565 7063 6f70 7928  = copy.deepcopy(
+0000a710: 6d6b 7273 5f70 6f73 290a 2020 2020 6d6b  mkrs_pos).    mk
+0000a720: 725f 6c73 745f 6469 6374 5f6e 6567 203d  r_lst_dict_neg =
+0000a730: 2063 6f70 792e 6465 6570 636f 7079 286d   copy.deepcopy(m
+0000a740: 6b72 735f 6e65 6729 0a20 2020 2066 6f72  krs_neg).    for
+0000a750: 206b 6579 2069 6e20 6c69 7374 286d 6b72   key in list(mkr
+0000a760: 5f6c 7374 5f64 6963 742e 6b65 7973 2829  _lst_dict.keys()
+0000a770: 293a 0a20 2020 2020 2020 206d 6b72 7320  ):.        mkrs 
+0000a780: 3d20 6d6b 725f 6c73 745f 6469 6374 5b6b  = mkr_lst_dict[k
+0000a790: 6579 5d0a 2020 2020 2020 2020 6d6b 7273  ey].        mkrs
+0000a7a0: 3220 3d20 6c69 7374 2873 6574 286d 6b72  2 = list(set(mkr
+0000a7b0: 7329 2e69 6e74 6572 7365 6374 696f 6e28  s).intersection(
+0000a7c0: 6765 6e65 7329 2920 2020 200a 2020 2020  genes))    .    
+0000a7d0: 2020 2020 6966 206c 656e 286d 6b72 7332      if len(mkrs2
+0000a7e0: 2920 3c20 6c65 6e28 6d6b 7273 293a 0a20  ) < len(mkrs):. 
+0000a7f0: 2020 2020 2020 2020 2020 206d 6b72 5f6c             mkr_l
+0000a800: 7374 5f64 6963 745b 6b65 795d 203d 206d  st_dict[key] = m
+0000a810: 6b72 7332 0a20 2020 2020 2020 2020 2020  krs2.           
+0000a820: 2073 203d 2027 270a 2020 2020 2020 2020   s = ''.        
+0000a830: 2020 2020 636e 7420 3d20 300a 2020 2020      cnt = 0.    
+0000a840: 2020 2020 2020 2020 666f 7220 6d6b 7220          for mkr 
+0000a850: 696e 206d 6b72 733a 0a20 2020 2020 2020  in mkrs:.       
+0000a860: 2020 2020 2020 2020 2069 6620 6d6b 7220           if mkr 
+0000a870: 6e6f 7420 696e 206d 6b72 7332 3a0a 2020  not in mkrs2:.  
+0000a880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a890: 2020 7320 3d20 7320 2b20 2725 732c 2720    s = s + '%s,' 
+0000a8a0: 2520 6d6b 720a 2020 2020 2020 2020 2020  % mkr.          
+0000a8b0: 2020 2020 2020 2020 2020 636e 7420 2b3d            cnt +=
+0000a8c0: 2031 0a20 2020 2020 2020 2020 2020 2069   1.            i
+0000a8d0: 6620 6c65 6e28 7329 203e 2031 3a0a 2020  f len(s) > 1:.  
+0000a8e0: 2020 2020 2020 2020 2020 2020 2020 7320                s 
+0000a8f0: 3d20 735b 3a2d 315d 0a20 2020 2020 2020  = s[:-1].       
+0000a900: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
+0000a910: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+0000a920: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+0000a930: 2020 2057 4152 4e49 4e47 3a20 2531 3573     WARNING: %15s
+0000a940: 2070 6f73 5f6d 6b72 7320 696e 2064 623a   pos_mkrs in db:
+0000a950: 2025 3369 2c20 7768 6572 6520 2532 6920   %3i, where %2i 
+0000a960: 6d69 7373 696e 6720 2825 7329 2720 2520  missing (%s)' % 
+0000a970: 286b 6579 2c20 6c65 6e28 6d6b 7273 292c  (key, len(mkrs),
+0000a980: 2063 6e74 2c20 7329 290a 2020 2020 2020   cnt, s)).      
+0000a990: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+0000a9a0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000a9b0: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+0000a9c0: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+0000a9d0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0000a9e0: 7428 2725 3135 7320 706f 735f 6d6b 7273  t('%15s pos_mkrs
+0000a9f0: 2069 6e20 6462 203d 2025 3269 2720 2520   in db = %2i' % 
+0000aa00: 286b 6579 2c20 6c65 6e28 6d6b 7273 2929  (key, len(mkrs))
+0000aa10: 290a 2020 2020 2020 2020 2020 2020 2327  ).            #'
+0000aa20: 2727 0a20 2020 2020 2020 2069 6620 6b65  ''.        if ke
+0000aa30: 7920 696e 206d 6b72 5f6c 7374 5f64 6963  y in mkr_lst_dic
+0000aa40: 745f 6e65 672e 6b65 7973 2829 3a0a 2020  t_neg.keys():.  
+0000aa50: 2020 2020 2020 2020 2020 6d6b 7273 3320            mkrs3 
+0000aa60: 3d20 6d6b 725f 6c73 745f 6469 6374 5f6e  = mkr_lst_dict_n
+0000aa70: 6567 5b6b 6579 5d0a 2020 2020 2020 2020  eg[key].        
+0000aa80: 2020 2020 6966 206c 656e 286d 6b72 7333      if len(mkrs3
+0000aa90: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
+0000aaa0: 2020 2020 2020 206d 6b72 7334 203d 206c         mkrs4 = l
+0000aab0: 6973 7428 7365 7428 6d6b 7273 3329 2e69  ist(set(mkrs3).i
+0000aac0: 6e74 6572 7365 6374 696f 6e28 6765 6e65  ntersection(gene
+0000aad0: 7329 2920 2020 200a 2020 2020 2020 2020  s))    .        
+0000aae0: 2020 2020 2020 2020 6966 206c 656e 286d          if len(m
+0000aaf0: 6b72 7334 2920 3c20 6c65 6e28 6d6b 7273  krs4) < len(mkrs
+0000ab00: 3329 3a0a 2020 2020 2020 2020 2020 2020  3):.            
+0000ab10: 2020 2020 2020 2020 6d6b 725f 6c73 745f          mkr_lst_
+0000ab20: 6469 6374 5f6e 6567 5b6b 6579 5d20 3d20  dict_neg[key] = 
+0000ab30: 6d6b 7273 320a 2020 2020 2020 2020 2020  mkrs2.          
+0000ab40: 2020 2020 2020 2020 2020 7320 3d20 2727            s = ''
+0000ab50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ab60: 2020 2020 2063 6e74 203d 2030 0a20 2020       cnt = 0.   
+0000ab70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ab80: 2066 6f72 206d 6b72 2069 6e20 6d6b 7273   for mkr in mkrs
+0000ab90: 333a 0a20 2020 2020 2020 2020 2020 2020  3:.             
+0000aba0: 2020 2020 2020 2020 2020 2069 6620 6d6b             if mk
+0000abb0: 7220 6e6f 7420 696e 206d 6b72 7334 3a0a  r not in mkrs4:.
+0000abc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000abd0: 2020 2020 2020 2020 2020 2020 7320 3d20              s = 
+0000abe0: 7320 2b20 2725 732c 2720 2520 6d6b 720a  s + '%s,' % mkr.
+0000abf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac00: 2020 2020 2020 2020 2020 2020 636e 7420              cnt 
+0000ac10: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
+0000ac20: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+0000ac30: 7329 203e 2031 3a0a 2020 2020 2020 2020  s) > 1:.        
+0000ac40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac50: 7320 3d20 735b 3a2d 315d 0a20 2020 2020  s = s[:-1].     
+0000ac60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac70: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
+0000ac80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac90: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0000aca0: 2827 2020 2057 4152 4e49 4e47 3a20 2531  ('   WARNING: %1
+0000acb0: 3573 206e 6567 5f6d 6b72 7320 696e 2064  5s neg_mkrs in d
+0000acc0: 623a 2025 3369 2c20 7768 6572 6520 2532  b: %3i, where %2
+0000acd0: 6920 6d69 7373 696e 6720 2825 7329 2720  i missing (%s)' 
+0000ace0: 2520 286b 6579 2c20 6c65 6e28 6d6b 7273  % (key, len(mkrs
+0000acf0: 292c 2063 6e74 2c20 7329 290a 0a20 2020  ), cnt, s))..   
+0000ad00: 2020 2020 2020 2020 200a 2020 2020 6966           .    if
+0000ad10: 2076 6572 626f 7365 3a20 7072 696e 7428   verbose: print(
+0000ad20: 2747 5341 202e 2e20 272c 2065 6e64 203d  'GSA .. ', end =
+0000ad30: 2027 2729 0a20 2020 2073 7461 7274 5f74   '').    start_t
+0000ad40: 696d 6520 3d20 7469 6d65 2e74 696d 6528  ime = time.time(
+0000ad50: 290a 2020 2020 0a20 2020 2023 2320 4765  ).    .    ## Ge
+0000ad60: 7420 7374 6174 7320 666f 7220 4344 342b  t stats for CD4+
+0000ad70: 2054 2063 656c 6c73 206f 6e6c 790a 0a20   T cells only.. 
+0000ad80: 2020 2058 6220 3d20 5820 3e20 300a 2020     Xb = X > 0.  
+0000ad90: 2020 4e20 3d20 5862 2e73 6861 7065 5b31    N = Xb.shape[1
+0000ada0: 5d0a 2020 2020 6b20 3d20 5862 2e73 756d  ].    k = Xb.sum
+0000adb0: 2861 7869 7320 3d20 3129 0a0a 2020 2020  (axis = 1)..    
+0000adc0: 6d6b 725f 7374 6174 203d 207b 7d0a 2020  mkr_stat = {}.  
+0000add0: 2020 6466 203d 2070 642e 4461 7461 4672    df = pd.DataFr
+0000ade0: 616d 6528 696e 6465 7820 3d20 5862 2e69  ame(index = Xb.i
+0000adf0: 6e64 6578 2e76 616c 7565 7329 0a20 2020  ndex.values).   
+0000ae00: 2064 666e 203d 2070 642e 4461 7461 4672   dfn = pd.DataFr
+0000ae10: 616d 6528 696e 6465 7820 3d20 5862 2e69  ame(index = Xb.i
+0000ae20: 6e64 6578 2e76 616c 7565 7329 0a0a 2020  ndex.values)..  
+0000ae30: 2020 6e5f 6d6b 7220 3d20 7b7d 0a20 2020    n_mkr = {}.   
+0000ae40: 2066 6f72 206b 6579 2069 6e20 6c69 7374   for key in list
+0000ae50: 286d 6b72 5f6c 7374 5f64 6963 742e 6b65  (mkr_lst_dict.ke
+0000ae60: 7973 2829 293a 0a20 2020 2020 2020 206e  ys()):.        n
+0000ae70: 5f6d 6b72 5b6b 6579 5d20 3d20 6c65 6e28  _mkr[key] = len(
+0000ae80: 6d6b 725f 6c73 745f 6469 6374 5b6b 6579  mkr_lst_dict[key
+0000ae90: 5d29 0a20 2020 2020 2020 2069 6620 6b65  ]).        if ke
+0000aea0: 7920 696e 206d 6b72 5f6c 7374 5f64 6963  y in mkr_lst_dic
+0000aeb0: 745f 6e65 672e 6b65 7973 2829 3a0a 2020  t_neg.keys():.  
+0000aec0: 2020 2020 2020 2020 2020 6e5f 6d6b 725b            n_mkr[
+0000aed0: 6b65 795d 203d 206e 5f6d 6b72 5b6b 6579  key] = n_mkr[key
+0000aee0: 5d20 2b20 6c65 6e28 6d6b 725f 6c73 745f  ] + len(mkr_lst_
+0000aef0: 6469 6374 5f6e 6567 5b6b 6579 5d29 0a20  dict_neg[key]). 
+0000af00: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+0000af10: 666f 7220 6b65 7920 696e 206c 6973 7428  for key in list(
+0000af20: 6d6b 725f 6c73 745f 6469 6374 2e6b 6579  mkr_lst_dict.key
+0000af30: 7328 2929 3a0a 2020 2020 2020 2020 6d6b  s()):.        mk
+0000af40: 7273 203d 206d 6b72 5f6c 7374 5f64 6963  rs = mkr_lst_dic
+0000af50: 745b 6b65 795d 0a20 2020 2020 2020 2062  t[key].        b
+0000af60: 203d 2058 625b 6d6b 7273 5d0a 2020 2020   = Xb[mkrs].    
+0000af70: 2020 2020 6e20 3d20 622e 7375 6d28 6178      n = b.sum(ax
+0000af80: 6973 203d 2031 290a 2020 2020 2020 2020  is = 1).        
+0000af90: 4d20 3d20 6c65 6e28 6d6b 7273 290a 2020  M = len(mkrs).  
+0000afa0: 2020 2020 2020 0a20 2020 2020 2020 2069        .        i
+0000afb0: 6620 6b65 7920 696e 206d 6b72 5f6c 7374  f key in mkr_lst
+0000afc0: 5f64 6963 745f 6e65 672e 6b65 7973 2829  _dict_neg.keys()
+0000afd0: 3a0a 2020 2020 2020 2020 2020 2020 6d6b  :.            mk
+0000afe0: 7273 5f6e 6567 203d 206d 6b72 5f6c 7374  rs_neg = mkr_lst
+0000aff0: 5f64 6963 745f 6e65 675b 6b65 795d 0a20  _dict_neg[key]. 
+0000b000: 2020 2020 2020 2020 2020 2062 5f6e 6567             b_neg
+0000b010: 203d 207e 5862 5b6d 6b72 735f 6e65 675d   = ~Xb[mkrs_neg]
+0000b020: 0a20 2020 2020 2020 2020 2020 206e 203d  .            n =
+0000b030: 206e 202b 2062 5f6e 6567 2e73 756d 2861   n + b_neg.sum(a
+0000b040: 7869 7320 3d20 3129 0a20 2020 2020 2020  xis = 1).       
+0000b050: 2020 2020 204d 203d 204d 202b 206c 656e       M = M + len
+0000b060: 286d 6b72 735f 6e65 6729 0a0a 2020 2020  (mkrs_neg)..    
+0000b070: 2020 2020 6e65 675f 6c6f 675f 7076 616c      neg_log_pval
+0000b080: 203d 202d 6879 7065 7267 656f 6d2e 6c6f   = -hypergeom.lo
+0000b090: 6773 6628 6e2d 312c 204e 2c20 4d2c 206b  gsf(n-1, N, M, k
+0000b0a0: 292a 6e70 2e6c 6f67 3130 286e 702e 6578  )*np.log10(np.ex
+0000b0b0: 7028 3129 290a 2020 2020 2020 2020 6466  p(1)).        df
+0000b0c0: 5b6b 6579 5d20 3d20 6e65 675f 6c6f 675f  [key] = neg_log_
+0000b0d0: 7076 616c 0a20 2020 2020 2020 2064 666e  pval.        dfn
+0000b0e0: 5b6b 6579 5d20 3d20 6e0a 0a20 2020 2023  [key] = n..    #
+0000b0f0: 2320 4765 7420 6669 6e61 6c20 7265 7375  # Get final resu
+0000b100: 6c74 730a 2020 2020 6e75 6d20 3d20 6c69  lts.    num = li
+0000b110: 7374 286e 702e 6172 616e 6765 2864 662e  st(np.arange(df.
+0000b120: 7368 6170 655b 315d 2929 0a20 2020 206e  shape[1])).    n
+0000b130: 616d 6520 3d20 6c69 7374 2864 662e 636f  ame = list(df.co
+0000b140: 6c75 6d6e 732e 7661 6c75 6573 290a 2020  lumns.values).  
+0000b150: 2020 7472 616e 735f 6469 6374 203d 2064    trans_dict = d
+0000b160: 6963 7428 7a69 7028 6e75 6d2c 6e61 6d65  ict(zip(num,name
+0000b170: 2929 0a20 2020 200a 2020 2020 6966 206c  )).    .    if l
+0000b180: 656e 286d 6b72 5f6c 7374 5f64 6963 742e  en(mkr_lst_dict.
+0000b190: 6b65 7973 2829 2920 3d3d 2031 3a0a 2020  keys()) == 1:.  
+0000b1a0: 2020 2020 2020 6320 3d20 6e61 6d65 5b30        c = name[0
+0000b1b0: 5d0a 2020 2020 2020 2020 6e65 675f 6c6f  ].        neg_lo
+0000b1c0: 675f 7076 616c 203d 2064 665b 635d 0a20  g_pval = df[c]. 
+0000b1d0: 2020 2020 2020 2073 7562 7479 7065 203d         subtype =
+0000b1e0: 205b 635d 2a64 662e 7368 6170 655b 305d   [c]*df.shape[0]
+0000b1f0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+0000b200: 2020 2320 6466 5f72 6573 203d 2070 642e    # df_res = pd.
+0000b210: 4461 7461 4672 616d 6528 7b27 4344 342b  DataFrame({'CD4+
+0000b220: 2054 2063 656c 6c20 7375 6274 7970 6527   T cell subtype'
+0000b230: 3a20 7463 5f73 7562 7479 7065 2c20 274e  : tc_subtype, 'N
+0000b240: 6567 4c6f 6750 7661 6c27 3a20 6e65 675f  egLogPval': neg_
+0000b250: 6c6f 675f 7076 616c 7d2c 2069 6e64 6578  log_pval}, index
+0000b260: 203d 2064 662e 696e 6465 782e 7661 6c75   = df.index.valu
+0000b270: 6573 290a 2020 2020 2020 2020 6466 5f72  es).        df_r
+0000b280: 6573 203d 2070 642e 4461 7461 4672 616d  es = pd.DataFram
+0000b290: 6528 7b27 6365 6c6c 5f74 7970 6527 3a20  e({'cell_type': 
+0000b2a0: 7375 6274 7970 652c 2027 6365 6c6c 5f74  subtype, 'cell_t
+0000b2b0: 7970 6528 7265 7629 273a 2073 7562 7479  ype(rev)': subty
+0000b2c0: 7065 2c20 0a20 2020 2020 2020 2020 2020  pe, .           
+0000b2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b2e0: 2020 2020 2763 656c 6c5f 7479 7065 2831      'cell_type(1
+0000b2f0: 7374 2927 3a20 7375 6274 7970 652c 2027  st)': subtype, '
+0000b300: 4f76 6572 6c61 7027 3a20 6466 6e5b 635d  Overlap': dfn[c]
+0000b310: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+0000b320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b330: 2020 2320 6474 7970 653d 7b27 6365 6c6c    # dtype={'cell
+0000b340: 5f74 7970 6527 3a20 7374 722c 2027 6365  _type': str, 'ce
+0000b350: 6c6c 5f74 7970 6528 7265 7629 273a 2073  ll_type(rev)': s
+0000b360: 7472 2c20 2763 656c 6c5f 7479 7065 2831  tr, 'cell_type(1
+0000b370: 7374 2927 3a20 7374 722c 2027 4f76 6572  st)': str, 'Over
+0000b380: 6c61 7027 3a20 696e 747d 2c0a 2020 2020  lap': int},.    
+0000b390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b3a0: 2020 2020 2020 2020 2020 2069 6e64 6578             index
+0000b3b0: 203d 2064 662e 696e 6465 782e 7661 6c75   = df.index.valu
+0000b3c0: 6573 290a 2020 2020 2020 2020 6466 5f72  es).        df_r
+0000b3d0: 6573 5b27 6365 6c6c 5f74 7970 6528 326e  es['cell_type(2n
+0000b3e0: 6429 275d 203d 204e 6f6e 650a 2020 2020  d)'] = None.    
+0000b3f0: 2020 2020 6466 5f72 6573 5b27 6365 6c6c      df_res['cell
+0000b400: 5f74 7970 6528 326e 6429 275d 203d 2064  _type(2nd)'] = d
+0000b410: 665f 7265 735b 2763 656c 6c5f 7479 7065  f_res['cell_type
+0000b420: 2832 6e64 2927 5d2e 6173 7479 7065 2873  (2nd)'].astype(s
+0000b430: 7472 290a 2020 2020 2020 2020 6466 5f72  tr).        df_r
+0000b440: 6573 5b27 4f76 6572 6c61 7028 326e 6429  es['Overlap(2nd)
+0000b450: 275d 203d 204e 6f6e 650a 2020 2020 2020  '] = None.      
+0000b460: 2020 6466 5f72 6573 5b27 4f76 6572 6c61    df_res['Overla
+0000b470: 7028 326e 6429 275d 203d 2064 665f 7265  p(2nd)'] = df_re
+0000b480: 735b 274f 7665 726c 6170 2832 6e64 2927  s['Overlap(2nd)'
+0000b490: 5d2e 6173 7479 7065 2873 7472 290a 2020  ].astype(str).  
+0000b4a0: 2020 2020 2020 6466 5f72 6573 5b27 436c        df_res['Cl
+0000b4b0: 6172 6974 7927 5d20 3d20 5b27 2d27 5d2a  arity'] = ['-']*
+0000b4c0: 6466 2e73 6861 7065 5b30 5d0a 2020 2020  df.shape[0].    
+0000b4d0: 2020 2020 6466 5f72 6573 5b27 2d6c 6f67      df_res['-log
+0000b4e0: 5027 5d20 3d20 6466 5b63 5d0a 2020 2020  P'] = df[c].    
+0000b4f0: 2020 2020 6466 5f72 6573 5b27 2d6c 6f67      df_res['-log
+0000b500: 5028 326e 6429 275d 203d 2030 0a20 2020  P(2nd)'] = 0.   
+0000b510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b520: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0000b530: 2020 2020 2064 665f 7265 735b 272d 6c6f       df_res['-lo
+0000b540: 6750 2d6c 6f67 5028 326e 6429 275d 203d  gP-logP(2nd)'] =
+0000b550: 2064 665b 635d 0a20 2020 2065 6c73 653a   df[c].    else:
+0000b560: 0a20 2020 2020 2020 206e 6567 5f6c 6f67  .        neg_log
+0000b570: 5f70 7661 6c20 3d20 6466 2e6d 6178 2861  _pval = df.max(a
+0000b580: 7869 7320 3d20 3129 0a20 2020 2020 2020  xis = 1).       
+0000b590: 2073 7562 7479 7065 203d 206c 6973 7428   subtype = list(
+0000b5a0: 6466 2e69 6478 6d61 7828 6178 6973 203d  df.idxmax(axis =
+0000b5b0: 2031 2929 0a20 2020 2020 2020 2023 7463   1)).        #tc
+0000b5c0: 5f73 7562 7479 7065 203d 205b 7472 616e  _subtype = [tran
+0000b5d0: 735f 6469 6374 5b6b 5d20 666f 7220 6b20  s_dict[k] for k 
+0000b5e0: 696e 2074 635f 7375 6274 7970 655d 0a0a  in tc_subtype]..
+0000b5f0: 2020 2020 2020 2020 6d61 7876 203d 205b          maxv = [
+0000b600: 5d0a 2020 2020 2020 2020 6d61 7876 3220  ].        maxv2 
+0000b610: 3d20 5b5d 0a20 2020 2020 2020 2069 6478  = [].        idx
+0000b620: 3220 3d20 5b5d 0a20 2020 2020 2020 204e  2 = [].        N
+0000b630: 6e20 3d20 5b5d 0a20 2020 2020 2020 204e  n = [].        N
+0000b640: 3120 3d20 5b5d 0a20 2020 2020 2020 204e  1 = [].        N
+0000b650: 3220 3d20 5b5d 0a20 2020 2020 2020 2073  2 = [].        s
+0000b660: 7562 7479 7065 5f6c 7374 203d 206c 6973  ubtype_lst = lis
+0000b670: 7428 6466 2e63 6f6c 756d 6e73 2e76 616c  t(df.columns.val
+0000b680: 7565 7329 0a0a 2020 2020 2020 2020 666f  ues)..        fo
+0000b690: 7220 6920 696e 2072 616e 6765 2864 662e  r i in range(df.
+0000b6a0: 7368 6170 655b 305d 293a 0a20 2020 2020  shape[0]):.     
+0000b6b0: 2020 2020 2020 2078 203d 206e 702e 6172         x = np.ar
+0000b6c0: 7261 7928 6466 2e69 6c6f 635b 695d 290a  ray(df.iloc[i]).
+0000b6d0: 2020 2020 2020 2020 2020 2020 6e20 3d20              n = 
+0000b6e0: 6e70 2e61 7272 6179 2864 666e 2e69 6c6f  np.array(dfn.ilo
+0000b6f0: 635b 695d 290a 2020 2020 2020 2020 2020  c[i]).          
+0000b700: 2020 6f64 7220 3d20 282d 7829 2e61 7267    odr = (-x).arg
+0000b710: 736f 7274 2829 0a20 2020 2020 2020 2020  sort().         
+0000b720: 2020 206d 6178 762e 6170 7065 6e64 2878     maxv.append(x
+0000b730: 5b6f 6472 5b30 5d5d 290a 2020 2020 2020  [odr[0]]).      
+0000b740: 2020 2020 2020 6d61 7876 322e 6170 7065        maxv2.appe
+0000b750: 6e64 2878 5b6f 6472 5b31 5d5d 290a 2020  nd(x[odr[1]]).  
+0000b760: 2020 2020 2020 2020 2020 6964 7832 2e61            idx2.a
+0000b770: 7070 656e 6428 7375 6274 7970 655f 6c73  ppend(subtype_ls
+0000b780: 745b 6f64 725b 315d 5d29 0a0a 2020 2020  t[odr[1]])..    
+0000b790: 2020 2020 2020 2020 6b31 203d 206e 5f6d          k1 = n_m
+0000b7a0: 6b72 5b73 7562 7479 7065 5f6c 7374 5b6f  kr[subtype_lst[o
+0000b7b0: 6472 5b30 5d5d 5d0a 2020 2020 2020 2020  dr[0]]].        
+0000b7c0: 2020 2020 6b32 203d 206e 5f6d 6b72 5b73      k2 = n_mkr[s
+0000b7d0: 7562 7479 7065 5f6c 7374 5b6f 6472 5b31  ubtype_lst[odr[1
+0000b7e0: 5d5d 5d0a 2020 2020 2020 2020 2020 2020  ]]].            
+0000b7f0: 6e31 203d 206e 5b6f 6472 5b30 5d5d 0a20  n1 = n[odr[0]]. 
+0000b800: 2020 2020 2020 2020 2020 206e 3220 3d20             n2 = 
+0000b810: 6e5b 6f64 725b 315d 5d0a 2020 2020 2020  n[odr[1]].      
+0000b820: 2020 2020 2020 7331 203d 2027 2569 2f25        s1 = '%i/%
+0000b830: 6927 2025 2028 6e31 2c20 6b31 290a 2020  i' % (n1, k1).  
+0000b840: 2020 2020 2020 2020 2020 7332 203d 2027            s2 = '
+0000b850: 2569 2f25 6927 2025 2028 6e32 2c20 6b32  %i/%i' % (n2, k2
+0000b860: 290a 2020 2020 2020 2020 2020 2020 4e31  ).            N1
+0000b870: 2e61 7070 656e 6428 7331 290a 2020 2020  .append(s1).    
+0000b880: 2020 2020 2020 2020 4e32 2e61 7070 656e          N2.appen
+0000b890: 6428 7332 290a 2020 2020 2020 2020 2020  d(s2).          
+0000b8a0: 2020 4e6e 2e61 7070 656e 6428 6e31 290a    Nn.append(n1).
+0000b8b0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0000b8c0: 2020 2020 2020 2020 206e 6c73 7420 3d20           nlst = 
+0000b8d0: 5b27 2569 2f25 6927 2025 2028 6e6e 2c20  ['%i/%i' % (nn, 
+0000b8e0: 6e5f 6d6b 725b 7375 6274 7970 655f 6c73  n_mkr[subtype_ls
+0000b8f0: 745b 6a5d 5d29 2066 6f72 206a 2c20 6e6e  t[j]]) for j, nn
+0000b900: 2069 6e20 656e 756d 6572 6174 6528 6c69   in enumerate(li
+0000b910: 7374 286e 2929 5d0a 2020 2020 2020 2020  st(n))].        
+0000b920: 2020 2020 6466 6e2e 696c 6f63 5b69 5d20      dfn.iloc[i] 
+0000b930: 3d20 6e6c 7374 0a0a 2020 2020 2020 2020  = nlst..        
+0000b940: 2320 6466 5f72 6573 203d 2070 642e 4461  # df_res = pd.Da
+0000b950: 7461 4672 616d 6528 7b27 4344 342b 2054  taFrame({'CD4+ T
+0000b960: 2063 656c 6c20 7375 6274 7970 6527 3a20   cell subtype': 
+0000b970: 7463 5f73 7562 7479 7065 2c20 274e 6567  tc_subtype, 'Neg
+0000b980: 4c6f 6750 7661 6c27 3a20 6e65 675f 6c6f  LogPval': neg_lo
+0000b990: 675f 7076 616c 7d2c 2069 6e64 6578 203d  g_pval}, index =
+0000b9a0: 2064 662e 696e 6465 782e 7661 6c75 6573   df.index.values
+0000b9b0: 290a 2020 2020 2020 2020 6466 5f72 6573  ).        df_res
+0000b9c0: 203d 2070 642e 4461 7461 4672 616d 6528   = pd.DataFrame(
+0000b9d0: 7b27 6365 6c6c 5f74 7970 6527 3a20 7375  {'cell_type': su
+0000b9e0: 6274 7970 652c 2027 6365 6c6c 5f74 7970  btype, 'cell_typ
+0000b9f0: 6528 7265 7629 273a 2073 7562 7479 7065  e(rev)': subtype
+0000ba00: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+0000ba10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ba20: 2020 2763 656c 6c5f 7479 7065 2831 7374    'cell_type(1st
+0000ba30: 2927 3a20 7375 6274 7970 652c 2027 4f76  )': subtype, 'Ov
+0000ba40: 6572 6c61 7027 3a20 4e31 2c0a 2020 2020  erlap': N1,.    
+0000ba50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ba60: 2020 2020 2020 2020 2020 2027 6365 6c6c             'cell
+0000ba70: 5f74 7970 6528 326e 6429 273a 2069 6478  _type(2nd)': idx
+0000ba80: 322c 2027 4f76 6572 6c61 7028 326e 6429  2, 'Overlap(2nd)
+0000ba90: 273a 204e 322c 0a20 2020 2020 2020 2020  ': N2,.         
+0000baa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bab0: 2020 2020 2020 2743 6c61 7269 7479 273a        'Clarity':
+0000bac0: 205b 272d 275d 2a64 662e 7368 6170 655b   ['-']*df.shape[
+0000bad0: 305d 2c20 272d 6c6f 6750 273a 206d 6178  0], '-logP': max
+0000bae0: 762c 2027 2d6c 6f67 5028 326e 6429 273a  v, '-logP(2nd)':
+0000baf0: 206d 6178 7632 7d2c 200a 2020 2020 2020   maxv2}, .      
+0000bb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bb10: 2020 2020 2020 2020 696e 6465 7820 3d20          index = 
+0000bb20: 6466 2e69 6e64 6578 2e76 616c 7565 7329  df.index.values)
+0000bb30: 0a20 2020 2020 2020 2064 665f 7265 735b  .        df_res[
+0000bb40: 272d 6c6f 6750 2d6c 6f67 5028 326e 6429  '-logP-logP(2nd)
+0000bb50: 275d 203d 2064 665f 7265 735b 272d 6c6f  '] = df_res['-lo
+0000bb60: 6750 275d 202d 2064 665f 7265 735b 272d  gP'] - df_res['-
+0000bb70: 6c6f 6750 2832 6e64 2927 5d0a 0a20 2020  logP(2nd)']..   
+0000bb80: 2020 2020 2062 203d 206e 702e 6172 7261       b = np.arra
+0000bb90: 7928 4e6e 2920 3d3d 2030 0a20 2020 2020  y(Nn) == 0.     
+0000bba0: 2020 2064 665f 7265 732e 6c6f 635b 622c     df_res.loc[b,
+0000bbb0: 2763 656c 6c5f 7479 7065 275d 203d 2027  'cell_type'] = '
+0000bbc0: 756e 6173 7369 676e 6564 270a 2020 2020  unassigned'.    
+0000bbd0: 2020 2020 6466 5f72 6573 2e6c 6f63 5b62      df_res.loc[b
+0000bbe0: 2c27 6365 6c6c 5f74 7970 6528 7265 7629  ,'cell_type(rev)
+0000bbf0: 275d 203d 2027 756e 6173 7369 676e 6564  '] = 'unassigned
+0000bc00: 270a 2020 2020 2020 2020 6466 5f72 6573  '.        df_res
+0000bc10: 2e6c 6f63 5b62 2c27 6365 6c6c 5f74 7970  .loc[b,'cell_typ
+0000bc20: 6528 3173 7429 275d 203d 2027 756e 6173  e(1st)'] = 'unas
+0000bc30: 7369 676e 6564 270a 2020 2020 2020 2020  signed'.        
+0000bc40: 6466 5f72 6573 2e6c 6f63 5b62 2c27 6365  df_res.loc[b,'ce
+0000bc50: 6c6c 5f74 7970 6528 326e 6429 275d 203d  ll_type(2nd)'] =
+0000bc60: 2027 756e 6173 7369 676e 6564 270a 2020   'unassigned'.  
+0000bc70: 2020 2020 200a 2020 2020 2320 6966 2076       .    # if v
+0000bc80: 6572 626f 7365 3a20 7072 696e 7428 2764  erbose: print('d
+0000bc90: 6f6e 652e 2028 2569 2073 2927 2025 2072  one. (%i s)' % r
+0000bca0: 6f75 6e64 2874 696d 652e 7469 6d65 2829  ound(time.time()
+0000bcb0: 202d 2073 7461 7274 5f74 696d 6529 290a   - start_time)).
+0000bcc0: 2020 2020 6466 5f73 636f 7265 203d 2064      df_score = d
+0000bcd0: 660a 2020 2020 7265 7475 726e 2064 665f  f.    return df_
+0000bce0: 7265 732c 2064 665f 7363 6f72 652c 2064  res, df_score, d
+0000bcf0: 666e 0a0a 0a64 6566 2043 5f6d 616a 6f72  fn...def C_major
+0000bd00: 5f67 6d6d 2858 5f70 6361 2c20 7973 2c20  _gmm(X_pca, ys, 
+0000bd10: 636c 6173 735f 6e61 6d65 732c 206d 6574  class_names, met
+0000bd20: 686f 6420 3d20 2767 6d6d 272c 204e 5f63  hod = 'gmm', N_c
+0000bd30: 6f6d 706f 6e65 6e74 7320 3d20 382c 2076  omponents = 8, v
+0000bd40: 6572 626f 7365 203d 2046 616c 7365 2029  erbose = False )
+0000bd50: 3a0a 2020 2020 0a20 2020 2069 6620 7665  :.    .    if ve
+0000bd60: 7262 6f73 653a 2070 7269 6e74 2827 4669  rbose: print('Fi
+0000bd70: 7474 696e 6720 474d 4d20 2e2e 2027 2c20  tting GMM .. ', 
+0000bd80: 656e 6420 3d20 2727 290a 2020 2020 7374  end = '').    st
+0000bd90: 6172 745f 7469 6d65 203d 2074 696d 652e  art_time = time.
+0000bda0: 7469 6d65 2829 0a0a 2020 2020 6273 203d  time()..    bs =
+0000bdb0: 2028 7973 203d 3d20 636c 6173 735f 6e61   (ys == class_na
+0000bdc0: 6d65 735b 305d 290a 2020 2020 666f 7220  mes[0]).    for 
+0000bdd0: 636e 616d 6520 696e 206c 6973 7428 636c  cname in list(cl
+0000bde0: 6173 735f 6e61 6d65 735b 313a 5d29 3a0a  ass_names[1:]):.
+0000bdf0: 2020 2020 2020 2020 6273 203d 2062 7320          bs = bs 
+0000be00: 7c20 2879 7320 3d3d 2063 6e61 6d65 290a  | (ys == cname).
+0000be10: 2020 2020 2020 2020 0a20 2020 2058 203d          .    X =
+0000be20: 206e 702e 6172 7261 7928 585f 7063 612e   np.array(X_pca.
+0000be30: 6c6f 635b 6273 2c3a 5d29 0a20 2020 2079  loc[bs,:]).    y
+0000be40: 203d 2079 735b 6273 5d0a 0a20 2020 2023   = ys[bs]..    #
+0000be50: 2320 5365 6c65 6374 2074 7261 696e 696e  # Select trainin
+0000be60: 6720 6365 6c6c 730a 2020 2020 6466 5f73  g cells.    df_s
+0000be70: 636f 7265 203d 2070 642e 4461 7461 4672  core = pd.DataFr
+0000be80: 616d 6528 696e 6465 7820 3d20 585f 7063  ame(index = X_pc
+0000be90: 612e 696e 6465 782e 7661 6c75 6573 290a  a.index.values).
+0000bea0: 2020 2020 636e 7420 3d20 300a 2020 2020      cnt = 0.    
+0000beb0: 666f 7220 636e 616d 6520 696e 206c 6973  for cname in lis
+0000bec0: 7428 636c 6173 735f 6e61 6d65 7329 3a0a  t(class_names):.
+0000bed0: 2020 2020 0a20 2020 2020 2020 2058 5f74      .        X_t
+0000bee0: 6d70 203d 2058 5b79 203d 3d20 636e 616d  mp = X[y == cnam
+0000bef0: 652c 3a5d 0a20 2020 2020 2020 2079 5f74  e,:].        y_t
+0000bf00: 6d70 203d 2079 5b79 203d 3d20 636e 616d  mp = y[y == cnam
+0000bf10: 655d 0a20 2020 2020 2020 200a 2020 2020  e].        .    
+0000bf20: 2020 2020 2320 4e5f 636f 6d70 203d 206d      # N_comp = m
+0000bf30: 696e 286d 6178 2869 6e74 284e 5f63 6f6d  in(max(int(N_com
+0000bf40: 706f 6e65 6e74 7320 2a20 6c65 6e28 795f  ponents * len(y_
+0000bf50: 746d 7029 2f73 7a6d 7829 2c31 292c 206c  tmp)/szmx),1), l
+0000bf60: 656e 2879 5f74 6d70 2929 0a20 2020 2020  en(y_tmp)).     
+0000bf70: 2020 2023 2069 6620 6c65 6e28 795f 746d     # if len(y_tm
+0000bf80: 7029 203c 2035 303a 204e 5f63 6f6d 7020  p) < 50: N_comp 
+0000bf90: 3d20 310a 2020 2020 2020 2020 2327 2727  = 1.        #'''
+0000bfa0: 0a20 2020 2020 2020 2073 7172 744e 203d  .        sqrtN =
+0000bfb0: 206d 6178 2869 6e74 286e 702e 7371 7274   max(int(np.sqrt
+0000bfc0: 2858 5f70 6361 2e73 6861 7065 5b30 5d29  (X_pca.shape[0])
+0000bfd0: 2f32 292c 2031 290a 2020 2020 2020 2020  /2), 1).        
+0000bfe0: 6966 206c 656e 2879 5f74 6d70 2920 3c3d  if len(y_tmp) <=
+0000bff0: 204e 5f63 6f6d 706f 6e65 6e74 733a 0a20   N_components:. 
+0000c000: 2020 2020 2020 2020 2020 204e 5f63 6f6d             N_com
+0000c010: 7020 3d20 310a 2020 2020 2020 2020 656c  p = 1.        el
+0000c020: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000c030: 4e5f 636f 6d70 203d 206d 696e 284e 5f63  N_comp = min(N_c
+0000c040: 6f6d 706f 6e65 6e74 732c 2073 7172 744e  omponents, sqrtN
+0000c050: 290a 2020 2020 2020 2020 2327 2727 0a0a  ).        #'''..
+0000c060: 2020 2020 2020 2020 6966 206c 656e 2879          if len(y
+0000c070: 5f74 6d70 2920 3e20 4e5f 636f 6d70 3a0a  _tmp) > N_comp:.
+0000c080: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+0000c090: 6574 686f 6420 3d3d 2027 676d 6d27 3a0a  ethod == 'gmm':.
+0000c0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c0b0: 676d 6d20 3d20 6d69 7874 7572 652e 4761  gmm = mixture.Ga
+0000c0c0: 7573 7369 616e 4d69 7874 7572 6528 6e5f  ussianMixture(n_
+0000c0d0: 636f 6d70 6f6e 656e 7473 203d 2069 6e74  components = int
+0000c0e0: 284e 5f63 6f6d 7029 2c20 7261 6e64 6f6d  (N_comp), random
+0000c0f0: 5f73 7461 7465 203d 2030 290a 2020 2020  _state = 0).    
+0000c100: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000c110: 2020 2020 2020 2020 2020 2020 2020 676d                gm
+0000c120: 6d20 3d20 6d69 7874 7572 652e 4261 7965  m = mixture.Baye
+0000c130: 7369 616e 4761 7573 7369 616e 4d69 7874  sianGaussianMixt
+0000c140: 7572 6528 6e5f 636f 6d70 6f6e 656e 7473  ure(n_components
+0000c150: 203d 2069 6e74 284e 5f63 6f6d 7029 2c20   = int(N_comp), 
+0000c160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c190: 2020 2020 2020 206d 6178 5f69 7465 7220         max_iter 
+0000c1a0: 3d20 3130 3030 2c20 7261 6e64 6f6d 5f73  = 1000, random_s
+0000c1b0: 7461 7465 203d 2030 290a 0a20 2020 2020  tate = 0)..     
+0000c1c0: 2020 2020 2020 2067 6d6d 2e66 6974 286e         gmm.fit(n
+0000c1d0: 702e 6172 7261 7928 585f 746d 7029 290a  p.array(X_tmp)).
+0000c1e0: 2020 2020 2020 2020 2020 2020 795f 636f              y_co
+0000c1f0: 6e66 203d 2067 6d6d 2e73 636f 7265 5f73  nf = gmm.score_s
+0000c200: 616d 706c 6573 286e 702e 6172 7261 7928  amples(np.array(
+0000c210: 585f 7063 6129 290a 2020 2020 2020 2020  X_pca)).        
+0000c220: 2020 2020 6466 5f73 636f 7265 5b27 2573      df_score['%s
+0000c230: 2720 2520 636e 616d 655d 203d 206c 6973  ' % cname] = lis
+0000c240: 7428 795f 636f 6e66 290a 2020 2020 2020  t(y_conf).      
+0000c250: 2020 2020 2020 636e 7420 2b3d 2031 0a20        cnt += 1. 
+0000c260: 2020 200a 2020 2020 6966 2063 6e74 203e     .    if cnt >
+0000c270: 2031 3a0a 2020 2020 2020 2020 795f 7072   1:.        y_pr
+0000c280: 6564 203d 2064 665f 7363 6f72 652e 6964  ed = df_score.id
+0000c290: 786d 6178 2861 7869 7320 3d20 3129 0a20  xmax(axis = 1). 
+0000c2a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000c2b0: 2079 5f70 7265 6420 3d20 7064 2e53 6572   y_pred = pd.Ser
+0000c2c0: 6965 7328 696e 6465 7820 3d20 585f 7063  ies(index = X_pc
+0000c2d0: 612e 696e 6465 782e 7661 6c75 6573 2c20  a.index.values, 
+0000c2e0: 6474 7970 6520 3d20 666c 6f61 7429 0a20  dtype = float). 
+0000c2f0: 2020 2020 2020 2069 6620 636e 7420 3d3d         if cnt ==
+0000c300: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+0000c310: 795f 7072 6564 5b3a 5d20 3d20 6466 5f73  y_pred[:] = df_s
+0000c320: 636f 7265 2e63 6f6c 756d 6e73 2e76 616c  core.columns.val
+0000c330: 7565 735b 305d 0a20 2020 2020 2020 2065  ues[0].        e
+0000c340: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000c350: 2079 5f70 7265 645b 3a5d 203d 2027 756e   y_pred[:] = 'un
+0000c360: 6173 7369 676e 6564 270a 2020 2020 2020  assigned'.      
+0000c370: 2020 0a20 2020 2079 5f70 7265 645b 7e62    .    y_pred[~b
+0000c380: 735d 203d 2027 756e 6173 7369 676e 6564  s] = 'unassigned
+0000c390: 270a 2020 2020 0a20 2020 2023 2069 6620  '.    .    # if 
+0000c3a0: 7665 7262 6f73 653a 2070 7269 6e74 2827  verbose: print('
+0000c3b0: 474d 4d20 636f 7272 6563 7469 6f6e 3a20  GMM correction: 
+0000c3c0: 2569 202d 3e20 2569 2c20 2569 2720 2520  %i -> %i, %i' % 
+0000c3d0: 286c 656e 2862 7329 2c20 6e70 2e73 756d  (len(bs), np.sum
+0000c3e0: 2862 7329 2c20 6e70 2e73 756d 2879 5f70  (bs), np.sum(y_p
+0000c3f0: 7265 6420 3d3d 2027 756e 6173 7369 676e  red == 'unassign
+0000c400: 6564 2729 2029 2920 2020 200a 2020 2020  ed') ))    .    
+0000c410: 2320 6966 2076 6572 626f 7365 3a20 7072  # if verbose: pr
+0000c420: 696e 7428 2764 6f6e 652e 2028 2569 2073  int('done. (%i s
+0000c430: 2927 2025 2072 6f75 6e64 2874 696d 652e  )' % round(time.
+0000c440: 7469 6d65 2829 202d 2073 7461 7274 5f74  time() - start_t
+0000c450: 696d 6529 290a 2020 2020 7265 7475 726e  ime)).    return
+0000c460: 2079 5f70 7265 642c 2064 665f 7363 6f72   y_pred, df_scor
+0000c470: 650a 0a0a 6465 6620 435f 6d61 6a6f 725f  e...def C_major_
+0000c480: 6c6f 6772 6567 2858 5f70 6361 2c20 7973  logreg(X_pca, ys
+0000c490: 2c20 636c 6173 735f 6e61 6d65 732c 2076  , class_names, v
+0000c4a0: 6572 626f 7365 203d 2046 616c 7365 2029  erbose = False )
+0000c4b0: 3a0a 2020 2020 0a20 2020 2069 6620 7665  :.    .    if ve
+0000c4c0: 7262 6f73 653a 2070 7269 6e74 2827 4669  rbose: print('Fi
+0000c4d0: 7474 696e 6720 4c6f 6769 7374 6963 2052  tting Logistic R
+0000c4e0: 6567 7265 7373 696f 6e20 6d6f 6465 6c20  egression model 
+0000c4f0: 2e2e 2027 2c20 656e 6420 3d20 2727 290a  .. ', end = '').
+0000c500: 2020 2020 7374 6172 745f 7469 6d65 203d      start_time =
+0000c510: 2074 696d 652e 7469 6d65 2829 0a0a 2020   time.time()..  
+0000c520: 2020 6273 203d 2028 7973 203d 3d20 636c    bs = (ys == cl
+0000c530: 6173 735f 6e61 6d65 735b 305d 290a 2020  ass_names[0]).  
+0000c540: 2020 666f 7220 636e 616d 6520 696e 206c    for cname in l
+0000c550: 6973 7428 636c 6173 735f 6e61 6d65 735b  ist(class_names[
+0000c560: 313a 5d29 3a0a 2020 2020 2020 2020 6273  1:]):.        bs
+0000c570: 203d 2062 7320 7c20 2879 7320 3d3d 2063   = bs | (ys == c
+0000c580: 6e61 6d65 290a 2020 2020 2020 2020 0a20  name).        . 
+0000c590: 2020 2058 203d 206e 702e 6172 7261 7928     X = np.array(
+0000c5a0: 585f 7063 612e 6c6f 635b 6273 2c3a 5d29  X_pca.loc[bs,:])
+0000c5b0: 0a20 2020 2079 203d 2079 735b 6273 5d0a  .    y = ys[bs].
+0000c5c0: 0a20 2020 204e 4356 203d 204c 4f47 5245  .    NCV = LOGRE
+0000c5d0: 475f 4e43 560a 2020 2020 4d41 585f 4954  G_NCV.    MAX_IT
+0000c5e0: 4552 203d 204c 4f47 5245 475f 4d41 585f  ER = LOGREG_MAX_
+0000c5f0: 4954 4552 0a20 2020 2070 6172 616d 5f67  ITER.    param_g
+0000c600: 7269 6420 3d20 4c4f 4752 4547 5f50 4152  rid = LOGREG_PAR
+0000c610: 414d 5f47 5249 440a 0a20 2020 206e 5f73  AM_GRID..    n_s
+0000c620: 616d 706c 6573 2c20 6e5f 6665 6174 7572  amples, n_featur
+0000c630: 6573 203d 2058 2e73 6861 7065 0a20 2020  es = X.shape.   
+0000c640: 2063 7620 3d20 6d6f 645f 7365 6c2e 5374   cv = mod_sel.St
+0000c650: 7261 7469 6669 6564 4b46 6f6c 6428 6e5f  ratifiedKFold(n_
+0000c660: 7370 6c69 7473 3d4e 4356 290a 2020 2020  splits=NCV).    
+0000c670: 636c 6173 7369 6669 6572 203d 206c 6d2e  classifier = lm.
+0000c680: 4c6f 6769 7374 6963 5265 6772 6573 7369  LogisticRegressi
+0000c690: 6f6e 2870 656e 616c 7479 203d 2027 656c  on(penalty = 'el
+0000c6a0: 6173 7469 636e 6574 272c 200a 2020 2020  asticnet', .    
+0000c6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c6d0: 2020 206d 6178 5f69 7465 7220 3d20 4d41     max_iter = MA
+0000c6e0: 585f 4954 4552 2c20 736f 6c76 6572 203d  X_ITER, solver =
+0000c6f0: 2027 7361 6761 272c 200a 2020 2020 2020   'saga', .      
+0000c700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c720: 2063 6c61 7373 5f77 6569 6768 7420 3d20   class_weight = 
+0000c730: 2762 616c 616e 6365 6427 2c74 6f6c 203d  'balanced',tol =
+0000c740: 204c 4f47 5245 475f 544f 4c29 0a0a 2020   LOGREG_TOL)..  
+0000c750: 2020 7769 7468 2077 6172 6e69 6e67 732e    with warnings.
+0000c760: 6361 7463 685f 7761 726e 696e 6773 2829  catch_warnings()
+0000c770: 3a0a 2020 2020 2020 2020 7761 726e 696e  :.        warnin
+0000c780: 6773 2e73 696d 706c 6566 696c 7465 7228  gs.simplefilter(
+0000c790: 2269 676e 6f72 6522 290a 2020 2020 2020  "ignore").      
+0000c7a0: 2020 2320 7761 726e 696e 6773 2e66 696c    # warnings.fil
+0000c7b0: 7465 7277 6172 6e69 6e67 7328 2269 676e  terwarnings("ign
+0000c7c0: 6f72 6522 2c20 6361 7465 676f 7279 3d43  ore", category=C
+0000c7d0: 6f6e 7665 7267 656e 6365 5761 726e 696e  onvergenceWarnin
+0000c7e0: 6729 0a20 2020 2020 2020 2067 7320 3d20  g).        gs = 
+0000c7f0: 6d6f 645f 7365 6c2e 4772 6964 5365 6172  mod_sel.GridSear
+0000c800: 6368 4356 2863 6c61 7373 6966 6965 722c  chCV(classifier,
+0000c810: 2070 6172 616d 5f67 7269 642c 2063 763d   param_grid, cv=
+0000c820: 6376 2c20 7363 6f72 696e 673d 2762 616c  cv, scoring='bal
+0000c830: 616e 6365 645f 6163 6375 7261 6379 272c  anced_accuracy',
+0000c840: 2072 6566 6974 203d 2054 7275 652c 206e   refit = True, n
+0000c850: 5f6a 6f62 7320 3d20 4e43 562c 2076 6572  _jobs = NCV, ver
+0000c860: 626f 7365 203d 2030 290a 0a20 2020 2020  bose = 0)..     
+0000c870: 2020 2067 732e 6669 7428 582c 7929 0a20     gs.fit(X,y). 
+0000c880: 2020 2020 2020 2070 7269 6e74 2867 732e         print(gs.
+0000c890: 6265 7374 5f70 6172 616d 735f 2c20 6773  best_params_, gs
+0000c8a0: 2e62 6573 745f 7363 6f72 655f 290a 0a20  .best_score_).. 
+0000c8b0: 2020 2063 6c61 7373 6966 6965 7220 3d20     classifier = 
+0000c8c0: 6773 2e62 6573 745f 6573 7469 6d61 746f  gs.best_estimato
+0000c8d0: 725f 0a20 2020 2079 5f70 7265 6420 3d20  r_.    y_pred = 
+0000c8e0: 636c 6173 7369 6669 6572 2e70 7265 6469  classifier.predi
+0000c8f0: 6374 2858 5f70 6361 290a 2020 2020 795f  ct(X_pca).    y_
+0000c900: 7072 6f62 203d 2063 6c61 7373 6966 6965  prob = classifie
+0000c910: 722e 7072 6564 6963 745f 7072 6f62 6128  r.predict_proba(
+0000c920: 585f 7063 6129 0a0a 2020 2020 636f 6c73  X_pca)..    cols
+0000c930: 203d 206c 6973 7428 636c 6173 7369 6669   = list(classifi
+0000c940: 6572 2e63 6c61 7373 6573 5f29 0a20 2020  er.classes_).   
+0000c950: 2064 665f 7363 6f72 6520 3d20 7064 2e44   df_score = pd.D
+0000c960: 6174 6146 7261 6d65 286e 702e 6c6f 6731  ataFrame(np.log1
+0000c970: 3028 795f 7072 6f62 202b 2031 652d 3130  0(y_prob + 1e-10
+0000c980: 3029 2c20 696e 6465 7820 3d20 585f 7063  0), index = X_pc
+0000c990: 612e 696e 6465 782e 7661 6c75 6573 2c20  a.index.values, 
+0000c9a0: 636f 6c75 6d6e 7320 3d20 636f 6c73 290a  columns = cols).
+0000c9b0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0000c9c0: 2079 5f70 7265 6420 3d20 6466 5f73 636f   y_pred = df_sco
+0000c9d0: 7265 2e69 6478 6d61 7828 6178 6973 203d  re.idxmax(axis =
+0000c9e0: 2031 290a 2020 2020 0a20 2020 2023 2069   1).    .    # i
+0000c9f0: 6620 7665 7262 6f73 653a 2070 7269 6e74  f verbose: print
+0000ca00: 2827 646f 6e65 2e20 2825 6920 7329 2720  ('done. (%i s)' 
+0000ca10: 2520 726f 756e 6428 7469 6d65 2e74 696d  % round(time.tim
+0000ca20: 6528 2920 2d20 7374 6172 745f 7469 6d65  e() - start_time
+0000ca30: 2929 0a20 2020 2072 6574 7572 6e20 795f  )).    return y_
+0000ca40: 7072 6564 2c20 6466 5f73 636f 7265 0a20  pred, df_score. 
+0000ca50: 2020 2020 200a 2020 2020 0a64 6566 2067       .    .def g
+0000ca60: 6574 5f74 6872 6573 686f 6c64 2876 616c  et_threshold(val
+0000ca70: 7565 732c 2074 6172 6765 745f 4650 5220  ues, target_FPR 
+0000ca80: 3d20 302e 3035 2c20 7570 7065 7220 3d20  = 0.05, upper = 
+0000ca90: 5472 7565 293a 0a20 2020 200a 2020 2020  True):.    .    
+0000caa0: 7a20 3d20 6e70 2e61 7272 6179 2876 616c  z = np.array(val
+0000cab0: 7565 7329 0a20 2020 206f 6472 203d 207a  ues).    odr = z
+0000cac0: 2e61 7267 736f 7274 2829 0a20 2020 206e  .argsort().    n
+0000cad0: 203d 2069 6e74 2872 6f75 6e64 286c 656e   = int(round(len
+0000cae0: 286f 6472 292a 7461 7267 6574 5f46 5052  (odr)*target_FPR
+0000caf0: 2929 0a20 2020 2069 6620 6e20 3e3d 206c  )).    if n >= l
+0000cb00: 656e 286f 6472 293a 0a20 2020 2020 2020  en(odr):.       
+0000cb10: 206e 203d 2069 6e74 286c 656e 286f 6472   n = int(len(odr
+0000cb20: 292d 3129 0a20 2020 2069 6620 7570 7065  )-1).    if uppe
+0000cb30: 723a 0a20 2020 2020 2020 2074 6820 3d20  r:.        th = 
+0000cb40: 7a5b 6f64 725b 2d6e 5d5d 0a20 2020 2065  z[odr[-n]].    e
+0000cb50: 6c73 653a 0a20 2020 2020 2020 2074 6820  lse:.        th 
+0000cb60: 3d20 7a5b 6f64 725b 6e5d 5d0a 2020 2020  = z[odr[n]].    
+0000cb70: 7265 7475 726e 2074 680a 0a0a 6465 6620  return th...def 
+0000cb80: 6765 745f 7468 7265 7368 6f6c 645f 4e28  get_threshold_N(
+0000cb90: 7661 6c75 6573 2c20 4e4e 203d 2031 2c20  values, NN = 1, 
+0000cba0: 7570 7065 7220 3d20 5472 7565 293a 0a20  upper = True):. 
+0000cbb0: 2020 200a 2020 2020 7a20 3d20 6e70 2e61     .    z = np.a
+0000cbc0: 7272 6179 2876 616c 7565 7329 0a20 2020  rray(values).   
+0000cbd0: 206f 6472 203d 207a 2e61 7267 736f 7274   odr = z.argsort
+0000cbe0: 2829 0a20 2020 206e 203d 2069 6e74 284e  ().    n = int(N
+0000cbf0: 4e29 0a20 2020 2069 6620 6e20 3e3d 206c  N).    if n >= l
+0000cc00: 656e 286f 6472 293a 0a20 2020 2020 2020  en(odr):.       
+0000cc10: 206e 203d 2069 6e74 286c 656e 286f 6472   n = int(len(odr
+0000cc20: 292d 3129 0a20 2020 2069 6620 7570 7065  )-1).    if uppe
+0000cc30: 723a 0a20 2020 2020 2020 2074 6820 3d20  r:.        th = 
+0000cc40: 7a5b 6f64 725b 2d6e 5d5d 0a20 2020 2065  z[odr[-n]].    e
+0000cc50: 6c73 653a 0a20 2020 2020 2020 2074 6820  lse:.        th 
+0000cc60: 3d20 7a5b 6f64 725b 6e5d 5d0a 2020 2020  = z[odr[n]].    
+0000cc70: 7265 7475 726e 2074 680a 0a23 2727 270a  return th..#'''.
+0000cc80: 0a64 6566 2067 6574 5f6e 6f72 6d61 6c5f  .def get_normal_
+0000cc90: 7064 6628 2078 2c20 6d75 2c20 7661 722c  pdf( x, mu, var,
+0000cca0: 206e 6269 6e73 293a 0a20 2020 200a 2020   nbins):.    .  
+0000ccb0: 2020 7920 3d20 6e70 2e61 7272 6179 2878    y = np.array(x
+0000ccc0: 290a 2020 2020 6d6e 5f78 203d 2079 2e6d  ).    mn_x = y.m
+0000ccd0: 696e 2829 0a20 2020 206d 785f 7820 3d20  in().    mx_x = 
+0000cce0: 792e 6d61 7828 290a 2020 2020 4c20 3d20  y.max().    L = 
+0000ccf0: 3130 300a 2020 2020 2320 6478 203d 206c  100.    # dx = l
+0000cd00: 656e 2879 292a 286d 785f 782d 6d6e 5f78  en(y)*(mx_x-mn_x
+0000cd10: 292f 4c0a 2020 2020 6478 203d 2028 6d78  )/L.    dx = (mx
+0000cd20: 5f78 2d6d 6e5f 7829 2f6e 6269 6e73 0a20  _x-mn_x)/nbins. 
+0000cd30: 2020 2078 7320 3d20 6e70 2e61 7261 6e67     xs = np.arang
+0000cd40: 6528 6d6e 5f78 2c6d 785f 782c 2064 7820  e(mn_x,mx_x, dx 
+0000cd50: 290a 2020 2020 7064 6620 3d20 2864 782a  ).    pdf = (dx*
+0000cd60: 6c65 6e28 7929 292a 6e70 2e65 7870 282d  len(y))*np.exp(-
+0000cd70: 2828 7873 2d6d 7529 2a2a 3229 2f28 322a  ((xs-mu)**2)/(2*
+0000cd80: 7661 722b 3165 2d31 3029 292f 286e 702e  var+1e-10))/(np.
+0000cd90: 7371 7274 2832 2a6d 6174 682e 7069 2a76  sqrt(2*math.pi*v
+0000cda0: 6172 292b 3165 2d31 3029 202b 2031 652d  ar)+1e-10) + 1e-
+0000cdb0: 3130 0a20 2020 2072 6574 7572 6e20 7064  10.    return pd
+0000cdc0: 662c 2078 730a 0a0a 6465 6620 6765 745f  f, xs...def get_
+0000cdd0: 7468 7265 7368 6f6c 645f 7573 696e 675f  threshold_using_
+0000cde0: 7061 7261 6d28 2070 6172 616d 2c20 5461  param( param, Ta
+0000cdf0: 7267 6574 5f46 5052 203d 2030 2e31 2029  rget_FPR = 0.1 )
+0000ce00: 3a0a 2020 2020 0a20 2020 2077 302c 206d  :.    .    w0, m
+0000ce10: 302c 2076 302c 2077 312c 206d 312c 2076  0, v0, w1, m1, v
+0000ce20: 3120 3d20 7061 7261 6d20 0a20 2020 206d  1 = param .    m
+0000ce30: 7876 203d 206d 312b 6e70 2e73 7172 7428  xv = m1+np.sqrt(
+0000ce40: 7631 290a 2020 2020 6d6e 7620 3d20 6d30  v1).    mnv = m0
+0000ce50: 0a20 2020 207a 203d 206e 702e 6172 616e  .    z = np.aran
+0000ce60: 6765 286d 6e76 2c6d 7876 2c20 286d 7876  ge(mnv,mxv, (mxv
+0000ce70: 2d6d 6e76 292f 3130 3030 290a 0a20 2020  -mnv)/1000)..   
+0000ce80: 2065 3020 3d20 3120 2d20 302e 352a 2831   e0 = 1 - 0.5*(1
+0000ce90: 202b 2065 7266 2828 7a20 2d20 6d30 292f   + erf((z - m0)/
+0000cea0: 6e70 2e73 7172 7428 7630 2929 290a 2020  np.sqrt(v0))).  
+0000ceb0: 2020 6531 203d 2031 202d 2030 2e35 2a28    e1 = 1 - 0.5*(
+0000cec0: 3120 2b20 6572 6628 287a 202d 206d 3129  1 + erf((z - m1)
+0000ced0: 2f6e 702e 7371 7274 2876 3129 2929 0a20  /np.sqrt(v1))). 
+0000cee0: 2020 2066 7072 203d 2065 302f 6531 0a20     fpr = e0/e1. 
+0000cef0: 2020 200a 2020 2020 6966 2066 7072 2e6d     .    if fpr.m
+0000cf00: 696e 2829 203c 2054 6172 6765 745f 4650  in() < Target_FP
+0000cf10: 523a 0a20 2020 2020 2020 2069 203d 206e  R:.        i = n
+0000cf20: 702e 6162 7328 6670 722d 5461 7267 6574  p.abs(fpr-Target
+0000cf30: 5f46 5052 292e 6172 676d 696e 2829 0a20  _FPR).argmin(). 
+0000cf40: 2020 2020 2020 2074 6872 6573 686f 6c64         threshold
+0000cf50: 203d 207a 5b69 5d0a 2020 2020 656c 7365   = z[i].    else
+0000cf60: 3a20 0a20 2020 2020 2020 2069 203d 2066  : .        i = f
+0000cf70: 7072 2e61 7267 6d69 6e28 290a 2020 2020  pr.argmin().    
+0000cf80: 2020 2020 7468 7265 7368 6f6c 6420 3d20      threshold = 
+0000cf90: 7a5b 695d 0a20 2020 2020 2020 2020 2020  z[i].           
+0000cfa0: 200a 2020 2020 7265 7475 726e 2074 6872   .    return thr
+0000cfb0: 6573 686f 6c64 0a0a 6465 6620 6269 6d6f  eshold..def bimo
+0000cfc0: 6461 6c5f 6669 7428 2078 5f73 636f 7265  dal_fit( x_score
+0000cfd0: 2029 3a0a 2020 2020 0a20 2020 2078 203d   ):.    .    x =
+0000cfe0: 2078 5f73 636f 7265 0a0a 2020 2020 676d   x_score..    gm
+0000cff0: 6d20 3d20 6d69 7874 7572 652e 4761 7573  m = mixture.Gaus
+0000d000: 7369 616e 4d69 7874 7572 6528 6e5f 636f  sianMixture(n_co
+0000d010: 6d70 6f6e 656e 7473 203d 2032 2c20 7261  mponents = 2, ra
+0000d020: 6e64 6f6d 5f73 7461 7465 203d 2030 290a  ndom_state = 0).
+0000d030: 2020 2020 7920 3d20 676d 6d2e 6669 745f      y = gmm.fit_
+0000d040: 7072 6564 6963 7428 6e70 2e61 7272 6179  predict(np.array
+0000d050: 2878 292e 7265 7368 6170 6528 2d31 2c20  (x).reshape(-1, 
+0000d060: 3129 290a 0a20 2020 206d 6e73 203d 205b  1))..    mns = [
+0000d070: 6d5b 305d 2066 6f72 206d 2069 6e20 676d  m[0] for m in gm
+0000d080: 6d2e 6d65 616e 735f 5d0a 2020 2020 6376  m.means_].    cv
+0000d090: 7320 3d20 5b63 765b 302c 305d 2066 6f72  s = [cv[0,0] for
+0000d0a0: 2063 7620 696e 2067 6d6d 2e63 6f76 6172   cv in gmm.covar
+0000d0b0: 6961 6e63 6573 5f5d 0a0a 2020 2020 7767  iances_]..    wg
+0000d0c0: 7320 3d20 676d 6d2e 7765 6967 6874 735f  s = gmm.weights_
+0000d0d0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+0000d0e0: 6966 206d 6e73 5b30 5d20 3c20 6d6e 735b  if mns[0] < mns[
+0000d0f0: 315d 3a0a 2020 2020 2020 2020 7730 2c20  1]:.        w0, 
+0000d100: 7731 203d 2077 6773 5b30 5d2c 2077 6773  w1 = wgs[0], wgs
+0000d110: 5b31 5d0a 2020 2020 2020 2020 6d30 2c20  [1].        m0, 
+0000d120: 6d31 203d 206d 6e73 5b30 5d2c 206d 6e73  m1 = mns[0], mns
+0000d130: 5b31 5d0a 2020 2020 2020 2020 7630 2c20  [1].        v0, 
+0000d140: 7631 203d 2063 7673 5b30 5d2c 2063 7673  v1 = cvs[0], cvs
+0000d150: 5b31 5d0a 2020 2020 656c 7365 3a0a 2020  [1].    else:.  
+0000d160: 2020 2020 2020 7730 2c20 7731 203d 2077        w0, w1 = w
+0000d170: 6773 5b31 5d2c 2077 6773 5b30 5d0a 2020  gs[1], wgs[0].  
+0000d180: 2020 2020 2020 6d30 2c20 6d31 203d 206d        m0, m1 = m
+0000d190: 6e73 5b31 5d2c 206d 6e73 5b30 5d0a 2020  ns[1], mns[0].  
+0000d1a0: 2020 2020 2020 7630 2c20 7631 203d 2063        v0, v1 = c
+0000d1b0: 7673 5b31 5d2c 2063 7673 5b30 5d0a 0a20  vs[1], cvs[0].. 
+0000d1c0: 2020 2072 6574 7572 6e20 7730 2c20 6d30     return w0, m0
+0000d1d0: 2c20 7630 2c20 7731 2c20 6d31 2c20 7631  , v0, w1, m1, v1
+0000d1e0: 0a20 2020 200a 2020 2020 0a64 6566 2067  .    .    .def g
+0000d1f0: 6574 5f74 6872 6573 686f 6c64 5f66 726f  et_threshold_fro
+0000d200: 6d5f 4753 415f 7265 7375 6c74 2864 665f  m_GSA_result(df_
+0000d210: 7375 6d2c 2070 7661 6c5f 7468 203d 2030  sum, pval_th = 0
+0000d220: 2e30 352c 2074 6172 6765 745f 4650 5220  .05, target_FPR 
+0000d230: 3d20 302e 3035 2c20 0a20 2020 2020 2020  = 0.05, .       
+0000d240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d250: 2020 2020 2020 2020 2020 2020 7665 7262              verb
+0000d260: 6f73 6520 3d20 4661 6c73 652c 2070 6c6f  ose = False, plo
+0000d270: 745f 6869 7374 203d 2046 616c 7365 293a  t_hist = False):
+0000d280: 0a20 2020 200a 2020 2020 7461 7267 6574  .    .    target
+0000d290: 5f74 7970 6573 203d 206c 6973 7428 6466  _types = list(df
+0000d2a0: 5f73 756d 5b27 6365 6c6c 5f74 7970 6528  _sum['cell_type(
+0000d2b0: 3173 7429 275d 2e75 6e69 7175 6528 2929  1st)'].unique())
+0000d2c0: 0a20 2020 2074 6872 6573 686f 6c64 7320  .    thresholds 
+0000d2d0: 3d20 7b7d 0a20 2020 206d 316d 325f 7261  = {}.    m1m2_ra
+0000d2e0: 7469 6f20 3d20 7b7d 0a20 2020 200a 2020  tio = {}.    .  
+0000d2f0: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+0000d300: 2020 2020 2020 7072 696e 7428 2754 6872        print('Thr
+0000d310: 6573 686f 6c64 733a 2729 0a20 2020 2020  esholds:').     
+0000d320: 2020 200a 2020 2020 6966 206c 656e 2874     .    if len(t
+0000d330: 6172 6765 745f 7479 7065 7329 203d 3d20  arget_types) == 
+0000d340: 313a 0a20 2020 2020 2020 200a 2020 2020  1:.        .    
+0000d350: 2020 2020 7420 3d20 7461 7267 6574 5f74      t = target_t
+0000d360: 7970 6573 5b30 5d0a 2020 2020 2020 2020  ypes[0].        
+0000d370: 785f 7363 6f72 6520 3d20 6466 5f73 756d  x_score = df_sum
+0000d380: 5b27 2d6c 6f67 5027 5d20 2320 6e70 2e6c  ['-logP'] # np.l
+0000d390: 6f67 3130 2864 665f 7375 6d5b 272d 6c6f  og10(df_sum['-lo
+0000d3a0: 6750 275d 202b 2031 652d 3329 0a20 2020  gP'] + 1e-3).   
+0000d3b0: 2020 2020 2070 6172 616d 203d 2062 696d       param = bim
+0000d3c0: 6f64 616c 5f66 6974 2820 785f 7363 6f72  odal_fit( x_scor
+0000d3d0: 6520 290a 2020 2020 2020 2020 7468 7265  e ).        thre
+0000d3e0: 7368 203d 2067 6574 5f74 6872 6573 686f  sh = get_thresho
+0000d3f0: 6c64 5f75 7369 6e67 5f70 6172 616d 2820  ld_using_param( 
+0000d400: 7061 7261 6d2c 2054 6172 6765 745f 4650  param, Target_FP
+0000d410: 5220 3d20 7461 7267 6574 5f46 5052 2029  R = target_FPR )
+0000d420: 0a20 2020 2020 2020 2077 302c 206d 302c  .        w0, m0,
+0000d430: 2076 302c 2077 312c 206d 312c 2076 3120   v0, w1, m1, v1 
+0000d440: 3d20 7061 7261 6d20 0a20 2020 2020 2020  = param .       
+0000d450: 2023 206d 3020 3d20 3130 2a2a 6d30 0a20   # m0 = 10**m0. 
+0000d460: 2020 2020 2020 2023 206d 3120 3d20 3130         # m1 = 10
+0000d470: 2a2a 6d31 0a20 2020 2020 2020 2023 2074  **m1.        # t
+0000d480: 6872 6573 6820 3d20 3130 2a2a 7468 7265  hresh = 10**thre
+0000d490: 7368 0a20 2020 2020 2020 2074 6872 6573  sh.        thres
+0000d4a0: 686f 6c64 735b 745d 203d 2074 6872 6573  holds[t] = thres
+0000d4b0: 680a 2020 2020 2020 2020 6d31 6d32 5f72  h.        m1m2_r
+0000d4c0: 6174 696f 5b74 5d20 3d20 6d31 2f6d 3020  atio[t] = m1/m0 
+0000d4d0: 2320 2831 302a 2a6d 3129 2f28 3130 2a2a  # (10**m1)/(10**
+0000d4e0: 6d30 290a 0a20 2020 2020 2020 2069 6620  m0)..        if 
+0000d4f0: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+0000d500: 2020 2020 2070 7269 6e74 2827 2020 2025       print('   %
+0000d510: 3136 733a 2025 352e 3366 2c20 2535 2e33  16s: %5.3f, %5.3
+0000d520: 6620 3e20 2535 2e32 662c 2025 352e 3266  f > %5.2f, %5.2f
+0000d530: 203e 2025 692f 2569 2720 2520 5c0a 2020   > %i/%i' % \.  
+0000d540: 2020 2020 2020 2020 2020 2020 2874 2c20              (t, 
+0000d550: 6d31 2c20 6d30 2c20 7468 7265 7368 2c20  m1, m0, thresh, 
+0000d560: 6d31 2f6d 302c 200a 2020 2020 2020 2020  m1/m0, .        
+0000d570: 2020 2020 2020 206e 702e 7375 6d28 785f         np.sum(x_
+0000d580: 7363 6f72 6520 3e3d 2074 6872 6573 6829  score >= thresh)
+0000d590: 2c20 6c65 6e28 785f 7363 6f72 6529 2929  , len(x_score)))
+0000d5a0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0000d5b0: 2020 2066 6f72 2074 2069 6e20 7461 7267     for t in targ
+0000d5c0: 6574 5f74 7970 6573 3a0a 2020 2020 2020  et_types:.      
+0000d5d0: 2020 2020 2020 6966 2074 2021 3d20 2775        if t != 'u
+0000d5e0: 6e61 7373 6967 6e65 6427 3a0a 2020 2020  nassigned':.    
+0000d5f0: 2020 2020 2020 2020 2020 2020 7461 7267              targ
+0000d600: 6574 203d 2074 0a0a 2020 2020 2020 2020  et = t..        
+0000d610: 2020 2020 2020 2020 6231 203d 2028 6466          b1 = (df
+0000d620: 5f73 756d 5b27 6365 6c6c 5f74 7970 6528  _sum['cell_type(
+0000d630: 3173 7429 275d 203d 3d20 7461 7267 6574  1st)'] == target
+0000d640: 2920 2620 5c0a 2020 2020 2020 2020 2020  ) & \.          
+0000d650: 2020 2020 2020 2020 2020 2028 6466 5f73             (df_s
+0000d660: 756d 5b27 2d6c 6f67 5027 5d20 3e3d 202d  um['-logP'] >= -
+0000d670: 6e70 2e6c 6f67 3130 2870 7661 6c5f 7468  np.log10(pval_th
+0000d680: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+0000d690: 2020 2076 3120 3d20 6466 5f73 756d 2e6c     v1 = df_sum.l
+0000d6a0: 6f63 5b62 312c 2027 2d6c 6f67 5027 5d0a  oc[b1, '-logP'].
+0000d6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d6c0: 6d31 203d 2064 665f 7375 6d2e 6c6f 635b  m1 = df_sum.loc[
+0000d6d0: 6231 2c20 272d 6c6f 6750 275d 2e6d 6561  b1, '-logP'].mea
+0000d6e0: 6e28 290a 2020 2020 2020 2020 2020 2020  n().            
+0000d6f0: 2020 2020 6e31 203d 206e 702e 7375 6d28      n1 = np.sum(
+0000d700: 6231 290a 0a20 2020 2020 2020 2020 2020  b1)..           
+0000d710: 2020 2020 2062 3220 3d20 2864 665f 7375       b2 = (df_su
+0000d720: 6d5b 2763 656c 6c5f 7479 7065 2832 6e64  m['cell_type(2nd
+0000d730: 2927 5d20 3d3d 2074 6172 6765 7429 2026  )'] == target) &
+0000d740: 205c 0a20 2020 2020 2020 2020 2020 2020   \.             
+0000d750: 2020 2020 2020 2020 2864 665f 7375 6d5b          (df_sum[
+0000d760: 272d 6c6f 6750 2832 6e64 2927 5d20 3e20  '-logP(2nd)'] > 
+0000d770: 2d6e 702e 6c6f 6731 3028 7076 616c 5f74  -np.log10(pval_t
+0000d780: 6829 290a 2020 2020 2020 2020 2020 2020  h)).            
+0000d790: 2020 2020 6966 206e 702e 7375 6d28 6232      if np.sum(b2
+0000d7a0: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
+0000d7b0: 2020 2020 2020 2020 2020 2076 3220 3d20             v2 = 
+0000d7c0: 6466 5f73 756d 2e6c 6f63 5b62 322c 2027  df_sum.loc[b2, '
+0000d7d0: 2d6c 6f67 5028 326e 6429 275d 0a20 2020  -logP(2nd)'].   
+0000d7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d7f0: 206d 3220 3d20 6466 5f73 756d 2e6c 6f63   m2 = df_sum.loc
+0000d800: 5b62 322c 2027 2d6c 6f67 5028 326e 6429  [b2, '-logP(2nd)
+0000d810: 275d 2e6d 6561 6e28 290a 2020 2020 2020  '].mean().      
+0000d820: 2020 2020 2020 2020 2020 2020 2020 6e32                n2
+0000d830: 203d 206e 702e 7375 6d28 6232 290a 0a20   = np.sum(b2).. 
+0000d840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d850: 2020 204e 4e20 3d20 696e 7428 6e31 2a74     NN = int(n1*t
+0000d860: 6172 6765 745f 4650 5229 0a20 2020 2020  arget_FPR).     
+0000d870: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000d880: 6872 6573 6820 3d20 6765 745f 7468 7265  hresh = get_thre
+0000d890: 7368 6f6c 645f 4e28 7632 2c20 4e4e 203d  shold_N(v2, NN =
+0000d8a0: 204e 4e2c 2075 7070 6572 203d 2054 7275   NN, upper = Tru
+0000d8b0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0000d8c0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+0000d8d0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000d8e0: 685f 6c73 7420 3d20 6c69 7374 2828 3530  h_lst = list((50
+0000d8f0: 3020 2d20 6e70 2e61 7261 6e67 6528 3530  0 - np.arange(50
+0000d900: 3029 292a 7631 2e6d 6178 2829 2f35 3030  0))*v1.max()/500
+0000d910: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000d920: 2020 2020 2020 7468 7265 7368 203d 202d        thresh = -
+0000d930: 6e70 2e6c 6f67 3130 2870 7661 6c5f 7468  np.log10(pval_th
+0000d940: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000d950: 2020 2020 2020 666f 7220 7468 2069 6e20        for th in 
+0000d960: 7468 5f6c 7374 3a0a 2020 2020 2020 2020  th_lst:.        
+0000d970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d980: 7a31 203d 206e 702e 7375 6d28 7631 203e  z1 = np.sum(v1 >
+0000d990: 2074 6829 2f6c 656e 2876 3129 0a20 2020   th)/len(v1).   
+0000d9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d9b0: 2020 2020 207a 3220 3d20 6e70 2e73 756d       z2 = np.sum
+0000d9c0: 2876 3220 3e20 7468 292f 6c65 6e28 7632  (v2 > th)/len(v2
+0000d9d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000d9e0: 2020 2020 2020 2020 2020 6966 207a 322f            if z2/
+0000d9f0: 287a 312b 7a32 2920 3e20 7461 7267 6574  (z1+z2) > target
+0000da00: 5f46 5052 3a0a 2020 2020 2020 2020 2020  _FPR:.          
+0000da10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000da20: 2020 7468 7265 7368 203d 2074 680a 2020    thresh = th.  
+0000da30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000da40: 2020 2727 270a 2020 2020 2020 2020 2020    '''.          
+0000da50: 2020 2020 2020 2020 2020 7468 7265 7368            thresh
+0000da60: 203d 206d 6178 2874 6872 6573 682c 202d   = max(thresh, -
+0000da70: 6e70 2e6c 6f67 3130 2870 7661 6c5f 7468  np.log10(pval_th
+0000da80: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+0000da90: 2020 2020 2020 2023 2074 685f 6d69 6e20         # th_min 
+0000daa0: 3d20 6765 745f 7468 7265 7368 6f6c 6428  = get_threshold(
+0000dab0: 7631 2c20 7461 7267 6574 5f46 5052 203d  v1, target_FPR =
+0000dac0: 2030 2e31 2c20 7570 7065 7220 3d20 4661   0.1, upper = Fa
+0000dad0: 6c73 6529 0a20 2020 2020 2020 2020 2020  lse).           
+0000dae0: 2020 2020 2020 2020 2023 2069 6620 7468           # if th
+0000daf0: 7265 7368 203c 2074 685f 6d69 6e3a 200a  resh < th_min: .
+0000db00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000db10: 2020 2020 2320 2020 2020 7468 7265 7368      #     thresh
+0000db20: 203d 2074 685f 6d69 6e0a 2020 2020 2020   = th_min.      
+0000db30: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000db40: 2074 6872 6573 6820 3e20 6d31 3a20 7468   thresh > m1: th
+0000db50: 7265 7368 203d 206d 310a 2020 2020 2020  resh = m1.      
+0000db60: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0000db70: 6966 2028 7468 7265 7368 203c 206d 3229  if (thresh < m2)
+0000db80: 2026 2028 6d31 203e 206d 3229 3a20 7468   & (m1 > m2): th
+0000db90: 7265 7368 203d 206d 320a 2020 2020 2020  resh = m2.      
+0000dba0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+0000dbb0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000dbc0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000dbd0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+0000dbe0: 7631 2920 3e20 313a 0a20 2020 2020 2020  v1) > 1:.       
+0000dbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc00: 2074 6872 6573 6820 3d20 6765 745f 7468   thresh = get_th
+0000dc10: 7265 7368 6f6c 6428 7631 2c20 7461 7267  reshold(v1, targ
+0000dc20: 6574 5f46 5052 203d 2030 2e31 2c20 7570  et_FPR = 0.1, up
+0000dc30: 7065 7220 3d20 4661 6c73 6529 0a20 2020  per = False).   
+0000dc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc50: 2020 2020 2069 6620 7468 7265 7368 203e       if thresh >
+0000dc60: 206d 313a 2074 6872 6573 6820 3d20 6d31   m1: thresh = m1
+0000dc70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dc80: 2020 2020 2020 2020 2074 6872 6573 6820           thresh 
+0000dc90: 3d20 6d61 7828 7468 7265 7368 2c20 2d6e  = max(thresh, -n
+0000dca0: 702e 6c6f 6731 3028 7076 616c 5f74 6829  p.log10(pval_th)
+0000dcb0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000dcc0: 2020 2020 2020 2020 2020 6d32 203d 2030            m2 = 0
+0000dcd0: 2e30 310a 2020 2020 2020 2020 2020 2020  .01.            
+0000dce0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000dcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd00: 2020 2020 2020 7468 7265 7368 203d 2030        thresh = 0
+0000dd10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dd20: 2020 2020 2020 2020 206d 3220 3d20 302e           m2 = 0.
+0000dd30: 3031 0a0a 2020 2020 2020 2020 2020 2020  01..            
+0000dd40: 2020 2020 7468 7265 7368 6f6c 6473 5b74      thresholds[t
+0000dd50: 5d20 3d20 7468 7265 7368 0a20 2020 2020  ] = thresh.     
+0000dd60: 2020 2020 2020 2020 2020 206d 316d 325f             m1m2_
+0000dd70: 7261 7469 6f5b 745d 203d 206d 312f 6d32  ratio[t] = m1/m2
+0000dd80: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000dd90: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+0000dda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ddb0: 2020 7072 696e 7428 2720 2020 2531 3673    print('   %16s
+0000ddc0: 3a20 2535 2e33 662c 2025 352e 3366 203e  : %5.3f, %5.3f >
+0000ddd0: 2025 352e 3266 2c20 2535 2e32 6620 3e20   %5.2f, %5.2f > 
+0000dde0: 2569 2f25 6927 2025 205c 0a20 2020 2020  %i/%i' % \.     
+0000ddf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000de00: 2028 742c 206d 312c 206d 322c 2074 6872   (t, m1, m2, thr
+0000de10: 6573 682c 206d 312f 6d32 2c20 6e70 2e73  esh, m1/m2, np.s
+0000de20: 756d 2876 3120 3e3d 2074 6872 6573 6829  um(v1 >= thresh)
+0000de30: 2c20 6c65 6e28 7631 2920 2920 290a 2020  , len(v1) ) ).  
+0000de40: 2020 2020 2020 2020 2020 0a20 2020 2072            .    r
+0000de50: 6574 7572 6e20 7468 7265 7368 6f6c 6473  eturn thresholds
+0000de60: 2c20 6d31 6d32 5f72 6174 696f 0a23 2727  , m1m2_ratio.#''
+0000de70: 270a 0a64 6566 2067 6574 5f73 7461 7428  '..def get_stat(
+0000de80: 6466 5f73 636f 7265 293a 0a0a 2020 2020  df_score):..    
+0000de90: 6466 203d 2064 665f 7363 6f72 650a 2020  df = df_score.  
+0000dea0: 2020 6d61 7876 203d 206c 6973 7428 6466    maxv = list(df
+0000deb0: 2e6d 6178 2861 7869 7320 3d20 3129 290a  .max(axis = 1)).
+0000dec0: 2020 2020 7375 6274 7970 6520 3d20 6c69      subtype = li
+0000ded0: 7374 2864 662e 6964 786d 6178 2861 7869  st(df.idxmax(axi
+0000dee0: 7320 3d20 3129 290a 2020 2020 2374 635f  s = 1)).    #tc_
+0000def0: 7375 6274 7970 6520 3d20 5b74 7261 6e73  subtype = [trans
+0000df00: 5f64 6963 745b 6b5d 2066 6f72 206b 2069  _dict[k] for k i
+0000df10: 6e20 7463 5f73 7562 7479 7065 5d0a 0a20  n tc_subtype].. 
+0000df20: 2020 206d 6178 7632 203d 205b 5d0a 2020     maxv2 = [].  
+0000df30: 2020 6964 7832 203d 205b 5d0a 2020 2020    idx2 = [].    
+0000df40: 7375 6274 7970 655f 6c73 7420 3d20 6c69  subtype_lst = li
+0000df50: 7374 2864 662e 636f 6c75 6d6e 732e 7661  st(df.columns.va
+0000df60: 6c75 6573 290a 0a20 2020 2066 6f72 2069  lues)..    for i
+0000df70: 2069 6e20 7261 6e67 6528 6466 2e73 6861   in range(df.sha
+0000df80: 7065 5b30 5d29 3a0a 2020 2020 2020 2020  pe[0]):.        
+0000df90: 7820 3d20 6e70 2e61 7272 6179 2864 662e  x = np.array(df.
+0000dfa0: 696c 6f63 5b69 5d29 0a20 2020 2020 2020  iloc[i]).       
+0000dfb0: 206f 6472 203d 2028 2d78 292e 6172 6773   odr = (-x).args
+0000dfc0: 6f72 7428 290a 2020 2020 2020 2020 6966  ort().        if
+0000dfd0: 206c 656e 2878 2920 3e20 313a 0a20 2020   len(x) > 1:.   
+0000dfe0: 2020 2020 2020 2020 206d 6178 7632 2e61           maxv2.a
+0000dff0: 7070 656e 6428 785b 6f64 725b 315d 5d29  ppend(x[odr[1]])
+0000e000: 0a20 2020 2020 2020 2020 2020 2069 6478  .            idx
+0000e010: 322e 6170 7065 6e64 2873 7562 7479 7065  2.append(subtype
+0000e020: 5f6c 7374 5b6f 6472 5b31 5d5d 290a 2020  _lst[odr[1]]).  
+0000e030: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000e040: 2020 2020 2020 2020 6d61 7876 322e 6170          maxv2.ap
+0000e050: 7065 6e64 2830 290a 2020 2020 2020 2020  pend(0).        
+0000e060: 2020 2020 6964 7832 2e61 7070 656e 6428      idx2.append(
+0000e070: 4e6f 6e65 290a 0a20 2020 2023 2064 665f  None)..    # df_
+0000e080: 7265 7320 3d20 7064 2e44 6174 6146 7261  res = pd.DataFra
+0000e090: 6d65 287b 2743 4434 2b20 5420 6365 6c6c  me({'CD4+ T cell
+0000e0a0: 2073 7562 7479 7065 273a 2074 635f 7375   subtype': tc_su
+0000e0b0: 6274 7970 652c 2027 4e65 674c 6f67 5076  btype, 'NegLogPv
+0000e0c0: 616c 273a 206e 6567 5f6c 6f67 5f70 7661  al': neg_log_pva
+0000e0d0: 6c7d 2c20 696e 6465 7820 3d20 6466 2e69  l}, index = df.i
+0000e0e0: 6e64 6578 2e76 616c 7565 7329 0a20 2020  ndex.values).   
+0000e0f0: 2064 665f 7265 7320 3d20 7064 2e44 6174   df_res = pd.Dat
+0000e100: 6146 7261 6d65 287b 2763 656c 6c5f 7479  aFrame({'cell_ty
+0000e110: 7065 273a 2073 7562 7479 7065 2c20 2763  pe': subtype, 'c
+0000e120: 656c 6c5f 7479 7065 2872 6576 2927 3a20  ell_type(rev)': 
+0000e130: 7375 6274 7970 652c 200a 2020 2020 2020  subtype, .      
+0000e140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e150: 2020 2020 2027 6365 6c6c 5f74 7970 6528       'cell_type(
+0000e160: 3173 7429 273a 2073 7562 7479 7065 2c20  1st)': subtype, 
+0000e170: 2763 656c 6c5f 7479 7065 2832 6e64 2927  'cell_type(2nd)'
+0000e180: 3a20 6964 7832 2c20 0a20 2020 2020 2020  : idx2, .       
+0000e190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e1a0: 2020 2020 2743 6c61 7269 7479 273a 205b      'Clarity': [
+0000e1b0: 272d 275d 2a64 662e 7368 6170 655b 305d  '-']*df.shape[0]
+0000e1c0: 2c20 2753 636f 7265 273a 206d 6178 762c  , 'Score': maxv,
+0000e1d0: 2027 5363 6f72 6528 326e 6429 273a 206d   'Score(2nd)': m
+0000e1e0: 6178 7632 7d2c 200a 2020 2020 2020 2020  axv2}, .        
+0000e1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e200: 2020 696e 6465 7820 3d20 6466 2e69 6e64    index = df.ind
+0000e210: 6578 2e76 616c 7565 7329 0a20 2020 2064  ex.values).    d
+0000e220: 665f 7265 735b 2764 5363 6f72 6527 5d20  f_res['dScore'] 
+0000e230: 3d20 6466 5f72 6573 5b27 5363 6f72 6527  = df_res['Score'
+0000e240: 5d20 2d20 6466 5f72 6573 5b27 5363 6f72  ] - df_res['Scor
+0000e250: 6528 326e 6429 275d 0a20 2020 200a 2020  e(2nd)'].    .  
+0000e260: 2020 7265 7475 726e 2064 665f 7265 730a    return df_res.
+0000e270: 0a0a 6465 6620 6765 745f 7468 7265 7368  ..def get_thresh
+0000e280: 6f6c 645f 6672 6f6d 5f47 4d4d 5f72 6573  old_from_GMM_res
+0000e290: 756c 7428 6466 5f73 756d 2c20 7461 7267  ult(df_sum, targ
+0000e2a0: 6574 5f46 5052 203d 2030 2e30 352c 200a  et_FPR = 0.05, .
+0000e2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e2d0: 2020 2076 6572 626f 7365 203d 2046 616c     verbose = Fal
+0000e2e0: 7365 2c20 706c 6f74 5f68 6973 7420 3d20  se, plot_hist = 
+0000e2f0: 4661 6c73 6529 3a0a 2020 2020 0a20 2020  False):.    .   
+0000e300: 2074 6172 6765 745f 7479 7065 7320 3d20   target_types = 
+0000e310: 6c69 7374 2864 665f 7375 6d5b 2763 656c  list(df_sum['cel
+0000e320: 6c5f 7479 7065 2831 7374 2927 5d2e 756e  l_type(1st)'].un
+0000e330: 6971 7565 2829 290a 2020 2020 7468 7265  ique()).    thre
+0000e340: 7368 6f6c 6473 203d 207b 7d0a 2020 2020  sholds = {}.    
+0000e350: 6d31 6d32 5f72 6174 696f 203d 207b 7d0a  m1m2_ratio = {}.
+0000e360: 2020 2020 0a20 2020 2069 6620 7665 7262      .    if verb
+0000e370: 6f73 653a 0a20 2020 2020 2020 2070 7269  ose:.        pri
+0000e380: 6e74 2827 5468 7265 7368 6f6c 6473 3a27  nt('Thresholds:'
+0000e390: 290a 2020 2020 2020 2020 0a20 2020 2066  ).        .    f
+0000e3a0: 6f72 2074 2069 6e20 7461 7267 6574 5f74  or t in target_t
+0000e3b0: 7970 6573 3a0a 2020 2020 2020 2020 7461  ypes:.        ta
+0000e3c0: 7267 6574 203d 2074 0a0a 2020 2020 2020  rget = t..      
+0000e3d0: 2020 6231 203d 2028 6466 5f73 756d 5b27    b1 = (df_sum['
+0000e3e0: 6365 6c6c 5f74 7970 6528 7265 7629 275d  cell_type(rev)']
+0000e3f0: 203d 3d20 7461 7267 6574 2920 2326 2028   == target) #& (
+0000e400: 6466 5f73 756d 5b27 2d6c 6f67 5027 5d20  df_sum['-logP'] 
+0000e410: 3e20 2d6e 702e 6c6f 6731 3028 7076 616c  > -np.log10(pval
+0000e420: 5f74 6829 290a 2020 2020 2020 2020 7631  _th)).        v1
+0000e430: 203d 2064 665f 7375 6d2e 6c6f 635b 6231   = df_sum.loc[b1
+0000e440: 2c20 2753 636f 7265 275d 0a20 2020 2020  , 'Score'].     
+0000e450: 2020 206d 3120 3d20 6466 5f73 756d 2e6c     m1 = df_sum.l
+0000e460: 6f63 5b62 312c 2027 5363 6f72 6527 5d2e  oc[b1, 'Score'].
+0000e470: 6d61 7828 2920 232e 6d65 616e 2829 0a20  max() #.mean(). 
+0000e480: 2020 2020 2020 206e 3120 3d20 6e70 2e73         n1 = np.s
+0000e490: 756d 2862 3129 0a0a 2020 2020 2020 2020  um(b1)..        
+0000e4a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000e4b0: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
+0000e4c0: 2020 2020 2020 2062 3220 3d20 2864 665f         b2 = (df_
+0000e4d0: 7375 6d5b 2763 656c 6c5f 7479 7065 2832  sum['cell_type(2
+0000e4e0: 6e64 2927 5d20 3d3d 2074 6172 6765 7429  nd)'] == target)
+0000e4f0: 2026 205c 0a20 2020 2020 2020 2020 2020   & \.           
+0000e500: 2020 2864 665f 7375 6d5b 2763 656c 6c5f    (df_sum['cell_
+0000e510: 7479 7065 2872 6576 2927 5d20 213d 2027  type(rev)'] != '
+0000e520: 756e 6173 7369 676e 6564 2729 200a 2020  unassigned') .  
+0000e530: 2020 2020 2020 6966 206e 702e 7375 6d28        if np.sum(
+0000e540: 6232 2920 3e20 303a 0a20 2020 2020 2020  b2) > 0:.       
+0000e550: 2020 2020 2076 3220 3d20 6466 5f73 756d       v2 = df_sum
+0000e560: 2e6c 6f63 5b62 322c 2027 5363 6f72 6528  .loc[b2, 'Score(
+0000e570: 326e 6429 275d 0a20 2020 2020 2020 2020  2nd)'].         
+0000e580: 2020 206d 3220 3d20 6466 5f73 756d 2e6c     m2 = df_sum.l
+0000e590: 6f63 5b62 322c 2027 5363 6f72 6528 326e  oc[b2, 'Score(2n
+0000e5a0: 6429 275d 2e6d 6178 2829 2023 2e6d 6561  d)'].max() #.mea
+0000e5b0: 6e28 290a 2020 2020 2020 2020 2020 2020  n().            
+0000e5c0: 6e32 203d 206e 702e 7375 6d28 6232 290a  n2 = np.sum(b2).
+0000e5d0: 0a20 2020 2020 2020 2020 2020 2027 2727  .            '''
+0000e5e0: 0a20 2020 2020 2020 2020 2020 206e 7820  .            nx 
+0000e5f0: 3d20 696e 7428 6e31 2a74 6172 6765 745f  = int(n1*target_
+0000e600: 4650 5229 0a20 2020 2020 2020 2020 2020  FPR).           
+0000e610: 206f 6472 203d 206e 702e 6172 7261 7928   odr = np.array(
+0000e620: 7632 292e 6172 6773 6f72 7428 290a 2020  v2).argsort().  
+0000e630: 2020 2020 2020 2020 2020 6966 206e 7820            if nx 
+0000e640: 3d3d 2030 3a20 6e78 203d 2031 0a20 2020  == 0: nx = 1.   
+0000e650: 2020 2020 2020 2020 2065 6c69 6620 6e78           elif nx
+0000e660: 203e 3d20 6c65 6e28 7632 293a 206e 7820   >= len(v2): nx 
+0000e670: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
+0000e680: 7468 7265 7368 203d 2076 325b 6f64 725b  thresh = v2[odr[
+0000e690: 2d6e 785d 5d20 0a20 2020 2020 2020 2020  -nx]] .         
+0000e6a0: 2020 2023 2727 270a 2020 2020 2020 2020     #'''.        
+0000e6b0: 2020 2020 4e4e 203d 2069 6e74 286e 312a      NN = int(n1*
+0000e6c0: 7461 7267 6574 5f46 5052 290a 2020 2020  target_FPR).    
+0000e6d0: 2020 2020 2020 2020 7468 7265 7368 203d          thresh =
+0000e6e0: 2067 6574 5f74 6872 6573 686f 6c64 5f4e   get_threshold_N
+0000e6f0: 2876 322c 204e 4e20 3d20 4e4e 2c20 7570  (v2, NN = NN, up
+0000e700: 7065 7220 3d20 5472 7565 290a 2020 2020  per = True).    
+0000e710: 2020 2020 2020 2020 2374 6872 6573 6820          #thresh 
+0000e720: 3d20 6e70 2e6d 6178 2876 3229 0a20 2020  = np.max(v2).   
+0000e730: 2020 2020 2020 2020 2023 2067 6574 5f74           # get_t
+0000e740: 6872 6573 686f 6c64 2876 322c 2074 6172  hreshold(v2, tar
+0000e750: 6765 745f 4650 5220 3d20 7461 7267 6574  get_FPR = target
+0000e760: 5f46 5052 2c20 7570 7065 7220 3d20 5472  _FPR, upper = Tr
+0000e770: 7565 290a 2020 2020 2020 2020 656c 7365  ue).        else
+0000e780: 3a0a 2020 2020 2020 2020 2020 2020 6d32  :.            m2
+0000e790: 203d 2064 665f 7375 6d2e 6c6f 635b 6231   = df_sum.loc[b1
+0000e7a0: 2c20 2753 636f 7265 275d 2e6d 6561 6e28  , 'Score'].mean(
+0000e7b0: 290a 2020 2020 2020 2020 2020 2020 7632  ).            v2
+0000e7c0: 203d 2064 665f 7375 6d2e 6c6f 635b 6231   = df_sum.loc[b1
+0000e7d0: 2c20 2753 636f 7265 275d 0a20 2020 2020  , 'Score'].     
+0000e7e0: 2020 2020 2020 2074 6872 6573 6820 3d20         thresh = 
+0000e7f0: 6d32 2023 6765 745f 7468 7265 7368 6f6c  m2 #get_threshol
+0000e800: 6428 7631 2c20 7461 7267 6574 5f46 5052  d(v1, target_FPR
+0000e810: 203d 2074 6172 6765 745f 4650 522c 2075   = target_FPR, u
+0000e820: 7070 6572 203d 2046 616c 7365 290a 2020  pper = False).  
+0000e830: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
+0000e840: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+0000e850: 2020 2020 2020 7072 696e 7428 2757 4152        print('WAR
+0000e860: 4e49 4e47 3a20 7468 7265 7368 6f6c 6473  NING: thresholds
+0000e870: 2066 6f72 2025 7320 7761 7320 7365 7420   for %s was set 
+0000e880: 746f 2025 362e 3266 202d 2031 3020 3d20  to %6.2f - 10 = 
+0000e890: 2536 2e32 6627 2025 2028 742c 206d 312c  %6.2f' % (t, m1,
+0000e8a0: 2074 6872 6573 6829 290a 0a20 2020 2020   thresh))..     
+0000e8b0: 2020 2074 6872 6573 686f 6c64 735b 745d     thresholds[t]
+0000e8c0: 203d 2074 6872 6573 680a 2020 2020 2020   = thresh.      
+0000e8d0: 2020 6d31 6d32 5f72 6174 696f 5b74 5d20    m1m2_ratio[t] 
+0000e8e0: 3d20 6d31 2d6d 320a 0a20 2020 2020 2020  = m1-m2..       
+0000e8f0: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+0000e900: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+0000e910: 2020 2025 3136 733a 2025 362e 3266 2c20     %16s: %6.2f, 
+0000e920: 2536 2e32 6620 3e20 5468 7265 7368 6f6c  %6.2f > Threshol
+0000e930: 643a 2025 362e 3266 203e 2025 692f 2569  d: %6.2f > %i/%i
+0000e940: 2c20 2025 692f 2569 2720 2520 5c0a 2020  ,  %i/%i' % \.  
+0000e950: 2020 2020 2020 2020 2020 2020 2874 2c20              (t, 
+0000e960: 6d31 2c20 6d32 2c20 7468 7265 7368 2c20  m1, m2, thresh, 
+0000e970: 6e70 2e73 756d 2876 3120 3e3d 2074 6872  np.sum(v1 >= thr
+0000e980: 6573 6829 2c20 6c65 6e28 7631 292c 206e  esh), len(v1), n
+0000e990: 702e 7375 6d28 7632 203e 3d20 7468 7265  p.sum(v2 >= thre
+0000e9a0: 7368 292c 206c 656e 2876 3229 2929 0a20  sh), len(v2))). 
+0000e9b0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+0000e9c0: 7265 7475 726e 2074 6872 6573 686f 6c64  return threshold
+0000e9d0: 732c 206d 316d 325f 7261 7469 6f0a 0a0a  s, m1m2_ratio...
+0000e9e0: 6465 6620 6765 745f 6d61 6a6f 7269 7469  def get_majoriti
+0000e9f0: 6573 2879 2c20 795f 636c 7573 7429 3a0a  es(y, y_clust):.
+0000ea00: 2020 2020 0a20 2020 206c 6162 656c 735f      .    labels_
+0000ea10: 756e 6971 7565 2c20 636f 756e 7473 203d  unique, counts =
+0000ea20: 206e 702e 756e 6971 7565 2879 5f63 6c75   np.unique(y_clu
+0000ea30: 7374 2c20 7265 7475 726e 5f63 6f75 6e74  st, return_count
+0000ea40: 733d 5472 7565 290a 2020 2020 0a20 2020  s=True).    .   
+0000ea50: 206d 616a 5f6c 7374 203d 205b 5d0a 2020   maj_lst = [].  
+0000ea60: 2020 636e 745f 6c73 7420 3d20 5b5d 0a20    cnt_lst = []. 
+0000ea70: 2020 2066 6f72 2063 2069 6e20 6c69 7374     for c in list
+0000ea80: 286c 6162 656c 735f 756e 6971 7565 293a  (labels_unique):
+0000ea90: 0a20 2020 2020 2020 2062 203d 206e 702e  .        b = np.
+0000eaa0: 6172 7261 7928 795f 636c 7573 7429 203d  array(y_clust) =
+0000eab0: 3d20 630a 2020 2020 2020 2020 6374 732c  = c.        cts,
+0000eac0: 2063 6e74 7320 3d20 6e70 2e75 6e69 7175   cnts = np.uniqu
+0000ead0: 6528 795b 625d 2c20 7265 7475 726e 5f63  e(y[b], return_c
+0000eae0: 6f75 6e74 733d 5472 7565 290a 2020 2020  ounts=True).    
+0000eaf0: 2020 2020 6f64 7220 3d20 636e 7473 2e61      odr = cnts.a
+0000eb00: 7267 736f 7274 2829 0a20 2020 2020 2020  rgsort().       
+0000eb10: 206d 616a 6f72 6974 7920 3d20 6374 735b   majority = cts[
+0000eb20: 6f64 725b 2d31 5d5d 0a20 2020 2020 2020  odr[-1]].       
+0000eb30: 206d 616a 5f6c 7374 2e61 7070 656e 6428   maj_lst.append(
+0000eb40: 6d61 6a6f 7269 7479 290a 2020 2020 2020  majority).      
+0000eb50: 2020 636e 745f 6c73 742e 6170 7065 6e64    cnt_lst.append
+0000eb60: 2863 6e74 735b 6f64 725b 2d31 5d5d 290a  (cnts[odr[-1]]).
+0000eb70: 2020 2020 2020 2020 0a20 2020 206d 616a          .    maj
+0000eb80: 5f64 6963 7420 3d20 6469 6374 287a 6970  _dict = dict(zip
+0000eb90: 286c 6162 656c 735f 756e 6971 7565 2c20  (labels_unique, 
+0000eba0: 6d61 6a5f 6c73 7429 290a 2020 2020 636e  maj_lst)).    cn
+0000ebb0: 745f 6469 6374 203d 2064 6963 7428 7a69  t_dict = dict(zi
+0000ebc0: 7028 6c61 6265 6c73 5f75 6e69 7175 652c  p(labels_unique,
+0000ebd0: 2063 6e74 5f6c 7374 2929 0a20 2020 200a   cnt_lst)).    .
+0000ebe0: 2020 2020 7265 7475 726e 206d 616a 5f64      return maj_d
+0000ebf0: 6963 742c 2063 6e74 5f64 6963 740a 0a0a  ict, cnt_dict...
+0000ec00: 6465 6620 636c 7573 7465 725f 6261 7369  def cluster_basi
+0000ec10: 735f 636f 7272 6563 7469 6f6e 2858 5f70  s_correction(X_p
+0000ec20: 6361 2c20 792c 2063 6f62 6a2c 2079 5f63  ca, y, cobj, y_c
+0000ec30: 6c75 7374 2c20 706d 616a 203d 2030 2e37  lust, pmaj = 0.7
+0000ec40: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+0000ec50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec60: 6375 746f 6666 203d 2030 2e30 312c 2076  cutoff = 0.01, v
+0000ec70: 6572 626f 7365 203d 2046 616c 7365 2029  erbose = False )
+0000ec80: 3a0a 2020 2020 0a20 2020 2079 7320 3d20  :.    .    ys = 
+0000ec90: 7064 2e53 6572 6965 7328 7929 2e63 6f70  pd.Series(y).cop
+0000eca0: 7928 6465 6570 203d 2054 7275 6529 0a20  y(deep = True). 
+0000ecb0: 2020 200a 2020 2020 6164 6a5f 6167 6720     .    adj_agg 
+0000ecc0: 3d20 636f 626a 2e61 6767 7265 6761 7465  = cobj.aggregate
+0000ecd0: 5f0a 2020 2020 6164 6a5f 6167 675f 6d61  _.    adj_agg_ma
+0000ece0: 7420 3d20 6164 6a5f 6167 672e 746f 6465  t = adj_agg.tode
+0000ecf0: 6e73 6528 292e 6173 7479 7065 2869 6e74  nse().astype(int
+0000ed00: 2920 0a20 2020 206c 6162 656c 735f 756e  ) .    labels_un
+0000ed10: 6971 7565 2c20 636f 756e 7473 203d 206e  ique, counts = n
+0000ed20: 702e 756e 6971 7565 2879 5f63 6c75 7374  p.unique(y_clust
+0000ed30: 2c20 7265 7475 726e 5f63 6f75 6e74 733d  , return_counts=
+0000ed40: 5472 7565 290a 0a20 2020 2023 2320 4765  True)..    ## Ge
+0000ed50: 7420 6e65 6967 6862 6f72 2063 6c75 7374  t neighbor clust
+0000ed60: 6572 730a 2020 2020 2320 6375 746f 6666  ers.    # cutoff
+0000ed70: 203d 2030 2e30 310a 2020 2020 616a 203d   = 0.01.    aj =
+0000ed80: 207b 7d0a 2020 2020 666f 7220 6a20 696e   {}.    for j in
+0000ed90: 2072 616e 6765 286c 656e 286c 6162 656c   range(len(label
+0000eda0: 735f 756e 6971 7565 2929 3a0a 2020 2020  s_unique)):.    
+0000edb0: 2020 2020 6120 3d20 5b5d 0a20 2020 2020      a = [].     
+0000edc0: 2020 2062 203d 205b 5d0a 2020 2020 2020     b = [].      
+0000edd0: 2020 666f 7220 6b20 696e 2072 616e 6765    for k in range
+0000ede0: 286c 656e 286c 6162 656c 735f 756e 6971  (len(labels_uniq
+0000edf0: 7565 2929 3a0a 2020 2020 2020 2020 2020  ue)):.          
+0000ee00: 2020 6966 2028 6164 6a5f 6167 675f 6d61    if (adj_agg_ma
+0000ee10: 745b 6a2c 6b5d 203e 3d20 6164 6a5f 6167  t[j,k] >= adj_ag
+0000ee20: 675f 6d61 745b 6a2c 6a5d 2a63 7574 6f66  g_mat[j,j]*cutof
+0000ee30: 6629 2026 2028 6164 6a5f 6167 675f 6d61  f) & (adj_agg_ma
+0000ee40: 745b 6a2c 6b5d 203e 3d20 6164 6a5f 6167  t[j,k] >= adj_ag
+0000ee50: 675f 6d61 745b 6b2c 6b5d 2a63 7574 6f66  g_mat[k,k]*cutof
+0000ee60: 6629 3a0a 2020 2020 2020 2020 2020 2020  f):.            
+0000ee70: 2020 2020 612e 6170 7065 6e64 286b 290a      a.append(k).
+0000ee80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee90: 622e 6170 7065 6e64 2861 646a 5f61 6767  b.append(adj_agg
+0000eea0: 5f6d 6174 5b6a 2c6b 5d29 0a20 2020 2020  _mat[j,k]).     
+0000eeb0: 2020 2069 6620 6c65 6e28 6129 203e 2030     if len(a) > 0
+0000eec0: 3a0a 2020 2020 2020 2020 2020 2020 6f64  :.            od
+0000eed0: 7220 3d20 282d 6e70 2e61 7272 6179 2862  r = (-np.array(b
+0000eee0: 2929 2e61 7267 736f 7274 2829 0a20 2020  )).argsort().   
+0000eef0: 2020 2020 2020 2020 2061 3120 3d20 5b5d           a1 = []
+0000ef00: 0a20 2020 2020 2020 2020 2020 2062 3120  .            b1 
+0000ef10: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+0000ef20: 2062 6e20 3d20 5b5d 0a20 2020 2020 2020   bn = [].       
+0000ef30: 2020 2020 2066 6f72 206f 2069 6e20 6f64       for o in od
+0000ef40: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+0000ef50: 2020 2061 312e 6170 7065 6e64 2861 5b6f     a1.append(a[o
+0000ef60: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+0000ef70: 2020 2062 312e 6170 7065 6e64 2862 5b6f     b1.append(b[o
+0000ef80: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+0000ef90: 2020 206e 7620 3d20 696e 7428 3130 2a6e     nv = int(10*n
+0000efa0: 702e 6c6f 6731 3028 625b 6f5d 2f61 646a  p.log10(b[o]/adj
+0000efb0: 5f61 6767 5f6d 6174 5b6a 2c6a 5d20 2b20  _agg_mat[j,j] + 
+0000efc0: 3165 2d31 3029 290a 2020 2020 2020 2020  1e-10)).        
+0000efd0: 2020 2020 2020 2020 626e 2e61 7070 656e          bn.appen
+0000efe0: 6428 6e76 290a 2020 2020 2020 2020 2020  d(nv).          
+0000eff0: 2020 6420 3d20 6469 6374 287a 6970 2861    d = dict(zip(a
+0000f000: 312c 626e 2929 0a20 2020 2020 2020 2020  1,bn)).         
+0000f010: 2020 2062 6e2e 736f 7274 2872 6576 6572     bn.sort(rever
+0000f020: 7365 203d 2054 7275 6529 0a20 2020 2020  se = True).     
+0000f030: 2020 2020 2020 2061 6a5b 6a5d 203d 2064         aj[j] = d
+0000f040: 0a0a 2020 2020 2323 2047 6574 2063 6f6d  ..    ## Get com
+0000f050: 6d75 6e69 7479 206c 6973 740a 2020 2020  munity list.    
+0000f060: 636f 6d6d 756e 6974 6965 7320 3d20 5b5d  communities = []
+0000f070: 0a20 2020 2066 6f72 206b 6579 2069 6e20  .    for key in 
+0000f080: 616a 2e6b 6579 7328 293a 0a20 2020 2020  aj.keys():.     
+0000f090: 2020 2064 203d 2061 6a5b 6b65 795d 0a20     d = aj[key]. 
+0000f0a0: 2020 2020 2020 206e 6f64 6573 203d 206c         nodes = l
+0000f0b0: 6973 7428 642e 6b65 7973 2829 290a 2020  ist(d.keys()).  
+0000f0c0: 2020 2020 2020 6966 206c 656e 286e 6f64        if len(nod
+0000f0d0: 6573 2920 3e20 313a 0a20 2020 2020 2020  es) > 1:.       
+0000f0e0: 2020 2020 2063 6f6d 6d6f 6e20 3d20 6e6f       common = no
+0000f0f0: 6465 730a 2020 2020 2020 2020 2020 2020  des.            
+0000f100: 666f 7220 6e20 696e 206e 6f64 6573 3a0a  for n in nodes:.
+0000f110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f120: 636f 6d6d 6f6e 203d 206c 6973 7428 7365  common = list(se
+0000f130: 7428 636f 6d6d 6f6e 292e 696e 7465 7273  t(common).inters
+0000f140: 6563 7469 6f6e 286c 6973 7428 616a 5b6e  ection(list(aj[n
+0000f150: 5d2e 6b65 7973 2829 2929 290a 2020 2020  ].keys()))).    
+0000f160: 2020 2020 2020 2020 6966 206c 656e 2863          if len(c
+0000f170: 6f6d 6d6f 6e29 203e 2031 3a0a 2020 2020  ommon) > 1:.    
+0000f180: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
+0000f190: 756e 6974 6965 732e 6170 7065 6e64 2863  unities.append(c
+0000f1a0: 6f6d 6d6f 6e29 0a20 2020 2020 2020 2020  ommon).         
+0000f1b0: 2020 2020 2020 2023 2070 7269 6e74 286b         # print(k
+0000f1c0: 6579 2c20 273a 2027 2c20 636f 6d6d 6f6e  ey, ': ', common
+0000f1d0: 290a 0a20 2020 2074 6f5f 6465 6c20 3d20  )..    to_del = 
+0000f1e0: 5b5d 0a20 2020 2066 6f72 206b 2c20 6320  [].    for k, c 
+0000f1f0: 696e 2065 6e75 6d65 7261 7465 2863 6f6d  in enumerate(com
+0000f200: 6d75 6e69 7469 6573 293a 0a20 2020 2020  munities):.     
+0000f210: 2020 2062 203d 2046 616c 7365 0a20 2020     b = False.   
+0000f220: 2020 2020 2066 6f72 206b 322c 2063 3220       for k2, c2 
+0000f230: 696e 2065 6e75 6d65 7261 7465 2863 6f6d  in enumerate(com
+0000f240: 6d75 6e69 7469 6573 293a 0a20 2020 2020  munities):.     
+0000f250: 2020 2020 2020 2069 6620 286b 3220 213d         if (k2 !=
+0000f260: 206b 2920 2620 286b 206e 6f74 2069 6e20   k) & (k not in 
+0000f270: 746f 5f64 656c 2920 2620 286b 3220 6e6f  to_del) & (k2 no
+0000f280: 7420 696e 2074 6f5f 6465 6c29 3a0a 2020  t in to_del):.  
+0000f290: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000f2a0: 2028 6c65 6e28 6c69 7374 2873 6574 2863   (len(list(set(c
+0000f2b0: 2920 2d20 7365 7428 6332 2929 2920 3d3d  ) - set(c2))) ==
+0000f2c0: 2030 293a 0a20 2020 2020 2020 2020 2020   0):.           
+0000f2d0: 2020 2020 2020 2020 2074 6f5f 6465 6c2e           to_del.
+0000f2e0: 6170 7065 6e64 286b 290a 0a20 2020 2066  append(k)..    f
+0000f2f0: 6f72 206b 2069 6e20 7265 7665 7273 6564  or k in reversed
+0000f300: 2874 6f5f 6465 6c29 3a0a 2020 2020 2020  (to_del):.      
+0000f310: 2020 6465 6c20 636f 6d6d 756e 6974 6965    del communitie
+0000f320: 735b 6b5d 0a20 2020 200a 2020 2020 636c  s[k].    .    cl
+0000f330: 7573 745f 6d61 6a5f 6469 6374 2c20 636c  ust_maj_dict, cl
+0000f340: 7573 745f 636e 745f 6469 6374 203d 2067  ust_cnt_dict = g
+0000f350: 6574 5f6d 616a 6f72 6974 6965 7328 792c  et_majorities(y,
+0000f360: 2079 5f63 6c75 7374 290a 2020 2020 0a20   y_clust).    . 
+0000f370: 2020 2066 6f72 206b 2c20 636f 6d6d 756e     for k, commun
+0000f380: 6974 7920 696e 2065 6e75 6d65 7261 7465  ity in enumerate
+0000f390: 2863 6f6d 6d75 6e69 7469 6573 293a 0a20  (communities):. 
+0000f3a0: 2020 2020 2020 2069 6620 286c 656e 2863         if (len(c
+0000f3b0: 6f6d 6d75 6e69 7479 2920 3e20 3129 3a0a  ommunity) > 1):.
+0000f3c0: 2020 2020 2020 2020 2020 2020 2323 2063              ## c
+0000f3d0: 6865 636b 2069 6620 2775 6e61 7373 6967  heck if 'unassig
+0000f3e0: 6e65 6427 2063 6c75 7374 6572 0a20 2020  ned' cluster.   
+0000f3f0: 2020 2020 2020 2020 2063 745f 636e 745f           ct_cnt_
+0000f400: 6469 6374 203d 207b 7d0a 2020 2020 2020  dict = {}.      
+0000f410: 2020 2020 2020 666f 7220 636d 2069 6e20        for cm in 
+0000f420: 636f 6d6d 756e 6974 793a 0a20 2020 2020  community:.     
+0000f430: 2020 2020 2020 2020 2020 2069 6620 636c             if cl
+0000f440: 7573 745f 6d61 6a5f 6469 6374 5b63 6d5d  ust_maj_dict[cm]
+0000f450: 2069 6e20 6c69 7374 2863 745f 636e 745f   in list(ct_cnt_
+0000f460: 6469 6374 2e6b 6579 7328 2929 3a0a 2020  dict.keys()):.  
+0000f470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f480: 2020 6374 5f63 6e74 5f64 6963 745b 636c    ct_cnt_dict[cl
+0000f490: 7573 745f 6d61 6a5f 6469 6374 5b63 6d5d  ust_maj_dict[cm]
+0000f4a0: 5d20 2b3d 2063 6c75 7374 5f63 6e74 5f64  ] += clust_cnt_d
+0000f4b0: 6963 745b 636d 5d0a 2020 2020 2020 2020  ict[cm].        
+0000f4c0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
 0000f4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f4e0: 6b65 7920 3d20 6b65 7973 5b6f 5d0a 2020  key = keys[o].  
-0000f4f0: 2020 2020 2020 2020 2020 2020 2020 7661                va
-0000f500: 6c20 3d20 6374 5f63 6e74 5f64 6963 745b  l = ct_cnt_dict[
-0000f510: 6b65 795d 0a20 2020 2020 2020 2020 2020  key].           
-0000f520: 2020 2020 2063 745f 636e 745f 6469 6374       ct_cnt_dict
-0000f530: 5f6e 6577 5b6b 6579 5d20 3d20 7661 6c0a  _new[key] = val.
-0000f540: 2020 2020 2020 2020 2020 2020 6374 5f63              ct_c
-0000f550: 6e74 5f64 6963 7420 3d20 6374 5f63 6e74  nt_dict = ct_cnt
-0000f560: 5f64 6963 745f 6e65 770a 2020 2020 2020  _dict_new.      
-0000f570: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-0000f580: 2020 2020 2020 2069 6620 286c 656e 286c         if (len(l
-0000f590: 6973 7428 6374 5f63 6e74 5f64 6963 742e  ist(ct_cnt_dict.
-0000f5a0: 6b65 7973 2829 2929 203e 2031 293a 2023  keys())) > 1): #
-0000f5b0: 2026 2028 2775 6e61 7373 6967 6e65 6427   & ('unassigned'
-0000f5c0: 2069 6e20 6c69 7374 2863 745f 636e 745f   in list(ct_cnt_
-0000f5d0: 6469 6374 2e6b 6579 7328 2929 293a 0a0a  dict.keys())):..
-0000f5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f5f0: 2320 7072 696e 7428 6374 5f63 6e74 5f64  # print(ct_cnt_d
-0000f600: 6963 7429 0a20 2020 2020 2020 2020 2020  ict).           
-0000f610: 2020 2020 206b 6579 7320 3d20 6c69 7374       keys = list
-0000f620: 2863 745f 636e 745f 6469 6374 2e6b 6579  (ct_cnt_dict.key
-0000f630: 7328 2929 0a20 2020 2020 2020 2020 2020  s()).           
-0000f640: 2020 2020 2063 6e74 5f74 6f74 616c 203d       cnt_total =
-0000f650: 206e 702e 7375 6d28 6c69 7374 2863 745f   np.sum(list(ct_
-0000f660: 636e 745f 6469 6374 2e76 616c 7565 7328  cnt_dict.values(
-0000f670: 2929 290a 2020 2020 2020 2020 2020 2020  ))).            
-0000f680: 2020 2020 6d61 6a5f 6374 203d 204e 6f6e      maj_ct = Non
-0000f690: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0000f6a0: 2020 6966 206b 6579 735b 305d 203d 3d20    if keys[0] == 
-0000f6b0: 2775 6e61 7373 6967 6e65 6427 3a0a 2020  'unassigned':.  
-0000f6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f6d0: 2020 6966 2063 745f 636e 745f 6469 6374    if ct_cnt_dict
-0000f6e0: 5b6b 6579 735b 315d 5d20 3e3d 2028 636e  [keys[1]] >= (cn
-0000f6f0: 745f 746f 7461 6c20 2d20 6374 5f63 6e74  t_total - ct_cnt
-0000f700: 5f64 6963 745b 2775 6e61 7373 6967 6e65  _dict['unassigne
-0000f710: 6427 5d29 2a70 6d61 6a3a 0a20 2020 2020  d'])*pmaj:.     
-0000f720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f730: 2020 206d 616a 5f63 7420 3d20 6b65 7973     maj_ct = keys
-0000f740: 5b31 5d0a 2020 2020 2020 2020 2020 2020  [1].            
-0000f750: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000f760: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000f770: 2063 745f 636e 745f 6469 6374 5b6b 6579   ct_cnt_dict[key
-0000f780: 735b 305d 5d20 3e3d 2028 636e 745f 746f  s[0]] >= (cnt_to
-0000f790: 7461 6c29 2a70 6d61 6a3a 200a 2020 2020  tal)*pmaj: .    
-0000f7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f7b0: 2020 2020 6d61 6a5f 6374 203d 206b 6579      maj_ct = key
-0000f7c0: 735b 305d 0a0a 2020 2020 2020 2020 2020  s[0]..          
-0000f7d0: 2020 2020 2020 6966 206d 616a 5f63 7420        if maj_ct 
-0000f7e0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0000f7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f800: 2066 6f72 2063 6d20 696e 2063 6f6d 6d75   for cm in commu
-0000f810: 6e69 7479 3a0a 2020 2020 2020 2020 2020  nity:.          
-0000f820: 2020 2020 2020 2020 2020 2020 2020 6220                b 
-0000f830: 3d20 6e70 2e61 7272 6179 2879 5f63 6c75  = np.array(y_clu
-0000f840: 7374 2920 3d3d 2063 6d0a 2020 2020 2020  st) == cm.      
-0000f850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f860: 2020 7973 5b62 5d20 3d20 6d61 6a5f 6374    ys[b] = maj_ct
-0000f870: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000f880: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-0000f890: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000f8a0: 2020 2020 2020 2020 2020 7320 3d20 2743            s = 'C
-0000f8b0: 6f6d 6d75 6e69 7479 2025 693a 2027 2025  ommunity %i: ' %
-0000f8c0: 206b 0a20 2020 2020 2020 2020 2020 2020   k.             
-0000f8d0: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
-0000f8e0: 6d20 696e 2063 6f6d 6d75 6e69 7479 3a0a  m in community:.
-0000f8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f900: 2020 2020 2020 2020 2020 2020 7320 3d20              s = 
-0000f910: 7320 2b20 2725 7328 2569 292c 2027 2025  s + '%s(%i), ' %
-0000f920: 2028 636c 7573 745f 6d61 6a5f 6469 6374   (clust_maj_dict
-0000f930: 5b63 6d5d 2c20 696e 7428 636c 7573 745f  [cm], int(clust_
-0000f940: 636e 745f 6469 6374 5b63 6d5d 2929 0a20  cnt_dict[cm])). 
-0000f950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f960: 2020 2020 2020 2069 6620 6c65 6e28 7329         if len(s)
-0000f970: 203e 2033 3a20 7320 3d20 735b 3a2d 315d   > 3: s = s[:-1]
-0000f980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f990: 2020 2020 2020 2020 2073 203d 2073 202b           s = s +
-0000f9a0: 2027 202d 3e20 2573 2027 2025 206d 616a   ' -> %s ' % maj
-0000f9b0: 5f63 740a 2020 2020 2020 2020 2020 2020  _ct.            
-0000f9c0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0000f9d0: 7428 735b 3a2d 325d 2c20 666c 7573 6820  t(s[:-2], flush 
-0000f9e0: 3d20 5472 7565 290a 2020 2020 2020 2020  = True).        
-0000f9f0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0000fa00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000fa10: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0000fa20: 2725 7327 2025 206d 616a 5f63 745b 305d  '%s' % maj_ct[0]
-0000fa30: 2c20 656e 6420 3d20 2727 2c20 666c 7573  , end = '', flus
-0000fa40: 6820 3d20 5472 7565 2920 2020 2020 2020  h = True)       
-0000fa50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fa60: 200a 2020 2020 7265 7475 726e 2079 730a   .    return ys.
-0000fa70: 0a0a 6465 6620 6669 6e64 5f70 6374 5f63  ..def find_pct_c
-0000fa80: 7574 6f66 6628 7363 6f72 652c 2079 5f63  utoff(score, y_c
-0000fa90: 6c75 7374 2c20 7074 6820 3d20 312e 332c  lust, pth = 1.3,
-0000faa0: 2070 6374 5f66 6974 5f70 6e74 203d 2030   pct_fit_pnt = 0
-0000fab0: 2e33 2c20 0a20 2020 2020 2020 2020 2020  .3, .           
-0000fac0: 2020 2020 2020 2020 2020 7063 745f 6d69            pct_mi
-0000fad0: 6e5f 7266 203d 2031 2c20 7072 696e 745f  n_rf = 1, print_
-0000fae0: 7265 706f 7274 203d 2046 616c 7365 2c20  report = False, 
-0000faf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fb00: 2020 2020 2020 6669 6773 697a 6520 3d20        figsize = 
-0000fb10: 2835 2c34 292c 2074 6974 6c65 203d 2027  (5,4), title = '
-0000fb20: 436c 7573 7465 7220 6669 6c74 6572 2073  Cluster filter s
-0000fb30: 7461 7473 2e27 293a 0a20 2020 200a 2020  tats.'):.    .  
-0000fb40: 2020 636c 7573 745f 6c73 7420 3d20 6c69    clust_lst = li
-0000fb50: 7374 2873 6574 2879 5f63 6c75 7374 2929  st(set(y_clust))
-0000fb60: 0a20 2020 2023 2063 6c75 7374 5f6c 7374  .    # clust_lst
-0000fb70: 2e73 6f72 7428 290a 0a20 2020 206e 6e20  .sort()..    nn 
-0000fb80: 3d20 5b5d 0a20 2020 2066 6f72 2063 2069  = [].    for c i
-0000fb90: 6e20 636c 7573 745f 6c73 743a 0a20 2020  n clust_lst:.   
-0000fba0: 2020 2020 2062 203d 2079 5f63 6c75 7374       b = y_clust
-0000fbb0: 203d 3d20 630a 2020 2020 2020 2020 6e6e   == c.        nn
-0000fbc0: 2e61 7070 656e 6428 2873 636f 7265 5b62  .append((score[b
-0000fbd0: 5d20 3e3d 2070 7468 292e 7375 6d28 292f  ] >= pth).sum()/
-0000fbe0: 6e70 2e73 756d 2862 2929 0a20 2020 206e  np.sum(b)).    n
-0000fbf0: 6e2e 736f 7274 2829 0a0a 2020 2020 7920  n.sort()..    y 
-0000fc00: 3d20 6e70 2e61 7272 6179 286e 6e29 0a20  = np.array(nn). 
-0000fc10: 2020 2078 203d 206e 702e 6172 616e 6765     x = np.arange
-0000fc20: 286c 656e 286e 6e29 290a 2020 2020 0a20  (len(nn)).    . 
-0000fc30: 2020 204c 203d 2069 6e74 286c 656e 2879     L = int(len(y
-0000fc40: 292a 7063 745f 6669 745f 706e 7429 2023  )*pct_fit_pnt) #
-0000fc50: 6e70 2e73 756d 2879 203c 2050 4354 5f54  np.sum(y < PCT_T
-0000fc60: 4852 4553 484f 4c44 5f4d 4158 290a 2020  HRESHOLD_MAX).  
-0000fc70: 2020 6966 206c 656e 2879 2920 2d20 4c20    if len(y) - L 
-0000fc80: 3c20 3130 3a20 4c20 3d20 6d61 7828 6c65  < 10: L = max(le
-0000fc90: 6e28 7929 202d 2031 302c 2032 290a 2020  n(y) - 10, 2).  
-0000fca0: 2020 2020 2020 0a20 2020 2069 6620 4c20        .    if L 
-0000fcb0: 3e3d 2030 3a0a 2020 2020 2020 2020 7a20  >= 0:.        z 
-0000fcc0: 3d20 6e70 2e70 6f6c 7966 6974 2878 5b4c  = np.polyfit(x[L
-0000fcd0: 3a5d 2c79 5b4c 3a5d 2c20 312c 2077 203d  :],y[L:], 1, w =
-0000fce0: 2079 5b4c 3a5d 290a 2020 2020 2020 2020   y[L:]).        
-0000fcf0: 7020 3d20 6e70 2e70 6f6c 7931 6428 7a29  p = np.poly1d(z)
-0000fd00: 0a20 2020 2020 2020 2073 203d 2070 2878  .        s = p(x
-0000fd10: 290a 0a20 2020 2020 2020 2023 2066 6f72  )..        # for
-0000fd20: 2069 2069 6e20 7265 7665 7273 6564 2872   i in reversed(r
-0000fd30: 616e 6765 286c 656e 286e 6e29 2929 3a0a  ange(len(nn))):.
-0000fd40: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
-0000fd50: 2072 616e 6765 286c 656e 286e 6e29 293a   range(len(nn)):
-0000fd60: 0a20 2020 2020 2020 2020 2020 2023 2069  .            # i
-0000fd70: 6620 6e70 2e61 6273 2873 5b69 5d20 2d20  f np.abs(s[i] - 
-0000fd80: 795b 695d 2920 3e20 6d61 7267 696e 3a0a  y[i]) > margin:.
-0000fd90: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0000fda0: 735b 695d 202d 2079 5b69 5d29 203c 3d20  s[i] - y[i]) <= 
-0000fdb0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-0000fdc0: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
-0000fdd0: 2020 6966 2069 203d 3d20 303a 0a20 2020    if i == 0:.   
-0000fde0: 2020 2020 2020 2020 2061 6273 5f64 6966           abs_dif
-0000fdf0: 6620 3d20 6e70 2e61 6273 2879 202d 2073  f = np.abs(y - s
-0000fe00: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0000fe10: 2020 2020 2020 2020 2020 2020 6162 735f              abs_
-0000fe20: 6469 6666 203d 206e 702e 6162 7328 795b  diff = np.abs(y[
-0000fe30: 3a69 5d20 2d20 735b 3a69 5d29 0a20 2020  :i] - s[:i]).   
-0000fe40: 2020 2020 200a 2020 2020 2020 2020 6d61       .        ma
-0000fe50: 7267 696e 203d 206e 702e 6d61 7828 6162  rgin = np.max(ab
-0000fe60: 735f 6469 6666 292a 2831 2d70 6374 5f66  s_diff)*(1-pct_f
-0000fe70: 6974 5f70 6e74 290a 2020 2020 2020 2020  it_pnt).        
-0000fe80: 7063 745f 7468 7265 7368 203d 206d 6178  pct_thresh = max
-0000fe90: 2873 5b30 5d20 2d20 6d61 7267 696e 2c20  (s[0] - margin, 
-0000fea0: 7063 745f 6d69 6e5f 7266 290a 2020 2020  pct_min_rf).    
-0000feb0: 2020 2020 0a20 2020 2020 2020 2069 6620      .        if 
-0000fec0: 7072 696e 745f 7265 706f 7274 3a0a 2020  print_report:.  
-0000fed0: 2020 2020 2020 2020 2020 706c 742e 6669            plt.fi
-0000fee0: 6775 7265 2866 6967 7369 7a65 203d 2066  gure(figsize = f
-0000fef0: 6967 7369 7a65 2c20 6470 693d 3130 3029  igsize, dpi=100)
-0000ff00: 0a20 2020 2020 2020 2020 2020 2070 6c74  .            plt
-0000ff10: 2e70 6c6f 7428 782c 2079 290a 2020 2020  .plot(x, y).    
-0000ff20: 2020 2020 2020 2020 706c 742e 706c 6f74          plt.plot
-0000ff30: 2878 2c20 7329 0a20 2020 2020 2020 2020  (x, s).         
-0000ff40: 2020 2061 203d 2070 6374 5f74 6872 6573     a = pct_thres
-0000ff50: 680a 2020 2020 2020 2020 2020 2020 706c  h.            pl
-0000ff60: 742e 706c 6f74 285b 302c 6c65 6e28 6e6e  t.plot([0,len(nn
-0000ff70: 292d 315d 2c20 5b61 2c61 5d29 0a20 2020  )-1], [a,a]).   
-0000ff80: 2020 2020 2020 2020 2061 203d 2070 6374           a = pct
-0000ff90: 5f74 6872 6573 6820 2b20 6d61 7267 696e  _thresh + margin
-0000ffa0: 0a20 2020 2020 2020 2020 2020 2023 2070  .            # p
-0000ffb0: 6c74 2e70 6c6f 7428 5b30 2c6c 656e 286e  lt.plot([0,len(n
-0000ffc0: 6e29 2d31 5d2c 205b 612c 615d 2c20 272d  n)-1], [a,a], '-
-0000ffd0: 2d27 290a 2020 2020 2020 2020 2020 2020  -').            
-0000ffe0: 706c 742e 786c 6162 656c 2827 436c 7573  plt.xlabel('Clus
-0000fff0: 7465 7220 6f72 6465 7220 5b24 6b24 5d27  ter order [$k$]'
-00010000: 2c20 666f 6e74 7369 7a65 203d 2031 3229  , fontsize = 12)
-00010010: 0a20 2020 2020 2020 2020 2020 2070 6c74  .            plt
-00010020: 2e79 6c61 6265 6c28 2724 715f 6b3d 2450  .ylabel('$q_k=$P
-00010030: 5b73 636f 7265 203e 3d24 735f 7b74 687d  [score >=$s_{th}
-00010040: 2420 696e 2063 6c75 7374 6572 2024 6b24  $ in cluster $k$
-00010050: 5d27 2c20 666f 6e74 7369 7a65 203d 2031  ]', fontsize = 1
-00010060: 3229 0a20 2020 2020 2020 2020 2020 2070  2).            p
-00010070: 6c74 2e74 6974 6c65 2874 6974 6c65 2c20  lt.title(title, 
-00010080: 666f 6e74 7369 7a65 203d 2031 3429 0a20  fontsize = 14). 
-00010090: 2020 2020 2020 2020 2020 2070 6c74 2e79             plt.y
-000100a0: 6c69 6d28 5b30 2c31 2e32 5d29 0a20 2020  lim([0,1.2]).   
-000100b0: 2020 2020 2020 2020 2070 6c74 2e67 7269           plt.gri
-000100c0: 6428 290a 2020 2020 2020 2020 2020 2020  d().            
-000100d0: 706c 742e 6c65 6765 6e64 285b 2724 715f  plt.legend(['$q_
-000100e0: 6b24 272c 2027 4c69 6e65 6172 2066 6974  k$', 'Linear fit
-000100f0: 272c 2027 5265 6a65 6374 696f 6e20 7468  ', 'Rejection th
-00010100: 7265 7368 6f6c 6427 5d29 0a20 2020 2020  reshold']).     
-00010110: 2020 2020 2020 2070 6173 7320 2020 2020         pass     
-00010120: 2020 2020 2020 200a 2020 2020 656c 7365         .    else
-00010130: 3a0a 2020 2020 2020 2020 7063 745f 7468  :.        pct_th
-00010140: 7265 7368 203d 2050 4354 5f54 4852 4553  resh = PCT_THRES
-00010150: 484f 4c44 5f4d 4158 0a20 2020 2020 2020  HOLD_MAX.       
-00010160: 206d 6172 6769 6e20 3d20 300a 2020 2020   margin = 0.    
-00010170: 0a20 2020 2072 6574 7572 6e20 7063 745f  .    return pct_
-00010180: 7468 7265 7368 2c20 6d61 7267 696e 0a0a  thresh, margin..
-00010190: 0a64 6566 2072 756e 5f67 7361 5f61 6e64  .def run_gsa_and
-000101a0: 5f63 6c66 2858 5f70 6361 2c20 5873 2c20  _clf(X_pca, Xs, 
-000101b0: 636f 626a 2c20 795f 636c 7573 742c 206d  cobj, y_clust, m
-000101c0: 6b72 5f6c 7374 2c20 6d6b 725f 6c73 745f  kr_lst, mkr_lst_
-000101d0: 6e65 672c 206d 6574 686f 6420 3d20 2767  neg, method = 'g
-000101e0: 6d6d 272c 200a 2020 2020 2020 2020 2020  mm', .          
-000101f0: 2020 2020 2020 2020 2020 204e 5f63 6f6d             N_com
-00010200: 706f 6e65 6e74 7320 3d20 382c 2070 7661  ponents = 8, pva
-00010210: 6c5f 7468 203d 2030 2e30 352c 2070 6374  l_th = 0.05, pct
-00010220: 5f66 6974 5f70 6e74 203d 2030 2e33 2c20  _fit_pnt = 0.3, 
-00010230: 7063 745f 6d69 6e5f 7266 203d 2031 2c0a  pct_min_rf = 1,.
-00010240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010250: 2020 2020 2054 6172 6765 745f 4650 5220       Target_FPR 
-00010260: 3d20 302e 3035 2c20 706d 616a 203d 2030  = 0.05, pmaj = 0
-00010270: 2c20 6d69 6e6f 725f 6964 5f73 6570 203d  , minor_id_sep =
-00010280: 2054 7275 652c 206d 696e 5f6c 6f67 505f   True, min_logP_
-00010290: 6469 6666 203d 2033 2c0a 2020 2020 2020  diff = 3,.      
-000102a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000102b0: 6872 6573 686f 6c64 696e 6720 3d20 4661  hresholding = Fa
-000102c0: 6c73 652c 2070 6374 5f63 7574 6f66 6620  lse, pct_cutoff 
-000102d0: 3d20 4661 6c73 652c 2063 6263 5f63 7574  = False, cbc_cut
-000102e0: 6f66 6620 3d20 302e 3031 2c20 7072 696e  off = 0.01, prin
-000102f0: 745f 7265 706f 7274 203d 2046 616c 7365  t_report = False
-00010300: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00010310: 2020 2020 2020 2064 665f 4753 415f 7363         df_GSA_sc
-00010320: 6f72 6520 3d20 4e6f 6e65 2029 3a0a 2020  ore = None ):.  
-00010330: 2020 0a20 2020 2069 6620 6466 5f47 5341    .    if df_GSA
-00010340: 5f73 636f 7265 2069 7320 4e6f 6e65 3a0a  _score is None:.
-00010350: 2020 2020 2020 2020 6466 5f72 6573 2c20          df_res, 
-00010360: 6466 5f47 5341 5f73 636f 7265 2c20 6466  df_GSA_score, df
-00010370: 6e20 3d20 4753 415f 6365 6c6c 5f73 7562  n = GSA_cell_sub
-00010380: 7479 7069 6e67 2820 5873 2c20 6d6b 725f  typing( Xs, mkr_
-00010390: 6c73 742c 206d 6b72 5f6c 7374 5f6e 6567  lst, mkr_lst_neg
-000103a0: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-000103b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000103c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000103d0: 2020 7665 7262 6f73 6520 3d20 7072 696e    verbose = prin
-000103e0: 745f 7265 706f 7274 2029 0a20 2020 2065  t_report ).    e
-000103f0: 6c73 653a 0a20 2020 2020 2020 2064 665f  lse:.        df_
-00010400: 7265 7320 3d20 6765 745f 7374 6174 5f67  res = get_stat_g
-00010410: 7361 2820 6466 5f47 5341 5f73 636f 7265  sa( df_GSA_score
-00010420: 2029 0a0a 2020 2020 2323 2323 2323 2323   )..    ########
-00010430: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00010440: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00010450: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-00010460: 2020 2020 2323 2043 6f6d 7075 7465 2047      ## Compute G
-00010470: 5341 2074 6872 6573 686f 6c64 7320 4576  SA thresholds Ev
-00010480: 656e 2069 6620 7468 7265 7368 6f6c 6469  en if thresholdi
-00010490: 6e67 2069 7320 4661 6c73 650a 2020 2020  ng is False.    
-000104a0: 0a20 2020 206c 6f67 5f70 765f 7468 203d  .    log_pv_th =
-000104b0: 202d 6e70 2e6c 6f67 3130 2870 7661 6c5f   -np.log10(pval_
-000104c0: 7468 290a 0a20 2020 2023 2320 4669 6e64  th)..    ## Find
-000104d0: 2074 6865 2047 4c4f 4241 4c20 7468 7265   the GLOBAL thre
-000104e0: 7368 6f6c 6420 666f 7220 6561 6368 2063  shold for each c
-000104f0: 656c 6c20 7479 7065 0a20 2020 2074 685f  ell type.    th_
-00010500: 6469 6374 2c20 6d31 6d32 5f72 6174 696f  dict, m1m2_ratio
-00010510: 203d 2067 6574 5f74 6872 6573 686f 6c64   = get_threshold
-00010520: 5f66 726f 6d5f 4753 415f 7265 7375 6c74  _from_GSA_result
-00010530: 2864 665f 7265 732c 200a 2020 2020 2020  (df_res, .      
-00010540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010560: 2020 2020 2020 7076 616c 5f74 6820 3d20        pval_th = 
-00010570: 7076 616c 5f74 682c 200a 2020 2020 2020  pval_th, .      
-00010580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105a0: 2020 2020 2020 7461 7267 6574 5f46 5052        target_FPR
-000105b0: 203d 2054 6172 6765 745f 4650 522c 200a   = Target_FPR, .
-000105c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105e0: 2020 2020 2020 2020 2020 2020 7665 7262              verb
-000105f0: 6f73 6520 3d20 7072 696e 745f 7265 706f  ose = print_repo
-00010600: 7274 290a 2020 2020 2020 2020 2020 2020  rt).            
-00010610: 0a20 2020 2069 6620 2870 6374 5f63 7574  .    if (pct_cut
-00010620: 6f66 6629 2026 2028 6c65 6e28 6c69 7374  off) & (len(list
-00010630: 2873 6574 2879 5f63 6c75 7374 2929 2920  (set(y_clust))) 
-00010640: 3e3d 2036 293a 0a20 2020 2020 2020 2073  >= 6):.        s
-00010650: 636f 7265 203d 2064 665f 7265 735b 272d  core = df_res['-
-00010660: 6c6f 6750 275d 2e63 6f70 7928 6465 6570  logP'].copy(deep
-00010670: 3d54 7275 6529 0a20 2020 2020 2020 2070  =True).        p
-00010680: 6374 5f74 6872 6573 682c 206d 6172 6769  ct_thresh, margi
-00010690: 6e20 3d20 6669 6e64 5f70 6374 5f63 7574  n = find_pct_cut
-000106a0: 6f66 6628 7363 6f72 652c 2079 5f63 6c75  off(score, y_clu
-000106b0: 7374 2c20 6c6f 675f 7076 5f74 682c 0a20  st, log_pv_th,. 
-000106c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f4e0: 2020 6374 5f63 6e74 5f64 6963 745b 636c    ct_cnt_dict[cl
+0000f4f0: 7573 745f 6d61 6a5f 6469 6374 5b63 6d5d  ust_maj_dict[cm]
+0000f500: 5d20 3d20 636c 7573 745f 636e 745f 6469  ] = clust_cnt_di
+0000f510: 6374 5b63 6d5d 0a20 2020 2020 2020 2020  ct[cm].         
+0000f520: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+0000f530: 2020 2020 2020 2020 6f64 7220 3d20 282d          odr = (-
+0000f540: 6e70 2e61 7272 6179 286c 6973 7428 6374  np.array(list(ct
+0000f550: 5f63 6e74 5f64 6963 742e 7661 6c75 6573  _cnt_dict.values
+0000f560: 2829 2929 292e 6172 6773 6f72 7428 290a  ()))).argsort().
+0000f570: 2020 2020 2020 2020 2020 2020 6374 5f63              ct_c
+0000f580: 6e74 5f64 6963 745f 6e65 7720 3d20 7b7d  nt_dict_new = {}
+0000f590: 0a20 2020 2020 2020 2020 2020 206b 6579  .            key
+0000f5a0: 7320 3d20 6c69 7374 2863 745f 636e 745f  s = list(ct_cnt_
+0000f5b0: 6469 6374 2e6b 6579 7328 2929 0a20 2020  dict.keys()).   
+0000f5c0: 2020 2020 2020 2020 2066 6f72 206f 2069           for o i
+0000f5d0: 6e20 6f64 723a 0a20 2020 2020 2020 2020  n odr:.         
+0000f5e0: 2020 2020 2020 206b 6579 203d 206b 6579         key = key
+0000f5f0: 735b 6f5d 0a20 2020 2020 2020 2020 2020  s[o].           
+0000f600: 2020 2020 2076 616c 203d 2063 745f 636e       val = ct_cn
+0000f610: 745f 6469 6374 5b6b 6579 5d0a 2020 2020  t_dict[key].    
+0000f620: 2020 2020 2020 2020 2020 2020 6374 5f63              ct_c
+0000f630: 6e74 5f64 6963 745f 6e65 775b 6b65 795d  nt_dict_new[key]
+0000f640: 203d 2076 616c 0a20 2020 2020 2020 2020   = val.         
+0000f650: 2020 2063 745f 636e 745f 6469 6374 203d     ct_cnt_dict =
+0000f660: 2063 745f 636e 745f 6469 6374 5f6e 6577   ct_cnt_dict_new
+0000f670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f680: 200a 2020 2020 2020 2020 2020 2020 6966   .            if
+0000f690: 2028 6c65 6e28 6c69 7374 2863 745f 636e   (len(list(ct_cn
+0000f6a0: 745f 6469 6374 2e6b 6579 7328 2929 2920  t_dict.keys())) 
+0000f6b0: 3e20 3129 3a20 2320 2620 2827 756e 6173  > 1): # & ('unas
+0000f6c0: 7369 676e 6564 2720 696e 206c 6973 7428  signed' in list(
+0000f6d0: 6374 5f63 6e74 5f64 6963 742e 6b65 7973  ct_cnt_dict.keys
+0000f6e0: 2829 2929 3a0a 0a20 2020 2020 2020 2020  ())):..         
+0000f6f0: 2020 2020 2020 2023 2070 7269 6e74 2863         # print(c
+0000f700: 745f 636e 745f 6469 6374 290a 2020 2020  t_cnt_dict).    
+0000f710: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
+0000f720: 203d 206c 6973 7428 6374 5f63 6e74 5f64   = list(ct_cnt_d
+0000f730: 6963 742e 6b65 7973 2829 290a 2020 2020  ict.keys()).    
+0000f740: 2020 2020 2020 2020 2020 2020 636e 745f              cnt_
+0000f750: 746f 7461 6c20 3d20 6e70 2e73 756d 286c  total = np.sum(l
+0000f760: 6973 7428 6374 5f63 6e74 5f64 6963 742e  ist(ct_cnt_dict.
+0000f770: 7661 6c75 6573 2829 2929 0a20 2020 2020  values())).     
+0000f780: 2020 2020 2020 2020 2020 206d 616a 5f63             maj_c
+0000f790: 7420 3d20 4e6f 6e65 0a20 2020 2020 2020  t = None.       
+0000f7a0: 2020 2020 2020 2020 2069 6620 6b65 7973           if keys
+0000f7b0: 5b30 5d20 3d3d 2027 756e 6173 7369 676e  [0] == 'unassign
+0000f7c0: 6564 273a 0a20 2020 2020 2020 2020 2020  ed':.           
+0000f7d0: 2020 2020 2020 2020 2069 6620 6374 5f63           if ct_c
+0000f7e0: 6e74 5f64 6963 745b 6b65 7973 5b31 5d5d  nt_dict[keys[1]]
+0000f7f0: 203e 3d20 2863 6e74 5f74 6f74 616c 202d   >= (cnt_total -
+0000f800: 2063 745f 636e 745f 6469 6374 5b27 756e   ct_cnt_dict['un
+0000f810: 6173 7369 676e 6564 275d 292a 706d 616a  assigned'])*pmaj
+0000f820: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000f830: 2020 2020 2020 2020 2020 6d61 6a5f 6374            maj_ct
+0000f840: 203d 206b 6579 735b 315d 0a20 2020 2020   = keys[1].     
+0000f850: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000f860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f870: 2020 2020 2069 6620 6374 5f63 6e74 5f64       if ct_cnt_d
+0000f880: 6963 745b 6b65 7973 5b30 5d5d 203e 3d20  ict[keys[0]] >= 
+0000f890: 2863 6e74 5f74 6f74 616c 292a 706d 616a  (cnt_total)*pmaj
+0000f8a0: 3a20 0a20 2020 2020 2020 2020 2020 2020  : .             
+0000f8b0: 2020 2020 2020 2020 2020 206d 616a 5f63             maj_c
+0000f8c0: 7420 3d20 6b65 7973 5b30 5d0a 0a20 2020  t = keys[0]..   
+0000f8d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000f8e0: 6d61 6a5f 6374 2069 7320 6e6f 7420 4e6f  maj_ct is not No
+0000f8f0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0000f900: 2020 2020 2020 2020 666f 7220 636d 2069          for cm i
+0000f910: 6e20 636f 6d6d 756e 6974 793a 0a20 2020  n community:.   
+0000f920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f930: 2020 2020 2062 203d 206e 702e 6172 7261       b = np.arra
+0000f940: 7928 795f 636c 7573 7429 203d 3d20 636d  y(y_clust) == cm
+0000f950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f960: 2020 2020 2020 2020 2079 735b 625d 203d           ys[b] =
+0000f970: 206d 616a 5f63 740a 0a20 2020 2020 2020   maj_ct..       
+0000f980: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000f990: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+0000f9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f9b0: 2073 203d 2027 436f 6d6d 756e 6974 7920   s = 'Community 
+0000f9c0: 2569 3a20 2720 2520 6b0a 2020 2020 2020  %i: ' % k.      
+0000f9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f9e0: 2020 666f 7220 636d 2069 6e20 636f 6d6d    for cm in comm
+0000f9f0: 756e 6974 793a 0a20 2020 2020 2020 2020  unity:.         
+0000fa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fa10: 2020 2073 203d 2073 202b 2027 2573 2825     s = s + '%s(%
+0000fa20: 6929 2c20 2720 2520 2863 6c75 7374 5f6d  i), ' % (clust_m
+0000fa30: 616a 5f64 6963 745b 636d 5d2c 2069 6e74  aj_dict[cm], int
+0000fa40: 2863 6c75 7374 5f63 6e74 5f64 6963 745b  (clust_cnt_dict[
+0000fa50: 636d 5d29 290a 2020 2020 2020 2020 2020  cm])).          
+0000fa60: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000fa70: 206c 656e 2873 2920 3e20 333a 2073 203d   len(s) > 3: s =
+0000fa80: 2073 5b3a 2d31 5d0a 2020 2020 2020 2020   s[:-1].        
+0000fa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000faa0: 7320 3d20 7320 2b20 2720 2d3e 2025 7320  s = s + ' -> %s 
+0000fab0: 2720 2520 6d61 6a5f 6374 0a20 2020 2020  ' % maj_ct.     
+0000fac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fad0: 2020 2070 7269 6e74 2873 5b3a 2d32 5d2c     print(s[:-2],
+0000fae0: 2066 6c75 7368 203d 2054 7275 6529 0a20   flush = True). 
+0000faf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb00: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000fb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb20: 2070 7269 6e74 2827 2573 2720 2520 6d61   print('%s' % ma
+0000fb30: 6a5f 6374 5b30 5d2c 2065 6e64 203d 2027  j_ct[0], end = '
+0000fb40: 272c 2066 6c75 7368 203d 2054 7275 6529  ', flush = True)
+0000fb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb60: 2020 2020 2020 2020 0a20 2020 2072 6574          .    ret
+0000fb70: 7572 6e20 7973 0a0a 0a64 6566 2066 696e  urn ys...def fin
+0000fb80: 645f 7063 745f 6375 746f 6666 2873 636f  d_pct_cutoff(sco
+0000fb90: 7265 2c20 795f 636c 7573 742c 2070 7468  re, y_clust, pth
+0000fba0: 203d 2031 2e33 2c20 7063 745f 6669 745f   = 1.3, pct_fit_
+0000fbb0: 706e 7420 3d20 302e 332c 200a 2020 2020  pnt = 0.3, .    
+0000fbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fbd0: 2070 6374 5f6d 696e 5f72 6620 3d20 312c   pct_min_rf = 1,
+0000fbe0: 2070 7269 6e74 5f72 6570 6f72 7420 3d20   print_report = 
+0000fbf0: 4661 6c73 652c 200a 2020 2020 2020 2020  False, .        
+0000fc00: 2020 2020 2020 2020 2020 2020 2066 6967               fig
+0000fc10: 7369 7a65 203d 2028 352c 3429 2c20 7469  size = (5,4), ti
+0000fc20: 746c 6520 3d20 2743 6c75 7374 6572 2066  tle = 'Cluster f
+0000fc30: 696c 7465 7220 7374 6174 732e 2729 3a0a  ilter stats.'):.
+0000fc40: 2020 2020 0a20 2020 2063 6c75 7374 5f6c      .    clust_l
+0000fc50: 7374 203d 206c 6973 7428 7365 7428 795f  st = list(set(y_
+0000fc60: 636c 7573 7429 290a 2020 2020 2320 636c  clust)).    # cl
+0000fc70: 7573 745f 6c73 742e 736f 7274 2829 0a0a  ust_lst.sort()..
+0000fc80: 2020 2020 6e6e 203d 205b 5d0a 2020 2020      nn = [].    
+0000fc90: 666f 7220 6320 696e 2063 6c75 7374 5f6c  for c in clust_l
+0000fca0: 7374 3a0a 2020 2020 2020 2020 6220 3d20  st:.        b = 
+0000fcb0: 795f 636c 7573 7420 3d3d 2063 0a20 2020  y_clust == c.   
+0000fcc0: 2020 2020 206e 6e2e 6170 7065 6e64 2828       nn.append((
+0000fcd0: 7363 6f72 655b 625d 203e 3d20 7074 6829  score[b] >= pth)
+0000fce0: 2e73 756d 2829 2f6e 702e 7375 6d28 6229  .sum()/np.sum(b)
+0000fcf0: 290a 2020 2020 6e6e 2e73 6f72 7428 290a  ).    nn.sort().
+0000fd00: 0a20 2020 2079 203d 206e 702e 6172 7261  .    y = np.arra
+0000fd10: 7928 6e6e 290a 2020 2020 7820 3d20 6e70  y(nn).    x = np
+0000fd20: 2e61 7261 6e67 6528 6c65 6e28 6e6e 2929  .arange(len(nn))
+0000fd30: 0a20 2020 200a 2020 2020 4c20 3d20 696e  .    .    L = in
+0000fd40: 7428 6c65 6e28 7929 2a70 6374 5f66 6974  t(len(y)*pct_fit
+0000fd50: 5f70 6e74 2920 236e 702e 7375 6d28 7920  _pnt) #np.sum(y 
+0000fd60: 3c20 5043 545f 5448 5245 5348 4f4c 445f  < PCT_THRESHOLD_
+0000fd70: 4d41 5829 0a20 2020 2069 6620 6c65 6e28  MAX).    if len(
+0000fd80: 7929 202d 204c 203c 2031 303a 204c 203d  y) - L < 10: L =
+0000fd90: 206d 6178 286c 656e 2879 2920 2d20 3130   max(len(y) - 10
+0000fda0: 2c20 3229 0a20 2020 2020 2020 200a 2020  , 2).        .  
+0000fdb0: 2020 6966 204c 203e 3d20 303a 0a20 2020    if L >= 0:.   
+0000fdc0: 2020 2020 207a 203d 206e 702e 706f 6c79       z = np.poly
+0000fdd0: 6669 7428 785b 4c3a 5d2c 795b 4c3a 5d2c  fit(x[L:],y[L:],
+0000fde0: 2031 2c20 7720 3d20 795b 4c3a 5d29 0a20   1, w = y[L:]). 
+0000fdf0: 2020 2020 2020 2070 203d 206e 702e 706f         p = np.po
+0000fe00: 6c79 3164 287a 290a 2020 2020 2020 2020  ly1d(z).        
+0000fe10: 7320 3d20 7028 7829 0a0a 2020 2020 2020  s = p(x)..      
+0000fe20: 2020 2320 666f 7220 6920 696e 2072 6576    # for i in rev
+0000fe30: 6572 7365 6428 7261 6e67 6528 6c65 6e28  ersed(range(len(
+0000fe40: 6e6e 2929 293a 0a20 2020 2020 2020 2066  nn))):.        f
+0000fe50: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
+0000fe60: 6e28 6e6e 2929 3a0a 2020 2020 2020 2020  n(nn)):.        
+0000fe70: 2020 2020 2320 6966 206e 702e 6162 7328      # if np.abs(
+0000fe80: 735b 695d 202d 2079 5b69 5d29 203e 206d  s[i] - y[i]) > m
+0000fe90: 6172 6769 6e3a 0a20 2020 2020 2020 2020  argin:.         
+0000fea0: 2020 2069 6620 2873 5b69 5d20 2d20 795b     if (s[i] - y[
+0000feb0: 695d 2920 3c3d 2030 3a0a 2020 2020 2020  i]) <= 0:.      
+0000fec0: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+0000fed0: 0a20 2020 2020 2020 2069 6620 6920 3d3d  .        if i ==
+0000fee0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+0000fef0: 6162 735f 6469 6666 203d 206e 702e 6162  abs_diff = np.ab
+0000ff00: 7328 7920 2d20 7329 0a20 2020 2020 2020  s(y - s).       
+0000ff10: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000ff20: 2020 2061 6273 5f64 6966 6620 3d20 6e70     abs_diff = np
+0000ff30: 2e61 6273 2879 5b3a 695d 202d 2073 5b3a  .abs(y[:i] - s[:
+0000ff40: 695d 290a 2020 2020 2020 2020 0a20 2020  i]).        .   
+0000ff50: 2020 2020 206d 6172 6769 6e20 3d20 6e70       margin = np
+0000ff60: 2e6d 6178 2861 6273 5f64 6966 6629 2a28  .max(abs_diff)*(
+0000ff70: 312d 7063 745f 6669 745f 706e 7429 0a20  1-pct_fit_pnt). 
+0000ff80: 2020 2020 2020 2070 6374 5f74 6872 6573         pct_thres
+0000ff90: 6820 3d20 6d61 7828 735b 305d 202d 206d  h = max(s[0] - m
+0000ffa0: 6172 6769 6e2c 2070 6374 5f6d 696e 5f72  argin, pct_min_r
+0000ffb0: 6629 0a20 2020 2020 2020 200a 2020 2020  f).        .    
+0000ffc0: 2020 2020 6966 2070 7269 6e74 5f72 6570      if print_rep
+0000ffd0: 6f72 743a 0a20 2020 2020 2020 2020 2020  ort:.           
+0000ffe0: 2070 6c74 2e66 6967 7572 6528 6669 6773   plt.figure(figs
+0000fff0: 697a 6520 3d20 6669 6773 697a 652c 2064  ize = figsize, d
+00010000: 7069 3d31 3030 290a 2020 2020 2020 2020  pi=100).        
+00010010: 2020 2020 706c 742e 706c 6f74 2878 2c20      plt.plot(x, 
+00010020: 7929 0a20 2020 2020 2020 2020 2020 2070  y).            p
+00010030: 6c74 2e70 6c6f 7428 782c 2073 290a 2020  lt.plot(x, s).  
+00010040: 2020 2020 2020 2020 2020 6120 3d20 7063            a = pc
+00010050: 745f 7468 7265 7368 0a20 2020 2020 2020  t_thresh.       
+00010060: 2020 2020 2070 6c74 2e70 6c6f 7428 5b30       plt.plot([0
+00010070: 2c6c 656e 286e 6e29 2d31 5d2c 205b 612c  ,len(nn)-1], [a,
+00010080: 615d 290a 2020 2020 2020 2020 2020 2020  a]).            
+00010090: 6120 3d20 7063 745f 7468 7265 7368 202b  a = pct_thresh +
+000100a0: 206d 6172 6769 6e0a 2020 2020 2020 2020   margin.        
+000100b0: 2020 2020 2320 706c 742e 706c 6f74 285b      # plt.plot([
+000100c0: 302c 6c65 6e28 6e6e 292d 315d 2c20 5b61  0,len(nn)-1], [a
+000100d0: 2c61 5d2c 2027 2d2d 2729 0a20 2020 2020  ,a], '--').     
+000100e0: 2020 2020 2020 2070 6c74 2e78 6c61 6265         plt.xlabe
+000100f0: 6c28 2743 6c75 7374 6572 206f 7264 6572  l('Cluster order
+00010100: 205b 246b 245d 272c 2066 6f6e 7473 697a   [$k$]', fontsiz
+00010110: 6520 3d20 3132 290a 2020 2020 2020 2020  e = 12).        
+00010120: 2020 2020 706c 742e 796c 6162 656c 2827      plt.ylabel('
+00010130: 2471 5f6b 3d24 505b 7363 6f72 6520 3e3d  $q_k=$P[score >=
+00010140: 2473 5f7b 7468 7d24 2069 6e20 636c 7573  $s_{th}$ in clus
+00010150: 7465 7220 246b 245d 272c 2066 6f6e 7473  ter $k$]', fonts
+00010160: 697a 6520 3d20 3132 290a 2020 2020 2020  ize = 12).      
+00010170: 2020 2020 2020 706c 742e 7469 746c 6528        plt.title(
+00010180: 7469 746c 652c 2066 6f6e 7473 697a 6520  title, fontsize 
+00010190: 3d20 3134 290a 2020 2020 2020 2020 2020  = 14).          
+000101a0: 2020 706c 742e 796c 696d 285b 302c 312e    plt.ylim([0,1.
+000101b0: 325d 290a 2020 2020 2020 2020 2020 2020  2]).            
+000101c0: 706c 742e 6772 6964 2829 0a20 2020 2020  plt.grid().     
+000101d0: 2020 2020 2020 2070 6c74 2e6c 6567 656e         plt.legen
+000101e0: 6428 5b27 2471 5f6b 2427 2c20 274c 696e  d(['$q_k$', 'Lin
+000101f0: 6561 7220 6669 7427 2c20 2752 656a 6563  ear fit', 'Rejec
+00010200: 7469 6f6e 2074 6872 6573 686f 6c64 275d  tion threshold']
+00010210: 290a 2020 2020 2020 2020 2020 2020 7061  ).            pa
+00010220: 7373 2020 2020 2020 2020 2020 2020 0a20  ss            . 
+00010230: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00010240: 2070 6374 5f74 6872 6573 6820 3d20 5043   pct_thresh = PC
+00010250: 545f 5448 5245 5348 4f4c 445f 4d41 580a  T_THRESHOLD_MAX.
+00010260: 2020 2020 2020 2020 6d61 7267 696e 203d          margin =
+00010270: 2030 0a20 2020 200a 2020 2020 7265 7475   0.    .    retu
+00010280: 726e 2070 6374 5f74 6872 6573 682c 206d  rn pct_thresh, m
+00010290: 6172 6769 6e0a 0a0a 6465 6620 7275 6e5f  argin...def run_
+000102a0: 6773 615f 616e 645f 636c 6628 585f 7063  gsa_and_clf(X_pc
+000102b0: 612c 2058 732c 2063 6f62 6a2c 2079 5f63  a, Xs, cobj, y_c
+000102c0: 6c75 7374 2c20 6d6b 725f 6c73 742c 206d  lust, mkr_lst, m
+000102d0: 6b72 5f6c 7374 5f6e 6567 2c20 6d65 7468  kr_lst_neg, meth
+000102e0: 6f64 203d 2027 676d 6d27 2c20 0a20 2020  od = 'gmm', .   
+000102f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010300: 2020 4e5f 636f 6d70 6f6e 656e 7473 203d    N_components =
+00010310: 2038 2c20 7076 616c 5f74 6820 3d20 302e   8, pval_th = 0.
+00010320: 3035 2c20 7063 745f 6669 745f 706e 7420  05, pct_fit_pnt 
+00010330: 3d20 302e 332c 2070 6374 5f6d 696e 5f72  = 0.3, pct_min_r
+00010340: 6620 3d20 312c 0a20 2020 2020 2020 2020  f = 1,.         
+00010350: 2020 2020 2020 2020 2020 2020 5461 7267              Targ
+00010360: 6574 5f46 5052 203d 2030 2e30 352c 2070  et_FPR = 0.05, p
+00010370: 6d61 6a20 3d20 302c 206d 696e 6f72 5f69  maj = 0, minor_i
+00010380: 645f 7365 7020 3d20 5472 7565 2c20 6d69  d_sep = True, mi
+00010390: 6e5f 6c6f 6750 5f64 6966 6620 3d20 332c  n_logP_diff = 3,
+000103a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000103b0: 2020 2020 2020 7468 7265 7368 6f6c 6469        thresholdi
+000103c0: 6e67 203d 2046 616c 7365 2c20 7063 745f  ng = False, pct_
+000103d0: 6375 746f 6666 203d 2046 616c 7365 2c20  cutoff = False, 
+000103e0: 6362 635f 6375 746f 6666 203d 2030 2e30  cbc_cutoff = 0.0
+000103f0: 312c 2070 7269 6e74 5f72 6570 6f72 7420  1, print_report 
+00010400: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
+00010410: 2020 2020 2020 2020 2020 2020 2020 6466                df
+00010420: 5f47 5341 5f73 636f 7265 203d 204e 6f6e  _GSA_score = Non
+00010430: 6520 293a 0a20 2020 200a 2020 2020 6966  e ):.    .    if
+00010440: 2064 665f 4753 415f 7363 6f72 6520 6973   df_GSA_score is
+00010450: 204e 6f6e 653a 0a20 2020 2020 2020 2064   None:.        d
+00010460: 665f 7265 732c 2064 665f 4753 415f 7363  f_res, df_GSA_sc
+00010470: 6f72 652c 2064 666e 203d 2047 5341 5f63  ore, dfn = GSA_c
+00010480: 656c 6c5f 7375 6274 7970 696e 6728 2058  ell_subtyping( X
+00010490: 732c 206d 6b72 5f6c 7374 2c20 6d6b 725f  s, mkr_lst, mkr_
+000104a0: 6c73 745f 6e65 672c 200a 2020 2020 2020  lst_neg, .      
+000104b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104d0: 2020 2020 2020 2020 2076 6572 626f 7365           verbose
+000104e0: 203d 2070 7269 6e74 5f72 6570 6f72 7420   = print_report 
+000104f0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+00010500: 2020 2020 6466 5f72 6573 203d 2067 6574      df_res = get
+00010510: 5f73 7461 745f 6773 6128 2064 665f 4753  _stat_gsa( df_GS
+00010520: 415f 7363 6f72 6520 290a 0a20 2020 2023  A_score )..    #
+00010530: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00010540: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00010550: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00010560: 2323 2323 2323 0a20 2020 2023 2320 436f  ######.    ## Co
+00010570: 6d70 7574 6520 4753 4120 7468 7265 7368  mpute GSA thresh
+00010580: 6f6c 6473 2045 7665 6e20 6966 2074 6872  olds Even if thr
+00010590: 6573 686f 6c64 696e 6720 6973 2046 616c  esholding is Fal
+000105a0: 7365 0a20 2020 200a 2020 2020 6c6f 675f  se.    .    log_
+000105b0: 7076 5f74 6820 3d20 2d6e 702e 6c6f 6731  pv_th = -np.log1
+000105c0: 3028 7076 616c 5f74 6829 0a0a 2020 2020  0(pval_th)..    
+000105d0: 2323 2046 696e 6420 7468 6520 474c 4f42  ## Find the GLOB
+000105e0: 414c 2074 6872 6573 686f 6c64 2066 6f72  AL threshold for
+000105f0: 2065 6163 6820 6365 6c6c 2074 7970 650a   each cell type.
+00010600: 2020 2020 7468 5f64 6963 742c 206d 316d      th_dict, m1m
+00010610: 325f 7261 7469 6f20 3d20 6765 745f 7468  2_ratio = get_th
+00010620: 7265 7368 6f6c 645f 6672 6f6d 5f47 5341  reshold_from_GSA
+00010630: 5f72 6573 756c 7428 6466 5f72 6573 2c20  _result(df_res, 
+00010640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010660: 2020 2020 2020 2020 2020 2020 2070 7661               pva
+00010670: 6c5f 7468 203d 2070 7661 6c5f 7468 2c20  l_th = pval_th, 
+00010680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000106a0: 2020 2020 2020 2020 2020 2020 2074 6172               tar
+000106b0: 6765 745f 4650 5220 3d20 5461 7267 6574  get_FPR = Target
+000106c0: 5f46 5052 2c20 0a20 2020 2020 2020 2020  _FPR, .         
 000106d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000106e0: 2020 2020 2020 2020 2020 2020 7063 745f              pct_
-000106f0: 6669 745f 706e 7420 3d20 7063 745f 6669  fit_pnt = pct_fi
-00010700: 745f 706e 742c 200a 2020 2020 2020 2020  t_pnt, .        
-00010710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010730: 2020 2020 2070 6374 5f6d 696e 5f72 6620       pct_min_rf 
-00010740: 3d20 7063 745f 6d69 6e5f 7266 2c20 7072  = pct_min_rf, pr
-00010750: 696e 745f 7265 706f 7274 203d 2046 616c  int_report = Fal
-00010760: 7365 290a 2020 2020 2020 2020 2320 7063  se).        # pc
-00010770: 745f 7468 7265 7368 203d 206d 696e 286d  t_thresh = min(m
-00010780: 6178 2870 6374 5f74 6872 6573 682c 2031  ax(pct_thresh, 1
-00010790: 2d70 6d61 6a29 2c20 5043 545f 5448 5245  -pmaj), PCT_THRE
-000107a0: 5348 4f4c 445f 4d41 5829 0a20 2020 2065  SHOLD_MAX).    e
-000107b0: 6c73 653a 0a20 2020 2020 2020 2070 6374  lse:.        pct
-000107c0: 5f74 6872 6573 6820 3d20 302e 3235 0a0a  _thresh = 0.25..
-000107d0: 2020 2020 2320 7072 696e 7428 2742 6566      # print('Bef
-000107e0: 6f72 6520 7468 7265 7368 6f6c 6469 6e67  ore thresholding
-000107f0: 3a20 272c 2064 665f 7265 735b 2763 656c  : ', df_res['cel
-00010800: 6c5f 7479 7065 2872 6576 2927 5d2e 7661  l_type(rev)'].va
-00010810: 6c75 655f 636f 756e 7473 2829 290a 0a20  lue_counts()).. 
-00010820: 2020 2070 6374 5f74 6872 6573 6820 3d20     pct_thresh = 
-00010830: 6d69 6e28 7063 745f 6d69 6e5f 7266 2c20  min(pct_min_rf, 
-00010840: 7063 745f 7468 7265 7368 290a 2020 2020  pct_thresh).    
-00010850: 636c 7374 5f74 6f5f 6578 636c 7564 6520  clst_to_exclude 
-00010860: 3d20 5b5d 0a20 2020 2020 2020 200a 2020  = [].        .  
-00010870: 2020 2323 2041 7070 6c79 2047 5341 2074    ## Apply GSA t
-00010880: 6872 6573 686f 6c64 7320 4966 2074 6872  hresholds If thr
-00010890: 6573 686f 6c64 696e 6720 6973 2054 7275  esholding is Tru
-000108a0: 650a 2020 2020 6966 2070 6374 5f63 7574  e.    if pct_cut
-000108b0: 6f66 663a 2023 2320 692e 652e 2066 6f72  off: ## i.e. for
-000108c0: 206d 616a 6f72 2074 7970 650a 2020 2020   major type.    
-000108d0: 2020 2020 6966 2074 6872 6573 686f 6c64      if threshold
-000108e0: 696e 673a 0a0a 2020 2020 2020 2020 2020  ing:..          
-000108f0: 2020 636c 7573 7465 725f 6c73 7420 3d20    cluster_lst = 
-00010900: 6c69 7374 2873 6574 2879 5f63 6c75 7374  list(set(y_clust
-00010910: 2929 0a20 2020 2020 2020 2020 2020 2063  )).            c
-00010920: 6c75 7374 6572 5f6c 7374 2e73 6f72 7428  luster_lst.sort(
-00010930: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-00010940: 6620 7063 745f 6375 746f 6666 2026 2070  f pct_cutoff & p
-00010950: 7269 6e74 5f72 6570 6f72 743a 200a 2020  rint_report: .  
-00010960: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00010970: 696e 7428 2750 5b50 763c 5468 5d20 6375  int('P[Pv<Th] cu
-00010980: 746f 6666 203d 2025 342e 3266 2825 342e  toff = %4.2f(%4.
-00010990: 3266 2927 2025 2028 7063 745f 7468 7265  2f)' % (pct_thre
-000109a0: 7368 2c20 6d61 7267 696e 292c 2065 6e64  sh, margin), end
-000109b0: 203d 2027 2729 0a0a 2020 2020 2020 2020   = '')..        
-000109c0: 2020 2020 636e 7420 3d20 300a 2020 2020      cnt = 0.    
-000109d0: 2020 2020 2020 2020 666f 7220 636c 7374          for clst
-000109e0: 2069 6e20 636c 7573 7465 725f 6c73 743a   in cluster_lst:
-000109f0: 0a20 2020 2020 2020 2020 2020 2023 2320  .            ## 
-00010a00: 466f 7220 6561 6368 2063 6c75 7374 6572  For each cluster
-00010a10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00010a20: 2020 2323 2073 656c 6563 7420 6365 6c6c    ## select cell
-00010a30: 7320 696e 2074 6865 2063 6c75 7374 6572  s in the cluster
-00010a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010a50: 2062 203d 2079 5f63 6c75 7374 203d 3d20   b = y_clust == 
-00010a60: 636c 7374 0a20 2020 2020 2020 2020 2020  clst.           
-00010a70: 2020 2020 2070 6374 203d 2028 6466 5f72       pct = (df_r
-00010a80: 6573 2e6c 6f63 5b62 2c20 272d 6c6f 6750  es.loc[b, '-logP
-00010a90: 275d 203e 3d20 6c6f 675f 7076 5f74 6829  '] >= log_pv_th)
-00010aa0: 2e73 756d 2829 2f6e 702e 7375 6d28 6229  .sum()/np.sum(b)
-00010ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010ac0: 2069 6620 7063 7420 3c20 7063 745f 7468   if pct < pct_th
-00010ad0: 7265 7368 3a0a 2020 2020 2020 2020 2020  resh:.          
-00010ae0: 2020 2020 2020 2020 2020 636e 7420 2b3d            cnt +=
-00010af0: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
-00010b00: 2020 2020 2020 2069 6620 7072 696e 745f         if print_
-00010b10: 7265 706f 7274 3a0a 2020 2020 2020 2020  report:.        
-00010b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b30: 636e 745f 7462 6c20 3d20 6466 5f72 6573  cnt_tbl = df_res
-00010b40: 2e6c 6f63 5b62 2c20 2763 656c 6c5f 7479  .loc[b, 'cell_ty
-00010b50: 7065 2872 6576 2927 5d2e 7661 6c75 655f  pe(rev)'].value_
-00010b60: 636f 756e 7473 2829 0a20 2020 2020 2020  counts().       
-00010b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b80: 206d 616a 6f72 6974 7920 3d20 636e 745f   majority = cnt_
-00010b90: 7462 6c2e 696e 6465 782e 7661 6c75 6573  tbl.index.values
-00010ba0: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-00010bb0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00010bc0: 7428 272c 2025 7328 2534 2e32 662c 206d  t(', %s(%4.2f, m
-00010bd0: 616a 3a25 7329 2720 2520 2873 7472 2863  aj:%s)' % (str(c
-00010be0: 6c73 7429 2c20 7063 742c 206d 616a 6f72  lst), pct, major
-00010bf0: 6974 7929 2c20 656e 6420 3d20 2727 290a  ity), end = '').
-00010c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c10: 2020 2020 2020 2020 2320 7072 696e 7428          # print(
-00010c20: 2720 2020 436c 7573 7465 7220 2532 7320  '   Cluster %2s 
-00010c30: 3a20 2534 2e32 6627 2025 2028 7374 7228  : %4.2f' % (str(
-00010c40: 636c 7374 292c 2070 6374 2929 0a0a 2020  clst), pct))..  
-00010c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c60: 2020 6466 5f72 6573 2e6c 6f63 5b62 2c20    df_res.loc[b, 
-00010c70: 2763 656c 6c5f 7479 7065 2872 6576 2927  'cell_type(rev)'
-00010c80: 5d20 3d20 2775 6e61 7373 6967 6e65 6427  ] = 'unassigned'
-00010c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010ca0: 2020 2020 2064 665f 7265 732e 6c6f 635b       df_res.loc[
-00010cb0: 622c 2027 436c 6172 6974 7927 5d20 3d20  b, 'Clarity'] = 
-00010cc0: 2755 6e63 6c65 6172 270a 0a20 2020 2020  'Unclear'..     
-00010cd0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00010ce0: 6c73 745f 746f 5f65 7863 6c75 6465 2e61  lst_to_exclude.a
-00010cf0: 7070 656e 6428 636c 7374 290a 2020 2020  ppend(clst).    
-00010d00: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00010d10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00010d20: 2020 2020 2020 2323 2046 696e 6420 6d61        ## Find ma
-00010d30: 6a6f 7269 7479 2063 656c 6c0a 2020 2020  jority cell.    
-00010d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d50: 636e 745f 7462 6c20 3d20 6466 5f72 6573  cnt_tbl = df_res
-00010d60: 2e6c 6f63 5b62 2c20 2763 656c 6c5f 7479  .loc[b, 'cell_ty
-00010d70: 7065 2831 7374 2927 5d2e 7661 6c75 655f  pe(1st)'].value_
-00010d80: 636f 756e 7473 2829 0a20 2020 2020 2020  counts().       
-00010d90: 2020 2020 2020 2020 2020 2020 2023 2069               # i
-00010da0: 6478 203d 2063 6e74 5f74 626c 2e69 6e64  dx = cnt_tbl.ind
-00010db0: 6578 2e76 616c 7565 730a 2020 2020 2020  ex.values.      
-00010dc0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-00010dd0: 6a6f 7269 7479 203d 2063 6e74 5f74 626c  jority = cnt_tbl
-00010de0: 2e69 6e64 6578 2e76 616c 7565 735b 305d  .index.values[0]
-00010df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010e00: 2020 2020 2069 6620 636e 745f 7462 6c5b       if cnt_tbl[
-00010e10: 6d61 6a6f 7269 7479 5d20 3e3d 2063 6e74  majority] >= cnt
-00010e20: 5f74 626c 2e73 756d 2829 2a70 6d61 6a3a  _tbl.sum()*pmaj:
-00010e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010e40: 2020 2020 2020 2020 2064 665f 7265 732e           df_res.
-00010e50: 6c6f 635b 622c 2027 6365 6c6c 5f74 7970  loc[b, 'cell_typ
-00010e60: 6528 7265 7629 275d 203d 206d 616a 6f72  e(rev)'] = major
-00010e70: 6974 790a 2020 2020 2020 2020 2020 2020  ity.            
-00010e80: 2020 2020 2020 2020 2020 2020 6466 5f72              df_r
-00010e90: 6573 2e6c 6f63 5b62 2c20 2743 6c61 7269  es.loc[b, 'Clari
-00010ea0: 7479 275d 203d 2027 2d27 0a20 2020 2020  ty'] = '-'.     
-00010eb0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00010ec0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00010ed0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00010ee0: 6d69 6e6f 725f 6964 5f73 6570 3a0a 2020  minor_id_sep:.  
-00010ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f00: 2020 2020 2020 2020 2020 6466 5f72 6573            df_res
-00010f10: 2e6c 6f63 5b62 2c20 2763 656c 6c5f 7479  .loc[b, 'cell_ty
-00010f20: 7065 2872 6576 2927 5d20 3d20 6d61 6a6f  pe(rev)'] = majo
-00010f30: 7269 7479 0a20 2020 2020 2020 2020 2020  rity.           
+000106e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000106f0: 2020 2076 6572 626f 7365 203d 2070 7269     verbose = pri
+00010700: 6e74 5f72 6570 6f72 7429 0a20 2020 2020  nt_report).     
+00010710: 2020 2020 2020 200a 2020 2020 6966 2028         .    if (
+00010720: 7063 745f 6375 746f 6666 2920 2620 286c  pct_cutoff) & (l
+00010730: 656e 286c 6973 7428 7365 7428 795f 636c  en(list(set(y_cl
+00010740: 7573 7429 2929 203e 3d20 3629 3a0a 2020  ust))) >= 6):.  
+00010750: 2020 2020 2020 7363 6f72 6520 3d20 6466        score = df
+00010760: 5f72 6573 5b27 2d6c 6f67 5027 5d2e 636f  _res['-logP'].co
+00010770: 7079 2864 6565 703d 5472 7565 290a 2020  py(deep=True).  
+00010780: 2020 2020 2020 7063 745f 7468 7265 7368        pct_thresh
+00010790: 2c20 6d61 7267 696e 203d 2066 696e 645f  , margin = find_
+000107a0: 7063 745f 6375 746f 6666 2873 636f 7265  pct_cutoff(score
+000107b0: 2c20 795f 636c 7573 742c 206c 6f67 5f70  , y_clust, log_p
+000107c0: 765f 7468 2c0a 2020 2020 2020 2020 2020  v_th,.          
+000107d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000107e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000107f0: 2020 2070 6374 5f66 6974 5f70 6e74 203d     pct_fit_pnt =
+00010800: 2070 6374 5f66 6974 5f70 6e74 2c20 0a20   pct_fit_pnt, . 
+00010810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010830: 2020 2020 2020 2020 2020 2020 7063 745f              pct_
+00010840: 6d69 6e5f 7266 203d 2070 6374 5f6d 696e  min_rf = pct_min
+00010850: 5f72 662c 2070 7269 6e74 5f72 6570 6f72  _rf, print_repor
+00010860: 7420 3d20 4661 6c73 6529 0a20 2020 2020  t = False).     
+00010870: 2020 2023 2070 6374 5f74 6872 6573 6820     # pct_thresh 
+00010880: 3d20 6d69 6e28 6d61 7828 7063 745f 7468  = min(max(pct_th
+00010890: 7265 7368 2c20 312d 706d 616a 292c 2050  resh, 1-pmaj), P
+000108a0: 4354 5f54 4852 4553 484f 4c44 5f4d 4158  CT_THRESHOLD_MAX
+000108b0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+000108c0: 2020 2020 7063 745f 7468 7265 7368 203d      pct_thresh =
+000108d0: 2030 2e32 350a 0a20 2020 2023 2070 7269   0.25..    # pri
+000108e0: 6e74 2827 4265 666f 7265 2074 6872 6573  nt('Before thres
+000108f0: 686f 6c64 696e 673a 2027 2c20 6466 5f72  holding: ', df_r
+00010900: 6573 5b27 6365 6c6c 5f74 7970 6528 7265  es['cell_type(re
+00010910: 7629 275d 2e76 616c 7565 5f63 6f75 6e74  v)'].value_count
+00010920: 7328 2929 0a0a 2020 2020 7063 745f 7468  s())..    pct_th
+00010930: 7265 7368 203d 206d 696e 2870 6374 5f6d  resh = min(pct_m
+00010940: 696e 5f72 662c 2070 6374 5f74 6872 6573  in_rf, pct_thres
+00010950: 6829 0a20 2020 2063 6c73 745f 746f 5f65  h).    clst_to_e
+00010960: 7863 6c75 6465 203d 205b 5d0a 2020 2020  xclude = [].    
+00010970: 2020 2020 0a20 2020 2023 2320 4170 706c      .    ## Appl
+00010980: 7920 4753 4120 7468 7265 7368 6f6c 6473  y GSA thresholds
+00010990: 2049 6620 7468 7265 7368 6f6c 6469 6e67   If thresholding
+000109a0: 2069 7320 5472 7565 0a20 2020 2069 6620   is True.    if 
+000109b0: 7063 745f 6375 746f 6666 3a20 2323 2069  pct_cutoff: ## i
+000109c0: 2e65 2e20 666f 7220 6d61 6a6f 7220 7479  .e. for major ty
+000109d0: 7065 0a20 2020 2020 2020 2069 6620 7468  pe.        if th
+000109e0: 7265 7368 6f6c 6469 6e67 3a0a 0a20 2020  resholding:..   
+000109f0: 2020 2020 2020 2020 2063 6c75 7374 6572           cluster
+00010a00: 5f6c 7374 203d 206c 6973 7428 7365 7428  _lst = list(set(
+00010a10: 795f 636c 7573 7429 290a 2020 2020 2020  y_clust)).      
+00010a20: 2020 2020 2020 636c 7573 7465 725f 6c73        cluster_ls
+00010a30: 742e 736f 7274 2829 0a0a 2020 2020 2020  t.sort()..      
+00010a40: 2020 2020 2020 6966 2070 6374 5f63 7574        if pct_cut
+00010a50: 6f66 6620 2620 7072 696e 745f 7265 706f  off & print_repo
+00010a60: 7274 3a20 0a20 2020 2020 2020 2020 2020  rt: .           
+00010a70: 2020 2020 2070 7269 6e74 2827 505b 5076       print('P[Pv
+00010a80: 3c54 685d 2063 7574 6f66 6620 3d20 2534  <Th] cutoff = %4
+00010a90: 2e32 6628 2534 2e32 6629 2720 2520 2870  .2f(%4.2f)' % (p
+00010aa0: 6374 5f74 6872 6573 682c 206d 6172 6769  ct_thresh, margi
+00010ab0: 6e29 2c20 656e 6420 3d20 2727 290a 0a20  n), end = '').. 
+00010ac0: 2020 2020 2020 2020 2020 2063 6e74 203d             cnt =
+00010ad0: 2030 0a20 2020 2020 2020 2020 2020 2066   0.            f
+00010ae0: 6f72 2063 6c73 7420 696e 2063 6c75 7374  or clst in clust
+00010af0: 6572 5f6c 7374 3a0a 2020 2020 2020 2020  er_lst:.        
+00010b00: 2020 2020 2323 2046 6f72 2065 6163 6820      ## For each 
+00010b10: 636c 7573 7465 722c 0a20 2020 2020 2020  cluster,.       
+00010b20: 2020 2020 2020 2020 2023 2320 7365 6c65           ## sele
+00010b30: 6374 2063 656c 6c73 2069 6e20 7468 6520  ct cells in the 
+00010b40: 636c 7573 7465 720a 2020 2020 2020 2020  cluster.        
+00010b50: 2020 2020 2020 2020 6220 3d20 795f 636c          b = y_cl
+00010b60: 7573 7420 3d3d 2063 6c73 740a 2020 2020  ust == clst.    
+00010b70: 2020 2020 2020 2020 2020 2020 7063 7420              pct 
+00010b80: 3d20 2864 665f 7265 732e 6c6f 635b 622c  = (df_res.loc[b,
+00010b90: 2027 2d6c 6f67 5027 5d20 3e3d 206c 6f67   '-logP'] >= log
+00010ba0: 5f70 765f 7468 292e 7375 6d28 292f 6e70  _pv_th).sum()/np
+00010bb0: 2e73 756d 2862 290a 2020 2020 2020 2020  .sum(b).        
+00010bc0: 2020 2020 2020 2020 6966 2070 6374 203c          if pct <
+00010bd0: 2070 6374 5f74 6872 6573 683a 0a20 2020   pct_thresh:.   
+00010be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010bf0: 2063 6e74 202b 3d20 310a 2020 2020 2020   cnt += 1.      
+00010c00: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00010c10: 2070 7269 6e74 5f72 6570 6f72 743a 0a20   print_report:. 
+00010c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c30: 2020 2020 2020 2063 6e74 5f74 626c 203d         cnt_tbl =
+00010c40: 2064 665f 7265 732e 6c6f 635b 622c 2027   df_res.loc[b, '
+00010c50: 6365 6c6c 5f74 7970 6528 7265 7629 275d  cell_type(rev)']
+00010c60: 2e76 616c 7565 5f63 6f75 6e74 7328 290a  .value_counts().
+00010c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c80: 2020 2020 2020 2020 6d61 6a6f 7269 7479          majority
+00010c90: 203d 2063 6e74 5f74 626c 2e69 6e64 6578   = cnt_tbl.index
+00010ca0: 2e76 616c 7565 735b 305d 0a20 2020 2020  .values[0].     
+00010cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010cc0: 2020 2070 7269 6e74 2827 2c20 2573 2825     print(', %s(%
+00010cd0: 342e 3266 2c20 6d61 6a3a 2573 2927 2025  4.2f, maj:%s)' %
+00010ce0: 2028 7374 7228 636c 7374 292c 2070 6374   (str(clst), pct
+00010cf0: 2c20 6d61 6a6f 7269 7479 292c 2065 6e64  , majority), end
+00010d00: 203d 2027 2729 0a20 2020 2020 2020 2020   = '').         
+00010d10: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00010d20: 2070 7269 6e74 2827 2020 2043 6c75 7374   print('   Clust
+00010d30: 6572 2025 3273 203a 2025 342e 3266 2720  er %2s : %4.2f' 
+00010d40: 2520 2873 7472 2863 6c73 7429 2c20 7063  % (str(clst), pc
+00010d50: 7429 290a 0a20 2020 2020 2020 2020 2020  t))..           
+00010d60: 2020 2020 2020 2020 2064 665f 7265 732e           df_res.
+00010d70: 6c6f 635b 622c 2027 6365 6c6c 5f74 7970  loc[b, 'cell_typ
+00010d80: 6528 7265 7629 275d 203d 2027 756e 6173  e(rev)'] = 'unas
+00010d90: 7369 676e 6564 270a 2020 2020 2020 2020  signed'.        
+00010da0: 2020 2020 2020 2020 2020 2020 6466 5f72              df_r
+00010db0: 6573 2e6c 6f63 5b62 2c20 2743 6c61 7269  es.loc[b, 'Clari
+00010dc0: 7479 275d 203d 2027 556e 636c 6561 7227  ty'] = 'Unclear'
+00010dd0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00010de0: 2020 2020 2020 636c 7374 5f74 6f5f 6578        clst_to_ex
+00010df0: 636c 7564 652e 6170 7065 6e64 2863 6c73  clude.append(cls
+00010e00: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+00010e10: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00010e20: 2020 2020 2020 2020 2020 2020 2023 2320               ## 
+00010e30: 4669 6e64 206d 616a 6f72 6974 7920 6365  Find majority ce
+00010e40: 6c6c 0a20 2020 2020 2020 2020 2020 2020  ll.             
+00010e50: 2020 2020 2020 2063 6e74 5f74 626c 203d         cnt_tbl =
+00010e60: 2064 665f 7265 732e 6c6f 635b 622c 2027   df_res.loc[b, '
+00010e70: 6365 6c6c 5f74 7970 6528 3173 7429 275d  cell_type(1st)']
+00010e80: 2e76 616c 7565 5f63 6f75 6e74 7328 290a  .value_counts().
+00010e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010ea0: 2020 2020 2320 6964 7820 3d20 636e 745f      # idx = cnt_
+00010eb0: 7462 6c2e 696e 6465 782e 7661 6c75 6573  tbl.index.values
+00010ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010ed0: 2020 2020 206d 616a 6f72 6974 7920 3d20       majority = 
+00010ee0: 636e 745f 7462 6c2e 696e 6465 782e 7661  cnt_tbl.index.va
+00010ef0: 6c75 6573 5b30 5d0a 2020 2020 2020 2020  lues[0].        
+00010f00: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+00010f10: 6e74 5f74 626c 5b6d 616a 6f72 6974 795d  nt_tbl[majority]
+00010f20: 203e 3d20 636e 745f 7462 6c2e 7375 6d28   >= cnt_tbl.sum(
+00010f30: 292a 706d 616a 3a0a 2020 2020 2020 2020  )*pmaj:.        
 00010f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f50: 2064 665f 7265 732e 6c6f 635b 622c 2027   df_res.loc[b, '
-00010f60: 436c 6172 6974 7927 5d20 3d20 272d 270a  Clarity'] = '-'.
-00010f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f80: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00010f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010fa0: 2020 2020 2020 2020 2020 7061 7373 0a0a            pass..
-00010fb0: 2020 2020 2020 2020 2020 2020 6966 2070              if p
-00010fc0: 6374 5f63 7574 6f66 6620 2620 7072 696e  ct_cutoff & prin
-00010fd0: 745f 7265 706f 7274 3a20 0a20 2020 2020  t_report: .     
-00010fe0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00010ff0: 2827 202d 2d3e 2025 6920 636c 7573 7465  (' --> %i cluste
-00011000: 7228 7329 2061 6d6f 6e67 2025 6920 6578  r(s) among %i ex
-00011010: 636c 7564 6564 2e20 2720 2520 2863 6e74  cluded. ' % (cnt
-00011020: 2c20 6c65 6e28 636c 7573 7465 725f 6c73  , len(cluster_ls
-00011030: 7429 2929 0a20 2020 2020 2020 2020 2020  t))).           
-00011040: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00011050: 2020 2020 2020 2070 7269 6e74 2827 2e27         print('.'
-00011060: 2c20 656e 6420 3d20 2727 2c20 666c 7573  , end = '', flus
-00011070: 6820 3d20 5472 7565 290a 2020 2020 2020  h = True).      
-00011080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011090: 2020 2020 2020 0a20 2020 2020 2020 2023        .        #
-000110a0: 2070 7269 6e74 2827 4166 7465 7220 7468   print('After th
-000110b0: 7265 7368 6f6c 6469 6e67 3a20 272c 2064  resholding: ', d
-000110c0: 665f 7265 735b 2763 656c 6c5f 7479 7065  f_res['cell_type
-000110d0: 2872 6576 2927 5d2e 7661 6c75 655f 636f  (rev)'].value_co
-000110e0: 756e 7473 2829 290a 0a20 2020 2020 2020  unts())..       
-000110f0: 2063 656c 6c74 7970 6573 203d 206c 6973   celltypes = lis
-00011100: 7428 7468 5f64 6963 742e 6b65 7973 2829  t(th_dict.keys()
-00011110: 290a 2020 2020 2020 2020 6466 5f72 6573  ).        df_res
-00011120: 5b27 3e3d 7468 275d 203d 2054 7275 650a  ['>=th'] = True.
-00011130: 2020 2020 2020 2020 666f 7220 6374 2069          for ct i
-00011140: 6e20 7468 5f64 6963 742e 6b65 7973 2829  n th_dict.keys()
-00011150: 3a0a 2020 2020 2020 2020 2020 2020 6274  :.            bt
-00011160: 203d 2064 665f 7265 735b 2763 656c 6c5f   = df_res['cell_
-00011170: 7479 7065 2872 6576 2927 5d20 3d3d 2063  type(rev)'] == c
-00011180: 740a 2020 2020 2020 2020 2020 2020 6268  t.            bh
-00011190: 203d 2064 665f 7265 735b 272d 6c6f 6750   = df_res['-logP
-000111a0: 275d 203c 2074 685f 6469 6374 5b63 745d  '] < th_dict[ct]
-000111b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000111c0: 6e70 2e73 756d 2862 7426 6268 2920 3e3d  np.sum(bt&bh) >=
-000111d0: 2031 303a 0a20 2020 2020 2020 2020 2020   10:.           
-000111e0: 2020 2020 2064 665f 7265 732e 6c6f 635b       df_res.loc[
-000111f0: 6274 2662 682c 2027 3e3d 7468 275d 203d  bt&bh, '>=th'] =
-00011200: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
-00011210: 2020 2065 6c69 6620 6e70 2e73 756d 2862     elif np.sum(b
-00011220: 7429 203c 2031 303a 0a20 2020 2020 2020  t) < 10:.       
-00011230: 2020 2020 2020 2020 2064 665f 7265 732e           df_res.
-00011240: 6c6f 635b 6274 2c20 273e 3d74 6827 5d20  loc[bt, '>=th'] 
-00011250: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-00011260: 2020 2020 2020 2020 0a20 2020 2065 6c73          .    els
-00011270: 653a 2023 2320 692e 652e 206d 696e 6f72  e: ## i.e. minor
-00011280: 2074 7970 6520 6f72 2073 7562 7365 7420   type or subset 
-00011290: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-000112a0: 2020 2323 2041 7070 6c79 2047 5341 2074    ## Apply GSA t
-000112b0: 6872 6573 686f 6c64 7320 4966 2074 6872  hresholds If thr
-000112c0: 6573 686f 6c64 696e 6720 6973 2054 7275  esholding is Tru
-000112d0: 650a 2020 2020 2020 2020 6966 2074 6872  e.        if thr
-000112e0: 6573 686f 6c64 696e 673a 0a20 2020 2020  esholding:.     
-000112f0: 2020 2020 2020 2063 656c 6c74 7970 6573         celltypes
-00011300: 203d 206c 6973 7428 7468 5f64 6963 742e   = list(th_dict.
-00011310: 6b65 7973 2829 290a 2020 2020 2020 2020  keys()).        
-00011320: 2020 2020 6466 5f72 6573 5b27 3e3d 7468      df_res['>=th
-00011330: 275d 203d 2054 7275 650a 2020 2020 2020  '] = True.      
-00011340: 2020 2020 2020 666f 7220 6374 2069 6e20        for ct in 
-00011350: 7468 5f64 6963 742e 6b65 7973 2829 3a0a  th_dict.keys():.
-00011360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011370: 6274 203d 2064 665f 7265 735b 2763 656c  bt = df_res['cel
-00011380: 6c5f 7479 7065 2872 6576 2927 5d20 3d3d  l_type(rev)'] ==
-00011390: 2063 740a 2020 2020 2020 2020 2020 2020   ct.            
-000113a0: 2020 2020 6268 203d 2064 665f 7265 735b      bh = df_res[
-000113b0: 272d 6c6f 6750 275d 203c 2074 685f 6469  '-logP'] < th_di
-000113c0: 6374 5b63 745d 0a20 2020 2020 2020 2020  ct[ct].         
-000113d0: 2020 2020 2020 2064 665f 7265 732e 6c6f         df_res.lo
-000113e0: 635b 6274 2662 682c 2027 6365 6c6c 5f74  c[bt&bh, 'cell_t
-000113f0: 7970 6528 7265 7629 275d 203d 2027 756e  ype(rev)'] = 'un
-00011400: 6173 7369 676e 6564 270a 2020 2020 2020  assigned'.      
-00011410: 2020 2020 2020 2020 2020 6466 5f72 6573            df_res
-00011420: 2e6c 6f63 5b62 7426 6268 2c20 273e 3d74  .loc[bt&bh, '>=t
-00011430: 6827 5d20 3d20 4661 6c73 650a 0a20 2020  h'] = False..   
-00011440: 2020 2020 2020 2020 2079 5f70 7265 6420           y_pred 
-00011450: 3d20 6466 5f72 6573 5b27 6365 6c6c 5f74  = df_res['cell_t
-00011460: 7970 6528 7265 7629 275d 0a20 2020 2020  ype(rev)'].     
-00011470: 2020 2020 2020 2069 6620 7072 696e 745f         if print_
-00011480: 7265 706f 7274 3a0a 2020 2020 2020 2020  report:.        
-00011490: 2020 2020 2020 2020 625f 6375 7220 3d20          b_cur = 
-000114a0: 795f 7072 6564 203d 3d20 2775 6e61 7373  y_pred == 'unass
-000114b0: 6967 6e65 6427 0a20 2020 2020 2020 2020  igned'.         
-000114c0: 2020 2020 2020 2070 7269 6e74 2827 4e75         print('Nu
-000114d0: 6d20 6f66 2075 6e61 7373 6967 6e65 6420  m of unassigned 
-000114e0: 6365 6c6c 733a 2025 6920 616d 6f6e 6720  cells: %i among 
-000114f0: 2569 2720 2520 286e 702e 7375 6d28 625f  %i' % (np.sum(b_
-00011500: 6375 7229 2c20 6c65 6e28 625f 6375 7229  cur), len(b_cur)
-00011510: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
-00011520: 6466 5f72 6573 5b27 6365 6c6c 5f74 7970  df_res['cell_typ
-00011530: 6527 5d20 3d20 795f 7072 6564 0a20 2020  e'] = y_pred.   
-00011540: 2020 2020 2020 2020 2020 2020 200a 2020               .  
-00011550: 2020 0a20 2020 2079 7320 3d20 6466 5f72    .    ys = df_r
-00011560: 6573 5b27 6365 6c6c 5f74 7970 6528 7265  es['cell_type(re
-00011570: 7629 275d 2e63 6f70 7928 6465 6570 3d54  v)'].copy(deep=T
-00011580: 7275 6529 2020 2020 0a20 2020 2064 665f  rue)    .    df_
-00011590: 7265 735b 2763 656c 6c5f 7479 7065 2872  res['cell_type(r
-000115a0: 6576 3229 275d 203d 2079 730a 2020 2020  ev2)'] = ys.    
-000115b0: 0a20 2020 2063 6c61 7373 5f6e 616d 6573  .    class_names
-000115c0: 203d 206c 6973 7428 6466 5f47 5341 5f73   = list(df_GSA_s
-000115d0: 636f 7265 2e63 6f6c 756d 6e73 2e76 616c  core.columns.val
-000115e0: 7565 7329 2020 2020 200a 2020 2020 6966  ues)     .    if
-000115f0: 206d 6574 686f 6420 3d3d 2027 6c6f 6772   method == 'logr
-00011600: 6567 273a 0a20 2020 2020 2020 2079 5f70  eg':.        y_p
-00011610: 7265 642c 2064 665f 7363 6f72 6520 3d20  red, df_score = 
-00011620: 435f 6d61 6a6f 725f 6c6f 6772 6567 2858  C_major_logreg(X
-00011630: 5f70 6361 2c20 7973 2c20 636c 6173 735f  _pca, ys, class_
-00011640: 6e61 6d65 732c 200a 2020 2020 2020 2020  names, .        
-00011650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011670: 2020 7665 7262 6f73 6520 3d20 7072 696e    verbose = prin
-00011680: 745f 7265 706f 7274 2029 0a20 2020 2065  t_report ).    e
-00011690: 6c69 6620 6d65 7468 6f64 203d 3d20 2767  lif method == 'g
-000116a0: 6d6d 273a 0a20 2020 2020 2020 2079 5f70  mm':.        y_p
-000116b0: 7265 642c 2064 665f 7363 6f72 6520 3d20  red, df_score = 
-000116c0: 435f 6d61 6a6f 725f 676d 6d28 585f 7063  C_major_gmm(X_pc
-000116d0: 612c 2079 732c 2063 6c61 7373 5f6e 616d  a, ys, class_nam
-000116e0: 6573 2c20 0a20 2020 2020 2020 2020 2020  es, .           
-000116f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011700: 2020 2020 2020 2020 6d65 7468 6f64 203d          method =
-00011710: 206d 6574 686f 642c 200a 2020 2020 2020   method, .      
-00011720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011730: 2020 2020 2020 2020 2020 2020 204e 5f63               N_c
-00011740: 6f6d 706f 6e65 6e74 7320 3d20 4e5f 636f  omponents = N_co
-00011750: 6d70 6f6e 656e 7473 2c20 0a20 2020 2020  mponents, .     
+00010f50: 6466 5f72 6573 2e6c 6f63 5b62 2c20 2763  df_res.loc[b, 'c
+00010f60: 656c 6c5f 7479 7065 2872 6576 2927 5d20  ell_type(rev)'] 
+00010f70: 3d20 6d61 6a6f 7269 7479 0a20 2020 2020  = majority.     
+00010f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f90: 2020 2064 665f 7265 732e 6c6f 635b 622c     df_res.loc[b,
+00010fa0: 2027 436c 6172 6974 7927 5d20 3d20 272d   'Clarity'] = '-
+00010fb0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00010fc0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00010fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010fe0: 2020 2020 6966 206d 696e 6f72 5f69 645f      if minor_id_
+00010ff0: 7365 703a 0a20 2020 2020 2020 2020 2020  sep:.           
+00011000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011010: 2064 665f 7265 732e 6c6f 635b 622c 2027   df_res.loc[b, '
+00011020: 6365 6c6c 5f74 7970 6528 7265 7629 275d  cell_type(rev)']
+00011030: 203d 206d 616a 6f72 6974 790a 2020 2020   = majority.    
+00011040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011050: 2020 2020 2020 2020 6466 5f72 6573 2e6c          df_res.l
+00011060: 6f63 5b62 2c20 2743 6c61 7269 7479 275d  oc[b, 'Clarity']
+00011070: 203d 2027 2d27 0a20 2020 2020 2020 2020   = '-'.         
+00011080: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00011090: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000110a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000110b0: 2070 6173 730a 0a20 2020 2020 2020 2020   pass..         
+000110c0: 2020 2069 6620 7063 745f 6375 746f 6666     if pct_cutoff
+000110d0: 2026 2070 7269 6e74 5f72 6570 6f72 743a   & print_report:
+000110e0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+000110f0: 2020 7072 696e 7428 2720 2d2d 3e20 2569    print(' --> %i
+00011100: 2063 6c75 7374 6572 2873 2920 616d 6f6e   cluster(s) amon
+00011110: 6720 2569 2065 7863 6c75 6465 642e 2027  g %i excluded. '
+00011120: 2025 2028 636e 742c 206c 656e 2863 6c75   % (cnt, len(clu
+00011130: 7374 6572 5f6c 7374 2929 290a 2020 2020  ster_lst))).    
+00011140: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00011150: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00011160: 696e 7428 272e 272c 2065 6e64 203d 2027  int('.', end = '
+00011170: 272c 2066 6c75 7368 203d 2054 7275 6529  ', flush = True)
+00011180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011190: 2020 2020 2020 2020 2020 2020 200a 2020               .  
+000111a0: 2020 2020 2020 2320 7072 696e 7428 2741        # print('A
+000111b0: 6674 6572 2074 6872 6573 686f 6c64 696e  fter thresholdin
+000111c0: 673a 2027 2c20 6466 5f72 6573 5b27 6365  g: ', df_res['ce
+000111d0: 6c6c 5f74 7970 6528 7265 7629 275d 2e76  ll_type(rev)'].v
+000111e0: 616c 7565 5f63 6f75 6e74 7328 2929 0a0a  alue_counts())..
+000111f0: 2020 2020 2020 2020 6365 6c6c 7479 7065          celltype
+00011200: 7320 3d20 6c69 7374 2874 685f 6469 6374  s = list(th_dict
+00011210: 2e6b 6579 7328 2929 0a20 2020 2020 2020  .keys()).       
+00011220: 2064 665f 7265 735b 273e 3d74 6827 5d20   df_res['>=th'] 
+00011230: 3d20 5472 7565 0a20 2020 2020 2020 2066  = True.        f
+00011240: 6f72 2063 7420 696e 2074 685f 6469 6374  or ct in th_dict
+00011250: 2e6b 6579 7328 293a 0a20 2020 2020 2020  .keys():.       
+00011260: 2020 2020 2062 7420 3d20 6466 5f72 6573       bt = df_res
+00011270: 5b27 6365 6c6c 5f74 7970 6528 7265 7629  ['cell_type(rev)
+00011280: 275d 203d 3d20 6374 0a20 2020 2020 2020  '] == ct.       
+00011290: 2020 2020 2062 6820 3d20 6466 5f72 6573       bh = df_res
+000112a0: 5b27 2d6c 6f67 5027 5d20 3c20 7468 5f64  ['-logP'] < th_d
+000112b0: 6963 745b 6374 5d0a 2020 2020 2020 2020  ict[ct].        
+000112c0: 2020 2020 6966 206e 702e 7375 6d28 6274      if np.sum(bt
+000112d0: 2662 6829 203e 3d20 3130 3a0a 2020 2020  &bh) >= 10:.    
+000112e0: 2020 2020 2020 2020 2020 2020 6466 5f72              df_r
+000112f0: 6573 2e6c 6f63 5b62 7426 6268 2c20 273e  es.loc[bt&bh, '>
+00011300: 3d74 6827 5d20 3d20 4661 6c73 650a 2020  =th'] = False.  
+00011310: 2020 2020 2020 2020 2020 656c 6966 206e            elif n
+00011320: 702e 7375 6d28 6274 2920 3c20 3130 3a0a  p.sum(bt) < 10:.
+00011330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011340: 6466 5f72 6573 2e6c 6f63 5b62 742c 2027  df_res.loc[bt, '
+00011350: 3e3d 7468 275d 203d 2046 616c 7365 0a20  >=th'] = False. 
+00011360: 2020 2020 2020 2020 2020 2020 2020 200a                 .
+00011370: 2020 2020 656c 7365 3a20 2323 2069 2e65      else: ## i.e
+00011380: 2e20 6d69 6e6f 7220 7479 7065 206f 7220  . minor type or 
+00011390: 7375 6273 6574 200a 2020 2020 2020 2020  subset .        
+000113a0: 0a20 2020 2020 2020 2023 2320 4170 706c  .        ## Appl
+000113b0: 7920 4753 4120 7468 7265 7368 6f6c 6473  y GSA thresholds
+000113c0: 2049 6620 7468 7265 7368 6f6c 6469 6e67   If thresholding
+000113d0: 2069 7320 5472 7565 0a20 2020 2020 2020   is True.       
+000113e0: 2069 6620 7468 7265 7368 6f6c 6469 6e67   if thresholding
+000113f0: 3a0a 2020 2020 2020 2020 2020 2020 6365  :.            ce
+00011400: 6c6c 7479 7065 7320 3d20 6c69 7374 2874  lltypes = list(t
+00011410: 685f 6469 6374 2e6b 6579 7328 2929 0a20  h_dict.keys()). 
+00011420: 2020 2020 2020 2020 2020 2064 665f 7265             df_re
+00011430: 735b 273e 3d74 6827 5d20 3d20 5472 7565  s['>=th'] = True
+00011440: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00011450: 2063 7420 696e 2074 685f 6469 6374 2e6b   ct in th_dict.k
+00011460: 6579 7328 293a 0a20 2020 2020 2020 2020  eys():.         
+00011470: 2020 2020 2020 2062 7420 3d20 6466 5f72         bt = df_r
+00011480: 6573 5b27 6365 6c6c 5f74 7970 6528 7265  es['cell_type(re
+00011490: 7629 275d 203d 3d20 6374 0a20 2020 2020  v)'] == ct.     
+000114a0: 2020 2020 2020 2020 2020 2062 6820 3d20             bh = 
+000114b0: 6466 5f72 6573 5b27 2d6c 6f67 5027 5d20  df_res['-logP'] 
+000114c0: 3c20 7468 5f64 6963 745b 6374 5d0a 2020  < th_dict[ct].  
+000114d0: 2020 2020 2020 2020 2020 2020 2020 6466                df
+000114e0: 5f72 6573 2e6c 6f63 5b62 7426 6268 2c20  _res.loc[bt&bh, 
+000114f0: 2763 656c 6c5f 7479 7065 2872 6576 2927  'cell_type(rev)'
+00011500: 5d20 3d20 2775 6e61 7373 6967 6e65 6427  ] = 'unassigned'
+00011510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011520: 2064 665f 7265 732e 6c6f 635b 6274 2662   df_res.loc[bt&b
+00011530: 682c 2027 3e3d 7468 275d 203d 2046 616c  h, '>=th'] = Fal
+00011540: 7365 0a0a 2020 2020 2020 2020 2020 2020  se..            
+00011550: 795f 7072 6564 203d 2064 665f 7265 735b  y_pred = df_res[
+00011560: 2763 656c 6c5f 7479 7065 2872 6576 2927  'cell_type(rev)'
+00011570: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
+00011580: 2070 7269 6e74 5f72 6570 6f72 743a 0a20   print_report:. 
+00011590: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+000115a0: 5f63 7572 203d 2079 5f70 7265 6420 3d3d  _cur = y_pred ==
+000115b0: 2027 756e 6173 7369 676e 6564 270a 2020   'unassigned'.  
+000115c0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+000115d0: 696e 7428 274e 756d 206f 6620 756e 6173  int('Num of unas
+000115e0: 7369 676e 6564 2063 656c 6c73 3a20 2569  signed cells: %i
+000115f0: 2061 6d6f 6e67 2025 6927 2025 2028 6e70   among %i' % (np
+00011600: 2e73 756d 2862 5f63 7572 292c 206c 656e  .sum(b_cur), len
+00011610: 2862 5f63 7572 2929 290a 0a20 2020 2020  (b_cur)))..     
+00011620: 2020 2020 2020 2064 665f 7265 735b 2763         df_res['c
+00011630: 656c 6c5f 7479 7065 275d 203d 2079 5f70  ell_type'] = y_p
+00011640: 7265 640a 2020 2020 2020 2020 2020 2020  red.            
+00011650: 2020 2020 0a20 2020 200a 2020 2020 7973      .    .    ys
+00011660: 203d 2064 665f 7265 735b 2763 656c 6c5f   = df_res['cell_
+00011670: 7479 7065 2872 6576 2927 5d2e 636f 7079  type(rev)'].copy
+00011680: 2864 6565 703d 5472 7565 2920 2020 200a  (deep=True)    .
+00011690: 2020 2020 6466 5f72 6573 5b27 6365 6c6c      df_res['cell
+000116a0: 5f74 7970 6528 7265 7632 2927 5d20 3d20  _type(rev2)'] = 
+000116b0: 7973 0a20 2020 200a 2020 2020 636c 6173  ys.    .    clas
+000116c0: 735f 6e61 6d65 7320 3d20 6c69 7374 2864  s_names = list(d
+000116d0: 665f 4753 415f 7363 6f72 652e 636f 6c75  f_GSA_score.colu
+000116e0: 6d6e 732e 7661 6c75 6573 2920 2020 2020  mns.values)     
+000116f0: 0a20 2020 2069 6620 6d65 7468 6f64 203d  .    if method =
+00011700: 3d20 276c 6f67 7265 6727 3a0a 2020 2020  = 'logreg':.    
+00011710: 2020 2020 795f 7072 6564 2c20 6466 5f73      y_pred, df_s
+00011720: 636f 7265 203d 2043 5f6d 616a 6f72 5f6c  core = C_major_l
+00011730: 6f67 7265 6728 585f 7063 612c 2079 732c  ogreg(X_pca, ys,
+00011740: 2063 6c61 7373 5f6e 616d 6573 2c20 0a20   class_names, . 
+00011750: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00011760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011770: 2020 2020 2020 2020 2020 2020 2020 7665                ve
-00011780: 7262 6f73 6520 3d20 7072 696e 745f 7265  rbose = print_re
-00011790: 706f 7274 2029 0a20 2020 2020 2020 2020  port ).         
-000117a0: 2020 200a 2020 2020 2020 2020 2323 2072     .        ## r
-000117b0: 656a 6563 7420 6966 2047 4d4d 2073 636f  eject if GMM sco
-000117c0: 7265 203e 2030 0a20 2020 2020 2020 2023  re > 0.        #
-000117d0: 204d 696e 5620 3d20 6466 5f73 636f 7265   MinV = df_score
-000117e0: 2e6d 696e 2829 2e6d 696e 2829 0a20 2020  .min().min().   
-000117f0: 2020 2020 2069 6620 6466 5f73 636f 7265       if df_score
-00011800: 2e73 6861 7065 5b31 5d20 3e20 303a 0a20  .shape[1] > 0:. 
-00011810: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-00011820: 2069 6e20 7261 6e67 6528 6466 5f73 636f   in range(df_sco
-00011830: 7265 2e73 6861 7065 5b30 5d29 3a0a 2020  re.shape[0]):.  
-00011840: 2020 2020 2020 2020 2020 2020 2020 7363                sc
-00011850: 6f72 6520 3d20 6466 5f73 636f 7265 2e69  ore = df_score.i
-00011860: 6c6f 635b 695d 2e63 6f70 7928 6465 6570  loc[i].copy(deep
-00011870: 203d 2054 7275 6529 0a20 2020 2020 2020   = True).       
-00011880: 2020 2020 2020 2020 2062 203d 2073 636f           b = sco
-00011890: 7265 203e 2030 0a20 2020 2020 2020 2020  re > 0.         
-000118a0: 2020 2020 2020 2073 636f 7265 5b62 5d20         score[b] 
-000118b0: 3d20 3020 2320 4d69 6e56 0a20 2020 2020  = 0 # MinV.     
-000118c0: 2020 2020 2020 2020 2020 2064 665f 7363             df_sc
-000118d0: 6f72 652e 696c 6f63 5b69 5d20 3d20 6c69  ore.iloc[i] = li
-000118e0: 7374 2873 636f 7265 290a 2020 2020 656c  st(score).    el
-000118f0: 7365 3a20 0a20 2020 2020 2020 2079 5f70  se: .        y_p
-00011900: 7265 6420 3d20 7973 0a20 2020 2020 2020  red = ys.       
-00011910: 2064 665f 7363 6f72 6520 3d20 4e6f 6e65   df_score = None
-00011920: 0a0a 2020 2020 6966 2070 6374 5f63 7574  ..    if pct_cut
-00011930: 6f66 663a 2023 2320 692e 652e 2066 6f72  off: ## i.e. for
-00011940: 206d 616a 6f72 2074 7970 6520 2020 2020   major type     
-00011950: 2020 200a 2020 2020 2020 2020 666f 7220     .        for 
-00011960: 636c 7374 2069 6e20 636c 7374 5f74 6f5f  clst in clst_to_
-00011970: 6578 636c 7564 653a 0a20 2020 2020 2020  exclude:.       
-00011980: 2020 2020 2062 203d 2079 5f63 6c75 7374       b = y_clust
-00011990: 203d 3d20 636c 7374 0a20 2020 2020 2020   == clst.       
-000119a0: 2020 2020 2079 5f70 7265 645b 625d 203d       y_pred[b] =
-000119b0: 2027 756e 6173 7369 676e 6564 270a 2020   'unassigned'.  
-000119c0: 2020 2020 2020 2020 2020 0a20 2020 2023            .    #
-000119d0: 2064 665f 7363 6f72 6520 3d20 6466 5f73   df_score = df_s
-000119e0: 636f 7265 202b 2064 665f 4753 415f 7363  core + df_GSA_sc
-000119f0: 6f72 652e 636c 6970 2875 7070 6572 203d  ore.clip(upper =
-00011a00: 2035 290a 2020 2020 0a20 2020 2064 665f   5).    .    df_
-00011a10: 7265 735b 2763 656c 6c5f 7479 7065 2872  res['cell_type(r
-00011a20: 6576 3329 275d 203d 2079 5f70 7265 640a  ev3)'] = y_pred.
-00011a30: 2020 2020 2320 7072 696e 7428 2741 6674      # print('Aft
-00011a40: 6572 2067 6d6d 3a20 272c 2064 665f 7265  er gmm: ', df_re
-00011a50: 735b 2763 656c 6c5f 7479 7065 2872 6576  s['cell_type(rev
-00011a60: 3329 275d 2e76 616c 7565 5f63 6f75 6e74  3)'].value_count
-00011a70: 7328 2929 0a20 2020 200a 2020 2020 6966  s()).    .    if
-00011a80: 2028 6d65 7468 6f64 2069 7320 6e6f 7420   (method is not 
-00011a90: 4e6f 6e65 2920 2620 2864 665f 7363 6f72  None) & (df_scor
-00011aa0: 6520 6973 206e 6f74 204e 6f6e 6529 3a20  e is not None): 
-00011ab0: 0a20 2020 2020 2020 2069 6620 2874 6872  .        if (thr
-00011ac0: 6573 686f 6c64 696e 6729 3a20 0a20 2020  esholding): .   
-00011ad0: 2020 2020 2020 2020 2069 6620 2864 665f           if (df_
-00011ae0: 7363 6f72 652e 7368 6170 655b 315d 203c  score.shape[1] <
-00011af0: 3d20 3129 3a0a 2020 2020 2020 2020 2020  = 1):.          
-00011b00: 2020 2020 2020 795f 7072 6564 203d 2079        y_pred = y
-00011b10: 730a 2020 2020 2020 2020 2020 2020 656c  s.            el
-00011b20: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00011b30: 2020 2020 6466 5f73 756d 6d61 7279 203d      df_summary =
-00011b40: 2067 6574 5f73 7461 7428 6466 5f73 636f   get_stat(df_sco
-00011b50: 7265 2920 2020 2020 2020 2020 2020 2020  re)             
-00011b60: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-00011b70: 2020 2020 7468 5f64 6963 742c 2064 6966      th_dict, dif
-00011b80: 665f 6469 6374 203d 2067 6574 5f74 6872  f_dict = get_thr
-00011b90: 6573 686f 6c64 5f66 726f 6d5f 474d 4d5f  eshold_from_GMM_
-00011ba0: 7265 7375 6c74 2864 665f 7375 6d6d 6172  result(df_summar
-00011bb0: 792c 200a 2020 2020 2020 2020 2020 2020  y, .            
-00011bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011be0: 2020 2020 2020 2020 7461 7267 6574 5f46          target_F
-00011bf0: 5052 203d 2054 6172 6765 745f 4650 522c  PR = Target_FPR,
-00011c00: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00011c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c30: 2020 2020 2020 7665 7262 6f73 6520 3d20        verbose = 
-00011c40: 7072 696e 745f 7265 706f 7274 2c20 0a20  print_report, . 
-00011c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c80: 2020 2070 6c6f 745f 6869 7374 203d 2046     plot_hist = F
-00011c90: 616c 7365 2029 2023 2070 7269 6e74 5f72  alse ) # print_r
-00011ca0: 6570 6f72 7429 200a 0a20 2020 2020 2020  eport) ..       
-00011cb0: 2020 2020 2020 2020 206c 6162 656c 5f6c           label_l
-00011cc0: 7374 203d 206c 6973 7428 795f 7072 6564  st = list(y_pred
-00011cd0: 2e75 6e69 7175 6528 2929 0a20 2020 2020  .unique()).     
-00011ce0: 2020 2020 2020 2020 2020 2066 6f72 206c             for l
-00011cf0: 6162 656c 2069 6e20 6c61 6265 6c5f 6c73  abel in label_ls
-00011d00: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-00011d10: 2020 2020 2020 2069 6620 286c 6162 656c         if (label
-00011d20: 2021 3d20 2775 6e61 7373 6967 6e65 6427   != 'unassigned'
-00011d30: 2920 2620 286c 6162 656c 2069 6e20 7468  ) & (label in th
-00011d40: 5f64 6963 742e 6b65 7973 2829 293a 0a20  _dict.keys()):. 
-00011d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011d60: 2020 2020 2020 2062 3120 3d20 795f 7072         b1 = y_pr
-00011d70: 6564 203d 3d20 6c61 6265 6c0a 2020 2020  ed == label.    
-00011d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011d90: 2020 2020 6232 203d 2064 665f 7375 6d6d      b2 = df_summ
-00011da0: 6172 795b 2753 636f 7265 275d 203c 2020  ary['Score'] <  
-00011db0: 7468 5f64 6963 745b 6c61 6265 6c5d 0a20  th_dict[label]. 
-00011dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011dd0: 2020 2020 2020 2062 3320 3d20 6466 5f72         b3 = df_r
-00011de0: 6573 5b27 2d6c 6f67 502d 6c6f 6750 2832  es['-logP-logP(2
-00011df0: 6e64 2927 5d20 3c20 6d69 6e5f 6c6f 6750  nd)'] < min_logP
-00011e00: 5f64 6966 660a 2020 2020 2020 2020 2020  _diff.          
-00011e10: 2020 2020 2020 2020 2020 2020 2020 795f                y_
-00011e20: 7072 6564 5b62 3126 6232 2662 335d 203d  pred[b1&b2&b3] =
-00011e30: 2027 756e 6173 7369 676e 6564 270a 0a20   'unassigned'.. 
-00011e40: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00011e50: 7820 3d20 7973 203d 3d20 2775 6e61 7373  x = ys == 'unass
-00011e60: 6967 6e65 6427 2023 230a 2020 2020 2020  igned' ##.      
-00011e70: 2020 2020 2020 2020 2020 6278 203d 2079            bx = y
-00011e80: 5f70 7265 6420 3d3d 2027 756e 6173 7369  _pred == 'unassi
-00011e90: 676e 6564 2720 2320 6e6f 7420 776f 726b  gned' # not work
-00011ea0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
-00011eb0: 2020 2020 666f 7220 636c 7374 2069 6e20      for clst in 
-00011ec0: 636c 7573 7465 725f 6c73 743a 0a20 2020  cluster_lst:.   
-00011ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ee0: 2062 203d 2079 5f63 6c75 7374 203d 3d20   b = y_clust == 
-00011ef0: 636c 7374 0a20 2020 2020 2020 2020 2020  clst.           
-00011f00: 2020 2020 2020 2020 2023 2320 4966 2074           ## If t
-00011f10: 6865 206d 616a 6f72 6974 7920 6f66 2061  he majority of a
-00011f20: 2063 6c75 7374 6572 2069 7320 756e 6173   cluster is unas
-00011f30: 7369 676e 6564 2c0a 2020 2020 2020 2020  signed,.        
-00011f40: 2020 2020 2020 2020 2020 2020 2323 2073              ## s
-00011f50: 6574 2061 6c6c 2074 6865 2063 656c 6c73  et all the cells
-00011f60: 2069 6e20 7468 6520 636c 7573 7465 7220   in the cluster 
-00011f70: 756e 6173 7369 676e 6564 0a20 2020 2020  unassigned.     
-00011f80: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00011f90: 2069 6620 4661 6c73 653a 2023 206e 702e   if False: # np.
-00011fa0: 7375 6d28 6226 6278 2920 3e20 6e70 2e73  sum(b&bx) > np.s
-00011fb0: 756d 2862 292a 706d 616a 3a0a 2020 2020  um(b)*pmaj:.    
-00011fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011fd0: 2320 2020 2020 795f 7072 6564 5b62 5d20  #     y_pred[b] 
-00011fe0: 3d20 2775 6e61 7373 6967 6e65 6427 0a20  = 'unassigned'. 
-00011ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012000: 2020 2069 6620 6e70 2e73 756d 2862 2628     if np.sum(b&(
-00012010: 7e62 7829 2920 3e20 303a 0a20 2020 2020  ~bx)) > 0:.     
-00012020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012030: 2020 2063 6e74 5f74 626c 203d 2079 5f70     cnt_tbl = y_p
-00012040: 7265 645b 6226 287e 6278 295d 2e76 616c  red[b&(~bx)].val
-00012050: 7565 5f63 6f75 6e74 7328 290a 2020 2020  ue_counts().    
-00012060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012070: 2020 2020 2320 6964 7820 3d20 636e 745f      # idx = cnt_
-00012080: 7462 6c2e 696e 6465 782e 7661 6c75 6573  tbl.index.values
-00012090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000120a0: 2020 2020 2020 2020 206d 616a 6f72 6974           majorit
-000120b0: 7920 3d20 636e 745f 7462 6c2e 696e 6465  y = cnt_tbl.inde
-000120c0: 782e 7661 6c75 6573 5b30 5d0a 2020 2020  x.values[0].    
-000120d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000120e0: 2020 2020 6966 2063 6e74 5f74 626c 5b6d      if cnt_tbl[m
-000120f0: 616a 6f72 6974 795d 203e 3d20 636e 745f  ajority] >= cnt_
-00012100: 7462 6c2e 7375 6d28 292a 706d 616a 3a0a  tbl.sum()*pmaj:.
-00012110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012120: 2020 2020 2020 2020 2020 2020 795f 7072              y_pr
-00012130: 6564 5b62 5d20 3d20 6d61 6a6f 7269 7479  ed[b] = majority
-00012140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012150: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00012160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012170: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-00012180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012190: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-000121a0: 2023 2070 7269 6e74 2827 4166 7465 7220   # print('After 
-000121b0: 676d 6d20 7468 3a20 272c 2079 5f70 7265  gmm th: ', y_pre
-000121c0: 642e 7661 6c75 655f 636f 756e 7473 2829  d.value_counts()
-000121d0: 290a 2020 2020 0a20 2020 2064 665f 7265  ).    .    df_re
-000121e0: 735b 2763 656c 6c5f 7479 7065 2872 6576  s['cell_type(rev
-000121f0: 3429 275d 203d 2079 5f70 7265 640a 2020  4)'] = y_pred.  
-00012200: 2020 6278 203d 2079 5f70 7265 6420 3d3d    bx = y_pred ==
-00012210: 2027 756e 6173 7369 676e 6564 270a 2020   'unassigned'.  
-00012220: 2020 0a20 2020 2069 6620 534b 4e45 5457    .    if SKNETW
-00012230: 4f52 4b3a 0a20 2020 2020 2020 2069 6620  ORK:.        if 
-00012240: 7063 745f 6375 746f 6666 2026 2028 6973  pct_cutoff & (is
-00012250: 696e 7374 616e 6365 2863 6f62 6a2c 204c  instance(cobj, L
-00012260: 6f75 7661 696e 2929 2026 2028 6362 635f  ouvain)) & (cbc_
-00012270: 6375 746f 6666 203e 2030 293a 2023 2061  cutoff > 0): # a
-00012280: 7070 6c79 206f 6e6c 7920 666f 7220 6d61  pply only for ma
-00012290: 6a6f 7220 7479 7065 0a20 2020 2020 2020  jor type.       
-000122a0: 2020 2020 2079 5f70 7265 6420 3d20 636c       y_pred = cl
-000122b0: 7573 7465 725f 6261 7369 735f 636f 7272  uster_basis_corr
-000122c0: 6563 7469 6f6e 2858 5f70 6361 2c20 795f  ection(X_pca, y_
-000122d0: 7072 6564 2c20 0a20 2020 2020 2020 2020  pred, .         
-000122e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000122f0: 2020 636f 626a 2c20 795f 636c 7573 742c    cobj, y_clust,
-00012300: 2070 6d61 6a20 3d20 706d 616a 2c20 0a20   pmaj = pmaj, . 
-00012310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012320: 2020 2020 2020 2020 2020 6375 746f 6666            cutoff
-00012330: 203d 2063 6263 5f63 7574 6f66 662c 2076   = cbc_cutoff, v
-00012340: 6572 626f 7365 203d 2070 7269 6e74 5f72  erbose = print_r
-00012350: 6570 6f72 7429 0a20 2020 2020 2020 200a  eport).        .
-00012360: 2020 2020 6966 2070 7269 6e74 5f72 6570      if print_rep
-00012370: 6f72 743a 0a20 2020 2020 2020 2062 5f63  ort:.        b_c
-00012380: 7572 203d 2079 5f70 7265 6420 3d3d 2027  ur = y_pred == '
-00012390: 756e 6173 7369 676e 6564 270a 2020 2020  unassigned'.    
-000123a0: 2020 2020 7072 696e 7428 274e 756d 206f      print('Num o
-000123b0: 6620 756e 6173 7369 676e 6564 2063 656c  f unassigned cel
-000123c0: 6c73 3a20 2569 2061 6d6f 6e67 2025 6927  ls: %i among %i'
-000123d0: 2025 2028 6e70 2e73 756d 2862 5f63 7572   % (np.sum(b_cur
-000123e0: 292c 206c 656e 2862 5f63 7572 2929 290a  ), len(b_cur))).
-000123f0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00012400: 2020 6966 2070 6374 5f63 7574 6f66 663a    if pct_cutoff:
-00012410: 2070 7269 6e74 2827 2e27 2c20 656e 6420   print('.', end 
-00012420: 3d20 2727 2c20 666c 7573 6820 3d20 5472  = '', flush = Tr
-00012430: 7565 290a 2020 2020 2020 2020 0a20 2020  ue).        .   
-00012440: 2064 665f 7265 735b 2763 656c 6c5f 7479   df_res['cell_ty
-00012450: 7065 275d 203d 2079 5f70 7265 640a 2020  pe'] = y_pred.  
-00012460: 2020 7265 7475 726e 2064 665f 7265 732c    return df_res,
-00012470: 2064 665f 7363 6f72 652c 2064 665f 4753   df_score, df_GS
-00012480: 415f 7363 6f72 650a 0a0a 6465 6620 6368  A_score...def ch
-00012490: 6563 6b5f 6966 5f73 6570 6172 6162 6c65  eck_if_separable
-000124a0: 5f70 6169 7277 6973 6528 6466 5f73 636f  _pairwise(df_sco
-000124b0: 7265 2c20 795f 7472 7565 293a 0a20 2020  re, y_true):.   
-000124c0: 200a 2020 2020 6c61 6265 6c20 3d20 6c69   .    label = li
-000124d0: 7374 2864 665f 7363 6f72 652e 636f 6c75  st(df_score.colu
-000124e0: 6d6e 732e 7661 6c75 6573 2920 2020 2020  mns.values)     
-000124f0: 2020 200a 2020 2020 6175 6373 203d 2070     .    aucs = p
-00012500: 642e 4461 7461 4672 616d 6528 206e 702e  d.DataFrame( np.
-00012510: 6f6e 6573 285b 6c65 6e28 6c61 6265 6c29  ones([len(label)
-00012520: 2c6c 656e 286c 6162 656c 295d 292a 5345  ,len(label)])*SE
-00012530: 5041 5241 4249 4c49 5459 5f41 5543 5f49  PARABILITY_AUC_I
-00012540: 4e49 545f 5641 4c55 452c 200a 2020 2020  NIT_VALUE, .    
-00012550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012560: 2020 2020 2069 6e64 6578 203d 206c 6162       index = lab
-00012570: 656c 2c20 636f 6c75 6d6e 7320 3d20 6c61  el, columns = la
-00012580: 6265 6c20 290a 2020 2020 0a20 2020 2066  bel ).    .    f
-00012590: 6f72 206b 2c20 6c72 2069 6e20 656e 756d  or k, lr in enum
-000125a0: 6572 6174 6528 6c61 6265 6c29 3a0a 2020  erate(label):.  
-000125b0: 2020 2020 2020 666f 7220 6d2c 206c 6320        for m, lc 
-000125c0: 696e 2065 6e75 6d65 7261 7465 286c 6162  in enumerate(lab
-000125d0: 656c 293a 0a20 2020 2020 2020 2020 2020  el):.           
-000125e0: 2069 6620 6c72 2021 3d20 6c63 3a0a 2020   if lr != lc:.  
-000125f0: 2020 2020 2020 2020 2020 2020 2020 6272                br
-00012600: 203d 2079 5f74 7275 6520 3d3d 206c 720a   = y_true == lr.
-00012610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012620: 6263 203d 2079 5f74 7275 6520 3d3d 206c  bc = y_true == l
-00012630: 630a 2020 2020 2020 2020 2020 2020 2020  c.              
-00012640: 2020 6966 2028 6e70 2e73 756d 2862 7229    if (np.sum(br)
-00012650: 203c 2053 4550 4152 4142 494c 4954 595f   < SEPARABILITY_
-00012660: 4d49 4e5f 4e55 4d5f 4345 4c4c 5329 207c  MIN_NUM_CELLS) |
-00012670: 2028 6e70 2e73 756d 2862 6329 203c 2053   (np.sum(bc) < S
-00012680: 4550 4152 4142 494c 4954 595f 4d49 4e5f  EPARABILITY_MIN_
-00012690: 4e55 4d5f 4345 4c4c 5329 3a0a 2020 2020  NUM_CELLS):.    
-000126a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000126b0: 6175 6373 2e6c 6f63 5b6c 722c 6c63 5d20  aucs.loc[lr,lc] 
-000126c0: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-000126d0: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-000126e0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-000126f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00012700: 2020 2020 2020 2062 7320 3d20 6272 207c         bs = br |
-00012710: 2062 630a 2020 2020 2020 2020 2020 2020   bc.            
-00012720: 2020 2020 2020 2020 795f 636f 6e66 5f31          y_conf_1
-00012730: 203d 2064 665f 7363 6f72 652e 6c6f 635b   = df_score.loc[
-00012740: 6273 2c20 6c72 5d0a 2020 2020 2020 2020  bs, lr].        
-00012750: 2020 2020 2020 2020 2020 2020 795f 636f              y_co
-00012760: 6e66 5f30 203d 2064 665f 7363 6f72 652e  nf_0 = df_score.
-00012770: 6c6f 635b 6273 2c20 6c63 5d0a 2020 2020  loc[bs, lc].    
-00012780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012790: 795f 6f64 6420 3d20 795f 636f 6e66 5f31  y_odd = y_conf_1
-000127a0: 202d 2079 5f63 6f6e 665f 300a 2020 2020   - y_conf_0.    
-000127b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000127c0: 7920 3d20 795f 7472 7565 5b62 735d 0a0a  y = y_true[bs]..
-000127d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000127e0: 2020 2020 626e 203d 2028 7e6e 702e 6973      bn = (~np.is
-000127f0: 6e61 6e28 795f 6f64 6429 290a 2020 2020  nan(y_odd)).    
-00012800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012810: 795f 6f64 6420 3d20 795f 6f64 645b 626e  y_odd = y_odd[bn
-00012820: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00012830: 2020 2020 2020 7920 3d20 795b 626e 5d0a        y = y[bn].
-00012840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012850: 2020 2020 2074 6172 6765 7420 3d20 6c72       target = lr
-00012860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012870: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00012880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012890: 2020 6670 722c 2074 7072 2c20 5f20 3d20    fpr, tpr, _ = 
-000128a0: 726f 635f 6375 7276 6528 792e 7261 7665  roc_curve(y.rave
-000128b0: 6c28 292c 2079 5f6f 6464 2e72 6176 656c  l(), y_odd.ravel
-000128c0: 2829 2c20 706f 735f 6c61 6265 6c20 3d20  (), pos_label = 
-000128d0: 7461 7267 6574 290a 2020 2020 2020 2020  target).        
-000128e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000128f0: 726f 635f 6175 6320 3d20 6175 6328 6670  roc_auc = auc(fp
-00012900: 722c 2074 7072 290a 2020 2020 2020 2020  r, tpr).        
-00012910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012920: 6175 6373 2e6c 6f63 5b6c 722c 6c63 5d20  aucs.loc[lr,lc] 
-00012930: 3d20 726f 635f 6175 630a 2020 2020 2020  = roc_auc.      
-00012940: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-00012950: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
-00012960: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00012970: 696e 7428 2757 4152 4e49 4e47 3a20 6361  int('WARNING: ca
-00012980: 6e6e 6f74 2064 6574 6572 6d69 6e65 2074  nnot determine t
-00012990: 6865 2073 6570 6172 6162 696c 6974 7920  he separability 
-000129a0: 666f 7220 2573 2720 2520 7461 7267 6574  for %s' % target
-000129b0: 2920 2020 2020 2020 200a 2020 2020 7265  )        .    re
-000129c0: 7475 726e 2061 7563 730a 0a64 6566 2073  turn aucs..def s
-000129d0: 6570 6172 6162 696c 6974 795f 6368 6563  eparability_chec
-000129e0: 6b5f 7061 6972 7769 7365 2864 665f 7363  k_pairwise(df_sc
-000129f0: 6f72 652c 2079 732c 206d 6b72 5f6c 7374  ore, ys, mkr_lst
-00012a00: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+00011770: 2020 2020 2020 2020 2076 6572 626f 7365           verbose
+00011780: 203d 2070 7269 6e74 5f72 6570 6f72 7420   = print_report 
+00011790: 290a 2020 2020 656c 6966 206d 6574 686f  ).    elif metho
+000117a0: 6420 3d3d 2027 676d 6d27 3a0a 2020 2020  d == 'gmm':.    
+000117b0: 2020 2020 795f 7072 6564 2c20 6466 5f73      y_pred, df_s
+000117c0: 636f 7265 203d 2043 5f6d 616a 6f72 5f67  core = C_major_g
+000117d0: 6d6d 2858 5f70 6361 2c20 7973 2c20 636c  mm(X_pca, ys, cl
+000117e0: 6173 735f 6e61 6d65 732c 200a 2020 2020  ass_names, .    
+000117f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011800: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00011810: 6574 686f 6420 3d20 6d65 7468 6f64 2c20  ethod = method, 
+00011820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011840: 2020 2020 4e5f 636f 6d70 6f6e 656e 7473      N_components
+00011850: 203d 204e 5f63 6f6d 706f 6e65 6e74 732c   = N_components,
+00011860: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+00011870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011880: 2020 2020 2076 6572 626f 7365 203d 2070       verbose = p
+00011890: 7269 6e74 5f72 6570 6f72 7420 290a 2020  rint_report ).  
+000118a0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+000118b0: 2020 2023 2320 7265 6a65 6374 2069 6620     ## reject if 
+000118c0: 474d 4d20 7363 6f72 6520 3e20 300a 2020  GMM score > 0.  
+000118d0: 2020 2020 2020 2320 4d69 6e56 203d 2064        # MinV = d
+000118e0: 665f 7363 6f72 652e 6d69 6e28 292e 6d69  f_score.min().mi
+000118f0: 6e28 290a 2020 2020 2020 2020 6966 2064  n().        if d
+00011900: 665f 7363 6f72 652e 7368 6170 655b 315d  f_score.shape[1]
+00011910: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
+00011920: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+00011930: 2864 665f 7363 6f72 652e 7368 6170 655b  (df_score.shape[
+00011940: 305d 293a 0a20 2020 2020 2020 2020 2020  0]):.           
+00011950: 2020 2020 2073 636f 7265 203d 2064 665f       score = df_
+00011960: 7363 6f72 652e 696c 6f63 5b69 5d2e 636f  score.iloc[i].co
+00011970: 7079 2864 6565 7020 3d20 5472 7565 290a  py(deep = True).
+00011980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011990: 6220 3d20 7363 6f72 6520 3e20 300a 2020  b = score > 0.  
+000119a0: 2020 2020 2020 2020 2020 2020 2020 7363                sc
+000119b0: 6f72 655b 625d 203d 2030 2023 204d 696e  ore[b] = 0 # Min
+000119c0: 560a 2020 2020 2020 2020 2020 2020 2020  V.              
+000119d0: 2020 6466 5f73 636f 7265 2e69 6c6f 635b    df_score.iloc[
+000119e0: 695d 203d 206c 6973 7428 7363 6f72 6529  i] = list(score)
+000119f0: 0a20 2020 2065 6c73 653a 200a 2020 2020  .    else: .    
+00011a00: 2020 2020 795f 7072 6564 203d 2079 730a      y_pred = ys.
+00011a10: 2020 2020 2020 2020 6466 5f73 636f 7265          df_score
+00011a20: 203d 204e 6f6e 650a 0a20 2020 2069 6620   = None..    if 
+00011a30: 7063 745f 6375 746f 6666 3a20 2323 2069  pct_cutoff: ## i
+00011a40: 2e65 2e20 666f 7220 6d61 6a6f 7220 7479  .e. for major ty
+00011a50: 7065 2020 2020 2020 2020 0a20 2020 2020  pe        .     
+00011a60: 2020 2066 6f72 2063 6c73 7420 696e 2063     for clst in c
+00011a70: 6c73 745f 746f 5f65 7863 6c75 6465 3a0a  lst_to_exclude:.
+00011a80: 2020 2020 2020 2020 2020 2020 6220 3d20              b = 
+00011a90: 795f 636c 7573 7420 3d3d 2063 6c73 740a  y_clust == clst.
+00011aa0: 2020 2020 2020 2020 2020 2020 795f 7072              y_pr
+00011ab0: 6564 5b62 5d20 3d20 2775 6e61 7373 6967  ed[b] = 'unassig
+00011ac0: 6e65 6427 0a20 2020 2020 2020 2020 2020  ned'.           
+00011ad0: 200a 2020 2020 2320 6466 5f73 636f 7265   .    # df_score
+00011ae0: 203d 2064 665f 7363 6f72 6520 2b20 6466   = df_score + df
+00011af0: 5f47 5341 5f73 636f 7265 2e63 6c69 7028  _GSA_score.clip(
+00011b00: 7570 7065 7220 3d20 3529 0a20 2020 200a  upper = 5).    .
+00011b10: 2020 2020 6466 5f72 6573 5b27 6365 6c6c      df_res['cell
+00011b20: 5f74 7970 6528 7265 7633 2927 5d20 3d20  _type(rev3)'] = 
+00011b30: 795f 7072 6564 0a20 2020 2023 2070 7269  y_pred.    # pri
+00011b40: 6e74 2827 4166 7465 7220 676d 6d3a 2027  nt('After gmm: '
+00011b50: 2c20 6466 5f72 6573 5b27 6365 6c6c 5f74  , df_res['cell_t
+00011b60: 7970 6528 7265 7633 2927 5d2e 7661 6c75  ype(rev3)'].valu
+00011b70: 655f 636f 756e 7473 2829 290a 2020 2020  e_counts()).    
+00011b80: 0a20 2020 2069 6620 286d 6574 686f 6420  .    if (method 
+00011b90: 6973 206e 6f74 204e 6f6e 6529 2026 2028  is not None) & (
+00011ba0: 6466 5f73 636f 7265 2069 7320 6e6f 7420  df_score is not 
+00011bb0: 4e6f 6e65 293a 200a 2020 2020 2020 2020  None): .        
+00011bc0: 6966 2028 7468 7265 7368 6f6c 6469 6e67  if (thresholding
+00011bd0: 293a 200a 2020 2020 2020 2020 2020 2020  ): .            
+00011be0: 6966 2028 6466 5f73 636f 7265 2e73 6861  if (df_score.sha
+00011bf0: 7065 5b31 5d20 3c3d 2031 293a 0a20 2020  pe[1] <= 1):.   
+00011c00: 2020 2020 2020 2020 2020 2020 2079 5f70               y_p
+00011c10: 7265 6420 3d20 7973 0a20 2020 2020 2020  red = ys.       
+00011c20: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00011c30: 2020 2020 2020 2020 2020 2064 665f 7375             df_su
+00011c40: 6d6d 6172 7920 3d20 6765 745f 7374 6174  mmary = get_stat
+00011c50: 2864 665f 7363 6f72 6529 2020 2020 2020  (df_score)      
+00011c60: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+00011c70: 2020 2020 2020 2020 2020 2074 685f 6469             th_di
+00011c80: 6374 2c20 6469 6666 5f64 6963 7420 3d20  ct, diff_dict = 
+00011c90: 6765 745f 7468 7265 7368 6f6c 645f 6672  get_threshold_fr
+00011ca0: 6f6d 5f47 4d4d 5f72 6573 756c 7428 6466  om_GMM_result(df
+00011cb0: 5f73 756d 6d61 7279 2c20 0a20 2020 2020  _summary, .     
+00011cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ce0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00011cf0: 6172 6765 745f 4650 5220 3d20 5461 7267  arget_FPR = Targ
+00011d00: 6574 5f46 5052 2c20 0a20 2020 2020 2020  et_FPR, .       
+00011d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d30: 2020 2020 2020 2020 2020 2020 2076 6572               ver
+00011d40: 626f 7365 203d 2070 7269 6e74 5f72 6570  bose = print_rep
+00011d50: 6f72 742c 200a 2020 2020 2020 2020 2020  ort, .          
+00011d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d80: 2020 2020 2020 2020 2020 706c 6f74 5f68            plot_h
+00011d90: 6973 7420 3d20 4661 6c73 6520 2920 2320  ist = False ) # 
+00011da0: 7072 696e 745f 7265 706f 7274 2920 0a0a  print_report) ..
+00011db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011dc0: 6c61 6265 6c5f 6c73 7420 3d20 6c69 7374  label_lst = list
+00011dd0: 2879 5f70 7265 642e 756e 6971 7565 2829  (y_pred.unique()
+00011de0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00011df0: 2020 666f 7220 6c61 6265 6c20 696e 206c    for label in l
+00011e00: 6162 656c 5f6c 7374 3a0a 2020 2020 2020  abel_lst:.      
+00011e10: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00011e20: 2028 6c61 6265 6c20 213d 2027 756e 6173   (label != 'unas
+00011e30: 7369 676e 6564 2729 2026 2028 6c61 6265  signed') & (labe
+00011e40: 6c20 696e 2074 685f 6469 6374 2e6b 6579  l in th_dict.key
+00011e50: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
+00011e60: 2020 2020 2020 2020 2020 2020 2020 6231                b1
+00011e70: 203d 2079 5f70 7265 6420 3d3d 206c 6162   = y_pred == lab
+00011e80: 656c 0a20 2020 2020 2020 2020 2020 2020  el.             
+00011e90: 2020 2020 2020 2020 2020 2062 3220 3d20             b2 = 
+00011ea0: 6466 5f73 756d 6d61 7279 5b27 5363 6f72  df_summary['Scor
+00011eb0: 6527 5d20 3c20 2074 685f 6469 6374 5b6c  e'] <  th_dict[l
+00011ec0: 6162 656c 5d0a 2020 2020 2020 2020 2020  abel].          
+00011ed0: 2020 2020 2020 2020 2020 2020 2020 6233                b3
+00011ee0: 203d 2064 665f 7265 735b 272d 6c6f 6750   = df_res['-logP
+00011ef0: 2d6c 6f67 5028 326e 6429 275d 203c 206d  -logP(2nd)'] < m
+00011f00: 696e 5f6c 6f67 505f 6469 6666 0a20 2020  in_logP_diff.   
+00011f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f20: 2020 2020 2079 5f70 7265 645b 6231 2662       y_pred[b1&b
+00011f30: 3226 6233 5d20 3d20 2775 6e61 7373 6967  2&b3] = 'unassig
+00011f40: 6e65 6427 0a0a 2020 2020 2020 2020 2020  ned'..          
+00011f50: 2020 2020 2020 6278 203d 2079 7320 3d3d        bx = ys ==
+00011f60: 2027 756e 6173 7369 676e 6564 2720 2323   'unassigned' ##
+00011f70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011f80: 2062 7820 3d20 795f 7072 6564 203d 3d20   bx = y_pred == 
+00011f90: 2775 6e61 7373 6967 6e65 6427 2023 206e  'unassigned' # n
+00011fa0: 6f74 2077 6f72 6b69 6e67 0a20 2020 2020  ot working.     
+00011fb0: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
+00011fc0: 6c73 7420 696e 2063 6c75 7374 6572 5f6c  lst in cluster_l
+00011fd0: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
+00011fe0: 2020 2020 2020 2020 6220 3d20 795f 636c          b = y_cl
+00011ff0: 7573 7420 3d3d 2063 6c73 740a 2020 2020  ust == clst.    
+00012000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012010: 2323 2049 6620 7468 6520 6d61 6a6f 7269  ## If the majori
+00012020: 7479 206f 6620 6120 636c 7573 7465 7220  ty of a cluster 
+00012030: 6973 2075 6e61 7373 6967 6e65 642c 0a20  is unassigned,. 
+00012040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012050: 2020 2023 2320 7365 7420 616c 6c20 7468     ## set all th
+00012060: 6520 6365 6c6c 7320 696e 2074 6865 2063  e cells in the c
+00012070: 6c75 7374 6572 2075 6e61 7373 6967 6e65  luster unassigne
+00012080: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00012090: 2020 2020 2020 2320 6966 2046 616c 7365        # if False
+000120a0: 3a20 2320 6e70 2e73 756d 2862 2662 7829  : # np.sum(b&bx)
+000120b0: 203e 206e 702e 7375 6d28 6229 2a70 6d61   > np.sum(b)*pma
+000120c0: 6a3a 0a20 2020 2020 2020 2020 2020 2020  j:.             
+000120d0: 2020 2020 2020 2023 2020 2020 2079 5f70         #     y_p
+000120e0: 7265 645b 625d 203d 2027 756e 6173 7369  red[b] = 'unassi
+000120f0: 676e 6564 270a 2020 2020 2020 2020 2020  gned'.          
+00012100: 2020 2020 2020 2020 2020 6966 206e 702e            if np.
+00012110: 7375 6d28 6226 287e 6278 2929 203e 2030  sum(b&(~bx)) > 0
+00012120: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012130: 2020 2020 2020 2020 2020 636e 745f 7462            cnt_tb
+00012140: 6c20 3d20 795f 7072 6564 5b62 2628 7e62  l = y_pred[b&(~b
+00012150: 7829 5d2e 7661 6c75 655f 636f 756e 7473  x)].value_counts
+00012160: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00012170: 2020 2020 2020 2020 2020 2023 2069 6478             # idx
+00012180: 203d 2063 6e74 5f74 626c 2e69 6e64 6578   = cnt_tbl.index
+00012190: 2e76 616c 7565 730a 2020 2020 2020 2020  .values.        
+000121a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000121b0: 6d61 6a6f 7269 7479 203d 2063 6e74 5f74  majority = cnt_t
+000121c0: 626c 2e69 6e64 6578 2e76 616c 7565 735b  bl.index.values[
+000121d0: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
+000121e0: 2020 2020 2020 2020 2020 2069 6620 636e             if cn
+000121f0: 745f 7462 6c5b 6d61 6a6f 7269 7479 5d20  t_tbl[majority] 
+00012200: 3e3d 2063 6e74 5f74 626c 2e73 756d 2829  >= cnt_tbl.sum()
+00012210: 2a70 6d61 6a3a 0a20 2020 2020 2020 2020  *pmaj:.         
+00012220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012230: 2020 2079 5f70 7265 645b 625d 203d 206d     y_pred[b] = m
+00012240: 616a 6f72 6974 790a 2020 2020 2020 2020  ajority.        
+00012250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012260: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00012270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012280: 2020 7061 7373 0a20 2020 2020 2020 2020    pass.         
+00012290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000122a0: 2020 200a 2020 2020 2320 7072 696e 7428     .    # print(
+000122b0: 2741 6674 6572 2067 6d6d 2074 683a 2027  'After gmm th: '
+000122c0: 2c20 795f 7072 6564 2e76 616c 7565 5f63  , y_pred.value_c
+000122d0: 6f75 6e74 7328 2929 0a20 2020 200a 2020  ounts()).    .  
+000122e0: 2020 6466 5f72 6573 5b27 6365 6c6c 5f74    df_res['cell_t
+000122f0: 7970 6528 7265 7634 2927 5d20 3d20 795f  ype(rev4)'] = y_
+00012300: 7072 6564 0a20 2020 2062 7820 3d20 795f  pred.    bx = y_
+00012310: 7072 6564 203d 3d20 2775 6e61 7373 6967  pred == 'unassig
+00012320: 6e65 6427 0a20 2020 200a 2020 2020 6966  ned'.    .    if
+00012330: 2053 4b4e 4554 574f 524b 3a0a 2020 2020   SKNETWORK:.    
+00012340: 2020 2020 6966 2070 6374 5f63 7574 6f66      if pct_cutof
+00012350: 6620 2620 2869 7369 6e73 7461 6e63 6528  f & (isinstance(
+00012360: 636f 626a 2c20 4c6f 7576 6169 6e29 2920  cobj, Louvain)) 
+00012370: 2620 2863 6263 5f63 7574 6f66 6620 3e20  & (cbc_cutoff > 
+00012380: 3029 3a20 2320 6170 706c 7920 6f6e 6c79  0): # apply only
+00012390: 2066 6f72 206d 616a 6f72 2074 7970 650a   for major type.
+000123a0: 2020 2020 2020 2020 2020 2020 795f 7072              y_pr
+000123b0: 6564 203d 2063 6c75 7374 6572 5f62 6173  ed = cluster_bas
+000123c0: 6973 5f63 6f72 7265 6374 696f 6e28 585f  is_correction(X_
+000123d0: 7063 612c 2079 5f70 7265 642c 200a 2020  pca, y_pred, .  
+000123e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000123f0: 2020 2020 2020 2020 2063 6f62 6a2c 2079           cobj, y
+00012400: 5f63 6c75 7374 2c20 706d 616a 203d 2070  _clust, pmaj = p
+00012410: 6d61 6a2c 200a 2020 2020 2020 2020 2020  maj, .          
+00012420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012430: 2063 7574 6f66 6620 3d20 6362 635f 6375   cutoff = cbc_cu
+00012440: 746f 6666 2c20 7665 7262 6f73 6520 3d20  toff, verbose = 
+00012450: 7072 696e 745f 7265 706f 7274 290a 2020  print_report).  
+00012460: 2020 2020 2020 0a20 2020 2069 6620 7072        .    if pr
+00012470: 696e 745f 7265 706f 7274 3a0a 2020 2020  int_report:.    
+00012480: 2020 2020 625f 6375 7220 3d20 795f 7072      b_cur = y_pr
+00012490: 6564 203d 3d20 2775 6e61 7373 6967 6e65  ed == 'unassigne
+000124a0: 6427 0a20 2020 2020 2020 2070 7269 6e74  d'.        print
+000124b0: 2827 4e75 6d20 6f66 2075 6e61 7373 6967  ('Num of unassig
+000124c0: 6e65 6420 6365 6c6c 733a 2025 6920 616d  ned cells: %i am
+000124d0: 6f6e 6720 2569 2720 2520 286e 702e 7375  ong %i' % (np.su
+000124e0: 6d28 625f 6375 7229 2c20 6c65 6e28 625f  m(b_cur), len(b_
+000124f0: 6375 7229 2929 0a20 2020 2065 6c73 653a  cur))).    else:
+00012500: 0a20 2020 2020 2020 2069 6620 7063 745f  .        if pct_
+00012510: 6375 746f 6666 3a20 7072 696e 7428 272e  cutoff: print('.
+00012520: 272c 2065 6e64 203d 2027 272c 2066 6c75  ', end = '', flu
+00012530: 7368 203d 2054 7275 6529 0a20 2020 2020  sh = True).     
+00012540: 2020 200a 2020 2020 6466 5f72 6573 5b27     .    df_res['
+00012550: 6365 6c6c 5f74 7970 6527 5d20 3d20 795f  cell_type'] = y_
+00012560: 7072 6564 0a20 2020 2072 6574 7572 6e20  pred.    return 
+00012570: 6466 5f72 6573 2c20 6466 5f73 636f 7265  df_res, df_score
+00012580: 2c20 6466 5f47 5341 5f73 636f 7265 0a0a  , df_GSA_score..
+00012590: 0a64 6566 2063 6865 636b 5f69 665f 7365  .def check_if_se
+000125a0: 7061 7261 626c 655f 7061 6972 7769 7365  parable_pairwise
+000125b0: 2864 665f 7363 6f72 652c 2079 5f74 7275  (df_score, y_tru
+000125c0: 6529 3a0a 2020 2020 0a20 2020 206c 6162  e):.    .    lab
+000125d0: 656c 203d 206c 6973 7428 6466 5f73 636f  el = list(df_sco
+000125e0: 7265 2e63 6f6c 756d 6e73 2e76 616c 7565  re.columns.value
+000125f0: 7329 2020 2020 2020 2020 0a20 2020 2061  s)        .    a
+00012600: 7563 7320 3d20 7064 2e44 6174 6146 7261  ucs = pd.DataFra
+00012610: 6d65 2820 6e70 2e6f 6e65 7328 5b6c 656e  me( np.ones([len
+00012620: 286c 6162 656c 292c 6c65 6e28 6c61 6265  (label),len(labe
+00012630: 6c29 5d29 2a53 4550 4152 4142 494c 4954  l)])*SEPARABILIT
+00012640: 595f 4155 435f 494e 4954 5f56 414c 5545  Y_AUC_INIT_VALUE
+00012650: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+00012660: 2020 2020 2020 2020 2020 2020 696e 6465              inde
+00012670: 7820 3d20 6c61 6265 6c2c 2063 6f6c 756d  x = label, colum
+00012680: 6e73 203d 206c 6162 656c 2029 0a20 2020  ns = label ).   
+00012690: 200a 2020 2020 666f 7220 6b2c 206c 7220   .    for k, lr 
+000126a0: 696e 2065 6e75 6d65 7261 7465 286c 6162  in enumerate(lab
+000126b0: 656c 293a 0a20 2020 2020 2020 2066 6f72  el):.        for
+000126c0: 206d 2c20 6c63 2069 6e20 656e 756d 6572   m, lc in enumer
+000126d0: 6174 6528 6c61 6265 6c29 3a0a 2020 2020  ate(label):.    
+000126e0: 2020 2020 2020 2020 6966 206c 7220 213d          if lr !=
+000126f0: 206c 633a 0a20 2020 2020 2020 2020 2020   lc:.           
+00012700: 2020 2020 2062 7220 3d20 795f 7472 7565       br = y_true
+00012710: 203d 3d20 6c72 0a20 2020 2020 2020 2020   == lr.         
+00012720: 2020 2020 2020 2062 6320 3d20 795f 7472         bc = y_tr
+00012730: 7565 203d 3d20 6c63 0a20 2020 2020 2020  ue == lc.       
+00012740: 2020 2020 2020 2020 2069 6620 286e 702e           if (np.
+00012750: 7375 6d28 6272 2920 3c20 5345 5041 5241  sum(br) < SEPARA
+00012760: 4249 4c49 5459 5f4d 494e 5f4e 554d 5f43  BILITY_MIN_NUM_C
+00012770: 454c 4c53 2920 7c20 286e 702e 7375 6d28  ELLS) | (np.sum(
+00012780: 6263 2920 3c20 5345 5041 5241 4249 4c49  bc) < SEPARABILI
+00012790: 5459 5f4d 494e 5f4e 554d 5f43 454c 4c53  TY_MIN_NUM_CELLS
+000127a0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000127b0: 2020 2020 2020 2061 7563 732e 6c6f 635b         aucs.loc[
+000127c0: 6c72 2c6c 635d 203d 2031 0a20 2020 2020  lr,lc] = 1.     
+000127d0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000127e0: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
+000127f0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00012800: 2020 2020 2020 2020 2020 2020 2020 6273                bs
+00012810: 203d 2062 7220 7c20 6263 0a20 2020 2020   = br | bc.     
+00012820: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+00012830: 5f63 6f6e 665f 3120 3d20 6466 5f73 636f  _conf_1 = df_sco
+00012840: 7265 2e6c 6f63 5b62 732c 206c 725d 0a20  re.loc[bs, lr]. 
+00012850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012860: 2020 2079 5f63 6f6e 665f 3020 3d20 6466     y_conf_0 = df
+00012870: 5f73 636f 7265 2e6c 6f63 5b62 732c 206c  _score.loc[bs, l
+00012880: 635d 0a20 2020 2020 2020 2020 2020 2020  c].             
+00012890: 2020 2020 2020 2079 5f6f 6464 203d 2079         y_odd = y
+000128a0: 5f63 6f6e 665f 3120 2d20 795f 636f 6e66  _conf_1 - y_conf
+000128b0: 5f30 0a20 2020 2020 2020 2020 2020 2020  _0.             
+000128c0: 2020 2020 2020 2079 203d 2079 5f74 7275         y = y_tru
+000128d0: 655b 6273 5d0a 0a20 2020 2020 2020 2020  e[bs]..         
+000128e0: 2020 2020 2020 2020 2020 2062 6e20 3d20             bn = 
+000128f0: 287e 6e70 2e69 736e 616e 2879 5f6f 6464  (~np.isnan(y_odd
+00012900: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00012910: 2020 2020 2020 2079 5f6f 6464 203d 2079         y_odd = y
+00012920: 5f6f 6464 5b62 6e5d 0a20 2020 2020 2020  _odd[bn].       
+00012930: 2020 2020 2020 2020 2020 2020 2079 203d               y =
+00012940: 2079 5b62 6e5d 0a0a 2020 2020 2020 2020   y[bn]..        
+00012950: 2020 2020 2020 2020 2020 2020 7461 7267              targ
+00012960: 6574 203d 206c 720a 2020 2020 2020 2020  et = lr.        
+00012970: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00012980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012990: 2020 2020 2020 2020 2066 7072 2c20 7470           fpr, tp
+000129a0: 722c 205f 203d 2072 6f63 5f63 7572 7665  r, _ = roc_curve
+000129b0: 2879 2e72 6176 656c 2829 2c20 795f 6f64  (y.ravel(), y_od
+000129c0: 642e 7261 7665 6c28 292c 2070 6f73 5f6c  d.ravel(), pos_l
+000129d0: 6162 656c 203d 2074 6172 6765 7429 0a20  abel = target). 
+000129e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000129f0: 2020 2020 2020 2072 6f63 5f61 7563 203d         roc_auc =
+00012a00: 2061 7563 2866 7072 2c20 7470 7229 0a20   auc(fpr, tpr). 
 00012a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012a20: 2020 2064 6963 745f 6365 6c6c 7479 7065     dict_celltype
-00012a30: 5f63 6f6d 622c 2076 6572 626f 7365 203d  _comb, verbose =
-00012a40: 2046 616c 7365 293a 0a20 2020 200a 2020   False):.    .  
-00012a50: 2020 6175 6373 203d 2063 6865 636b 5f69    aucs = check_i
-00012a60: 665f 7365 7061 7261 626c 655f 7061 6972  f_separable_pair
-00012a70: 7769 7365 2864 665f 7363 6f72 652c 2079  wise(df_score, y
-00012a80: 7329 0a20 2020 2069 6478 635f 7665 6320  s).    idxc_vec 
-00012a90: 3d20 6175 6373 2e69 6478 6d69 6e28 6178  = aucs.idxmin(ax
-00012aa0: 6973 203d 2031 290a 2020 2020 6d69 6e61  is = 1).    mina
-00012ab0: 5f76 6563 203d 2061 7563 732e 6d69 6e28  _vec = aucs.min(
-00012ac0: 6178 6973 203d 2031 290a 2020 2020 6964  axis = 1).    id
-00012ad0: 7872 203d 206d 696e 615f 7665 632e 6964  xr = mina_vec.id
-00012ae0: 786d 696e 2829 0a20 2020 2069 6478 6320  xmin().    idxc 
-00012af0: 3d20 6964 7863 5f76 6563 5b69 6478 725d  = idxc_vec[idxr]
-00012b00: 0a20 2020 200a 2020 2020 6d69 6e5f 6175  .    .    min_au
-00012b10: 6320 3d20 6175 6373 2e6c 6f63 5b69 6478  c = aucs.loc[idx
-00012b20: 722c 2069 6478 635d 0a20 2020 2062 5f6f  r, idxc].    b_o
-00012b30: 6b20 3d20 5472 7565 0a20 2020 2069 6620  k = True.    if 
-00012b40: 6d69 6e5f 6175 6320 3c20 5345 5041 5241  min_auc < SEPARA
-00012b50: 4249 4c49 5459 5f54 4852 4553 484f 4c44  BILITY_THRESHOLD
-00012b60: 3a0a 2020 2020 2020 2020 625f 6f6b 203d  :.        b_ok =
-00012b70: 2046 616c 7365 0a20 2020 200a 2020 2020   False.    .    
-00012b80: 6966 2062 5f6f 6b3a 0a20 2020 2020 2020  if b_ok:.       
-00012b90: 2069 6620 7665 7262 6f73 653a 200a 2020   if verbose: .  
-00012ba0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00012bb0: 2753 6570 6172 6162 696c 6974 7920 6368  'Separability ch
-00012bc0: 6563 6b20 7061 7373 6564 3a20 4d69 6e2e  eck passed: Min.
-00012bd0: 4155 4320 3d20 2536 2e34 6620 6274 6e20  AUC = %6.4f btn 
-00012be0: 2573 2061 6e64 2025 7327 2025 2028 6d69  %s and %s' % (mi
-00012bf0: 6e5f 6175 632c 2069 6478 722c 2069 6478  n_auc, idxr, idx
-00012c00: 6329 290a 2020 2020 656c 7365 3a0a 2020  c)).    else:.  
-00012c10: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-00012c20: 3a20 0a20 2020 2020 2020 2020 2020 2070  : .            p
-00012c30: 7269 6e74 2827 5365 7061 7261 6269 6c69  rint('Separabili
-00012c40: 7479 2063 6865 636b 2066 6169 6c65 643a  ty check failed:
-00012c50: 204d 696e 2e41 5543 203d 2025 362e 3466   Min.AUC = %6.4f
-00012c60: 2062 746e 2025 7320 616e 6420 2573 2720   btn %s and %s' 
-00012c70: 2520 286d 696e 5f61 7563 2c20 6964 7872  % (min_auc, idxr
-00012c80: 2c20 6964 7863 2929 0a20 2020 2020 2020  , idxc)).       
-00012c90: 206e 616d 6573 203d 2027 2573 2061 6e64   names = '%s and
-00012ca0: 2025 7327 2025 2028 6964 7872 2c20 6964   %s' % (idxr, id
-00012cb0: 7863 290a 2020 2020 2020 2020 6e65 775f  xc).        new_
-00012cc0: 6e61 6d65 203d 2027 2573 5f6f 725f 2573  name = '%s_or_%s
-00012cd0: 2720 2520 2869 6478 722c 2069 6478 6329  ' % (idxr, idxc)
-00012ce0: 0a20 2020 2020 2020 2067 656e 6573 203d  .        genes =
-00012cf0: 206c 6973 7428 7365 7428 6d6b 725f 6c73   list(set(mkr_ls
-00012d00: 745b 6964 7872 5d20 2b20 6d6b 725f 6c73  t[idxr] + mkr_ls
-00012d10: 745b 6964 7863 5d29 290a 2020 2020 2020  t[idxc])).      
-00012d20: 2020 746f 5f63 6f6d 625f 6e61 6d65 203d    to_comb_name =
-00012d30: 205b 6964 7872 2c20 6964 7863 5d0a 2020   [idxr, idxc].  
-00012d40: 2020 2020 2020 0a20 2020 2020 2020 2064        .        d
-00012d50: 6963 745f 6365 6c6c 7479 7065 5f63 6f6d  ict_celltype_com
-00012d60: 625b 6e65 775f 6e61 6d65 5d20 3d20 746f  b[new_name] = to
-00012d70: 5f63 6f6d 625f 6e61 6d65 0a20 2020 2020  _comb_name.     
-00012d80: 2020 206d 6b72 5f6c 7374 5b6e 6577 5f6e     mkr_lst[new_n
-00012d90: 616d 655d 203d 2067 656e 6573 0a20 2020  ame] = genes.   
-00012da0: 2020 2020 200a 2020 2020 2020 2020 6465       .        de
-00012db0: 6c20 6d6b 725f 6c73 745b 6964 7872 5d20  l mkr_lst[idxr] 
-00012dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012dd0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00012de0: 6465 6c20 6d6b 725f 6c73 745b 6964 7863  del mkr_lst[idxc
-00012df0: 5d20 2020 2020 2020 2020 2020 2020 2020  ]               
-00012e00: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-00012e10: 2020 6966 2069 6478 7220 696e 2064 6963    if idxr in dic
-00012e20: 745f 6365 6c6c 7479 7065 5f63 6f6d 622e  t_celltype_comb.
-00012e30: 6b65 7973 2829 3a0a 2020 2020 2020 2020  keys():.        
-00012e40: 2020 2020 6465 6c20 6469 6374 5f63 656c      del dict_cel
-00012e50: 6c74 7970 655f 636f 6d62 5b69 6478 725d  ltype_comb[idxr]
-00012e60: 0a20 2020 2020 2020 2069 6620 6964 7863  .        if idxc
-00012e70: 2069 6e20 6469 6374 5f63 656c 6c74 7970   in dict_celltyp
-00012e80: 655f 636f 6d62 2e6b 6579 7328 293a 0a20  e_comb.keys():. 
-00012e90: 2020 2020 2020 2020 2020 2064 656c 2064             del d
-00012ea0: 6963 745f 6365 6c6c 7479 7065 5f63 6f6d  ict_celltype_com
-00012eb0: 625b 6964 7863 5d0a 2020 2020 2020 2020  b[idxc].        
-00012ec0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00012ed0: 2069 6620 7665 7262 6f73 653a 200a 2020   if verbose: .  
-00012ee0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00012ef0: 2753 6570 6172 6162 696c 6974 7920 6368  'Separability ch
-00012f00: 6563 6b20 5741 524e 494e 473a 2025 7320  eck WARNING: %s 
-00012f10: 6172 6520 6e6f 7420 636c 6561 726c 7920  are not clearly 
-00012f20: 7365 7061 7261 626c 652e 2720 2520 6e61  separable.' % na
-00012f30: 6d65 7329 0a20 2020 2020 2020 2020 2020  mes).           
-00012f40: 2023 2070 7269 6e74 2827 2573 2061 7265   # print('%s are
-00012f50: 206e 6f74 2063 6c65 6172 6c79 2073 6570   not clearly sep
-00012f60: 6172 6162 6c65 202d 3e20 636f 6d62 696e  arable -> combin
-00012f70: 6564 2069 6e74 6f20 6f6e 6520 6d61 6a6f  ed into one majo
-00012f80: 7220 7479 7065 2e27 2025 206e 616d 6573  r type.' % names
-00012f90: 290a 2020 2020 0a20 2020 2072 6574 7572  ).    .    retur
-00012fa0: 6e20 625f 6f6b 2c20 6d6b 725f 6c73 742c  n b_ok, mkr_lst,
-00012fb0: 2064 6963 745f 6365 6c6c 7479 7065 5f63   dict_celltype_c
-00012fc0: 6f6d 620a 0a0a 6465 6620 7265 6d5f 6d69  omb...def rem_mi
-00012fd0: 6e6f 7228 206d 6b72 5f64 6963 742c 2074  nor( mkr_dict, t
-00012fe0: 6f5f 7265 6d5f 6c73 7420 293a 0a0a 2020  o_rem_lst ):..  
-00012ff0: 2020 6374 7320 3d20 6c69 7374 286d 6b72    cts = list(mkr
-00013000: 5f64 6963 742e 6b65 7973 2829 290a 2020  _dict.keys()).  
-00013010: 2020 6966 206c 656e 2874 6f5f 7265 6d5f    if len(to_rem_
-00013020: 6c73 7429 203e 2030 3a0a 2020 2020 2020  lst) > 0:.      
-00013030: 2020 666f 7220 6320 696e 2063 7473 3a0a    for c in cts:.
-00013040: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-00013050: 2069 6e20 746f 5f72 656d 5f6c 7374 3a0a   in to_rem_lst:.
-00013060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013070: 6465 6c20 6d6b 725f 6469 6374 5b63 5d0a  del mkr_dict[c].
-00013080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013090: 0a20 2020 2072 6574 7572 6e20 6d6b 725f  .    return mkr_
-000130a0: 6469 6374 0a0a 0a64 6566 2067 6574 5f6d  dict...def get_m
-000130b0: 616a 2869 7665 632c 2063 746f 2c20 705f  aj(ivec, cto, p_
-000130c0: 6365 6c6c 735f 6469 6374 2c20 705f 6d69  cells_dict, p_mi
-000130d0: 6e20 3d20 302e 3129 3a0a 0a20 2020 2069  n = 0.1):..    i
-000130e0: 7465 6d73 203d 206c 6973 7428 7365 7428  tems = list(set(
-000130f0: 6976 6563 2929 0a20 2020 2069 6620 6c65  ivec)).    if le
-00013100: 6e28 6974 656d 7329 203d 3d20 313a 0a20  n(items) == 1:. 
-00013110: 2020 2020 2020 2072 6574 7572 6e20 6374         return ct
-00013120: 6f0a 2020 2020 0a20 2020 204e 756d 203d  o.    .    Num =
-00013130: 206e 702e 7a65 726f 7328 6c65 6e28 6974   np.zeros(len(it
-00013140: 656d 7329 290a 2020 2020 5363 6f72 6520  ems)).    Score 
-00013150: 3d20 6e70 2e7a 6572 6f73 286c 656e 2869  = np.zeros(len(i
-00013160: 7465 6d73 2929 0a20 2020 2066 6f72 206b  tems)).    for k
-00013170: 2c20 6974 656d 2069 6e20 656e 756d 6572  , item in enumer
-00013180: 6174 6528 6974 656d 7329 3a0a 2020 2020  ate(items):.    
-00013190: 2020 2020 6220 3d20 6976 6563 203d 3d20      b = ivec == 
-000131a0: 6974 656d 0a20 2020 2020 2020 204e 756d  item.        Num
-000131b0: 5b6b 5d20 3d20 6e70 2e73 756d 2862 290a  [k] = np.sum(b).
-000131c0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-000131d0: 2020 2020 6966 2069 7465 6d20 696e 206c      if item in l
-000131e0: 6973 7428 705f 6365 6c6c 735f 6469 6374  ist(p_cells_dict
-000131f0: 2e6b 6579 7328 2929 3a0a 2020 2020 2020  .keys()):.      
-00013200: 2020 2020 2020 5363 6f72 655b 6b5d 203d        Score[k] =
-00013210: 206e 702e 7375 6d28 6229 2a70 5f63 656c   np.sum(b)*p_cel
-00013220: 6c73 5f64 6963 745b 6974 656d 5d0a 2020  ls_dict[item].  
-00013230: 2020 2020 2020 656c 7365 3a20 0a20 2020        else: .   
-00013240: 2020 2020 2020 2020 2053 636f 7265 5b6b           Score[k
-00013250: 5d20 3d20 300a 2020 2020 2020 2020 2327  ] = 0.        #'
-00013260: 2727 0a20 2020 206b 203d 206e 702e 6172  ''.    k = np.ar
-00013270: 676d 6178 284e 756d 290a 0a20 2020 2062  gmax(Num)..    b
-00013280: 203d 2046 616c 7365 0a20 2020 2069 6620   = False.    if 
-00013290: 6974 656d 735b 6b5d 203d 3d20 5354 525f  items[k] == STR_
-000132a0: 554e 4153 5349 474e 4544 3a0a 2020 2020  UNASSIGNED:.    
-000132b0: 2020 2020 6f64 7220 3d20 282d 4e75 6d29      odr = (-Num)
-000132c0: 2e61 7267 736f 7274 2829 2020 2020 2020  .argsort()      
-000132d0: 2020 0a20 2020 2020 2020 2069 6620 6c65    .        if le
-000132e0: 6e28 6f64 7229 203e 2031 3a0a 2020 2020  n(odr) > 1:.    
-000132f0: 2020 2020 2020 2020 6966 204e 756d 5b6f          if Num[o
-00013300: 6472 5b31 5d5d 203e 3d20 726f 756e 6428  dr[1]] >= round(
-00013310: 6e70 2e73 756d 284e 756d 292a 2870 5f6d  np.sum(Num)*(p_m
-00013320: 696e 2929 3a0a 2020 2020 2020 2020 2020  in)):.          
-00013330: 2020 2020 2020 6b20 3d20 6f64 725b 315d        k = odr[1]
-00013340: 0a20 2020 2020 2020 2020 2020 2023 2065  .            # e
-00013350: 6c69 6620 4e75 6d5b 6b5d 203c 3d20 726f  lif Num[k] <= ro
-00013360: 756e 6428 6e70 2e73 756d 284e 756d 292a  und(np.sum(Num)*
-00013370: 2831 2d70 5f6d 696e 2929 3a0a 2020 2020  (1-p_min)):.    
-00013380: 2020 2020 2020 2020 2320 2020 2020 7265          #     re
-00013390: 7475 726e 2063 746f 0a20 2020 2020 2020  turn cto.       
-000133a0: 0a20 2020 2072 6574 7572 6e20 2069 7465  .    return  ite
-000133b0: 6d73 5b6b 5d0a 0a0a 6465 6620 6170 706c  ms[k]...def appl
-000133c0: 795f 6b6e 6e28 6e65 695f 696e 6469 6365  y_knn(nei_indice
-000133d0: 732c 2063 656c 6c5f 7479 7065 2c20 7363  s, cell_type, sc
-000133e0: 6f72 652c 2070 6d61 6a20 3d20 302e 3235  ore, pmaj = 0.25
-000133f0: 2c20 6e6c 6f67 5f70 7661 6c5f 7468 203d  , nlog_pval_th =
-00013400: 2032 293a 0a0a 2020 2020 6365 6c6c 5f74   2):..    cell_t
-00013410: 7970 655f 6e65 7720 3d20 6365 6c6c 5f74  ype_new = cell_t
-00013420: 7970 652e 636f 7079 2864 6565 7020 3d20  ype.copy(deep = 
-00013430: 5472 7565 290a 2020 2020 6964 785f 6172  True).    idx_ar
-00013440: 7920 3d20 6365 6c6c 5f74 7970 652e 696e  y = cell_type.in
-00013450: 6465 782e 7661 6c75 6573 0a20 2020 204e  dex.values.    N
-00013460: 5f6e 6569 203d 206e 6569 5f69 6e64 6963  _nei = nei_indic
-00013470: 6573 2e73 6861 7065 5b31 5d0a 2020 2020  es.shape[1].    
-00013480: 7369 6478 5f61 7279 203d 2073 636f 7265  sidx_ary = score
-00013490: 2e69 6e64 6578 2e76 616c 7565 730a 2020  .index.values.  
-000134a0: 2020 7363 6f72 6532 203d 2073 636f 7265    score2 = score
-000134b0: 2e63 6f70 7928 6465 6570 203d 2054 7275  .copy(deep = Tru
-000134c0: 6529 0a20 2020 2066 6f72 206b 2069 6e20  e).    for k in 
-000134d0: 7261 6e67 6528 206c 656e 2863 656c 6c5f  range( len(cell_
-000134e0: 7479 7065 2920 293a 0a20 2020 2020 2020  type) ):.       
-000134f0: 200a 2020 2020 2020 2020 2323 2055 7064   .        ## Upd
-00013500: 6174 6520 4365 6c6c 2074 7970 6520 7573  ate Cell type us
-00013510: 696e 6720 6d61 6a6f 7269 7479 2076 6f74  ing majority vot
-00013520: 6f6e 670a 2020 2020 2020 2020 6e6c 7374  ong.        nlst
-00013530: 203d 206c 6973 7428 6e65 695f 696e 6469   = list(nei_indi
-00013540: 6365 732e 696c 6f63 5b6b 2c3a 5d2e 6173  ces.iloc[k,:].as
-00013550: 7479 7065 2869 6e74 2929 0a20 2020 2020  type(int)).     
-00013560: 2020 2069 6c73 7420 3d20 6964 785f 6172     ilst = idx_ar
-00013570: 795b 6e6c 7374 5d0a 2020 2020 2020 2020  y[nlst].        
-00013580: 6374 7320 3d20 6365 6c6c 5f74 7970 655b  cts = cell_type[
-00013590: 206c 6973 7428 696c 7374 2920 5d0a 2020   list(ilst) ].  
-000135a0: 2020 2020 2020 6966 206c 656e 2873 6574        if len(set
-000135b0: 286c 6973 7428 6374 7329 2929 203c 3d20  (list(cts))) <= 
-000135c0: 313a 0a20 2020 2020 2020 2020 2020 2070  1:.            p
-000135d0: 6173 730a 2020 2020 2020 2020 656c 7365  ass.        else
-000135e0: 3a0a 2020 2020 2020 2020 2020 2020 636e  :.            cn
-000135f0: 745f 7462 6c20 3d20 6374 732e 7661 6c75  t_tbl = cts.valu
-00013600: 655f 636f 756e 7473 2829 0a20 2020 2020  e_counts().     
-00013610: 2020 2020 2020 206d 616a 6f72 6974 7920         majority 
-00013620: 3d20 636e 745f 7462 6c2e 696e 6465 782e  = cnt_tbl.index.
-00013630: 7661 6c75 6573 5b30 5d0a 0a20 2020 2020  values[0]..     
-00013640: 2020 2020 2020 2069 6620 6d61 6a6f 7269         if majori
-00013650: 7479 203d 3d20 2775 6e61 7373 6967 6e65  ty == 'unassigne
-00013660: 6427 3a0a 2020 2020 2020 2020 2020 2020  d':.            
-00013670: 2020 2020 6d61 6a6f 7269 7479 203d 2063      majority = c
-00013680: 6e74 5f74 626c 2e69 6e64 6578 2e76 616c  nt_tbl.index.val
-00013690: 7565 735b 315d 0a20 2020 2020 2020 2020  ues[1].         
-000136a0: 2020 2020 2020 2063 656c 6c5f 7479 7065         cell_type
-000136b0: 5f6e 6577 5b69 6478 5f61 7279 5b6b 5d5d  _new[idx_ary[k]]
-000136c0: 203d 2063 6e74 5f74 626c 2e69 6e64 6578   = cnt_tbl.index
-000136d0: 2e76 616c 7565 735b 315d 0a20 2020 2020  .values[1].     
-000136e0: 2020 2020 2020 2065 6c73 653a 200a 2020         else: .  
-000136f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00013700: 2028 6365 6c6c 5f74 7970 655b 6b5d 203d   (cell_type[k] =
-00013710: 3d20 2775 6e61 7373 6967 6e65 6427 293a  = 'unassigned'):
-00013720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013730: 2020 2020 2063 656c 6c5f 7479 7065 5f6e       cell_type_n
-00013740: 6577 5b69 6478 5f61 7279 5b6b 5d5d 203d  ew[idx_ary[k]] =
-00013750: 206d 616a 6f72 6974 790a 2020 2020 2020   majority.      
-00013760: 2020 2020 2020 2020 2020 656c 6966 2028            elif (
-00013770: 7363 6f72 652e 6c6f 635b 7369 6478 5f61  score.loc[sidx_a
-00013780: 7279 5b6b 5d2c 2063 656c 6c5f 7479 7065  ry[k], cell_type
-00013790: 5b6b 5d5d 203c 206e 6c6f 675f 7076 616c  [k]] < nlog_pval
-000137a0: 5f74 6829 3a0a 2020 2020 2020 2020 2020  _th):.          
-000137b0: 2020 2020 2020 2020 2020 6365 6c6c 5f74            cell_t
-000137c0: 7970 655f 6e65 775b 6964 785f 6172 795b  ype_new[idx_ary[
-000137d0: 6b5d 5d20 3d20 6d61 6a6f 7269 7479 0a20  k]] = majority. 
-000137e0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000137f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00013800: 2020 2020 2020 2020 2069 6620 636e 745f           if cnt_
-00013810: 7462 6c5b 6d61 6a6f 7269 7479 5d20 3e20  tbl[majority] > 
-00013820: 4e5f 6e65 692a 706d 616a 3a0a 2020 2020  N_nei*pmaj:.    
-00013830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013840: 2020 2020 6365 6c6c 5f74 7970 655f 6e65      cell_type_ne
-00013850: 775b 6964 785f 6172 795b 6b5d 5d20 3d20  w[idx_ary[k]] = 
-00013860: 6d61 6a6f 7269 7479 0a20 2020 2020 2020  majority.       
-00013870: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-00013880: 2020 2323 2055 7064 6174 6520 7363 6f72    ## Update scor
-00013890: 650a 2020 2020 2020 2020 2020 2020 2727  e.            ''
-000138a0: 270a 2020 2020 2020 2020 2020 2020 736d  '.            sm
-000138b0: 203d 2073 636f 7265 2e6c 6f63 5b69 6c73   = score.loc[ils
-000138c0: 742c 3a5d 2e73 756d 2861 7869 733d 3029  t,:].sum(axis=0)
-000138d0: 0a20 2020 2020 2020 2020 2020 2073 636f  .            sco
-000138e0: 7265 322e 696c 6f63 5b6b 2c3a 5d20 3d20  re2.iloc[k,:] = 
-000138f0: 6c69 7374 2820 736d 2029 0a20 2020 2020  list( sm ).     
-00013900: 2020 2020 2020 2023 2727 270a 2020 2020         #'''.    
-00013910: 2020 2020 2020 2020 0a20 2020 2072 6574          .    ret
-00013920: 7572 6e20 6365 6c6c 5f74 7970 655f 6e65  urn cell_type_ne
-00013930: 772c 2073 636f 7265 320a 2020 2020 0a0a  w, score2.    ..
-00013940: 6465 6620 6170 706c 795f 6b6e 6e31 286e  def apply_knn1(n
-00013950: 6569 5f69 6e64 6963 6573 2c20 6365 6c6c  ei_indices, cell
-00013960: 5f74 7970 652c 2073 636f 7265 2c20 706d  _type, score, pm
-00013970: 616a 203d 2030 2e32 352c 206e 6c6f 675f  aj = 0.25, nlog_
-00013980: 7076 616c 5f74 6820 3d20 3229 3a0a 0a20  pval_th = 2):.. 
-00013990: 2020 2063 656c 6c5f 7479 7065 5f6e 6577     cell_type_new
-000139a0: 203d 2063 656c 6c5f 7479 7065 2e63 6f70   = cell_type.cop
-000139b0: 7928 6465 6570 203d 2054 7275 6529 0a20  y(deep = True). 
-000139c0: 2020 2069 6478 5f61 7279 203d 2063 656c     idx_ary = cel
-000139d0: 6c5f 7479 7065 2e69 6e64 6578 2e76 616c  l_type.index.val
-000139e0: 7565 730a 2020 2020 4e5f 6e65 6920 3d20  ues.    N_nei = 
-000139f0: 6e65 695f 696e 6469 6365 732e 7368 6170  nei_indices.shap
-00013a00: 655b 315d 0a20 2020 2073 6964 785f 6172  e[1].    sidx_ar
-00013a10: 7920 3d20 7363 6f72 652e 696e 6465 782e  y = score.index.
-00013a20: 7661 6c75 6573 0a20 2020 2073 636f 7265  values.    score
-00013a30: 3220 3d20 7363 6f72 652e 636f 7079 2864  2 = score.copy(d
-00013a40: 6565 7020 3d20 5472 7565 290a 2020 2020  eep = True).    
-00013a50: 666f 7220 6b20 696e 2072 616e 6765 2820  for k in range( 
-00013a60: 6c65 6e28 6365 6c6c 5f74 7970 6529 2029  len(cell_type) )
-00013a70: 3a0a 2020 2020 2020 2020 0a20 2020 2020  :.        .     
-00013a80: 2020 2023 2320 5570 6461 7465 2043 656c     ## Update Cel
-00013a90: 6c20 7479 7065 2075 7369 6e67 206d 616a  l type using maj
-00013aa0: 6f72 6974 7920 766f 746f 6e67 0a20 2020  ority votong.   
-00013ab0: 2020 2020 206e 6c73 7420 3d20 6c69 7374       nlst = list
-00013ac0: 286e 6569 5f69 6e64 6963 6573 2e69 6c6f  (nei_indices.ilo
-00013ad0: 635b 6b2c 3a5d 2e61 7374 7970 6528 696e  c[k,:].astype(in
-00013ae0: 7429 290a 2020 2020 2020 2020 696c 7374  t)).        ilst
-00013af0: 203d 2069 6478 5f61 7279 5b6e 6c73 745d   = idx_ary[nlst]
-00013b00: 0a20 2020 2020 2020 2063 7473 203d 2063  .        cts = c
-00013b10: 656c 6c5f 7479 7065 5b20 6c69 7374 2869  ell_type[ list(i
-00013b20: 6c73 7429 205d 0a20 2020 2020 2020 2069  lst) ].        i
-00013b30: 6620 6c65 6e28 7365 7428 6c69 7374 2863  f len(set(list(c
-00013b40: 7473 2929 2920 3c3d 2031 3a0a 2020 2020  ts))) <= 1:.    
-00013b50: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-00013b60: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00013b70: 2020 2020 2020 2063 6e74 5f74 626c 203d         cnt_tbl =
-00013b80: 2063 7473 2e76 616c 7565 5f63 6f75 6e74   cts.value_count
-00013b90: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-00013ba0: 6d61 6a6f 7269 7479 203d 2063 6e74 5f74  majority = cnt_t
-00013bb0: 626c 2e69 6e64 6578 2e76 616c 7565 735b  bl.index.values[
-00013bc0: 305d 0a0a 2020 2020 2020 2020 2020 2020  0]..            
-00013bd0: 6966 206d 616a 6f72 6974 7920 3d3d 2027  if majority == '
-00013be0: 756e 6173 7369 676e 6564 273a 0a20 2020  unassigned':.   
-00013bf0: 2020 2020 2020 2020 2020 2020 206d 616a               maj
-00013c00: 6f72 6974 7920 3d20 636e 745f 7462 6c2e  ority = cnt_tbl.
-00013c10: 696e 6465 782e 7661 6c75 6573 5b31 5d0a  index.values[1].
-00013c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c30: 6365 6c6c 5f74 7970 655f 6e65 775b 6964  cell_type_new[id
-00013c40: 785f 6172 795b 6b5d 5d20 3d20 6d61 6a6f  x_ary[k]] = majo
-00013c50: 7269 7479 0a20 2020 2020 2020 2020 2020  rity.           
-00013c60: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-00013c70: 2020 6966 2063 6e74 5f74 626c 5b6d 616a    if cnt_tbl[maj
-00013c80: 6f72 6974 795d 203e 204e 5f6e 6569 2a70  ority] > N_nei*p
-00013c90: 6d61 6a3a 0a20 2020 2020 2020 2020 2020  maj:.           
-00013ca0: 2020 2020 2063 656c 6c5f 7479 7065 5f6e       cell_type_n
-00013cb0: 6577 5b69 6478 5f61 7279 5b6b 5d5d 203d  ew[idx_ary[k]] =
-00013cc0: 206d 616a 6f72 6974 790a 2020 2020 2020   majority.      
-00013cd0: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
-00013ce0: 2020 2023 2320 5570 6461 7465 2073 636f     ## Update sco
-00013cf0: 7265 0a20 2020 2020 2020 2020 2020 2023  re.            #
-00013d00: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-00013d10: 6220 3d20 6374 7320 3d3d 206d 616a 6f72  b = cts == major
-00013d20: 6974 790a 2020 2020 2020 2020 2020 2020  ity.            
-00013d30: 736d 203d 2073 636f 7265 2e6c 6f63 5b69  sm = score.loc[i
-00013d40: 6c73 742c 3a5d 2e6d 6561 6e28 6178 6973  lst,:].mean(axis
-00013d50: 3d30 290a 2020 2020 2020 2020 2020 2020  =0).            
-00013d60: 7363 6f72 6532 2e69 6c6f 635b 6b2c 3a5d  score2.iloc[k,:]
-00013d70: 203d 206c 6973 7428 2073 6d20 290a 2020   = list( sm ).  
-00013d80: 2020 2020 2020 2020 2020 2327 2727 0a20            #'''. 
-00013d90: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-00013da0: 7265 7475 726e 2063 656c 6c5f 7479 7065  return cell_type
-00013db0: 5f6e 6577 2c20 7363 6f72 6532 0a20 2020  _new, score2.   
-00013dc0: 200a 0a64 6566 2061 7070 6c79 5f6b 6e6e   ..def apply_knn
-00013dd0: 3228 6e65 695f 696e 6469 6365 732c 2063  2(nei_indices, c
-00013de0: 656c 6c5f 7479 7065 2c20 7363 6f72 652c  ell_type, score,
-00013df0: 2070 6d61 6a20 3d20 302e 352c 206e 6c6f   pmaj = 0.5, nlo
-00013e00: 675f 7076 616c 5f74 6820 3d20 3229 3a0a  g_pval_th = 2):.
-00013e10: 0a20 2020 2063 656c 6c5f 7479 7065 5f6e  .    cell_type_n
-00013e20: 6577 203d 2063 656c 6c5f 7479 7065 2e63  ew = cell_type.c
-00013e30: 6f70 7928 6465 6570 203d 2054 7275 6529  opy(deep = True)
-00013e40: 0a20 2020 2069 6478 5f61 7279 203d 2063  .    idx_ary = c
-00013e50: 656c 6c5f 7479 7065 2e69 6e64 6578 2e76  ell_type.index.v
-00013e60: 616c 7565 730a 2020 2020 4e5f 6e65 6920  alues.    N_nei 
-00013e70: 3d20 6e65 695f 696e 6469 6365 732e 7368  = nei_indices.sh
-00013e80: 6170 655b 315d 0a20 2020 2073 636f 7265  ape[1].    score
-00013e90: 3220 3d20 7363 6f72 652e 636f 7079 2864  2 = score.copy(d
-00013ea0: 6565 7020 3d20 5472 7565 290a 2020 2020  eep = True).    
-00013eb0: 666f 7220 6b20 696e 2072 616e 6765 2820  for k in range( 
-00013ec0: 6c65 6e28 6365 6c6c 5f74 7970 6529 2029  len(cell_type) )
-00013ed0: 3a0a 2020 2020 2020 2020 6e6c 7374 203d  :.        nlst =
-00013ee0: 206c 6973 7428 6e65 695f 696e 6469 6365   list(nei_indice
-00013ef0: 732e 696c 6f63 5b6b 2c3a 5d2e 6173 7479  s.iloc[k,:].asty
-00013f00: 7065 2869 6e74 2929 0a20 2020 2020 2020  pe(int)).       
-00013f10: 2069 6c73 7420 3d20 6c69 7374 2869 6478   ilst = list(idx
-00013f20: 5f61 7279 5b6e 6c73 745d 290a 2020 2020  _ary[nlst]).    
-00013f30: 2020 2020 736d 203d 2073 636f 7265 2e6c      sm = score.l
-00013f40: 6f63 5b69 6c73 742c 3a5d 2e6d 6561 6e28  oc[ilst,:].mean(
-00013f50: 6178 6973 3d30 290a 2020 2020 2020 2020  axis=0).        
-00013f60: 7363 6f72 6532 2e69 6c6f 635b 6b2c 3a5d  score2.iloc[k,:]
-00013f70: 203d 206c 6973 7428 2073 6d20 290a 2020   = list( sm ).  
-00013f80: 2020 2020 2020 0a20 2020 2023 2320 5570        .    ## Up
-00013f90: 6461 7465 2043 656c 6c20 7479 7065 2075  date Cell type u
-00013fa0: 7369 6e67 2075 7064 6174 6564 2073 636f  sing updated sco
-00013fb0: 7265 0a20 2020 2063 656c 6c5f 7479 7065  re.    cell_type
-00013fc0: 5f6e 6577 203d 2073 636f 7265 322e 6964  _new = score2.id
-00013fd0: 786d 6178 2861 7869 7320 3d20 3129 0a20  xmax(axis = 1). 
-00013fe0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-00013ff0: 7265 7475 726e 2063 656c 6c5f 7479 7065  return cell_type
-00014000: 5f6e 6577 2c20 7363 6f72 6532 0a20 2020  _new, score2.   
-00014010: 200a 0a64 6566 2067 6574 5f73 7461 745f   ..def get_stat_
-00014020: 6773 6128 2064 665f 7363 6f72 6520 293a  gsa( df_score ):
-00014030: 0a20 2020 200a 2020 2020 6466 203d 2064  .    .    df = d
-00014040: 665f 7363 6f72 650a 2020 2020 6e61 6d65  f_score.    name
-00014050: 203d 206c 6973 7428 6466 2e63 6f6c 756d   = list(df.colum
-00014060: 6e73 2e76 616c 7565 7329 0a20 2020 200a  ns.values).    .
-00014070: 2020 2020 6966 2064 662e 7368 6170 655b      if df.shape[
-00014080: 315d 203d 3d20 313a 0a20 2020 2020 2020  1] == 1:.       
-00014090: 2063 203d 206e 616d 655b 305d 0a20 2020   c = name[0].   
-000140a0: 2020 2020 206e 6567 5f6c 6f67 5f70 7661       neg_log_pva
-000140b0: 6c20 3d20 6466 5b63 5d0a 2020 2020 2020  l = df[c].      
-000140c0: 2020 7375 6274 7970 6520 3d20 5b63 5d2a    subtype = [c]*
-000140d0: 6466 2e73 6861 7065 5b30 5d0a 2020 2020  df.shape[0].    
-000140e0: 2020 2020 0a20 2020 2020 2020 2064 665f      .        df_
-000140f0: 7265 7320 3d20 7064 2e44 6174 6146 7261  res = pd.DataFra
-00014100: 6d65 287b 2763 656c 6c5f 7479 7065 273a  me({'cell_type':
-00014110: 2073 7562 7479 7065 2c20 2763 656c 6c5f   subtype, 'cell_
-00014120: 7479 7065 2872 6576 2927 3a20 7375 6274  type(rev)': subt
-00014130: 7970 652c 200a 2020 2020 2020 2020 2020  ype, .          
-00014140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014150: 2020 2020 2027 6365 6c6c 5f74 7970 6528       'cell_type(
-00014160: 3173 7429 273a 2073 7562 7479 7065 2c20  1st)': subtype, 
-00014170: 274f 7665 726c 6170 273a 205b 272d 275d  'Overlap': ['-']
-00014180: 2a64 662e 7368 6170 655b 305d 207d 2c0a  *df.shape[0] },.
-00014190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000141a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000141b0: 6e64 6578 203d 2064 662e 696e 6465 782e  ndex = df.index.
-000141c0: 7661 6c75 6573 290a 2020 2020 2020 2020  values).        
-000141d0: 6466 5f72 6573 5b27 6365 6c6c 5f74 7970  df_res['cell_typ
-000141e0: 6528 326e 6429 275d 203d 2073 7562 7479  e(2nd)'] = subty
-000141f0: 7065 0a20 2020 2020 2020 2064 665f 7265  pe.        df_re
-00014200: 735b 274f 7665 726c 6170 2832 6e64 2927  s['Overlap(2nd)'
-00014210: 5d20 3d20 5b27 2d27 5d2a 6466 2e73 6861  ] = ['-']*df.sha
-00014220: 7065 5b30 5d0a 2020 2020 2020 2020 6466  pe[0].        df
-00014230: 5f72 6573 5b27 436c 6172 6974 7927 5d20  _res['Clarity'] 
-00014240: 3d20 5b27 2d27 5d2a 6466 2e73 6861 7065  = ['-']*df.shape
-00014250: 5b30 5d0a 2020 2020 2020 2020 6466 5f72  [0].        df_r
-00014260: 6573 5b27 2d6c 6f67 5027 5d20 3d20 6466  es['-logP'] = df
-00014270: 5b63 5d0a 2020 2020 2020 2020 6466 5f72  [c].        df_r
-00014280: 6573 5b27 2d6c 6f67 5028 326e 6429 275d  es['-logP(2nd)']
-00014290: 203d 205b 305d 2a64 662e 7368 6170 655b   = [0]*df.shape[
-000142a0: 305d 0a20 2020 2020 2020 2064 665f 7265  0].        df_re
-000142b0: 735b 272d 6c6f 6750 2d6c 6f67 5028 326e  s['-logP-logP(2n
-000142c0: 6429 275d 203d 2064 665b 635d 0a20 2020  d)'] = df[c].   
-000142d0: 2065 6c73 653a 0a20 2020 2020 2020 206d   else:.        m
-000142e0: 6178 7620 3d20 6c69 7374 2864 662e 6d61  axv = list(df.ma
-000142f0: 7828 6178 6973 203d 2031 2929 0a20 2020  x(axis = 1)).   
-00014300: 2020 2020 2073 7562 7479 7065 203d 206c       subtype = l
-00014310: 6973 7428 6466 2e69 6478 6d61 7828 6178  ist(df.idxmax(ax
-00014320: 6973 203d 2031 2929 0a20 2020 2020 2020  is = 1)).       
-00014330: 2023 7463 5f73 7562 7479 7065 203d 205b   #tc_subtype = [
-00014340: 7472 616e 735f 6469 6374 5b6b 5d20 666f  trans_dict[k] fo
-00014350: 7220 6b20 696e 2074 635f 7375 6274 7970  r k in tc_subtyp
-00014360: 655d 0a0a 2020 2020 2020 2020 6d61 7876  e]..        maxv
-00014370: 3220 3d20 5b5d 0a20 2020 2020 2020 2069  2 = [].        i
-00014380: 6478 3220 3d20 5b5d 0a20 2020 2020 2020  dx2 = [].       
-00014390: 2073 7562 7479 7065 5f6c 7374 203d 206c   subtype_lst = l
-000143a0: 6973 7428 6466 2e63 6f6c 756d 6e73 2e76  ist(df.columns.v
-000143b0: 616c 7565 7329 0a0a 2020 2020 2020 2020  alues)..        
-000143c0: 666f 7220 6920 696e 2072 616e 6765 2864  for i in range(d
-000143d0: 662e 7368 6170 655b 305d 293a 0a20 2020  f.shape[0]):.   
-000143e0: 2020 2020 2020 2020 2078 203d 206e 702e           x = np.
-000143f0: 6172 7261 7928 6466 2e69 6c6f 635b 695d  array(df.iloc[i]
-00014400: 290a 2020 2020 2020 2020 2020 2020 6f64  ).            od
-00014410: 7220 3d20 282d 7829 2e61 7267 736f 7274  r = (-x).argsort
-00014420: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
-00014430: 6620 6c65 6e28 7829 203e 2031 3a0a 2020  f len(x) > 1:.  
-00014440: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-00014450: 7876 322e 6170 7065 6e64 2878 5b6f 6472  xv2.append(x[odr
-00014460: 5b31 5d5d 290a 2020 2020 2020 2020 2020  [1]]).          
-00014470: 2020 2020 2020 6964 7832 2e61 7070 656e        idx2.appen
-00014480: 6428 7375 6274 7970 655f 6c73 745b 6f64  d(subtype_lst[od
-00014490: 725b 315d 5d29 0a20 2020 2020 2020 2020  r[1]]).         
-000144a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000144b0: 2020 2020 2020 2020 206d 6178 7632 2e61           maxv2.a
-000144c0: 7070 656e 6428 3029 0a20 2020 2020 2020  ppend(0).       
-000144d0: 2020 2020 2020 2020 2069 6478 322e 6170           idx2.ap
-000144e0: 7065 6e64 284e 6f6e 6529 0a0a 2020 2020  pend(None)..    
-000144f0: 2020 2020 6466 5f72 6573 203d 2070 642e      df_res = pd.
-00014500: 4461 7461 4672 616d 6528 7b27 6365 6c6c  DataFrame({'cell
-00014510: 5f74 7970 6527 3a20 7375 6274 7970 652c  _type': subtype,
-00014520: 2027 6365 6c6c 5f74 7970 6528 7265 7629   'cell_type(rev)
-00014530: 273a 2073 7562 7479 7065 2c20 0a20 2020  ': subtype, .   
-00014540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014550: 2020 2020 2020 2020 2020 2020 2763 656c              'cel
-00014560: 6c5f 7479 7065 2831 7374 2927 3a20 7375  l_type(1st)': su
-00014570: 6274 7970 652c 2027 4f76 6572 6c61 7027  btype, 'Overlap'
-00014580: 3a20 5b27 2d27 5d2a 6466 2e73 6861 7065  : ['-']*df.shape
-00014590: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
-000145a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000145b0: 2020 2020 2763 656c 6c5f 7479 7065 2832      'cell_type(2
-000145c0: 6e64 2927 3a20 6964 7832 2c20 274f 7665  nd)': idx2, 'Ove
-000145d0: 726c 6170 2832 6e64 2927 3a20 5b27 2d27  rlap(2nd)': ['-'
-000145e0: 5d2a 6466 2e73 6861 7065 5b30 5d2c 0a20  ]*df.shape[0],. 
-000145f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014600: 2020 2020 2020 2020 2020 2020 2020 2743                'C
-00014610: 6c61 7269 7479 273a 205b 272d 275d 2a64  larity': ['-']*d
-00014620: 662e 7368 6170 655b 305d 2c20 272d 6c6f  f.shape[0], '-lo
-00014630: 6750 273a 206d 6178 762c 2027 2d6c 6f67  gP': maxv, '-log
-00014640: 5028 326e 6429 273a 206d 6178 7632 7d2c  P(2nd)': maxv2},
-00014650: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00014660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014670: 696e 6465 7820 3d20 6466 2e69 6e64 6578  index = df.index
-00014680: 2e76 616c 7565 7329 0a20 2020 2020 2020  .values).       
-00014690: 2064 665f 7265 735b 272d 6c6f 6750 2d6c   df_res['-logP-l
-000146a0: 6f67 5028 326e 6429 275d 203d 2064 665f  ogP(2nd)'] = df_
-000146b0: 7265 735b 272d 6c6f 6750 275d 202d 2064  res['-logP'] - d
-000146c0: 665f 7265 735b 272d 6c6f 6750 2832 6e64  f_res['-logP(2nd
-000146d0: 2927 5d0a 0a20 2020 2072 6574 7572 6e20  )']..    return 
-000146e0: 6466 5f72 6573 0a0a 0a64 6566 2067 6574  df_res...def get
-000146f0: 5f6d 6172 6b65 7273 5f61 6c6c 286d 6b72  _markers_all(mkr
-00014700: 5f66 696c 652c 2074 6172 6765 745f 6c73  _file, target_ls
-00014710: 742c 2070 6e73 6831 322c 206c 6576 656c  t, pnsh12, level
-00014720: 203d 2031 2c20 636f 6d62 5f6d 6b72 7320   = 1, comb_mkrs 
-00014730: 3d20 4661 6c73 6529 3a0a 2020 2020 0a20  = False):.    . 
-00014740: 2020 2023 2074 6172 6765 7420 3d20 274d     # target = 'M
-00014750: 7965 6c6f 6964 2063 656c 6c27 0a20 2020  yeloid cell'.   
-00014760: 2069 6620 6c65 7665 6c20 3d3d 2031 3a0a   if level == 1:.
-00014770: 2020 2020 2020 2020 6d6b 725f 6469 6374          mkr_dict
-00014780: 2c20 6d6b 725f 6469 6374 5f6e 6567 203d  , mkr_dict_neg =
-00014790: 205c 0a20 2020 2020 2020 2020 2020 2067   \.            g
-000147a0: 6574 5f6d 6172 6b65 7273 5f6d 696e 6f72  et_markers_minor
-000147b0: 5f74 7970 6532 286d 6b72 5f66 696c 652c  _type2(mkr_file,
-000147c0: 2074 6172 6765 745f 6365 6c6c 7320 3d20   target_cells = 
-000147d0: 7461 7267 6574 5f6c 7374 2c20 0a20 2020  target_lst, .   
-000147e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000147f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014800: 2070 6e73 6831 3220 3d20 706e 7368 3132   pnsh12 = pnsh12
-00014810: 2c20 7265 6d5f 636f 6d6d 6f6e 203d 2046  , rem_common = F
-00014820: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
-00014830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014840: 2020 2020 2020 2020 2020 636f 6d62 5f6d            comb_m
-00014850: 6b72 7320 3d20 636f 6d62 5f6d 6b72 732c  krs = comb_mkrs,
-00014860: 2076 6572 626f 7365 203d 2046 616c 7365   verbose = False
-00014870: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
-00014880: 2020 2020 6d6b 725f 6469 6374 2c20 6d6b      mkr_dict, mk
-00014890: 725f 6469 6374 5f6e 6567 203d 205c 0a20  r_dict_neg = \. 
-000148a0: 2020 2020 2020 2020 2020 2067 6574 5f6d             get_m
-000148b0: 6172 6b65 7273 5f63 656c 6c5f 7479 7065  arkers_cell_type
-000148c0: 286d 6b72 5f66 696c 652c 2074 6172 6765  (mkr_file, targe
-000148d0: 745f 6365 6c6c 7320 3d20 7461 7267 6574  t_cells = target
-000148e0: 5f6c 7374 2c20 706e 7368 3132 203d 2070  _lst, pnsh12 = p
-000148f0: 6e73 6831 322c 0a20 2020 2020 2020 2020  nsh12,.         
-00014900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014910: 2072 656d 5f63 6f6d 6d6f 6e20 3d20 4661   rem_common = Fa
-00014920: 6c73 652c 2076 6572 626f 7365 203d 2046  lse, verbose = F
-00014930: 616c 7365 290a 2020 2020 2020 2020 0a20  alse).        . 
-00014940: 2020 206d 6b72 735f 616c 6c20 3d20 5b5d     mkrs_all = []
-00014950: 2023 5b27 5345 4c4c 275d 0a20 2020 206d   #['SELL'].    m
-00014960: 6b72 735f 636d 6e20 3d20 5b5d 0a20 2020  krs_cmn = [].   
-00014970: 2066 6f72 2063 7420 696e 206d 6b72 5f64   for ct in mkr_d
-00014980: 6963 742e 6b65 7973 2829 3a0a 2020 2020  ict.keys():.    
-00014990: 2020 2020 6d6b 7273 5f61 6c6c 203d 206d      mkrs_all = m
-000149a0: 6b72 735f 616c 6c20 2b20 6d6b 725f 6469  krs_all + mkr_di
-000149b0: 6374 5b63 745d 0a20 2020 2020 2020 2069  ct[ct].        i
-000149c0: 6620 6c65 6e28 6d6b 7273 5f63 6d6e 2920  f len(mkrs_cmn) 
-000149d0: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-000149e0: 2020 6d6b 7273 5f63 6d6e 203d 206d 6b72    mkrs_cmn = mkr
-000149f0: 5f64 6963 745b 6374 5d0a 2020 2020 2020  _dict[ct].      
-00014a00: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00014a10: 2020 2020 6d6b 7273 5f63 6d6e 203d 206c      mkrs_cmn = l
-00014a20: 6973 7428 7365 7428 6d6b 7273 5f63 6d6e  ist(set(mkrs_cmn
-00014a30: 292e 696e 7465 7273 6563 7469 6f6e 286d  ).intersection(m
-00014a40: 6b72 5f64 6963 745b 6374 5d29 290a 0a20  kr_dict[ct])).. 
-00014a50: 2020 206d 6b72 735f 616c 6c20 3d20 6c69     mkrs_all = li
-00014a60: 7374 2873 6574 286d 6b72 735f 616c 6c29  st(set(mkrs_all)
-00014a70: 290a 2020 2020 0a20 2020 2072 6574 7572  ).    .    retur
-00014a80: 6e20 6d6b 7273 5f61 6c6c 2c20 6d6b 725f  n mkrs_all, mkr_
-00014a90: 6469 6374 0a0a 0a64 6566 2048 6943 4154  dict...def HiCAT
-00014aa0: 2820 585f 6365 6c6c 5f62 795f 6765 6e65  ( X_cell_by_gene
-00014ab0: 2c20 6d61 726b 6572 5f66 696c 652c 206c  , marker_file, l
-00014ac0: 6f67 5f74 7261 6e73 666f 726d 6564 203d  og_transformed =
-00014ad0: 2046 616c 7365 2c0a 2020 2020 2020 2020   False,.        
-00014ae0: 2020 2020 2020 2074 6172 6765 745f 7469         target_ti
-00014af0: 7373 7565 7320 3d20 5b5d 2c20 7461 7267  ssues = [], targ
-00014b00: 6574 5f63 656c 6c5f 7479 7065 7320 3d20  et_cell_types = 
-00014b10: 5b5d 2c20 6d69 6e6f 725f 7479 7065 735f  [], minor_types_
-00014b20: 746f 5f65 7863 6c75 6465 203d 205b 5d2c  to_exclude = [],
-00014b30: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00014b40: 206d 6b72 5f73 656c 6563 746f 7220 3d20   mkr_selector = 
-00014b50: 504e 5348 3132 2c20 4e5f 6e65 6967 6862  PNSH12, N_neighb
-00014b60: 6f72 735f 6d69 6e6f 7220 3d20 3331 2c20  ors_minor = 31, 
-00014b70: 4e5f 6e65 6967 6862 6f72 735f 7375 6273  N_neighbors_subs
-00014b80: 6574 203d 2031 2c20 200a 2020 2020 2020  et = 1,  .      
-00014b90: 2020 2020 2020 2020 2043 6c75 7374 6572           Cluster
-00014ba0: 696e 675f 616c 676f 203d 2027 6c76 272c  ing_algo = 'lv',
-00014bb0: 2043 6c75 7374 6572 696e 675f 7265 736f   Clustering_reso
-00014bc0: 6c75 7469 6f6e 203d 2031 2c20 0a20 2020  lution = 1, .   
-00014bd0: 2020 2020 2020 2020 2020 2020 436c 7573              Clus
-00014be0: 7465 7269 6e67 5f62 6173 6520 3d20 2770  tering_base = 'p
-00014bf0: 6361 272c 204e 5f70 6361 5f63 6f6d 706f  ca', N_pca_compo
-00014c00: 6e65 6e74 7320 3d20 3135 2c20 0a20 2020  nents = 15, .   
-00014c10: 2020 2020 2020 2020 2020 2020 6379 636c              cycl
-00014c20: 696e 675f 6365 6c6c 203d 2046 616c 7365  ing_cell = False
-00014c30: 2c20 636f 7079 5f58 203d 2046 616c 7365  , copy_X = False
-00014c40: 2c20 7665 7262 6f73 6520 3d20 4661 6c73  , verbose = Fals
-00014c50: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00014c60: 2020 6d6f 6465 6c20 3d20 2767 6d6d 272c    model = 'gmm',
-00014c70: 204e 5f67 6d6d 5f63 6f6d 706f 6e65 6e74   N_gmm_component
-00014c80: 7320 3d20 3130 2c20 6362 635f 6375 746f  s = 10, cbc_cuto
-00014c90: 6666 203d 2030 2e30 312c 0a20 2020 2020  ff = 0.01,.     
-00014ca0: 2020 2020 2020 2020 2020 5461 7267 6574            Target
-00014cb0: 5f46 5052 203d 2030 2e30 352c 2070 7661  _FPR = 0.05, pva
-00014cc0: 6c5f 7468 203d 2030 2e30 352c 2070 7661  l_th = 0.05, pva
-00014cd0: 6c5f 7468 5f73 7562 7365 7420 3d20 312c  l_th_subset = 1,
-00014ce0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00014cf0: 2070 6d61 6a20 3d20 302e 372c 2070 7468   pmaj = 0.7, pth
-00014d00: 5f66 6974 5f70 6e74 203d 2030 2e34 2c20  _fit_pnt = 0.4, 
-00014d10: 7074 685f 6d69 6e20 3d20 302e 352c 206d  pth_min = 0.5, m
-00014d20: 696e 5f6c 6f67 505f 6469 6666 203d 2031  in_logP_diff = 1
-00014d30: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-00014d40: 2020 7573 655f 6d69 6e6f 7220 3d20 5472    use_minor = Tr
-00014d50: 7565 2c20 6d69 6e6f 725f 7767 7420 3d20  ue, minor_wgt = 
-00014d60: 302c 2075 7365 5f75 6e69 6f6e 203d 2046  0, use_union = F
-00014d70: 616c 7365 2c20 7573 655f 756e 696f 6e5f  alse, use_union_
-00014d80: 6d61 6a6f 7220 3d20 5472 7565 2c0a 2020  major = True,.  
-00014d90: 2020 2020 2020 2020 2020 2020 2075 7365               use
-00014da0: 5f6d 6172 6b65 7273 5f66 6f72 5f70 6361  _markers_for_pca
-00014db0: 203d 2046 616c 7365 2c20 636f 6d62 5f6d   = False, comb_m
-00014dc0: 6b72 7320 3d20 4661 6c73 652c 200a 2020  krs = False, .  
-00014dd0: 2020 2020 2020 2020 2020 2020 206b 6e6e               knn
-00014de0: 5f74 7970 6520 3d20 312c 206b 6e6e 5f70  _type = 1, knn_p
-00014df0: 6d61 6a20 3d20 302e 332c 204e 5f6d 6178  maj = 0.3, N_max
-00014e00: 5f74 6f5f 6176 6520 3d20 312c 0a20 2020  _to_ave = 1,.   
-00014e10: 2020 2020 2020 2020 2020 2020 7468 7265              thre
-00014e20: 7368 6f6c 6469 6e67 5f6d 696e 6f72 203d  sholding_minor =
-00014e30: 2046 616c 7365 2c20 7468 7265 7368 6f6c   False, threshol
-00014e40: 6469 6e67 5f73 7562 7365 7420 3d20 4661  ding_subset = Fa
-00014e50: 6c73 6520 293a 0a0a 2020 2020 6966 206c  lse ):..    if l
-00014e60: 656e 2874 6172 6765 745f 6365 6c6c 5f74  en(target_cell_t
-00014e70: 7970 6573 2920 3e20 303a 0a20 2020 2020  ypes) > 0:.     
-00014e80: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
-00014e90: 2320 7461 7267 6574 5f63 656c 6c5f 7479  # target_cell_ty
-00014ea0: 7065 7320 3d20 7461 7267 6574 5f63 656c  pes = target_cel
-00014eb0: 6c5f 7479 7065 735f 696e 0a20 2020 2065  l_types_in.    e
-00014ec0: 6c69 6620 6c65 6e28 7461 7267 6574 5f74  lif len(target_t
-00014ed0: 6973 7375 6573 2920 3e20 303a 0a20 2020  issues) > 0:.   
-00014ee0: 2020 2020 2020 2020 2074 6172 6765 745f           target_
-00014ef0: 6365 6c6c 5f74 7970 6573 203d 2067 6574  cell_types = get
-00014f00: 5f74 6172 6765 745f 6365 6c6c 5f74 7970  _target_cell_typ
-00014f10: 6573 2820 6d61 726b 6572 5f66 696c 652c  es( marker_file,
-00014f20: 2074 6172 6765 745f 7469 7373 7565 7320   target_tissues 
-00014f30: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-00014f40: 7072 696e 7428 2754 6172 6765 7420 6365  print('Target ce
-00014f50: 6c6c 2074 7970 6573 3a20 272c 2074 6172  ll types: ', tar
-00014f60: 6765 745f 6365 6c6c 5f74 7970 6573 290a  get_cell_types).
-00014f70: 0a20 2020 2069 6620 434c 5553 5445 5249  .    if CLUSTERI
-00014f80: 4e47 5f41 474f 2021 3d20 276c 7627 3a0a  NG_AGO != 'lv':.
-00014f90: 2020 2020 2020 2020 436c 7573 7465 7269          Clusteri
-00014fa0: 6e67 5f61 6c67 6f20 3d20 434c 5553 5445  ng_algo = CLUSTE
-00014fb0: 5249 4e47 5f41 474f 0a20 2020 2020 2020  RING_AGO.       
-00014fc0: 200a 2020 2020 7265 6d5f 636d 6e5f 6d6b   .    rem_cmn_mk
-00014fd0: 7220 3d20 4661 6c73 650a 2020 2020 6964  r = False.    id
-00014fe0: 656e 745f 6c65 7665 6c20 3d20 330a 2020  ent_level = 3.  
-00014ff0: 2020 6d69 6e6f 725f 6964 5f73 6570 203d    minor_id_sep =
-00015000: 2054 7275 650a 2020 2020 0a20 2020 2067   True.    .    g
-00015010: 656e 655f 6e61 6d65 7320 3d20 4e6f 6e65  ene_names = None
-00015020: 0a20 2020 206d 6574 686f 6420 3d20 6d6f  .    method = mo
-00015030: 6465 6c0a 2020 2020 4e5f 636f 6d70 6f6e  del.    N_compon
-00015040: 656e 7473 203d 204e 5f67 6d6d 5f63 6f6d  ents = N_gmm_com
-00015050: 706f 6e65 6e74 730a 2020 2020 7374 6172  ponents.    star
-00015060: 745f 7469 6d65 203d 2074 696d 652e 7469  t_time = time.ti
-00015070: 6d65 2829 0a20 2020 2064 6963 745f 7375  me().    dict_su
-00015080: 6d6d 6172 795f 7265 7320 3d20 7b7d 0a20  mmary_res = {}. 
-00015090: 2020 2064 6963 745f 7375 6d6d 6172 795f     dict_summary_
-000150a0: 7363 6f72 6520 3d20 7b7d 0a20 2020 2064  score = {}.    d
-000150b0: 6963 745f 7375 6d6d 6172 795f 7363 6f72  ict_summary_scor
-000150c0: 6532 203d 207b 7d0a 2020 2020 6469 6374  e2 = {}.    dict
-000150d0: 5f73 756d 6d61 7279 5f73 636f 7265 3320  _summary_score3 
-000150e0: 3d20 7b7d 0a20 2020 200a 2020 2020 6966  = {}.    .    if
-000150f0: 2054 6172 6765 745f 4650 5220 3e3d 2031   Target_FPR >= 1
-00015100: 3a0a 2020 2020 2020 2020 7468 7265 7368  :.        thresh
-00015110: 6f6c 6469 6e67 203d 2046 616c 7365 0a20  olding = False. 
-00015120: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00015130: 2074 6872 6573 686f 6c64 696e 6720 3d20   thresholding = 
-00015140: 5472 7565 0a20 2020 2020 2020 200a 2020  True.        .  
-00015150: 2020 6966 2076 6572 626f 7365 3a20 7072    if verbose: pr
-00015160: 696e 7428 2748 6943 4154 2072 756e 6e69  int('HiCAT runni
-00015170: 6e67 202e 2e27 290a 2020 2020 656c 7365  ng ..').    else
-00015180: 3a20 7072 696e 7428 2748 6943 4154 2072  : print('HiCAT r
-00015190: 756e 6e69 6e67 202e 2e27 2c20 656e 6420  unning ..', end 
-000151a0: 3d20 2727 2c20 666c 7573 6820 3d20 5472  = '', flush = Tr
-000151b0: 7565 290a 2020 2020 2020 2020 0a20 2020  ue).        .   
-000151c0: 2069 6620 6973 696e 7374 616e 6365 2858   if isinstance(X
-000151d0: 5f63 656c 6c5f 6279 5f67 656e 652c 2070  _cell_by_gene, p
-000151e0: 642e 4461 7461 4672 616d 6529 3a0a 2020  d.DataFrame):.  
-000151f0: 2020 2020 2020 6966 2063 6f70 795f 583a        if copy_X:
-00015200: 0a20 2020 2020 2020 2020 2020 2058 7320  .            Xs 
-00015210: 3d20 585f 6365 6c6c 5f62 795f 6765 6e65  = X_cell_by_gene
-00015220: 2e63 6f70 7928 6465 6570 3d54 7275 6529  .copy(deep=True)
-00015230: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00015240: 2020 2020 2020 2020 2020 2058 7320 3d20             Xs = 
-00015250: 585f 6365 6c6c 5f62 795f 6765 6e65 0a20  X_cell_by_gene. 
-00015260: 2020 2020 2020 2067 656e 6573 5f6c 7374         genes_lst
-00015270: 5f6f 7267 203d 206c 6973 7428 585f 6365  _org = list(X_ce
-00015280: 6c6c 5f62 795f 6765 6e65 2e63 6f6c 756d  ll_by_gene.colum
-00015290: 6e73 2e76 616c 7565 7329 0a0a 2020 2020  ns.values)..    
-000152a0: 2020 2020 6765 6e65 735f 6c73 7420 3d20      genes_lst = 
-000152b0: 5b5d 0a20 2020 2020 2020 2066 6f72 2067  [].        for g
-000152c0: 2069 6e20 6765 6e65 735f 6c73 745f 6f72   in genes_lst_or
-000152d0: 673a 0a20 2020 2020 2020 2020 2020 2067  g:.            g
-000152e0: 656e 6573 5f6c 7374 2e61 7070 656e 6428  enes_lst.append(
-000152f0: 672e 7570 7065 7228 2929 0a20 2020 2020  g.upper()).     
-00015300: 2020 2072 656e 6420 3d20 6469 6374 287a     rend = dict(z
-00015310: 6970 2867 656e 6573 5f6c 7374 5f6f 7267  ip(genes_lst_org
-00015320: 2c20 6765 6e65 735f 6c73 7429 290a 2020  , genes_lst)).  
-00015330: 2020 2020 2020 5873 2e72 656e 616d 6528        Xs.rename(
-00015340: 636f 6c75 6d6e 7320 3d20 7265 6e64 2c20  columns = rend, 
-00015350: 696e 706c 6163 6520 3d20 5472 7565 290a  inplace = True).
-00015360: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-00015370: 2065 6c73 653a 0a20 2020 2020 2020 2054   else:.        T
-00015380: 6964 656e 5f70 7269 6e74 5f65 7272 6f72  iden_print_error
-00015390: 2829 0a20 2020 2020 2020 2072 6574 7572  ().        retur
-000153a0: 6e20 2d31 0a0a 2020 2020 2323 2320 436f  n -1..    ### Co
-000153b0: 7272 6563 7420 4d61 6a6f 7220 7479 7065  rrect Major type
-000153c0: 0a20 2020 2069 6620 7665 7262 6f73 653a  .    if verbose:
-000153d0: 2070 7269 6e74 2827 5043 4120 2e2e 2027   print('PCA .. '
-000153e0: 2c20 656e 6420 3d20 2727 2c20 666c 7573  , end = '', flus
-000153f0: 6820 3d20 5472 7565 290a 2020 2020 656c  h = True).    el
-00015400: 7365 3a20 0a20 2020 2020 2020 2065 7469  se: .        eti
-00015410: 6d65 203d 2072 6f75 6e64 2874 696d 652e  me = round(time.
-00015420: 7469 6d65 2829 202d 2073 7461 7274 5f74  time() - start_t
-00015430: 696d 6529 2020 2020 2020 2020 0a20 2020  ime)        .   
-00015440: 2020 2020 2073 7461 7274 5f74 696d 655f       start_time_
-00015450: 6e65 7720 3d20 7469 6d65 2e74 696d 6528  new = time.time(
-00015460: 290a 2020 2020 2020 2020 7072 696e 7428  ).        print(
-00015470: 272e 272c 2065 6e64 203d 2027 272c 2066  '.', end = '', f
-00015480: 6c75 7368 203d 2054 7275 6529 0a20 2020  lush = True).   
-00015490: 2020 2020 2023 2070 7269 6e74 2827 2e27       # print('.'
-000154a0: 2c20 656e 6420 3d20 2727 2c20 666c 7573  , end = '', flus
-000154b0: 6820 3d20 5472 7565 290a 2020 2020 4e5f  h = True).    N_
-000154c0: 636f 6d70 6f6e 656e 7473 5f70 6361 203d  components_pca =
-000154d0: 204e 5f70 6361 5f63 6f6d 706f 6e65 6e74   N_pca_component
-000154e0: 730a 2020 2020 7063 6120 3d20 5043 4128  s.    pca = PCA(
-000154f0: 6e5f 636f 6d70 6f6e 656e 7473 203d 2069  n_components = i
-00015500: 6e74 284e 5f63 6f6d 706f 6e65 6e74 735f  nt(N_components_
-00015510: 7063 6129 2c20 636f 7079 203d 2054 7275  pca), copy = Tru
-00015520: 652c 200a 2020 2020 2020 2020 2020 2020  e, .            
-00015530: 2020 7261 6e64 6f6d 5f73 7461 7465 203d    random_state =
-00015540: 2030 2920 2320 2c20 7376 645f 736f 6c76   0) # , svd_solv
-00015550: 6572 203d 2027 6172 7061 636b 2729 0a20  er = 'arpack'). 
-00015560: 2020 200a 2020 2020 6966 2075 7365 5f6d     .    if use_m
-00015570: 6172 6b65 7273 5f66 6f72 5f70 6361 3a0a  arkers_for_pca:.
-00015580: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-00015590: 7365 3a20 7072 696e 7428 2755 7369 6e67  se: print('Using
-000155a0: 204d 6b72 7320 2e2e 2027 2c20 656e 6420   Mkrs .. ', end 
-000155b0: 3d20 2727 2c20 666c 7573 6820 3d20 5472  = '', flush = Tr
-000155c0: 7565 290a 2020 2020 2020 2020 6d6b 7273  ue).        mkrs
-000155d0: 5f61 6c6c 2c20 6d6b 7273 5f64 6963 7420  _all, mkrs_dict 
-000155e0: 3d20 6765 745f 6d61 726b 6572 735f 616c  = get_markers_al
-000155f0: 6c28 6d61 726b 6572 5f66 696c 652c 2074  l(marker_file, t
-00015600: 6172 6765 745f 6c73 7420 3d20 5b5d 2c20  arget_lst = [], 
-00015610: 706e 7368 3132 203d 206d 6b72 5f73 656c  pnsh12 = mkr_sel
-00015620: 6563 746f 722c 0a20 2020 2020 2020 2020  ector,.         
-00015630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015650: 2020 2020 206c 6576 656c 203d 2031 2c20       level = 1, 
-00015660: 636f 6d62 5f6d 6b72 7320 3d20 636f 6d62  comb_mkrs = comb
-00015670: 5f6d 6b72 7329 0a20 2020 2020 2020 2067  _mkrs).        g
-00015680: 656e 6573 203d 206c 6973 7428 5873 2e63  enes = list(Xs.c
-00015690: 6f6c 756d 6e73 2e76 616c 7565 7329 0a20  olumns.values). 
-000156a0: 2020 2020 2020 206d 6b72 735f 616c 6c20         mkrs_all 
-000156b0: 3d20 6c69 7374 2873 6574 286d 6b72 735f  = list(set(mkrs_
-000156c0: 616c 6c29 2e69 6e74 6572 7365 6374 696f  all).intersectio
-000156d0: 6e28 6765 6e65 7329 290a 2020 2020 2020  n(genes)).      
-000156e0: 2020 5873 203d 2058 735b 6d6b 7273 5f61    Xs = Xs[mkrs_a
-000156f0: 6c6c 5d0a 2020 2020 656c 7365 3a0a 2020  ll].    else:.  
-00015700: 2020 2020 2020 6d6b 7273 5f61 6c6c 203d        mkrs_all =
-00015710: 206c 6973 7428 5873 2e63 6f6c 756d 6e73   list(Xs.columns
-00015720: 2e76 616c 7565 7329 0a20 2020 2020 2020  .values).       
-00015730: 200a 2020 2020 5878 203d 2058 5f70 7265   .    Xx = X_pre
-00015740: 7072 6f63 6573 7369 6e67 2820 5873 2c20  processing( Xs, 
-00015750: 6c6f 675f 7472 616e 7366 6f72 6d65 642c  log_transformed,
-00015760: 204e 5f67 656e 6573 203d 2032 3030 3020   N_genes = 2000 
-00015770: 290a 2020 2020 2727 270a 2020 2020 6966  ).    '''.    if
-00015780: 2058 732e 7368 6170 655b 315d 203c 2033   Xs.shape[1] < 3
-00015790: 3030 303a 0a20 2020 2020 2020 2069 6620  000:.        if 
-000157a0: 6e6f 7420 6c6f 675f 7472 616e 7366 6f72  not log_transfor
-000157b0: 6d65 643a 0a20 2020 2020 2020 2020 2020  med:.           
-000157c0: 2058 7820 3d20 6e70 2e6c 6f67 3228 3120   Xx = np.log2(1 
-000157d0: 2b20 585f 6e6f 726d 616c 697a 6528 5873  + X_normalize(Xs
-000157e0: 2929 0a20 2020 2020 2020 2020 2020 2058  )).            X
-000157f0: 7820 3d20 585f 7363 616c 6528 5878 2c20  x = X_scale(Xx, 
-00015800: 6d61 785f 7661 6c20 3d20 3130 290a 2020  max_val = 10).  
-00015810: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00015820: 2020 2020 2020 2020 5878 203d 2058 730a          Xx = Xs.
-00015830: 2020 2020 2020 2020 2020 2020 5878 203d              Xx =
-00015840: 2058 5f73 6361 6c65 2858 782c 206d 6178   X_scale(Xx, max
-00015850: 5f76 616c 203d 2031 3029 0a20 2020 2065  _val = 10).    e
-00015860: 6c73 653a 0a20 2020 2020 2020 2067 656e  lse:.        gen
-00015870: 655f 7365 6c20 3d20 7365 6c65 6374 5f76  e_sel = select_v
-00015880: 6172 6961 626c 655f 6765 6e65 7328 5873  ariable_genes(Xs
-00015890: 2c20 6c6f 675f 7472 616e 7366 6f72 6d65  , log_transforme
-000158a0: 6420 3d20 6c6f 675f 7472 616e 7366 6f72  d = log_transfor
-000158b0: 6d65 6429 0a20 2020 2020 2020 2069 6620  med).        if 
-000158c0: 6e6f 7420 6c6f 675f 7472 616e 7366 6f72  not log_transfor
-000158d0: 6d65 643a 0a20 2020 2020 2020 2020 2020  med:.           
-000158e0: 2058 7820 3d20 6e70 2e6c 6f67 3228 3120   Xx = np.log2(1 
-000158f0: 2b20 585f 6e6f 726d 616c 697a 6528 5873  + X_normalize(Xs
-00015900: 2e6c 6f63 5b3a 2c67 656e 655f 7365 6c5d  .loc[:,gene_sel]
-00015910: 2929 0a20 2020 2020 2020 2020 2020 2058  )).            X
-00015920: 7820 3d20 585f 7363 616c 6528 5878 2c20  x = X_scale(Xx, 
-00015930: 6d61 785f 7661 6c20 3d20 3130 290a 2020  max_val = 10).  
-00015940: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00015950: 2020 2020 2020 2020 5878 203d 2058 732e          Xx = Xs.
-00015960: 6c6f 635b 3a2c 6765 6e65 5f73 656c 5d0a  loc[:,gene_sel].
-00015970: 2020 2020 2020 2020 2020 2020 5878 203d              Xx =
-00015980: 2058 5f73 6361 6c65 2858 782c 206d 6178   X_scale(Xx, max
-00015990: 5f76 616c 203d 2031 3029 0a20 2020 2027  _val = 10).    '
-000159a0: 2727 2020 2020 0a20 2020 2058 5f6c 6f67  ''    .    X_log
-000159b0: 203d 2058 780a 2020 2020 585f 7063 6120   = Xx.    X_pca 
-000159c0: 3d20 7063 612e 6669 745f 7472 616e 7366  = pca.fit_transf
-000159d0: 6f72 6d28 5878 290a 2020 2020 585f 7063  orm(Xx).    X_pc
-000159e0: 6120 3d20 7064 2e44 6174 6146 7261 6d65  a = pd.DataFrame
-000159f0: 2858 5f70 6361 2c20 696e 6465 7820 3d20  (X_pca, index = 
-00015a00: 5878 2e69 6e64 6578 2c20 636f 6c75 6d6e  Xx.index, column
-00015a10: 7320 3d20 6c69 7374 286e 702e 6172 616e  s = list(np.aran
-00015a20: 6765 2869 6e74 284e 5f63 6f6d 706f 6e65  ge(int(N_compone
-00015a30: 6e74 735f 7063 6129 2929 290a 2020 2020  nts_pca)))).    
-00015a40: 0a20 2020 204e 5f63 6c75 7374 6572 7320  .    N_clusters 
-00015a50: 3d20 696e 7428 3235 2a6e 702e 7371 7274  = int(25*np.sqrt
-00015a60: 2843 6c75 7374 6572 696e 675f 7265 736f  (Clustering_reso
-00015a70: 6c75 7469 6f6e 2929 0a20 2020 204d 6178  lution)).    Max
-00015a80: 4e63 6f6d 7020 3d20 4e5f 636c 7573 7465  Ncomp = N_cluste
-00015a90: 7273 0a20 2020 2073 7172 744e 203d 2069  rs.    sqrtN = i
-00015aa0: 6e74 286e 702e 7371 7274 2858 5f70 6361  nt(np.sqrt(X_pca
-00015ab0: 2e73 6861 7065 5b30 5d29 2f32 290a 2020  .shape[0])/2).  
-00015ac0: 2020 4e5f 636f 6d70 203d 206d 696e 284d    N_comp = min(M
-00015ad0: 6178 4e63 6f6d 702c 2073 7172 744e 290a  axNcomp, sqrtN).
-00015ae0: 2020 2020 0a20 2020 2069 6620 7665 7262      .    if verb
-00015af0: 6f73 653a 2070 7269 6e74 2827 436c 7573  ose: print('Clus
-00015b00: 7465 7269 6e67 202e 2e20 272c 2065 6e64  tering .. ', end
-00015b10: 203d 2027 272c 2066 6c75 7368 203d 2054   = '', flush = T
-00015b20: 7275 6529 0a20 2020 2065 6c73 653a 200a  rue).    else: .
-00015b30: 2020 2020 2020 2020 6574 696d 6520 3d20          etime = 
-00015b40: 726f 756e 6428 7469 6d65 2e74 696d 6528  round(time.time(
-00015b50: 2920 2d20 7374 6172 745f 7469 6d65 5f6e  ) - start_time_n
-00015b60: 6577 2920 2020 2020 2020 200a 2020 2020  ew)        .    
-00015b70: 2020 2020 7374 6172 745f 7469 6d65 5f6e      start_time_n
-00015b80: 6577 203d 2074 696d 652e 7469 6d65 2829  ew = time.time()
-00015b90: 0a20 2020 2020 2020 2070 7269 6e74 2827  .        print('
-00015ba0: 5025 692e 2720 2520 6574 696d 652c 2065  P%i.' % etime, e
-00015bb0: 6e64 203d 2027 272c 2066 6c75 7368 203d  nd = '', flush =
-00015bc0: 2054 7275 6529 0a20 2020 2020 2020 2023   True).        #
-00015bd0: 2070 7269 6e74 2827 2e27 2c20 656e 6420   print('.', end 
-00015be0: 3d20 2727 2c20 666c 7573 6820 3d20 5472  = '', flush = Tr
-00015bf0: 7565 290a 2020 2020 0a20 2020 2069 6620  ue).    .    if 
-00015c00: 436c 7573 7465 7269 6e67 5f62 6173 6520  Clustering_base 
-00015c10: 3d3d 2027 7063 6127 3a0a 2020 2020 2020  == 'pca':.      
-00015c20: 2020 585f 756d 6170 203d 2058 5f70 6361    X_umap = X_pca
-00015c30: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00015c40: 2020 2058 5f75 6d61 7020 3d20 585f 7063     X_umap = X_pc
-00015c50: 610a 2020 2020 2020 2020 0a20 2020 2079  a.        .    y
-00015c60: 5f63 6c75 7374 2c20 636f 626a 203d 2063  _clust, cobj = c
-00015c70: 6c75 7374 6572 696e 675f 616c 6728 585f  lustering_alg(X_
-00015c80: 756d 6170 2c20 636c 7573 745f 616c 676f  umap, clust_algo
-00015c90: 203d 2043 6c75 7374 6572 696e 675f 616c   = Clustering_al
-00015ca0: 676f 2c20 4e5f 636c 7573 7465 7273 203d  go, N_clusters =
-00015cb0: 204e 5f63 6f6d 702c 200a 2020 2020 2020   N_comp, .      
-00015cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015cd0: 2020 2020 2020 2072 6573 6f6c 7574 696f         resolutio
-00015ce0: 6e20 3d20 436c 7573 7465 7269 6e67 5f72  n = Clustering_r
-00015cf0: 6573 6f6c 7574 696f 6e29 0a20 2020 200a  esolution).    .
-00015d00: 2020 2020 7265 6e64 203d 207b 7d0a 2020      rend = {}.  
-00015d10: 2020 666f 7220 6920 696e 206c 6973 7428    for i in list(
-00015d20: 585f 7063 612e 636f 6c75 6d6e 732e 7661  X_pca.columns.va
-00015d30: 6c75 6573 293a 0a20 2020 2020 2020 2072  lues):.        r
-00015d40: 656e 645b 695d 203d 2073 7472 2869 290a  end[i] = str(i).
-00015d50: 2020 2020 585f 7063 612e 7265 6e61 6d65      X_pca.rename
-00015d60: 2863 6f6c 756d 6e73 203d 2072 656e 642c  (columns = rend,
-00015d70: 2069 6e70 6c61 6365 203d 2054 7275 6529   inplace = True)
-00015d80: 0a0a 2020 2020 2320 6469 6374 5f73 756d  ..    # dict_sum
-00015d90: 6d61 7279 5f72 6573 5b27 5870 6361 275d  mary_res['Xpca']
-00015da0: 203d 2058 5f70 6361 0a20 2020 200a 2020   = X_pca.    .  
-00015db0: 2020 6966 2076 6572 626f 7365 3a20 7072    if verbose: pr
-00015dc0: 696e 7428 274e 6320 3d20 2569 2c20 2720  int('Nc = %i, ' 
-00015dd0: 2520 6c65 6e28 7365 7428 795f 636c 7573  % len(set(y_clus
-00015de0: 7429 292c 2065 6e64 203d 2027 272c 2066  t)), end = '', f
-00015df0: 6c75 7368 203d 2054 7275 6529 0a20 2020  lush = True).   
-00015e00: 2065 6c73 653a 200a 2020 2020 2020 2020   else: .        
-00015e10: 6574 696d 6520 3d20 726f 756e 6428 7469  etime = round(ti
-00015e20: 6d65 2e74 696d 6528 2920 2d20 7374 6172  me.time() - star
-00015e30: 745f 7469 6d65 5f6e 6577 2920 2020 2020  t_time_new)     
-00015e40: 2020 200a 2020 2020 2020 2020 7374 6172     .        star
-00015e50: 745f 7469 6d65 5f6e 6577 203d 2074 696d  t_time_new = tim
-00015e60: 652e 7469 6d65 2829 0a20 2020 2020 2020  e.time().       
-00015e70: 2070 7269 6e74 2827 4325 692e 2720 2520   print('C%i.' % 
-00015e80: 6574 696d 652c 2065 6e64 203d 2027 272c  etime, end = '',
-00015e90: 2066 6c75 7368 203d 2054 7275 6529 0a20   flush = True). 
-00015ea0: 2020 2020 2020 2023 2070 7269 6e74 2827         # print('
-00015eb0: 2e27 2c20 656e 6420 3d20 2727 2c20 666c  .', end = '', fl
-00015ec0: 7573 6820 3d20 5472 7565 290a 2020 2020  ush = True).    
-00015ed0: 2020 200a 2020 2020 2323 2323 2320 4d61     .    ##### Ma
-00015ee0: 6a6f 7220 7479 7065 2069 6465 6e74 6966  jor type identif
-00015ef0: 6963 6174 696f 6e20 666f 7220 7461 7267  ication for targ
-00015f00: 6574 2063 656c 6c20 7365 6c65 6374 696f  et cell selectio
-00015f10: 6e0a 2020 2020 6469 6374 5f63 656c 6c74  n.    dict_cellt
-00015f20: 7970 655f 636f 6d62 203d 207b 7d0a 0a20  ype_comb = {}.. 
-00015f30: 2020 2069 6620 5472 7565 3a0a 2020 2020     if True:.    
-00015f40: 2020 2020 7461 7267 6574 5f63 656c 6c20      target_cell 
-00015f50: 3d20 7461 7267 6574 5f63 656c 6c5f 7479  = target_cell_ty
-00015f60: 7065 730a 2020 2020 2020 2020 6d6b 725f  pes.        mkr_
-00015f70: 6c73 742c 206d 6b72 5f6c 7374 5f6e 6567  lst, mkr_lst_neg
-00015f80: 203d 2067 6574 5f6d 6172 6b65 7273 5f6d   = get_markers_m
-00015f90: 616a 6f72 5f74 7970 6528 6d61 726b 6572  ajor_type(marker
-00015fa0: 5f66 696c 652c 2074 6172 6765 745f 6365  _file, target_ce
-00015fb0: 6c6c 2c20 0a20 2020 2020 2020 2020 2020  ll, .           
-00015fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015fd0: 2020 2020 2020 2020 2020 2020 2070 6e73               pns
-00015fe0: 6831 3220 3d20 6d6b 725f 7365 6c65 6374  h12 = mkr_select
-00015ff0: 6f72 2c20 7265 6d5f 636f 6d6d 6f6e 203d  or, rem_common =
-00016000: 2072 656d 5f63 6d6e 5f6d 6b72 2c20 7665   rem_cmn_mkr, ve
-00016010: 7262 6f73 6520 3d20 7665 7262 6f73 6529  rbose = verbose)
-00016020: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-00016030: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
-00016040: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00016050: 0a20 2020 2020 2020 2023 2320 4765 7420  .        ## Get 
-00016060: 6d69 6e6f 7220 7479 7065 206d 6172 6b65  minor type marke
-00016070: 7273 0a20 2020 2020 2020 2069 6620 6e6f  rs.        if no
-00016080: 7420 7573 655f 756e 696f 6e5f 6d61 6a6f  t use_union_majo
-00016090: 723a 2020 2020 2020 2020 2020 2020 0a20  r:            . 
-000160a0: 2020 2020 2020 2020 2020 206d 6b72 5f6c             mkr_l
-000160b0: 7374 5f73 7562 7365 742c 206d 6b72 5f6c  st_subset, mkr_l
-000160c0: 7374 5f73 7562 7365 745f 6e65 672c 206d  st_subset_neg, m
-000160d0: 6b72 5f6c 7374 5f73 7562 7365 745f 7365  kr_lst_subset_se
-000160e0: 632c 206d 6170 5f64 6963 745f 7375 6232  c, map_dict_sub2
-000160f0: 6d61 6a2c 206d 6170 5f64 6963 745f 7375  maj, map_dict_su
-00016100: 6232 6d69 6e20 3d20 5c0a 2020 2020 2020  b2min = \.      
-00016110: 2020 2020 2020 2020 2020 6c6f 6164 5f6d            load_m
-00016120: 6172 6b65 7273 5f61 6c6c 286d 6172 6b65  arkers_all(marke
-00016130: 725f 6669 6c65 2c20 7461 7267 6574 5f63  r_file, target_c
-00016140: 656c 6c73 203d 2074 6172 6765 745f 6365  ells = target_ce
-00016150: 6c6c 2c20 706e 7368 3132 203d 206d 6b72  ll, pnsh12 = mkr
-00016160: 5f73 656c 6563 746f 722c 200a 2020 2020  _selector, .    
-00016170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016180: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
-00016190: 625f 6d6b 7273 203d 2063 6f6d 625f 6d6b  b_mkrs = comb_mk
-000161a0: 7273 2c20 2076 6572 626f 7365 203d 2046  rs,  verbose = F
-000161b0: 616c 7365 290a 0a20 2020 2020 2020 2020  alse)..         
-000161c0: 2020 206d 6170 5f64 6963 745f 6d61 6a32     map_dict_maj2
-000161d0: 7375 6220 3d20 7b7d 0a20 2020 2020 2020  sub = {}.       
-000161e0: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
-000161f0: 6d61 705f 6469 6374 5f73 7562 326d 616a  map_dict_sub2maj
-00016200: 2e6b 6579 7328 293a 0a20 2020 2020 2020  .keys():.       
-00016210: 2020 2020 2020 2020 206d 6a74 203d 206d           mjt = m
-00016220: 6170 5f64 6963 745f 7375 6232 6d61 6a5b  ap_dict_sub2maj[
-00016230: 6b65 795d 0a20 2020 2020 2020 2020 2020  key].           
-00016240: 2020 2020 2069 6620 6d6a 7420 6e6f 7420       if mjt not 
-00016250: 696e 206c 6973 7428 6d61 705f 6469 6374  in list(map_dict
-00016260: 5f6d 616a 3273 7562 2e6b 6579 7328 2929  _maj2sub.keys())
-00016270: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00016280: 2020 2020 2020 6d61 705f 6469 6374 5f6d        map_dict_m
-00016290: 616a 3273 7562 5b6d 6a74 5d20 3d20 5b6b  aj2sub[mjt] = [k
-000162a0: 6579 5d0a 2020 2020 2020 2020 2020 2020  ey].            
-000162b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000162c0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-000162d0: 705f 6469 6374 5f6d 616a 3273 7562 5b6d  p_dict_maj2sub[m
-000162e0: 6a74 5d2e 6170 7065 6e64 286b 6579 290a  jt].append(key).
-000162f0: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
-00016300: 5f64 6963 745f 6d69 6e32 7375 6220 3d20  _dict_min2sub = 
-00016310: 7b7d 0a20 2020 2020 2020 2020 2020 2066  {}.            f
-00016320: 6f72 206b 6579 2069 6e20 6d61 705f 6469  or key in map_di
-00016330: 6374 5f73 7562 326d 696e 2e6b 6579 7328  ct_sub2min.keys(
-00016340: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00016350: 2020 206d 6a74 203d 206d 6170 5f64 6963     mjt = map_dic
-00016360: 745f 7375 6232 6d69 6e5b 6b65 795d 0a20  t_sub2min[key]. 
-00016370: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00016380: 6620 6d6a 7420 6e6f 7420 696e 206c 6973  f mjt not in lis
-00016390: 7428 6d61 705f 6469 6374 5f6d 696e 3273  t(map_dict_min2s
-000163a0: 7562 2e6b 6579 7328 2929 3a0a 2020 2020  ub.keys()):.    
-000163b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000163c0: 6d61 705f 6469 6374 5f6d 696e 3273 7562  map_dict_min2sub
-000163d0: 5b6d 6a74 5d20 3d20 5b6b 6579 5d0a 2020  [mjt] = [key].  
-000163e0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-000163f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00016400: 2020 2020 2020 2020 6d61 705f 6469 6374          map_dict
-00016410: 5f6d 696e 3273 7562 5b6d 6a74 5d2e 6170  _min2sub[mjt].ap
-00016420: 7065 6e64 286b 6579 290a 0a20 2020 2020  pend(key)..     
-00016430: 2020 2020 2020 2064 665f 7265 735f 7375         df_res_su
-00016440: 6273 6574 5f61 6c6c 2c20 6466 5f47 5341  bset_all, df_GSA
-00016450: 5f73 636f 7265 5f73 7562 7365 745f 616c  _score_subset_al
-00016460: 6c2c 2064 666e 5f73 7562 7365 745f 616c  l, dfn_subset_al
-00016470: 6c20 3d20 5c0a 2020 2020 2020 2020 2020  l = \.          
-00016480: 2020 2020 2020 4753 415f 6365 6c6c 5f73        GSA_cell_s
-00016490: 7562 7479 7069 6e67 2820 5873 2c20 6d6b  ubtyping( Xs, mk
-000164a0: 725f 6c73 745f 7375 6273 6574 2c20 6d6b  r_lst_subset, mk
-000164b0: 725f 6c73 745f 7375 6273 6574 5f6e 6567  r_lst_subset_neg
-000164c0: 2c20 7665 7262 6f73 6520 3d20 7665 7262  , verbose = verb
-000164d0: 6f73 6520 290a 2020 2020 2020 2020 2020  ose ).          
-000164e0: 2020 0a20 2020 2020 2020 2020 2020 2069    .            i
-000164f0: 6620 6e6f 7420 7665 7262 6f73 653a 200a  f not verbose: .
-00016500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016510: 6574 696d 6520 3d20 726f 756e 6428 7469  etime = round(ti
-00016520: 6d65 2e74 696d 6528 2920 2d20 7374 6172  me.time() - star
-00016530: 745f 7469 6d65 5f6e 6577 2920 2020 2020  t_time_new)     
-00016540: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-00016550: 2020 2020 7374 6172 745f 7469 6d65 5f6e      start_time_n
-00016560: 6577 203d 2074 696d 652e 7469 6d65 2829  ew = time.time()
-00016570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016580: 2070 7269 6e74 2827 2569 2e27 2025 2065   print('%i.' % e
-00016590: 7469 6d65 2c20 656e 6420 3d20 2727 2c20  time, end = '', 
-000165a0: 666c 7573 6820 3d20 5472 7565 290a 2020  flush = True).  
-000165b0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000165c0: 7072 696e 7428 272e 272c 2065 6e64 203d  print('.', end =
-000165d0: 2027 272c 2066 6c75 7368 203d 2054 7275   '', flush = Tru
-000165e0: 6529 0a20 2020 2020 2020 2023 2323 2323  e).        #####
-000165f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00016600: 2323 2323 2323 2323 230a 2020 2020 2020  #########.      
-00016610: 2020 0a20 2020 2020 2020 2069 6620 7461    .        if ta
-00016620: 7267 6574 5f63 656c 6c5f 7479 7065 7320  rget_cell_types 
-00016630: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00016640: 2020 2020 2074 6172 6765 745f 6365 6c6c       target_cell
-00016650: 5f74 7970 6573 203d 206c 6973 7428 6d6b  _types = list(mk
-00016660: 725f 6c73 742e 6b65 7973 2829 290a 2020  r_lst.keys()).  
-00016670: 2020 2020 2020 656c 6966 206c 656e 2874        elif len(t
-00016680: 6172 6765 745f 6365 6c6c 5f74 7970 6573  arget_cell_types
-00016690: 2920 3d3d 2030 3a0a 2020 2020 2020 2020  ) == 0:.        
-000166a0: 2020 2020 7461 7267 6574 5f63 656c 6c5f      target_cell_
-000166b0: 7479 7065 7320 3d20 6c69 7374 286d 6b72  types = list(mkr
-000166c0: 5f6c 7374 2e6b 6579 7328 2929 0a20 2020  _lst.keys()).   
-000166d0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000166e0: 2020 2020 2020 2073 6d20 3d20 2727 0a20         sm = ''. 
-000166f0: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
-00016700: 6579 2069 6e20 6c69 7374 2873 6574 2874  ey in list(set(t
-00016710: 6172 6765 745f 6365 6c6c 5f74 7970 6573  arget_cell_types
-00016720: 292e 6469 6666 6572 656e 6365 286c 6973  ).difference(lis
-00016730: 7428 6d6b 725f 6c73 742e 6b65 7973 2829  t(mkr_lst.keys()
-00016740: 2929 293a 0a20 2020 2020 2020 2020 2020  ))):.           
-00016750: 2020 2020 2073 6d20 3d20 736d 202b 2027       sm = sm + '
-00016760: 2573 2c27 2025 206b 6579 0a20 2020 2020  %s,' % key.     
-00016770: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
-00016780: 6520 2620 286c 656e 2873 6d29 203e 2030  e & (len(sm) > 0
-00016790: 293a 200a 2020 2020 2020 2020 2020 2020  ): .            
-000167a0: 2020 2020 7072 696e 7428 2749 4e46 4f3a      print('INFO:
-000167b0: 2054 6865 206d 6172 6b65 7220 6462 2064   The marker db d
-000167c0: 6f65 7320 6e6f 7420 636f 6e74 6169 6e20  oes not contain 
-000167d0: 2573 2720 2520 736d 5b3a 2d31 5d29 0a20  %s' % sm[:-1]). 
-000167e0: 2020 2020 2020 2020 2020 2074 6172 6765             targe
-000167f0: 745f 6365 6c6c 5f74 7970 6573 203d 206c  t_cell_types = l
-00016800: 6973 7428 7365 7428 7461 7267 6574 5f63  ist(set(target_c
-00016810: 656c 6c5f 7479 7065 7329 2e69 6e74 6572  ell_types).inter
-00016820: 7365 6374 696f 6e28 6d6b 725f 6c73 742e  section(mkr_lst.
-00016830: 6b65 7973 2829 2929 0a20 2020 2020 2020  keys())).       
-00016840: 2020 2020 200a 2020 2020 2020 2020 6d6b       .        mk
-00016850: 7273 5f61 6c6c 203d 205b 5d0a 2020 2020  rs_all = [].    
-00016860: 2020 2020 666f 7220 6b65 7920 696e 206d      for key in m
-00016870: 6b72 5f6c 7374 2e6b 6579 7328 293a 0a20  kr_lst.keys():. 
-00016880: 2020 2020 2020 2020 2020 206d 6b72 735f             mkrs_
-00016890: 616c 6c20 3d20 6d6b 7273 5f61 6c6c 202b  all = mkrs_all +
-000168a0: 206d 6b72 5f6c 7374 5b6b 6579 5d0a 2020   mkr_lst[key].  
-000168b0: 2020 2020 2020 6d6b 7273 5f61 6c6c 203d        mkrs_all =
-000168c0: 206c 6973 7428 7365 7428 6d6b 7273 5f61   list(set(mkrs_a
-000168d0: 6c6c 2929 0a20 2020 2020 2020 206d 6b72  ll)).        mkr
-000168e0: 735f 6578 6973 7420 3d20 6c69 7374 2873  s_exist = list(s
-000168f0: 6574 286d 6b72 735f 616c 6c29 2e69 6e74  et(mkrs_all).int
-00016900: 6572 7365 6374 696f 6e28 6765 6e65 735f  ersection(genes_
-00016910: 6c73 7429 290a 2020 2020 2020 2020 0a20  lst)).        . 
-00016920: 2020 2020 2020 2070 6374 5f72 203d 206c         pct_r = l
-00016930: 656e 286d 6b72 735f 6578 6973 7429 2f6c  en(mkrs_exist)/l
-00016940: 656e 286d 6b72 735f 616c 6c29 0a20 2020  en(mkrs_all).   
-00016950: 2020 2020 2069 6620 7063 745f 7220 3d3d       if pct_r ==
-00016960: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00016970: 7072 696e 7428 2745 5252 4f52 3a20 4e6f  print('ERROR: No
-00016980: 206d 6172 6b65 7220 6765 6e65 7320 666f   marker genes fo
-00016990: 756e 6420 696e 2074 6865 2064 6174 612e  und in the data.
-000169a0: 2729 0a20 2020 2020 2020 2020 2020 2072  ').            r
-000169b0: 6574 7572 6e20 4e6f 6e65 2c20 4e6f 6e65  eturn None, None
-000169c0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-000169d0: 2020 7076 616c 5f74 6820 3d20 6d69 6e28    pval_th = min(
-000169e0: 2070 7661 6c5f 7468 2f70 6374 5f72 2c20   pval_th/pct_r, 
-000169f0: 302e 3120 290a 2020 2020 2020 2020 7063  0.1 ).        pc
-00016a00: 745f 7468 5f6d 696e 203d 2070 7468 5f6d  t_th_min = pth_m
-00016a10: 696e 2a70 6374 5f72 0a20 2020 2020 2020  in*pct_r.       
-00016a20: 200a 2020 2020 2020 2020 6966 2076 6572   .        if ver
-00016a30: 626f 7365 2026 2028 7063 745f 7220 3c20  bose & (pct_r < 
-00016a40: 302e 3929 3a20 0a20 2020 2020 2020 2020  0.9): .         
-00016a50: 2020 2023 2070 7269 6e74 2827 5043 5420     # print('PCT 
-00016a60: 7265 6475 6374 696f 6e20 6661 6374 6f72  reduction factor
-00016a70: 203d 2025 342e 3266 2720 2520 7063 745f   = %4.2f' % pct_
-00016a80: 7229 0a20 2020 2020 2020 2020 2020 2070  r).            p
-00016a90: 7269 6e74 2827 5741 524e 494e 473a 2054  rint('WARNING: T
-00016aa0: 6f6f 206d 616e 7920 6d61 726b 6572 7320  oo many markers 
-00016ab0: 6e6f 7420 7072 6573 656e 742e 2070 765f  not present. pv_
-00016ac0: 7468 2c20 6d69 6e5f 7074 6820 2d3e 2025  th, min_pth -> %
-00016ad0: 352e 3366 2c20 2535 2e33 6627 2025 205c  5.3f, %5.3f' % \
-00016ae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016af0: 2020 2028 7076 616c 5f74 682c 2070 6374     (pval_th, pct
-00016b00: 5f72 2a50 4354 5f54 4852 4553 484f 4c44  _r*PCT_THRESHOLD
-00016b10: 5f4d 494e 2929 0a20 2020 2020 2020 2020  _MIN)).         
-00016b20: 2020 2023 2070 7269 6e74 2827 494e 464f     # print('INFO
-00016b30: 3a20 546f 6f20 6d61 6e79 206d 6172 6b65  : Too many marke
-00016b40: 7273 206e 6f74 2070 7265 7365 6e74 2e20  rs not present. 
-00016b50: 6d69 6e5f 7074 6820 2d3e 2025 352e 3366  min_pth -> %5.3f
-00016b60: 2720 2520 2870 6374 5f72 2a50 4354 5f54  ' % (pct_r*PCT_T
-00016b70: 4852 4553 484f 4c44 5f4d 494e 2929 0a0a  HRESHOLD_MIN))..
-00016b80: 2020 2020 2020 2020 666f 7220 6c6f 6f70          for loop
-00016b90: 2069 6e20 7261 6e67 6528 6c65 6e28 7461   in range(len(ta
-00016ba0: 7267 6574 5f63 656c 6c5f 7479 7065 7329  rget_cell_types)
-00016bb0: 293a 0a20 2020 2020 2020 2023 206c 6f6f  ):.        # loo
-00016bc0: 7020 3d20 300a 2020 2020 2020 2020 2320  p = 0.        # 
-00016bd0: 6966 2054 7275 653a 2020 0a20 2020 2020  if True:  .     
-00016be0: 2020 2020 2020 2023 2075 7365 5f75 6e69         # use_uni
-00016bf0: 6f6e 5f6d 616a 6f72 203d 2075 7365 5f75  on_major = use_u
-00016c00: 6e69 6f6e 0a20 2020 2020 2020 2020 2020  nion.           
-00016c10: 2069 6620 7573 655f 756e 696f 6e5f 6d61   if use_union_ma
-00016c20: 6a6f 723a 0a20 2020 2020 2020 2020 2020  jor:.           
-00016c30: 2020 2020 2064 665f 7061 7373 203d 204e       df_pass = N
-00016c40: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-00016c50: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00016c60: 2020 2020 2020 6466 5f47 5341 5f73 636f        df_GSA_sco
-00016c70: 7265 5f73 7562 7365 7420 3d20 6466 5f47  re_subset = df_G
-00016c80: 5341 5f73 636f 7265 5f73 7562 7365 745f  SA_score_subset_
-00016c90: 616c 6c0a 2020 2020 2020 2020 2020 2020  all.            
-00016ca0: 2020 2020 6d61 6a6f 725f 7479 7065 5f6c      major_type_l
-00016cb0: 7374 203d 206c 6973 7428 6d61 705f 6469  st = list(map_di
-00016cc0: 6374 5f6d 616a 3273 7562 2e6b 6579 7328  ct_maj2sub.keys(
-00016cd0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00016ce0: 2020 2064 665f 4753 415f 7363 6f72 655f     df_GSA_score_
-00016cf0: 6d61 6a6f 7220 3d20 7064 2e44 6174 6146  major = pd.DataF
-00016d00: 7261 6d65 2869 6e64 6578 203d 2058 732e  rame(index = Xs.
-00016d10: 696e 6465 782c 2063 6f6c 756d 6e73 203d  index, columns =
-00016d20: 206d 616a 6f72 5f74 7970 655f 6c73 7429   major_type_lst)
-00016d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016d40: 2064 666e 5f73 7562 7365 7420 3d20 6466   dfn_subset = df
-00016d50: 6e5f 7375 6273 6574 5f61 6c6c 0a20 2020  n_subset_all.   
-00016d60: 2020 2020 2020 2020 2020 2020 2064 666e               dfn
-00016d70: 5f6d 616a 6f72 203d 2070 642e 4461 7461  _major = pd.Data
-00016d80: 4672 616d 6528 696e 6465 7820 3d20 5873  Frame(index = Xs
-00016d90: 2e69 6e64 6578 2c20 636f 6c75 6d6e 7320  .index, columns 
-00016da0: 3d20 6d61 6a6f 725f 7479 7065 5f6c 7374  = major_type_lst
-00016db0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00016dc0: 2020 666f 7220 6d61 6a6f 7220 696e 206d    for major in m
-00016dd0: 616a 6f72 5f74 7970 655f 6c73 743a 0a20  ajor_type_lst:. 
-00016de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016df0: 2020 2073 7562 5f6c 7374 203d 206d 6170     sub_lst = map
-00016e00: 5f64 6963 745f 6d61 6a32 7375 625b 6d61  _dict_maj2sub[ma
-00016e10: 6a6f 725d 0a20 2020 2020 2020 2020 2020  jor].           
-00016e20: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-00016e30: 7375 625f 6c73 7429 203d 3d20 313a 0a20  sub_lst) == 1:. 
-00016e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016e50: 2020 2020 2020 2062 6573 745f 7363 6f72         best_scor
-00016e60: 6520 3d20 6466 5f47 5341 5f73 636f 7265  e = df_GSA_score
-00016e70: 5f73 7562 7365 745b 7375 625f 6c73 745b  _subset[sub_lst[
-00016e80: 305d 5d0a 2020 2020 2020 2020 2020 2020  0]].            
-00016e90: 2020 2020 2020 2020 2020 2020 6466 6e5f              dfn_
-00016ea0: 6d61 6a6f 725b 6d61 6a6f 725d 203d 2064  major[major] = d
-00016eb0: 666e 5f73 7562 7365 745b 7375 625f 6c73  fn_subset[sub_ls
-00016ec0: 745b 305d 5d0a 2020 2020 2020 2020 2020  t[0]].          
-00016ed0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00016ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ef0: 2020 2020 2020 2020 7375 6273 6574 7320          subsets 
-00016f00: 3d20 6466 5f47 5341 5f73 636f 7265 5f73  = df_GSA_score_s
-00016f10: 7562 7365 745b 7375 625f 6c73 745d 2e69  ubset[sub_lst].i
-00016f20: 6478 6d61 7828 6178 6973 203d 2031 290a  dxmax(axis = 1).
-00016f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016f40: 2020 2020 2020 2020 666f 7220 6b2c 2073          for k, s
-00016f50: 2069 6e20 656e 756d 6572 6174 6528 6c69   in enumerate(li
-00016f60: 7374 2873 7562 7365 7473 2929 3a0a 2020  st(subsets)):.  
-00016f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016f80: 2020 2020 2020 2020 2020 6964 7820 3d20            idx = 
-00016f90: 5873 2e69 6e64 6578 5b6b 5d0a 2020 2020  Xs.index[k].    
-00016fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016fb0: 2020 2020 2020 2020 6466 6e5f 6d61 6a6f          dfn_majo
-00016fc0: 722e 6c6f 635b 6964 782c 6d61 6a6f 725d  r.loc[idx,major]
-00016fd0: 203d 2064 666e 5f73 7562 7365 742e 6c6f   = dfn_subset.lo
-00016fe0: 635b 6964 782c 735d 0a20 2020 2020 2020  c[idx,s].       
-00016ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017000: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00017010: 2020 2020 2020 2020 2020 6966 204e 5f6d            if N_m
-00017020: 6178 5f74 6f5f 6176 6520 3c3d 2031 3a0a  ax_to_ave <= 1:.
-00017030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017040: 2020 2020 2020 2020 2020 2020 6265 7374              best
-00017050: 5f73 636f 7265 203d 2064 665f 4753 415f  _score = df_GSA_
-00017060: 7363 6f72 655f 7375 6273 6574 5b73 7562  score_subset[sub
-00017070: 5f6c 7374 5d2e 6d61 7828 6178 6973 203d  _lst].max(axis =
-00017080: 2031 290a 2020 2020 2020 2020 2020 2020   1).            
-00017090: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000170a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000170b0: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
-000170c0: 6d61 7820 3d20 6d69 6e28 4e5f 6d61 785f  max = min(N_max_
-000170d0: 746f 5f61 7665 2c20 6c65 6e28 7375 625f  to_ave, len(sub_
-000170e0: 6c73 7429 290a 2020 2020 2020 2020 2020  lst)).          
+00012a20: 2020 2020 2020 2061 7563 732e 6c6f 635b         aucs.loc[
+00012a30: 6c72 2c6c 635d 203d 2072 6f63 5f61 7563  lr,lc] = roc_auc
+00012a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012a50: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
+00012a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a70: 2020 2020 2070 7269 6e74 2827 5741 524e       print('WARN
+00012a80: 494e 473a 2063 616e 6e6f 7420 6465 7465  ING: cannot dete
+00012a90: 726d 696e 6520 7468 6520 7365 7061 7261  rmine the separa
+00012aa0: 6269 6c69 7479 2066 6f72 2025 7327 2025  bility for %s' %
+00012ab0: 2074 6172 6765 7429 2020 2020 2020 2020   target)        
+00012ac0: 0a20 2020 2072 6574 7572 6e20 6175 6373  .    return aucs
+00012ad0: 0a0a 6465 6620 7365 7061 7261 6269 6c69  ..def separabili
+00012ae0: 7479 5f63 6865 636b 5f70 6169 7277 6973  ty_check_pairwis
+00012af0: 6528 6466 5f73 636f 7265 2c20 7973 2c20  e(df_score, ys, 
+00012b00: 6d6b 725f 6c73 742c 200a 2020 2020 2020  mkr_lst, .      
+00012b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012b20: 2020 2020 2020 2020 2020 6469 6374 5f63            dict_c
+00012b30: 656c 6c74 7970 655f 636f 6d62 2c20 7665  elltype_comb, ve
+00012b40: 7262 6f73 6520 3d20 4661 6c73 6529 3a0a  rbose = False):.
+00012b50: 2020 2020 0a20 2020 2061 7563 7320 3d20      .    aucs = 
+00012b60: 6368 6563 6b5f 6966 5f73 6570 6172 6162  check_if_separab
+00012b70: 6c65 5f70 6169 7277 6973 6528 6466 5f73  le_pairwise(df_s
+00012b80: 636f 7265 2c20 7973 290a 2020 2020 6964  core, ys).    id
+00012b90: 7863 5f76 6563 203d 2061 7563 732e 6964  xc_vec = aucs.id
+00012ba0: 786d 696e 2861 7869 7320 3d20 3129 0a20  xmin(axis = 1). 
+00012bb0: 2020 206d 696e 615f 7665 6320 3d20 6175     mina_vec = au
+00012bc0: 6373 2e6d 696e 2861 7869 7320 3d20 3129  cs.min(axis = 1)
+00012bd0: 0a20 2020 2069 6478 7220 3d20 6d69 6e61  .    idxr = mina
+00012be0: 5f76 6563 2e69 6478 6d69 6e28 290a 2020  _vec.idxmin().  
+00012bf0: 2020 6964 7863 203d 2069 6478 635f 7665    idxc = idxc_ve
+00012c00: 635b 6964 7872 5d0a 2020 2020 0a20 2020  c[idxr].    .   
+00012c10: 206d 696e 5f61 7563 203d 2061 7563 732e   min_auc = aucs.
+00012c20: 6c6f 635b 6964 7872 2c20 6964 7863 5d0a  loc[idxr, idxc].
+00012c30: 2020 2020 625f 6f6b 203d 2054 7275 650a      b_ok = True.
+00012c40: 2020 2020 6966 206d 696e 5f61 7563 203c      if min_auc <
+00012c50: 2053 4550 4152 4142 494c 4954 595f 5448   SEPARABILITY_TH
+00012c60: 5245 5348 4f4c 443a 0a20 2020 2020 2020  RESHOLD:.       
+00012c70: 2062 5f6f 6b20 3d20 4661 6c73 650a 2020   b_ok = False.  
+00012c80: 2020 0a20 2020 2069 6620 625f 6f6b 3a0a    .    if b_ok:.
+00012c90: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+00012ca0: 7365 3a20 0a20 2020 2020 2020 2020 2020  se: .           
+00012cb0: 2070 7269 6e74 2827 5365 7061 7261 6269   print('Separabi
+00012cc0: 6c69 7479 2063 6865 636b 2070 6173 7365  lity check passe
+00012cd0: 643a 204d 696e 2e41 5543 203d 2025 362e  d: Min.AUC = %6.
+00012ce0: 3466 2062 746e 2025 7320 616e 6420 2573  4f btn %s and %s
+00012cf0: 2720 2520 286d 696e 5f61 7563 2c20 6964  ' % (min_auc, id
+00012d00: 7872 2c20 6964 7863 2929 0a20 2020 2065  xr, idxc)).    e
+00012d10: 6c73 653a 0a20 2020 2020 2020 2069 6620  lse:.        if 
+00012d20: 7665 7262 6f73 653a 200a 2020 2020 2020  verbose: .      
+00012d30: 2020 2020 2020 7072 696e 7428 2753 6570        print('Sep
+00012d40: 6172 6162 696c 6974 7920 6368 6563 6b20  arability check 
+00012d50: 6661 696c 6564 3a20 4d69 6e2e 4155 4320  failed: Min.AUC 
+00012d60: 3d20 2536 2e34 6620 6274 6e20 2573 2061  = %6.4f btn %s a
+00012d70: 6e64 2025 7327 2025 2028 6d69 6e5f 6175  nd %s' % (min_au
+00012d80: 632c 2069 6478 722c 2069 6478 6329 290a  c, idxr, idxc)).
+00012d90: 2020 2020 2020 2020 6e61 6d65 7320 3d20          names = 
+00012da0: 2725 7320 616e 6420 2573 2720 2520 2869  '%s and %s' % (i
+00012db0: 6478 722c 2069 6478 6329 0a20 2020 2020  dxr, idxc).     
+00012dc0: 2020 206e 6577 5f6e 616d 6520 3d20 2725     new_name = '%
+00012dd0: 735f 6f72 5f25 7327 2025 2028 6964 7872  s_or_%s' % (idxr
+00012de0: 2c20 6964 7863 290a 2020 2020 2020 2020  , idxc).        
+00012df0: 6765 6e65 7320 3d20 6c69 7374 2873 6574  genes = list(set
+00012e00: 286d 6b72 5f6c 7374 5b69 6478 725d 202b  (mkr_lst[idxr] +
+00012e10: 206d 6b72 5f6c 7374 5b69 6478 635d 2929   mkr_lst[idxc]))
+00012e20: 0a20 2020 2020 2020 2074 6f5f 636f 6d62  .        to_comb
+00012e30: 5f6e 616d 6520 3d20 5b69 6478 722c 2069  _name = [idxr, i
+00012e40: 6478 635d 0a20 2020 2020 2020 200a 2020  dxc].        .  
+00012e50: 2020 2020 2020 6469 6374 5f63 656c 6c74        dict_cellt
+00012e60: 7970 655f 636f 6d62 5b6e 6577 5f6e 616d  ype_comb[new_nam
+00012e70: 655d 203d 2074 6f5f 636f 6d62 5f6e 616d  e] = to_comb_nam
+00012e80: 650a 2020 2020 2020 2020 6d6b 725f 6c73  e.        mkr_ls
+00012e90: 745b 6e65 775f 6e61 6d65 5d20 3d20 6765  t[new_name] = ge
+00012ea0: 6e65 730a 2020 2020 2020 2020 0a20 2020  nes.        .   
+00012eb0: 2020 2020 2064 656c 206d 6b72 5f6c 7374       del mkr_lst
+00012ec0: 5b69 6478 725d 2020 2020 2020 2020 2020  [idxr]          
+00012ed0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+00012ee0: 2020 2020 2020 2064 656c 206d 6b72 5f6c         del mkr_l
+00012ef0: 7374 5b69 6478 635d 2020 2020 2020 2020  st[idxc]        
+00012f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f10: 0a20 2020 2020 2020 2069 6620 6964 7872  .        if idxr
+00012f20: 2069 6e20 6469 6374 5f63 656c 6c74 7970   in dict_celltyp
+00012f30: 655f 636f 6d62 2e6b 6579 7328 293a 0a20  e_comb.keys():. 
+00012f40: 2020 2020 2020 2020 2020 2064 656c 2064             del d
+00012f50: 6963 745f 6365 6c6c 7479 7065 5f63 6f6d  ict_celltype_com
+00012f60: 625b 6964 7872 5d0a 2020 2020 2020 2020  b[idxr].        
+00012f70: 6966 2069 6478 6320 696e 2064 6963 745f  if idxc in dict_
+00012f80: 6365 6c6c 7479 7065 5f63 6f6d 622e 6b65  celltype_comb.ke
+00012f90: 7973 2829 3a0a 2020 2020 2020 2020 2020  ys():.          
+00012fa0: 2020 6465 6c20 6469 6374 5f63 656c 6c74    del dict_cellt
+00012fb0: 7970 655f 636f 6d62 5b69 6478 635d 0a20  ype_comb[idxc]. 
+00012fc0: 2020 2020 2020 2020 2020 2020 2020 200a                 .
+00012fd0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+00012fe0: 7365 3a20 0a20 2020 2020 2020 2020 2020  se: .           
+00012ff0: 2070 7269 6e74 2827 5365 7061 7261 6269   print('Separabi
+00013000: 6c69 7479 2063 6865 636b 2057 4152 4e49  lity check WARNI
+00013010: 4e47 3a20 2573 2061 7265 206e 6f74 2063  NG: %s are not c
+00013020: 6c65 6172 6c79 2073 6570 6172 6162 6c65  learly separable
+00013030: 2e27 2025 206e 616d 6573 290a 2020 2020  .' % names).    
+00013040: 2020 2020 2020 2020 2320 7072 696e 7428          # print(
+00013050: 2725 7320 6172 6520 6e6f 7420 636c 6561  '%s are not clea
+00013060: 726c 7920 7365 7061 7261 626c 6520 2d3e  rly separable ->
+00013070: 2063 6f6d 6269 6e65 6420 696e 746f 206f   combined into o
+00013080: 6e65 206d 616a 6f72 2074 7970 652e 2720  ne major type.' 
+00013090: 2520 6e61 6d65 7329 0a20 2020 200a 2020  % names).    .  
+000130a0: 2020 7265 7475 726e 2062 5f6f 6b2c 206d    return b_ok, m
+000130b0: 6b72 5f6c 7374 2c20 6469 6374 5f63 656c  kr_lst, dict_cel
+000130c0: 6c74 7970 655f 636f 6d62 0a0a 0a64 6566  ltype_comb...def
+000130d0: 2072 656d 5f6d 696e 6f72 2820 6d6b 725f   rem_minor( mkr_
+000130e0: 6469 6374 2c20 746f 5f72 656d 5f6c 7374  dict, to_rem_lst
+000130f0: 2029 3a0a 0a20 2020 2063 7473 203d 206c   ):..    cts = l
+00013100: 6973 7428 6d6b 725f 6469 6374 2e6b 6579  ist(mkr_dict.key
+00013110: 7328 2929 0a20 2020 2069 6620 6c65 6e28  s()).    if len(
+00013120: 746f 5f72 656d 5f6c 7374 2920 3e20 303a  to_rem_lst) > 0:
+00013130: 0a20 2020 2020 2020 2066 6f72 2063 2069  .        for c i
+00013140: 6e20 6374 733a 0a20 2020 2020 2020 2020  n cts:.         
+00013150: 2020 2069 6620 6320 696e 2074 6f5f 7265     if c in to_re
+00013160: 6d5f 6c73 743a 0a20 2020 2020 2020 2020  m_lst:.         
+00013170: 2020 2020 2020 2064 656c 206d 6b72 5f64         del mkr_d
+00013180: 6963 745b 635d 0a20 2020 2020 2020 2020  ict[c].         
+00013190: 2020 2020 2020 200a 2020 2020 7265 7475         .    retu
+000131a0: 726e 206d 6b72 5f64 6963 740a 0a0a 6465  rn mkr_dict...de
+000131b0: 6620 6765 745f 6d61 6a28 6976 6563 2c20  f get_maj(ivec, 
+000131c0: 6374 6f2c 2070 5f63 656c 6c73 5f64 6963  cto, p_cells_dic
+000131d0: 742c 2070 5f6d 696e 203d 2030 2e31 293a  t, p_min = 0.1):
+000131e0: 0a0a 2020 2020 6974 656d 7320 3d20 6c69  ..    items = li
+000131f0: 7374 2873 6574 2869 7665 6329 290a 2020  st(set(ivec)).  
+00013200: 2020 6966 206c 656e 2869 7465 6d73 2920    if len(items) 
+00013210: 3d3d 2031 3a0a 2020 2020 2020 2020 7265  == 1:.        re
+00013220: 7475 726e 2063 746f 0a20 2020 200a 2020  turn cto.    .  
+00013230: 2020 4e75 6d20 3d20 6e70 2e7a 6572 6f73    Num = np.zeros
+00013240: 286c 656e 2869 7465 6d73 2929 0a20 2020  (len(items)).   
+00013250: 2053 636f 7265 203d 206e 702e 7a65 726f   Score = np.zero
+00013260: 7328 6c65 6e28 6974 656d 7329 290a 2020  s(len(items)).  
+00013270: 2020 666f 7220 6b2c 2069 7465 6d20 696e    for k, item in
+00013280: 2065 6e75 6d65 7261 7465 2869 7465 6d73   enumerate(items
+00013290: 293a 0a20 2020 2020 2020 2062 203d 2069  ):.        b = i
+000132a0: 7665 6320 3d3d 2069 7465 6d0a 2020 2020  vec == item.    
+000132b0: 2020 2020 4e75 6d5b 6b5d 203d 206e 702e      Num[k] = np.
+000132c0: 7375 6d28 6229 0a20 2020 2020 2020 2027  sum(b).        '
+000132d0: 2727 0a20 2020 2020 2020 2069 6620 6974  ''.        if it
+000132e0: 656d 2069 6e20 6c69 7374 2870 5f63 656c  em in list(p_cel
+000132f0: 6c73 5f64 6963 742e 6b65 7973 2829 293a  ls_dict.keys()):
+00013300: 0a20 2020 2020 2020 2020 2020 2053 636f  .            Sco
+00013310: 7265 5b6b 5d20 3d20 6e70 2e73 756d 2862  re[k] = np.sum(b
+00013320: 292a 705f 6365 6c6c 735f 6469 6374 5b69  )*p_cells_dict[i
+00013330: 7465 6d5d 0a20 2020 2020 2020 2065 6c73  tem].        els
+00013340: 653a 200a 2020 2020 2020 2020 2020 2020  e: .            
+00013350: 5363 6f72 655b 6b5d 203d 2030 0a20 2020  Score[k] = 0.   
+00013360: 2020 2020 2023 2727 270a 2020 2020 6b20       #'''.    k 
+00013370: 3d20 6e70 2e61 7267 6d61 7828 4e75 6d29  = np.argmax(Num)
+00013380: 0a0a 2020 2020 6220 3d20 4661 6c73 650a  ..    b = False.
+00013390: 2020 2020 6966 2069 7465 6d73 5b6b 5d20      if items[k] 
+000133a0: 3d3d 2053 5452 5f55 4e41 5353 4947 4e45  == STR_UNASSIGNE
+000133b0: 443a 0a20 2020 2020 2020 206f 6472 203d  D:.        odr =
+000133c0: 2028 2d4e 756d 292e 6172 6773 6f72 7428   (-Num).argsort(
+000133d0: 2920 2020 2020 2020 200a 2020 2020 2020  )        .      
+000133e0: 2020 6966 206c 656e 286f 6472 2920 3e20    if len(odr) > 
+000133f0: 313a 0a20 2020 2020 2020 2020 2020 2069  1:.            i
+00013400: 6620 4e75 6d5b 6f64 725b 315d 5d20 3e3d  f Num[odr[1]] >=
+00013410: 2072 6f75 6e64 286e 702e 7375 6d28 4e75   round(np.sum(Nu
+00013420: 6d29 2a28 705f 6d69 6e29 293a 0a20 2020  m)*(p_min)):.   
+00013430: 2020 2020 2020 2020 2020 2020 206b 203d               k =
+00013440: 206f 6472 5b31 5d0a 2020 2020 2020 2020   odr[1].        
+00013450: 2020 2020 2320 656c 6966 204e 756d 5b6b      # elif Num[k
+00013460: 5d20 3c3d 2072 6f75 6e64 286e 702e 7375  ] <= round(np.su
+00013470: 6d28 4e75 6d29 2a28 312d 705f 6d69 6e29  m(Num)*(1-p_min)
+00013480: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
+00013490: 2020 2020 2072 6574 7572 6e20 6374 6f0a       return cto.
+000134a0: 2020 2020 2020 200a 2020 2020 7265 7475         .    retu
+000134b0: 726e 2020 6974 656d 735b 6b5d 0a0a 0a64  rn  items[k]...d
+000134c0: 6566 2061 7070 6c79 5f6b 6e6e 286e 6569  ef apply_knn(nei
+000134d0: 5f69 6e64 6963 6573 2c20 6365 6c6c 5f74  _indices, cell_t
+000134e0: 7970 652c 2073 636f 7265 2c20 706d 616a  ype, score, pmaj
+000134f0: 203d 2030 2e32 352c 206e 6c6f 675f 7076   = 0.25, nlog_pv
+00013500: 616c 5f74 6820 3d20 3229 3a0a 0a20 2020  al_th = 2):..   
+00013510: 2063 656c 6c5f 7479 7065 5f6e 6577 203d   cell_type_new =
+00013520: 2063 656c 6c5f 7479 7065 2e63 6f70 7928   cell_type.copy(
+00013530: 6465 6570 203d 2054 7275 6529 0a20 2020  deep = True).   
+00013540: 2069 6478 5f61 7279 203d 2063 656c 6c5f   idx_ary = cell_
+00013550: 7479 7065 2e69 6e64 6578 2e76 616c 7565  type.index.value
+00013560: 730a 2020 2020 4e5f 6e65 6920 3d20 6e65  s.    N_nei = ne
+00013570: 695f 696e 6469 6365 732e 7368 6170 655b  i_indices.shape[
+00013580: 315d 0a20 2020 2073 6964 785f 6172 7920  1].    sidx_ary 
+00013590: 3d20 7363 6f72 652e 696e 6465 782e 7661  = score.index.va
+000135a0: 6c75 6573 0a20 2020 2073 636f 7265 3220  lues.    score2 
+000135b0: 3d20 7363 6f72 652e 636f 7079 2864 6565  = score.copy(dee
+000135c0: 7020 3d20 5472 7565 290a 2020 2020 666f  p = True).    fo
+000135d0: 7220 6b20 696e 2072 616e 6765 2820 6c65  r k in range( le
+000135e0: 6e28 6365 6c6c 5f74 7970 6529 2029 3a0a  n(cell_type) ):.
+000135f0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00013600: 2023 2320 5570 6461 7465 2043 656c 6c20   ## Update Cell 
+00013610: 7479 7065 2075 7369 6e67 206d 616a 6f72  type using major
+00013620: 6974 7920 766f 746f 6e67 0a20 2020 2020  ity votong.     
+00013630: 2020 206e 6c73 7420 3d20 6c69 7374 286e     nlst = list(n
+00013640: 6569 5f69 6e64 6963 6573 2e69 6c6f 635b  ei_indices.iloc[
+00013650: 6b2c 3a5d 2e61 7374 7970 6528 696e 7429  k,:].astype(int)
+00013660: 290a 2020 2020 2020 2020 696c 7374 203d  ).        ilst =
+00013670: 2069 6478 5f61 7279 5b6e 6c73 745d 0a20   idx_ary[nlst]. 
+00013680: 2020 2020 2020 2063 7473 203d 2063 656c         cts = cel
+00013690: 6c5f 7479 7065 5b20 6c69 7374 2869 6c73  l_type[ list(ils
+000136a0: 7429 205d 0a20 2020 2020 2020 2069 6620  t) ].        if 
+000136b0: 6c65 6e28 7365 7428 6c69 7374 2863 7473  len(set(list(cts
+000136c0: 2929 2920 3c3d 2031 3a0a 2020 2020 2020  ))) <= 1:.      
+000136d0: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
+000136e0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000136f0: 2020 2020 2063 6e74 5f74 626c 203d 2063       cnt_tbl = c
+00013700: 7473 2e76 616c 7565 5f63 6f75 6e74 7328  ts.value_counts(
+00013710: 290a 2020 2020 2020 2020 2020 2020 6d61  ).            ma
+00013720: 6a6f 7269 7479 203d 2063 6e74 5f74 626c  jority = cnt_tbl
+00013730: 2e69 6e64 6578 2e76 616c 7565 735b 305d  .index.values[0]
+00013740: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00013750: 206d 616a 6f72 6974 7920 3d3d 2027 756e   majority == 'un
+00013760: 6173 7369 676e 6564 273a 0a20 2020 2020  assigned':.     
+00013770: 2020 2020 2020 2020 2020 206d 616a 6f72             major
+00013780: 6974 7920 3d20 636e 745f 7462 6c2e 696e  ity = cnt_tbl.in
+00013790: 6465 782e 7661 6c75 6573 5b31 5d0a 2020  dex.values[1].  
+000137a0: 2020 2020 2020 2020 2020 2020 2020 6365                ce
+000137b0: 6c6c 5f74 7970 655f 6e65 775b 6964 785f  ll_type_new[idx_
+000137c0: 6172 795b 6b5d 5d20 3d20 636e 745f 7462  ary[k]] = cnt_tb
+000137d0: 6c2e 696e 6465 782e 7661 6c75 6573 5b31  l.index.values[1
+000137e0: 5d0a 2020 2020 2020 2020 2020 2020 656c  ].            el
+000137f0: 7365 3a20 0a20 2020 2020 2020 2020 2020  se: .           
+00013800: 2020 2020 2069 6620 2863 656c 6c5f 7479       if (cell_ty
+00013810: 7065 5b6b 5d20 3d3d 2027 756e 6173 7369  pe[k] == 'unassi
+00013820: 676e 6564 2729 3a0a 2020 2020 2020 2020  gned'):.        
+00013830: 2020 2020 2020 2020 2020 2020 6365 6c6c              cell
+00013840: 5f74 7970 655f 6e65 775b 6964 785f 6172  _type_new[idx_ar
+00013850: 795b 6b5d 5d20 3d20 6d61 6a6f 7269 7479  y[k]] = majority
+00013860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013870: 2065 6c69 6620 2873 636f 7265 2e6c 6f63   elif (score.loc
+00013880: 5b73 6964 785f 6172 795b 6b5d 2c20 6365  [sidx_ary[k], ce
+00013890: 6c6c 5f74 7970 655b 6b5d 5d20 3c20 6e6c  ll_type[k]] < nl
+000138a0: 6f67 5f70 7661 6c5f 7468 293a 0a20 2020  og_pval_th):.   
+000138b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000138c0: 2063 656c 6c5f 7479 7065 5f6e 6577 5b69   cell_type_new[i
+000138d0: 6478 5f61 7279 5b6b 5d5d 203d 206d 616a  dx_ary[k]] = maj
+000138e0: 6f72 6974 790a 2020 2020 2020 2020 2020  ority.          
+000138f0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00013900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013910: 6966 2063 6e74 5f74 626c 5b6d 616a 6f72  if cnt_tbl[major
+00013920: 6974 795d 203e 204e 5f6e 6569 2a70 6d61  ity] > N_nei*pma
+00013930: 6a3a 0a20 2020 2020 2020 2020 2020 2020  j:.             
+00013940: 2020 2020 2020 2020 2020 2063 656c 6c5f             cell_
+00013950: 7479 7065 5f6e 6577 5b69 6478 5f61 7279  type_new[idx_ary
+00013960: 5b6b 5d5d 203d 206d 616a 6f72 6974 790a  [k]] = majority.
+00013970: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00013980: 2020 2020 2020 2020 2023 2320 5570 6461           ## Upda
+00013990: 7465 2073 636f 7265 0a20 2020 2020 2020  te score.       
+000139a0: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
+000139b0: 2020 2020 2073 6d20 3d20 7363 6f72 652e       sm = score.
+000139c0: 6c6f 635b 696c 7374 2c3a 5d2e 7375 6d28  loc[ilst,:].sum(
+000139d0: 6178 6973 3d30 290a 2020 2020 2020 2020  axis=0).        
+000139e0: 2020 2020 7363 6f72 6532 2e69 6c6f 635b      score2.iloc[
+000139f0: 6b2c 3a5d 203d 206c 6973 7428 2073 6d20  k,:] = list( sm 
+00013a00: 290a 2020 2020 2020 2020 2020 2020 2327  ).            #'
+00013a10: 2727 0a20 2020 2020 2020 2020 2020 200a  ''.            .
+00013a20: 2020 2020 7265 7475 726e 2063 656c 6c5f      return cell_
+00013a30: 7479 7065 5f6e 6577 2c20 7363 6f72 6532  type_new, score2
+00013a40: 0a20 2020 200a 0a64 6566 2061 7070 6c79  .    ..def apply
+00013a50: 5f6b 6e6e 3128 6e65 695f 696e 6469 6365  _knn1(nei_indice
+00013a60: 732c 2063 656c 6c5f 7479 7065 2c20 7363  s, cell_type, sc
+00013a70: 6f72 652c 2070 6d61 6a20 3d20 302e 3235  ore, pmaj = 0.25
+00013a80: 2c20 6e6c 6f67 5f70 7661 6c5f 7468 203d  , nlog_pval_th =
+00013a90: 2032 293a 0a0a 2020 2020 6365 6c6c 5f74   2):..    cell_t
+00013aa0: 7970 655f 6e65 7720 3d20 6365 6c6c 5f74  ype_new = cell_t
+00013ab0: 7970 652e 636f 7079 2864 6565 7020 3d20  ype.copy(deep = 
+00013ac0: 5472 7565 290a 2020 2020 6964 785f 6172  True).    idx_ar
+00013ad0: 7920 3d20 6365 6c6c 5f74 7970 652e 696e  y = cell_type.in
+00013ae0: 6465 782e 7661 6c75 6573 0a20 2020 204e  dex.values.    N
+00013af0: 5f6e 6569 203d 206e 6569 5f69 6e64 6963  _nei = nei_indic
+00013b00: 6573 2e73 6861 7065 5b31 5d0a 2020 2020  es.shape[1].    
+00013b10: 7369 6478 5f61 7279 203d 2073 636f 7265  sidx_ary = score
+00013b20: 2e69 6e64 6578 2e76 616c 7565 730a 2020  .index.values.  
+00013b30: 2020 7363 6f72 6532 203d 2073 636f 7265    score2 = score
+00013b40: 2e63 6f70 7928 6465 6570 203d 2054 7275  .copy(deep = Tru
+00013b50: 6529 0a20 2020 2066 6f72 206b 2069 6e20  e).    for k in 
+00013b60: 7261 6e67 6528 206c 656e 2863 656c 6c5f  range( len(cell_
+00013b70: 7479 7065 2920 293a 0a20 2020 2020 2020  type) ):.       
+00013b80: 200a 2020 2020 2020 2020 2323 2055 7064   .        ## Upd
+00013b90: 6174 6520 4365 6c6c 2074 7970 6520 7573  ate Cell type us
+00013ba0: 696e 6720 6d61 6a6f 7269 7479 2076 6f74  ing majority vot
+00013bb0: 6f6e 670a 2020 2020 2020 2020 6e6c 7374  ong.        nlst
+00013bc0: 203d 206c 6973 7428 6e65 695f 696e 6469   = list(nei_indi
+00013bd0: 6365 732e 696c 6f63 5b6b 2c3a 5d2e 6173  ces.iloc[k,:].as
+00013be0: 7479 7065 2869 6e74 2929 0a20 2020 2020  type(int)).     
+00013bf0: 2020 2069 6c73 7420 3d20 6964 785f 6172     ilst = idx_ar
+00013c00: 795b 6e6c 7374 5d0a 2020 2020 2020 2020  y[nlst].        
+00013c10: 6374 7320 3d20 6365 6c6c 5f74 7970 655b  cts = cell_type[
+00013c20: 206c 6973 7428 696c 7374 2920 5d0a 2020   list(ilst) ].  
+00013c30: 2020 2020 2020 6966 206c 656e 2873 6574        if len(set
+00013c40: 286c 6973 7428 6374 7329 2929 203c 3d20  (list(cts))) <= 
+00013c50: 313a 0a20 2020 2020 2020 2020 2020 2070  1:.            p
+00013c60: 6173 730a 2020 2020 2020 2020 656c 7365  ass.        else
+00013c70: 3a0a 2020 2020 2020 2020 2020 2020 636e  :.            cn
+00013c80: 745f 7462 6c20 3d20 6374 732e 7661 6c75  t_tbl = cts.valu
+00013c90: 655f 636f 756e 7473 2829 0a20 2020 2020  e_counts().     
+00013ca0: 2020 2020 2020 206d 616a 6f72 6974 7920         majority 
+00013cb0: 3d20 636e 745f 7462 6c2e 696e 6465 782e  = cnt_tbl.index.
+00013cc0: 7661 6c75 6573 5b30 5d0a 0a20 2020 2020  values[0]..     
+00013cd0: 2020 2020 2020 2069 6620 6d61 6a6f 7269         if majori
+00013ce0: 7479 203d 3d20 2775 6e61 7373 6967 6e65  ty == 'unassigne
+00013cf0: 6427 3a0a 2020 2020 2020 2020 2020 2020  d':.            
+00013d00: 2020 2020 6d61 6a6f 7269 7479 203d 2063      majority = c
+00013d10: 6e74 5f74 626c 2e69 6e64 6578 2e76 616c  nt_tbl.index.val
+00013d20: 7565 735b 315d 0a20 2020 2020 2020 2020  ues[1].         
+00013d30: 2020 2020 2020 2063 656c 6c5f 7479 7065         cell_type
+00013d40: 5f6e 6577 5b69 6478 5f61 7279 5b6b 5d5d  _new[idx_ary[k]]
+00013d50: 203d 206d 616a 6f72 6974 790a 2020 2020   = majority.    
+00013d60: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00013d70: 2020 2020 2020 2020 2069 6620 636e 745f           if cnt_
+00013d80: 7462 6c5b 6d61 6a6f 7269 7479 5d20 3e20  tbl[majority] > 
+00013d90: 4e5f 6e65 692a 706d 616a 3a0a 2020 2020  N_nei*pmaj:.    
+00013da0: 2020 2020 2020 2020 2020 2020 6365 6c6c              cell
+00013db0: 5f74 7970 655f 6e65 775b 6964 785f 6172  _type_new[idx_ar
+00013dc0: 795b 6b5d 5d20 3d20 6d61 6a6f 7269 7479  y[k]] = majority
+00013dd0: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
+00013de0: 2020 2020 2020 2020 2020 2323 2055 7064            ## Upd
+00013df0: 6174 6520 7363 6f72 650a 2020 2020 2020  ate score.      
+00013e00: 2020 2020 2020 2327 2727 0a20 2020 2020        #'''.     
+00013e10: 2020 2020 2020 2062 203d 2063 7473 203d         b = cts =
+00013e20: 3d20 6d61 6a6f 7269 7479 0a20 2020 2020  = majority.     
+00013e30: 2020 2020 2020 2073 6d20 3d20 7363 6f72         sm = scor
+00013e40: 652e 6c6f 635b 696c 7374 2c3a 5d2e 6d65  e.loc[ilst,:].me
+00013e50: 616e 2861 7869 733d 3029 0a20 2020 2020  an(axis=0).     
+00013e60: 2020 2020 2020 2073 636f 7265 322e 696c         score2.il
+00013e70: 6f63 5b6b 2c3a 5d20 3d20 6c69 7374 2820  oc[k,:] = list( 
+00013e80: 736d 2029 0a20 2020 2020 2020 2020 2020  sm ).           
+00013e90: 2023 2727 270a 2020 2020 2020 2020 2020   #'''.          
+00013ea0: 2020 0a20 2020 2072 6574 7572 6e20 6365    .    return ce
+00013eb0: 6c6c 5f74 7970 655f 6e65 772c 2073 636f  ll_type_new, sco
+00013ec0: 7265 320a 2020 2020 0a0a 6465 6620 6170  re2.    ..def ap
+00013ed0: 706c 795f 6b6e 6e32 286e 6569 5f69 6e64  ply_knn2(nei_ind
+00013ee0: 6963 6573 2c20 6365 6c6c 5f74 7970 652c  ices, cell_type,
+00013ef0: 2073 636f 7265 2c20 706d 616a 203d 2030   score, pmaj = 0
+00013f00: 2e35 2c20 6e6c 6f67 5f70 7661 6c5f 7468  .5, nlog_pval_th
+00013f10: 203d 2032 293a 0a0a 2020 2020 6365 6c6c   = 2):..    cell
+00013f20: 5f74 7970 655f 6e65 7720 3d20 6365 6c6c  _type_new = cell
+00013f30: 5f74 7970 652e 636f 7079 2864 6565 7020  _type.copy(deep 
+00013f40: 3d20 5472 7565 290a 2020 2020 6964 785f  = True).    idx_
+00013f50: 6172 7920 3d20 6365 6c6c 5f74 7970 652e  ary = cell_type.
+00013f60: 696e 6465 782e 7661 6c75 6573 0a20 2020  index.values.   
+00013f70: 204e 5f6e 6569 203d 206e 6569 5f69 6e64   N_nei = nei_ind
+00013f80: 6963 6573 2e73 6861 7065 5b31 5d0a 2020  ices.shape[1].  
+00013f90: 2020 7363 6f72 6532 203d 2073 636f 7265    score2 = score
+00013fa0: 2e63 6f70 7928 6465 6570 203d 2054 7275  .copy(deep = Tru
+00013fb0: 6529 0a20 2020 2066 6f72 206b 2069 6e20  e).    for k in 
+00013fc0: 7261 6e67 6528 206c 656e 2863 656c 6c5f  range( len(cell_
+00013fd0: 7479 7065 2920 293a 0a20 2020 2020 2020  type) ):.       
+00013fe0: 206e 6c73 7420 3d20 6c69 7374 286e 6569   nlst = list(nei
+00013ff0: 5f69 6e64 6963 6573 2e69 6c6f 635b 6b2c  _indices.iloc[k,
+00014000: 3a5d 2e61 7374 7970 6528 696e 7429 290a  :].astype(int)).
+00014010: 2020 2020 2020 2020 696c 7374 203d 206c          ilst = l
+00014020: 6973 7428 6964 785f 6172 795b 6e6c 7374  ist(idx_ary[nlst
+00014030: 5d29 0a20 2020 2020 2020 2073 6d20 3d20  ]).        sm = 
+00014040: 7363 6f72 652e 6c6f 635b 696c 7374 2c3a  score.loc[ilst,:
+00014050: 5d2e 6d65 616e 2861 7869 733d 3029 0a20  ].mean(axis=0). 
+00014060: 2020 2020 2020 2073 636f 7265 322e 696c         score2.il
+00014070: 6f63 5b6b 2c3a 5d20 3d20 6c69 7374 2820  oc[k,:] = list( 
+00014080: 736d 2029 0a20 2020 2020 2020 200a 2020  sm ).        .  
+00014090: 2020 2323 2055 7064 6174 6520 4365 6c6c    ## Update Cell
+000140a0: 2074 7970 6520 7573 696e 6720 7570 6461   type using upda
+000140b0: 7465 6420 7363 6f72 650a 2020 2020 6365  ted score.    ce
+000140c0: 6c6c 5f74 7970 655f 6e65 7720 3d20 7363  ll_type_new = sc
+000140d0: 6f72 6532 2e69 6478 6d61 7828 6178 6973  ore2.idxmax(axis
+000140e0: 203d 2031 290a 2020 2020 2020 2020 2020   = 1).          
+000140f0: 2020 0a20 2020 2072 6574 7572 6e20 6365    .    return ce
+00014100: 6c6c 5f74 7970 655f 6e65 772c 2073 636f  ll_type_new, sco
+00014110: 7265 320a 2020 2020 0a0a 6465 6620 6765  re2.    ..def ge
+00014120: 745f 7374 6174 5f67 7361 2820 6466 5f73  t_stat_gsa( df_s
+00014130: 636f 7265 2029 3a0a 2020 2020 0a20 2020  core ):.    .   
+00014140: 2064 6620 3d20 6466 5f73 636f 7265 0a20   df = df_score. 
+00014150: 2020 206e 616d 6520 3d20 6c69 7374 2864     name = list(d
+00014160: 662e 636f 6c75 6d6e 732e 7661 6c75 6573  f.columns.values
+00014170: 290a 2020 2020 0a20 2020 2069 6620 6466  ).    .    if df
+00014180: 2e73 6861 7065 5b31 5d20 3d3d 2031 3a0a  .shape[1] == 1:.
+00014190: 2020 2020 2020 2020 6320 3d20 6e61 6d65          c = name
+000141a0: 5b30 5d0a 2020 2020 2020 2020 6e65 675f  [0].        neg_
+000141b0: 6c6f 675f 7076 616c 203d 2064 665b 635d  log_pval = df[c]
+000141c0: 0a20 2020 2020 2020 2073 7562 7479 7065  .        subtype
+000141d0: 203d 205b 635d 2a64 662e 7368 6170 655b   = [c]*df.shape[
+000141e0: 305d 0a20 2020 2020 2020 200a 2020 2020  0].        .    
+000141f0: 2020 2020 6466 5f72 6573 203d 2070 642e      df_res = pd.
+00014200: 4461 7461 4672 616d 6528 7b27 6365 6c6c  DataFrame({'cell
+00014210: 5f74 7970 6527 3a20 7375 6274 7970 652c  _type': subtype,
+00014220: 2027 6365 6c6c 5f74 7970 6528 7265 7629   'cell_type(rev)
+00014230: 273a 2073 7562 7479 7065 2c20 0a20 2020  ': subtype, .   
+00014240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014250: 2020 2020 2020 2020 2020 2020 2763 656c              'cel
+00014260: 6c5f 7479 7065 2831 7374 2927 3a20 7375  l_type(1st)': su
+00014270: 6274 7970 652c 2027 4f76 6572 6c61 7027  btype, 'Overlap'
+00014280: 3a20 5b27 2d27 5d2a 6466 2e73 6861 7065  : ['-']*df.shape
+00014290: 5b30 5d20 7d2c 0a20 2020 2020 2020 2020  [0] },.         
+000142a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000142b0: 2020 2020 2020 696e 6465 7820 3d20 6466        index = df
+000142c0: 2e69 6e64 6578 2e76 616c 7565 7329 0a20  .index.values). 
+000142d0: 2020 2020 2020 2064 665f 7265 735b 2763         df_res['c
+000142e0: 656c 6c5f 7479 7065 2832 6e64 2927 5d20  ell_type(2nd)'] 
+000142f0: 3d20 7375 6274 7970 650a 2020 2020 2020  = subtype.      
+00014300: 2020 6466 5f72 6573 5b27 4f76 6572 6c61    df_res['Overla
+00014310: 7028 326e 6429 275d 203d 205b 272d 275d  p(2nd)'] = ['-']
+00014320: 2a64 662e 7368 6170 655b 305d 0a20 2020  *df.shape[0].   
+00014330: 2020 2020 2064 665f 7265 735b 2743 6c61       df_res['Cla
+00014340: 7269 7479 275d 203d 205b 272d 275d 2a64  rity'] = ['-']*d
+00014350: 662e 7368 6170 655b 305d 0a20 2020 2020  f.shape[0].     
+00014360: 2020 2064 665f 7265 735b 272d 6c6f 6750     df_res['-logP
+00014370: 275d 203d 2064 665b 635d 0a20 2020 2020  '] = df[c].     
+00014380: 2020 2064 665f 7265 735b 272d 6c6f 6750     df_res['-logP
+00014390: 2832 6e64 2927 5d20 3d20 5b30 5d2a 6466  (2nd)'] = [0]*df
+000143a0: 2e73 6861 7065 5b30 5d0a 2020 2020 2020  .shape[0].      
+000143b0: 2020 6466 5f72 6573 5b27 2d6c 6f67 502d    df_res['-logP-
+000143c0: 6c6f 6750 2832 6e64 2927 5d20 3d20 6466  logP(2nd)'] = df
+000143d0: 5b63 5d0a 2020 2020 656c 7365 3a0a 2020  [c].    else:.  
+000143e0: 2020 2020 2020 6d61 7876 203d 206c 6973        maxv = lis
+000143f0: 7428 6466 2e6d 6178 2861 7869 7320 3d20  t(df.max(axis = 
+00014400: 3129 290a 2020 2020 2020 2020 7375 6274  1)).        subt
+00014410: 7970 6520 3d20 6c69 7374 2864 662e 6964  ype = list(df.id
+00014420: 786d 6178 2861 7869 7320 3d20 3129 290a  xmax(axis = 1)).
+00014430: 2020 2020 2020 2020 2374 635f 7375 6274          #tc_subt
+00014440: 7970 6520 3d20 5b74 7261 6e73 5f64 6963  ype = [trans_dic
+00014450: 745b 6b5d 2066 6f72 206b 2069 6e20 7463  t[k] for k in tc
+00014460: 5f73 7562 7479 7065 5d0a 0a20 2020 2020  _subtype]..     
+00014470: 2020 206d 6178 7632 203d 205b 5d0a 2020     maxv2 = [].  
+00014480: 2020 2020 2020 6964 7832 203d 205b 5d0a        idx2 = [].
+00014490: 2020 2020 2020 2020 7375 6274 7970 655f          subtype_
+000144a0: 6c73 7420 3d20 6c69 7374 2864 662e 636f  lst = list(df.co
+000144b0: 6c75 6d6e 732e 7661 6c75 6573 290a 0a20  lumns.values).. 
+000144c0: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+000144d0: 7261 6e67 6528 6466 2e73 6861 7065 5b30  range(df.shape[0
+000144e0: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
+000144f0: 7820 3d20 6e70 2e61 7272 6179 2864 662e  x = np.array(df.
+00014500: 696c 6f63 5b69 5d29 0a20 2020 2020 2020  iloc[i]).       
+00014510: 2020 2020 206f 6472 203d 2028 2d78 292e       odr = (-x).
+00014520: 6172 6773 6f72 7428 290a 2020 2020 2020  argsort().      
+00014530: 2020 2020 2020 6966 206c 656e 2878 2920        if len(x) 
+00014540: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
+00014550: 2020 2020 206d 6178 7632 2e61 7070 656e       maxv2.appen
+00014560: 6428 785b 6f64 725b 315d 5d29 0a20 2020  d(x[odr[1]]).   
+00014570: 2020 2020 2020 2020 2020 2020 2069 6478               idx
+00014580: 322e 6170 7065 6e64 2873 7562 7479 7065  2.append(subtype
+00014590: 5f6c 7374 5b6f 6472 5b31 5d5d 290a 2020  _lst[odr[1]]).  
+000145a0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+000145b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000145c0: 6d61 7876 322e 6170 7065 6e64 2830 290a  maxv2.append(0).
+000145d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000145e0: 6964 7832 2e61 7070 656e 6428 4e6f 6e65  idx2.append(None
+000145f0: 290a 0a20 2020 2020 2020 2064 665f 7265  )..        df_re
+00014600: 7320 3d20 7064 2e44 6174 6146 7261 6d65  s = pd.DataFrame
+00014610: 287b 2763 656c 6c5f 7479 7065 273a 2073  ({'cell_type': s
+00014620: 7562 7479 7065 2c20 2763 656c 6c5f 7479  ubtype, 'cell_ty
+00014630: 7065 2872 6576 2927 3a20 7375 6274 7970  pe(rev)': subtyp
+00014640: 652c 200a 2020 2020 2020 2020 2020 2020  e, .            
+00014650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014660: 2020 2027 6365 6c6c 5f74 7970 6528 3173     'cell_type(1s
+00014670: 7429 273a 2073 7562 7479 7065 2c20 274f  t)': subtype, 'O
+00014680: 7665 726c 6170 273a 205b 272d 275d 2a64  verlap': ['-']*d
+00014690: 662e 7368 6170 655b 305d 2c0a 2020 2020  f.shape[0],.    
+000146a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000146b0: 2020 2020 2020 2020 2020 2027 6365 6c6c             'cell
+000146c0: 5f74 7970 6528 326e 6429 273a 2069 6478  _type(2nd)': idx
+000146d0: 322c 2027 4f76 6572 6c61 7028 326e 6429  2, 'Overlap(2nd)
+000146e0: 273a 205b 272d 275d 2a64 662e 7368 6170  ': ['-']*df.shap
+000146f0: 655b 305d 2c0a 2020 2020 2020 2020 2020  e[0],.          
+00014700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014710: 2020 2020 2027 436c 6172 6974 7927 3a20       'Clarity': 
+00014720: 5b27 2d27 5d2a 6466 2e73 6861 7065 5b30  ['-']*df.shape[0
+00014730: 5d2c 2027 2d6c 6f67 5027 3a20 6d61 7876  ], '-logP': maxv
+00014740: 2c20 272d 6c6f 6750 2832 6e64 2927 3a20  , '-logP(2nd)': 
+00014750: 6d61 7876 327d 2c20 0a20 2020 2020 2020  maxv2}, .       
+00014760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014770: 2020 2020 2020 2069 6e64 6578 203d 2064         index = d
+00014780: 662e 696e 6465 782e 7661 6c75 6573 290a  f.index.values).
+00014790: 2020 2020 2020 2020 6466 5f72 6573 5b27          df_res['
+000147a0: 2d6c 6f67 502d 6c6f 6750 2832 6e64 2927  -logP-logP(2nd)'
+000147b0: 5d20 3d20 6466 5f72 6573 5b27 2d6c 6f67  ] = df_res['-log
+000147c0: 5027 5d20 2d20 6466 5f72 6573 5b27 2d6c  P'] - df_res['-l
+000147d0: 6f67 5028 326e 6429 275d 0a0a 2020 2020  ogP(2nd)']..    
+000147e0: 7265 7475 726e 2064 665f 7265 730a 0a0a  return df_res...
+000147f0: 6465 6620 6765 745f 6d61 726b 6572 735f  def get_markers_
+00014800: 616c 6c28 6d6b 725f 6669 6c65 2c20 7461  all(mkr_file, ta
+00014810: 7267 6574 5f6c 7374 2c20 706e 7368 3132  rget_lst, pnsh12
+00014820: 2c20 6c65 7665 6c20 3d20 312c 2063 6f6d  , level = 1, com
+00014830: 625f 6d6b 7273 203d 2046 616c 7365 293a  b_mkrs = False):
+00014840: 0a20 2020 200a 2020 2020 2320 7461 7267  .    .    # targ
+00014850: 6574 203d 2027 4d79 656c 6f69 6420 6365  et = 'Myeloid ce
+00014860: 6c6c 270a 2020 2020 6966 206c 6576 656c  ll'.    if level
+00014870: 203d 3d20 313a 0a20 2020 2020 2020 206d   == 1:.        m
+00014880: 6b72 5f64 6963 742c 206d 6b72 5f64 6963  kr_dict, mkr_dic
+00014890: 745f 6e65 6720 3d20 5c0a 2020 2020 2020  t_neg = \.      
+000148a0: 2020 2020 2020 6765 745f 6d61 726b 6572        get_marker
+000148b0: 735f 6d69 6e6f 725f 7479 7065 3228 6d6b  s_minor_type2(mk
+000148c0: 725f 6669 6c65 2c20 7461 7267 6574 5f63  r_file, target_c
+000148d0: 656c 6c73 203d 2074 6172 6765 745f 6c73  ells = target_ls
+000148e0: 742c 200a 2020 2020 2020 2020 2020 2020  t, .            
+000148f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014900: 2020 2020 2020 2020 706e 7368 3132 203d          pnsh12 =
+00014910: 2070 6e73 6831 322c 2072 656d 5f63 6f6d   pnsh12, rem_com
+00014920: 6d6f 6e20 3d20 4661 6c73 652c 0a20 2020  mon = False,.   
+00014930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014950: 2063 6f6d 625f 6d6b 7273 203d 2063 6f6d   comb_mkrs = com
+00014960: 625f 6d6b 7273 2c20 7665 7262 6f73 6520  b_mkrs, verbose 
+00014970: 3d20 4661 6c73 6529 0a20 2020 2065 6c73  = False).    els
+00014980: 653a 0a20 2020 2020 2020 206d 6b72 5f64  e:.        mkr_d
+00014990: 6963 742c 206d 6b72 5f64 6963 745f 6e65  ict, mkr_dict_ne
+000149a0: 6720 3d20 5c0a 2020 2020 2020 2020 2020  g = \.          
+000149b0: 2020 6765 745f 6d61 726b 6572 735f 6365    get_markers_ce
+000149c0: 6c6c 5f74 7970 6528 6d6b 725f 6669 6c65  ll_type(mkr_file
+000149d0: 2c20 7461 7267 6574 5f63 656c 6c73 203d  , target_cells =
+000149e0: 2074 6172 6765 745f 6c73 742c 2070 6e73   target_lst, pns
+000149f0: 6831 3220 3d20 706e 7368 3132 2c0a 2020  h12 = pnsh12,.  
+00014a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a10: 2020 2020 2020 2020 7265 6d5f 636f 6d6d          rem_comm
+00014a20: 6f6e 203d 2046 616c 7365 2c20 7665 7262  on = False, verb
+00014a30: 6f73 6520 3d20 4661 6c73 6529 0a20 2020  ose = False).   
+00014a40: 2020 2020 200a 2020 2020 6d6b 7273 5f61       .    mkrs_a
+00014a50: 6c6c 203d 205b 5d20 235b 2753 454c 4c27  ll = [] #['SELL'
+00014a60: 5d0a 2020 2020 6d6b 7273 5f63 6d6e 203d  ].    mkrs_cmn =
+00014a70: 205b 5d0a 2020 2020 666f 7220 6374 2069   [].    for ct i
+00014a80: 6e20 6d6b 725f 6469 6374 2e6b 6579 7328  n mkr_dict.keys(
+00014a90: 293a 0a20 2020 2020 2020 206d 6b72 735f  ):.        mkrs_
+00014aa0: 616c 6c20 3d20 6d6b 7273 5f61 6c6c 202b  all = mkrs_all +
+00014ab0: 206d 6b72 5f64 6963 745b 6374 5d0a 2020   mkr_dict[ct].  
+00014ac0: 2020 2020 2020 6966 206c 656e 286d 6b72        if len(mkr
+00014ad0: 735f 636d 6e29 203d 3d20 303a 0a20 2020  s_cmn) == 0:.   
+00014ae0: 2020 2020 2020 2020 206d 6b72 735f 636d           mkrs_cm
+00014af0: 6e20 3d20 6d6b 725f 6469 6374 5b63 745d  n = mkr_dict[ct]
+00014b00: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00014b10: 2020 2020 2020 2020 2020 206d 6b72 735f             mkrs_
+00014b20: 636d 6e20 3d20 6c69 7374 2873 6574 286d  cmn = list(set(m
+00014b30: 6b72 735f 636d 6e29 2e69 6e74 6572 7365  krs_cmn).interse
+00014b40: 6374 696f 6e28 6d6b 725f 6469 6374 5b63  ction(mkr_dict[c
+00014b50: 745d 2929 0a0a 2020 2020 6d6b 7273 5f61  t]))..    mkrs_a
+00014b60: 6c6c 203d 206c 6973 7428 7365 7428 6d6b  ll = list(set(mk
+00014b70: 7273 5f61 6c6c 2929 0a20 2020 200a 2020  rs_all)).    .  
+00014b80: 2020 7265 7475 726e 206d 6b72 735f 616c    return mkrs_al
+00014b90: 6c2c 206d 6b72 5f64 6963 740a 0a0a 6465  l, mkr_dict...de
+00014ba0: 6620 4869 4341 5428 2058 5f63 656c 6c5f  f HiCAT( X_cell_
+00014bb0: 6279 5f67 656e 652c 206d 6172 6b65 725f  by_gene, marker_
+00014bc0: 6669 6c65 2c20 6c6f 675f 7472 616e 7366  file, log_transf
+00014bd0: 6f72 6d65 6420 3d20 4661 6c73 652c 0a20  ormed = False,. 
+00014be0: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+00014bf0: 7267 6574 5f74 6973 7375 6573 203d 205b  rget_tissues = [
+00014c00: 5d2c 2074 6172 6765 745f 6365 6c6c 5f74  ], target_cell_t
+00014c10: 7970 6573 203d 205b 5d2c 206d 696e 6f72  ypes = [], minor
+00014c20: 5f74 7970 6573 5f74 6f5f 6578 636c 7564  _types_to_exclud
+00014c30: 6520 3d20 5b5d 2c20 0a20 2020 2020 2020  e = [], .       
+00014c40: 2020 2020 2020 2020 6d6b 725f 7365 6c65          mkr_sele
+00014c50: 6374 6f72 203d 2050 4e53 4831 322c 204e  ctor = PNSH12, N
+00014c60: 5f6e 6569 6768 626f 7273 5f6d 696e 6f72  _neighbors_minor
+00014c70: 203d 2033 312c 204e 5f6e 6569 6768 626f   = 31, N_neighbo
+00014c80: 7273 5f73 7562 7365 7420 3d20 312c 2020  rs_subset = 1,  
+00014c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014ca0: 436c 7573 7465 7269 6e67 5f61 6c67 6f20  Clustering_algo 
+00014cb0: 3d20 276c 7627 2c20 436c 7573 7465 7269  = 'lv', Clusteri
+00014cc0: 6e67 5f72 6573 6f6c 7574 696f 6e20 3d20  ng_resolution = 
+00014cd0: 312c 200a 2020 2020 2020 2020 2020 2020  1, .            
+00014ce0: 2020 2043 6c75 7374 6572 696e 675f 6261     Clustering_ba
+00014cf0: 7365 203d 2027 7063 6127 2c20 4e5f 7063  se = 'pca', N_pc
+00014d00: 615f 636f 6d70 6f6e 656e 7473 203d 2031  a_components = 1
+00014d10: 352c 200a 2020 2020 2020 2020 2020 2020  5, .            
+00014d20: 2020 2063 7963 6c69 6e67 5f63 656c 6c20     cycling_cell 
+00014d30: 3d20 4661 6c73 652c 2063 6f70 795f 5820  = False, copy_X 
+00014d40: 3d20 4661 6c73 652c 2076 6572 626f 7365  = False, verbose
+00014d50: 203d 2046 616c 7365 2c0a 2020 2020 2020   = False,.      
+00014d60: 2020 2020 2020 2020 206d 6f64 656c 203d           model =
+00014d70: 2027 676d 6d27 2c20 4e5f 676d 6d5f 636f   'gmm', N_gmm_co
+00014d80: 6d70 6f6e 656e 7473 203d 2031 302c 2063  mponents = 10, c
+00014d90: 6263 5f63 7574 6f66 6620 3d20 302e 3031  bc_cutoff = 0.01
+00014da0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00014db0: 2054 6172 6765 745f 4650 5220 3d20 302e   Target_FPR = 0.
+00014dc0: 3035 2c20 7076 616c 5f74 6820 3d20 302e  05, pval_th = 0.
+00014dd0: 3035 2c20 7076 616c 5f74 685f 7375 6273  05, pval_th_subs
+00014de0: 6574 203d 2031 2c20 0a20 2020 2020 2020  et = 1, .       
+00014df0: 2020 2020 2020 2020 706d 616a 203d 2030          pmaj = 0
+00014e00: 2e37 2c20 7074 685f 6669 745f 706e 7420  .7, pth_fit_pnt 
+00014e10: 3d20 302e 342c 2070 7468 5f6d 696e 203d  = 0.4, pth_min =
+00014e20: 2030 2e35 2c20 6d69 6e5f 6c6f 6750 5f64   0.5, min_logP_d
+00014e30: 6966 6620 3d20 312c 200a 2020 2020 2020  iff = 1, .      
+00014e40: 2020 2020 2020 2020 2075 7365 5f6d 696e           use_min
+00014e50: 6f72 203d 2054 7275 652c 206d 696e 6f72  or = True, minor
+00014e60: 5f77 6774 203d 2030 2c20 7573 655f 756e  _wgt = 0, use_un
+00014e70: 696f 6e20 3d20 4661 6c73 652c 2075 7365  ion = False, use
+00014e80: 5f75 6e69 6f6e 5f6d 616a 6f72 203d 2054  _union_major = T
+00014e90: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+00014ea0: 2020 2020 7573 655f 6d61 726b 6572 735f      use_markers_
+00014eb0: 666f 725f 7063 6120 3d20 4661 6c73 652c  for_pca = False,
+00014ec0: 2063 6f6d 625f 6d6b 7273 203d 2046 616c   comb_mkrs = Fal
+00014ed0: 7365 2c20 0a20 2020 2020 2020 2020 2020  se, .           
+00014ee0: 2020 2020 6b6e 6e5f 7479 7065 203d 2031      knn_type = 1
+00014ef0: 2c20 6b6e 6e5f 706d 616a 203d 2030 2e33  , knn_pmaj = 0.3
+00014f00: 2c20 4e5f 6d61 785f 746f 5f61 7665 203d  , N_max_to_ave =
+00014f10: 2031 2c0a 2020 2020 2020 2020 2020 2020   1,.            
+00014f20: 2020 2074 6872 6573 686f 6c64 696e 675f     thresholding_
+00014f30: 6d69 6e6f 7220 3d20 4661 6c73 652c 2074  minor = False, t
+00014f40: 6872 6573 686f 6c64 696e 675f 7375 6273  hresholding_subs
+00014f50: 6574 203d 2046 616c 7365 2029 3a0a 0a20  et = False ):.. 
+00014f60: 2020 2069 6620 6c65 6e28 7461 7267 6574     if len(target
+00014f70: 5f63 656c 6c5f 7479 7065 7329 203e 2030  _cell_types) > 0
+00014f80: 3a0a 2020 2020 2020 2020 7061 7373 0a20  :.        pass. 
+00014f90: 2020 2020 2020 2023 2074 6172 6765 745f         # target_
+00014fa0: 6365 6c6c 5f74 7970 6573 203d 2074 6172  cell_types = tar
+00014fb0: 6765 745f 6365 6c6c 5f74 7970 6573 5f69  get_cell_types_i
+00014fc0: 6e0a 2020 2020 656c 6966 206c 656e 2874  n.    elif len(t
+00014fd0: 6172 6765 745f 7469 7373 7565 7329 203e  arget_tissues) >
+00014fe0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00014ff0: 7461 7267 6574 5f63 656c 6c5f 7479 7065  target_cell_type
+00015000: 7320 3d20 6765 745f 7461 7267 6574 5f63  s = get_target_c
+00015010: 656c 6c5f 7479 7065 7328 206d 6172 6b65  ell_types( marke
+00015020: 725f 6669 6c65 2c20 7461 7267 6574 5f74  r_file, target_t
+00015030: 6973 7375 6573 2029 0a20 2020 2020 2020  issues ).       
+00015040: 2020 2020 2023 2070 7269 6e74 2827 5461       # print('Ta
+00015050: 7267 6574 2063 656c 6c20 7479 7065 733a  rget cell types:
+00015060: 2027 2c20 7461 7267 6574 5f63 656c 6c5f   ', target_cell_
+00015070: 7479 7065 7329 0a0a 2020 2020 6966 2043  types)..    if C
+00015080: 4c55 5354 4552 494e 475f 4147 4f20 213d  LUSTERING_AGO !=
+00015090: 2027 6c76 273a 0a20 2020 2020 2020 2043   'lv':.        C
+000150a0: 6c75 7374 6572 696e 675f 616c 676f 203d  lustering_algo =
+000150b0: 2043 4c55 5354 4552 494e 475f 4147 4f0a   CLUSTERING_AGO.
+000150c0: 2020 2020 2020 2020 0a20 2020 2072 656d          .    rem
+000150d0: 5f63 6d6e 5f6d 6b72 203d 2046 616c 7365  _cmn_mkr = False
+000150e0: 0a20 2020 2069 6465 6e74 5f6c 6576 656c  .    ident_level
+000150f0: 203d 2033 0a20 2020 206d 696e 6f72 5f69   = 3.    minor_i
+00015100: 645f 7365 7020 3d20 5472 7565 0a20 2020  d_sep = True.   
+00015110: 200a 2020 2020 6765 6e65 5f6e 616d 6573   .    gene_names
+00015120: 203d 204e 6f6e 650a 2020 2020 6d65 7468   = None.    meth
+00015130: 6f64 203d 206d 6f64 656c 0a20 2020 204e  od = model.    N
+00015140: 5f63 6f6d 706f 6e65 6e74 7320 3d20 4e5f  _components = N_
+00015150: 676d 6d5f 636f 6d70 6f6e 656e 7473 0a20  gmm_components. 
+00015160: 2020 2073 7461 7274 5f74 696d 6520 3d20     start_time = 
+00015170: 7469 6d65 2e74 696d 6528 290a 2020 2020  time.time().    
+00015180: 6469 6374 5f73 756d 6d61 7279 5f72 6573  dict_summary_res
+00015190: 203d 207b 7d0a 2020 2020 6469 6374 5f73   = {}.    dict_s
+000151a0: 756d 6d61 7279 5f73 636f 7265 203d 207b  ummary_score = {
+000151b0: 7d0a 2020 2020 6469 6374 5f73 756d 6d61  }.    dict_summa
+000151c0: 7279 5f73 636f 7265 3220 3d20 7b7d 0a20  ry_score2 = {}. 
+000151d0: 2020 2064 6963 745f 7375 6d6d 6172 795f     dict_summary_
+000151e0: 7363 6f72 6533 203d 207b 7d0a 2020 2020  score3 = {}.    
+000151f0: 0a20 2020 2069 6620 5461 7267 6574 5f46  .    if Target_F
+00015200: 5052 203e 3d20 313a 0a20 2020 2020 2020  PR >= 1:.       
+00015210: 2074 6872 6573 686f 6c64 696e 6720 3d20   thresholding = 
+00015220: 4661 6c73 650a 2020 2020 656c 7365 3a0a  False.    else:.
+00015230: 2020 2020 2020 2020 7468 7265 7368 6f6c          threshol
+00015240: 6469 6e67 203d 2054 7275 650a 2020 2020  ding = True.    
+00015250: 2020 2020 0a20 2020 2069 6620 7665 7262      .    if verb
+00015260: 6f73 653a 2070 7269 6e74 2827 4869 4341  ose: print('HiCA
+00015270: 5420 7275 6e6e 696e 6720 2e2e 2729 0a20  T running ..'). 
+00015280: 2020 2065 6c73 653a 2070 7269 6e74 2827     else: print('
+00015290: 4869 4341 5420 7275 6e6e 696e 6720 2e2e  HiCAT running ..
+000152a0: 272c 2065 6e64 203d 2027 272c 2066 6c75  ', end = '', flu
+000152b0: 7368 203d 2054 7275 6529 0a20 2020 2020  sh = True).     
+000152c0: 2020 200a 2020 2020 6966 2069 7369 6e73     .    if isins
+000152d0: 7461 6e63 6528 585f 6365 6c6c 5f62 795f  tance(X_cell_by_
+000152e0: 6765 6e65 2c20 7064 2e44 6174 6146 7261  gene, pd.DataFra
+000152f0: 6d65 293a 0a20 2020 2020 2020 2069 6620  me):.        if 
+00015300: 636f 7079 5f58 3a0a 2020 2020 2020 2020  copy_X:.        
+00015310: 2020 2020 5873 203d 2058 5f63 656c 6c5f      Xs = X_cell_
+00015320: 6279 5f67 656e 652e 636f 7079 2864 6565  by_gene.copy(dee
+00015330: 703d 5472 7565 290a 2020 2020 2020 2020  p=True).        
+00015340: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00015350: 2020 5873 203d 2058 5f63 656c 6c5f 6279    Xs = X_cell_by
+00015360: 5f67 656e 650a 2020 2020 2020 2020 6765  _gene.        ge
+00015370: 6e65 735f 6c73 745f 6f72 6720 3d20 6c69  nes_lst_org = li
+00015380: 7374 2858 5f63 656c 6c5f 6279 5f67 656e  st(X_cell_by_gen
+00015390: 652e 636f 6c75 6d6e 732e 7661 6c75 6573  e.columns.values
+000153a0: 290a 0a20 2020 2020 2020 2067 656e 6573  )..        genes
+000153b0: 5f6c 7374 203d 205b 5d0a 2020 2020 2020  _lst = [].      
+000153c0: 2020 666f 7220 6720 696e 2067 656e 6573    for g in genes
+000153d0: 5f6c 7374 5f6f 7267 3a0a 2020 2020 2020  _lst_org:.      
+000153e0: 2020 2020 2020 6765 6e65 735f 6c73 742e        genes_lst.
+000153f0: 6170 7065 6e64 2867 2e75 7070 6572 2829  append(g.upper()
+00015400: 290a 2020 2020 2020 2020 7265 6e64 203d  ).        rend =
+00015410: 2064 6963 7428 7a69 7028 6765 6e65 735f   dict(zip(genes_
+00015420: 6c73 745f 6f72 672c 2067 656e 6573 5f6c  lst_org, genes_l
+00015430: 7374 2929 0a20 2020 2020 2020 2058 732e  st)).        Xs.
+00015440: 7265 6e61 6d65 2863 6f6c 756d 6e73 203d  rename(columns =
+00015450: 2072 656e 642c 2069 6e70 6c61 6365 203d   rend, inplace =
+00015460: 2054 7275 6529 0a20 2020 2020 2020 2020   True).         
+00015470: 2020 200a 2020 2020 656c 7365 3a0a 2020     .    else:.  
+00015480: 2020 2020 2020 5469 6465 6e5f 7072 696e        Tiden_prin
+00015490: 745f 6572 726f 7228 290a 2020 2020 2020  t_error().      
+000154a0: 2020 7265 7475 726e 202d 310a 0a20 2020    return -1..   
+000154b0: 2023 2323 2043 6f72 7265 6374 204d 616a   ### Correct Maj
+000154c0: 6f72 2074 7970 650a 2020 2020 6966 2076  or type.    if v
+000154d0: 6572 626f 7365 3a20 7072 696e 7428 2750  erbose: print('P
+000154e0: 4341 202e 2e20 272c 2065 6e64 203d 2027  CA .. ', end = '
+000154f0: 272c 2066 6c75 7368 203d 2054 7275 6529  ', flush = True)
+00015500: 0a20 2020 2065 6c73 653a 200a 2020 2020  .    else: .    
+00015510: 2020 2020 6574 696d 6520 3d20 726f 756e      etime = roun
+00015520: 6428 7469 6d65 2e74 696d 6528 2920 2d20  d(time.time() - 
+00015530: 7374 6172 745f 7469 6d65 2920 2020 2020  start_time)     
+00015540: 2020 200a 2020 2020 2020 2020 7374 6172     .        star
+00015550: 745f 7469 6d65 5f6e 6577 203d 2074 696d  t_time_new = tim
+00015560: 652e 7469 6d65 2829 0a20 2020 2020 2020  e.time().       
+00015570: 2070 7269 6e74 2827 2e27 2c20 656e 6420   print('.', end 
+00015580: 3d20 2727 2c20 666c 7573 6820 3d20 5472  = '', flush = Tr
+00015590: 7565 290a 2020 2020 2020 2020 2320 7072  ue).        # pr
+000155a0: 696e 7428 272e 272c 2065 6e64 203d 2027  int('.', end = '
+000155b0: 272c 2066 6c75 7368 203d 2054 7275 6529  ', flush = True)
+000155c0: 0a20 2020 204e 5f63 6f6d 706f 6e65 6e74  .    N_component
+000155d0: 735f 7063 6120 3d20 4e5f 7063 615f 636f  s_pca = N_pca_co
+000155e0: 6d70 6f6e 656e 7473 0a20 2020 2070 6361  mponents.    pca
+000155f0: 203d 2050 4341 286e 5f63 6f6d 706f 6e65   = PCA(n_compone
+00015600: 6e74 7320 3d20 696e 7428 4e5f 636f 6d70  nts = int(N_comp
+00015610: 6f6e 656e 7473 5f70 6361 292c 2063 6f70  onents_pca), cop
+00015620: 7920 3d20 5472 7565 2c20 0a20 2020 2020  y = True, .     
+00015630: 2020 2020 2020 2020 2072 616e 646f 6d5f           random_
+00015640: 7374 6174 6520 3d20 3029 2023 202c 2073  state = 0) # , s
+00015650: 7664 5f73 6f6c 7665 7220 3d20 2761 7270  vd_solver = 'arp
+00015660: 6163 6b27 290a 2020 2020 0a20 2020 2069  ack').    .    i
+00015670: 6620 7573 655f 6d61 726b 6572 735f 666f  f use_markers_fo
+00015680: 725f 7063 613a 0a20 2020 2020 2020 2069  r_pca:.        i
+00015690: 6620 7665 7262 6f73 653a 2070 7269 6e74  f verbose: print
+000156a0: 2827 5573 696e 6720 4d6b 7273 202e 2e20  ('Using Mkrs .. 
+000156b0: 272c 2065 6e64 203d 2027 272c 2066 6c75  ', end = '', flu
+000156c0: 7368 203d 2054 7275 6529 0a20 2020 2020  sh = True).     
+000156d0: 2020 206d 6b72 735f 616c 6c2c 206d 6b72     mkrs_all, mkr
+000156e0: 735f 6469 6374 203d 2067 6574 5f6d 6172  s_dict = get_mar
+000156f0: 6b65 7273 5f61 6c6c 286d 6172 6b65 725f  kers_all(marker_
+00015700: 6669 6c65 2c20 7461 7267 6574 5f6c 7374  file, target_lst
+00015710: 203d 205b 5d2c 2070 6e73 6831 3220 3d20   = [], pnsh12 = 
+00015720: 6d6b 725f 7365 6c65 6374 6f72 2c0a 2020  mkr_selector,.  
+00015730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015750: 2020 2020 2020 2020 2020 2020 6c65 7665              leve
+00015760: 6c20 3d20 312c 2063 6f6d 625f 6d6b 7273  l = 1, comb_mkrs
+00015770: 203d 2063 6f6d 625f 6d6b 7273 290a 2020   = comb_mkrs).  
+00015780: 2020 2020 2020 6765 6e65 7320 3d20 6c69        genes = li
+00015790: 7374 2858 732e 636f 6c75 6d6e 732e 7661  st(Xs.columns.va
+000157a0: 6c75 6573 290a 2020 2020 2020 2020 6d6b  lues).        mk
+000157b0: 7273 5f61 6c6c 203d 206c 6973 7428 7365  rs_all = list(se
+000157c0: 7428 6d6b 7273 5f61 6c6c 292e 696e 7465  t(mkrs_all).inte
+000157d0: 7273 6563 7469 6f6e 2867 656e 6573 2929  rsection(genes))
+000157e0: 0a20 2020 2020 2020 2058 7320 3d20 5873  .        Xs = Xs
+000157f0: 5b6d 6b72 735f 616c 6c5d 0a20 2020 2065  [mkrs_all].    e
+00015800: 6c73 653a 0a20 2020 2020 2020 206d 6b72  lse:.        mkr
+00015810: 735f 616c 6c20 3d20 6c69 7374 2858 732e  s_all = list(Xs.
+00015820: 636f 6c75 6d6e 732e 7661 6c75 6573 290a  columns.values).
+00015830: 2020 2020 2020 2020 0a20 2020 2058 7820          .    Xx 
+00015840: 3d20 585f 7072 6570 726f 6365 7373 696e  = X_preprocessin
+00015850: 6728 2058 732c 206c 6f67 5f74 7261 6e73  g( Xs, log_trans
+00015860: 666f 726d 6564 2c20 4e5f 6765 6e65 7320  formed, N_genes 
+00015870: 3d20 3230 3030 2029 0a20 2020 2027 2727  = 2000 ).    '''
+00015880: 0a20 2020 2069 6620 5873 2e73 6861 7065  .    if Xs.shape
+00015890: 5b31 5d20 3c20 3330 3030 3a0a 2020 2020  [1] < 3000:.    
+000158a0: 2020 2020 6966 206e 6f74 206c 6f67 5f74      if not log_t
+000158b0: 7261 6e73 666f 726d 6564 3a0a 2020 2020  ransformed:.    
+000158c0: 2020 2020 2020 2020 5878 203d 206e 702e          Xx = np.
+000158d0: 6c6f 6732 2831 202b 2058 5f6e 6f72 6d61  log2(1 + X_norma
+000158e0: 6c69 7a65 2858 7329 290a 2020 2020 2020  lize(Xs)).      
+000158f0: 2020 2020 2020 5878 203d 2058 5f73 6361        Xx = X_sca
+00015900: 6c65 2858 782c 206d 6178 5f76 616c 203d  le(Xx, max_val =
+00015910: 2031 3029 0a20 2020 2020 2020 2065 6c73   10).        els
+00015920: 653a 0a20 2020 2020 2020 2020 2020 2058  e:.            X
+00015930: 7820 3d20 5873 0a20 2020 2020 2020 2020  x = Xs.         
+00015940: 2020 2058 7820 3d20 585f 7363 616c 6528     Xx = X_scale(
+00015950: 5878 2c20 6d61 785f 7661 6c20 3d20 3130  Xx, max_val = 10
+00015960: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+00015970: 2020 2020 6765 6e65 5f73 656c 203d 2073      gene_sel = s
+00015980: 656c 6563 745f 7661 7269 6162 6c65 5f67  elect_variable_g
+00015990: 656e 6573 2858 732c 206c 6f67 5f74 7261  enes(Xs, log_tra
+000159a0: 6e73 666f 726d 6564 203d 206c 6f67 5f74  nsformed = log_t
+000159b0: 7261 6e73 666f 726d 6564 290a 2020 2020  ransformed).    
+000159c0: 2020 2020 6966 206e 6f74 206c 6f67 5f74      if not log_t
+000159d0: 7261 6e73 666f 726d 6564 3a0a 2020 2020  ransformed:.    
+000159e0: 2020 2020 2020 2020 5878 203d 206e 702e          Xx = np.
+000159f0: 6c6f 6732 2831 202b 2058 5f6e 6f72 6d61  log2(1 + X_norma
+00015a00: 6c69 7a65 2858 732e 6c6f 635b 3a2c 6765  lize(Xs.loc[:,ge
+00015a10: 6e65 5f73 656c 5d29 290a 2020 2020 2020  ne_sel])).      
+00015a20: 2020 2020 2020 5878 203d 2058 5f73 6361        Xx = X_sca
+00015a30: 6c65 2858 782c 206d 6178 5f76 616c 203d  le(Xx, max_val =
+00015a40: 2031 3029 0a20 2020 2020 2020 2065 6c73   10).        els
+00015a50: 653a 0a20 2020 2020 2020 2020 2020 2058  e:.            X
+00015a60: 7820 3d20 5873 2e6c 6f63 5b3a 2c67 656e  x = Xs.loc[:,gen
+00015a70: 655f 7365 6c5d 0a20 2020 2020 2020 2020  e_sel].         
+00015a80: 2020 2058 7820 3d20 585f 7363 616c 6528     Xx = X_scale(
+00015a90: 5878 2c20 6d61 785f 7661 6c20 3d20 3130  Xx, max_val = 10
+00015aa0: 290a 2020 2020 2727 2720 2020 200a 2020  ).    '''    .  
+00015ab0: 2020 585f 6c6f 6720 3d20 5878 0a20 2020    X_log = Xx.   
+00015ac0: 2058 5f70 6361 203d 2070 6361 2e66 6974   X_pca = pca.fit
+00015ad0: 5f74 7261 6e73 666f 726d 2858 7829 0a20  _transform(Xx). 
+00015ae0: 2020 2058 5f70 6361 203d 2070 642e 4461     X_pca = pd.Da
+00015af0: 7461 4672 616d 6528 585f 7063 612c 2069  taFrame(X_pca, i
+00015b00: 6e64 6578 203d 2058 782e 696e 6465 782c  ndex = Xx.index,
+00015b10: 2063 6f6c 756d 6e73 203d 206c 6973 7428   columns = list(
+00015b20: 6e70 2e61 7261 6e67 6528 696e 7428 4e5f  np.arange(int(N_
+00015b30: 636f 6d70 6f6e 656e 7473 5f70 6361 2929  components_pca))
+00015b40: 2929 0a20 2020 200a 2020 2020 4e5f 636c  )).    .    N_cl
+00015b50: 7573 7465 7273 203d 2069 6e74 2832 352a  usters = int(25*
+00015b60: 6e70 2e73 7172 7428 436c 7573 7465 7269  np.sqrt(Clusteri
+00015b70: 6e67 5f72 6573 6f6c 7574 696f 6e29 290a  ng_resolution)).
+00015b80: 2020 2020 4d61 784e 636f 6d70 203d 204e      MaxNcomp = N
+00015b90: 5f63 6c75 7374 6572 730a 2020 2020 7371  _clusters.    sq
+00015ba0: 7274 4e20 3d20 696e 7428 6e70 2e73 7172  rtN = int(np.sqr
+00015bb0: 7428 585f 7063 612e 7368 6170 655b 305d  t(X_pca.shape[0]
+00015bc0: 292f 3229 0a20 2020 204e 5f63 6f6d 7020  )/2).    N_comp 
+00015bd0: 3d20 6d69 6e28 4d61 784e 636f 6d70 2c20  = min(MaxNcomp, 
+00015be0: 7371 7274 4e29 0a20 2020 200a 2020 2020  sqrtN).    .    
+00015bf0: 6966 2076 6572 626f 7365 3a20 7072 696e  if verbose: prin
+00015c00: 7428 2743 6c75 7374 6572 696e 6720 2e2e  t('Clustering ..
+00015c10: 2027 2c20 656e 6420 3d20 2727 2c20 666c   ', end = '', fl
+00015c20: 7573 6820 3d20 5472 7565 290a 2020 2020  ush = True).    
+00015c30: 656c 7365 3a20 0a20 2020 2020 2020 2065  else: .        e
+00015c40: 7469 6d65 203d 2072 6f75 6e64 2874 696d  time = round(tim
+00015c50: 652e 7469 6d65 2829 202d 2073 7461 7274  e.time() - start
+00015c60: 5f74 696d 655f 6e65 7729 2020 2020 2020  _time_new)      
+00015c70: 2020 0a20 2020 2020 2020 2073 7461 7274    .        start
+00015c80: 5f74 696d 655f 6e65 7720 3d20 7469 6d65  _time_new = time
+00015c90: 2e74 696d 6528 290a 2020 2020 2020 2020  .time().        
+00015ca0: 7072 696e 7428 2750 2569 2e27 2025 2065  print('P%i.' % e
+00015cb0: 7469 6d65 2c20 656e 6420 3d20 2727 2c20  time, end = '', 
+00015cc0: 666c 7573 6820 3d20 5472 7565 290a 2020  flush = True).  
+00015cd0: 2020 2020 2020 2320 7072 696e 7428 272e        # print('.
+00015ce0: 272c 2065 6e64 203d 2027 272c 2066 6c75  ', end = '', flu
+00015cf0: 7368 203d 2054 7275 6529 0a20 2020 200a  sh = True).    .
+00015d00: 2020 2020 6966 2043 6c75 7374 6572 696e      if Clusterin
+00015d10: 675f 6261 7365 203d 3d20 2770 6361 273a  g_base == 'pca':
+00015d20: 0a20 2020 2020 2020 2058 5f75 6d61 7020  .        X_umap 
+00015d30: 3d20 585f 7063 610a 2020 2020 656c 7365  = X_pca.    else
+00015d40: 3a0a 2020 2020 2020 2020 585f 756d 6170  :.        X_umap
+00015d50: 203d 2058 5f70 6361 0a20 2020 2020 2020   = X_pca.       
+00015d60: 200a 2020 2020 795f 636c 7573 742c 2063   .    y_clust, c
+00015d70: 6f62 6a20 3d20 636c 7573 7465 7269 6e67  obj = clustering
+00015d80: 5f61 6c67 2858 5f75 6d61 702c 2063 6c75  _alg(X_umap, clu
+00015d90: 7374 5f61 6c67 6f20 3d20 436c 7573 7465  st_algo = Cluste
+00015da0: 7269 6e67 5f61 6c67 6f2c 204e 5f63 6c75  ring_algo, N_clu
+00015db0: 7374 6572 7320 3d20 4e5f 636f 6d70 2c20  sters = N_comp, 
+00015dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015dd0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00015de0: 736f 6c75 7469 6f6e 203d 2043 6c75 7374  solution = Clust
+00015df0: 6572 696e 675f 7265 736f 6c75 7469 6f6e  ering_resolution
+00015e00: 290a 2020 2020 0a20 2020 2072 656e 6420  ).    .    rend 
+00015e10: 3d20 7b7d 0a20 2020 2066 6f72 2069 2069  = {}.    for i i
+00015e20: 6e20 6c69 7374 2858 5f70 6361 2e63 6f6c  n list(X_pca.col
+00015e30: 756d 6e73 2e76 616c 7565 7329 3a0a 2020  umns.values):.  
+00015e40: 2020 2020 2020 7265 6e64 5b69 5d20 3d20        rend[i] = 
+00015e50: 7374 7228 6929 0a20 2020 2058 5f70 6361  str(i).    X_pca
+00015e60: 2e72 656e 616d 6528 636f 6c75 6d6e 7320  .rename(columns 
+00015e70: 3d20 7265 6e64 2c20 696e 706c 6163 6520  = rend, inplace 
+00015e80: 3d20 5472 7565 290a 0a20 2020 2023 2064  = True)..    # d
+00015e90: 6963 745f 7375 6d6d 6172 795f 7265 735b  ict_summary_res[
+00015ea0: 2758 7063 6127 5d20 3d20 585f 7063 610a  'Xpca'] = X_pca.
+00015eb0: 2020 2020 0a20 2020 2069 6620 7665 7262      .    if verb
+00015ec0: 6f73 653a 2070 7269 6e74 2827 4e63 203d  ose: print('Nc =
+00015ed0: 2025 692c 2027 2025 206c 656e 2873 6574   %i, ' % len(set
+00015ee0: 2879 5f63 6c75 7374 2929 2c20 656e 6420  (y_clust)), end 
+00015ef0: 3d20 2727 2c20 666c 7573 6820 3d20 5472  = '', flush = Tr
+00015f00: 7565 290a 2020 2020 656c 7365 3a20 0a20  ue).    else: . 
+00015f10: 2020 2020 2020 2065 7469 6d65 203d 2072         etime = r
+00015f20: 6f75 6e64 2874 696d 652e 7469 6d65 2829  ound(time.time()
+00015f30: 202d 2073 7461 7274 5f74 696d 655f 6e65   - start_time_ne
+00015f40: 7729 2020 2020 2020 2020 0a20 2020 2020  w)        .     
+00015f50: 2020 2073 7461 7274 5f74 696d 655f 6e65     start_time_ne
+00015f60: 7720 3d20 7469 6d65 2e74 696d 6528 290a  w = time.time().
+00015f70: 2020 2020 2020 2020 7072 696e 7428 2743          print('C
+00015f80: 2569 2e27 2025 2065 7469 6d65 2c20 656e  %i.' % etime, en
+00015f90: 6420 3d20 2727 2c20 666c 7573 6820 3d20  d = '', flush = 
+00015fa0: 5472 7565 290a 2020 2020 2020 2020 2320  True).        # 
+00015fb0: 7072 696e 7428 272e 272c 2065 6e64 203d  print('.', end =
+00015fc0: 2027 272c 2066 6c75 7368 203d 2054 7275   '', flush = Tru
+00015fd0: 6529 0a20 2020 2020 2020 0a20 2020 2023  e).       .    #
+00015fe0: 2323 2323 204d 616a 6f72 2074 7970 6520  #### Major type 
+00015ff0: 6964 656e 7469 6669 6361 7469 6f6e 2066  identification f
+00016000: 6f72 2074 6172 6765 7420 6365 6c6c 2073  or target cell s
+00016010: 656c 6563 7469 6f6e 0a20 2020 2064 6963  election.    dic
+00016020: 745f 6365 6c6c 7479 7065 5f63 6f6d 6220  t_celltype_comb 
+00016030: 3d20 7b7d 0a0a 2020 2020 6966 2054 7275  = {}..    if Tru
+00016040: 653a 0a20 2020 2020 2020 2074 6172 6765  e:.        targe
+00016050: 745f 6365 6c6c 203d 2074 6172 6765 745f  t_cell = target_
+00016060: 6365 6c6c 5f74 7970 6573 0a20 2020 2020  cell_types.     
+00016070: 2020 206d 6b72 5f6c 7374 2c20 6d6b 725f     mkr_lst, mkr_
+00016080: 6c73 745f 6e65 6720 3d20 6765 745f 6d61  lst_neg = get_ma
+00016090: 726b 6572 735f 6d61 6a6f 725f 7479 7065  rkers_major_type
+000160a0: 286d 6172 6b65 725f 6669 6c65 2c20 7461  (marker_file, ta
+000160b0: 7267 6574 5f63 656c 6c2c 200a 2020 2020  rget_cell, .    
+000160c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000160d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000160e0: 2020 2020 706e 7368 3132 203d 206d 6b72      pnsh12 = mkr
+000160f0: 5f73 656c 6563 746f 722c 2072 656d 5f63  _selector, rem_c
+00016100: 6f6d 6d6f 6e20 3d20 7265 6d5f 636d 6e5f  ommon = rem_cmn_
+00016110: 6d6b 722c 2076 6572 626f 7365 203d 2076  mkr, verbose = v
+00016120: 6572 626f 7365 290a 2020 2020 2020 2020  erbose).        
+00016130: 0a20 2020 2020 2020 2023 2323 2323 2323  .        #######
+00016140: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00016150: 2323 2323 2323 230a 2020 2020 2020 2020  #######.        
+00016160: 2323 2047 6574 206d 696e 6f72 2074 7970  ## Get minor typ
+00016170: 6520 6d61 726b 6572 730a 2020 2020 2020  e markers.      
+00016180: 2020 6966 206e 6f74 2075 7365 5f75 6e69    if not use_uni
+00016190: 6f6e 5f6d 616a 6f72 3a20 2020 2020 2020  on_major:       
+000161a0: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+000161b0: 2020 6d6b 725f 6c73 745f 7375 6273 6574    mkr_lst_subset
+000161c0: 2c20 6d6b 725f 6c73 745f 7375 6273 6574  , mkr_lst_subset
+000161d0: 5f6e 6567 2c20 6d6b 725f 6c73 745f 7375  _neg, mkr_lst_su
+000161e0: 6273 6574 5f73 6563 2c20 6d61 705f 6469  bset_sec, map_di
+000161f0: 6374 5f73 7562 326d 616a 2c20 6d61 705f  ct_sub2maj, map_
+00016200: 6469 6374 5f73 7562 326d 696e 203d 205c  dict_sub2min = \
+00016210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016220: 206c 6f61 645f 6d61 726b 6572 735f 616c   load_markers_al
+00016230: 6c28 6d61 726b 6572 5f66 696c 652c 2074  l(marker_file, t
+00016240: 6172 6765 745f 6365 6c6c 7320 3d20 7461  arget_cells = ta
+00016250: 7267 6574 5f63 656c 6c2c 2070 6e73 6831  rget_cell, pnsh1
+00016260: 3220 3d20 6d6b 725f 7365 6c65 6374 6f72  2 = mkr_selector
+00016270: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+00016280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016290: 2020 2020 636f 6d62 5f6d 6b72 7320 3d20      comb_mkrs = 
+000162a0: 636f 6d62 5f6d 6b72 732c 2020 7665 7262  comb_mkrs,  verb
+000162b0: 6f73 6520 3d20 4661 6c73 6529 0a0a 2020  ose = False)..  
+000162c0: 2020 2020 2020 2020 2020 6d61 705f 6469            map_di
+000162d0: 6374 5f6d 616a 3273 7562 203d 207b 7d0a  ct_maj2sub = {}.
+000162e0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000162f0: 6b65 7920 696e 206d 6170 5f64 6963 745f  key in map_dict_
+00016300: 7375 6232 6d61 6a2e 6b65 7973 2829 3a0a  sub2maj.keys():.
+00016310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016320: 6d6a 7420 3d20 6d61 705f 6469 6374 5f73  mjt = map_dict_s
+00016330: 7562 326d 616a 5b6b 6579 5d0a 2020 2020  ub2maj[key].    
+00016340: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+00016350: 6a74 206e 6f74 2069 6e20 6c69 7374 286d  jt not in list(m
+00016360: 6170 5f64 6963 745f 6d61 6a32 7375 622e  ap_dict_maj2sub.
+00016370: 6b65 7973 2829 293a 0a20 2020 2020 2020  keys()):.       
+00016380: 2020 2020 2020 2020 2020 2020 206d 6170               map
+00016390: 5f64 6963 745f 6d61 6a32 7375 625b 6d6a  _dict_maj2sub[mj
+000163a0: 745d 203d 205b 6b65 795d 0a20 2020 2020  t] = [key].     
+000163b0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000163c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000163d0: 2020 2020 206d 6170 5f64 6963 745f 6d61       map_dict_ma
+000163e0: 6a32 7375 625b 6d6a 745d 2e61 7070 656e  j2sub[mjt].appen
+000163f0: 6428 6b65 7929 0a0a 2020 2020 2020 2020  d(key)..        
+00016400: 2020 2020 6d61 705f 6469 6374 5f6d 696e      map_dict_min
+00016410: 3273 7562 203d 207b 7d0a 2020 2020 2020  2sub = {}.      
+00016420: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
+00016430: 206d 6170 5f64 6963 745f 7375 6232 6d69   map_dict_sub2mi
+00016440: 6e2e 6b65 7973 2829 3a0a 2020 2020 2020  n.keys():.      
+00016450: 2020 2020 2020 2020 2020 6d6a 7420 3d20            mjt = 
+00016460: 6d61 705f 6469 6374 5f73 7562 326d 696e  map_dict_sub2min
+00016470: 5b6b 6579 5d0a 2020 2020 2020 2020 2020  [key].          
+00016480: 2020 2020 2020 6966 206d 6a74 206e 6f74        if mjt not
+00016490: 2069 6e20 6c69 7374 286d 6170 5f64 6963   in list(map_dic
+000164a0: 745f 6d69 6e32 7375 622e 6b65 7973 2829  t_min2sub.keys()
+000164b0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000164c0: 2020 2020 2020 206d 6170 5f64 6963 745f         map_dict_
+000164d0: 6d69 6e32 7375 625b 6d6a 745d 203d 205b  min2sub[mjt] = [
+000164e0: 6b65 795d 0a20 2020 2020 2020 2020 2020  key].           
+000164f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00016500: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00016510: 6170 5f64 6963 745f 6d69 6e32 7375 625b  ap_dict_min2sub[
+00016520: 6d6a 745d 2e61 7070 656e 6428 6b65 7929  mjt].append(key)
+00016530: 0a0a 2020 2020 2020 2020 2020 2020 6466  ..            df
+00016540: 5f72 6573 5f73 7562 7365 745f 616c 6c2c  _res_subset_all,
+00016550: 2064 665f 4753 415f 7363 6f72 655f 7375   df_GSA_score_su
+00016560: 6273 6574 5f61 6c6c 2c20 6466 6e5f 7375  bset_all, dfn_su
+00016570: 6273 6574 5f61 6c6c 203d 205c 0a20 2020  bset_all = \.   
+00016580: 2020 2020 2020 2020 2020 2020 2047 5341               GSA
+00016590: 5f63 656c 6c5f 7375 6274 7970 696e 6728  _cell_subtyping(
+000165a0: 2058 732c 206d 6b72 5f6c 7374 5f73 7562   Xs, mkr_lst_sub
+000165b0: 7365 742c 206d 6b72 5f6c 7374 5f73 7562  set, mkr_lst_sub
+000165c0: 7365 745f 6e65 672c 2076 6572 626f 7365  set_neg, verbose
+000165d0: 203d 2076 6572 626f 7365 2029 0a20 2020   = verbose ).   
+000165e0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+000165f0: 2020 2020 2020 6966 206e 6f74 2076 6572        if not ver
+00016600: 626f 7365 3a20 0a20 2020 2020 2020 2020  bose: .         
+00016610: 2020 2020 2020 2065 7469 6d65 203d 2072         etime = r
+00016620: 6f75 6e64 2874 696d 652e 7469 6d65 2829  ound(time.time()
+00016630: 202d 2073 7461 7274 5f74 696d 655f 6e65   - start_time_ne
+00016640: 7729 2020 2020 2020 2020 0a20 2020 2020  w)        .     
+00016650: 2020 2020 2020 2020 2020 2073 7461 7274             start
+00016660: 5f74 696d 655f 6e65 7720 3d20 7469 6d65  _time_new = time
+00016670: 2e74 696d 6528 290a 2020 2020 2020 2020  .time().        
+00016680: 2020 2020 2020 2020 7072 696e 7428 2725          print('%
+00016690: 692e 2720 2520 6574 696d 652c 2065 6e64  i.' % etime, end
+000166a0: 203d 2027 272c 2066 6c75 7368 203d 2054   = '', flush = T
+000166b0: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
+000166c0: 2020 2020 2023 2070 7269 6e74 2827 2e27       # print('.'
+000166d0: 2c20 656e 6420 3d20 2727 2c20 666c 7573  , end = '', flus
+000166e0: 6820 3d20 5472 7565 290a 2020 2020 2020  h = True).      
+000166f0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+00016700: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00016710: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+00016720: 2020 6966 2074 6172 6765 745f 6365 6c6c    if target_cell
+00016730: 5f74 7970 6573 2069 7320 4e6f 6e65 3a0a  _types is None:.
+00016740: 2020 2020 2020 2020 2020 2020 7461 7267              targ
+00016750: 6574 5f63 656c 6c5f 7479 7065 7320 3d20  et_cell_types = 
+00016760: 6c69 7374 286d 6b72 5f6c 7374 2e6b 6579  list(mkr_lst.key
+00016770: 7328 2929 0a20 2020 2020 2020 2065 6c69  s()).        eli
+00016780: 6620 6c65 6e28 7461 7267 6574 5f63 656c  f len(target_cel
+00016790: 6c5f 7479 7065 7329 203d 3d20 303a 0a20  l_types) == 0:. 
+000167a0: 2020 2020 2020 2020 2020 2074 6172 6765             targe
+000167b0: 745f 6365 6c6c 5f74 7970 6573 203d 206c  t_cell_types = l
+000167c0: 6973 7428 6d6b 725f 6c73 742e 6b65 7973  ist(mkr_lst.keys
+000167d0: 2829 290a 2020 2020 2020 2020 656c 7365  ()).        else
+000167e0: 3a0a 2020 2020 2020 2020 2020 2020 736d  :.            sm
+000167f0: 203d 2027 270a 2020 2020 2020 2020 2020   = ''.          
+00016800: 2020 666f 7220 6b65 7920 696e 206c 6973    for key in lis
+00016810: 7428 7365 7428 7461 7267 6574 5f63 656c  t(set(target_cel
+00016820: 6c5f 7479 7065 7329 2e64 6966 6665 7265  l_types).differe
+00016830: 6e63 6528 6c69 7374 286d 6b72 5f6c 7374  nce(list(mkr_lst
+00016840: 2e6b 6579 7328 2929 2929 3a0a 2020 2020  .keys()))):.    
+00016850: 2020 2020 2020 2020 2020 2020 736d 203d              sm =
+00016860: 2073 6d20 2b20 2725 732c 2720 2520 6b65   sm + '%s,' % ke
+00016870: 790a 2020 2020 2020 2020 2020 2020 6966  y.            if
+00016880: 2076 6572 626f 7365 2026 2028 6c65 6e28   verbose & (len(
+00016890: 736d 2920 3e20 3029 3a20 0a20 2020 2020  sm) > 0): .     
+000168a0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+000168b0: 2827 494e 464f 3a20 5468 6520 6d61 726b  ('INFO: The mark
+000168c0: 6572 2064 6220 646f 6573 206e 6f74 2063  er db does not c
+000168d0: 6f6e 7461 696e 2025 7327 2025 2073 6d5b  ontain %s' % sm[
+000168e0: 3a2d 315d 290a 2020 2020 2020 2020 2020  :-1]).          
+000168f0: 2020 7461 7267 6574 5f63 656c 6c5f 7479    target_cell_ty
+00016900: 7065 7320 3d20 6c69 7374 2873 6574 2874  pes = list(set(t
+00016910: 6172 6765 745f 6365 6c6c 5f74 7970 6573  arget_cell_types
+00016920: 292e 696e 7465 7273 6563 7469 6f6e 286d  ).intersection(m
+00016930: 6b72 5f6c 7374 2e6b 6579 7328 2929 290a  kr_lst.keys())).
+00016940: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00016950: 2020 2020 206d 6b72 735f 616c 6c20 3d20       mkrs_all = 
+00016960: 5b5d 0a20 2020 2020 2020 2066 6f72 206b  [].        for k
+00016970: 6579 2069 6e20 6d6b 725f 6c73 742e 6b65  ey in mkr_lst.ke
+00016980: 7973 2829 3a0a 2020 2020 2020 2020 2020  ys():.          
+00016990: 2020 6d6b 7273 5f61 6c6c 203d 206d 6b72    mkrs_all = mkr
+000169a0: 735f 616c 6c20 2b20 6d6b 725f 6c73 745b  s_all + mkr_lst[
+000169b0: 6b65 795d 0a20 2020 2020 2020 206d 6b72  key].        mkr
+000169c0: 735f 616c 6c20 3d20 6c69 7374 2873 6574  s_all = list(set
+000169d0: 286d 6b72 735f 616c 6c29 290a 2020 2020  (mkrs_all)).    
+000169e0: 2020 2020 6d6b 7273 5f65 7869 7374 203d      mkrs_exist =
+000169f0: 206c 6973 7428 7365 7428 6d6b 7273 5f61   list(set(mkrs_a
+00016a00: 6c6c 292e 696e 7465 7273 6563 7469 6f6e  ll).intersection
+00016a10: 2867 656e 6573 5f6c 7374 2929 0a20 2020  (genes_lst)).   
+00016a20: 2020 2020 200a 2020 2020 2020 2020 7063       .        pc
+00016a30: 745f 7220 3d20 6c65 6e28 6d6b 7273 5f65  t_r = len(mkrs_e
+00016a40: 7869 7374 292f 6c65 6e28 6d6b 7273 5f61  xist)/len(mkrs_a
+00016a50: 6c6c 290a 2020 2020 2020 2020 6966 2070  ll).        if p
+00016a60: 6374 5f72 203d 3d20 303a 0a20 2020 2020  ct_r == 0:.     
+00016a70: 2020 2020 2020 2070 7269 6e74 2827 4552         print('ER
+00016a80: 524f 523a 204e 6f20 6d61 726b 6572 2067  ROR: No marker g
+00016a90: 656e 6573 2066 6f75 6e64 2069 6e20 7468  enes found in th
+00016aa0: 6520 6461 7461 2e27 290a 2020 2020 2020  e data.').      
+00016ab0: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+00016ac0: 652c 204e 6f6e 650a 2020 2020 2020 2020  e, None.        
+00016ad0: 0a20 2020 2020 2020 2070 7661 6c5f 7468  .        pval_th
+00016ae0: 203d 206d 696e 2820 7076 616c 5f74 682f   = min( pval_th/
+00016af0: 7063 745f 722c 2030 2e31 2029 0a20 2020  pct_r, 0.1 ).   
+00016b00: 2020 2020 2070 6374 5f74 685f 6d69 6e20       pct_th_min 
+00016b10: 3d20 7074 685f 6d69 6e2a 7063 745f 720a  = pth_min*pct_r.
+00016b20: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00016b30: 2069 6620 7665 7262 6f73 6520 2620 2870   if verbose & (p
+00016b40: 6374 5f72 203c 2030 2e39 293a 200a 2020  ct_r < 0.9): .  
+00016b50: 2020 2020 2020 2020 2020 2320 7072 696e            # prin
+00016b60: 7428 2750 4354 2072 6564 7563 7469 6f6e  t('PCT reduction
+00016b70: 2066 6163 746f 7220 3d20 2534 2e32 6627   factor = %4.2f'
+00016b80: 2025 2070 6374 5f72 290a 2020 2020 2020   % pct_r).      
+00016b90: 2020 2020 2020 7072 696e 7428 2757 4152        print('WAR
+00016ba0: 4e49 4e47 3a20 546f 6f20 6d61 6e79 206d  NING: Too many m
+00016bb0: 6172 6b65 7273 206e 6f74 2070 7265 7365  arkers not prese
+00016bc0: 6e74 2e20 7076 5f74 682c 206d 696e 5f70  nt. pv_th, min_p
+00016bd0: 7468 202d 3e20 2535 2e33 662c 2025 352e  th -> %5.3f, %5.
+00016be0: 3366 2720 2520 5c0a 2020 2020 2020 2020  3f' % \.        
+00016bf0: 2020 2020 2020 2020 2020 2870 7661 6c5f            (pval_
+00016c00: 7468 2c20 7063 745f 722a 5043 545f 5448  th, pct_r*PCT_TH
+00016c10: 5245 5348 4f4c 445f 4d49 4e29 290a 2020  RESHOLD_MIN)).  
+00016c20: 2020 2020 2020 2020 2020 2320 7072 696e            # prin
+00016c30: 7428 2749 4e46 4f3a 2054 6f6f 206d 616e  t('INFO: Too man
+00016c40: 7920 6d61 726b 6572 7320 6e6f 7420 7072  y markers not pr
+00016c50: 6573 656e 742e 206d 696e 5f70 7468 202d  esent. min_pth -
+00016c60: 3e20 2535 2e33 6627 2025 2028 7063 745f  > %5.3f' % (pct_
+00016c70: 722a 5043 545f 5448 5245 5348 4f4c 445f  r*PCT_THRESHOLD_
+00016c80: 4d49 4e29 290a 0a20 2020 2020 2020 2066  MIN))..        f
+00016c90: 6f72 206c 6f6f 7020 696e 2072 616e 6765  or loop in range
+00016ca0: 286c 656e 2874 6172 6765 745f 6365 6c6c  (len(target_cell
+00016cb0: 5f74 7970 6573 2929 3a0a 2020 2020 2020  _types)):.      
+00016cc0: 2020 2320 6c6f 6f70 203d 2030 0a20 2020    # loop = 0.   
+00016cd0: 2020 2020 2023 2069 6620 5472 7565 3a20       # if True: 
+00016ce0: 200a 2020 2020 2020 2020 2020 2020 2320   .            # 
+00016cf0: 7573 655f 756e 696f 6e5f 6d61 6a6f 7220  use_union_major 
+00016d00: 3d20 7573 655f 756e 696f 6e0a 2020 2020  = use_union.    
+00016d10: 2020 2020 2020 2020 6966 2075 7365 5f75          if use_u
+00016d20: 6e69 6f6e 5f6d 616a 6f72 3a0a 2020 2020  nion_major:.    
+00016d30: 2020 2020 2020 2020 2020 2020 6466 5f70              df_p
+00016d40: 6173 7320 3d20 4e6f 6e65 0a20 2020 2020  ass = None.     
+00016d50: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00016d60: 2020 2020 2020 2020 2020 2020 2064 665f               df_
+00016d70: 4753 415f 7363 6f72 655f 7375 6273 6574  GSA_score_subset
+00016d80: 203d 2064 665f 4753 415f 7363 6f72 655f   = df_GSA_score_
+00016d90: 7375 6273 6574 5f61 6c6c 0a20 2020 2020  subset_all.     
+00016da0: 2020 2020 2020 2020 2020 206d 616a 6f72             major
+00016db0: 5f74 7970 655f 6c73 7420 3d20 6c69 7374  _type_lst = list
+00016dc0: 286d 6170 5f64 6963 745f 6d61 6a32 7375  (map_dict_maj2su
+00016dd0: 622e 6b65 7973 2829 290a 2020 2020 2020  b.keys()).      
+00016de0: 2020 2020 2020 2020 2020 6466 5f47 5341            df_GSA
+00016df0: 5f73 636f 7265 5f6d 616a 6f72 203d 2070  _score_major = p
+00016e00: 642e 4461 7461 4672 616d 6528 696e 6465  d.DataFrame(inde
+00016e10: 7820 3d20 5873 2e69 6e64 6578 2c20 636f  x = Xs.index, co
+00016e20: 6c75 6d6e 7320 3d20 6d61 6a6f 725f 7479  lumns = major_ty
+00016e30: 7065 5f6c 7374 290a 2020 2020 2020 2020  pe_lst).        
+00016e40: 2020 2020 2020 2020 6466 6e5f 7375 6273          dfn_subs
+00016e50: 6574 203d 2064 666e 5f73 7562 7365 745f  et = dfn_subset_
+00016e60: 616c 6c0a 2020 2020 2020 2020 2020 2020  all.            
+00016e70: 2020 2020 6466 6e5f 6d61 6a6f 7220 3d20      dfn_major = 
+00016e80: 7064 2e44 6174 6146 7261 6d65 2869 6e64  pd.DataFrame(ind
+00016e90: 6578 203d 2058 732e 696e 6465 782c 2063  ex = Xs.index, c
+00016ea0: 6f6c 756d 6e73 203d 206d 616a 6f72 5f74  olumns = major_t
+00016eb0: 7970 655f 6c73 7429 0a20 2020 2020 2020  ype_lst).       
+00016ec0: 2020 2020 2020 2020 2066 6f72 206d 616a           for maj
+00016ed0: 6f72 2069 6e20 6d61 6a6f 725f 7479 7065  or in major_type
+00016ee0: 5f6c 7374 3a0a 2020 2020 2020 2020 2020  _lst:.          
+00016ef0: 2020 2020 2020 2020 2020 7375 625f 6c73            sub_ls
+00016f00: 7420 3d20 6d61 705f 6469 6374 5f6d 616a  t = map_dict_maj
+00016f10: 3273 7562 5b6d 616a 6f72 5d0a 2020 2020  2sub[major].    
+00016f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016f30: 6966 206c 656e 2873 7562 5f6c 7374 2920  if len(sub_lst) 
+00016f40: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
+00016f50: 2020 2020 2020 2020 2020 2020 2020 6265                be
+00016f60: 7374 5f73 636f 7265 203d 2064 665f 4753  st_score = df_GS
+00016f70: 415f 7363 6f72 655f 7375 6273 6574 5b73  A_score_subset[s
+00016f80: 7562 5f6c 7374 5b30 5d5d 0a20 2020 2020  ub_lst[0]].     
+00016f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016fa0: 2020 2064 666e 5f6d 616a 6f72 5b6d 616a     dfn_major[maj
+00016fb0: 6f72 5d20 3d20 6466 6e5f 7375 6273 6574  or] = dfn_subset
+00016fc0: 5b73 7562 5f6c 7374 5b30 5d5d 0a20 2020  [sub_lst[0]].   
+00016fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016fe0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00016ff0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00017000: 7562 7365 7473 203d 2064 665f 4753 415f  ubsets = df_GSA_
+00017010: 7363 6f72 655f 7375 6273 6574 5b73 7562  score_subset[sub
+00017020: 5f6c 7374 5d2e 6964 786d 6178 2861 7869  _lst].idxmax(axi
+00017030: 7320 3d20 3129 0a20 2020 2020 2020 2020  s = 1).         
+00017040: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00017050: 6f72 206b 2c20 7320 696e 2065 6e75 6d65  or k, s in enume
+00017060: 7261 7465 286c 6973 7428 7375 6273 6574  rate(list(subset
+00017070: 7329 293a 0a20 2020 2020 2020 2020 2020  s)):.           
+00017080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017090: 2069 6478 203d 2058 732e 696e 6465 785b   idx = Xs.index[
+000170a0: 6b5d 0a20 2020 2020 2020 2020 2020 2020  k].             
+000170b0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000170c0: 666e 5f6d 616a 6f72 2e6c 6f63 5b69 6478  fn_major.loc[idx
+000170d0: 2c6d 616a 6f72 5d20 3d20 6466 6e5f 7375  ,major] = dfn_su
+000170e0: 6273 6574 2e6c 6f63 5b69 6478 2c73 5d0a  bset.loc[idx,s].
 000170f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017100: 2020 6265 7374 5f73 636f 7265 203d 206e    best_score = n
-00017110: 702e 736f 7274 2864 665f 4753 415f 7363  p.sort(df_GSA_sc
-00017120: 6f72 655f 7375 6273 6574 5b73 7562 5f6c  ore_subset[sub_l
-00017130: 7374 5d2c 2061 7869 733d 3129 5b3a 2c20  st], axis=1)[:, 
-00017140: 2d6e 5f6d 6178 3a5d 2e6d 6561 6e28 6178  -n_max:].mean(ax
-00017150: 6973 203d 2031 290a 0a20 2020 2020 2020  is = 1)..       
-00017160: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-00017170: 4753 415f 7363 6f72 655f 6d61 6a6f 725b  GSA_score_major[
-00017180: 6d61 6a6f 725d 203d 2062 6573 745f 7363  major] = best_sc
-00017190: 6f72 6520 0a20 2020 2020 2020 2020 2020  ore .           
-000171a0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-000171b0: 2020 2020 2020 2020 2020 6466 5f70 6173            df_pas
-000171c0: 7320 3d20 6466 5f47 5341 5f73 636f 7265  s = df_GSA_score
-000171d0: 5f6d 616a 6f72 0a20 2020 2020 2020 2020  _major.         
-000171e0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-000171f0: 2020 2020 6466 5f72 6573 5f6d 616a 6f72      df_res_major
-00017200: 2c20 6466 5f73 636f 7265 5f6d 616a 6f72  , df_score_major
-00017210: 2c20 6466 5f47 5341 5f73 636f 7265 5f6d  , df_GSA_score_m
-00017220: 616a 6f72 203d 205c 0a20 2020 2020 2020  ajor = \.       
-00017230: 2020 2020 2020 2020 2072 756e 5f67 7361           run_gsa
-00017240: 5f61 6e64 5f63 6c66 2820 585f 7063 612c  _and_clf( X_pca,
-00017250: 2058 732c 2063 6f62 6a2c 2079 5f63 6c75   Xs, cobj, y_clu
-00017260: 7374 2c20 6d6b 725f 6c73 742c 206d 6b72  st, mkr_lst, mkr
-00017270: 5f6c 7374 5f6e 6567 2c20 0a20 2020 2020  _lst_neg, .     
-00017280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017290: 2020 2020 2020 2020 2020 2020 6d65 7468              meth
-000172a0: 6f64 203d 2027 676d 6d27 2c20 4e5f 636f  od = 'gmm', N_co
-000172b0: 6d70 6f6e 656e 7473 203d 204e 5f63 6f6d  mponents = N_com
-000172c0: 706f 6e65 6e74 732c 2070 7661 6c5f 7468  ponents, pval_th
-000172d0: 203d 2070 7661 6c5f 7468 2c20 0a20 2020   = pval_th, .   
-000172e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000172f0: 2020 2020 2020 2020 2020 2020 2020 7063                pc
-00017300: 745f 6669 745f 706e 7420 3d20 7074 685f  t_fit_pnt = pth_
-00017310: 6669 745f 706e 742c 2070 6374 5f6d 696e  fit_pnt, pct_min
-00017320: 5f72 6620 3d20 7063 745f 7468 5f6d 696e  _rf = pct_th_min
-00017330: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00017340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017350: 2020 2054 6172 6765 745f 4650 5220 3d20     Target_FPR = 
-00017360: 5461 7267 6574 5f46 5052 2c20 706d 616a  Target_FPR, pmaj
-00017370: 203d 2070 6d61 6a2c 206d 696e 6f72 5f69   = pmaj, minor_i
-00017380: 645f 7365 7020 3d20 6d69 6e6f 725f 6964  d_sep = minor_id
-00017390: 5f73 6570 2c0a 2020 2020 2020 2020 2020  _sep,.          
-000173a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000173b0: 2020 2020 2020 206d 696e 5f6c 6f67 505f         min_logP_
-000173c0: 6469 6666 203d 206d 696e 5f6c 6f67 505f  diff = min_logP_
-000173d0: 6469 6666 2c20 7468 7265 7368 6f6c 6469  diff, thresholdi
-000173e0: 6e67 203d 2074 6872 6573 686f 6c64 696e  ng = thresholdin
-000173f0: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
-00017400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017410: 2020 2020 7063 745f 6375 746f 6666 203d      pct_cutoff =
-00017420: 2054 7275 652c 2063 6263 5f63 7574 6f66   True, cbc_cutof
-00017430: 6620 3d20 6362 635f 6375 746f 6666 2c20  f = cbc_cutoff, 
-00017440: 7072 696e 745f 7265 706f 7274 203d 2076  print_report = v
-00017450: 6572 626f 7365 2c0a 2020 2020 2020 2020  erbose,.        
-00017460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017470: 2020 2020 2020 2020 2064 665f 4753 415f           df_GSA_
-00017480: 7363 6f72 6520 3d20 6466 5f70 6173 7329  score = df_pass)
-00017490: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000174a0: 6e6f 7420 7573 655f 756e 696f 6e5f 6d61  not use_union_ma
-000174b0: 6a6f 723a 0a20 2020 2020 2020 2020 2020  jor:.           
-000174c0: 2020 2020 2069 6478 7320 3d20 6466 5f72       idxs = df_r
-000174d0: 6573 5f6d 616a 6f72 2e69 6e64 6578 2e76  es_major.index.v
-000174e0: 616c 7565 730a 2020 2020 2020 2020 2020  alues.          
-000174f0: 2020 2020 2020 666f 7220 6b2c 2069 6478        for k, idx
-00017500: 2069 6e20 656e 756d 6572 6174 6528 6c69   in enumerate(li
-00017510: 7374 2869 6478 7329 293a 0a20 2020 2020  st(idxs)):.     
-00017520: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00017530: 7420 3d20 6466 5f72 6573 5f6d 616a 6f72  t = df_res_major
-00017540: 2e6c 6f63 5b69 6478 2c20 2763 656c 6c5f  .loc[idx, 'cell_
-00017550: 7479 7065 2831 7374 2927 5d0a 2020 2020  type(1st)'].    
+00017100: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00017110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017120: 2069 6620 4e5f 6d61 785f 746f 5f61 7665   if N_max_to_ave
+00017130: 203c 3d20 313a 0a20 2020 2020 2020 2020   <= 1:.         
+00017140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017150: 2020 2062 6573 745f 7363 6f72 6520 3d20     best_score = 
+00017160: 6466 5f47 5341 5f73 636f 7265 5f73 7562  df_GSA_score_sub
+00017170: 7365 745b 7375 625f 6c73 745d 2e6d 6178  set[sub_lst].max
+00017180: 2861 7869 7320 3d20 3129 0a20 2020 2020  (axis = 1).     
+00017190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000171a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000171b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000171c0: 2020 2020 206e 5f6d 6178 203d 206d 696e       n_max = min
+000171d0: 284e 5f6d 6178 5f74 6f5f 6176 652c 206c  (N_max_to_ave, l
+000171e0: 656e 2873 7562 5f6c 7374 2929 0a20 2020  en(sub_lst)).   
+000171f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017200: 2020 2020 2020 2020 2062 6573 745f 7363           best_sc
+00017210: 6f72 6520 3d20 6e70 2e73 6f72 7428 6466  ore = np.sort(df
+00017220: 5f47 5341 5f73 636f 7265 5f73 7562 7365  _GSA_score_subse
+00017230: 745b 7375 625f 6c73 745d 2c20 6178 6973  t[sub_lst], axis
+00017240: 3d31 295b 3a2c 202d 6e5f 6d61 783a 5d2e  =1)[:, -n_max:].
+00017250: 6d65 616e 2861 7869 7320 3d20 3129 0a0a  mean(axis = 1)..
+00017260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017270: 2020 2020 6466 5f47 5341 5f73 636f 7265      df_GSA_score
+00017280: 5f6d 616a 6f72 5b6d 616a 6f72 5d20 3d20  _major[major] = 
+00017290: 6265 7374 5f73 636f 7265 200a 2020 2020  best_score .    
+000172a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000172b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000172c0: 2064 665f 7061 7373 203d 2064 665f 4753   df_pass = df_GS
+000172d0: 415f 7363 6f72 655f 6d61 6a6f 720a 2020  A_score_major.  
+000172e0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+000172f0: 2020 2020 2020 2020 2020 2064 665f 7265             df_re
+00017300: 735f 6d61 6a6f 722c 2064 665f 7363 6f72  s_major, df_scor
+00017310: 655f 6d61 6a6f 722c 2064 665f 4753 415f  e_major, df_GSA_
+00017320: 7363 6f72 655f 6d61 6a6f 7220 3d20 5c0a  score_major = \.
+00017330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017340: 7275 6e5f 6773 615f 616e 645f 636c 6628  run_gsa_and_clf(
+00017350: 2058 5f70 6361 2c20 5873 2c20 636f 626a   X_pca, Xs, cobj
+00017360: 2c20 795f 636c 7573 742c 206d 6b72 5f6c  , y_clust, mkr_l
+00017370: 7374 2c20 6d6b 725f 6c73 745f 6e65 672c  st, mkr_lst_neg,
+00017380: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+00017390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000173a0: 2020 206d 6574 686f 6420 3d20 2767 6d6d     method = 'gmm
+000173b0: 272c 204e 5f63 6f6d 706f 6e65 6e74 7320  ', N_components 
+000173c0: 3d20 4e5f 636f 6d70 6f6e 656e 7473 2c20  = N_components, 
+000173d0: 7076 616c 5f74 6820 3d20 7076 616c 5f74  pval_th = pval_t
+000173e0: 682c 200a 2020 2020 2020 2020 2020 2020  h, .            
+000173f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017400: 2020 2020 2070 6374 5f66 6974 5f70 6e74       pct_fit_pnt
+00017410: 203d 2070 7468 5f66 6974 5f70 6e74 2c20   = pth_fit_pnt, 
+00017420: 7063 745f 6d69 6e5f 7266 203d 2070 6374  pct_min_rf = pct
+00017430: 5f74 685f 6d69 6e2c 0a20 2020 2020 2020  _th_min,.       
+00017440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017450: 2020 2020 2020 2020 2020 5461 7267 6574            Target
+00017460: 5f46 5052 203d 2054 6172 6765 745f 4650  _FPR = Target_FP
+00017470: 522c 2070 6d61 6a20 3d20 706d 616a 2c20  R, pmaj = pmaj, 
+00017480: 6d69 6e6f 725f 6964 5f73 6570 203d 206d  minor_id_sep = m
+00017490: 696e 6f72 5f69 645f 7365 702c 0a20 2020  inor_id_sep,.   
+000174a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000174b0: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
+000174c0: 6e5f 6c6f 6750 5f64 6966 6620 3d20 6d69  n_logP_diff = mi
+000174d0: 6e5f 6c6f 6750 5f64 6966 662c 2074 6872  n_logP_diff, thr
+000174e0: 6573 686f 6c64 696e 6720 3d20 7468 7265  esholding = thre
+000174f0: 7368 6f6c 6469 6e67 2c0a 2020 2020 2020  sholding,.      
+00017500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017510: 2020 2020 2020 2020 2020 2070 6374 5f63             pct_c
+00017520: 7574 6f66 6620 3d20 5472 7565 2c20 6362  utoff = True, cb
+00017530: 635f 6375 746f 6666 203d 2063 6263 5f63  c_cutoff = cbc_c
+00017540: 7574 6f66 662c 2070 7269 6e74 5f72 6570  utoff, print_rep
+00017550: 6f72 7420 3d20 7665 7262 6f73 652c 0a20  ort = verbose,. 
 00017560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017570: 6466 5f72 6573 5f6d 616a 6f72 2e6c 6f63  df_res_major.loc
-00017580: 5b69 6478 2c20 274f 7665 726c 6170 275d  [idx, 'Overlap']
-00017590: 203d 2064 666e 5f6d 616a 6f72 2e6c 6f63   = dfn_major.loc
-000175a0: 5b69 6478 2c63 745d 0a20 2020 2020 2020  [idx,ct].       
-000175b0: 2020 2020 2020 2020 2020 2020 2063 7420               ct 
-000175c0: 3d20 6466 5f72 6573 5f6d 616a 6f72 2e6c  = df_res_major.l
-000175d0: 6f63 5b69 6478 2c20 2763 656c 6c5f 7479  oc[idx, 'cell_ty
-000175e0: 7065 2832 6e64 2927 5d0a 2020 2020 2020  pe(2nd)'].      
-000175f0: 2020 2020 2020 2020 2020 2020 2020 6466                df
-00017600: 5f72 6573 5f6d 616a 6f72 2e6c 6f63 5b69  _res_major.loc[i
-00017610: 6478 2c20 274f 7665 726c 6170 2832 6e64  dx, 'Overlap(2nd
-00017620: 2927 5d20 3d20 6466 6e5f 6d61 6a6f 722e  )'] = dfn_major.
-00017630: 6c6f 635b 6964 782c 6374 5d0a 0a20 2020  loc[idx,ct]..   
-00017640: 2020 2020 2020 2020 2079 5f70 7265 645f           y_pred_
-00017650: 6d61 6a6f 7220 3d20 6466 5f72 6573 5f6d  major = df_res_m
-00017660: 616a 6f72 5b27 6365 6c6c 5f74 7970 6527  ajor['cell_type'
-00017670: 5d0a 2020 2020 2020 2020 2020 2020 7973  ].            ys
-00017680: 5f6d 616a 6f72 203d 2064 665f 7265 735f  _major = df_res_
-00017690: 6d61 6a6f 725b 2763 656c 6c5f 7479 7065  major['cell_type
-000176a0: 2872 6576 2927 5d0a 0a20 2020 2020 2020  (rev)']..       
-000176b0: 2020 2020 2023 2070 7269 6e74 2864 665f       # print(df_
-000176c0: 7265 735f 6d61 6a6f 722e 7368 6170 652c  res_major.shape,
-000176d0: 2064 665f 7363 6f72 655f 6d61 6a6f 722e   df_score_major.
-000176e0: 7368 6170 652c 2064 665f 4753 415f 7363  shape, df_GSA_sc
-000176f0: 6f72 655f 6d61 6a6f 722e 7368 6170 6529  ore_major.shape)
-00017700: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00017710: 286c 656e 2874 6172 6765 745f 6365 6c6c  (len(target_cell
-00017720: 5f74 7970 6573 2920 3e20 3129 2026 2028  _types) > 1) & (
-00017730: 6466 5f73 636f 7265 5f6d 616a 6f72 2069  df_score_major i
-00017740: 7320 6e6f 7420 4e6f 6e65 293a 0a20 2020  s not None):.   
-00017750: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00017760: 6466 5f73 636f 7265 5f6d 616a 6f72 2e73  df_score_major.s
-00017770: 6861 7065 5b31 5d20 3e20 303a 0a20 2020  hape[1] > 0:.   
-00017780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017790: 2062 5f6f 6b2c 206d 6b72 5f6c 7374 2c20   b_ok, mkr_lst, 
-000177a0: 6469 6374 5f63 656c 6c74 7970 655f 636f  dict_celltype_co
-000177b0: 6d62 203d 205c 0a20 2020 2020 2020 2020  mb = \.         
-000177c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000177d0: 6570 6172 6162 696c 6974 795f 6368 6563  eparability_chec
-000177e0: 6b5f 7061 6972 7769 7365 2820 6466 5f73  k_pairwise( df_s
-000177f0: 636f 7265 5f6d 616a 6f72 2c20 7973 5f6d  core_major, ys_m
-00017800: 616a 6f72 2c20 0a20 2020 2020 2020 2020  ajor, .         
-00017810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017830: 2020 206d 6b72 5f6c 7374 2c20 6469 6374     mkr_lst, dict
-00017840: 5f63 656c 6c74 7970 655f 636f 6d62 2c20  _celltype_comb, 
-00017850: 7665 7262 6f73 6529 0a20 2020 2020 2020  verbose).       
-00017860: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00017870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017880: 2020 2062 5f6f 6b20 3d20 5472 7565 0a20     b_ok = True. 
-00017890: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000178a0: 6620 625f 6f6b 3a20 6272 6561 6b0a 2020  f b_ok: break.  
-000178b0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00017570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017580: 6466 5f47 5341 5f73 636f 7265 203d 2064  df_GSA_score = d
+00017590: 665f 7061 7373 290a 2020 2020 2020 2020  f_pass).        
+000175a0: 2020 2020 6966 206e 6f74 2075 7365 5f75      if not use_u
+000175b0: 6e69 6f6e 5f6d 616a 6f72 3a0a 2020 2020  nion_major:.    
+000175c0: 2020 2020 2020 2020 2020 2020 6964 7873              idxs
+000175d0: 203d 2064 665f 7265 735f 6d61 6a6f 722e   = df_res_major.
+000175e0: 696e 6465 782e 7661 6c75 6573 0a20 2020  index.values.   
+000175f0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00017600: 206b 2c20 6964 7820 696e 2065 6e75 6d65   k, idx in enume
+00017610: 7261 7465 286c 6973 7428 6964 7873 2929  rate(list(idxs))
+00017620: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017630: 2020 2020 2020 6374 203d 2064 665f 7265        ct = df_re
+00017640: 735f 6d61 6a6f 722e 6c6f 635b 6964 782c  s_major.loc[idx,
+00017650: 2027 6365 6c6c 5f74 7970 6528 3173 7429   'cell_type(1st)
+00017660: 275d 0a20 2020 2020 2020 2020 2020 2020  '].             
+00017670: 2020 2020 2020 2064 665f 7265 735f 6d61         df_res_ma
+00017680: 6a6f 722e 6c6f 635b 6964 782c 2027 4f76  jor.loc[idx, 'Ov
+00017690: 6572 6c61 7027 5d20 3d20 6466 6e5f 6d61  erlap'] = dfn_ma
+000176a0: 6a6f 722e 6c6f 635b 6964 782c 6374 5d0a  jor.loc[idx,ct].
+000176b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000176c0: 2020 2020 6374 203d 2064 665f 7265 735f      ct = df_res_
+000176d0: 6d61 6a6f 722e 6c6f 635b 6964 782c 2027  major.loc[idx, '
+000176e0: 6365 6c6c 5f74 7970 6528 326e 6429 275d  cell_type(2nd)']
+000176f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017700: 2020 2020 2064 665f 7265 735f 6d61 6a6f       df_res_majo
+00017710: 722e 6c6f 635b 6964 782c 2027 4f76 6572  r.loc[idx, 'Over
+00017720: 6c61 7028 326e 6429 275d 203d 2064 666e  lap(2nd)'] = dfn
+00017730: 5f6d 616a 6f72 2e6c 6f63 5b69 6478 2c63  _major.loc[idx,c
+00017740: 745d 0a0a 2020 2020 2020 2020 2020 2020  t]..            
+00017750: 795f 7072 6564 5f6d 616a 6f72 203d 2064  y_pred_major = d
+00017760: 665f 7265 735f 6d61 6a6f 725b 2763 656c  f_res_major['cel
+00017770: 6c5f 7479 7065 275d 0a20 2020 2020 2020  l_type'].       
+00017780: 2020 2020 2079 735f 6d61 6a6f 7220 3d20       ys_major = 
+00017790: 6466 5f72 6573 5f6d 616a 6f72 5b27 6365  df_res_major['ce
+000177a0: 6c6c 5f74 7970 6528 7265 7629 275d 0a0a  ll_type(rev)']..
+000177b0: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
+000177c0: 696e 7428 6466 5f72 6573 5f6d 616a 6f72  int(df_res_major
+000177d0: 2e73 6861 7065 2c20 6466 5f73 636f 7265  .shape, df_score
+000177e0: 5f6d 616a 6f72 2e73 6861 7065 2c20 6466  _major.shape, df
+000177f0: 5f47 5341 5f73 636f 7265 5f6d 616a 6f72  _GSA_score_major
+00017800: 2e73 6861 7065 290a 2020 2020 2020 2020  .shape).        
+00017810: 2020 2020 6966 2028 6c65 6e28 7461 7267      if (len(targ
+00017820: 6574 5f63 656c 6c5f 7479 7065 7329 203e  et_cell_types) >
+00017830: 2031 2920 2620 2864 665f 7363 6f72 655f   1) & (df_score_
+00017840: 6d61 6a6f 7220 6973 206e 6f74 204e 6f6e  major is not Non
+00017850: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00017860: 2020 2020 6966 2064 665f 7363 6f72 655f      if df_score_
+00017870: 6d61 6a6f 722e 7368 6170 655b 315d 203e  major.shape[1] >
+00017880: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00017890: 2020 2020 2020 2020 625f 6f6b 2c20 6d6b          b_ok, mk
+000178a0: 725f 6c73 742c 2064 6963 745f 6365 6c6c  r_lst, dict_cell
+000178b0: 7479 7065 5f63 6f6d 6220 3d20 5c0a 2020  type_comb = \.  
 000178c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000178d0: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
-000178e0: 2020 2020 2020 0a20 2020 2020 2020 2079        .        y
-000178f0: 5f70 7265 645f 636f 7272 6563 7420 3d20  _pred_correct = 
-00017900: 795f 7072 6564 5f6d 616a 6f72 0a20 2020  y_pred_major.   
-00017910: 2020 2020 2062 5f63 7572 203d 2079 5f70       b_cur = y_p
-00017920: 7265 645f 636f 7272 6563 7420 3d3d 2027  red_correct == '
-00017930: 756e 6173 7369 676e 6564 270a 2020 2020  unassigned'.    
-00017940: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
-00017950: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00017960: 7428 274e 756d 206f 6620 756e 6173 7369  t('Num of unassi
-00017970: 676e 6564 2063 656c 6c73 3a20 2569 2061  gned cells: %i a
-00017980: 6d6f 6e67 2025 6927 2025 2028 6e70 2e73  mong %i' % (np.s
-00017990: 756d 2862 5f63 7572 292c 206c 656e 2862  um(b_cur), len(b
-000179a0: 5f63 7572 2929 290a 0a20 2020 2020 2020  _cur)))..       
-000179b0: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
-000179c0: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-000179d0: 4d61 6a6f 7220 6365 6c6c 2074 7970 6520  Major cell type 
-000179e0: 6964 656e 7469 6669 6361 7469 6f6e 2064  identification d
-000179f0: 6f6e 652e 2028 2569 2927 2025 205c 0a20  one. (%i)' % \. 
-00017a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017a10: 2020 726f 756e 6428 7469 6d65 2e74 696d    round(time.tim
-00017a20: 6528 2920 2d20 7374 6172 745f 7469 6d65  e() - start_time
-00017a30: 2929 0a20 2020 2020 2020 2065 6c73 653a  )).        else:
-00017a40: 200a 2020 2020 2020 2020 2020 2020 6574   .            et
-00017a50: 696d 6520 3d20 726f 756e 6428 7469 6d65  ime = round(time
-00017a60: 2e74 696d 6528 2920 2d20 7374 6172 745f  .time() - start_
-00017a70: 7469 6d65 5f6e 6577 2920 2020 2020 2020  time_new)       
-00017a80: 200a 2020 2020 2020 2020 2020 2020 7374   .            st
-00017a90: 6172 745f 7469 6d65 5f6e 6577 203d 2074  art_time_new = t
-00017aa0: 696d 652e 7469 6d65 2829 0a20 2020 2020  ime.time().     
-00017ab0: 2020 2020 2020 2070 7269 6e74 2827 4d25         print('M%
-00017ac0: 692e 2720 2520 6574 696d 652c 2065 6e64  i.' % etime, end
-00017ad0: 203d 2027 272c 2066 6c75 7368 203d 2054   = '', flush = T
-00017ae0: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
-00017af0: 2023 2070 6c6f 745f 726f 635f 7265 7375   # plot_roc_resu
-00017b00: 6c74 2864 665f 7363 6f72 655f 6d61 6a6f  lt(df_score_majo
-00017b10: 722c 2079 735f 6d61 6a6f 722c 206d 6574  r, ys_major, met
-00017b20: 686f 6429 0a0a 2020 2020 2020 2020 6466  hod)..        df
-00017b30: 5f70 7265 6432 203d 2070 642e 4461 7461  _pred2 = pd.Data
-00017b40: 4672 616d 6528 696e 6465 7820 3d20 6466  Frame(index = df
-00017b50: 5f72 6573 5f6d 616a 6f72 2e69 6e64 6578  _res_major.index
-00017b60: 2e76 616c 7565 7329 0a20 2020 2020 2020  .values).       
-00017b70: 2064 665f 7072 6564 325b 2763 6c75 7374   df_pred2['clust
-00017b80: 6572 5f72 6576 275d 203d 2079 5f63 6c75  er_rev'] = y_clu
-00017b90: 7374 202b 2031 0a20 2020 2020 2020 2064  st + 1.        d
-00017ba0: 665f 7072 6564 325b 2763 6c75 7374 6572  f_pred2['cluster
-00017bb0: 5f72 6576 275d 203d 2064 665f 7072 6564  _rev'] = df_pred
-00017bc0: 325b 2763 6c75 7374 6572 5f72 6576 275d  2['cluster_rev']
-00017bd0: 2e61 7374 7970 6528 7374 7229 0a20 2020  .astype(str).   
-00017be0: 2020 2020 200a 2020 2020 2020 2020 6466       .        df
-00017bf0: 5f70 7265 6420 3d20 7064 2e44 6174 6146  _pred = pd.DataF
-00017c00: 7261 6d65 287b 2763 656c 6c5f 7479 7065  rame({'cell_type
-00017c10: 5f6d 616a 6f72 273a 2079 5f70 7265 645f  _major': y_pred_
-00017c20: 636f 7272 6563 747d 2c0a 2020 2020 2020  correct},.      
-00017c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017c40: 2020 2020 2020 2020 2020 696e 6465 7820            index 
-00017c50: 3d20 6466 5f72 6573 5f6d 616a 6f72 2e69  = df_res_major.i
-00017c60: 6e64 6578 2e76 616c 7565 7329 0a20 2020  ndex.values).   
-00017c70: 2020 2020 2064 665f 7072 6564 5b27 6365       df_pred['ce
-00017c80: 6c6c 5f74 7970 655f 6d69 6e6f 7227 5d20  ll_type_minor'] 
-00017c90: 3d20 2775 6e61 7373 6967 6e65 6427 0a20  = 'unassigned'. 
-00017ca0: 2020 2020 2020 2064 665f 7072 6564 5b27         df_pred['
-00017cb0: 6365 6c6c 5f74 7970 655f 7375 6273 6574  cell_type_subset
-00017cc0: 275d 203d 2027 756e 6173 7369 676e 6564  '] = 'unassigned
-00017cd0: 270a 2020 2020 2020 2020 6466 5f70 7265  '.        df_pre
-00017ce0: 645b 2763 6c75 7374 6572 275d 203d 2079  d['cluster'] = y
-00017cf0: 5f63 6c75 7374 202b 2031 0a20 2020 2020  _clust + 1.     
-00017d00: 2020 2064 665f 7072 6564 5b27 636c 7573     df_pred['clus
-00017d10: 7465 7227 5d20 3d20 6466 5f70 7265 645b  ter'] = df_pred[
-00017d20: 2763 6c75 7374 6572 275d 2e61 7374 7970  'cluster'].astyp
-00017d30: 6528 7374 7229 0a0a 2020 2020 2020 2020  e(str)..        
-00017d40: 6466 5f70 7265 645b 2763 656c 6c5f 7479  df_pred['cell_ty
-00017d50: 7065 2831 7374 2927 5d20 3d20 6466 5f72  pe(1st)'] = df_r
-00017d60: 6573 5f6d 616a 6f72 5b27 6365 6c6c 5f74  es_major['cell_t
-00017d70: 7970 6528 3173 7429 275d 2e61 7374 7970  ype(1st)'].astyp
-00017d80: 6528 7374 7229 0a20 2020 2020 2020 2064  e(str).        d
-00017d90: 665f 7072 6564 5b27 436f 6e66 6964 656e  f_pred['Confiden
-00017da0: 6365 2831 7374 2927 5d20 3d20 6466 5f72  ce(1st)'] = df_r
-00017db0: 6573 5f6d 616a 6f72 5b27 2d6c 6f67 5027  es_major['-logP'
-00017dc0: 5d2e 6173 7479 7065 2866 6c6f 6174 290a  ].astype(float).
-00017dd0: 2020 2020 2020 2020 6466 5f70 7265 645b          df_pred[
-00017de0: 2763 656c 6c5f 7479 7065 2832 6e64 2927  'cell_type(2nd)'
-00017df0: 5d20 3d20 6466 5f72 6573 5f6d 616a 6f72  ] = df_res_major
-00017e00: 5b27 6365 6c6c 5f74 7970 6528 326e 6429  ['cell_type(2nd)
-00017e10: 275d 2e61 7374 7970 6528 7374 7229 0a20  '].astype(str). 
-00017e20: 2020 2020 2020 2064 665f 7072 6564 5b27         df_pred['
-00017e30: 436f 6e66 6964 656e 6365 2832 6e64 2927  Confidence(2nd)'
-00017e40: 5d20 3d20 6466 5f72 6573 5f6d 616a 6f72  ] = df_res_major
-00017e50: 5b27 2d6c 6f67 5028 326e 6429 275d 2e61  ['-logP(2nd)'].a
-00017e60: 7374 7970 6528 666c 6f61 7429 0a20 2020  stype(float).   
-00017e70: 2020 2020 200a 2020 2020 2020 2020 6469       .        di
-00017e80: 6374 5f73 756d 6d61 7279 5f72 6573 5b27  ct_summary_res['
-00017e90: 4d61 6a6f 725f 5479 7065 275d 203d 2064  Major_Type'] = d
-00017ea0: 665f 7265 735f 6d61 6a6f 720a 2020 2020  f_res_major.    
-00017eb0: 2020 2020 6469 6374 5f73 756d 6d61 7279      dict_summary
-00017ec0: 5f73 636f 7265 5b27 4d61 6a6f 725f 5479  _score['Major_Ty
-00017ed0: 7065 275d 203d 2064 665f 7363 6f72 655f  pe'] = df_score_
-00017ee0: 6d61 6a6f 720a 2020 2020 2020 2020 6469  major.        di
-00017ef0: 6374 5f73 756d 6d61 7279 5f73 636f 7265  ct_summary_score
-00017f00: 325b 274d 616a 6f72 5f54 7970 6527 5d20  2['Major_Type'] 
-00017f10: 3d20 6466 5f47 5341 5f73 636f 7265 5f6d  = df_GSA_score_m
-00017f20: 616a 6f72 0a20 2020 2020 2020 200a 2020  ajor.        .  
-00017f30: 2020 2327 2727 0a20 2020 2023 2323 2323    #'''.    #####
-00017f40: 204d 696e 6f72 2074 7970 6520 6964 656e   Minor type iden
-00017f50: 7469 6669 6361 7469 6f6e 2066 6f72 2073  tification for s
-00017f60: 656c 6563 7465 6420 6365 6c6c 730a 2020  elected cells.  
-00017f70: 2020 6966 2069 6465 6e74 5f6c 6576 656c    if ident_level
-00017f80: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
-00017f90: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-00017fa0: 2020 2064 665f 7072 6564 5b27 6365 6c6c     df_pred['cell
-00017fb0: 5f74 7970 655f 6d69 6e6f 7228 3173 7429  _type_minor(1st)
-00017fc0: 275d 203d 2064 665f 7072 6564 5b27 6365  '] = df_pred['ce
-00017fd0: 6c6c 5f74 7970 6528 3173 7429 275d 2e61  ll_type(1st)'].a
-00017fe0: 7374 7970 6528 7374 7229 0a20 2020 2020  stype(str).     
-00017ff0: 2020 2064 665f 7072 6564 5b27 436f 6e66     df_pred['Conf
-00018000: 6964 656e 6365 5f6d 696e 6f72 2831 7374  idence_minor(1st
-00018010: 2927 5d20 3d20 6466 5f70 7265 645b 2743  )'] = df_pred['C
-00018020: 6f6e 6669 6465 6e63 6528 3173 7429 275d  onfidence(1st)']
-00018030: 2e61 7374 7970 6528 666c 6f61 7429 0a20  .astype(float). 
-00018040: 2020 2020 2020 2064 665f 7072 6564 5b27         df_pred['
-00018050: 6365 6c6c 5f74 7970 655f 6d69 6e6f 7228  cell_type_minor(
-00018060: 326e 6429 275d 203d 2064 665f 7072 6564  2nd)'] = df_pred
-00018070: 5b27 6365 6c6c 5f74 7970 6528 3173 7429  ['cell_type(1st)
-00018080: 275d 2e61 7374 7970 6528 7374 7229 0a20  '].astype(str). 
-00018090: 2020 2020 2020 2064 665f 7072 6564 5b27         df_pred['
-000180a0: 436f 6e66 6964 656e 6365 5f6d 696e 6f72  Confidence_minor
-000180b0: 2832 6e64 2927 5d20 3d20 6466 5f70 7265  (2nd)'] = df_pre
-000180c0: 645b 2743 6f6e 6669 6465 6e63 6528 3173  d['Confidence(1s
-000180d0: 7429 275d 2e61 7374 7970 6528 666c 6f61  t)'].astype(floa
-000180e0: 7429 0a20 2020 2020 2020 200a 2020 2020  t).        .    
-000180f0: 2020 2020 2323 2043 6c75 7374 6572 2062      ## Cluster b
-00018100: 6173 6973 2074 6172 6765 7420 6365 6c6c  asis target cell
-00018110: 7320 5365 6c65 6374 696f 6e20 0a20 2020  s Selection .   
-00018120: 2020 2020 2062 5f73 656c 203d 2079 5f70       b_sel = y_p
-00018130: 7265 645f 636f 7272 6563 7420 213d 2027  red_correct != '
-00018140: 756e 6173 7369 676e 6564 270a 2020 2020  unassigned'.    
-00018150: 2020 2020 625f 7365 6c5b 3a5d 203d 2046      b_sel[:] = F
-00018160: 616c 7365 0a20 2020 2020 2020 2063 6c75  alse.        clu
-00018170: 7374 6572 5f6c 7374 203d 206c 6973 7428  ster_lst = list(
-00018180: 7365 7428 795f 636c 7573 7429 290a 2020  set(y_clust)).  
-00018190: 2020 2020 2020 666f 7220 636c 7374 2069        for clst i
-000181a0: 6e20 636c 7573 7465 725f 6c73 743a 0a20  n cluster_lst:. 
-000181b0: 2020 2020 2020 2020 2020 2062 6320 3d20             bc = 
-000181c0: 795f 636c 7573 7420 3d3d 2063 6c73 740a  y_clust == clst.
-000181d0: 2020 2020 2020 2020 2020 2020 6261 203d              ba =
-000181e0: 2079 5f70 7265 645f 636f 7272 6563 7420   y_pred_correct 
-000181f0: 3d3d 2027 756e 6173 7369 676e 6564 270a  == 'unassigned'.
-00018200: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00018210: 702e 7375 6d28 6263 2662 6129 203c 3d20  p.sum(bc&ba) <= 
-00018220: 6e70 2e73 756d 2862 6329 2a70 6d61 6a3a  np.sum(bc)*pmaj:
-00018230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018240: 2062 5f73 656c 5b62 635d 203d 2054 7275   b_sel[bc] = Tru
-00018250: 650a 0a20 2020 2020 2020 2023 2320 5275  e..        ## Ru
-00018260: 6e20 4753 4120 616e 6420 7065 7266 6f72  n GSA and perfor
-00018270: 6d20 6964 656e 7469 6669 6361 7469 6f6e  m identification
-00018280: 0a20 2020 2020 2020 2058 5f73 656c 203d  .        X_sel =
-00018290: 2058 732e 6c6f 635b 625f 7365 6c2c 3a5d   Xs.loc[b_sel,:]
-000182a0: 0a20 2020 2020 2020 2023 2058 5f6c 6f67  .        # X_log
-000182b0: 5f73 656c 203d 2058 5f6c 6f67 2e6c 6f63  _sel = X_log.loc
-000182c0: 5b62 5f73 656c 2c3a 5d0a 2020 2020 2020  [b_sel,:].      
-000182d0: 2020 585f 7063 615f 7365 6c20 3d20 585f    X_pca_sel = X_
-000182e0: 7063 612e 6c6f 635b 625f 7365 6c2c 3a5d  pca.loc[b_sel,:]
-000182f0: 0a20 2020 2020 2020 2079 5f63 6c75 7374  .        y_clust
-00018300: 5f73 656c 203d 2079 5f63 6c75 7374 5b62  _sel = y_clust[b
-00018310: 5f73 656c 5d0a 2020 2020 2020 2020 795f  _sel].        y_
-00018320: 7072 6564 5f73 656c 203d 2079 5f70 7265  pred_sel = y_pre
-00018330: 645f 636f 7272 6563 745b 625f 7365 6c5d  d_correct[b_sel]
-00018340: 0a0a 2020 2020 2020 2020 2323 2047 6574  ..        ## Get
-00018350: 2063 656c 6c2d 7479 7065 206c 6973 7473   cell-type lists
-00018360: 0a20 2020 2020 2020 2074 6172 6765 745f  .        target_
-00018370: 6365 6c6c 5f6c 7374 203d 207b 7d20 2320  cell_lst = {} # 
-00018380: 7461 7267 6574 5f63 656c 6c5f 7479 7065  target_cell_type
-00018390: 730a 2020 2020 2020 2020 666f 7220 6320  s.        for c 
-000183a0: 696e 206d 6b72 5f6c 7374 2e6b 6579 7328  in mkr_lst.keys(
-000183b0: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-000183c0: 6620 6320 696e 2064 6963 745f 6365 6c6c  f c in dict_cell
-000183d0: 7479 7065 5f63 6f6d 622e 6b65 7973 2829  type_comb.keys()
-000183e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000183f0: 2020 7461 7267 6574 5f63 656c 6c5f 6c73    target_cell_ls
-00018400: 745b 635d 203d 2064 6963 745f 6365 6c6c  t[c] = dict_cell
-00018410: 7479 7065 5f63 6f6d 625b 635d 0a20 2020  type_comb[c].   
-00018420: 2020 2020 2020 2020 2065 6c69 6620 6320           elif c 
-00018430: 696e 2074 6172 6765 745f 6365 6c6c 5f74  in target_cell_t
-00018440: 7970 6573 3a0a 2020 2020 2020 2020 2020  ypes:.          
-00018450: 2020 2020 2020 7461 7267 6574 5f63 656c        target_cel
-00018460: 6c5f 6c73 745b 635d 203d 205b 635d 0a0a  l_lst[c] = [c]..
-00018470: 2020 2020 2020 2020 6d6b 725f 6c73 7420          mkr_lst 
-00018480: 3d20 7b7d 0a20 2020 2020 2020 206d 6b72  = {}.        mkr
-00018490: 5f6c 7374 5f6e 6567 203d 207b 7d0a 2020  _lst_neg = {}.  
-000184a0: 2020 2020 2020 666f 7220 6320 696e 2074        for c in t
-000184b0: 6172 6765 745f 6365 6c6c 5f6c 7374 2e6b  arget_cell_lst.k
-000184c0: 6579 7328 293a 0a20 2020 2020 2020 2020  eys():.         
-000184d0: 2020 2074 6172 6765 745f 6365 6c6c 203d     target_cell =
-000184e0: 2074 6172 6765 745f 6365 6c6c 5f6c 7374   target_cell_lst
-000184f0: 5b63 5d0a 2020 2020 2020 2020 2020 2020  [c].            
-00018500: 6d6b 725f 6c73 745f 746d 702c 206d 6b72  mkr_lst_tmp, mkr
-00018510: 5f6c 7374 5f6e 6567 5f74 6d70 203d 2067  _lst_neg_tmp = g
-00018520: 6574 5f6d 6172 6b65 7273 5f63 656c 6c5f  et_markers_cell_
-00018530: 7479 7065 286d 6172 6b65 725f 6669 6c65  type(marker_file
-00018540: 2c20 7461 7267 6574 5f63 656c 6c2c 200a  , target_cell, .
-00018550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018570: 2020 2020 2020 2020 2020 2020 706e 7368              pnsh
-00018580: 3132 203d 206d 6b72 5f73 656c 6563 746f  12 = mkr_selecto
-00018590: 722c 2072 656d 5f63 6f6d 6d6f 6e20 3d20  r, rem_common = 
-000185a0: 7265 6d5f 636d 6e5f 6d6b 722c 0a20 2020  rem_cmn_mkr,.   
-000185b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000185c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000185d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000185e0: 2020 2020 2020 2020 2020 2020 2020 7665                ve
-000185f0: 7262 6f73 6520 3d20 4661 6c73 6529 0a20  rbose = False). 
-00018600: 2020 2020 2020 2020 2020 206d 6b72 5f6c             mkr_l
-00018610: 7374 2e75 7064 6174 6528 6d6b 725f 6c73  st.update(mkr_ls
-00018620: 745f 746d 7029 0a20 2020 2020 2020 2020  t_tmp).         
-00018630: 2020 206d 6b72 5f6c 7374 5f6e 6567 2e75     mkr_lst_neg.u
-00018640: 7064 6174 6528 6d6b 725f 6c73 745f 6e65  pdate(mkr_lst_ne
-00018650: 675f 746d 7029 0a0a 2020 2020 2020 2020  g_tmp)..        
-00018660: 6966 206c 656e 286d 696e 6f72 5f74 7970  if len(minor_typ
-00018670: 6573 5f74 6f5f 6578 636c 7564 6529 203e  es_to_exclude) >
-00018680: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00018690: 6d6b 725f 6c73 7420 3d20 7265 6d5f 6d69  mkr_lst = rem_mi
-000186a0: 6e6f 7228 206d 6b72 5f6c 7374 2c20 6d69  nor( mkr_lst, mi
-000186b0: 6e6f 725f 7479 7065 735f 746f 5f65 7863  nor_types_to_exc
-000186c0: 6c75 6465 2029 0a20 2020 2020 2020 2020  lude ).         
-000186d0: 2020 206d 6b72 5f6c 7374 5f6e 6567 203d     mkr_lst_neg =
-000186e0: 2072 656d 5f6d 696e 6f72 2820 6d6b 725f   rem_minor( mkr_
-000186f0: 6c73 745f 6e65 672c 206d 696e 6f72 5f74  lst_neg, minor_t
-00018700: 7970 6573 5f74 6f5f 6578 636c 7564 6520  ypes_to_exclude 
-00018710: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
-00018720: 2020 2023 2323 2054 6f20 7573 6520 696e     ### To use in
-00018730: 2074 6865 2073 7562 7365 7420 6964 656e   the subset iden
-00018740: 7469 6669 6361 7469 6f6e 0a20 2020 2020  tification.     
-00018750: 2020 206d 6b72 5f6c 7374 5f73 6176 203d     mkr_lst_sav =
-00018760: 2063 6f70 792e 6465 6570 636f 7079 286d   copy.deepcopy(m
-00018770: 6b72 5f6c 7374 290a 0a20 2020 2020 2020  kr_lst)..       
-00018780: 2069 6478 5f73 656c 203d 2058 5f70 6361   idx_sel = X_pca
-00018790: 5f73 656c 2e69 6e64 6578 2e76 616c 7565  _sel.index.value
-000187a0: 730a 0a20 2020 2020 2020 2064 665f 4753  s..        df_GS
-000187b0: 415f 7363 6f72 655f 6d69 6e6f 725f 616c  A_score_minor_al
-000187c0: 6c20 3d20 7064 2e44 6174 6146 7261 6d65  l = pd.DataFrame
-000187d0: 2869 6e64 6578 203d 2064 665f 7072 6564  (index = df_pred
-000187e0: 2e69 6e64 6578 290a 2020 2020 2020 2020  .index).        
-000187f0: 0a20 2020 2020 2020 2063 6e74 203d 2030  .        cnt = 0
-00018800: 0a20 2020 2020 2020 2066 6f72 2074 6320  .        for tc 
-00018810: 696e 2074 6172 6765 745f 6365 6c6c 5f6c  in target_cell_l
-00018820: 7374 2e6b 6579 7328 293a 0a20 2020 2020  st.keys():.     
-00018830: 2020 2020 2020 2074 6172 6765 745f 6365         target_ce
-00018840: 6c6c 203d 2074 6172 6765 745f 6365 6c6c  ll = target_cell
-00018850: 5f6c 7374 5b74 635d 0a20 2020 2020 2020  _lst[tc].       
-00018860: 2020 2020 206d 6b72 5f6c 7374 2c20 6d6b       mkr_lst, mk
-00018870: 725f 6c73 745f 6e65 6720 3d20 6765 745f  r_lst_neg = get_
-00018880: 6d61 726b 6572 735f 6365 6c6c 5f74 7970  markers_cell_typ
-00018890: 6528 6d61 726b 6572 5f66 696c 652c 2074  e(marker_file, t
-000188a0: 6172 6765 745f 6365 6c6c 2c20 0a20 2020  arget_cell, .   
-000188b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000188c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000188d0: 2020 2020 2020 2020 2070 6e73 6831 3220           pnsh12 
-000188e0: 3d20 6d6b 725f 7365 6c65 6374 6f72 2c20  = mkr_selector, 
-000188f0: 7265 6d5f 636f 6d6d 6f6e 203d 2072 656d  rem_common = rem
-00018900: 5f63 6d6e 5f6d 6b72 2c0a 2020 2020 2020  _cmn_mkr,.      
-00018910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018940: 2020 2076 6572 626f 7365 203d 2046 616c     verbose = Fal
-00018950: 7365 290a 0a20 2020 2020 2020 2020 2020  se)..           
-00018960: 2069 6620 6c65 6e28 6d69 6e6f 725f 7479   if len(minor_ty
-00018970: 7065 735f 746f 5f65 7863 6c75 6465 2920  pes_to_exclude) 
-00018980: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-00018990: 2020 2020 206d 6b72 5f6c 7374 203d 2072       mkr_lst = r
-000189a0: 656d 5f6d 696e 6f72 2820 6d6b 725f 6c73  em_minor( mkr_ls
-000189b0: 742c 206d 696e 6f72 5f74 7970 6573 5f74  t, minor_types_t
-000189c0: 6f5f 6578 636c 7564 6520 290a 2020 2020  o_exclude ).    
-000189d0: 2020 2020 2020 2020 2020 2020 6d6b 725f              mkr_
-000189e0: 6c73 745f 6e65 6720 3d20 7265 6d5f 6d69  lst_neg = rem_mi
-000189f0: 6e6f 7228 206d 6b72 5f6c 7374 5f6e 6567  nor( mkr_lst_neg
-00018a00: 2c20 6d69 6e6f 725f 7479 7065 735f 746f  , minor_types_to
-00018a10: 5f65 7863 6c75 6465 2029 0a20 2020 200a  _exclude ).    .
-00018a20: 2020 2020 2020 2020 2020 2020 736d 203d              sm =
-00018a30: 2027 270a 2020 2020 2020 2020 2020 2020   ''.            
-00018a40: 666f 7220 6b65 7920 696e 206d 6b72 5f6c  for key in mkr_l
-00018a50: 7374 2e6b 6579 7328 293a 0a20 2020 2020  st.keys():.     
-00018a60: 2020 2020 2020 2020 2020 2073 6d20 3d20             sm = 
-00018a70: 736d 202b 2027 2573 2c27 2025 206b 6579  sm + '%s,' % key
-00018a80: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00018a90: 7665 7262 6f73 653a 2070 7269 6e74 2827  verbose: print('
-00018aa0: 2573 206d 696e 6f72 2074 7970 6520 6964  %s minor type id
-00018ab0: 656e 7469 6669 6361 7469 6f6e 3a20 2573  entification: %s
-00018ac0: 2720 2520 2874 632c 2073 6d5b 3a2d 315d  ' % (tc, sm[:-1]
-00018ad0: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
-00018ae0: 625f 6375 7220 3d20 795f 7072 6564 5f73  b_cur = y_pred_s
-00018af0: 656c 203d 3d20 2775 6e61 7373 6967 6e65  el == 'unassigne
-00018b00: 6427 0a20 2020 2020 2020 2020 2020 2062  d'.            b
-00018b10: 5f63 7572 5b3a 5d20 3d20 4661 6c73 650a  _cur[:] = False.
-00018b20: 2020 2020 2020 2020 2020 2020 636c 7573              clus
-00018b30: 7465 725f 6c73 7420 3d20 6c69 7374 2873  ter_lst = list(s
-00018b40: 6574 2879 5f63 6c75 7374 5f73 656c 2929  et(y_clust_sel))
-00018b50: 0a0a 2020 2020 2020 2020 2020 2020 2327  ..            #'
-00018b60: 2727 0a20 2020 2020 2020 2020 2020 2066  ''.            f
-00018b70: 6f72 2063 6c73 7420 696e 2063 6c75 7374  or clst in clust
-00018b80: 6572 5f6c 7374 3a0a 2020 2020 2020 2020  er_lst:.        
-00018b90: 2020 2020 2020 2020 6263 203d 2079 5f63          bc = y_c
-00018ba0: 6c75 7374 5f73 656c 203d 3d20 636c 7374  lust_sel == clst
-00018bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018bc0: 2062 6120 3d20 795f 7072 6564 5f73 656c   ba = y_pred_sel
-00018bd0: 203d 3d20 7463 0a20 2020 2020 2020 2020   == tc.         
-00018be0: 2020 2020 2020 2069 6620 6e70 2e73 756d         if np.sum
-00018bf0: 2862 6326 6261 2920 3e3d 206e 702e 7375  (bc&ba) >= np.su
-00018c00: 6d28 6263 292a 706d 616a 3a0a 2020 2020  m(bc)*pmaj:.    
-00018c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018c20: 625f 6375 725b 6263 5d20 3d20 5472 7565  b_cur[bc] = True
-00018c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018c40: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00018c50: 2020 2020 2020 2020 2020 2062 5f63 7572             b_cur
-00018c60: 5b62 615d 203d 2054 7275 650a 2020 2020  [ba] = True.    
-00018c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018c80: 0a20 2020 2020 2020 2020 2020 2023 2727  .            #''
-00018c90: 270a 2020 2020 2020 2020 2020 2020 0a20  '.            . 
-00018ca0: 2020 2020 2020 2020 2020 2023 2320 5275             ## Ru
-00018cb0: 6e20 4753 4120 616e 6420 7065 7266 6f72  n GSA and perfor
-00018cc0: 6d20 6964 656e 7469 6669 6361 7469 6f6e  m identification
-00018cd0: 0a20 2020 2020 2020 2020 2020 2058 5f63  .            X_c
-00018ce0: 7572 203d 2058 5f73 656c 2e6c 6f63 5b62  ur = X_sel.loc[b
-00018cf0: 5f63 7572 2c3a 5d0a 2020 2020 2020 2020  _cur,:].        
-00018d00: 2020 2020 585f 7063 615f 6375 7220 3d20      X_pca_cur = 
-00018d10: 585f 7063 615f 7365 6c2e 6c6f 635b 625f  X_pca_sel.loc[b_
-00018d20: 6375 722c 3a5d 0a20 2020 2020 2020 2020  cur,:].         
-00018d30: 2020 2079 5f63 6c75 7374 5f63 7572 203d     y_clust_cur =
-00018d40: 2079 5f63 6c75 7374 5f73 656c 5b62 5f63   y_clust_sel[b_c
-00018d50: 7572 5d0a 2020 2020 2020 2020 2020 2020  ur].            
-00018d60: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
-00018d70: 6872 6573 686f 6c64 696e 675f 6d69 6e6f  hresholding_mino
-00018d80: 7220 3d20 7468 7265 7368 6f6c 6469 6e67  r = thresholding
-00018d90: 5f6d 735b 305d 0a20 2020 2020 2020 2020  _ms[0].         
-00018da0: 2020 2023 2070 6374 5f63 7574 6f66 665f     # pct_cutoff_
-00018db0: 6d69 6e6f 7220 3d20 7063 745f 6375 746f  minor = pct_cuto
-00018dc0: 6666 5f6d 735b 305d 0a20 2020 2020 2020  ff_ms[0].       
-00018dd0: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-00018de0: 2020 2323 2052 6564 6f20 5043 4120 616e    ## Redo PCA an
-00018df0: 6420 436c 7573 7465 7269 6e67 2023 2323  d Clustering ###
-00018e00: 2323 0a20 2020 2020 2020 2020 2020 206d  ##.            m
-00018e10: 696e 6f72 5f74 7970 655f 6c73 745f 6375  inor_type_lst_cu
-00018e20: 7220 3d20 6c69 7374 286d 6b72 5f6c 7374  r = list(mkr_lst
-00018e30: 2e6b 6579 7328 2929 0a20 2020 2020 2020  .keys()).       
-00018e40: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-00018e50: 2020 2323 2320 546f 2062 6520 7573 6564    ### To be used
-00018e60: 2074 6f20 6465 7465 726d 696e 6520 6d69   to determine mi
-00018e70: 6e6f 7220 7479 7065 2066 6f72 2067 6976  nor type for giv
-00018e80: 656e 2073 7562 7365 740a 2020 2020 2020  en subset.      
-00018e90: 2020 2020 2020 6d61 705f 6469 6374 5f73        map_dict_s
-00018ea0: 7562 326d 696e 203d 207b 7d0a 2020 2020  ub2min = {}.    
-00018eb0: 2020 2020 2020 2020 6d61 705f 6469 6374          map_dict
-00018ec0: 5f6d 696e 3273 7562 203d 207b 7d0a 2020  _min2sub = {}.  
-00018ed0: 2020 2020 2020 2020 2020 666f 7220 6378            for cx
-00018ee0: 2069 6e20 6d69 6e6f 725f 7479 7065 5f6c   in minor_type_l
-00018ef0: 7374 5f63 7572 3a20 2320 666f 7220 6561  st_cur: # for ea
-00018f00: 6368 206d 696e 6f72 2074 7970 650a 2020  ch minor type.  
-00018f10: 2020 2020 2020 2020 2020 2020 2020 6d6b                mk
-00018f20: 725f 6c73 745f 746d 702c 206d 6b72 5f6c  r_lst_tmp, mkr_l
-00018f30: 7374 5f6e 6567 5f74 6d70 203d 2067 6574  st_neg_tmp = get
-00018f40: 5f6d 6172 6b65 7273 5f6d 696e 6f72 5f74  _markers_minor_t
-00018f50: 7970 6532 286d 6172 6b65 725f 6669 6c65  ype2(marker_file
-00018f60: 2c20 5b63 785d 2c20 0a20 2020 2020 2020  , [cx], .       
-00018f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018f90: 2070 6e73 6831 3220 3d20 6d6b 725f 7365   pnsh12 = mkr_se
-00018fa0: 6c65 6374 6f72 2c20 7265 6d5f 636f 6d6d  lector, rem_comm
-00018fb0: 6f6e 203d 2072 656d 5f63 6d6e 5f6d 6b72  on = rem_cmn_mkr
-00018fc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018fe0: 2020 2020 2020 2020 2020 636f 6d62 5f6d            comb_m
-00018ff0: 6b72 7320 3d20 636f 6d62 5f6d 6b72 732c  krs = comb_mkrs,
-00019000: 2076 6572 626f 7365 203d 2046 616c 7365   verbose = False
-00019010: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00019020: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
-00019030: 2020 2066 6f72 206b 6579 2069 6e20 6d6b     for key in mk
-00019040: 725f 6c73 745f 746d 702e 6b65 7973 2829  r_lst_tmp.keys()
-00019050: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00019060: 2020 2020 2020 6d61 705f 6469 6374 5f73        map_dict_s
-00019070: 7562 326d 696e 5b6b 6579 5d20 3d20 6378  ub2min[key] = cx
-00019080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019090: 206d 6170 5f64 6963 745f 6d69 6e32 7375   map_dict_min2su
-000190a0: 625b 6378 5d20 3d20 6c69 7374 286d 6b72  b[cx] = list(mkr
-000190b0: 5f6c 7374 5f74 6d70 2e6b 6579 7328 2929  _lst_tmp.keys())
-000190c0: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
-000190d0: 2020 2020 2020 2020 2020 2323 2323 2323            ######
-000190e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000190f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019100: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019110: 2323 0a20 2020 2020 2020 2020 2020 2069  ##.            i
-00019120: 6620 6e6f 7420 7573 655f 756e 696f 6e3a  f not use_union:
-00019130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019140: 206d 6b72 5f6c 7374 2c20 6d6b 725f 6c73   mkr_lst, mkr_ls
-00019150: 745f 6e65 6720 3d20 6765 745f 6d61 726b  t_neg = get_mark
-00019160: 6572 735f 6d69 6e6f 725f 7479 7065 3228  ers_minor_type2(
-00019170: 6d61 726b 6572 5f66 696c 652c 206d 696e  marker_file, min
-00019180: 6f72 5f74 7970 655f 6c73 745f 6375 722c  or_type_lst_cur,
-00019190: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-000191a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000191b0: 2020 706e 7368 3132 203d 206d 6b72 5f73    pnsh12 = mkr_s
-000191c0: 656c 6563 746f 722c 2072 656d 5f63 6f6d  elector, rem_com
-000191d0: 6d6f 6e20 3d20 7265 6d5f 636d 6e5f 6d6b  mon = rem_cmn_mk
-000191e0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-000191f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019200: 2020 2063 6f6d 625f 6d6b 7273 203d 2063     comb_mkrs = c
-00019210: 6f6d 625f 6d6b 7273 2c20 7665 7262 6f73  omb_mkrs, verbos
-00019220: 6520 3d20 4661 6c73 6529 0a0a 2020 2020  e = False)..    
-00019230: 2020 2020 2020 2020 6966 2028 6c65 6e28          if (len(
-00019240: 6c69 7374 286d 6b72 5f6c 7374 2e6b 6579  list(mkr_lst.key
-00019250: 7328 2929 2920 3c3d 2031 293a 0a20 2020  s())) <= 1):.   
-00019260: 2020 2020 2020 2020 2020 2020 2069 6478               idx
-00019270: 203d 206c 6973 7428 585f 6375 722e 696e   = list(X_cur.in
-00019280: 6465 782e 7661 6c75 6573 290a 2020 2020  dex.values).    
-00019290: 2020 2020 2020 2020 2020 2020 6374 6e20              ctn 
-000192a0: 3d20 2775 6e61 7373 6967 6e65 6427 0a20  = 'unassigned'. 
-000192b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000192c0: 6620 6c65 6e28 6c69 7374 286d 6b72 5f6c  f len(list(mkr_l
-000192d0: 7374 2e6b 6579 7328 2929 2920 3d3d 2031  st.keys())) == 1
-000192e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000192f0: 2020 2020 2020 6374 6e20 3d20 6c69 7374        ctn = list
-00019300: 286d 6b72 5f6c 7374 2e6b 6579 7328 2929  (mkr_lst.keys())
-00019310: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-00019320: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00019330: 2020 2020 2020 2020 2064 665f 7072 6564           df_pred
-00019340: 2e6c 6f63 5b69 6478 2c27 6365 6c6c 5f74  .loc[idx,'cell_t
-00019350: 7970 655f 6d69 6e6f 7227 5d20 3d20 7374  ype_minor'] = st
-00019360: 7228 6374 6e29 0a20 2020 2020 2020 2020  r(ctn).         
-00019370: 2020 2020 2020 2064 665f 7072 6564 2e6c         df_pred.l
-00019380: 6f63 5b69 6478 2c27 6365 6c6c 5f74 7970  oc[idx,'cell_typ
-00019390: 655f 7375 6273 6574 275d 203d 2073 7472  e_subset'] = str
-000193a0: 2863 746e 290a 2020 2020 2020 2020 2020  (ctn).          
-000193b0: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
-000193c0: 2020 2065 6c69 6620 6e70 2e73 756d 2862     elif np.sum(b
-000193d0: 5f63 7572 2920 3e20 303a 2020 200a 2020  _cur) > 0:   .  
-000193e0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000193f0: 2028 6e70 2e73 756d 2862 5f63 7572 2920   (np.sum(b_cur) 
-00019400: 3c20 4e5f 6e65 6967 6862 6f72 735f 6d69  < N_neighbors_mi
-00019410: 6e6f 7229 3a0a 2020 2020 2020 2020 2020  nor):.          
-00019420: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-00019430: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00019440: 6620 7573 655f 756e 696f 6e3a 0a20 2020  f use_union:.   
-00019450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019460: 2020 2020 2064 665f 7265 735f 6375 722c       df_res_cur,
-00019470: 2064 665f 4753 415f 7363 6f72 655f 6375   df_GSA_score_cu
-00019480: 722c 2064 666e 5f63 7572 203d 2047 5341  r, dfn_cur = GSA
-00019490: 5f63 656c 6c5f 7375 6274 7970 696e 6728  _cell_subtyping(
-000194a0: 2058 5f63 7572 2c20 6d6b 725f 6c73 742c   X_cur, mkr_lst,
-000194b0: 206d 6b72 5f6c 7374 5f6e 6567 2c20 0a20   mkr_lst_neg, . 
-000194c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000194d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000194e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000194f0: 2020 2020 2020 2020 2020 2020 2020 7665                ve
-00019500: 7262 6f73 6520 3d20 7072 696e 745f 7265  rbose = print_re
-00019510: 706f 7274 2029 0a20 2020 2020 2020 2020  port ).         
-00019520: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000178d0: 2020 2020 2020 7365 7061 7261 6269 6c69        separabili
+000178e0: 7479 5f63 6865 636b 5f70 6169 7277 6973  ty_check_pairwis
+000178f0: 6528 2064 665f 7363 6f72 655f 6d61 6a6f  e( df_score_majo
+00017900: 722c 2079 735f 6d61 6a6f 722c 200a 2020  r, ys_major, .  
+00017910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017930: 2020 2020 2020 2020 2020 6d6b 725f 6c73            mkr_ls
+00017940: 742c 2064 6963 745f 6365 6c6c 7479 7065  t, dict_celltype
+00017950: 5f63 6f6d 622c 2076 6572 626f 7365 290a  _comb, verbose).
+00017960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017970: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00017980: 2020 2020 2020 2020 2020 625f 6f6b 203d            b_ok =
+00017990: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
+000179a0: 2020 2020 2020 6966 2062 5f6f 6b3a 2062        if b_ok: b
+000179b0: 7265 616b 0a20 2020 2020 2020 2020 2020  reak.           
+000179c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000179d0: 2020 2020 2020 2062 7265 616b 0a20 2020         break.   
+000179e0: 2020 2020 2020 2020 2020 2020 200a 2020               .  
+000179f0: 2020 2020 2020 795f 7072 6564 5f63 6f72        y_pred_cor
+00017a00: 7265 6374 203d 2079 5f70 7265 645f 6d61  rect = y_pred_ma
+00017a10: 6a6f 720a 2020 2020 2020 2020 625f 6375  jor.        b_cu
+00017a20: 7220 3d20 795f 7072 6564 5f63 6f72 7265  r = y_pred_corre
+00017a30: 6374 203d 3d20 2775 6e61 7373 6967 6e65  ct == 'unassigne
+00017a40: 6427 0a20 2020 2020 2020 2069 6620 7665  d'.        if ve
+00017a50: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
+00017a60: 2020 2070 7269 6e74 2827 4e75 6d20 6f66     print('Num of
+00017a70: 2075 6e61 7373 6967 6e65 6420 6365 6c6c   unassigned cell
+00017a80: 733a 2025 6920 616d 6f6e 6720 2569 2720  s: %i among %i' 
+00017a90: 2520 286e 702e 7375 6d28 625f 6375 7229  % (np.sum(b_cur)
+00017aa0: 2c20 6c65 6e28 625f 6375 7229 2929 0a0a  , len(b_cur)))..
+00017ab0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+00017ac0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00017ad0: 7072 696e 7428 274d 616a 6f72 2063 656c  print('Major cel
+00017ae0: 6c20 7479 7065 2069 6465 6e74 6966 6963  l type identific
+00017af0: 6174 696f 6e20 646f 6e65 2e20 2825 6929  ation done. (%i)
+00017b00: 2720 2520 5c0a 2020 2020 2020 2020 2020  ' % \.          
+00017b10: 2020 2020 2020 2020 2072 6f75 6e64 2874           round(t
+00017b20: 696d 652e 7469 6d65 2829 202d 2073 7461  ime.time() - sta
+00017b30: 7274 5f74 696d 6529 290a 2020 2020 2020  rt_time)).      
+00017b40: 2020 656c 7365 3a20 0a20 2020 2020 2020    else: .       
+00017b50: 2020 2020 2065 7469 6d65 203d 2072 6f75       etime = rou
+00017b60: 6e64 2874 696d 652e 7469 6d65 2829 202d  nd(time.time() -
+00017b70: 2073 7461 7274 5f74 696d 655f 6e65 7729   start_time_new)
+00017b80: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00017b90: 2020 2020 2073 7461 7274 5f74 696d 655f       start_time_
+00017ba0: 6e65 7720 3d20 7469 6d65 2e74 696d 6528  new = time.time(
+00017bb0: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
+00017bc0: 696e 7428 274d 2569 2e27 2025 2065 7469  int('M%i.' % eti
+00017bd0: 6d65 2c20 656e 6420 3d20 2727 2c20 666c  me, end = '', fl
+00017be0: 7573 6820 3d20 5472 7565 290a 2020 2020  ush = True).    
+00017bf0: 2020 2020 2020 2020 2320 706c 6f74 5f72          # plot_r
+00017c00: 6f63 5f72 6573 756c 7428 6466 5f73 636f  oc_result(df_sco
+00017c10: 7265 5f6d 616a 6f72 2c20 7973 5f6d 616a  re_major, ys_maj
+00017c20: 6f72 2c20 6d65 7468 6f64 290a 0a20 2020  or, method)..   
+00017c30: 2020 2020 2064 665f 7072 6564 3220 3d20       df_pred2 = 
+00017c40: 7064 2e44 6174 6146 7261 6d65 2869 6e64  pd.DataFrame(ind
+00017c50: 6578 203d 2064 665f 7265 735f 6d61 6a6f  ex = df_res_majo
+00017c60: 722e 696e 6465 782e 7661 6c75 6573 290a  r.index.values).
+00017c70: 2020 2020 2020 2020 6466 5f70 7265 6432          df_pred2
+00017c80: 5b27 636c 7573 7465 725f 7265 7627 5d20  ['cluster_rev'] 
+00017c90: 3d20 795f 636c 7573 7420 2b20 310a 2020  = y_clust + 1.  
+00017ca0: 2020 2020 2020 6466 5f70 7265 6432 5b27        df_pred2['
+00017cb0: 636c 7573 7465 725f 7265 7627 5d20 3d20  cluster_rev'] = 
+00017cc0: 6466 5f70 7265 6432 5b27 636c 7573 7465  df_pred2['cluste
+00017cd0: 725f 7265 7627 5d2e 6173 7479 7065 2873  r_rev'].astype(s
+00017ce0: 7472 290a 2020 2020 2020 2020 0a20 2020  tr).        .   
+00017cf0: 2020 2020 2064 665f 7072 6564 203d 2070       df_pred = p
+00017d00: 642e 4461 7461 4672 616d 6528 7b27 6365  d.DataFrame({'ce
+00017d10: 6c6c 5f74 7970 655f 6d61 6a6f 7227 3a20  ll_type_major': 
+00017d20: 795f 7072 6564 5f63 6f72 7265 6374 7d2c  y_pred_correct},
+00017d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017d50: 2069 6e64 6578 203d 2064 665f 7265 735f   index = df_res_
+00017d60: 6d61 6a6f 722e 696e 6465 782e 7661 6c75  major.index.valu
+00017d70: 6573 290a 2020 2020 2020 2020 6466 5f70  es).        df_p
+00017d80: 7265 645b 2763 656c 6c5f 7479 7065 5f6d  red['cell_type_m
+00017d90: 696e 6f72 275d 203d 2027 756e 6173 7369  inor'] = 'unassi
+00017da0: 676e 6564 270a 2020 2020 2020 2020 6466  gned'.        df
+00017db0: 5f70 7265 645b 2763 656c 6c5f 7479 7065  _pred['cell_type
+00017dc0: 5f73 7562 7365 7427 5d20 3d20 2775 6e61  _subset'] = 'una
+00017dd0: 7373 6967 6e65 6427 0a20 2020 2020 2020  ssigned'.       
+00017de0: 2064 665f 7072 6564 5b27 636c 7573 7465   df_pred['cluste
+00017df0: 7227 5d20 3d20 795f 636c 7573 7420 2b20  r'] = y_clust + 
+00017e00: 310a 2020 2020 2020 2020 6466 5f70 7265  1.        df_pre
+00017e10: 645b 2763 6c75 7374 6572 275d 203d 2064  d['cluster'] = d
+00017e20: 665f 7072 6564 5b27 636c 7573 7465 7227  f_pred['cluster'
+00017e30: 5d2e 6173 7479 7065 2873 7472 290a 0a20  ].astype(str).. 
+00017e40: 2020 2020 2020 2064 665f 7072 6564 5b27         df_pred['
+00017e50: 6365 6c6c 5f74 7970 6528 3173 7429 275d  cell_type(1st)']
+00017e60: 203d 2064 665f 7265 735f 6d61 6a6f 725b   = df_res_major[
+00017e70: 2763 656c 6c5f 7479 7065 2831 7374 2927  'cell_type(1st)'
+00017e80: 5d2e 6173 7479 7065 2873 7472 290a 2020  ].astype(str).  
+00017e90: 2020 2020 2020 6466 5f70 7265 645b 2743        df_pred['C
+00017ea0: 6f6e 6669 6465 6e63 6528 3173 7429 275d  onfidence(1st)']
+00017eb0: 203d 2064 665f 7265 735f 6d61 6a6f 725b   = df_res_major[
+00017ec0: 272d 6c6f 6750 275d 2e61 7374 7970 6528  '-logP'].astype(
+00017ed0: 666c 6f61 7429 0a20 2020 2020 2020 2064  float).        d
+00017ee0: 665f 7072 6564 5b27 6365 6c6c 5f74 7970  f_pred['cell_typ
+00017ef0: 6528 326e 6429 275d 203d 2064 665f 7265  e(2nd)'] = df_re
+00017f00: 735f 6d61 6a6f 725b 2763 656c 6c5f 7479  s_major['cell_ty
+00017f10: 7065 2832 6e64 2927 5d2e 6173 7479 7065  pe(2nd)'].astype
+00017f20: 2873 7472 290a 2020 2020 2020 2020 6466  (str).        df
+00017f30: 5f70 7265 645b 2743 6f6e 6669 6465 6e63  _pred['Confidenc
+00017f40: 6528 326e 6429 275d 203d 2064 665f 7265  e(2nd)'] = df_re
+00017f50: 735f 6d61 6a6f 725b 272d 6c6f 6750 2832  s_major['-logP(2
+00017f60: 6e64 2927 5d2e 6173 7479 7065 2866 6c6f  nd)'].astype(flo
+00017f70: 6174 290a 2020 2020 2020 2020 0a20 2020  at).        .   
+00017f80: 2020 2020 2064 6963 745f 7375 6d6d 6172       dict_summar
+00017f90: 795f 7265 735b 274d 616a 6f72 5f54 7970  y_res['Major_Typ
+00017fa0: 6527 5d20 3d20 6466 5f72 6573 5f6d 616a  e'] = df_res_maj
+00017fb0: 6f72 0a20 2020 2020 2020 2064 6963 745f  or.        dict_
+00017fc0: 7375 6d6d 6172 795f 7363 6f72 655b 274d  summary_score['M
+00017fd0: 616a 6f72 5f54 7970 6527 5d20 3d20 6466  ajor_Type'] = df
+00017fe0: 5f73 636f 7265 5f6d 616a 6f72 0a20 2020  _score_major.   
+00017ff0: 2020 2020 2064 6963 745f 7375 6d6d 6172       dict_summar
+00018000: 795f 7363 6f72 6532 5b27 4d61 6a6f 725f  y_score2['Major_
+00018010: 5479 7065 275d 203d 2064 665f 4753 415f  Type'] = df_GSA_
+00018020: 7363 6f72 655f 6d61 6a6f 720a 2020 2020  score_major.    
+00018030: 2020 2020 0a20 2020 2023 2727 270a 2020      .    #'''.  
+00018040: 2020 2323 2323 2320 4d69 6e6f 7220 7479    ##### Minor ty
+00018050: 7065 2069 6465 6e74 6966 6963 6174 696f  pe identificatio
+00018060: 6e20 666f 7220 7365 6c65 6374 6564 2063  n for selected c
+00018070: 656c 6c73 0a20 2020 2069 6620 6964 656e  ells.    if iden
+00018080: 745f 6c65 7665 6c20 3e20 313a 0a20 2020  t_level > 1:.   
+00018090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000180a0: 200a 2020 2020 2020 2020 6466 5f70 7265   .        df_pre
+000180b0: 645b 2763 656c 6c5f 7479 7065 5f6d 696e  d['cell_type_min
+000180c0: 6f72 2831 7374 2927 5d20 3d20 6466 5f70  or(1st)'] = df_p
+000180d0: 7265 645b 2763 656c 6c5f 7479 7065 2831  red['cell_type(1
+000180e0: 7374 2927 5d2e 6173 7479 7065 2873 7472  st)'].astype(str
+000180f0: 290a 2020 2020 2020 2020 6466 5f70 7265  ).        df_pre
+00018100: 645b 2743 6f6e 6669 6465 6e63 655f 6d69  d['Confidence_mi
+00018110: 6e6f 7228 3173 7429 275d 203d 2064 665f  nor(1st)'] = df_
+00018120: 7072 6564 5b27 436f 6e66 6964 656e 6365  pred['Confidence
+00018130: 2831 7374 2927 5d2e 6173 7479 7065 2866  (1st)'].astype(f
+00018140: 6c6f 6174 290a 2020 2020 2020 2020 6466  loat).        df
+00018150: 5f70 7265 645b 2763 656c 6c5f 7479 7065  _pred['cell_type
+00018160: 5f6d 696e 6f72 2832 6e64 2927 5d20 3d20  _minor(2nd)'] = 
+00018170: 6466 5f70 7265 645b 2763 656c 6c5f 7479  df_pred['cell_ty
+00018180: 7065 2831 7374 2927 5d2e 6173 7479 7065  pe(1st)'].astype
+00018190: 2873 7472 290a 2020 2020 2020 2020 6466  (str).        df
+000181a0: 5f70 7265 645b 2743 6f6e 6669 6465 6e63  _pred['Confidenc
+000181b0: 655f 6d69 6e6f 7228 326e 6429 275d 203d  e_minor(2nd)'] =
+000181c0: 2064 665f 7072 6564 5b27 436f 6e66 6964   df_pred['Confid
+000181d0: 656e 6365 2831 7374 2927 5d2e 6173 7479  ence(1st)'].asty
+000181e0: 7065 2866 6c6f 6174 290a 2020 2020 2020  pe(float).      
+000181f0: 2020 0a20 2020 2020 2020 2023 2320 436c    .        ## Cl
+00018200: 7573 7465 7220 6261 7369 7320 7461 7267  uster basis targ
+00018210: 6574 2063 656c 6c73 2053 656c 6563 7469  et cells Selecti
+00018220: 6f6e 200a 2020 2020 2020 2020 625f 7365  on .        b_se
+00018230: 6c20 3d20 795f 7072 6564 5f63 6f72 7265  l = y_pred_corre
+00018240: 6374 2021 3d20 2775 6e61 7373 6967 6e65  ct != 'unassigne
+00018250: 6427 0a20 2020 2020 2020 2062 5f73 656c  d'.        b_sel
+00018260: 5b3a 5d20 3d20 4661 6c73 650a 2020 2020  [:] = False.    
+00018270: 2020 2020 636c 7573 7465 725f 6c73 7420      cluster_lst 
+00018280: 3d20 6c69 7374 2873 6574 2879 5f63 6c75  = list(set(y_clu
+00018290: 7374 2929 0a20 2020 2020 2020 2066 6f72  st)).        for
+000182a0: 2063 6c73 7420 696e 2063 6c75 7374 6572   clst in cluster
+000182b0: 5f6c 7374 3a0a 2020 2020 2020 2020 2020  _lst:.          
+000182c0: 2020 6263 203d 2079 5f63 6c75 7374 203d    bc = y_clust =
+000182d0: 3d20 636c 7374 0a20 2020 2020 2020 2020  = clst.         
+000182e0: 2020 2062 6120 3d20 795f 7072 6564 5f63     ba = y_pred_c
+000182f0: 6f72 7265 6374 203d 3d20 2775 6e61 7373  orrect == 'unass
+00018300: 6967 6e65 6427 0a20 2020 2020 2020 2020  igned'.         
+00018310: 2020 2069 6620 6e70 2e73 756d 2862 6326     if np.sum(bc&
+00018320: 6261 2920 3c3d 206e 702e 7375 6d28 6263  ba) <= np.sum(bc
+00018330: 292a 706d 616a 3a0a 2020 2020 2020 2020  )*pmaj:.        
+00018340: 2020 2020 2020 2020 625f 7365 6c5b 6263          b_sel[bc
+00018350: 5d20 3d20 5472 7565 0a0a 2020 2020 2020  ] = True..      
+00018360: 2020 2323 2052 756e 2047 5341 2061 6e64    ## Run GSA and
+00018370: 2070 6572 666f 726d 2069 6465 6e74 6966   perform identif
+00018380: 6963 6174 696f 6e0a 2020 2020 2020 2020  ication.        
+00018390: 585f 7365 6c20 3d20 5873 2e6c 6f63 5b62  X_sel = Xs.loc[b
+000183a0: 5f73 656c 2c3a 5d0a 2020 2020 2020 2020  _sel,:].        
+000183b0: 2320 585f 6c6f 675f 7365 6c20 3d20 585f  # X_log_sel = X_
+000183c0: 6c6f 672e 6c6f 635b 625f 7365 6c2c 3a5d  log.loc[b_sel,:]
+000183d0: 0a20 2020 2020 2020 2058 5f70 6361 5f73  .        X_pca_s
+000183e0: 656c 203d 2058 5f70 6361 2e6c 6f63 5b62  el = X_pca.loc[b
+000183f0: 5f73 656c 2c3a 5d0a 2020 2020 2020 2020  _sel,:].        
+00018400: 795f 636c 7573 745f 7365 6c20 3d20 795f  y_clust_sel = y_
+00018410: 636c 7573 745b 625f 7365 6c5d 0a20 2020  clust[b_sel].   
+00018420: 2020 2020 2079 5f70 7265 645f 7365 6c20       y_pred_sel 
+00018430: 3d20 795f 7072 6564 5f63 6f72 7265 6374  = y_pred_correct
+00018440: 5b62 5f73 656c 5d0a 0a20 2020 2020 2020  [b_sel]..       
+00018450: 2023 2320 4765 7420 6365 6c6c 2d74 7970   ## Get cell-typ
+00018460: 6520 6c69 7374 730a 2020 2020 2020 2020  e lists.        
+00018470: 7461 7267 6574 5f63 656c 6c5f 6c73 7420  target_cell_lst 
+00018480: 3d20 7b7d 2023 2074 6172 6765 745f 6365  = {} # target_ce
+00018490: 6c6c 5f74 7970 6573 0a20 2020 2020 2020  ll_types.       
+000184a0: 2066 6f72 2063 2069 6e20 6d6b 725f 6c73   for c in mkr_ls
+000184b0: 742e 6b65 7973 2829 3a0a 2020 2020 2020  t.keys():.      
+000184c0: 2020 2020 2020 6966 2063 2069 6e20 6469        if c in di
+000184d0: 6374 5f63 656c 6c74 7970 655f 636f 6d62  ct_celltype_comb
+000184e0: 2e6b 6579 7328 293a 0a20 2020 2020 2020  .keys():.       
+000184f0: 2020 2020 2020 2020 2074 6172 6765 745f           target_
+00018500: 6365 6c6c 5f6c 7374 5b63 5d20 3d20 6469  cell_lst[c] = di
+00018510: 6374 5f63 656c 6c74 7970 655f 636f 6d62  ct_celltype_comb
+00018520: 5b63 5d0a 2020 2020 2020 2020 2020 2020  [c].            
+00018530: 656c 6966 2063 2069 6e20 7461 7267 6574  elif c in target
+00018540: 5f63 656c 6c5f 7479 7065 733a 0a20 2020  _cell_types:.   
+00018550: 2020 2020 2020 2020 2020 2020 2074 6172               tar
+00018560: 6765 745f 6365 6c6c 5f6c 7374 5b63 5d20  get_cell_lst[c] 
+00018570: 3d20 5b63 5d0a 0a20 2020 2020 2020 206d  = [c]..        m
+00018580: 6b72 5f6c 7374 203d 207b 7d0a 2020 2020  kr_lst = {}.    
+00018590: 2020 2020 6d6b 725f 6c73 745f 6e65 6720      mkr_lst_neg 
+000185a0: 3d20 7b7d 0a20 2020 2020 2020 2066 6f72  = {}.        for
+000185b0: 2063 2069 6e20 7461 7267 6574 5f63 656c   c in target_cel
+000185c0: 6c5f 6c73 742e 6b65 7973 2829 3a0a 2020  l_lst.keys():.  
+000185d0: 2020 2020 2020 2020 2020 7461 7267 6574            target
+000185e0: 5f63 656c 6c20 3d20 7461 7267 6574 5f63  _cell = target_c
+000185f0: 656c 6c5f 6c73 745b 635d 0a20 2020 2020  ell_lst[c].     
+00018600: 2020 2020 2020 206d 6b72 5f6c 7374 5f74         mkr_lst_t
+00018610: 6d70 2c20 6d6b 725f 6c73 745f 6e65 675f  mp, mkr_lst_neg_
+00018620: 746d 7020 3d20 6765 745f 6d61 726b 6572  tmp = get_marker
+00018630: 735f 6365 6c6c 5f74 7970 6528 6d61 726b  s_cell_type(mark
+00018640: 6572 5f66 696c 652c 2074 6172 6765 745f  er_file, target_
+00018650: 6365 6c6c 2c20 0a20 2020 2020 2020 2020  cell, .         
+00018660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018680: 2020 2070 6e73 6831 3220 3d20 6d6b 725f     pnsh12 = mkr_
+00018690: 7365 6c65 6374 6f72 2c20 7265 6d5f 636f  selector, rem_co
+000186a0: 6d6d 6f6e 203d 2072 656d 5f63 6d6e 5f6d  mmon = rem_cmn_m
+000186b0: 6b72 2c0a 2020 2020 2020 2020 2020 2020  kr,.            
+000186c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000186d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000186e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000186f0: 2020 2020 2076 6572 626f 7365 203d 2046       verbose = F
+00018700: 616c 7365 290a 2020 2020 2020 2020 2020  alse).          
+00018710: 2020 6d6b 725f 6c73 742e 7570 6461 7465    mkr_lst.update
+00018720: 286d 6b72 5f6c 7374 5f74 6d70 290a 2020  (mkr_lst_tmp).  
+00018730: 2020 2020 2020 2020 2020 6d6b 725f 6c73            mkr_ls
+00018740: 745f 6e65 672e 7570 6461 7465 286d 6b72  t_neg.update(mkr
+00018750: 5f6c 7374 5f6e 6567 5f74 6d70 290a 0a20  _lst_neg_tmp).. 
+00018760: 2020 2020 2020 2069 6620 6c65 6e28 6d69         if len(mi
+00018770: 6e6f 725f 7479 7065 735f 746f 5f65 7863  nor_types_to_exc
+00018780: 6c75 6465 2920 3e20 303a 0a20 2020 2020  lude) > 0:.     
+00018790: 2020 2020 2020 206d 6b72 5f6c 7374 203d         mkr_lst =
+000187a0: 2072 656d 5f6d 696e 6f72 2820 6d6b 725f   rem_minor( mkr_
+000187b0: 6c73 742c 206d 696e 6f72 5f74 7970 6573  lst, minor_types
+000187c0: 5f74 6f5f 6578 636c 7564 6520 290a 2020  _to_exclude ).  
+000187d0: 2020 2020 2020 2020 2020 6d6b 725f 6c73            mkr_ls
+000187e0: 745f 6e65 6720 3d20 7265 6d5f 6d69 6e6f  t_neg = rem_mino
+000187f0: 7228 206d 6b72 5f6c 7374 5f6e 6567 2c20  r( mkr_lst_neg, 
+00018800: 6d69 6e6f 725f 7479 7065 735f 746f 5f65  minor_types_to_e
+00018810: 7863 6c75 6465 2029 0a20 2020 2020 2020  xclude ).       
+00018820: 200a 2020 2020 2020 2020 2323 2320 546f   .        ### To
+00018830: 2075 7365 2069 6e20 7468 6520 7375 6273   use in the subs
+00018840: 6574 2069 6465 6e74 6966 6963 6174 696f  et identificatio
+00018850: 6e0a 2020 2020 2020 2020 6d6b 725f 6c73  n.        mkr_ls
+00018860: 745f 7361 7620 3d20 636f 7079 2e64 6565  t_sav = copy.dee
+00018870: 7063 6f70 7928 6d6b 725f 6c73 7429 0a0a  pcopy(mkr_lst)..
+00018880: 2020 2020 2020 2020 6964 785f 7365 6c20          idx_sel 
+00018890: 3d20 585f 7063 615f 7365 6c2e 696e 6465  = X_pca_sel.inde
+000188a0: 782e 7661 6c75 6573 0a0a 2020 2020 2020  x.values..      
+000188b0: 2020 6466 5f47 5341 5f73 636f 7265 5f6d    df_GSA_score_m
+000188c0: 696e 6f72 5f61 6c6c 203d 2070 642e 4461  inor_all = pd.Da
+000188d0: 7461 4672 616d 6528 696e 6465 7820 3d20  taFrame(index = 
+000188e0: 6466 5f70 7265 642e 696e 6465 7829 0a20  df_pred.index). 
+000188f0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00018900: 636e 7420 3d20 300a 2020 2020 2020 2020  cnt = 0.        
+00018910: 666f 7220 7463 2069 6e20 7461 7267 6574  for tc in target
+00018920: 5f63 656c 6c5f 6c73 742e 6b65 7973 2829  _cell_lst.keys()
+00018930: 3a0a 2020 2020 2020 2020 2020 2020 7461  :.            ta
+00018940: 7267 6574 5f63 656c 6c20 3d20 7461 7267  rget_cell = targ
+00018950: 6574 5f63 656c 6c5f 6c73 745b 7463 5d0a  et_cell_lst[tc].
+00018960: 2020 2020 2020 2020 2020 2020 6d6b 725f              mkr_
+00018970: 6c73 742c 206d 6b72 5f6c 7374 5f6e 6567  lst, mkr_lst_neg
+00018980: 203d 2067 6574 5f6d 6172 6b65 7273 5f63   = get_markers_c
+00018990: 656c 6c5f 7479 7065 286d 6172 6b65 725f  ell_type(marker_
+000189a0: 6669 6c65 2c20 7461 7267 6574 5f63 656c  file, target_cel
+000189b0: 6c2c 200a 2020 2020 2020 2020 2020 2020  l, .            
+000189c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000189d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000189e0: 706e 7368 3132 203d 206d 6b72 5f73 656c  pnsh12 = mkr_sel
+000189f0: 6563 746f 722c 2072 656d 5f63 6f6d 6d6f  ector, rem_commo
+00018a00: 6e20 3d20 7265 6d5f 636d 6e5f 6d6b 722c  n = rem_cmn_mkr,
+00018a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018a40: 2020 2020 2020 2020 2020 7665 7262 6f73            verbos
+00018a50: 6520 3d20 4661 6c73 6529 0a0a 2020 2020  e = False)..    
+00018a60: 2020 2020 2020 2020 6966 206c 656e 286d          if len(m
+00018a70: 696e 6f72 5f74 7970 6573 5f74 6f5f 6578  inor_types_to_ex
+00018a80: 636c 7564 6529 203e 2030 3a0a 2020 2020  clude) > 0:.    
+00018a90: 2020 2020 2020 2020 2020 2020 6d6b 725f              mkr_
+00018aa0: 6c73 7420 3d20 7265 6d5f 6d69 6e6f 7228  lst = rem_minor(
+00018ab0: 206d 6b72 5f6c 7374 2c20 6d69 6e6f 725f   mkr_lst, minor_
+00018ac0: 7479 7065 735f 746f 5f65 7863 6c75 6465  types_to_exclude
+00018ad0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00018ae0: 2020 206d 6b72 5f6c 7374 5f6e 6567 203d     mkr_lst_neg =
+00018af0: 2072 656d 5f6d 696e 6f72 2820 6d6b 725f   rem_minor( mkr_
+00018b00: 6c73 745f 6e65 672c 206d 696e 6f72 5f74  lst_neg, minor_t
+00018b10: 7970 6573 5f74 6f5f 6578 636c 7564 6520  ypes_to_exclude 
+00018b20: 290a 2020 2020 0a20 2020 2020 2020 2020  ).    .         
+00018b30: 2020 2073 6d20 3d20 2727 0a20 2020 2020     sm = ''.     
+00018b40: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+00018b50: 6e20 6d6b 725f 6c73 742e 6b65 7973 2829  n mkr_lst.keys()
+00018b60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00018b70: 2020 736d 203d 2073 6d20 2b20 2725 732c    sm = sm + '%s,
+00018b80: 2720 2520 6b65 790a 2020 2020 2020 2020  ' % key.        
+00018b90: 2020 2020 6966 2076 6572 626f 7365 3a20      if verbose: 
+00018ba0: 7072 696e 7428 2725 7320 6d69 6e6f 7220  print('%s minor 
+00018bb0: 7479 7065 2069 6465 6e74 6966 6963 6174  type identificat
+00018bc0: 696f 6e3a 2025 7327 2025 2028 7463 2c20  ion: %s' % (tc, 
+00018bd0: 736d 5b3a 2d31 5d29 290a 0a20 2020 2020  sm[:-1]))..     
+00018be0: 2020 2020 2020 2062 5f63 7572 203d 2079         b_cur = y
+00018bf0: 5f70 7265 645f 7365 6c20 3d3d 2027 756e  _pred_sel == 'un
+00018c00: 6173 7369 676e 6564 270a 2020 2020 2020  assigned'.      
+00018c10: 2020 2020 2020 625f 6375 725b 3a5d 203d        b_cur[:] =
+00018c20: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
+00018c30: 2020 2063 6c75 7374 6572 5f6c 7374 203d     cluster_lst =
+00018c40: 206c 6973 7428 7365 7428 795f 636c 7573   list(set(y_clus
+00018c50: 745f 7365 6c29 290a 0a20 2020 2020 2020  t_sel))..       
+00018c60: 2020 2020 2023 2727 270a 2020 2020 2020       #'''.      
+00018c70: 2020 2020 2020 666f 7220 636c 7374 2069        for clst i
+00018c80: 6e20 636c 7573 7465 725f 6c73 743a 0a20  n cluster_lst:. 
+00018c90: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00018ca0: 6320 3d20 795f 636c 7573 745f 7365 6c20  c = y_clust_sel 
+00018cb0: 3d3d 2063 6c73 740a 2020 2020 2020 2020  == clst.        
+00018cc0: 2020 2020 2020 2020 6261 203d 2079 5f70          ba = y_p
+00018cd0: 7265 645f 7365 6c20 3d3d 2074 630a 2020  red_sel == tc.  
+00018ce0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00018cf0: 206e 702e 7375 6d28 6263 2662 6129 203e   np.sum(bc&ba) >
+00018d00: 3d20 6e70 2e73 756d 2862 6329 2a70 6d61  = np.sum(bc)*pma
+00018d10: 6a3a 0a20 2020 2020 2020 2020 2020 2020  j:.             
+00018d20: 2020 2020 2020 2062 5f63 7572 5b62 635d         b_cur[bc]
+00018d30: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+00018d40: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00018d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d60: 2020 625f 6375 725b 6261 5d20 3d20 5472    b_cur[ba] = Tr
+00018d70: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+00018d80: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00018d90: 2020 2020 2327 2727 0a20 2020 2020 2020      #'''.       
+00018da0: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+00018db0: 2020 2323 2052 756e 2047 5341 2061 6e64    ## Run GSA and
+00018dc0: 2070 6572 666f 726d 2069 6465 6e74 6966   perform identif
+00018dd0: 6963 6174 696f 6e0a 2020 2020 2020 2020  ication.        
+00018de0: 2020 2020 585f 6375 7220 3d20 585f 7365      X_cur = X_se
+00018df0: 6c2e 6c6f 635b 625f 6375 722c 3a5d 0a20  l.loc[b_cur,:]. 
+00018e00: 2020 2020 2020 2020 2020 2058 5f70 6361             X_pca
+00018e10: 5f63 7572 203d 2058 5f70 6361 5f73 656c  _cur = X_pca_sel
+00018e20: 2e6c 6f63 5b62 5f63 7572 2c3a 5d0a 2020  .loc[b_cur,:].  
+00018e30: 2020 2020 2020 2020 2020 795f 636c 7573            y_clus
+00018e40: 745f 6375 7220 3d20 795f 636c 7573 745f  t_cur = y_clust_
+00018e50: 7365 6c5b 625f 6375 725d 0a20 2020 2020  sel[b_cur].     
+00018e60: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00018e70: 2020 2020 2320 7468 7265 7368 6f6c 6469      # thresholdi
+00018e80: 6e67 5f6d 696e 6f72 203d 2074 6872 6573  ng_minor = thres
+00018e90: 686f 6c64 696e 675f 6d73 5b30 5d0a 2020  holding_ms[0].  
+00018ea0: 2020 2020 2020 2020 2020 2320 7063 745f            # pct_
+00018eb0: 6375 746f 6666 5f6d 696e 6f72 203d 2070  cutoff_minor = p
+00018ec0: 6374 5f63 7574 6f66 665f 6d73 5b30 5d0a  ct_cutoff_ms[0].
+00018ed0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00018ee0: 2020 2020 2020 2020 2023 2320 5265 646f           ## Redo
+00018ef0: 2050 4341 2061 6e64 2043 6c75 7374 6572   PCA and Cluster
+00018f00: 696e 6720 2323 2323 230a 2020 2020 2020  ing #####.      
+00018f10: 2020 2020 2020 6d69 6e6f 725f 7479 7065        minor_type
+00018f20: 5f6c 7374 5f63 7572 203d 206c 6973 7428  _lst_cur = list(
+00018f30: 6d6b 725f 6c73 742e 6b65 7973 2829 290a  mkr_lst.keys()).
+00018f40: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00018f50: 2020 2020 2020 2020 2023 2323 2054 6f20           ### To 
+00018f60: 6265 2075 7365 6420 746f 2064 6574 6572  be used to deter
+00018f70: 6d69 6e65 206d 696e 6f72 2074 7970 6520  mine minor type 
+00018f80: 666f 7220 6769 7665 6e20 7375 6273 6574  for given subset
+00018f90: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
+00018fa0: 5f64 6963 745f 7375 6232 6d69 6e20 3d20  _dict_sub2min = 
+00018fb0: 7b7d 0a20 2020 2020 2020 2020 2020 206d  {}.            m
+00018fc0: 6170 5f64 6963 745f 6d69 6e32 7375 6220  ap_dict_min2sub 
+00018fd0: 3d20 7b7d 0a20 2020 2020 2020 2020 2020  = {}.           
+00018fe0: 2066 6f72 2063 7820 696e 206d 696e 6f72   for cx in minor
+00018ff0: 5f74 7970 655f 6c73 745f 6375 723a 2023  _type_lst_cur: #
+00019000: 2066 6f72 2065 6163 6820 6d69 6e6f 7220   for each minor 
+00019010: 7479 7065 0a20 2020 2020 2020 2020 2020  type.           
+00019020: 2020 2020 206d 6b72 5f6c 7374 5f74 6d70       mkr_lst_tmp
+00019030: 2c20 6d6b 725f 6c73 745f 6e65 675f 746d  , mkr_lst_neg_tm
+00019040: 7020 3d20 6765 745f 6d61 726b 6572 735f  p = get_markers_
+00019050: 6d69 6e6f 725f 7479 7065 3228 6d61 726b  minor_type2(mark
+00019060: 6572 5f66 696c 652c 205b 6378 5d2c 200a  er_file, [cx], .
+00019070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019090: 2020 2020 2020 2020 706e 7368 3132 203d          pnsh12 =
+000190a0: 206d 6b72 5f73 656c 6563 746f 722c 2072   mkr_selector, r
+000190b0: 656d 5f63 6f6d 6d6f 6e20 3d20 7265 6d5f  em_common = rem_
+000190c0: 636d 6e5f 6d6b 722c 0a20 2020 2020 2020  cmn_mkr,.       
+000190d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000190e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000190f0: 2063 6f6d 625f 6d6b 7273 203d 2063 6f6d   comb_mkrs = com
+00019100: 625f 6d6b 7273 2c20 7665 7262 6f73 6520  b_mkrs, verbose 
+00019110: 3d20 4661 6c73 6529 0a20 2020 2020 2020  = False).       
+00019120: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+00019130: 2020 2020 2020 2020 2020 666f 7220 6b65            for ke
+00019140: 7920 696e 206d 6b72 5f6c 7374 5f74 6d70  y in mkr_lst_tmp
+00019150: 2e6b 6579 7328 293a 0a20 2020 2020 2020  .keys():.       
+00019160: 2020 2020 2020 2020 2020 2020 206d 6170               map
+00019170: 5f64 6963 745f 7375 6232 6d69 6e5b 6b65  _dict_sub2min[ke
+00019180: 795d 203d 2063 780a 2020 2020 2020 2020  y] = cx.        
+00019190: 2020 2020 2020 2020 6d61 705f 6469 6374          map_dict
+000191a0: 5f6d 696e 3273 7562 5b63 785d 203d 206c  _min2sub[cx] = l
+000191b0: 6973 7428 6d6b 725f 6c73 745f 746d 702e  ist(mkr_lst_tmp.
+000191c0: 6b65 7973 2829 290a 2020 2020 2020 2020  keys()).        
+000191d0: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+000191e0: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+000191f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00019200: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00019210: 2323 2323 2323 2323 230a 2020 2020 2020  #########.      
+00019220: 2020 2020 2020 6966 206e 6f74 2075 7365        if not use
+00019230: 5f75 6e69 6f6e 3a0a 2020 2020 2020 2020  _union:.        
+00019240: 2020 2020 2020 2020 6d6b 725f 6c73 742c          mkr_lst,
+00019250: 206d 6b72 5f6c 7374 5f6e 6567 203d 2067   mkr_lst_neg = g
+00019260: 6574 5f6d 6172 6b65 7273 5f6d 696e 6f72  et_markers_minor
+00019270: 5f74 7970 6532 286d 6172 6b65 725f 6669  _type2(marker_fi
+00019280: 6c65 2c20 6d69 6e6f 725f 7479 7065 5f6c  le, minor_type_l
+00019290: 7374 5f63 7572 2c20 0a20 2020 2020 2020  st_cur, .       
+000192a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000192b0: 2020 2020 2020 2020 2070 6e73 6831 3220           pnsh12 
+000192c0: 3d20 6d6b 725f 7365 6c65 6374 6f72 2c20  = mkr_selector, 
+000192d0: 7265 6d5f 636f 6d6d 6f6e 203d 2072 656d  rem_common = rem
+000192e0: 5f63 6d6e 5f6d 6b72 2c0a 2020 2020 2020  _cmn_mkr,.      
+000192f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019300: 2020 2020 2020 2020 2020 636f 6d62 5f6d            comb_m
+00019310: 6b72 7320 3d20 636f 6d62 5f6d 6b72 732c  krs = comb_mkrs,
+00019320: 2076 6572 626f 7365 203d 2046 616c 7365   verbose = False
+00019330: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+00019340: 6620 286c 656e 286c 6973 7428 6d6b 725f  f (len(list(mkr_
+00019350: 6c73 742e 6b65 7973 2829 2929 203c 3d20  lst.keys())) <= 
+00019360: 3129 3a0a 2020 2020 2020 2020 2020 2020  1):.            
+00019370: 2020 2020 6964 7820 3d20 6c69 7374 2858      idx = list(X
+00019380: 5f63 7572 2e69 6e64 6578 2e76 616c 7565  _cur.index.value
+00019390: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+000193a0: 2020 2063 746e 203d 2027 756e 6173 7369     ctn = 'unassi
+000193b0: 676e 6564 270a 2020 2020 2020 2020 2020  gned'.          
+000193c0: 2020 2020 2020 6966 206c 656e 286c 6973        if len(lis
+000193d0: 7428 6d6b 725f 6c73 742e 6b65 7973 2829  t(mkr_lst.keys()
+000193e0: 2929 203d 3d20 313a 0a20 2020 2020 2020  )) == 1:.       
+000193f0: 2020 2020 2020 2020 2020 2020 2063 746e               ctn
+00019400: 203d 206c 6973 7428 6d6b 725f 6c73 742e   = list(mkr_lst.
+00019410: 6b65 7973 2829 295b 305d 0a20 2020 2020  keys())[0].     
+00019420: 2020 2020 2020 2020 2020 2020 2020 200a                 .
+00019430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019440: 6466 5f70 7265 642e 6c6f 635b 6964 782c  df_pred.loc[idx,
+00019450: 2763 656c 6c5f 7479 7065 5f6d 696e 6f72  'cell_type_minor
+00019460: 275d 203d 2073 7472 2863 746e 290a 2020  '] = str(ctn).  
+00019470: 2020 2020 2020 2020 2020 2020 2020 6466                df
+00019480: 5f70 7265 642e 6c6f 635b 6964 782c 2763  _pred.loc[idx,'c
+00019490: 656c 6c5f 7479 7065 5f73 7562 7365 7427  ell_type_subset'
+000194a0: 5d20 3d20 7374 7228 6374 6e29 0a20 2020  ] = str(ctn).   
+000194b0: 2020 2020 2020 2020 2020 2020 200a 2020               .  
+000194c0: 2020 2020 2020 2020 2020 656c 6966 206e            elif n
+000194d0: 702e 7375 6d28 625f 6375 7229 203e 2030  p.sum(b_cur) > 0
+000194e0: 3a20 2020 0a20 2020 2020 2020 2020 2020  :   .           
+000194f0: 2020 2020 2069 6620 286e 702e 7375 6d28       if (np.sum(
+00019500: 625f 6375 7229 203c 204e 5f6e 6569 6768  b_cur) < N_neigh
+00019510: 626f 7273 5f6d 696e 6f72 293a 0a20 2020  bors_minor):.   
+00019520: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00019530: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00019540: 2020 2020 2020 2020 2020 2320 6466 5f47            # df_G
-00019550: 5341 5f73 636f 7265 5f73 7562 7365 7420  SA_score_subset 
-00019560: 3d20 6466 5f47 5341 5f73 636f 7265 5f73  = df_GSA_score_s
-00019570: 7562 7365 745f 616c 6c2e 6c6f 635b 585f  ubset_all.loc[X_
-00019580: 7063 615f 6375 722e 696e 6465 782c 3a5d  pca_cur.index,:]
-00019590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000195a0: 2020 2020 2020 2020 2064 665f 7265 735f           df_res_
-000195b0: 7375 6273 6574 2c20 6466 5f47 5341 5f73  subset, df_GSA_s
-000195c0: 636f 7265 5f73 7562 7365 742c 2064 666e  core_subset, dfn
-000195d0: 5f73 7562 7365 7420 3d20 5c0a 2020 2020  _subset = \.    
+00019540: 2020 2020 2020 6966 2075 7365 5f75 6e69        if use_uni
+00019550: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
+00019560: 2020 2020 2020 2020 2020 2020 6466 5f72              df_r
+00019570: 6573 5f63 7572 2c20 6466 5f47 5341 5f73  es_cur, df_GSA_s
+00019580: 636f 7265 5f63 7572 2c20 6466 6e5f 6375  core_cur, dfn_cu
+00019590: 7220 3d20 4753 415f 6365 6c6c 5f73 7562  r = GSA_cell_sub
+000195a0: 7479 7069 6e67 2820 585f 6375 722c 206d  typing( X_cur, m
+000195b0: 6b72 5f6c 7374 2c20 6d6b 725f 6c73 745f  kr_lst, mkr_lst_
+000195c0: 6e65 672c 200a 2020 2020 2020 2020 2020  neg, .          
+000195d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000195e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000195f0: 2020 2020 2020 2020 4753 415f 6365 6c6c          GSA_cell
-00019600: 5f73 7562 7479 7069 6e67 2820 585f 6375  _subtyping( X_cu
-00019610: 722c 206d 6b72 5f6c 7374 2c20 6d6b 725f  r, mkr_lst, mkr_
-00019620: 6c73 745f 6e65 672c 2076 6572 626f 7365  lst_neg, verbose
-00019630: 203d 2076 6572 626f 7365 2029 0a20 2020   = verbose ).   
+000195f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019600: 2020 2020 2076 6572 626f 7365 203d 2070       verbose = p
+00019610: 7269 6e74 5f72 6570 6f72 7420 290a 2020  rint_report ).  
+00019620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019630: 2020 656c 7365 3a20 0a20 2020 2020 2020    else: .       
 00019640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019650: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-00019660: 2020 2020 2020 2020 2020 2020 2020 6466                df
-00019670: 5f47 5341 5f73 636f 7265 5f63 7572 203d  _GSA_score_cur =
-00019680: 2070 642e 4461 7461 4672 616d 6528 696e   pd.DataFrame(in
-00019690: 6465 7820 3d20 585f 7063 615f 6375 722e  dex = X_pca_cur.
-000196a0: 696e 6465 782c 2063 6f6c 756d 6e73 203d  index, columns =
-000196b0: 206d 696e 6f72 5f74 7970 655f 6c73 745f   minor_type_lst_
-000196c0: 6375 7229 0a20 2020 2020 2020 2020 2020  cur).           
-000196d0: 2020 2020 2020 2020 2020 2020 200a 2020               .  
-000196e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000196f0: 2020 2020 2020 666f 7220 6d69 6e6f 7220        for minor 
-00019700: 696e 206d 6170 5f64 6963 745f 6d69 6e32  in map_dict_min2
-00019710: 7375 622e 6b65 7973 2829 3a0a 2020 2020  sub.keys():.    
-00019720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019730: 2020 2020 2020 2020 6966 206d 696e 6f72          if minor
-00019740: 2069 6e20 6d69 6e6f 725f 7479 7065 5f6c   in minor_type_l
-00019750: 7374 5f63 7572 3a0a 2020 2020 2020 2020  st_cur:.        
+00019650: 2023 2064 665f 4753 415f 7363 6f72 655f   # df_GSA_score_
+00019660: 7375 6273 6574 203d 2064 665f 4753 415f  subset = df_GSA_
+00019670: 7363 6f72 655f 7375 6273 6574 5f61 6c6c  score_subset_all
+00019680: 2e6c 6f63 5b58 5f70 6361 5f63 7572 2e69  .loc[X_pca_cur.i
+00019690: 6e64 6578 2c3a 5d0a 2020 2020 2020 2020  ndex,:].        
+000196a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000196b0: 6466 5f72 6573 5f73 7562 7365 742c 2064  df_res_subset, d
+000196c0: 665f 4753 415f 7363 6f72 655f 7375 6273  f_GSA_score_subs
+000196d0: 6574 2c20 6466 6e5f 7375 6273 6574 203d  et, dfn_subset =
+000196e0: 205c 0a20 2020 2020 2020 2020 2020 2020   \.             
+000196f0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+00019700: 5341 5f63 656c 6c5f 7375 6274 7970 696e  SA_cell_subtypin
+00019710: 6728 2058 5f63 7572 2c20 6d6b 725f 6c73  g( X_cur, mkr_ls
+00019720: 742c 206d 6b72 5f6c 7374 5f6e 6567 2c20  t, mkr_lst_neg, 
+00019730: 7665 7262 6f73 6520 3d20 7665 7262 6f73  verbose = verbos
+00019740: 6520 290a 2020 2020 2020 2020 2020 2020  e ).            
+00019750: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
 00019760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019770: 2020 2020 2020 2020 7375 625f 6c73 7420          sub_lst 
-00019780: 3d20 6d61 705f 6469 6374 5f6d 696e 3273  = map_dict_min2s
-00019790: 7562 5b6d 696e 6f72 5d0a 2020 2020 2020  ub[minor].      
-000197a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000197b0: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-000197c0: 2873 7562 5f6c 7374 2920 3d3d 2031 3a0a  (sub_lst) == 1:.
+00019770: 2020 2020 2064 665f 4753 415f 7363 6f72       df_GSA_scor
+00019780: 655f 6375 7220 3d20 7064 2e44 6174 6146  e_cur = pd.DataF
+00019790: 7261 6d65 2869 6e64 6578 203d 2058 5f70  rame(index = X_p
+000197a0: 6361 5f63 7572 2e69 6e64 6578 2c20 636f  ca_cur.index, co
+000197b0: 6c75 6d6e 7320 3d20 6d69 6e6f 725f 7479  lumns = minor_ty
+000197c0: 7065 5f6c 7374 5f63 7572 290a 2020 2020  pe_lst_cur).    
 000197d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000197e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000197f0: 2020 2020 6265 7374 5f73 636f 7265 203d      best_score =
-00019800: 2064 665f 4753 415f 7363 6f72 655f 7375   df_GSA_score_su
-00019810: 6273 6574 5b73 7562 5f6c 7374 5b30 5d5d  bset[sub_lst[0]]
-00019820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019840: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00019850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019860: 2020 2020 2020 2020 2020 2062 6573 745f             best_
-00019870: 7363 6f72 6520 3d20 6466 5f47 5341 5f73  score = df_GSA_s
-00019880: 636f 7265 5f73 7562 7365 745b 7375 625f  core_subset[sub_
-00019890: 6c73 745d 2e6d 6178 2861 7869 7320 3d20  lst].max(axis = 
-000198a0: 3129 0a20 2020 2020 2020 2020 2020 2020  1).             
+000197e0: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+000197f0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00019800: 206d 696e 6f72 2069 6e20 6d61 705f 6469   minor in map_di
+00019810: 6374 5f6d 696e 3273 7562 2e6b 6579 7328  ct_min2sub.keys(
+00019820: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00019830: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00019840: 6620 6d69 6e6f 7220 696e 206d 696e 6f72  f minor in minor
+00019850: 5f74 7970 655f 6c73 745f 6375 723a 0a20  _type_lst_cur:. 
+00019860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019870: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00019880: 7562 5f6c 7374 203d 206d 6170 5f64 6963  ub_lst = map_dic
+00019890: 745f 6d69 6e32 7375 625b 6d69 6e6f 725d  t_min2sub[minor]
+000198a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 000198b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000198c0: 2020 2064 665f 4753 415f 7363 6f72 655f     df_GSA_score_
-000198d0: 6375 725b 6d69 6e6f 725d 203d 2062 6573  cur[minor] = bes
-000198e0: 745f 7363 6f72 6520 2020 2020 2020 2020  t_score         
-000198f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019900: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-00019910: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-00019920: 7265 735f 6375 7220 3d20 6765 745f 7374  res_cur = get_st
-00019930: 6174 5f67 7361 2864 665f 4753 415f 7363  at_gsa(df_GSA_sc
-00019940: 6f72 655f 6375 7229 0a20 2020 2020 2020  ore_cur).       
+000198c0: 2069 6620 6c65 6e28 7375 625f 6c73 7429   if len(sub_lst)
+000198d0: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
+000198e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000198f0: 2020 2020 2020 2020 2020 2062 6573 745f             best_
+00019900: 7363 6f72 6520 3d20 6466 5f47 5341 5f73  score = df_GSA_s
+00019910: 636f 7265 5f73 7562 7365 745b 7375 625f  core_subset[sub_
+00019920: 6c73 745b 305d 5d0a 2020 2020 2020 2020  lst[0]].        
+00019930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019940: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
 00019950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019960: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00019970: 2020 2020 2020 795f 7072 6564 5f63 7572        y_pred_cur
-00019980: 203d 2064 665f 7265 735f 6375 725b 2763   = df_res_cur['c
-00019990: 656c 6c5f 7479 7065 275d 0a20 2020 2020  ell_type'].     
-000199a0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000199b0: 665f 7363 6f72 655f 6375 7220 3d20 4e6f  f_score_cur = No
-000199c0: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
-000199d0: 2020 2020 2020 2079 5f63 6c75 7374 5f63         y_clust_c
-000199e0: 7572 5b3a 5d20 3d20 300a 2020 2020 2020  ur[:] = 0.      
-000199f0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-00019a00: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00019a10: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00019a20: 2020 2020 2020 2020 2023 2320 5265 646f           ## Redo
-00019a30: 2050 4341 2061 6e64 2043 6c75 7374 6572   PCA and Cluster
-00019a40: 696e 6720 2323 2323 230a 2020 2020 2020  ing #####.      
-00019a50: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00019a60: 7468 7265 7368 6f6c 6469 6e67 5f6d 696e  thresholding_min
-00019a70: 6f72 203d 2074 6872 6573 686f 6c64 696e  or = thresholdin
-00019a80: 675f 6d73 5b30 5d0a 2020 2020 2020 2020  g_ms[0].        
-00019a90: 2020 2020 2020 2020 2020 2020 2320 7063              # pc
-00019aa0: 745f 6375 746f 6666 5f6d 696e 6f72 203d  t_cutoff_minor =
-00019ab0: 2070 6374 5f63 7574 6f66 665f 6d73 5b30   pct_cutoff_ms[0
-00019ac0: 5d0a 0a20 2020 2020 2020 2020 2020 2020  ]..             
-00019ad0: 2020 2020 2020 2058 785f 6375 7220 3d20         Xx_cur = 
-00019ae0: 585f 7072 6570 726f 6365 7373 696e 6728  X_preprocessing(
-00019af0: 2058 5f63 7572 2c20 6c6f 675f 7472 616e   X_cur, log_tran
-00019b00: 7366 6f72 6d65 642c 204e 5f67 656e 6573  sformed, N_genes
-00019b10: 203d 2032 3030 3020 290a 0a20 2020 2020   = 2000 )..     
-00019b20: 2020 2020 2020 2020 2020 2020 2020 2058                 X
-00019b30: 5f70 6361 5f63 7572 203d 2070 6361 2e66  _pca_cur = pca.f
-00019b40: 6974 5f74 7261 6e73 666f 726d 2858 785f  it_transform(Xx_
-00019b50: 6375 7229 0a20 2020 2020 2020 2020 2020  cur).           
-00019b60: 2020 2020 2020 2020 2058 5f70 6361 5f63           X_pca_c
-00019b70: 7572 203d 2070 642e 4461 7461 4672 616d  ur = pd.DataFram
-00019b80: 6528 585f 7063 615f 6375 722c 2069 6e64  e(X_pca_cur, ind
-00019b90: 6578 203d 2058 5f63 7572 2e69 6e64 6578  ex = X_cur.index
-00019ba0: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-00019bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019bd0: 636f 6c75 6d6e 7320 3d20 6c69 7374 286e  columns = list(n
-00019be0: 702e 6172 616e 6765 2869 6e74 284e 5f63  p.arange(int(N_c
-00019bf0: 6f6d 706f 6e65 6e74 735f 7063 6129 2929  omponents_pca)))
-00019c00: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00019c10: 2020 2020 2020 2079 5f63 6c75 7374 5f63         y_clust_c
-00019c20: 7572 2c20 636f 626a 203d 2063 6c75 7374  ur, cobj = clust
-00019c30: 6572 696e 675f 616c 6728 585f 7063 615f  ering_alg(X_pca_
-00019c40: 6375 722c 2063 6c75 7374 5f61 6c67 6f20  cur, clust_algo 
-00019c50: 3d20 436c 7573 7465 7269 6e67 5f61 6c67  = Clustering_alg
-00019c60: 6f2c 200a 2020 2020 2020 2020 2020 2020  o, .            
-00019c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c90: 2020 2020 2020 204e 5f63 6c75 7374 6572         N_cluster
-00019ca0: 7320 3d20 4e5f 636f 6d70 2c20 0a20 2020  s = N_comp, .   
+00019960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019970: 2020 6265 7374 5f73 636f 7265 203d 2064    best_score = d
+00019980: 665f 4753 415f 7363 6f72 655f 7375 6273  f_GSA_score_subs
+00019990: 6574 5b73 7562 5f6c 7374 5d2e 6d61 7828  et[sub_lst].max(
+000199a0: 6178 6973 203d 2031 290a 2020 2020 2020  axis = 1).      
+000199b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000199c0: 2020 2020 2020 2020 2020 6466 5f47 5341            df_GSA
+000199d0: 5f73 636f 7265 5f63 7572 5b6d 696e 6f72  _score_cur[minor
+000199e0: 5d20 3d20 6265 7374 5f73 636f 7265 2020  ] = best_score  
+000199f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019a00: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+00019a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019a20: 2020 2020 6466 5f72 6573 5f63 7572 203d      df_res_cur =
+00019a30: 2067 6574 5f73 7461 745f 6773 6128 6466   get_stat_gsa(df
+00019a40: 5f47 5341 5f73 636f 7265 5f63 7572 290a  _GSA_score_cur).
+00019a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019a60: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00019a70: 2020 2020 2020 2020 2020 2020 2079 5f70               y_p
+00019a80: 7265 645f 6375 7220 3d20 6466 5f72 6573  red_cur = df_res
+00019a90: 5f63 7572 5b27 6365 6c6c 5f74 7970 6527  _cur['cell_type'
+00019aa0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00019ab0: 2020 2020 2020 6466 5f73 636f 7265 5f63        df_score_c
+00019ac0: 7572 203d 204e 6f6e 650a 2020 2020 2020  ur = None.      
+00019ad0: 2020 2020 2020 2020 2020 2020 2020 795f                y_
+00019ae0: 636c 7573 745f 6375 725b 3a5d 203d 2030  clust_cur[:] = 0
+00019af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019b00: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+00019b10: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00019b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b30: 2323 2052 6564 6f20 5043 4120 616e 6420  ## Redo PCA and 
+00019b40: 436c 7573 7465 7269 6e67 2023 2323 2323  Clustering #####
+00019b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019b60: 2020 2020 2023 2074 6872 6573 686f 6c64       # threshold
+00019b70: 696e 675f 6d69 6e6f 7220 3d20 7468 7265  ing_minor = thre
+00019b80: 7368 6f6c 6469 6e67 5f6d 735b 305d 0a20  sholding_ms[0]. 
+00019b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ba0: 2020 2023 2070 6374 5f63 7574 6f66 665f     # pct_cutoff_
+00019bb0: 6d69 6e6f 7220 3d20 7063 745f 6375 746f  minor = pct_cuto
+00019bc0: 6666 5f6d 735b 305d 0a0a 2020 2020 2020  ff_ms[0]..      
+00019bd0: 2020 2020 2020 2020 2020 2020 2020 5878                Xx
+00019be0: 5f63 7572 203d 2058 5f70 7265 7072 6f63  _cur = X_preproc
+00019bf0: 6573 7369 6e67 2820 585f 6375 722c 206c  essing( X_cur, l
+00019c00: 6f67 5f74 7261 6e73 666f 726d 6564 2c20  og_transformed, 
+00019c10: 4e5f 6765 6e65 7320 3d20 3230 3030 2029  N_genes = 2000 )
+00019c20: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00019c30: 2020 2020 2020 585f 7063 615f 6375 7220        X_pca_cur 
+00019c40: 3d20 7063 612e 6669 745f 7472 616e 7366  = pca.fit_transf
+00019c50: 6f72 6d28 5878 5f63 7572 290a 2020 2020  orm(Xx_cur).    
+00019c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019c70: 585f 7063 615f 6375 7220 3d20 7064 2e44  X_pca_cur = pd.D
+00019c80: 6174 6146 7261 6d65 2858 5f70 6361 5f63  ataFrame(X_pca_c
+00019c90: 7572 2c20 696e 6465 7820 3d20 585f 6375  ur, index = X_cu
+00019ca0: 722e 696e 6465 782c 200a 2020 2020 2020  r.index, .      
 00019cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00019cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019ce0: 7265 736f 6c75 7469 6f6e 203d 2043 6c75  resolution = Clu
-00019cf0: 7374 6572 696e 675f 7265 736f 6c75 7469  stering_resoluti
-00019d00: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
-00019d10: 2020 2020 2020 2020 705f 6d61 6a5f 746d          p_maj_tm
-00019d20: 7020 3d20 706d 616a 0a0a 2020 2020 2020  p = pmaj..      
-00019d30: 2020 2020 2020 2020 2020 2020 2020 2323                ##
-00019d40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019d50: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-00019d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019d70: 2020 2020 6966 2075 7365 5f75 6e69 6f6e      if use_union
-00019d80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00019d90: 2020 2020 2020 2020 2020 6466 5f70 6173            df_pas
-00019da0: 7320 3d20 4e6f 6e65 0a20 2020 2020 2020  s = None.       
-00019db0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00019dc0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00019dd0: 2020 2020 2020 2020 2020 2023 2064 665f             # df_
-00019de0: 4753 415f 7363 6f72 655f 7375 6273 6574  GSA_score_subset
-00019df0: 203d 2064 665f 4753 415f 7363 6f72 655f   = df_GSA_score_
-00019e00: 7375 6273 6574 5f61 6c6c 2e6c 6f63 5b58  subset_all.loc[X
-00019e10: 5f70 6361 5f63 7572 2e69 6e64 6578 2c3a  _pca_cur.index,:
-00019e20: 5d20 2020 2020 2020 2020 2020 2020 2020  ]               
-00019e30: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-00019e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019e50: 2020 2320 6466 6e5f 7375 6273 6574 203d    # dfn_subset =
-00019e60: 2064 666e 5f73 7562 7365 745f 616c 6c2e   dfn_subset_all.
-00019e70: 6c6f 635b 585f 7063 615f 6375 722e 696e  loc[X_pca_cur.in
-00019e80: 6465 782c 3a5d 200a 2020 2020 2020 2020  dex,:] .        
+00019cd0: 2020 2020 2020 2063 6f6c 756d 6e73 203d         columns =
+00019ce0: 206c 6973 7428 6e70 2e61 7261 6e67 6528   list(np.arange(
+00019cf0: 696e 7428 4e5f 636f 6d70 6f6e 656e 7473  int(N_components
+00019d00: 5f70 6361 2929 2929 0a0a 2020 2020 2020  _pca))))..      
+00019d10: 2020 2020 2020 2020 2020 2020 2020 795f                y_
+00019d20: 636c 7573 745f 6375 722c 2063 6f62 6a20  clust_cur, cobj 
+00019d30: 3d20 636c 7573 7465 7269 6e67 5f61 6c67  = clustering_alg
+00019d40: 2858 5f70 6361 5f63 7572 2c20 636c 7573  (X_pca_cur, clus
+00019d50: 745f 616c 676f 203d 2043 6c75 7374 6572  t_algo = Cluster
+00019d60: 696e 675f 616c 676f 2c20 0a20 2020 2020  ing_algo, .     
+00019d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d90: 2020 2020 2020 2020 2020 2020 2020 4e5f                N_
+00019da0: 636c 7573 7465 7273 203d 204e 5f63 6f6d  clusters = N_com
+00019db0: 702c 200a 2020 2020 2020 2020 2020 2020  p, .            
+00019dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019de0: 2020 2020 2020 2072 6573 6f6c 7574 696f         resolutio
+00019df0: 6e20 3d20 436c 7573 7465 7269 6e67 5f72  n = Clustering_r
+00019e00: 6573 6f6c 7574 696f 6e29 0a20 2020 2020  esolution).     
+00019e10: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00019e20: 5f6d 616a 5f74 6d70 203d 2070 6d61 6a0a  _maj_tmp = pmaj.
+00019e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019e40: 2020 2020 2023 2323 2323 2323 2323 2323       ###########
+00019e50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00019e60: 2323 2323 2323 0a20 2020 2020 2020 2020  ######.         
+00019e70: 2020 2020 2020 2020 2020 2069 6620 7573             if us
+00019e80: 655f 756e 696f 6e3a 0a20 2020 2020 2020  e_union:.       
 00019e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019eb0: 2020 2020 2020 2020 2064 665f 7265 735f           df_res_
-00019ec0: 7375 6273 6574 2c20 6466 5f47 5341 5f73  subset, df_GSA_s
-00019ed0: 636f 7265 5f73 7562 7365 742c 2064 666e  core_subset, dfn
-00019ee0: 5f73 7562 7365 7420 3d20 5c0a 2020 2020  _subset = \.    
-00019ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019f00: 2020 2020 2020 2020 4753 415f 6365 6c6c          GSA_cell
-00019f10: 5f73 7562 7479 7069 6e67 2820 585f 6375  _subtyping( X_cu
-00019f20: 722c 206d 6b72 5f6c 7374 2c20 6d6b 725f  r, mkr_lst, mkr_
-00019f30: 6c73 745f 6e65 672c 2076 6572 626f 7365  lst_neg, verbose
-00019f40: 203d 2076 6572 626f 7365 2029 0a20 2020   = verbose ).   
-00019f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019f60: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-00019f70: 2020 2020 2020 2020 2020 2020 2020 6466                df
-00019f80: 5f47 5341 5f73 636f 7265 5f6d 696e 6f72  _GSA_score_minor
-00019f90: 5f63 7572 203d 2070 642e 4461 7461 4672  _cur = pd.DataFr
-00019fa0: 616d 6528 696e 6465 7820 3d20 585f 7063  ame(index = X_pc
-00019fb0: 615f 6375 722e 696e 6465 782c 2063 6f6c  a_cur.index, col
-00019fc0: 756d 6e73 203d 206d 696e 6f72 5f74 7970  umns = minor_typ
-00019fd0: 655f 6c73 745f 6375 7229 0a20 2020 2020  e_lst_cur).     
-00019fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019ff0: 2020 2064 666e 5f63 7572 203d 2070 642e     dfn_cur = pd.
-0001a000: 4461 7461 4672 616d 6528 696e 6465 7820  DataFrame(index 
-0001a010: 3d20 585f 7063 615f 6375 722e 696e 6465  = X_pca_cur.inde
-0001a020: 782c 2063 6f6c 756d 6e73 203d 206d 696e  x, columns = min
-0001a030: 6f72 5f74 7970 655f 6c73 745f 6375 7229  or_type_lst_cur)
-0001a040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a050: 2020 2020 2020 2020 2066 6f72 206d 696e           for min
-0001a060: 6f72 2069 6e20 6d61 705f 6469 6374 5f6d  or in map_dict_m
-0001a070: 696e 3273 7562 2e6b 6579 7328 293a 0a20  in2sub.keys():. 
-0001a080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a090: 2020 2020 2020 2020 2020 2069 6620 6d69             if mi
-0001a0a0: 6e6f 7220 696e 206d 696e 6f72 5f74 7970  nor in minor_typ
-0001a0b0: 655f 6c73 745f 6375 723a 0a20 2020 2020  e_lst_cur:.     
-0001a0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a0d0: 2020 2020 2020 2020 2020 2073 7562 5f6c             sub_l
-0001a0e0: 7374 203d 206d 6170 5f64 6963 745f 6d69  st = map_dict_mi
-0001a0f0: 6e32 7375 625b 6d69 6e6f 725d 0a20 2020  n2sub[minor].   
-0001a100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a110: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001a120: 6c65 6e28 7375 625f 6c73 7429 203d 3d20  len(sub_lst) == 
-0001a130: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-0001a140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a150: 2020 2020 2020 2062 6573 745f 7363 6f72         best_scor
-0001a160: 6520 3d20 6466 5f47 5341 5f73 636f 7265  e = df_GSA_score
-0001a170: 5f73 7562 7365 745b 7375 625f 6c73 745b  _subset[sub_lst[
-0001a180: 305d 5d0a 2020 2020 2020 2020 2020 2020  0]].            
+00019ea0: 2064 665f 7061 7373 203d 204e 6f6e 650a   df_pass = None.
+00019eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ec0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00019ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ee0: 2020 2320 6466 5f47 5341 5f73 636f 7265    # df_GSA_score
+00019ef0: 5f73 7562 7365 7420 3d20 6466 5f47 5341  _subset = df_GSA
+00019f00: 5f73 636f 7265 5f73 7562 7365 745f 616c  _score_subset_al
+00019f10: 6c2e 6c6f 635b 585f 7063 615f 6375 722e  l.loc[X_pca_cur.
+00019f20: 696e 6465 782c 3a5d 2020 2020 2020 2020  index,:]        
+00019f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019f50: 2020 2020 2020 2020 2023 2064 666e 5f73           # dfn_s
+00019f60: 7562 7365 7420 3d20 6466 6e5f 7375 6273  ubset = dfn_subs
+00019f70: 6574 5f61 6c6c 2e6c 6f63 5b58 5f70 6361  et_all.loc[X_pca
+00019f80: 5f63 7572 2e69 6e64 6578 2c3a 5d20 0a20  _cur.index,:] . 
+00019f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019fa0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00019fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019fc0: 6466 5f72 6573 5f73 7562 7365 742c 2064  df_res_subset, d
+00019fd0: 665f 4753 415f 7363 6f72 655f 7375 6273  f_GSA_score_subs
+00019fe0: 6574 2c20 6466 6e5f 7375 6273 6574 203d  et, dfn_subset =
+00019ff0: 205c 0a20 2020 2020 2020 2020 2020 2020   \.             
+0001a000: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+0001a010: 5341 5f63 656c 6c5f 7375 6274 7970 696e  SA_cell_subtypin
+0001a020: 6728 2058 5f63 7572 2c20 6d6b 725f 6c73  g( X_cur, mkr_ls
+0001a030: 742c 206d 6b72 5f6c 7374 5f6e 6567 2c20  t, mkr_lst_neg, 
+0001a040: 7665 7262 6f73 6520 3d20 7665 7262 6f73  verbose = verbos
+0001a050: 6520 290a 2020 2020 2020 2020 2020 2020  e ).            
+0001a060: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0001a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a080: 2020 2020 2064 665f 4753 415f 7363 6f72       df_GSA_scor
+0001a090: 655f 6d69 6e6f 725f 6375 7220 3d20 7064  e_minor_cur = pd
+0001a0a0: 2e44 6174 6146 7261 6d65 2869 6e64 6578  .DataFrame(index
+0001a0b0: 203d 2058 5f70 6361 5f63 7572 2e69 6e64   = X_pca_cur.ind
+0001a0c0: 6578 2c20 636f 6c75 6d6e 7320 3d20 6d69  ex, columns = mi
+0001a0d0: 6e6f 725f 7479 7065 5f6c 7374 5f63 7572  nor_type_lst_cur
+0001a0e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001a0f0: 2020 2020 2020 2020 2020 6466 6e5f 6375            dfn_cu
+0001a100: 7220 3d20 7064 2e44 6174 6146 7261 6d65  r = pd.DataFrame
+0001a110: 2869 6e64 6578 203d 2058 5f70 6361 5f63  (index = X_pca_c
+0001a120: 7572 2e69 6e64 6578 2c20 636f 6c75 6d6e  ur.index, column
+0001a130: 7320 3d20 6d69 6e6f 725f 7479 7065 5f6c  s = minor_type_l
+0001a140: 7374 5f63 7572 290a 2020 2020 2020 2020  st_cur).        
+0001a150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a160: 666f 7220 6d69 6e6f 7220 696e 206d 6170  for minor in map
+0001a170: 5f64 6963 745f 6d69 6e32 7375 622e 6b65  _dict_min2sub.ke
+0001a180: 7973 2829 3a0a 2020 2020 2020 2020 2020  ys():.          
 0001a190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a1a0: 2020 2020 2020 2020 6466 6e5f 6375 725b          dfn_cur[
-0001a1b0: 6d69 6e6f 725d 203d 2064 666e 5f73 7562  minor] = dfn_sub
-0001a1c0: 7365 745b 7375 625f 6c73 745b 305d 5d0a  set[sub_lst[0]].
+0001a1a0: 2020 6966 206d 696e 6f72 2069 6e20 6d69    if minor in mi
+0001a1b0: 6e6f 725f 7479 7065 5f6c 7374 5f63 7572  nor_type_lst_cur
+0001a1c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
 0001a1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a1f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001a200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a210: 2020 2020 2020 2020 2020 7375 6273 6574            subset
-0001a220: 7320 3d20 6466 5f47 5341 5f73 636f 7265  s = df_GSA_score
-0001a230: 5f73 7562 7365 745b 7375 625f 6c73 745d  _subset[sub_lst]
-0001a240: 2e69 6478 6d61 7828 6178 6973 203d 2031  .idxmax(axis = 1
-0001a250: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001a260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a270: 2020 2020 2020 666f 7220 6b2c 2073 2069        for k, s i
-0001a280: 6e20 656e 756d 6572 6174 6528 6c69 7374  n enumerate(list
-0001a290: 2873 7562 7365 7473 2929 3a0a 2020 2020  (subsets)):.    
-0001a2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a2c0: 2020 2020 6964 7820 3d20 585f 7063 615f      idx = X_pca_
-0001a2d0: 6375 722e 696e 6465 785b 6b5d 0a20 2020  cur.index[k].   
+0001a1e0: 2020 7375 625f 6c73 7420 3d20 6d61 705f    sub_lst = map_
+0001a1f0: 6469 6374 5f6d 696e 3273 7562 5b6d 696e  dict_min2sub[min
+0001a200: 6f72 5d0a 2020 2020 2020 2020 2020 2020  or].            
+0001a210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a220: 2020 2020 6966 206c 656e 2873 7562 5f6c      if len(sub_l
+0001a230: 7374 2920 3d3d 2031 3a0a 2020 2020 2020  st) == 1:.      
+0001a240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a250: 2020 2020 2020 2020 2020 2020 2020 6265                be
+0001a260: 7374 5f73 636f 7265 203d 2064 665f 4753  st_score = df_GS
+0001a270: 415f 7363 6f72 655f 7375 6273 6574 5b73  A_score_subset[s
+0001a280: 7562 5f6c 7374 5b30 5d5d 0a20 2020 2020  ub_lst[0]].     
+0001a290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a2a0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001a2b0: 666e 5f63 7572 5b6d 696e 6f72 5d20 3d20  fn_cur[minor] = 
+0001a2c0: 6466 6e5f 7375 6273 6574 5b73 7562 5f6c  dfn_subset[sub_l
+0001a2d0: 7374 5b30 5d5d 0a20 2020 2020 2020 2020  st[0]].         
 0001a2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a300: 2020 2020 2064 666e 5f63 7572 2e6c 6f63       dfn_cur.loc
-0001a310: 5b69 6478 2c6d 696e 6f72 5d20 3d20 6466  [idx,minor] = df
-0001a320: 6e5f 7375 6273 6574 2e6c 6f63 5b69 6478  n_subset.loc[idx
-0001a330: 2c73 5d0a 2020 2020 2020 2020 2020 2020  ,s].            
-0001a340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a350: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0001a2f0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001a300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a320: 2073 7562 7365 7473 203d 2064 665f 4753   subsets = df_GS
+0001a330: 415f 7363 6f72 655f 7375 6273 6574 5b73  A_score_subset[s
+0001a340: 7562 5f6c 7374 5d2e 6964 786d 6178 2861  ub_lst].idxmax(a
+0001a350: 7869 7320 3d20 3129 0a20 2020 2020 2020  xis = 1).       
 0001a360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a380: 2069 6620 4e5f 6d61 785f 746f 5f61 7665   if N_max_to_ave
-0001a390: 203c 3d20 313a 0a20 2020 2020 2020 2020   <= 1:.         
-0001a3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a3b0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0001a3c0: 6573 745f 7363 6f72 6520 3d20 6466 5f47  est_score = df_G
-0001a3d0: 5341 5f73 636f 7265 5f73 7562 7365 745b  SA_score_subset[
-0001a3e0: 7375 625f 6c73 745d 2e6d 6178 2861 7869  sub_lst].max(axi
-0001a3f0: 7320 3d20 3129 0a20 2020 2020 2020 2020  s = 1).         
-0001a400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a410: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0001a420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a440: 2020 2020 2020 2020 206e 5f6d 6178 203d           n_max =
-0001a450: 206d 696e 284e 5f6d 6178 5f74 6f5f 6176   min(N_max_to_av
-0001a460: 652c 206c 656e 2873 7562 5f6c 7374 2929  e, len(sub_lst))
-0001a470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a490: 2020 2020 2020 2020 2062 6573 745f 7363           best_sc
-0001a4a0: 6f72 6520 3d20 6e70 2e73 6f72 7428 6466  ore = np.sort(df
-0001a4b0: 5f47 5341 5f73 636f 7265 5f73 7562 7365  _GSA_score_subse
-0001a4c0: 745b 7375 625f 6c73 745d 2c20 6178 6973  t[sub_lst], axis
-0001a4d0: 3d31 295b 3a2c 202d 6e5f 6d61 783a 5d2e  =1)[:, -n_max:].
-0001a4e0: 6d65 616e 2861 7869 7320 3d20 3129 0a0a  mean(axis = 1)..
-0001a4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a370: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0001a380: 206b 2c20 7320 696e 2065 6e75 6d65 7261   k, s in enumera
+0001a390: 7465 286c 6973 7428 7375 6273 6574 7329  te(list(subsets)
+0001a3a0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0001a3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a3c0: 2020 2020 2020 2020 2020 2069 6478 203d             idx =
+0001a3d0: 2058 5f70 6361 5f63 7572 2e69 6e64 6578   X_pca_cur.index
+0001a3e0: 5b6b 5d0a 2020 2020 2020 2020 2020 2020  [k].            
+0001a3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a400: 2020 2020 2020 2020 2020 2020 6466 6e5f              dfn_
+0001a410: 6375 722e 6c6f 635b 6964 782c 6d69 6e6f  cur.loc[idx,mino
+0001a420: 725d 203d 2064 666e 5f73 7562 7365 742e  r] = dfn_subset.
+0001a430: 6c6f 635b 6964 782c 735d 0a20 2020 2020  loc[idx,s].     
+0001a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a460: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+0001a470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a480: 2020 2020 2020 2020 6966 204e 5f6d 6178          if N_max
+0001a490: 5f74 6f5f 6176 6520 3c3d 2031 3a0a 2020  _to_ave <= 1:.  
+0001a4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a4c0: 2020 2020 2020 6265 7374 5f73 636f 7265        best_score
+0001a4d0: 203d 2064 665f 4753 415f 7363 6f72 655f   = df_GSA_score_
+0001a4e0: 7375 6273 6574 5b73 7562 5f6c 7374 5d2e  subset[sub_lst].
+0001a4f0: 6d61 7828 6178 6973 203d 2031 290a 2020  max(axis = 1).  
 0001a500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a510: 6466 5f47 5341 5f73 636f 7265 5f6d 696e  df_GSA_score_min
-0001a520: 6f72 5f63 7572 5b6d 696e 6f72 5d20 3d20  or_cur[minor] = 
-0001a530: 6265 7374 5f73 636f 7265 200a 2020 2020  best_score .    
+0001a510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a520: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001a530: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a550: 2020 2020 6466 5f70 6173 7320 3d20 6466      df_pass = df
-0001a560: 5f47 5341 5f73 636f 7265 5f6d 696e 6f72  _GSA_score_minor
-0001a570: 5f63 7572 0a0a 2020 2020 2020 2020 2020  _cur..          
-0001a580: 2020 2020 2020 2020 2020 2323 2058 5f70            ## X_p
-0001a590: 6361 5f63 7572 2c20 636f 626a 2c20 795f  ca_cur, cobj, y_
-0001a5a0: 636c 7573 745f 6375 7220 6e6f 7420 7573  clust_cur not us
-0001a5b0: 6564 2061 7320 7063 745f 6375 746f 6666  ed as pct_cutoff
-0001a5c0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-0001a5d0: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-0001a5e0: 7265 735f 6375 722c 2064 665f 7363 6f72  res_cur, df_scor
-0001a5f0: 655f 6375 722c 2064 665f 4753 415f 7363  e_cur, df_GSA_sc
-0001a600: 6f72 655f 6375 7220 3d20 5c0a 2020 2020  ore_cur = \.    
-0001a610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a620: 2020 2020 7275 6e5f 6773 615f 616e 645f      run_gsa_and_
-0001a630: 636c 6628 585f 7063 615f 6375 722c 2058  clf(X_pca_cur, X
-0001a640: 5f63 7572 2c20 636f 626a 2c20 795f 636c  _cur, cobj, y_cl
-0001a650: 7573 745f 6375 722c 206d 6b72 5f6c 7374  ust_cur, mkr_lst
-0001a660: 2c20 6d6b 725f 6c73 745f 6e65 672c 200a  , mkr_lst_neg, .
-0001a670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a550: 6e5f 6d61 7820 3d20 6d69 6e28 4e5f 6d61  n_max = min(N_ma
+0001a560: 785f 746f 5f61 7665 2c20 6c65 6e28 7375  x_to_ave, len(su
+0001a570: 625f 6c73 7429 290a 2020 2020 2020 2020  b_lst)).        
+0001a580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a5a0: 6265 7374 5f73 636f 7265 203d 206e 702e  best_score = np.
+0001a5b0: 736f 7274 2864 665f 4753 415f 7363 6f72  sort(df_GSA_scor
+0001a5c0: 655f 7375 6273 6574 5b73 7562 5f6c 7374  e_subset[sub_lst
+0001a5d0: 5d2c 2061 7869 733d 3129 5b3a 2c20 2d6e  ], axis=1)[:, -n
+0001a5e0: 5f6d 6178 3a5d 2e6d 6561 6e28 6178 6973  _max:].mean(axis
+0001a5f0: 203d 2031 290a 0a20 2020 2020 2020 2020   = 1)..         
+0001a600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a610: 2020 2020 2020 2064 665f 4753 415f 7363         df_GSA_sc
+0001a620: 6f72 655f 6d69 6e6f 725f 6375 725b 6d69  ore_minor_cur[mi
+0001a630: 6e6f 725d 203d 2062 6573 745f 7363 6f72  nor] = best_scor
+0001a640: 6520 0a20 2020 2020 2020 2020 2020 2020  e .             
+0001a650: 2020 2020 2020 2020 2020 2064 665f 7061             df_pa
+0001a660: 7373 203d 2064 665f 4753 415f 7363 6f72  ss = df_GSA_scor
+0001a670: 655f 6d69 6e6f 725f 6375 720a 0a20 2020  e_minor_cur..   
 0001a680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a690: 2020 2020 2020 2020 206d 6574 686f 6420           method 
-0001a6a0: 3d20 4e6f 6e65 2c20 4e5f 636f 6d70 6f6e  = None, N_compon
-0001a6b0: 656e 7473 203d 204e 5f63 6f6d 706f 6e65  ents = N_compone
-0001a6c0: 6e74 732c 2070 7661 6c5f 7468 203d 2070  nts, pval_th = p
-0001a6d0: 7661 6c5f 7468 2c20 0a20 2020 2020 2020  val_th, .       
-0001a6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a700: 2020 7063 745f 6669 745f 706e 7420 3d20    pct_fit_pnt = 
-0001a710: 7074 685f 6669 745f 706e 742c 2070 6374  pth_fit_pnt, pct
-0001a720: 5f6d 696e 5f72 6620 3d20 7063 745f 7468  _min_rf = pct_th
-0001a730: 5f6d 696e 2c0a 2020 2020 2020 2020 2020  _min,.          
-0001a740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a750: 2020 2020 2020 2020 2020 2020 2020 2054                 T
-0001a760: 6172 6765 745f 4650 5220 3d20 5461 7267  arget_FPR = Targ
-0001a770: 6574 5f46 5052 2c20 706d 616a 203d 2070  et_FPR, pmaj = p
-0001a780: 5f6d 616a 5f74 6d70 2c20 6d69 6e6f 725f  _maj_tmp, minor_
-0001a790: 6964 5f73 6570 203d 206d 696e 6f72 5f69  id_sep = minor_i
-0001a7a0: 645f 7365 702c 0a20 2020 2020 2020 2020  d_sep,.         
-0001a7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a7d0: 6d69 6e5f 6c6f 6750 5f64 6966 6620 3d20  min_logP_diff = 
-0001a7e0: 6d69 6e5f 6c6f 6750 5f64 6966 662c 2074  min_logP_diff, t
-0001a7f0: 6872 6573 686f 6c64 696e 6720 3d20 7468  hresholding = th
-0001a800: 7265 7368 6f6c 6469 6e67 5f6d 696e 6f72  resholding_minor
-0001a810: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001a820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a830: 2020 2020 2020 2020 2020 2070 6374 5f63             pct_c
-0001a840: 7574 6f66 6620 3d20 4661 6c73 652c 2063  utoff = False, c
-0001a850: 6263 5f63 7574 6f66 6620 3d20 6362 635f  bc_cutoff = cbc_
-0001a860: 6375 746f 6666 2c20 7072 696e 745f 7265  cutoff, print_re
-0001a870: 706f 7274 203d 2076 6572 626f 7365 2c20  port = verbose, 
-0001a880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a8a0: 2020 2020 2020 2020 2020 6466 5f47 5341            df_GSA
-0001a8b0: 5f73 636f 7265 203d 2064 665f 7061 7373  _score = df_pass
-0001a8c0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0001a8d0: 2020 2020 2020 2069 6620 6e6f 7420 7573         if not us
-0001a8e0: 655f 756e 696f 6e3a 0a20 2020 2020 2020  e_union:.       
-0001a8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a900: 2069 6478 7320 3d20 6466 5f72 6573 5f63   idxs = df_res_c
-0001a910: 7572 2e69 6e64 6578 2e76 616c 7565 730a  ur.index.values.
+0001a690: 2023 2320 585f 7063 615f 6375 722c 2063   ## X_pca_cur, c
+0001a6a0: 6f62 6a2c 2079 5f63 6c75 7374 5f63 7572  obj, y_clust_cur
+0001a6b0: 206e 6f74 2075 7365 6420 6173 2070 6374   not used as pct
+0001a6c0: 5f63 7574 6f66 6620 3d20 4661 6c73 650a  _cutoff = False.
+0001a6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a6e0: 2020 2020 6466 5f72 6573 5f63 7572 2c20      df_res_cur, 
+0001a6f0: 6466 5f73 636f 7265 5f63 7572 2c20 6466  df_score_cur, df
+0001a700: 5f47 5341 5f73 636f 7265 5f63 7572 203d  _GSA_score_cur =
+0001a710: 205c 0a20 2020 2020 2020 2020 2020 2020   \.             
+0001a720: 2020 2020 2020 2020 2020 2072 756e 5f67             run_g
+0001a730: 7361 5f61 6e64 5f63 6c66 2858 5f70 6361  sa_and_clf(X_pca
+0001a740: 5f63 7572 2c20 585f 6375 722c 2063 6f62  _cur, X_cur, cob
+0001a750: 6a2c 2079 5f63 6c75 7374 5f63 7572 2c20  j, y_clust_cur, 
+0001a760: 6d6b 725f 6c73 742c 206d 6b72 5f6c 7374  mkr_lst, mkr_lst
+0001a770: 5f6e 6567 2c20 0a20 2020 2020 2020 2020  _neg, .         
+0001a780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a7a0: 6d65 7468 6f64 203d 204e 6f6e 652c 204e  method = None, N
+0001a7b0: 5f63 6f6d 706f 6e65 6e74 7320 3d20 4e5f  _components = N_
+0001a7c0: 636f 6d70 6f6e 656e 7473 2c20 7076 616c  components, pval
+0001a7d0: 5f74 6820 3d20 7076 616c 5f74 682c 200a  _th = pval_th, .
+0001a7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a800: 2020 2020 2020 2020 2070 6374 5f66 6974           pct_fit
+0001a810: 5f70 6e74 203d 2070 7468 5f66 6974 5f70  _pnt = pth_fit_p
+0001a820: 6e74 2c20 7063 745f 6d69 6e5f 7266 203d  nt, pct_min_rf =
+0001a830: 2070 6374 5f74 685f 6d69 6e2c 0a20 2020   pct_th_min,.   
+0001a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a860: 2020 2020 2020 5461 7267 6574 5f46 5052        Target_FPR
+0001a870: 203d 2054 6172 6765 745f 4650 522c 2070   = Target_FPR, p
+0001a880: 6d61 6a20 3d20 705f 6d61 6a5f 746d 702c  maj = p_maj_tmp,
+0001a890: 206d 696e 6f72 5f69 645f 7365 7020 3d20   minor_id_sep = 
+0001a8a0: 6d69 6e6f 725f 6964 5f73 6570 2c0a 2020  minor_id_sep,.  
+0001a8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a8d0: 2020 2020 2020 206d 696e 5f6c 6f67 505f         min_logP_
+0001a8e0: 6469 6666 203d 206d 696e 5f6c 6f67 505f  diff = min_logP_
+0001a8f0: 6469 6666 2c20 7468 7265 7368 6f6c 6469  diff, thresholdi
+0001a900: 6e67 203d 2074 6872 6573 686f 6c64 696e  ng = thresholdin
+0001a910: 675f 6d69 6e6f 722c 0a20 2020 2020 2020  g_minor,.       
 0001a920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a930: 2020 2020 2020 2020 666f 7220 6b2c 2069          for k, i
-0001a940: 6478 2069 6e20 656e 756d 6572 6174 6528  dx in enumerate(
-0001a950: 6c69 7374 2869 6478 7329 293a 0a20 2020  list(idxs)):.   
-0001a960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a970: 2020 2020 2020 2020 2063 7420 3d20 6466           ct = df
-0001a980: 5f72 6573 5f63 7572 2e6c 6f63 5b69 6478  _res_cur.loc[idx
-0001a990: 2c20 2763 656c 6c5f 7479 7065 2831 7374  , 'cell_type(1st
-0001a9a0: 2927 5d0a 2020 2020 2020 2020 2020 2020  )'].            
-0001a9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a9c0: 6466 5f72 6573 5f63 7572 2e6c 6f63 5b69  df_res_cur.loc[i
-0001a9d0: 6478 2c20 274f 7665 726c 6170 275d 203d  dx, 'Overlap'] =
-0001a9e0: 2064 666e 5f63 7572 2e6c 6f63 5b69 6478   dfn_cur.loc[idx
-0001a9f0: 2c63 745d 0a20 2020 2020 2020 2020 2020  ,ct].           
-0001aa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa10: 2063 7420 3d20 6466 5f72 6573 5f63 7572   ct = df_res_cur
-0001aa20: 2e6c 6f63 5b69 6478 2c20 2763 656c 6c5f  .loc[idx, 'cell_
-0001aa30: 7479 7065 2832 6e64 2927 5d0a 2020 2020  type(2nd)'].    
-0001aa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa50: 2020 2020 2020 2020 6466 5f72 6573 5f63          df_res_c
-0001aa60: 7572 2e6c 6f63 5b69 6478 2c20 274f 7665  ur.loc[idx, 'Ove
-0001aa70: 726c 6170 2832 6e64 2927 5d20 3d20 6466  rlap(2nd)'] = df
-0001aa80: 6e5f 6375 722e 6c6f 635b 6964 782c 6374  n_cur.loc[idx,ct
-0001aa90: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0001aaa0: 2020 2020 2020 2327 2727 0a20 2020 2020        #'''.     
-0001aab0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001aac0: 7473 203d 206c 6973 7428 6d6b 725f 6c73  ts = list(mkr_ls
-0001aad0: 742e 6b65 7973 2829 290a 2020 2020 2020  t.keys()).      
-0001aae0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0001aaf0: 206c 656e 2863 7473 2920 3e20 313a 0a20   len(cts) > 1:. 
+0001a930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a940: 2020 7063 745f 6375 746f 6666 203d 2046    pct_cutoff = F
+0001a950: 616c 7365 2c20 6362 635f 6375 746f 6666  alse, cbc_cutoff
+0001a960: 203d 2063 6263 5f63 7574 6f66 662c 2070   = cbc_cutoff, p
+0001a970: 7269 6e74 5f72 6570 6f72 7420 3d20 7665  rint_report = ve
+0001a980: 7262 6f73 652c 200a 2020 2020 2020 2020  rbose, .        
+0001a990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a9b0: 2064 665f 4753 415f 7363 6f72 6520 3d20   df_GSA_score = 
+0001a9c0: 6466 5f70 6173 7329 0a0a 2020 2020 2020  df_pass)..      
+0001a9d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001a9e0: 206e 6f74 2075 7365 5f75 6e69 6f6e 3a0a   not use_union:.
+0001a9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aa00: 2020 2020 2020 2020 6964 7873 203d 2064          idxs = d
+0001aa10: 665f 7265 735f 6375 722e 696e 6465 782e  f_res_cur.index.
+0001aa20: 7661 6c75 6573 0a20 2020 2020 2020 2020  values.         
+0001aa30: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001aa40: 6f72 206b 2c20 6964 7820 696e 2065 6e75  or k, idx in enu
+0001aa50: 6d65 7261 7465 286c 6973 7428 6964 7873  merate(list(idxs
+0001aa60: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+0001aa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aa80: 6374 203d 2064 665f 7265 735f 6375 722e  ct = df_res_cur.
+0001aa90: 6c6f 635b 6964 782c 2027 6365 6c6c 5f74  loc[idx, 'cell_t
+0001aaa0: 7970 6528 3173 7429 275d 0a20 2020 2020  ype(1st)'].     
+0001aab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aac0: 2020 2020 2020 2064 665f 7265 735f 6375         df_res_cu
+0001aad0: 722e 6c6f 635b 6964 782c 2027 4f76 6572  r.loc[idx, 'Over
+0001aae0: 6c61 7027 5d20 3d20 6466 6e5f 6375 722e  lap'] = dfn_cur.
+0001aaf0: 6c6f 635b 6964 782c 6374 5d0a 2020 2020  loc[idx,ct].    
 0001ab00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ab10: 2020 2020 2020 2062 7820 3d20 6466 5f72         bx = df_r
-0001ab20: 6573 5f63 7572 5b27 2d6c 6f67 5027 5d20  es_cur['-logP'] 
-0001ab30: 3c20 2d6e 702e 6c6f 6731 3028 2070 7661  < -np.log10( pva
-0001ab40: 6c5f 7468 2029 0a20 2020 2020 2020 2020  l_th ).         
+0001ab10: 2020 2020 2020 2020 6374 203d 2064 665f          ct = df_
+0001ab20: 7265 735f 6375 722e 6c6f 635b 6964 782c  res_cur.loc[idx,
+0001ab30: 2027 6365 6c6c 5f74 7970 6528 326e 6429   'cell_type(2nd)
+0001ab40: 275d 0a20 2020 2020 2020 2020 2020 2020  '].             
 0001ab50: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0001ab60: 665f 7265 735f 6375 722e 6c6f 635b 6278  f_res_cur.loc[bx
-0001ab70: 2c20 2763 656c 6c5f 7479 7065 275d 203d  , 'cell_type'] =
-0001ab80: 2027 756e 6173 7369 676e 6564 2720 2020   'unassigned'   
-0001ab90: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
-0001aba0: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-0001abb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001abc0: 2020 2020 2327 2727 0a20 2020 2020 2020      #'''.       
-0001abd0: 2020 2020 2020 2020 2020 2020 2023 2323               ###
-0001abe0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001abf0: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
-0001ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac10: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-0001ac20: 2020 2020 2020 2020 795f 7072 6564 5f63          y_pred_c
-0001ac30: 7572 203d 2064 665f 7265 735f 6375 725b  ur = df_res_cur[
-0001ac40: 2763 656c 6c5f 7479 7065 275d 0a20 2020  'cell_type'].   
+0001ab60: 665f 7265 735f 6375 722e 6c6f 635b 6964  f_res_cur.loc[id
+0001ab70: 782c 2027 4f76 6572 6c61 7028 326e 6429  x, 'Overlap(2nd)
+0001ab80: 275d 203d 2064 666e 5f63 7572 2e6c 6f63  '] = dfn_cur.loc
+0001ab90: 5b69 6478 2c63 745d 0a20 2020 2020 2020  [idx,ct].       
+0001aba0: 2020 2020 2020 2020 2020 2020 2023 2727               #''
+0001abb0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001abc0: 2020 2020 2020 6374 7320 3d20 6c69 7374        cts = list
+0001abd0: 286d 6b72 5f6c 7374 2e6b 6579 7328 2929  (mkr_lst.keys())
+0001abe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001abf0: 2020 2020 2069 6620 6c65 6e28 6374 7329       if len(cts)
+0001ac00: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
+0001ac10: 2020 2020 2020 2020 2020 2020 2020 6278                bx
+0001ac20: 203d 2064 665f 7265 735f 6375 725b 272d   = df_res_cur['-
+0001ac30: 6c6f 6750 275d 203c 202d 6e70 2e6c 6f67  logP'] < -np.log
+0001ac40: 3130 2820 7076 616c 5f74 6820 290a 2020  10( pval_th ).  
 0001ac50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac60: 2079 735f 6375 7220 3d20 6466 5f72 6573   ys_cur = df_res
-0001ac70: 5f63 7572 5b27 6365 6c6c 5f74 7970 6528  _cur['cell_type(
-0001ac80: 7265 7629 275d 0a0a 2020 2020 2020 2020  rev)']..        
-0001ac90: 2020 2020 2020 2020 2020 2020 6e5f 7461              n_ta
-0001aca0: 7267 6574 7320 3d20 6c65 6e28 6c69 7374  rgets = len(list
-0001acb0: 286d 6b72 5f6c 7374 2e6b 6579 7328 2929  (mkr_lst.keys())
-0001acc0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001acd0: 2020 2020 2020 6966 2028 4e5f 6e65 6967        if (N_neig
-0001ace0: 6862 6f72 735f 6d69 6e6f 7220 3e20 3229  hbors_minor > 2)
-0001acf0: 2026 2028 6c65 6e28 795f 7072 6564 5f63   & (len(y_pred_c
-0001ad00: 7572 2920 3e3d 204e 5f6e 6569 6768 626f  ur) >= N_neighbo
-0001ad10: 7273 5f6d 696e 6f72 2920 2620 286e 5f74  rs_minor) & (n_t
-0001ad20: 6172 6765 7473 203e 2031 293a 0a20 2020  argets > 1):.   
-0001ad30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ad40: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-0001ad50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ad60: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0001ad70: 6e74 2827 4170 706c 7969 6e67 204b 4e4e  nt('Applying KNN
-0001ad80: 2072 756c 6520 746f 2063 6f72 7265 6374   rule to correct
-0001ad90: 206d 696e 6f72 2074 7970 6520 2e2e 2027   minor type .. '
-0001ada0: 2c20 656e 6420 3d20 2727 290a 0a20 2020  , end = '')..   
-0001adb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001adc0: 2020 2020 2023 2320 4b4e 4e20 636f 7272       ## KNN corr
-0001add0: 6563 7469 6f6e 0a20 2020 2020 2020 2020  ection.         
-0001ade0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0001adf0: 2727 0a20 2020 2020 2020 2020 2020 2020  ''.             
-0001ae00: 2020 2020 2020 2020 2020 206e 6272 7320             nbrs 
-0001ae10: 3d20 4e65 6172 6573 744e 6569 6768 626f  = NearestNeighbo
-0001ae20: 7273 286e 5f6e 6569 6768 626f 7273 3d20  rs(n_neighbors= 
-0001ae30: 696e 7428 4e5f 6e65 6967 6862 6f72 735f  int(N_neighbors_
-0001ae40: 6d69 6e6f 7229 2c20 616c 676f 7269 7468  minor), algorith
-0001ae50: 6d3d 2762 616c 6c5f 7472 6565 2729 2e66  m='ball_tree').f
-0001ae60: 6974 2858 5f70 6361 5f63 7572 290a 2020  it(X_pca_cur).  
-0001ae70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ae80: 2020 2020 2020 6469 7374 616e 6365 732c        distances,
-0001ae90: 206e 6569 5f69 6e64 6963 6573 203d 206e   nei_indices = n
-0001aea0: 6272 732e 6b6e 6569 6768 626f 7273 2858  brs.kneighbors(X
-0001aeb0: 5f70 6361 5f63 7572 290a 2020 2020 2020  _pca_cur).      
-0001aec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aed0: 2020 6e65 695f 696e 6469 6365 7320 3d20    nei_indices = 
-0001aee0: 7064 2e44 6174 6146 7261 6d65 2820 6e65  pd.DataFrame( ne
-0001aef0: 695f 696e 6469 6365 732c 2069 6e64 6578  i_indices, index
-0001af00: 203d 2058 5f70 6361 5f63 7572 2e69 6e64   = X_pca_cur.ind
-0001af10: 6578 2e76 616c 7565 7320 290a 2020 2020  ex.values ).    
-0001af20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001af30: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-0001af40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001af50: 6164 6a20 3d20 6b6e 6569 6768 626f 7273  adj = kneighbors
-0001af60: 5f67 7261 7068 2858 5f70 6361 5f63 7572  _graph(X_pca_cur
-0001af70: 2c20 696e 7428 4e5f 6e65 6967 6862 6f72  , int(N_neighbor
-0001af80: 735f 6d69 6e6f 7229 2c20 6d6f 6465 3d27  s_minor), mode='
-0001af90: 636f 6e6e 6563 7469 7669 7479 272c 2069  connectivity', i
-0001afa0: 6e63 6c75 6465 5f73 656c 663d 5472 7565  nclude_self=True
-0001afb0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001afc0: 2020 2020 2020 2020 2020 6164 6a20 3d20            adj = 
-0001afd0: 6164 6a2e 746f 6465 6e73 6528 292e 6173  adj.todense().as
-0001afe0: 7479 7065 2869 6e74 290a 2020 2020 2020  type(int).      
-0001aff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b000: 2020 6964 785f 6172 7920 3d20 6e70 2e61    idx_ary = np.a
-0001b010: 7261 6e67 6528 585f 7063 615f 6375 722e  range(X_pca_cur.
-0001b020: 7368 6170 655b 305d 2c20 6474 7970 6520  shape[0], dtype 
-0001b030: 3d20 696e 7429 2023 2058 5f70 6361 2e69  = int) # X_pca.i
-0001b040: 6e64 6578 2e76 616c 7565 730a 2020 2020  ndex.values.    
-0001b050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b060: 2020 2020 6e65 695f 696e 6469 6365 7320      nei_indices 
-0001b070: 3d20 6e70 2e7a 6572 6f73 285b 6164 6a2e  = np.zeros([adj.
-0001b080: 7368 6170 655b 305d 2c20 4e5f 6e65 6967  shape[0], N_neig
-0001b090: 6862 6f72 735f 6d69 6e6f 725d 290a 2020  hbors_minor]).  
-0001b0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b0b0: 2020 2020 2020 666f 7220 6b20 696e 2072        for k in r
-0001b0c0: 616e 6765 2861 646a 2e73 6861 7065 5b30  ange(adj.shape[0
-0001b0d0: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
-0001b0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b0f0: 6964 7873 203d 206e 702e 6172 7261 7928  idxs = np.array(
-0001b100: 6164 6a5b 6b2c 3a5d 203e 2030 290a 2020  adj[k,:] > 0).  
-0001b110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b120: 2020 2020 2020 2020 2020 6e65 695f 696e            nei_in
-0001b130: 6469 6365 735b 6b2c 3a5d 203d 2069 6478  dices[k,:] = idx
-0001b140: 5f61 7279 5b69 6478 735b 302c 3a5d 5d0a  _ary[idxs[0,:]].
-0001b150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b160: 2020 2020 2020 2020 6e65 695f 696e 6469          nei_indi
-0001b170: 6365 7320 3d20 7064 2e44 6174 6146 7261  ces = pd.DataFra
-0001b180: 6d65 2820 6e65 695f 696e 6469 6365 732c  me( nei_indices,
-0001b190: 2069 6e64 6578 203d 2058 5f70 6361 5f63   index = X_pca_c
-0001b1a0: 7572 2e69 6e64 6578 2e76 616c 7565 7320  ur.index.values 
-0001b1b0: 2920 0a0a 2020 2020 2020 2020 2020 2020  ) ..            
-0001b1c0: 2020 2020 2020 2020 2020 2020 2320 6773              # gs
-0001b1d0: 615f 7363 6f72 6520 3d20 6466 5f72 6573  a_score = df_res
-0001b1e0: 5f63 7572 5b27 2d6c 6f67 5027 5d0a 2020  _cur['-logP'].  
-0001b1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b200: 2020 2020 2020 6966 2064 665f 4753 415f        if df_GSA_
-0001b210: 7363 6f72 655f 6375 7220 6973 206e 6f74  score_cur is not
-0001b220: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0001b230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b240: 2020 2023 2070 7269 6e74 286e 6569 5f69     # print(nei_i
-0001b250: 6e64 6963 6573 2e73 6861 7065 2c20 6466  ndices.shape, df
-0001b260: 5f47 5341 5f73 636f 7265 5f63 7572 2e73  _GSA_score_cur.s
-0001b270: 6861 7065 2c20 666c 7573 6820 3d20 5472  hape, flush = Tr
-0001b280: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-0001b290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b2a0: 6966 206b 6e6e 5f74 7970 6520 3d3d 2030  if knn_type == 0
-0001b2b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001ac60: 2020 2020 2020 6466 5f72 6573 5f63 7572        df_res_cur
+0001ac70: 2e6c 6f63 5b62 782c 2027 6365 6c6c 5f74  .loc[bx, 'cell_t
+0001ac80: 7970 6527 5d20 3d20 2775 6e61 7373 6967  ype'] = 'unassig
+0001ac90: 6e65 6427 2020 2020 200a 2020 2020 2020  ned'     .      
+0001aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001acb0: 2020 7061 7373 0a20 2020 2020 2020 2020    pass.         
+0001acc0: 2020 2020 2020 2020 2020 2023 2727 270a             #'''.
+0001acd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ace0: 2020 2020 2323 2323 2323 2323 2323 2323      ############
+0001acf0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001ad00: 2323 2323 230a 2020 2020 2020 2020 2020  #####.          
+0001ad10: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+0001ad20: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+0001ad30: 5f70 7265 645f 6375 7220 3d20 6466 5f72  _pred_cur = df_r
+0001ad40: 6573 5f63 7572 5b27 6365 6c6c 5f74 7970  es_cur['cell_typ
+0001ad50: 6527 5d0a 2020 2020 2020 2020 2020 2020  e'].            
+0001ad60: 2020 2020 2020 2020 7973 5f63 7572 203d          ys_cur =
+0001ad70: 2064 665f 7265 735f 6375 725b 2763 656c   df_res_cur['cel
+0001ad80: 6c5f 7479 7065 2872 6576 2927 5d0a 0a20  l_type(rev)'].. 
+0001ad90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ada0: 2020 206e 5f74 6172 6765 7473 203d 206c     n_targets = l
+0001adb0: 656e 286c 6973 7428 6d6b 725f 6c73 742e  en(list(mkr_lst.
+0001adc0: 6b65 7973 2829 2929 0a20 2020 2020 2020  keys())).       
+0001add0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001ade0: 284e 5f6e 6569 6768 626f 7273 5f6d 696e  (N_neighbors_min
+0001adf0: 6f72 203e 2032 2920 2620 286c 656e 2879  or > 2) & (len(y
+0001ae00: 5f70 7265 645f 6375 7229 203e 3d20 4e5f  _pred_cur) >= N_
+0001ae10: 6e65 6967 6862 6f72 735f 6d69 6e6f 7229  neighbors_minor)
+0001ae20: 2026 2028 6e5f 7461 7267 6574 7320 3e20   & (n_targets > 
+0001ae30: 3129 3a0a 2020 2020 2020 2020 2020 2020  1):.            
+0001ae40: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+0001ae50: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+0001ae60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ae70: 2020 2020 7072 696e 7428 2741 7070 6c79      print('Apply
+0001ae80: 696e 6720 4b4e 4e20 7275 6c65 2074 6f20  ing KNN rule to 
+0001ae90: 636f 7272 6563 7420 6d69 6e6f 7220 7479  correct minor ty
+0001aea0: 7065 202e 2e20 272c 2065 6e64 203d 2027  pe .. ', end = '
+0001aeb0: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
+0001aec0: 2020 2020 2020 2020 2020 2020 2323 204b              ## K
+0001aed0: 4e4e 2063 6f72 7265 6374 696f 6e0a 2020  NN correction.  
+0001aee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aef0: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+0001af00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001af10: 2020 6e62 7273 203d 204e 6561 7265 7374    nbrs = Nearest
+0001af20: 4e65 6967 6862 6f72 7328 6e5f 6e65 6967  Neighbors(n_neig
+0001af30: 6862 6f72 733d 2069 6e74 284e 5f6e 6569  hbors= int(N_nei
+0001af40: 6768 626f 7273 5f6d 696e 6f72 292c 2061  ghbors_minor), a
+0001af50: 6c67 6f72 6974 686d 3d27 6261 6c6c 5f74  lgorithm='ball_t
+0001af60: 7265 6527 292e 6669 7428 585f 7063 615f  ree').fit(X_pca_
+0001af70: 6375 7229 0a20 2020 2020 2020 2020 2020  cur).           
+0001af80: 2020 2020 2020 2020 2020 2020 2064 6973               dis
+0001af90: 7461 6e63 6573 2c20 6e65 695f 696e 6469  tances, nei_indi
+0001afa0: 6365 7320 3d20 6e62 7273 2e6b 6e65 6967  ces = nbrs.kneig
+0001afb0: 6862 6f72 7328 585f 7063 615f 6375 7229  hbors(X_pca_cur)
+0001afc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001afd0: 2020 2020 2020 2020 206e 6569 5f69 6e64           nei_ind
+0001afe0: 6963 6573 203d 2070 642e 4461 7461 4672  ices = pd.DataFr
+0001aff0: 616d 6528 206e 6569 5f69 6e64 6963 6573  ame( nei_indices
+0001b000: 2c20 696e 6465 7820 3d20 585f 7063 615f  , index = X_pca_
+0001b010: 6375 722e 696e 6465 782e 7661 6c75 6573  cur.index.values
+0001b020: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0001b030: 2020 2020 2020 2020 2020 2027 2727 0a20             '''. 
+0001b040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b050: 2020 2020 2020 2061 646a 203d 206b 6e65         adj = kne
+0001b060: 6967 6862 6f72 735f 6772 6170 6828 585f  ighbors_graph(X_
+0001b070: 7063 615f 6375 722c 2069 6e74 284e 5f6e  pca_cur, int(N_n
+0001b080: 6569 6768 626f 7273 5f6d 696e 6f72 292c  eighbors_minor),
+0001b090: 206d 6f64 653d 2763 6f6e 6e65 6374 6976   mode='connectiv
+0001b0a0: 6974 7927 2c20 696e 636c 7564 655f 7365  ity', include_se
+0001b0b0: 6c66 3d54 7275 6529 0a20 2020 2020 2020  lf=True).       
+0001b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b0d0: 2061 646a 203d 2061 646a 2e74 6f64 656e   adj = adj.toden
+0001b0e0: 7365 2829 2e61 7374 7970 6528 696e 7429  se().astype(int)
+0001b0f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b100: 2020 2020 2020 2020 2069 6478 5f61 7279           idx_ary
+0001b110: 203d 206e 702e 6172 616e 6765 2858 5f70   = np.arange(X_p
+0001b120: 6361 5f63 7572 2e73 6861 7065 5b30 5d2c  ca_cur.shape[0],
+0001b130: 2064 7479 7065 203d 2069 6e74 2920 2320   dtype = int) # 
+0001b140: 585f 7063 612e 696e 6465 782e 7661 6c75  X_pca.index.valu
+0001b150: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+0001b160: 2020 2020 2020 2020 2020 206e 6569 5f69             nei_i
+0001b170: 6e64 6963 6573 203d 206e 702e 7a65 726f  ndices = np.zero
+0001b180: 7328 5b61 646a 2e73 6861 7065 5b30 5d2c  s([adj.shape[0],
+0001b190: 204e 5f6e 6569 6768 626f 7273 5f6d 696e   N_neighbors_min
+0001b1a0: 6f72 5d29 0a20 2020 2020 2020 2020 2020  or]).           
+0001b1b0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0001b1c0: 206b 2069 6e20 7261 6e67 6528 6164 6a2e   k in range(adj.
+0001b1d0: 7368 6170 655b 305d 293a 0a20 2020 2020  shape[0]):.     
+0001b1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b1f0: 2020 2020 2020 2069 6478 7320 3d20 6e70         idxs = np
+0001b200: 2e61 7272 6179 2861 646a 5b6b 2c3a 5d20  .array(adj[k,:] 
+0001b210: 3e20 3029 0a20 2020 2020 2020 2020 2020  > 0).           
+0001b220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b230: 206e 6569 5f69 6e64 6963 6573 5b6b 2c3a   nei_indices[k,:
+0001b240: 5d20 3d20 6964 785f 6172 795b 6964 7873  ] = idx_ary[idxs
+0001b250: 5b30 2c3a 5d5d 0a20 2020 2020 2020 2020  [0,:]].         
+0001b260: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0001b270: 6569 5f69 6e64 6963 6573 203d 2070 642e  ei_indices = pd.
+0001b280: 4461 7461 4672 616d 6528 206e 6569 5f69  DataFrame( nei_i
+0001b290: 6e64 6963 6573 2c20 696e 6465 7820 3d20  ndices, index = 
+0001b2a0: 585f 7063 615f 6375 722e 696e 6465 782e  X_pca_cur.index.
+0001b2b0: 7661 6c75 6573 2029 200a 0a20 2020 2020  values ) ..     
 0001b2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b2d0: 2020 795f 7072 6564 5f63 7572 2c20 7363    y_pred_cur, sc
-0001b2e0: 6f72 655f 7570 203d 2061 7070 6c79 5f6b  ore_up = apply_k
-0001b2f0: 6e6e 286e 6569 5f69 6e64 6963 6573 2c20  nn(nei_indices, 
-0001b300: 795f 7072 6564 5f63 7572 2c20 6466 5f47  y_pred_cur, df_G
-0001b310: 5341 5f73 636f 7265 5f63 7572 2c20 0a20  SA_score_cur, . 
-0001b320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b2d0: 2020 2023 2067 7361 5f73 636f 7265 203d     # gsa_score =
+0001b2e0: 2064 665f 7265 735f 6375 725b 272d 6c6f   df_res_cur['-lo
+0001b2f0: 6750 275d 0a20 2020 2020 2020 2020 2020  gP'].           
+0001b300: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001b310: 6466 5f47 5341 5f73 636f 7265 5f63 7572  df_GSA_score_cur
+0001b320: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
 0001b330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b350: 2020 2020 2020 706d 616a 203d 206b 6e6e        pmaj = knn
-0001b360: 5f70 6d61 6a2c 206e 6c6f 675f 7076 616c  _pmaj, nlog_pval
-0001b370: 5f74 6820 3d20 2d6e 702e 6c6f 6731 3028  _th = -np.log10(
-0001b380: 7076 616c 5f74 6829 2920 2020 2020 2020  pval_th))       
-0001b390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b3a0: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-0001b3b0: 6620 6b6e 6e5f 7479 7065 203d 3d20 313a  f knn_type == 1:
-0001b3c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b3e0: 2079 5f70 7265 645f 6375 722c 2073 636f   y_pred_cur, sco
-0001b3f0: 7265 5f75 7020 3d20 6170 706c 795f 6b6e  re_up = apply_kn
-0001b400: 6e31 286e 6569 5f69 6e64 6963 6573 2c20  n1(nei_indices, 
-0001b410: 795f 7072 6564 5f63 7572 2c20 6466 5f47  y_pred_cur, df_G
-0001b420: 5341 5f73 636f 7265 5f63 7572 2c20 0a20  SA_score_cur, . 
+0001b340: 2020 2020 2020 2020 2020 2320 7072 696e            # prin
+0001b350: 7428 6e65 695f 696e 6469 6365 732e 7368  t(nei_indices.sh
+0001b360: 6170 652c 2064 665f 4753 415f 7363 6f72  ape, df_GSA_scor
+0001b370: 655f 6375 722e 7368 6170 652c 2066 6c75  e_cur.shape, flu
+0001b380: 7368 203d 2054 7275 6529 0a20 2020 2020  sh = True).     
+0001b390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b3a0: 2020 2020 2020 2069 6620 6b6e 6e5f 7479         if knn_ty
+0001b3b0: 7065 203d 3d20 303a 0a20 2020 2020 2020  pe == 0:.       
+0001b3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b3d0: 2020 2020 2020 2020 2079 5f70 7265 645f           y_pred_
+0001b3e0: 6375 722c 2073 636f 7265 5f75 7020 3d20  cur, score_up = 
+0001b3f0: 6170 706c 795f 6b6e 6e28 6e65 695f 696e  apply_knn(nei_in
+0001b400: 6469 6365 732c 2079 5f70 7265 645f 6375  dices, y_pred_cu
+0001b410: 722c 2064 665f 4753 415f 7363 6f72 655f  r, df_GSA_score_
+0001b420: 6375 722c 200a 2020 2020 2020 2020 2020  cur, .          
 0001b430: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001b440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b460: 2020 2020 2020 706d 616a 203d 206b 6e6e        pmaj = knn
-0001b470: 5f70 6d61 6a2c 206e 6c6f 675f 7076 616c  _pmaj, nlog_pval
-0001b480: 5f74 6820 3d20 2d6e 702e 6c6f 6731 3028  _th = -np.log10(
-0001b490: 7076 616c 5f74 6829 2920 2020 2020 2020  pval_th))       
-0001b4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b4b0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0001b4c0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001b450: 2020 2020 2020 2020 2020 2020 2070 6d61               pma
+0001b460: 6a20 3d20 6b6e 6e5f 706d 616a 2c20 6e6c  j = knn_pmaj, nl
+0001b470: 6f67 5f70 7661 6c5f 7468 203d 202d 6e70  og_pval_th = -np
+0001b480: 2e6c 6f67 3130 2870 7661 6c5f 7468 2929  .log10(pval_th))
+0001b490: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0001b4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b4b0: 2020 2020 656c 6966 206b 6e6e 5f74 7970      elif knn_typ
+0001b4c0: 6520 3d3d 2031 3a0a 2020 2020 2020 2020  e == 1:.        
 0001b4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b4e0: 2020 2079 5f70 7265 645f 6375 722c 2073     y_pred_cur, s
-0001b4f0: 636f 7265 5f75 7020 3d20 6170 706c 795f  core_up = apply_
-0001b500: 6b6e 6e32 286e 6569 5f69 6e64 6963 6573  knn2(nei_indices
-0001b510: 2c20 795f 7072 6564 5f63 7572 2c20 6466  , y_pred_cur, df
-0001b520: 5f47 5341 5f73 636f 7265 5f63 7572 2c20  _GSA_score_cur, 
-0001b530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b4e0: 2020 2020 2020 2020 795f 7072 6564 5f63          y_pred_c
+0001b4f0: 7572 2c20 7363 6f72 655f 7570 203d 2061  ur, score_up = a
+0001b500: 7070 6c79 5f6b 6e6e 3128 6e65 695f 696e  pply_knn1(nei_in
+0001b510: 6469 6365 732c 2079 5f70 7265 645f 6375  dices, y_pred_cu
+0001b520: 722c 2064 665f 4753 415f 7363 6f72 655f  r, df_GSA_score_
+0001b530: 6375 722c 200a 2020 2020 2020 2020 2020  cur, .          
 0001b540: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001b550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b560: 2020 2020 2020 2020 2070 6d61 6a20 3d20           pmaj = 
-0001b570: 6b6e 6e5f 706d 616a 2c20 6e6c 6f67 5f70  knn_pmaj, nlog_p
-0001b580: 7661 6c5f 7468 203d 202d 6e70 2e6c 6f67  val_th = -np.log
-0001b590: 3130 2870 7661 6c5f 7468 2929 200a 2020  10(pval_th)) .  
-0001b5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b5b0: 2020 2020 2020 2020 2020 2323 2073 636f            ## sco
-0001b5c0: 7265 5f75 7020 6e6f 7420 776f 726b 696e  re_up not workin
-0001b5d0: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
-0001b5e0: 2020 2020 2020 2020 2020 2020 2020 2323                ##
-0001b5f0: 2064 665f 4753 415f 7363 6f72 655f 6375   df_GSA_score_cu
-0001b600: 7220 3d20 7363 6f72 655f 7570 0a0a 2020  r = score_up..  
-0001b610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b620: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-0001b630: 3a20 7072 696e 7428 2764 6f6e 652e 2028  : print('done. (
-0001b640: 2569 2920 2720 2520 2872 6f75 6e64 2874  %i) ' % (round(t
-0001b650: 696d 652e 7469 6d65 2829 202d 2073 7461  ime.time() - sta
-0001b660: 7274 5f74 696d 6529 2929 0a0a 0a20 2020  rt_time)))...   
-0001b670: 2020 2020 2020 2020 2020 2020 2069 6478               idx
-0001b680: 203d 2069 6478 5f73 656c 5b62 5f63 7572   = idx_sel[b_cur
-0001b690: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0001b6a0: 2020 6466 5f70 7265 642e 6c6f 635b 6964    df_pred.loc[id
-0001b6b0: 782c 2763 656c 6c5f 7479 7065 5f6d 696e  x,'cell_type_min
-0001b6c0: 6f72 275d 203d 2079 5f70 7265 645f 6375  or'] = y_pred_cu
-0001b6d0: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-0001b6e0: 2020 795f 7072 6564 5f73 656c 5b62 5f63    y_pred_sel[b_c
-0001b6f0: 7572 5d20 3d20 795f 7072 6564 5f63 7572  ur] = y_pred_cur
-0001b700: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001b710: 2020 6466 5f70 7265 642e 6c6f 635b 6964    df_pred.loc[id
-0001b720: 782c 2027 6365 6c6c 5f74 7970 655f 6d69  x, 'cell_type_mi
-0001b730: 6e6f 7228 3173 7429 275d 203d 2064 665f  nor(1st)'] = df_
-0001b740: 7265 735f 6375 725b 2763 656c 6c5f 7479  res_cur['cell_ty
-0001b750: 7065 2831 7374 2927 5d2e 6173 7479 7065  pe(1st)'].astype
-0001b760: 2873 7472 290a 2020 2020 2020 2020 2020  (str).          
-0001b770: 2020 2020 2020 6466 5f70 7265 642e 6c6f        df_pred.lo
-0001b780: 635b 6964 782c 2027 436f 6e66 6964 656e  c[idx, 'Confiden
-0001b790: 6365 5f6d 696e 6f72 2831 7374 2927 5d20  ce_minor(1st)'] 
-0001b7a0: 3d20 6466 5f72 6573 5f63 7572 5b27 2d6c  = df_res_cur['-l
-0001b7b0: 6f67 5027 5d2e 6173 7479 7065 2866 6c6f  ogP'].astype(flo
-0001b7c0: 6174 290a 2020 2020 2020 2020 2020 2020  at).            
-0001b7d0: 2020 2020 6466 5f70 7265 642e 6c6f 635b      df_pred.loc[
-0001b7e0: 6964 782c 2027 6365 6c6c 5f74 7970 655f  idx, 'cell_type_
-0001b7f0: 6d69 6e6f 7228 326e 6429 275d 203d 2064  minor(2nd)'] = d
-0001b800: 665f 7265 735f 6375 725b 2763 656c 6c5f  f_res_cur['cell_
-0001b810: 7479 7065 2832 6e64 2927 5d2e 6173 7479  type(2nd)'].asty
-0001b820: 7065 2873 7472 290a 2020 2020 2020 2020  pe(str).        
-0001b830: 2020 2020 2020 2020 6466 5f70 7265 642e          df_pred.
-0001b840: 6c6f 635b 6964 782c 2027 436f 6e66 6964  loc[idx, 'Confid
-0001b850: 656e 6365 5f6d 696e 6f72 2832 6e64 2927  ence_minor(2nd)'
-0001b860: 5d20 3d20 6466 5f72 6573 5f63 7572 5b27  ] = df_res_cur['
-0001b870: 2d6c 6f67 5028 326e 6429 275d 2e61 7374  -logP(2nd)'].ast
-0001b880: 7970 6528 666c 6f61 7429 0a0a 2020 2020  ype(float)..    
-0001b890: 2020 2020 2020 2020 2020 2020 6466 5f70              df_p
-0001b8a0: 7265 6432 2e6c 6f63 5b69 6478 2c27 636c  red2.loc[idx,'cl
-0001b8b0: 7573 7465 725f 7265 7627 5d20 3d20 795f  uster_rev'] = y_
-0001b8c0: 636c 7573 745f 6375 7220 2b20 310a 2020  clust_cur + 1.  
-0001b8d0: 2020 2020 2020 2020 2020 2020 2020 6466                df
-0001b8e0: 5f70 7265 6432 2e6c 6f63 5b69 6478 2c27  _pred2.loc[idx,'
-0001b8f0: 636c 7573 7465 725f 7265 7627 5d20 3d20  cluster_rev'] = 
-0001b900: 6466 5f70 7265 6432 2e6c 6f63 5b69 6478  df_pred2.loc[idx
-0001b910: 2c27 636c 7573 7465 725f 7265 7627 5d2e  ,'cluster_rev'].
-0001b920: 6173 7479 7065 2873 7472 290a 2020 2020  astype(str).    
-0001b930: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-0001b940: 2020 2020 2020 2020 2020 2020 2023 2320               ## 
-0001b950: 546f 2062 6520 7573 6564 2069 6e20 7375  To be used in su
-0001b960: 6273 6574 2069 6465 6e74 6966 6963 6174  bset identificat
-0001b970: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
-0001b980: 2020 2020 6966 2064 665f 4753 415f 7363      if df_GSA_sc
-0001b990: 6f72 655f 6375 7220 6973 206e 6f74 204e  ore_cur is not N
-0001b9a0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001b9b0: 2020 2020 2020 2020 2063 6f6c 7320 3d20           cols = 
-0001b9c0: 6466 5f47 5341 5f73 636f 7265 5f63 7572  df_GSA_score_cur
-0001b9d0: 2e63 6f6c 756d 6e73 2e76 616c 7565 730a  .columns.values.
-0001b9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b9f0: 2020 2020 6964 7873 203d 2064 665f 4753      idxs = df_GS
-0001ba00: 415f 7363 6f72 655f 6375 722e 696e 6465  A_score_cur.inde
-0001ba10: 782e 7661 6c75 6573 0a20 2020 2020 2020  x.values.       
-0001ba20: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-0001ba30: 4753 415f 7363 6f72 655f 6d69 6e6f 725f  GSA_score_minor_
-0001ba40: 616c 6c5b 636f 6c73 5d20 3d20 300a 2020  all[cols] = 0.  
-0001ba50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ba60: 2020 6466 5f47 5341 5f73 636f 7265 5f6d    df_GSA_score_m
-0001ba70: 696e 6f72 5f61 6c6c 2e6c 6f63 5b69 6478  inor_all.loc[idx
-0001ba80: 732c 2063 6f6c 735d 203d 2064 665f 4753  s, cols] = df_GS
-0001ba90: 415f 7363 6f72 655f 6375 720a 0a20 2020  A_score_cur..   
-0001baa0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001bab0: 6466 5f72 6573 5f63 7572 2e73 6861 7065  df_res_cur.shape
-0001bac0: 5b30 5d20 3e20 303a 0a20 2020 2020 2020  [0] > 0:.       
-0001bad0: 2020 2020 2020 2020 2020 2020 2064 6963               dic
-0001bae0: 745f 7375 6d6d 6172 795f 7265 735b 7463  t_summary_res[tc
-0001baf0: 202b 2027 206d 696e 6f72 2074 7970 6527   + ' minor type'
-0001bb00: 5d20 3d20 6466 5f72 6573 5f63 7572 0a20  ] = df_res_cur. 
-0001bb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb20: 2020 2064 6963 745f 7375 6d6d 6172 795f     dict_summary_
-0001bb30: 7363 6f72 655b 7463 202b 2027 206d 696e  score[tc + ' min
-0001bb40: 6f72 2074 7970 6527 5d20 3d20 6466 5f73  or type'] = df_s
-0001bb50: 636f 7265 5f63 7572 0a20 2020 2020 2020  core_cur.       
-0001bb60: 2020 2020 2020 2020 2020 2020 2064 6963               dic
-0001bb70: 745f 7375 6d6d 6172 795f 7363 6f72 6532  t_summary_score2
-0001bb80: 5b74 6320 2b20 2720 6d69 6e6f 7220 7479  [tc + ' minor ty
-0001bb90: 7065 275d 203d 2064 665f 4753 415f 7363  pe'] = df_GSA_sc
-0001bba0: 6f72 655f 6375 720a 0a20 2020 2020 2020  ore_cur..       
-0001bbb0: 2020 2020 2020 2020 2069 6620 636e 7420           if cnt 
-0001bbc0: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-0001bbd0: 2020 2020 2020 2020 2020 6466 5f72 6573            df_res
-0001bbe0: 5f73 656c 203d 2064 665f 7265 735f 6375  _sel = df_res_cu
-0001bbf0: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-0001bc00: 2020 2020 2020 2320 6966 2064 665f 7363        # if df_sc
-0001bc10: 6f72 655f 6375 7220 6973 206e 6f74 204e  ore_cur is not N
-0001bc20: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001bc30: 2020 2020 2020 2020 2064 665f 7363 6f72           df_scor
-0001bc40: 655f 7365 6c20 3d20 6466 5f73 636f 7265  e_sel = df_score
-0001bc50: 5f63 7572 0a20 2020 2020 2020 2020 2020  _cur.           
-0001bc60: 2020 2020 2020 2020 2064 665f 4753 415f           df_GSA_
-0001bc70: 7363 6f72 655f 7365 6c20 3d20 6466 5f47  score_sel = df_G
-0001bc80: 5341 5f73 636f 7265 5f63 7572 0a20 2020  SA_score_cur.   
-0001bc90: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0001bca0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001bcb0: 2020 2020 2020 2064 665f 7265 735f 7365         df_res_se
-0001bcc0: 6c20 3d20 7064 2e63 6f6e 6361 7428 5b64  l = pd.concat([d
-0001bcd0: 665f 7265 735f 7365 6c2c 2064 665f 7265  f_res_sel, df_re
-0001bce0: 735f 6375 725d 2c20 6178 6973 203d 2030  s_cur], axis = 0
-0001bcf0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001bd00: 2020 2020 2020 6966 2028 6466 5f73 636f        if (df_sco
-0001bd10: 7265 5f63 7572 2069 7320 6e6f 7420 4e6f  re_cur is not No
-0001bd20: 6e65 2920 2620 2864 665f 7363 6f72 655f  ne) & (df_score_
-0001bd30: 7365 6c20 6973 206e 6f74 204e 6f6e 6529  sel is not None)
-0001bd40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001bd50: 2020 2020 2020 2020 2020 6466 5f73 636f            df_sco
-0001bd60: 7265 5f73 656c 203d 2070 642e 636f 6e63  re_sel = pd.conc
-0001bd70: 6174 285b 6466 5f73 636f 7265 5f73 656c  at([df_score_sel
-0001bd80: 2c20 6466 5f73 636f 7265 5f63 7572 5d2c  , df_score_cur],
-0001bd90: 2061 7869 7320 3d20 3029 0a20 2020 2020   axis = 0).     
-0001bda0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0001bdb0: 665f 4753 415f 7363 6f72 655f 7365 6c20  f_GSA_score_sel 
-0001bdc0: 3d20 7064 2e63 6f6e 6361 7428 5b64 665f  = pd.concat([df_
-0001bdd0: 4753 415f 7363 6f72 655f 7365 6c2c 2064  GSA_score_sel, d
-0001bde0: 665f 4753 415f 7363 6f72 655f 6375 725d  f_GSA_score_cur]
-0001bdf0: 2c20 6178 6973 203d 2030 290a 2020 2020  , axis = 0).    
-0001be00: 2020 2020 2020 2020 2020 2020 636e 7420              cnt 
-0001be10: 2b3d 2031 0a0a 2020 2020 2020 2020 2020  += 1..          
-0001be20: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-0001be30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001be40: 2020 2020 2020 7072 696e 7428 2725 7320        print('%s 
-0001be50: 6d69 6e6f 7220 7479 7065 2069 6465 6e74  minor type ident
-0001be60: 6966 6963 6174 696f 6e20 646f 6e65 2e20  ification done. 
-0001be70: 2825 6929 2720 2520 5c0a 2020 2020 2020  (%i)' % \.      
-0001be80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001be90: 2020 2020 2874 632c 2072 6f75 6e64 2874      (tc, round(t
-0001bea0: 696d 652e 7469 6d65 2829 202d 2073 7461  ime.time() - sta
-0001beb0: 7274 5f74 696d 6529 2929 0a20 2020 2020  rt_time))).     
-0001bec0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001bed0: 2070 6c6f 745f 726f 635f 7265 7375 6c74   plot_roc_result
-0001bee0: 2864 665f 7363 6f72 655f 7365 6c2c 2079  (df_score_sel, y
-0001bef0: 735f 7365 6c2c 206d 6574 686f 6429 0a20  s_sel, method). 
-0001bf00: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0001bf10: 6c73 653a 2070 7269 6e74 2827 2e27 2c20  lse: print('.', 
-0001bf20: 656e 6420 3d20 2727 2c20 666c 7573 6820  end = '', flush 
-0001bf30: 3d20 5472 7565 290a 0a20 2020 2020 2020  = True)..       
-0001bf40: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
-0001bf50: 2063 6e74 203e 2030 3a0a 2020 2020 2020   cnt > 0:.      
-0001bf60: 2020 2020 2020 6966 206e 702e 7375 6d28        if np.sum(
-0001bf70: 625f 7365 6c29 203c 2064 665f 7265 735f  b_sel) < df_res_
-0001bf80: 7365 6c2e 7368 6170 655b 305d 3a0a 2020  sel.shape[0]:.  
-0001bf90: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0001bfa0: 696e 7428 2757 4152 4e49 4e47 3a20 2569  int('WARNING: %i
-0001bfb0: 203c 2025 692e 204f 6e65 206f 7220 6d6f   < %i. One or mo
-0001bfc0: 7265 2063 6c75 7374 6572 2873 2920 6973  re cluster(s) is
-0001bfd0: 206d 6978 6564 2e27 2025 205c 0a20 2020   mixed.' % \.   
-0001bfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bff0: 2020 2028 6e70 2e73 756d 2862 5f73 656c     (np.sum(b_sel
-0001c000: 292c 2064 665f 7265 735f 7365 6c2e 7368  ), df_res_sel.sh
-0001c010: 6170 655b 305d 2929 0a20 2020 2020 2020  ape[0])).       
-0001c020: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
-0001c030: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-0001c040: 2573 2074 7970 6520 6964 656e 7469 6669  %s type identifi
-0001c050: 6361 7469 6f6e 2064 6f6e 652e 2028 2569  cation done. (%i
-0001c060: 2927 2025 2028 7463 2c20 726f 756e 6428  )' % (tc, round(
-0001c070: 7469 6d65 2e74 696d 6528 2920 2d20 7374  time.time() - st
-0001c080: 6172 745f 7469 6d65 2929 290a 2020 2020  art_time))).    
-0001c090: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001c0a0: 2020 2020 2020 6574 696d 6520 3d20 726f        etime = ro
-0001c0b0: 756e 6428 7469 6d65 2e74 696d 6528 2920  und(time.time() 
-0001c0c0: 2d20 7374 6172 745f 7469 6d65 5f6e 6577  - start_time_new
-0001c0d0: 2920 2020 2020 2020 200a 2020 2020 2020  )        .      
-0001c0e0: 2020 2020 2020 7374 6172 745f 7469 6d65        start_time
-0001c0f0: 5f6e 6577 203d 2074 696d 652e 7469 6d65  _new = time.time
-0001c100: 2829 0a20 2020 2020 2020 2020 2020 2070  ().            p
-0001c110: 7269 6e74 2827 4d25 692e 2720 2520 6574  rint('M%i.' % et
-0001c120: 696d 652c 2065 6e64 203d 2027 272c 2066  ime, end = '', f
-0001c130: 6c75 7368 203d 2054 7275 6529 0a20 2020  lush = True).   
-0001c140: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
-0001c150: 2827 2e27 2c20 656e 6420 3d20 2727 2c20  ('.', end = '', 
-0001c160: 666c 7573 6820 3d20 5472 7565 290a 2020  flush = True).  
-0001c170: 2020 2020 2020 2020 2020 2320 706c 6f74            # plot
-0001c180: 5f72 6f63 5f72 6573 756c 7428 6466 5f73  _roc_result(df_s
-0001c190: 636f 7265 5f73 656c 2c20 7973 5f73 656c  core_sel, ys_sel
-0001c1a0: 2c20 6d65 7468 6f64 290a 2020 2020 2020  , method).      
-0001c1b0: 2020 2327 2727 0a0a 2020 2020 2020 2020    #'''..        
-0001c1c0: 6466 5f70 7265 642e 6c6f 635b 625f 7365  df_pred.loc[b_se
-0001c1d0: 6c2c 2027 6365 6c6c 5f74 7970 655f 6d69  l, 'cell_type_mi
-0001c1e0: 6e6f 7227 5d20 3d20 795f 7072 6564 5f73  nor'] = y_pred_s
-0001c1f0: 656c 0a20 2020 2020 2020 200a 2020 2020  el.        .    
-0001c200: 2020 2020 2320 6469 6374 5f73 756d 6d61      # dict_summa
-0001c210: 7279 5f72 6573 5b27 4d69 6e6f 725f 5479  ry_res['Minor_Ty
-0001c220: 7065 275d 203d 2064 665f 7265 735f 7365  pe'] = df_res_se
-0001c230: 6c0a 2020 2020 2020 2020 2320 6469 6374  l.        # dict
-0001c240: 5f73 756d 6d61 7279 5f73 636f 7265 5b27  _summary_score['
-0001c250: 4d69 6e6f 725f 5479 7065 275d 203d 2064  Minor_Type'] = d
-0001c260: 665f 7363 6f72 655f 7365 6c0a 2020 2020  f_score_sel.    
-0001c270: 2020 2020 2320 6469 6374 5f73 756d 6d61      # dict_summa
-0001c280: 7279 5f73 636f 7265 325b 274d 696e 6f72  ry_score2['Minor
-0001c290: 5f54 7970 6527 5d20 3d20 6466 5f47 5341  _Type'] = df_GSA
-0001c2a0: 5f73 636f 7265 5f73 656c 0a20 2020 2020  _score_sel.     
-0001c2b0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0001c2c0: 625f 6375 7220 3d20 795f 7072 6564 5f73  b_cur = y_pred_s
-0001c2d0: 656c 203d 3d20 2775 6e61 7373 6967 6e65  el == 'unassigne
-0001c2e0: 6427 0a20 2020 2020 2020 2069 6620 7665  d'.        if ve
-0001c2f0: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
-0001c300: 2020 2070 7269 6e74 2827 4e75 6d20 6f66     print('Num of
-0001c310: 2075 6e61 7373 6967 6e65 6420 6365 6c6c   unassigned cell
-0001c320: 733a 2025 6920 616d 6f6e 6720 2569 2720  s: %i among %i' 
-0001c330: 2520 286e 702e 7375 6d28 625f 6375 7229  % (np.sum(b_cur)
-0001c340: 2c20 6c65 6e28 625f 6375 7229 2929 0a0a  , len(b_cur)))..
-0001c350: 2020 2020 2020 2020 2323 206d 616b 6520          ## make 
-0001c360: 636f 7272 6563 7469 6f6e 2069 6620 6d61  correction if ma
-0001c370: 6a6f 7220 7479 7065 2061 6e64 206d 696e  jor type and min
-0001c380: 6f72 2074 7970 6520 646f 6573 206e 6f74  or type does not
-0001c390: 206d 6174 6368 0a20 2020 2020 2020 2063   match.        c
-0001c3a0: 656c 6c5f 7479 7065 5f6d 6170 5f64 6963  ell_type_map_dic
-0001c3b0: 7420 3d20 7b7d 0a20 2020 2020 2020 2066  t = {}.        f
-0001c3c0: 6f72 2074 6320 696e 2074 6172 6765 745f  or tc in target_
-0001c3d0: 6365 6c6c 5f6c 7374 2e6b 6579 7328 293a  cell_lst.keys():
-0001c3e0: 0a20 2020 2020 2020 2020 2020 2074 635f  .            tc_
-0001c3f0: 6c73 7420 3d20 7461 7267 6574 5f63 656c  lst = target_cel
-0001c400: 6c5f 6c73 745b 7463 5d0a 2020 2020 2020  l_lst[tc].      
-0001c410: 2020 2020 2020 6d6b 725f 6c73 742c 206d        mkr_lst, m
-0001c420: 6b72 5f6c 7374 5f6e 6567 203d 2067 6574  kr_lst_neg = get
-0001c430: 5f6d 6172 6b65 7273 5f63 656c 6c5f 7479  _markers_cell_ty
-0001c440: 7065 286d 6172 6b65 725f 6669 6c65 2c20  pe(marker_file, 
-0001c450: 7463 5f6c 7374 2c20 706e 7368 3132 203d  tc_lst, pnsh12 =
-0001c460: 206d 6b72 5f73 656c 6563 746f 722c 200a   mkr_selector, .
-0001c470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c490: 2020 2020 2020 2020 2020 2020 7265 6d5f              rem_
-0001c4a0: 636f 6d6d 6f6e 203d 2072 656d 5f63 6d6e  common = rem_cmn
-0001c4b0: 5f6d 6b72 2c20 7665 7262 6f73 6520 3d20  _mkr, verbose = 
-0001c4c0: 4661 6c73 6529 0a0a 2020 2020 2020 2020  False)..        
-0001c4d0: 2020 2020 6365 6c6c 5f74 7970 655f 6c73      cell_type_ls
-0001c4e0: 7420 3d20 6c69 7374 286d 6b72 5f6c 7374  t = list(mkr_lst
-0001c4f0: 2e6b 6579 7328 2929 0a20 2020 2020 2020  .keys()).       
-0001c500: 2020 2020 2063 656c 6c5f 7479 7065 5f6d       cell_type_m
-0001c510: 6170 5f64 6963 745b 7463 5d20 3d20 6365  ap_dict[tc] = ce
-0001c520: 6c6c 5f74 7970 655f 6c73 740a 0a20 2020  ll_type_lst..   
-0001c530: 2020 2020 2023 2727 270a 2020 2020 2020       #'''.      
-0001c540: 2020 6d61 705f 6469 6374 203d 207b 7d0a    map_dict = {}.
-0001c550: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
-0001c560: 696e 206c 6973 7428 6365 6c6c 5f74 7970  in list(cell_typ
-0001c570: 655f 6d61 705f 6469 6374 2e6b 6579 7328  e_map_dict.keys(
-0001c580: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-0001c590: 666f 7220 6320 696e 2063 656c 6c5f 7479  for c in cell_ty
-0001c5a0: 7065 5f6d 6170 5f64 6963 745b 6b65 795d  pe_map_dict[key]
-0001c5b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001c5c0: 2020 6d61 705f 6469 6374 5b63 5d20 3d20    map_dict[c] = 
-0001c5d0: 6b65 790a 2020 2020 2020 2020 6365 6c6c  key.        cell
-0001c5e0: 5f74 7970 6573 203d 206c 6973 7428 6d61  _types = list(ma
-0001c5f0: 705f 6469 6374 2e6b 6579 7328 2929 0a0a  p_dict.keys())..
-0001c600: 2020 2020 2020 2020 795f 7072 6564 5f6d          y_pred_m
-0001c610: 616a 6f72 203d 206c 6973 7428 6466 5f70  ajor = list(df_p
-0001c620: 7265 645b 2763 656c 6c5f 7479 7065 5f6d  red['cell_type_m
-0001c630: 616a 6f72 275d 290a 2020 2020 2020 2020  ajor']).        
-0001c640: 795f 7072 6564 5f6d 696e 6f72 203d 206c  y_pred_minor = l
-0001c650: 6973 7428 6466 5f70 7265 645b 2763 656c  ist(df_pred['cel
-0001c660: 6c5f 7479 7065 5f6d 696e 6f72 275d 290a  l_type_minor']).
-0001c670: 0a20 2020 2020 2020 2079 5f70 7265 645f  .        y_pred_
-0001c680: 6d61 6a6f 725f 6e65 7720 3d20 5b5d 0a20  major_new = []. 
-0001c690: 2020 2020 2020 2079 5f70 7265 645f 6d69         y_pred_mi
-0001c6a0: 6e6f 725f 6e65 7720 3d20 5b5d 0a20 2020  nor_new = [].   
-0001c6b0: 2020 2020 2066 6f72 2079 6a2c 2079 6d20       for yj, ym 
-0001c6c0: 696e 207a 6970 2879 5f70 7265 645f 6d61  in zip(y_pred_ma
-0001c6d0: 6a6f 722c 2079 5f70 7265 645f 6d69 6e6f  jor, y_pred_mino
-0001c6e0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0001c6f0: 6966 2079 6d20 696e 2063 656c 6c5f 7479  if ym in cell_ty
-0001c700: 7065 733a 0a20 2020 2020 2020 2020 2020  pes:.           
-0001c710: 2020 2020 2069 6620 6d61 705f 6469 6374       if map_dict
-0001c720: 5b79 6d5d 203d 3d20 796a 3a0a 2020 2020  [ym] == yj:.    
-0001c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c740: 795f 7072 6564 5f6d 616a 6f72 5f6e 6577  y_pred_major_new
-0001c750: 2e61 7070 656e 6428 796a 290a 2020 2020  .append(yj).    
-0001c760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c770: 795f 7072 6564 5f6d 696e 6f72 5f6e 6577  y_pred_minor_new
-0001c780: 2e61 7070 656e 6428 796d 290a 2020 2020  .append(ym).    
-0001c790: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0001c7a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001c7b0: 2020 2020 2020 795f 7072 6564 5f6d 616a        y_pred_maj
-0001c7c0: 6f72 5f6e 6577 2e61 7070 656e 6428 6d61  or_new.append(ma
-0001c7d0: 705f 6469 6374 5b79 6d5d 290a 2020 2020  p_dict[ym]).    
-0001c7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c7f0: 795f 7072 6564 5f6d 696e 6f72 5f6e 6577  y_pred_minor_new
-0001c800: 2e61 7070 656e 6428 796d 290a 2020 2020  .append(ym).    
-0001c810: 2020 2020 2020 2020 656c 7365 3a20 2320          else: # 
-0001c820: 2775 6e61 7373 6967 6e65 6427 0a20 2020  'unassigned'.   
-0001c830: 2020 2020 2020 2020 2020 2020 2079 5f70               y_p
-0001c840: 7265 645f 6d61 6a6f 725f 6e65 772e 6170  red_major_new.ap
-0001c850: 7065 6e64 2879 6a29 2023 2775 6e61 7373  pend(yj) #'unass
-0001c860: 6967 6e65 6427 290a 2020 2020 2020 2020  igned').        
-0001c870: 2020 2020 2020 2020 795f 7072 6564 5f6d          y_pred_m
-0001c880: 696e 6f72 5f6e 6577 2e61 7070 656e 6428  inor_new.append(
-0001c890: 2775 6e61 7373 6967 6e65 6427 290a 0a20  'unassigned').. 
-0001c8a0: 2020 2020 2020 2064 665f 7072 6564 5b27         df_pred['
-0001c8b0: 6365 6c6c 5f74 7970 655f 6d61 6a6f 7227  cell_type_major'
-0001c8c0: 5d20 3d20 795f 7072 6564 5f6d 616a 6f72  ] = y_pred_major
-0001c8d0: 5f6e 6577 0a20 2020 2020 2020 2064 665f  _new.        df_
-0001c8e0: 7072 6564 5b27 6365 6c6c 5f74 7970 655f  pred['cell_type_
-0001c8f0: 6d69 6e6f 7227 5d20 3d20 795f 7072 6564  minor'] = y_pred
-0001c900: 5f6d 696e 6f72 5f6e 6577 0a20 2020 2020  _minor_new.     
-0001c910: 2020 2023 2727 270a 0a20 2020 2020 2020     #'''..       
-0001c920: 2079 5f70 7265 645f 6d61 6a6f 7220 3d20   y_pred_major = 
-0001c930: 6c69 7374 2864 665f 7072 6564 5b27 6365  list(df_pred['ce
-0001c940: 6c6c 5f74 7970 655f 6d61 6a6f 7227 5d29  ll_type_major'])
-0001c950: 0a20 2020 2020 2020 2079 5f70 7265 645f  .        y_pred_
-0001c960: 6d69 6e6f 7220 3d20 6c69 7374 2864 665f  minor = list(df_
-0001c970: 7072 6564 5b27 6365 6c6c 5f74 7970 655f  pred['cell_type_
-0001c980: 6d69 6e6f 7227 5d29 0a20 2020 2020 2020  minor']).       
-0001c990: 200a 2020 2020 2323 2323 2323 2323 2323   .    ##########
-0001c9a0: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
-0001c9b0: 2020 2023 2323 2053 7562 7365 7420 6964     ### Subset id
-0001c9c0: 656e 7469 6669 6361 7469 6f6e 2023 2323  entification ###
-0001c9d0: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
-0001c9e0: 2323 2323 2323 2323 2323 2323 230a 0a20  #############.. 
-0001c9f0: 2020 2069 6620 6964 656e 745f 6c65 7665     if ident_leve
-0001ca00: 6c20 3e20 323a 2020 2020 2020 2020 0a0a  l > 2:        ..
-0001ca10: 2020 2020 2020 2020 6466 5f70 7265 645b          df_pred[
-0001ca20: 2763 656c 6c5f 7479 7065 5f73 7562 7365  'cell_type_subse
-0001ca30: 7428 3173 7429 275d 203d 2064 665f 7072  t(1st)'] = df_pr
-0001ca40: 6564 5b27 6365 6c6c 5f74 7970 655f 6d69  ed['cell_type_mi
-0001ca50: 6e6f 7228 3173 7429 275d 0a20 2020 2020  nor(1st)'].     
-0001ca60: 2020 2064 665f 7072 6564 5b27 436f 6e66     df_pred['Conf
-0001ca70: 6964 656e 6365 5f73 7562 7365 7428 3173  idence_subset(1s
-0001ca80: 7429 275d 203d 2064 665f 7072 6564 5b27  t)'] = df_pred['
-0001ca90: 436f 6e66 6964 656e 6365 5f6d 696e 6f72  Confidence_minor
-0001caa0: 2831 7374 2927 5d0a 2020 2020 2020 2020  (1st)'].        
-0001cab0: 6466 5f70 7265 645b 2763 656c 6c5f 7479  df_pred['cell_ty
-0001cac0: 7065 5f73 7562 7365 7428 326e 6429 275d  pe_subset(2nd)']
-0001cad0: 203d 2064 665f 7072 6564 5b27 6365 6c6c   = df_pred['cell
-0001cae0: 5f74 7970 655f 6d69 6e6f 7228 3173 7429  _type_minor(1st)
-0001caf0: 275d 0a20 2020 2020 2020 2064 665f 7072  '].        df_pr
-0001cb00: 6564 5b27 436f 6e66 6964 656e 6365 5f73  ed['Confidence_s
-0001cb10: 7562 7365 7428 326e 6429 275d 203d 2064  ubset(2nd)'] = d
-0001cb20: 665f 7072 6564 5b27 436f 6e66 6964 656e  f_pred['Confiden
-0001cb30: 6365 5f6d 696e 6f72 2831 7374 2927 5d0a  ce_minor(1st)'].
-0001cb40: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0001cb50: 2063 6e74 203d 2030 0a20 2020 2020 2020   cnt = 0.       
-0001cb60: 206d 6170 5f64 6963 745f 7375 6232 6d69   map_dict_sub2mi
-0001cb70: 6e20 3d20 7b7d 0a20 2020 2020 2020 206d  n = {}.        m
-0001cb80: 6170 5f64 6963 745f 6d69 6e32 7375 6220  ap_dict_min2sub 
-0001cb90: 3d20 7b7d 0a20 2020 2020 2020 2066 6f72  = {}.        for
-0001cba0: 2074 6320 696e 2074 6172 6765 745f 6365   tc in target_ce
-0001cbb0: 6c6c 5f6c 7374 2e6b 6579 7328 293a 0a0a  ll_lst.keys():..
-0001cbc0: 2020 2020 2020 2020 2020 2020 2323 2047              ## G
-0001cbd0: 6574 206d 696e 6f72 2074 7970 6520 6d61  et minor type ma
-0001cbe0: 726b 6572 730a 2020 2020 2020 2020 2020  rkers.          
-0001cbf0: 2020 7461 7267 6574 5f63 656c 6c20 3d20    target_cell = 
-0001cc00: 7461 7267 6574 5f63 656c 6c5f 6c73 745b  target_cell_lst[
-0001cc10: 7463 5d0a 2020 2020 2020 2020 2020 2020  tc].            
-0001cc20: 6d6b 725f 6c73 742c 206d 6b72 5f6c 7374  mkr_lst, mkr_lst
-0001cc30: 5f6e 6567 203d 2067 6574 5f6d 6172 6b65  _neg = get_marke
-0001cc40: 7273 5f63 656c 6c5f 7479 7065 286d 6172  rs_cell_type(mar
-0001cc50: 6b65 725f 6669 6c65 2c20 7461 7267 6574  ker_file, target
-0001cc60: 5f63 656c 6c2c 200a 2020 2020 2020 2020  _cell, .        
-0001cc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc90: 2020 2020 706e 7368 3132 203d 206d 6b72      pnsh12 = mkr
-0001cca0: 5f73 656c 6563 746f 722c 2072 656d 5f63  _selector, rem_c
-0001ccb0: 6f6d 6d6f 6e20 3d20 7265 6d5f 636d 6e5f  ommon = rem_cmn_
-0001ccc0: 6d6b 722c 0a20 2020 2020 2020 2020 2020  mkr,.           
-0001ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ccf0: 2020 2020 2020 2020 2020 2020 2020 7665                ve
-0001cd00: 7262 6f73 6520 3d20 4661 6c73 6529 0a20  rbose = False). 
-0001cd10: 2020 2020 2020 2020 2020 2020 2020 200a                 .
-0001cd20: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-0001cd30: 656e 286d 696e 6f72 5f74 7970 6573 5f74  en(minor_types_t
-0001cd40: 6f5f 6578 636c 7564 6529 203e 2030 3a0a  o_exclude) > 0:.
-0001cd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd60: 6d6b 725f 6c73 7420 3d20 7265 6d5f 6d69  mkr_lst = rem_mi
-0001cd70: 6e6f 7228 206d 6b72 5f6c 7374 2c20 6d69  nor( mkr_lst, mi
-0001cd80: 6e6f 725f 7479 7065 735f 746f 5f65 7863  nor_types_to_exc
-0001cd90: 6c75 6465 2029 0a20 2020 2020 2020 2020  lude ).         
-0001cda0: 2020 2020 2020 206d 6b72 5f6c 7374 5f6e         mkr_lst_n
-0001cdb0: 6567 203d 2072 656d 5f6d 696e 6f72 2820  eg = rem_minor( 
-0001cdc0: 6d6b 725f 6c73 745f 6e65 672c 206d 696e  mkr_lst_neg, min
-0001cdd0: 6f72 5f74 7970 6573 5f74 6f5f 6578 636c  or_types_to_excl
-0001cde0: 7564 6520 290a 0a20 2020 2020 2020 2020  ude )..         
-0001cdf0: 2020 2063 656c 6c5f 7479 7065 5f6c 7374     cell_type_lst
-0001ce00: 203d 206c 6973 7428 6d6b 725f 6c73 742e   = list(mkr_lst.
-0001ce10: 6b65 7973 2829 290a 2020 2020 2020 2020  keys()).        
-0001ce20: 2020 2020 625f 6375 7220 3d20 6e70 2e66      b_cur = np.f
-0001ce30: 756c 6c28 6c65 6e28 795f 7072 6564 5f73  ull(len(y_pred_s
-0001ce40: 656c 292c 2046 616c 7365 290a 2020 2020  el), False).    
-0001ce50: 2020 2020 2020 2020 666f 7220 6320 696e          for c in
-0001ce60: 2063 656c 6c5f 7479 7065 5f6c 7374 3a0a   cell_type_lst:.
-0001ce70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ce80: 625f 6375 7220 3d20 625f 6375 7220 7c20  b_cur = b_cur | 
-0001ce90: 2879 5f70 7265 645f 7365 6c20 3d3d 2063  (y_pred_sel == c
-0001cea0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001ceb0: 2020 0a20 2020 2020 2020 2020 2020 2023    .            #
-0001cec0: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
-0001ced0: 2323 2320 546f 2062 6520 7573 6564 2074  ### To be used t
-0001cee0: 6f20 6465 7465 726d 696e 6520 6d69 6e6f  o determine mino
-0001cef0: 7220 7479 7065 2066 6f72 2067 6976 656e  r type for given
-0001cf00: 2073 7562 7365 740a 2020 2020 2020 2020   subset.        
-0001cf10: 2020 2020 666f 7220 6320 696e 2063 656c      for c in cel
-0001cf20: 6c5f 7479 7065 5f6c 7374 3a20 2320 666f  l_type_lst: # fo
-0001cf30: 7220 6561 6368 206d 696e 6f72 2074 7970  r each minor typ
-0001cf40: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0001cf50: 2020 6d6b 725f 6c73 745f 746d 702c 206d    mkr_lst_tmp, m
-0001cf60: 6b72 5f6c 7374 5f6e 6567 5f74 6d70 203d  kr_lst_neg_tmp =
-0001cf70: 2067 6574 5f6d 6172 6b65 7273 5f6d 696e   get_markers_min
-0001cf80: 6f72 5f74 7970 6532 286d 6172 6b65 725f  or_type2(marker_
-0001cf90: 6669 6c65 2c20 5b63 5d2c 200a 2020 2020  file, [c], .    
-0001cfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cfc0: 2020 2020 706e 7368 3132 203d 206d 6b72      pnsh12 = mkr
-0001cfd0: 5f73 656c 6563 746f 722c 2072 656d 5f63  _selector, rem_c
-0001cfe0: 6f6d 6d6f 6e20 3d20 7265 6d5f 636d 6e5f  ommon = rem_cmn_
-0001cff0: 6d6b 722c 0a20 2020 2020 2020 2020 2020  mkr,.           
-0001d000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d010: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
-0001d020: 625f 6d6b 7273 203d 2063 6f6d 625f 6d6b  b_mkrs = comb_mk
-0001d030: 7273 2c20 7665 7262 6f73 6520 3d20 4661  rs, verbose = Fa
-0001d040: 6c73 6529 0a20 2020 2020 2020 2020 2020  lse).           
-0001d050: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-0001d060: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
-0001d070: 206d 6b72 5f6c 7374 5f74 6d70 2e6b 6579   mkr_lst_tmp.key
-0001d080: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0001d090: 2020 2020 2020 2020 206d 6170 5f64 6963           map_dic
-0001d0a0: 745f 7375 6232 6d69 6e5b 6b65 795d 203d  t_sub2min[key] =
-0001d0b0: 2063 0a20 2020 2020 2020 2020 2020 2020   c.             
-0001d0c0: 2020 206d 6170 5f64 6963 745f 6d69 6e32     map_dict_min2
-0001d0d0: 7375 625b 635d 203d 206c 6973 7428 6d6b  sub[c] = list(mk
-0001d0e0: 725f 6c73 745f 746d 702e 6b65 7973 2829  r_lst_tmp.keys()
-0001d0f0: 290a 2020 2020 2020 2020 2020 2020 2327  ).            #'
-0001d100: 2727 0a20 2020 2020 2020 200a 2020 2020  ''.        .    
-0001d110: 2020 2020 2020 2020 6966 2075 7365 5f6d          if use_m
-0001d120: 696e 6f72 3a0a 2020 2020 2020 2020 2020  inor:.          
-0001d130: 2020 2020 2020 6c73 7420 3d20 5b5d 0a20        lst = []. 
-0001d140: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001d150: 6f72 2063 2069 6e20 6365 6c6c 5f74 7970  or c in cell_typ
-0001d160: 655f 6c73 743a 0a20 2020 2020 2020 2020  e_lst:.         
-0001d170: 2020 2020 2020 2020 2020 206c 7374 2e61             lst.a
-0001d180: 7070 656e 6428 205b 635d 2029 0a20 2020  ppend( [c] ).   
-0001d190: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0001d1a0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0001d1b0: 7374 203d 205b 6365 6c6c 5f74 7970 655f  st = [cell_type_
-0001d1c0: 6c73 745d 0a0a 2020 2020 2020 2020 2020  lst]..          
-0001d1d0: 2020 666f 7220 6320 696e 206c 7374 3a0a    for c in lst:.
-0001d1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d1f0: 6966 2075 7365 5f6d 696e 6f72 3a20 625f  if use_minor: b_
-0001d200: 6375 7220 3d20 795f 7072 6564 5f73 656c  cur = y_pred_sel
-0001d210: 203d 3d20 635b 305d 0a20 2020 2020 2020   == c[0].       
-0001d220: 2020 2020 2020 2020 2020 2020 200a 2020               .  
-0001d230: 2020 2020 2020 2020 2020 2020 2020 6d6b                mk
-0001d240: 725f 6c73 742c 206d 6b72 5f6c 7374 5f6e  r_lst, mkr_lst_n
-0001d250: 6567 203d 2067 6574 5f6d 6172 6b65 7273  eg = get_markers
-0001d260: 5f6d 696e 6f72 5f74 7970 6532 286d 6172  _minor_type2(mar
-0001d270: 6b65 725f 6669 6c65 2c20 632c 200a 2020  ker_file, c, .  
-0001d280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d2a0: 2020 706e 7368 3132 203d 206d 6b72 5f73    pnsh12 = mkr_s
-0001d2b0: 656c 6563 746f 722c 2072 656d 5f63 6f6d  elector, rem_com
-0001d2c0: 6d6f 6e20 3d20 7265 6d5f 636d 6e5f 6d6b  mon = rem_cmn_mk
-0001d2d0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-0001d2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d2f0: 2020 2020 2020 2063 6f6d 625f 6d6b 7273         comb_mkrs
-0001d300: 203d 2063 6f6d 625f 6d6b 7273 2c20 7665   = comb_mkrs, ve
-0001d310: 7262 6f73 6520 3d20 4661 6c73 6529 0a0a  rbose = False)..
+0001b560: 2020 2020 2020 2020 2020 2020 2070 6d61               pma
+0001b570: 6a20 3d20 6b6e 6e5f 706d 616a 2c20 6e6c  j = knn_pmaj, nl
+0001b580: 6f67 5f70 7661 6c5f 7468 203d 202d 6e70  og_pval_th = -np
+0001b590: 2e6c 6f67 3130 2870 7661 6c5f 7468 2929  .log10(pval_th))
+0001b5a0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0001b5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b5c0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001b5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b5e0: 2020 2020 2020 2020 2020 795f 7072 6564            y_pred
+0001b5f0: 5f63 7572 2c20 7363 6f72 655f 7570 203d  _cur, score_up =
+0001b600: 2061 7070 6c79 5f6b 6e6e 3228 6e65 695f   apply_knn2(nei_
+0001b610: 696e 6469 6365 732c 2079 5f70 7265 645f  indices, y_pred_
+0001b620: 6375 722c 2064 665f 4753 415f 7363 6f72  cur, df_GSA_scor
+0001b630: 655f 6375 722c 200a 2020 2020 2020 2020  e_cur, .        
+0001b640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b670: 706d 616a 203d 206b 6e6e 5f70 6d61 6a2c  pmaj = knn_pmaj,
+0001b680: 206e 6c6f 675f 7076 616c 5f74 6820 3d20   nlog_pval_th = 
+0001b690: 2d6e 702e 6c6f 6731 3028 7076 616c 5f74  -np.log10(pval_t
+0001b6a0: 6829 2920 0a20 2020 2020 2020 2020 2020  h)) .           
+0001b6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b6c0: 2023 2320 7363 6f72 655f 7570 206e 6f74   ## score_up not
+0001b6d0: 2077 6f72 6b69 6e67 0a20 2020 2020 2020   working.       
+0001b6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b6f0: 2020 2020 2023 2320 6466 5f47 5341 5f73       ## df_GSA_s
+0001b700: 636f 7265 5f63 7572 203d 2073 636f 7265  core_cur = score
+0001b710: 5f75 700a 0a20 2020 2020 2020 2020 2020  _up..           
+0001b720: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001b730: 7665 7262 6f73 653a 2070 7269 6e74 2827  verbose: print('
+0001b740: 646f 6e65 2e20 2825 6929 2027 2025 2028  done. (%i) ' % (
+0001b750: 726f 756e 6428 7469 6d65 2e74 696d 6528  round(time.time(
+0001b760: 2920 2d20 7374 6172 745f 7469 6d65 2929  ) - start_time))
+0001b770: 290a 0a0a 2020 2020 2020 2020 2020 2020  )...            
+0001b780: 2020 2020 6964 7820 3d20 6964 785f 7365      idx = idx_se
+0001b790: 6c5b 625f 6375 725d 0a20 2020 2020 2020  l[b_cur].       
+0001b7a0: 2020 2020 2020 2020 2064 665f 7072 6564           df_pred
+0001b7b0: 2e6c 6f63 5b69 6478 2c27 6365 6c6c 5f74  .loc[idx,'cell_t
+0001b7c0: 7970 655f 6d69 6e6f 7227 5d20 3d20 795f  ype_minor'] = y_
+0001b7d0: 7072 6564 5f63 7572 0a20 2020 2020 2020  pred_cur.       
+0001b7e0: 2020 2020 2020 2020 2079 5f70 7265 645f           y_pred_
+0001b7f0: 7365 6c5b 625f 6375 725d 203d 2079 5f70  sel[b_cur] = y_p
+0001b800: 7265 645f 6375 720a 0a20 2020 2020 2020  red_cur..       
+0001b810: 2020 2020 2020 2020 2064 665f 7072 6564           df_pred
+0001b820: 2e6c 6f63 5b69 6478 2c20 2763 656c 6c5f  .loc[idx, 'cell_
+0001b830: 7479 7065 5f6d 696e 6f72 2831 7374 2927  type_minor(1st)'
+0001b840: 5d20 3d20 6466 5f72 6573 5f63 7572 5b27  ] = df_res_cur['
+0001b850: 6365 6c6c 5f74 7970 6528 3173 7429 275d  cell_type(1st)']
+0001b860: 2e61 7374 7970 6528 7374 7229 0a20 2020  .astype(str).   
+0001b870: 2020 2020 2020 2020 2020 2020 2064 665f               df_
+0001b880: 7072 6564 2e6c 6f63 5b69 6478 2c20 2743  pred.loc[idx, 'C
+0001b890: 6f6e 6669 6465 6e63 655f 6d69 6e6f 7228  onfidence_minor(
+0001b8a0: 3173 7429 275d 203d 2064 665f 7265 735f  1st)'] = df_res_
+0001b8b0: 6375 725b 272d 6c6f 6750 275d 2e61 7374  cur['-logP'].ast
+0001b8c0: 7970 6528 666c 6f61 7429 0a20 2020 2020  ype(float).     
+0001b8d0: 2020 2020 2020 2020 2020 2064 665f 7072             df_pr
+0001b8e0: 6564 2e6c 6f63 5b69 6478 2c20 2763 656c  ed.loc[idx, 'cel
+0001b8f0: 6c5f 7479 7065 5f6d 696e 6f72 2832 6e64  l_type_minor(2nd
+0001b900: 2927 5d20 3d20 6466 5f72 6573 5f63 7572  )'] = df_res_cur
+0001b910: 5b27 6365 6c6c 5f74 7970 6528 326e 6429  ['cell_type(2nd)
+0001b920: 275d 2e61 7374 7970 6528 7374 7229 0a20  '].astype(str). 
+0001b930: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001b940: 665f 7072 6564 2e6c 6f63 5b69 6478 2c20  f_pred.loc[idx, 
+0001b950: 2743 6f6e 6669 6465 6e63 655f 6d69 6e6f  'Confidence_mino
+0001b960: 7228 326e 6429 275d 203d 2064 665f 7265  r(2nd)'] = df_re
+0001b970: 735f 6375 725b 272d 6c6f 6750 2832 6e64  s_cur['-logP(2nd
+0001b980: 2927 5d2e 6173 7479 7065 2866 6c6f 6174  )'].astype(float
+0001b990: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0001b9a0: 2020 2064 665f 7072 6564 322e 6c6f 635b     df_pred2.loc[
+0001b9b0: 6964 782c 2763 6c75 7374 6572 5f72 6576  idx,'cluster_rev
+0001b9c0: 275d 203d 2079 5f63 6c75 7374 5f63 7572  '] = y_clust_cur
+0001b9d0: 202b 2031 0a20 2020 2020 2020 2020 2020   + 1.           
+0001b9e0: 2020 2020 2064 665f 7072 6564 322e 6c6f       df_pred2.lo
+0001b9f0: 635b 6964 782c 2763 6c75 7374 6572 5f72  c[idx,'cluster_r
+0001ba00: 6576 275d 203d 2064 665f 7072 6564 322e  ev'] = df_pred2.
+0001ba10: 6c6f 635b 6964 782c 2763 6c75 7374 6572  loc[idx,'cluster
+0001ba20: 5f72 6576 275d 2e61 7374 7970 6528 7374  _rev'].astype(st
+0001ba30: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
+0001ba40: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+0001ba50: 2020 2020 2323 2054 6f20 6265 2075 7365      ## To be use
+0001ba60: 6420 696e 2073 7562 7365 7420 6964 656e  d in subset iden
+0001ba70: 7469 6669 6361 7469 6f6e 0a20 2020 2020  tification.     
+0001ba80: 2020 2020 2020 2020 2020 2069 6620 6466             if df
+0001ba90: 5f47 5341 5f73 636f 7265 5f63 7572 2069  _GSA_score_cur i
+0001baa0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0001bab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bac0: 636f 6c73 203d 2064 665f 4753 415f 7363  cols = df_GSA_sc
+0001bad0: 6f72 655f 6375 722e 636f 6c75 6d6e 732e  ore_cur.columns.
+0001bae0: 7661 6c75 6573 0a20 2020 2020 2020 2020  values.         
+0001baf0: 2020 2020 2020 2020 2020 2069 6478 7320             idxs 
+0001bb00: 3d20 6466 5f47 5341 5f73 636f 7265 5f63  = df_GSA_score_c
+0001bb10: 7572 2e69 6e64 6578 2e76 616c 7565 730a  ur.index.values.
+0001bb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bb30: 2020 2020 6466 5f47 5341 5f73 636f 7265      df_GSA_score
+0001bb40: 5f6d 696e 6f72 5f61 6c6c 5b63 6f6c 735d  _minor_all[cols]
+0001bb50: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
+0001bb60: 2020 2020 2020 2020 2064 665f 4753 415f           df_GSA_
+0001bb70: 7363 6f72 655f 6d69 6e6f 725f 616c 6c2e  score_minor_all.
+0001bb80: 6c6f 635b 6964 7873 2c20 636f 6c73 5d20  loc[idxs, cols] 
+0001bb90: 3d20 6466 5f47 5341 5f73 636f 7265 5f63  = df_GSA_score_c
+0001bba0: 7572 0a0a 2020 2020 2020 2020 2020 2020  ur..            
+0001bbb0: 2020 2020 6966 2064 665f 7265 735f 6375      if df_res_cu
+0001bbc0: 722e 7368 6170 655b 305d 203e 2030 3a0a  r.shape[0] > 0:.
+0001bbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bbe0: 2020 2020 6469 6374 5f73 756d 6d61 7279      dict_summary
+0001bbf0: 5f72 6573 5b74 6320 2b20 2720 6d69 6e6f  _res[tc + ' mino
+0001bc00: 7220 7479 7065 275d 203d 2064 665f 7265  r type'] = df_re
+0001bc10: 735f 6375 720a 2020 2020 2020 2020 2020  s_cur.          
+0001bc20: 2020 2020 2020 2020 2020 6469 6374 5f73            dict_s
+0001bc30: 756d 6d61 7279 5f73 636f 7265 5b74 6320  ummary_score[tc 
+0001bc40: 2b20 2720 6d69 6e6f 7220 7479 7065 275d  + ' minor type']
+0001bc50: 203d 2064 665f 7363 6f72 655f 6375 720a   = df_score_cur.
+0001bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bc70: 2020 2020 6469 6374 5f73 756d 6d61 7279      dict_summary
+0001bc80: 5f73 636f 7265 325b 7463 202b 2027 206d  _score2[tc + ' m
+0001bc90: 696e 6f72 2074 7970 6527 5d20 3d20 6466  inor type'] = df
+0001bca0: 5f47 5341 5f73 636f 7265 5f63 7572 0a0a  _GSA_score_cur..
+0001bcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bcc0: 6966 2063 6e74 203d 3d20 303a 0a20 2020  if cnt == 0:.   
+0001bcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bce0: 2064 665f 7265 735f 7365 6c20 3d20 6466   df_res_sel = df
+0001bcf0: 5f72 6573 5f63 7572 0a20 2020 2020 2020  _res_cur.       
+0001bd00: 2020 2020 2020 2020 2020 2020 2023 2069               # i
+0001bd10: 6620 6466 5f73 636f 7265 5f63 7572 2069  f df_score_cur i
+0001bd20: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0001bd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd40: 6466 5f73 636f 7265 5f73 656c 203d 2064  df_score_sel = d
+0001bd50: 665f 7363 6f72 655f 6375 720a 2020 2020  f_score_cur.    
+0001bd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd70: 6466 5f47 5341 5f73 636f 7265 5f73 656c  df_GSA_score_sel
+0001bd80: 203d 2064 665f 4753 415f 7363 6f72 655f   = df_GSA_score_
+0001bd90: 6375 720a 2020 2020 2020 2020 2020 2020  cur.            
+0001bda0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001bdb0: 2020 2020 2020 2020 2020 2020 2020 6466                df
+0001bdc0: 5f72 6573 5f73 656c 203d 2070 642e 636f  _res_sel = pd.co
+0001bdd0: 6e63 6174 285b 6466 5f72 6573 5f73 656c  ncat([df_res_sel
+0001bde0: 2c20 6466 5f72 6573 5f63 7572 5d2c 2061  , df_res_cur], a
+0001bdf0: 7869 7320 3d20 3029 0a20 2020 2020 2020  xis = 0).       
+0001be00: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001be10: 2864 665f 7363 6f72 655f 6375 7220 6973  (df_score_cur is
+0001be20: 206e 6f74 204e 6f6e 6529 2026 2028 6466   not None) & (df
+0001be30: 5f73 636f 7265 5f73 656c 2069 7320 6e6f  _score_sel is no
+0001be40: 7420 4e6f 6e65 293a 0a20 2020 2020 2020  t None):.       
+0001be50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001be60: 2064 665f 7363 6f72 655f 7365 6c20 3d20   df_score_sel = 
+0001be70: 7064 2e63 6f6e 6361 7428 5b64 665f 7363  pd.concat([df_sc
+0001be80: 6f72 655f 7365 6c2c 2064 665f 7363 6f72  ore_sel, df_scor
+0001be90: 655f 6375 725d 2c20 6178 6973 203d 2030  e_cur], axis = 0
+0001bea0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001beb0: 2020 2020 2020 6466 5f47 5341 5f73 636f        df_GSA_sco
+0001bec0: 7265 5f73 656c 203d 2070 642e 636f 6e63  re_sel = pd.conc
+0001bed0: 6174 285b 6466 5f47 5341 5f73 636f 7265  at([df_GSA_score
+0001bee0: 5f73 656c 2c20 6466 5f47 5341 5f73 636f  _sel, df_GSA_sco
+0001bef0: 7265 5f63 7572 5d2c 2061 7869 7320 3d20  re_cur], axis = 
+0001bf00: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
+0001bf10: 2020 2063 6e74 202b 3d20 310a 0a20 2020     cnt += 1..   
+0001bf20: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001bf30: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+0001bf40: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0001bf50: 6e74 2827 2573 206d 696e 6f72 2074 7970  nt('%s minor typ
+0001bf60: 6520 6964 656e 7469 6669 6361 7469 6f6e  e identification
+0001bf70: 2064 6f6e 652e 2028 2569 2927 2025 205c   done. (%i)' % \
+0001bf80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001bf90: 2020 2020 2020 2020 2020 2028 7463 2c20             (tc, 
+0001bfa0: 726f 756e 6428 7469 6d65 2e74 696d 6528  round(time.time(
+0001bfb0: 2920 2d20 7374 6172 745f 7469 6d65 2929  ) - start_time))
+0001bfc0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001bfd0: 2020 2020 2020 2320 706c 6f74 5f72 6f63        # plot_roc
+0001bfe0: 5f72 6573 756c 7428 6466 5f73 636f 7265  _result(df_score
+0001bff0: 5f73 656c 2c20 7973 5f73 656c 2c20 6d65  _sel, ys_sel, me
+0001c000: 7468 6f64 290a 2020 2020 2020 2020 2020  thod).          
+0001c010: 2020 2020 2020 656c 7365 3a20 7072 696e        else: prin
+0001c020: 7428 272e 272c 2065 6e64 203d 2027 272c  t('.', end = '',
+0001c030: 2066 6c75 7368 203d 2054 7275 6529 0a0a   flush = True)..
+0001c040: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0001c050: 2020 2020 2069 6620 636e 7420 3e20 303a       if cnt > 0:
+0001c060: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001c070: 6e70 2e73 756d 2862 5f73 656c 2920 3c20  np.sum(b_sel) < 
+0001c080: 6466 5f72 6573 5f73 656c 2e73 6861 7065  df_res_sel.shape
+0001c090: 5b30 5d3a 0a20 2020 2020 2020 2020 2020  [0]:.           
+0001c0a0: 2020 2020 2070 7269 6e74 2827 5741 524e       print('WARN
+0001c0b0: 494e 473a 2025 6920 3c20 2569 2e20 4f6e  ING: %i < %i. On
+0001c0c0: 6520 6f72 206d 6f72 6520 636c 7573 7465  e or more cluste
+0001c0d0: 7228 7329 2069 7320 6d69 7865 642e 2720  r(s) is mixed.' 
+0001c0e0: 2520 5c0a 2020 2020 2020 2020 2020 2020  % \.            
+0001c0f0: 2020 2020 2020 2020 2020 286e 702e 7375            (np.su
+0001c100: 6d28 625f 7365 6c29 2c20 6466 5f72 6573  m(b_sel), df_res
+0001c110: 5f73 656c 2e73 6861 7065 5b30 5d29 290a  _sel.shape[0])).
+0001c120: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+0001c130: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001c140: 7072 696e 7428 2725 7320 7479 7065 2069  print('%s type i
+0001c150: 6465 6e74 6966 6963 6174 696f 6e20 646f  dentification do
+0001c160: 6e65 2e20 2825 6929 2720 2520 2874 632c  ne. (%i)' % (tc,
+0001c170: 2072 6f75 6e64 2874 696d 652e 7469 6d65   round(time.time
+0001c180: 2829 202d 2073 7461 7274 5f74 696d 6529  () - start_time)
+0001c190: 2929 0a20 2020 2020 2020 2065 6c73 653a  )).        else:
+0001c1a0: 0a20 2020 2020 2020 2020 2020 2065 7469  .            eti
+0001c1b0: 6d65 203d 2072 6f75 6e64 2874 696d 652e  me = round(time.
+0001c1c0: 7469 6d65 2829 202d 2073 7461 7274 5f74  time() - start_t
+0001c1d0: 696d 655f 6e65 7729 2020 2020 2020 2020  ime_new)        
+0001c1e0: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+0001c1f0: 7274 5f74 696d 655f 6e65 7720 3d20 7469  rt_time_new = ti
+0001c200: 6d65 2e74 696d 6528 290a 2020 2020 2020  me.time().      
+0001c210: 2020 2020 2020 7072 696e 7428 274d 2569        print('M%i
+0001c220: 2e27 2025 2065 7469 6d65 2c20 656e 6420  .' % etime, end 
+0001c230: 3d20 2727 2c20 666c 7573 6820 3d20 5472  = '', flush = Tr
+0001c240: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
+0001c250: 2320 7072 696e 7428 272e 272c 2065 6e64  # print('.', end
+0001c260: 203d 2027 272c 2066 6c75 7368 203d 2054   = '', flush = T
+0001c270: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
+0001c280: 2023 2070 6c6f 745f 726f 635f 7265 7375   # plot_roc_resu
+0001c290: 6c74 2864 665f 7363 6f72 655f 7365 6c2c  lt(df_score_sel,
+0001c2a0: 2079 735f 7365 6c2c 206d 6574 686f 6429   ys_sel, method)
+0001c2b0: 0a20 2020 2020 2020 2023 2727 270a 0a20  .        #'''.. 
+0001c2c0: 2020 2020 2020 2064 665f 7072 6564 2e6c         df_pred.l
+0001c2d0: 6f63 5b62 5f73 656c 2c20 2763 656c 6c5f  oc[b_sel, 'cell_
+0001c2e0: 7479 7065 5f6d 696e 6f72 275d 203d 2079  type_minor'] = y
+0001c2f0: 5f70 7265 645f 7365 6c0a 2020 2020 2020  _pred_sel.      
+0001c300: 2020 0a20 2020 2020 2020 2023 2064 6963    .        # dic
+0001c310: 745f 7375 6d6d 6172 795f 7265 735b 274d  t_summary_res['M
+0001c320: 696e 6f72 5f54 7970 6527 5d20 3d20 6466  inor_Type'] = df
+0001c330: 5f72 6573 5f73 656c 0a20 2020 2020 2020  _res_sel.       
+0001c340: 2023 2064 6963 745f 7375 6d6d 6172 795f   # dict_summary_
+0001c350: 7363 6f72 655b 274d 696e 6f72 5f54 7970  score['Minor_Typ
+0001c360: 6527 5d20 3d20 6466 5f73 636f 7265 5f73  e'] = df_score_s
+0001c370: 656c 0a20 2020 2020 2020 2023 2064 6963  el.        # dic
+0001c380: 745f 7375 6d6d 6172 795f 7363 6f72 6532  t_summary_score2
+0001c390: 5b27 4d69 6e6f 725f 5479 7065 275d 203d  ['Minor_Type'] =
+0001c3a0: 2064 665f 4753 415f 7363 6f72 655f 7365   df_GSA_score_se
+0001c3b0: 6c0a 2020 2020 2020 2020 2020 2020 0a20  l.            . 
+0001c3c0: 2020 2020 2020 2062 5f63 7572 203d 2079         b_cur = y
+0001c3d0: 5f70 7265 645f 7365 6c20 3d3d 2027 756e  _pred_sel == 'un
+0001c3e0: 6173 7369 676e 6564 270a 2020 2020 2020  assigned'.      
+0001c3f0: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+0001c400: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0001c410: 274e 756d 206f 6620 756e 6173 7369 676e  'Num of unassign
+0001c420: 6564 2063 656c 6c73 3a20 2569 2061 6d6f  ed cells: %i amo
+0001c430: 6e67 2025 6927 2025 2028 6e70 2e73 756d  ng %i' % (np.sum
+0001c440: 2862 5f63 7572 292c 206c 656e 2862 5f63  (b_cur), len(b_c
+0001c450: 7572 2929 290a 0a20 2020 2020 2020 2023  ur)))..        #
+0001c460: 2320 6d61 6b65 2063 6f72 7265 6374 696f  # make correctio
+0001c470: 6e20 6966 206d 616a 6f72 2074 7970 6520  n if major type 
+0001c480: 616e 6420 6d69 6e6f 7220 7479 7065 2064  and minor type d
+0001c490: 6f65 7320 6e6f 7420 6d61 7463 680a 2020  oes not match.  
+0001c4a0: 2020 2020 2020 6365 6c6c 5f74 7970 655f        cell_type_
+0001c4b0: 6d61 705f 6469 6374 203d 207b 7d0a 2020  map_dict = {}.  
+0001c4c0: 2020 2020 2020 666f 7220 7463 2069 6e20        for tc in 
+0001c4d0: 7461 7267 6574 5f63 656c 6c5f 6c73 742e  target_cell_lst.
+0001c4e0: 6b65 7973 2829 3a0a 2020 2020 2020 2020  keys():.        
+0001c4f0: 2020 2020 7463 5f6c 7374 203d 2074 6172      tc_lst = tar
+0001c500: 6765 745f 6365 6c6c 5f6c 7374 5b74 635d  get_cell_lst[tc]
+0001c510: 0a20 2020 2020 2020 2020 2020 206d 6b72  .            mkr
+0001c520: 5f6c 7374 2c20 6d6b 725f 6c73 745f 6e65  _lst, mkr_lst_ne
+0001c530: 6720 3d20 6765 745f 6d61 726b 6572 735f  g = get_markers_
+0001c540: 6365 6c6c 5f74 7970 6528 6d61 726b 6572  cell_type(marker
+0001c550: 5f66 696c 652c 2074 635f 6c73 742c 2070  _file, tc_lst, p
+0001c560: 6e73 6831 3220 3d20 6d6b 725f 7365 6c65  nsh12 = mkr_sele
+0001c570: 6374 6f72 2c20 0a20 2020 2020 2020 2020  ctor, .         
+0001c580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c5a0: 2020 2072 656d 5f63 6f6d 6d6f 6e20 3d20     rem_common = 
+0001c5b0: 7265 6d5f 636d 6e5f 6d6b 722c 2076 6572  rem_cmn_mkr, ver
+0001c5c0: 626f 7365 203d 2046 616c 7365 290a 0a20  bose = False).. 
+0001c5d0: 2020 2020 2020 2020 2020 2063 656c 6c5f             cell_
+0001c5e0: 7479 7065 5f6c 7374 203d 206c 6973 7428  type_lst = list(
+0001c5f0: 6d6b 725f 6c73 742e 6b65 7973 2829 290a  mkr_lst.keys()).
+0001c600: 2020 2020 2020 2020 2020 2020 6365 6c6c              cell
+0001c610: 5f74 7970 655f 6d61 705f 6469 6374 5b74  _type_map_dict[t
+0001c620: 635d 203d 2063 656c 6c5f 7479 7065 5f6c  c] = cell_type_l
+0001c630: 7374 0a0a 2020 2020 2020 2020 2327 2727  st..        #'''
+0001c640: 0a20 2020 2020 2020 206d 6170 5f64 6963  .        map_dic
+0001c650: 7420 3d20 7b7d 0a20 2020 2020 2020 2066  t = {}.        f
+0001c660: 6f72 206b 6579 2069 6e20 6c69 7374 2863  or key in list(c
+0001c670: 656c 6c5f 7479 7065 5f6d 6170 5f64 6963  ell_type_map_dic
+0001c680: 742e 6b65 7973 2829 293a 0a20 2020 2020  t.keys()):.     
+0001c690: 2020 2020 2020 2066 6f72 2063 2069 6e20         for c in 
+0001c6a0: 6365 6c6c 5f74 7970 655f 6d61 705f 6469  cell_type_map_di
+0001c6b0: 6374 5b6b 6579 5d3a 0a20 2020 2020 2020  ct[key]:.       
+0001c6c0: 2020 2020 2020 2020 206d 6170 5f64 6963           map_dic
+0001c6d0: 745b 635d 203d 206b 6579 0a20 2020 2020  t[c] = key.     
+0001c6e0: 2020 2063 656c 6c5f 7479 7065 7320 3d20     cell_types = 
+0001c6f0: 6c69 7374 286d 6170 5f64 6963 742e 6b65  list(map_dict.ke
+0001c700: 7973 2829 290a 0a20 2020 2020 2020 2079  ys())..        y
+0001c710: 5f70 7265 645f 6d61 6a6f 7220 3d20 6c69  _pred_major = li
+0001c720: 7374 2864 665f 7072 6564 5b27 6365 6c6c  st(df_pred['cell
+0001c730: 5f74 7970 655f 6d61 6a6f 7227 5d29 0a20  _type_major']). 
+0001c740: 2020 2020 2020 2079 5f70 7265 645f 6d69         y_pred_mi
+0001c750: 6e6f 7220 3d20 6c69 7374 2864 665f 7072  nor = list(df_pr
+0001c760: 6564 5b27 6365 6c6c 5f74 7970 655f 6d69  ed['cell_type_mi
+0001c770: 6e6f 7227 5d29 0a0a 2020 2020 2020 2020  nor'])..        
+0001c780: 795f 7072 6564 5f6d 616a 6f72 5f6e 6577  y_pred_major_new
+0001c790: 203d 205b 5d0a 2020 2020 2020 2020 795f   = [].        y_
+0001c7a0: 7072 6564 5f6d 696e 6f72 5f6e 6577 203d  pred_minor_new =
+0001c7b0: 205b 5d0a 2020 2020 2020 2020 666f 7220   [].        for 
+0001c7c0: 796a 2c20 796d 2069 6e20 7a69 7028 795f  yj, ym in zip(y_
+0001c7d0: 7072 6564 5f6d 616a 6f72 2c20 795f 7072  pred_major, y_pr
+0001c7e0: 6564 5f6d 696e 6f72 293a 0a20 2020 2020  ed_minor):.     
+0001c7f0: 2020 2020 2020 2069 6620 796d 2069 6e20         if ym in 
+0001c800: 6365 6c6c 5f74 7970 6573 3a0a 2020 2020  cell_types:.    
+0001c810: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+0001c820: 6170 5f64 6963 745b 796d 5d20 3d3d 2079  ap_dict[ym] == y
+0001c830: 6a3a 0a20 2020 2020 2020 2020 2020 2020  j:.             
+0001c840: 2020 2020 2020 2079 5f70 7265 645f 6d61         y_pred_ma
+0001c850: 6a6f 725f 6e65 772e 6170 7065 6e64 2879  jor_new.append(y
+0001c860: 6a29 0a20 2020 2020 2020 2020 2020 2020  j).             
+0001c870: 2020 2020 2020 2079 5f70 7265 645f 6d69         y_pred_mi
+0001c880: 6e6f 725f 6e65 772e 6170 7065 6e64 2879  nor_new.append(y
+0001c890: 6d29 0a20 2020 2020 2020 2020 2020 2020  m).             
+0001c8a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001c8b0: 2020 2020 2020 2020 2020 2020 2079 5f70               y_p
+0001c8c0: 7265 645f 6d61 6a6f 725f 6e65 772e 6170  red_major_new.ap
+0001c8d0: 7065 6e64 286d 6170 5f64 6963 745b 796d  pend(map_dict[ym
+0001c8e0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+0001c8f0: 2020 2020 2020 2079 5f70 7265 645f 6d69         y_pred_mi
+0001c900: 6e6f 725f 6e65 772e 6170 7065 6e64 2879  nor_new.append(y
+0001c910: 6d29 0a20 2020 2020 2020 2020 2020 2065  m).            e
+0001c920: 6c73 653a 2023 2027 756e 6173 7369 676e  lse: # 'unassign
+0001c930: 6564 270a 2020 2020 2020 2020 2020 2020  ed'.            
+0001c940: 2020 2020 795f 7072 6564 5f6d 616a 6f72      y_pred_major
+0001c950: 5f6e 6577 2e61 7070 656e 6428 796a 2920  _new.append(yj) 
+0001c960: 2327 756e 6173 7369 676e 6564 2729 0a20  #'unassigned'). 
+0001c970: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+0001c980: 5f70 7265 645f 6d69 6e6f 725f 6e65 772e  _pred_minor_new.
+0001c990: 6170 7065 6e64 2827 756e 6173 7369 676e  append('unassign
+0001c9a0: 6564 2729 0a0a 2020 2020 2020 2020 6466  ed')..        df
+0001c9b0: 5f70 7265 645b 2763 656c 6c5f 7479 7065  _pred['cell_type
+0001c9c0: 5f6d 616a 6f72 275d 203d 2079 5f70 7265  _major'] = y_pre
+0001c9d0: 645f 6d61 6a6f 725f 6e65 770a 2020 2020  d_major_new.    
+0001c9e0: 2020 2020 6466 5f70 7265 645b 2763 656c      df_pred['cel
+0001c9f0: 6c5f 7479 7065 5f6d 696e 6f72 275d 203d  l_type_minor'] =
+0001ca00: 2079 5f70 7265 645f 6d69 6e6f 725f 6e65   y_pred_minor_ne
+0001ca10: 770a 2020 2020 2020 2020 2327 2727 0a0a  w.        #'''..
+0001ca20: 2020 2020 2020 2020 795f 7072 6564 5f6d          y_pred_m
+0001ca30: 616a 6f72 203d 206c 6973 7428 6466 5f70  ajor = list(df_p
+0001ca40: 7265 645b 2763 656c 6c5f 7479 7065 5f6d  red['cell_type_m
+0001ca50: 616a 6f72 275d 290a 2020 2020 2020 2020  ajor']).        
+0001ca60: 795f 7072 6564 5f6d 696e 6f72 203d 206c  y_pred_minor = l
+0001ca70: 6973 7428 6466 5f70 7265 645b 2763 656c  ist(df_pred['cel
+0001ca80: 6c5f 7479 7065 5f6d 696e 6f72 275d 290a  l_type_minor']).
+0001ca90: 2020 2020 2020 2020 0a20 2020 2023 2323          .    ###
+0001caa0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001cab0: 2323 2323 230a 2020 2020 2323 2320 5375  #####.    ### Su
+0001cac0: 6273 6574 2069 6465 6e74 6966 6963 6174  bset identificat
+0001cad0: 696f 6e20 2323 230a 2020 2020 2323 2323  ion ###.    ####
+0001cae0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001caf0: 2323 2323 0a0a 2020 2020 6966 2069 6465  ####..    if ide
+0001cb00: 6e74 5f6c 6576 656c 203e 2032 3a20 2020  nt_level > 2:   
+0001cb10: 2020 2020 200a 0a20 2020 2020 2020 2064       ..        d
+0001cb20: 665f 7072 6564 5b27 6365 6c6c 5f74 7970  f_pred['cell_typ
+0001cb30: 655f 7375 6273 6574 2831 7374 2927 5d20  e_subset(1st)'] 
+0001cb40: 3d20 6466 5f70 7265 645b 2763 656c 6c5f  = df_pred['cell_
+0001cb50: 7479 7065 5f6d 696e 6f72 2831 7374 2927  type_minor(1st)'
+0001cb60: 5d0a 2020 2020 2020 2020 6466 5f70 7265  ].        df_pre
+0001cb70: 645b 2743 6f6e 6669 6465 6e63 655f 7375  d['Confidence_su
+0001cb80: 6273 6574 2831 7374 2927 5d20 3d20 6466  bset(1st)'] = df
+0001cb90: 5f70 7265 645b 2743 6f6e 6669 6465 6e63  _pred['Confidenc
+0001cba0: 655f 6d69 6e6f 7228 3173 7429 275d 0a20  e_minor(1st)']. 
+0001cbb0: 2020 2020 2020 2064 665f 7072 6564 5b27         df_pred['
+0001cbc0: 6365 6c6c 5f74 7970 655f 7375 6273 6574  cell_type_subset
+0001cbd0: 2832 6e64 2927 5d20 3d20 6466 5f70 7265  (2nd)'] = df_pre
+0001cbe0: 645b 2763 656c 6c5f 7479 7065 5f6d 696e  d['cell_type_min
+0001cbf0: 6f72 2831 7374 2927 5d0a 2020 2020 2020  or(1st)'].      
+0001cc00: 2020 6466 5f70 7265 645b 2743 6f6e 6669    df_pred['Confi
+0001cc10: 6465 6e63 655f 7375 6273 6574 2832 6e64  dence_subset(2nd
+0001cc20: 2927 5d20 3d20 6466 5f70 7265 645b 2743  )'] = df_pred['C
+0001cc30: 6f6e 6669 6465 6e63 655f 6d69 6e6f 7228  onfidence_minor(
+0001cc40: 3173 7429 275d 0a20 2020 2020 2020 200a  1st)'].        .
+0001cc50: 2020 2020 2020 2020 636e 7420 3d20 300a          cnt = 0.
+0001cc60: 2020 2020 2020 2020 6d61 705f 6469 6374          map_dict
+0001cc70: 5f73 7562 326d 696e 203d 207b 7d0a 2020  _sub2min = {}.  
+0001cc80: 2020 2020 2020 6d61 705f 6469 6374 5f6d        map_dict_m
+0001cc90: 696e 3273 7562 203d 207b 7d0a 2020 2020  in2sub = {}.    
+0001cca0: 2020 2020 666f 7220 7463 2069 6e20 7461      for tc in ta
+0001ccb0: 7267 6574 5f63 656c 6c5f 6c73 742e 6b65  rget_cell_lst.ke
+0001ccc0: 7973 2829 3a0a 0a20 2020 2020 2020 2020  ys():..         
+0001ccd0: 2020 2023 2320 4765 7420 6d69 6e6f 7220     ## Get minor 
+0001cce0: 7479 7065 206d 6172 6b65 7273 0a20 2020  type markers.   
+0001ccf0: 2020 2020 2020 2020 2074 6172 6765 745f           target_
+0001cd00: 6365 6c6c 203d 2074 6172 6765 745f 6365  cell = target_ce
+0001cd10: 6c6c 5f6c 7374 5b74 635d 0a20 2020 2020  ll_lst[tc].     
+0001cd20: 2020 2020 2020 206d 6b72 5f6c 7374 2c20         mkr_lst, 
+0001cd30: 6d6b 725f 6c73 745f 6e65 6720 3d20 6765  mkr_lst_neg = ge
+0001cd40: 745f 6d61 726b 6572 735f 6365 6c6c 5f74  t_markers_cell_t
+0001cd50: 7970 6528 6d61 726b 6572 5f66 696c 652c  ype(marker_file,
+0001cd60: 2074 6172 6765 745f 6365 6c6c 2c20 0a20   target_cell, . 
+0001cd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd90: 2020 2020 2020 2020 2020 2070 6e73 6831             pnsh1
+0001cda0: 3220 3d20 6d6b 725f 7365 6c65 6374 6f72  2 = mkr_selector
+0001cdb0: 2c20 7265 6d5f 636f 6d6d 6f6e 203d 2072  , rem_common = r
+0001cdc0: 656d 5f63 6d6e 5f6d 6b72 2c0a 2020 2020  em_cmn_mkr,.    
+0001cdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce00: 2020 2020 2076 6572 626f 7365 203d 2046       verbose = F
+0001ce10: 616c 7365 290a 2020 2020 2020 2020 2020  alse).          
+0001ce20: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+0001ce30: 2020 2069 6620 6c65 6e28 6d69 6e6f 725f     if len(minor_
+0001ce40: 7479 7065 735f 746f 5f65 7863 6c75 6465  types_to_exclude
+0001ce50: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
+0001ce60: 2020 2020 2020 206d 6b72 5f6c 7374 203d         mkr_lst =
+0001ce70: 2072 656d 5f6d 696e 6f72 2820 6d6b 725f   rem_minor( mkr_
+0001ce80: 6c73 742c 206d 696e 6f72 5f74 7970 6573  lst, minor_types
+0001ce90: 5f74 6f5f 6578 636c 7564 6520 290a 2020  _to_exclude ).  
+0001cea0: 2020 2020 2020 2020 2020 2020 2020 6d6b                mk
+0001ceb0: 725f 6c73 745f 6e65 6720 3d20 7265 6d5f  r_lst_neg = rem_
+0001cec0: 6d69 6e6f 7228 206d 6b72 5f6c 7374 5f6e  minor( mkr_lst_n
+0001ced0: 6567 2c20 6d69 6e6f 725f 7479 7065 735f  eg, minor_types_
+0001cee0: 746f 5f65 7863 6c75 6465 2029 0a0a 2020  to_exclude )..  
+0001cef0: 2020 2020 2020 2020 2020 6365 6c6c 5f74            cell_t
+0001cf00: 7970 655f 6c73 7420 3d20 6c69 7374 286d  ype_lst = list(m
+0001cf10: 6b72 5f6c 7374 2e6b 6579 7328 2929 0a20  kr_lst.keys()). 
+0001cf20: 2020 2020 2020 2020 2020 2062 5f63 7572             b_cur
+0001cf30: 203d 206e 702e 6675 6c6c 286c 656e 2879   = np.full(len(y
+0001cf40: 5f70 7265 645f 7365 6c29 2c20 4661 6c73  _pred_sel), Fals
+0001cf50: 6529 0a20 2020 2020 2020 2020 2020 2066  e).            f
+0001cf60: 6f72 2063 2069 6e20 6365 6c6c 5f74 7970  or c in cell_typ
+0001cf70: 655f 6c73 743a 0a20 2020 2020 2020 2020  e_lst:.         
+0001cf80: 2020 2020 2020 2062 5f63 7572 203d 2062         b_cur = b
+0001cf90: 5f63 7572 207c 2028 795f 7072 6564 5f73  _cur | (y_pred_s
+0001cfa0: 656c 203d 3d20 6329 0a20 2020 2020 2020  el == c).       
+0001cfb0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+0001cfc0: 2020 2020 2020 2327 2727 0a20 2020 2020        #'''.     
+0001cfd0: 2020 2020 2020 2023 2323 2054 6f20 6265         ### To be
+0001cfe0: 2075 7365 6420 746f 2064 6574 6572 6d69   used to determi
+0001cff0: 6e65 206d 696e 6f72 2074 7970 6520 666f  ne minor type fo
+0001d000: 7220 6769 7665 6e20 7375 6273 6574 0a20  r given subset. 
+0001d010: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
+0001d020: 2069 6e20 6365 6c6c 5f74 7970 655f 6c73   in cell_type_ls
+0001d030: 743a 2023 2066 6f72 2065 6163 6820 6d69  t: # for each mi
+0001d040: 6e6f 7220 7479 7065 0a20 2020 2020 2020  nor type.       
+0001d050: 2020 2020 2020 2020 206d 6b72 5f6c 7374           mkr_lst
+0001d060: 5f74 6d70 2c20 6d6b 725f 6c73 745f 6e65  _tmp, mkr_lst_ne
+0001d070: 675f 746d 7020 3d20 6765 745f 6d61 726b  g_tmp = get_mark
+0001d080: 6572 735f 6d69 6e6f 725f 7479 7065 3228  ers_minor_type2(
+0001d090: 6d61 726b 6572 5f66 696c 652c 205b 635d  marker_file, [c]
+0001d0a0: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+0001d0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d0c0: 2020 2020 2020 2020 2020 2070 6e73 6831             pnsh1
+0001d0d0: 3220 3d20 6d6b 725f 7365 6c65 6374 6f72  2 = mkr_selector
+0001d0e0: 2c20 7265 6d5f 636f 6d6d 6f6e 203d 2072  , rem_common = r
+0001d0f0: 656d 5f63 6d6e 5f6d 6b72 2c0a 2020 2020  em_cmn_mkr,.    
+0001d100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d120: 2020 2020 636f 6d62 5f6d 6b72 7320 3d20      comb_mkrs = 
+0001d130: 636f 6d62 5f6d 6b72 732c 2076 6572 626f  comb_mkrs, verbo
+0001d140: 7365 203d 2046 616c 7365 290a 2020 2020  se = False).    
+0001d150: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0001d160: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0001d170: 206b 6579 2069 6e20 6d6b 725f 6c73 745f   key in mkr_lst_
+0001d180: 746d 702e 6b65 7973 2829 3a0a 2020 2020  tmp.keys():.    
+0001d190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d1a0: 6d61 705f 6469 6374 5f73 7562 326d 696e  map_dict_sub2min
+0001d1b0: 5b6b 6579 5d20 3d20 630a 2020 2020 2020  [key] = c.      
+0001d1c0: 2020 2020 2020 2020 2020 6d61 705f 6469            map_di
+0001d1d0: 6374 5f6d 696e 3273 7562 5b63 5d20 3d20  ct_min2sub[c] = 
+0001d1e0: 6c69 7374 286d 6b72 5f6c 7374 5f74 6d70  list(mkr_lst_tmp
+0001d1f0: 2e6b 6579 7328 2929 0a20 2020 2020 2020  .keys()).       
+0001d200: 2020 2020 2023 2727 270a 2020 2020 2020       #'''.      
+0001d210: 2020 0a20 2020 2020 2020 2020 2020 2069    .            i
+0001d220: 6620 7573 655f 6d69 6e6f 723a 0a20 2020  f use_minor:.   
+0001d230: 2020 2020 2020 2020 2020 2020 206c 7374               lst
+0001d240: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
+0001d250: 2020 2020 2020 666f 7220 6320 696e 2063        for c in c
+0001d260: 656c 6c5f 7479 7065 5f6c 7374 3a0a 2020  ell_type_lst:.  
+0001d270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d280: 2020 6c73 742e 6170 7065 6e64 2820 5b63    lst.append( [c
+0001d290: 5d20 290a 2020 2020 2020 2020 2020 2020  ] ).            
+0001d2a0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001d2b0: 2020 2020 2020 6c73 7420 3d20 5b63 656c        lst = [cel
+0001d2c0: 6c5f 7479 7065 5f6c 7374 5d0a 0a20 2020  l_type_lst]..   
+0001d2d0: 2020 2020 2020 2020 2066 6f72 2063 2069           for c i
+0001d2e0: 6e20 6c73 743a 0a20 2020 2020 2020 2020  n lst:.         
+0001d2f0: 2020 2020 2020 2069 6620 7573 655f 6d69         if use_mi
+0001d300: 6e6f 723a 2062 5f63 7572 203d 2079 5f70  nor: b_cur = y_p
+0001d310: 7265 645f 7365 6c20 3d3d 2063 5b30 5d0a  red_sel == c[0].
 0001d320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d330: 6966 206c 656e 286d 696e 6f72 5f74 7970  if len(minor_typ
-0001d340: 6573 5f74 6f5f 6578 636c 7564 6529 203e  es_to_exclude) >
-0001d350: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-0001d360: 2020 2020 2020 2020 6d6b 725f 6c73 7420          mkr_lst 
-0001d370: 3d20 7265 6d5f 6d69 6e6f 7228 206d 6b72  = rem_minor( mkr
-0001d380: 5f6c 7374 2c20 6d69 6e6f 725f 7479 7065  _lst, minor_type
-0001d390: 735f 746f 5f65 7863 6c75 6465 2029 0a20  s_to_exclude ). 
-0001d3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d3b0: 2020 206d 6b72 5f6c 7374 5f6e 6567 203d     mkr_lst_neg =
-0001d3c0: 2072 656d 5f6d 696e 6f72 2820 6d6b 725f   rem_minor( mkr_
-0001d3d0: 6c73 745f 6e65 672c 206d 696e 6f72 5f74  lst_neg, minor_t
-0001d3e0: 7970 6573 5f74 6f5f 6578 636c 7564 6520  ypes_to_exclude 
-0001d3f0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0001d400: 2020 2073 6d20 3d20 2727 0a20 2020 2020     sm = ''.     
-0001d410: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
-0001d420: 6579 2069 6e20 6d6b 725f 6c73 742e 6b65  ey in mkr_lst.ke
-0001d430: 7973 2829 3a0a 2020 2020 2020 2020 2020  ys():.          
-0001d440: 2020 2020 2020 2020 2020 736d 203d 2073            sm = s
-0001d450: 6d20 2b20 2725 732c 2720 2520 6b65 790a  m + '%s,' % key.
-0001d460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d470: 2069 6620 286c 656e 286c 6973 7428 6d6b   if (len(list(mk
-0001d480: 725f 6c73 742e 6b65 7973 2829 2929 203c  r_lst.keys())) <
-0001d490: 3d20 3129 207c 2028 6e70 2e73 756d 2862  = 1) | (np.sum(b
-0001d4a0: 5f63 7572 2920 3c20 3130 293a 0a20 2020  _cur) < 10):.   
-0001d4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d4c0: 2058 5f63 7572 203d 2058 5f73 656c 2e6c   X_cur = X_sel.l
-0001d4d0: 6f63 5b62 5f63 7572 2c3a 5d0a 2020 2020  oc[b_cur,:].    
-0001d4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d4f0: 6964 7820 3d20 6c69 7374 2858 5f63 7572  idx = list(X_cur
-0001d500: 2e69 6e64 6578 2e76 616c 7565 7329 0a20  .index.values). 
-0001d510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d520: 2020 2063 746e 203d 2027 756e 6173 7369     ctn = 'unassi
-0001d530: 676e 6564 270a 2020 2020 2020 2020 2020  gned'.          
-0001d540: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-0001d550: 286c 6973 7428 6d6b 725f 6c73 742e 6b65  (list(mkr_lst.ke
-0001d560: 7973 2829 2929 203d 3d20 313a 0a20 2020  ys())) == 1:.   
-0001d570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d580: 2020 2020 2063 746e 203d 206c 6973 7428       ctn = list(
-0001d590: 6d6b 725f 6c73 742e 6b65 7973 2829 295b  mkr_lst.keys())[
-0001d5a0: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
-0001d5b0: 2020 2020 2020 2064 665f 7072 6564 2e6c         df_pred.l
-0001d5c0: 6f63 5b69 6478 2c27 6365 6c6c 5f74 7970  oc[idx,'cell_typ
-0001d5d0: 655f 7375 6273 6574 275d 203d 2073 7472  e_subset'] = str
-0001d5e0: 2863 746e 290a 2020 2020 2020 2020 2020  (ctn).          
-0001d5f0: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
-0001d600: 626f 7365 3a20 0a20 2020 2020 2020 2020  bose: .         
-0001d610: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0001d620: 7269 6e74 2827 2573 2073 7562 7365 7420  rint('%s subset 
-0001d630: 6964 656e 7469 6669 6361 7469 6f6e 3a20  identification: 
-0001d640: 2573 2720 2520 2874 632c 2073 6d5b 3a2d  %s' % (tc, sm[:-
-0001d650: 315d 2929 0a0a 2020 2020 2020 2020 2020  1]))..          
-0001d660: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001d670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d680: 6966 2076 6572 626f 7365 3a20 0a20 2020  if verbose: .   
-0001d690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d6a0: 2020 2020 2070 7269 6e74 2827 2573 2073       print('%s s
-0001d6b0: 7562 7365 7420 6964 656e 7469 6669 6361  ubset identifica
-0001d6c0: 7469 6f6e 3a20 2573 2720 2520 2874 632c  tion: %s' % (tc,
-0001d6d0: 2073 6d5b 3a2d 315d 2929 0a20 2020 2020   sm[:-1])).     
-0001d6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d6f0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-0001d700: 2020 2020 2020 2020 585f 6375 7220 3d20          X_cur = 
-0001d710: 585f 7365 6c2e 6c6f 635b 625f 6375 722c  X_sel.loc[b_cur,
-0001d720: 3a5d 0a20 2020 2020 2020 2020 2020 2020  :].             
-0001d730: 2020 2020 2020 2058 5f70 6361 5f63 7572         X_pca_cur
-0001d740: 203d 2058 5f70 6361 5f73 656c 2e6c 6f63   = X_pca_sel.loc
-0001d750: 5b62 5f63 7572 2c3a 5d0a 2020 2020 2020  [b_cur,:].      
-0001d760: 2020 2020 2020 2020 2020 2020 2020 795f                y_
-0001d770: 636c 7573 745f 6375 7220 3d20 795f 636c  clust_cur = y_cl
-0001d780: 7573 745f 7365 6c5b 625f 6375 725d 0a0a  ust_sel[b_cur]..
-0001d790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d7a0: 2020 2020 2323 2052 6564 6f20 5043 4120      ## Redo PCA 
-0001d7b0: 616e 6420 436c 7573 7465 7269 6e67 2023  and Clustering #
-0001d7c0: 2323 2323 0a20 2020 2020 2020 2020 2020  ####.           
-0001d7d0: 2020 2020 2020 2020 2023 2074 6872 6573           # thres
-0001d7e0: 686f 6c64 696e 675f 7375 6273 6574 203d  holding_subset =
-0001d7f0: 2074 6872 6573 686f 6c64 696e 675f 6d73   thresholding_ms
-0001d800: 5b31 5d0a 2020 2020 2020 2020 2020 2020  [1].            
-0001d810: 2020 2020 2020 2020 2320 7063 745f 6375          # pct_cu
-0001d820: 746f 6666 5f73 7562 7365 7420 3d20 7063  toff_subset = pc
-0001d830: 745f 6375 746f 6666 5f6d 735b 315d 0a20  t_cutoff_ms[1]. 
-0001d840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d850: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-0001d860: 2020 2020 2020 2020 6966 206e 702e 7375          if np.su
-0001d870: 6d28 625f 6375 7229 203e 3d20 4e5f 636f  m(b_cur) >= N_co
-0001d880: 6d70 6f6e 656e 7473 5f70 6361 3a0a 2020  mponents_pca:.  
-0001d890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d8a0: 2020 2020 2020 5878 5f63 7572 203d 2058        Xx_cur = X
-0001d8b0: 5f70 7265 7072 6f63 6573 7369 6e67 2820  _preprocessing( 
-0001d8c0: 585f 6375 722c 206c 6f67 5f74 7261 6e73  X_cur, log_trans
-0001d8d0: 666f 726d 6564 2c20 4e5f 6765 6e65 7320  formed, N_genes 
-0001d8e0: 3d20 3230 3030 2029 0a20 2020 2020 2020  = 2000 ).       
-0001d8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d900: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-0001d910: 2020 2020 2020 2020 2020 2020 2020 585f                X_
-0001d920: 7063 615f 6375 7220 3d20 7063 612e 6669  pca_cur = pca.fi
-0001d930: 745f 7472 616e 7366 6f72 6d28 5878 5f63  t_transform(Xx_c
-0001d940: 7572 290a 2020 2020 2020 2020 2020 2020  ur).            
-0001d950: 2020 2020 2020 2020 2020 2020 585f 7063              X_pc
-0001d960: 615f 6375 7220 3d20 7064 2e44 6174 6146  a_cur = pd.DataF
-0001d970: 7261 6d65 2858 5f70 6361 5f63 7572 2c20  rame(X_pca_cur, 
-0001d980: 696e 6465 7820 3d20 585f 6375 722e 696e  index = X_cur.in
-0001d990: 6465 782c 200a 2020 2020 2020 2020 2020  dex, .          
-0001d9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d9c0: 2020 2020 2020 2063 6f6c 756d 6e73 203d         columns =
-0001d9d0: 206c 6973 7428 6e70 2e61 7261 6e67 6528   list(np.arange(
-0001d9e0: 696e 7428 4e5f 636f 6d70 6f6e 656e 7473  int(N_components
-0001d9f0: 5f70 6361 2929 2929 0a0a 2020 2020 2020  _pca))))..      
-0001da00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001da10: 2020 795f 636c 7573 745f 6375 722c 2063    y_clust_cur, c
-0001da20: 6f62 6a20 3d20 636c 7573 7465 7269 6e67  obj = clustering
-0001da30: 5f61 6c67 2858 5f70 6361 5f63 7572 2c20  _alg(X_pca_cur, 
-0001da40: 636c 7573 745f 616c 676f 203d 2043 6c75  clust_algo = Clu
-0001da50: 7374 6572 696e 675f 616c 676f 2c20 0a20  stering_algo, . 
-0001da60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001da70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001da80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001da90: 2020 2020 2020 4e5f 636c 7573 7465 7273        N_clusters
-0001daa0: 203d 204e 5f63 6f6d 702c 200a 2020 2020   = N_comp, .    
+0001d330: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+0001d340: 2020 2020 206d 6b72 5f6c 7374 2c20 6d6b       mkr_lst, mk
+0001d350: 725f 6c73 745f 6e65 6720 3d20 6765 745f  r_lst_neg = get_
+0001d360: 6d61 726b 6572 735f 6d69 6e6f 725f 7479  markers_minor_ty
+0001d370: 7065 3228 6d61 726b 6572 5f66 696c 652c  pe2(marker_file,
+0001d380: 2063 2c20 0a20 2020 2020 2020 2020 2020   c, .           
+0001d390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d3a0: 2020 2020 2020 2020 2070 6e73 6831 3220           pnsh12 
+0001d3b0: 3d20 6d6b 725f 7365 6c65 6374 6f72 2c20  = mkr_selector, 
+0001d3c0: 7265 6d5f 636f 6d6d 6f6e 203d 2072 656d  rem_common = rem
+0001d3d0: 5f63 6d6e 5f6d 6b72 2c0a 2020 2020 2020  _cmn_mkr,.      
+0001d3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d3f0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0001d400: 6d62 5f6d 6b72 7320 3d20 636f 6d62 5f6d  mb_mkrs = comb_m
+0001d410: 6b72 732c 2076 6572 626f 7365 203d 2046  krs, verbose = F
+0001d420: 616c 7365 290a 0a20 2020 2020 2020 2020  alse)..         
+0001d430: 2020 2020 2020 2069 6620 6c65 6e28 6d69         if len(mi
+0001d440: 6e6f 725f 7479 7065 735f 746f 5f65 7863  nor_types_to_exc
+0001d450: 6c75 6465 2920 3e20 303a 0a20 2020 2020  lude) > 0:.     
+0001d460: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0001d470: 6b72 5f6c 7374 203d 2072 656d 5f6d 696e  kr_lst = rem_min
+0001d480: 6f72 2820 6d6b 725f 6c73 742c 206d 696e  or( mkr_lst, min
+0001d490: 6f72 5f74 7970 6573 5f74 6f5f 6578 636c  or_types_to_excl
+0001d4a0: 7564 6520 290a 2020 2020 2020 2020 2020  ude ).          
+0001d4b0: 2020 2020 2020 2020 2020 6d6b 725f 6c73            mkr_ls
+0001d4c0: 745f 6e65 6720 3d20 7265 6d5f 6d69 6e6f  t_neg = rem_mino
+0001d4d0: 7228 206d 6b72 5f6c 7374 5f6e 6567 2c20  r( mkr_lst_neg, 
+0001d4e0: 6d69 6e6f 725f 7479 7065 735f 746f 5f65  minor_types_to_e
+0001d4f0: 7863 6c75 6465 2029 0a0a 2020 2020 2020  xclude )..      
+0001d500: 2020 2020 2020 2020 2020 736d 203d 2027            sm = '
+0001d510: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001d520: 2020 666f 7220 6b65 7920 696e 206d 6b72    for key in mkr
+0001d530: 5f6c 7374 2e6b 6579 7328 293a 0a20 2020  _lst.keys():.   
+0001d540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d550: 2073 6d20 3d20 736d 202b 2027 2573 2c27   sm = sm + '%s,'
+0001d560: 2025 206b 6579 0a0a 2020 2020 2020 2020   % key..        
+0001d570: 2020 2020 2020 2020 6966 2028 6c65 6e28          if (len(
+0001d580: 6c69 7374 286d 6b72 5f6c 7374 2e6b 6579  list(mkr_lst.key
+0001d590: 7328 2929 2920 3c3d 2031 2920 7c20 286e  s())) <= 1) | (n
+0001d5a0: 702e 7375 6d28 625f 6375 7229 203c 2031  p.sum(b_cur) < 1
+0001d5b0: 3029 3a0a 2020 2020 2020 2020 2020 2020  0):.            
+0001d5c0: 2020 2020 2020 2020 585f 6375 7220 3d20          X_cur = 
+0001d5d0: 585f 7365 6c2e 6c6f 635b 625f 6375 722c  X_sel.loc[b_cur,
+0001d5e0: 3a5d 0a20 2020 2020 2020 2020 2020 2020  :].             
+0001d5f0: 2020 2020 2020 2069 6478 203d 206c 6973         idx = lis
+0001d600: 7428 585f 6375 722e 696e 6465 782e 7661  t(X_cur.index.va
+0001d610: 6c75 6573 290a 2020 2020 2020 2020 2020  lues).          
+0001d620: 2020 2020 2020 2020 2020 6374 6e20 3d20            ctn = 
+0001d630: 2775 6e61 7373 6967 6e65 6427 0a20 2020  'unassigned'.   
+0001d640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d650: 2069 6620 6c65 6e28 6c69 7374 286d 6b72   if len(list(mkr
+0001d660: 5f6c 7374 2e6b 6579 7328 2929 2920 3d3d  _lst.keys())) ==
+0001d670: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+0001d680: 2020 2020 2020 2020 2020 2020 6374 6e20              ctn 
+0001d690: 3d20 6c69 7374 286d 6b72 5f6c 7374 2e6b  = list(mkr_lst.k
+0001d6a0: 6579 7328 2929 5b30 5d0a 2020 2020 2020  eys())[0].      
+0001d6b0: 2020 2020 2020 2020 2020 2020 2020 6466                df
+0001d6c0: 5f70 7265 642e 6c6f 635b 6964 782c 2763  _pred.loc[idx,'c
+0001d6d0: 656c 6c5f 7479 7065 5f73 7562 7365 7427  ell_type_subset'
+0001d6e0: 5d20 3d20 7374 7228 6374 6e29 0a20 2020  ] = str(ctn).   
+0001d6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d700: 2069 6620 7665 7262 6f73 653a 200a 2020   if verbose: .  
+0001d710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d720: 2020 2020 2020 7072 696e 7428 2725 7320        print('%s 
+0001d730: 7375 6273 6574 2069 6465 6e74 6966 6963  subset identific
+0001d740: 6174 696f 6e3a 2025 7327 2025 2028 7463  ation: %s' % (tc
+0001d750: 2c20 736d 5b3a 2d31 5d29 290a 0a20 2020  , sm[:-1]))..   
+0001d760: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0001d770: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001d780: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
+0001d790: 653a 200a 2020 2020 2020 2020 2020 2020  e: .            
+0001d7a0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0001d7b0: 7428 2725 7320 7375 6273 6574 2069 6465  t('%s subset ide
+0001d7c0: 6e74 6966 6963 6174 696f 6e3a 2025 7327  ntification: %s'
+0001d7d0: 2025 2028 7463 2c20 736d 5b3a 2d31 5d29   % (tc, sm[:-1])
+0001d7e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001d7f0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+0001d800: 2020 2020 2020 2020 2020 2020 2020 2058                 X
+0001d810: 5f63 7572 203d 2058 5f73 656c 2e6c 6f63  _cur = X_sel.loc
+0001d820: 5b62 5f63 7572 2c3a 5d0a 2020 2020 2020  [b_cur,:].      
+0001d830: 2020 2020 2020 2020 2020 2020 2020 585f                X_
+0001d840: 7063 615f 6375 7220 3d20 585f 7063 615f  pca_cur = X_pca_
+0001d850: 7365 6c2e 6c6f 635b 625f 6375 722c 3a5d  sel.loc[b_cur,:]
+0001d860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d870: 2020 2020 2079 5f63 6c75 7374 5f63 7572       y_clust_cur
+0001d880: 203d 2079 5f63 6c75 7374 5f73 656c 5b62   = y_clust_sel[b
+0001d890: 5f63 7572 5d0a 0a20 2020 2020 2020 2020  _cur]..         
+0001d8a0: 2020 2020 2020 2020 2020 2023 2320 5265             ## Re
+0001d8b0: 646f 2050 4341 2061 6e64 2043 6c75 7374  do PCA and Clust
+0001d8c0: 6572 696e 6720 2323 2323 230a 2020 2020  ering #####.    
+0001d8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d8e0: 2320 7468 7265 7368 6f6c 6469 6e67 5f73  # thresholding_s
+0001d8f0: 7562 7365 7420 3d20 7468 7265 7368 6f6c  ubset = threshol
+0001d900: 6469 6e67 5f6d 735b 315d 0a20 2020 2020  ding_ms[1].     
+0001d910: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001d920: 2070 6374 5f63 7574 6f66 665f 7375 6273   pct_cutoff_subs
+0001d930: 6574 203d 2070 6374 5f63 7574 6f66 665f  et = pct_cutoff_
+0001d940: 6d73 5b31 5d0a 2020 2020 2020 2020 2020  ms[1].          
+0001d950: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+0001d960: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001d970: 6620 6e70 2e73 756d 2862 5f63 7572 2920  f np.sum(b_cur) 
+0001d980: 3e3d 204e 5f63 6f6d 706f 6e65 6e74 735f  >= N_components_
+0001d990: 7063 613a 0a20 2020 2020 2020 2020 2020  pca:.           
+0001d9a0: 2020 2020 2020 2020 2020 2020 2058 785f               Xx_
+0001d9b0: 6375 7220 3d20 585f 7072 6570 726f 6365  cur = X_preproce
+0001d9c0: 7373 696e 6728 2058 5f63 7572 2c20 6c6f  ssing( X_cur, lo
+0001d9d0: 675f 7472 616e 7366 6f72 6d65 642c 204e  g_transformed, N
+0001d9e0: 5f67 656e 6573 203d 2032 3030 3020 290a  _genes = 2000 ).
+0001d9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001da00: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0001da10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001da20: 2020 2020 2058 5f70 6361 5f63 7572 203d       X_pca_cur =
+0001da30: 2070 6361 2e66 6974 5f74 7261 6e73 666f   pca.fit_transfo
+0001da40: 726d 2858 785f 6375 7229 0a20 2020 2020  rm(Xx_cur).     
+0001da50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001da60: 2020 2058 5f70 6361 5f63 7572 203d 2070     X_pca_cur = p
+0001da70: 642e 4461 7461 4672 616d 6528 585f 7063  d.DataFrame(X_pc
+0001da80: 615f 6375 722c 2069 6e64 6578 203d 2058  a_cur, index = X
+0001da90: 5f63 7572 2e69 6e64 6578 2c20 0a20 2020  _cur.index, .   
+0001daa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001dab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dae0: 2020 2072 6573 6f6c 7574 696f 6e20 3d20     resolution = 
-0001daf0: 436c 7573 7465 7269 6e67 5f72 6573 6f6c  Clustering_resol
-0001db00: 7574 696f 6e29 0a20 2020 2020 2020 2020  ution).         
-0001db10: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0001db20: 5f6d 616a 5f74 6d70 203d 2030 2e33 0a20  _maj_tmp = 0.3. 
-0001db30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001db40: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001db50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001db60: 2079 5f63 6c75 7374 5f63 7572 5b3a 5d20   y_clust_cur[:] 
-0001db70: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
-0001db80: 2020 2020 2020 2020 2020 2020 705f 6d61              p_ma
-0001db90: 6a5f 746d 7020 3d20 300a 2020 2020 2020  j_tmp = 0.      
-0001dba0: 2020 2020 2020 2020 2020 2020 2020 2323                ##
-0001dbb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001dbc0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+0001dac0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0001dad0: 6c75 6d6e 7320 3d20 6c69 7374 286e 702e  lumns = list(np.
+0001dae0: 6172 616e 6765 2869 6e74 284e 5f63 6f6d  arange(int(N_com
+0001daf0: 706f 6e65 6e74 735f 7063 6129 2929 290a  ponents_pca)))).
+0001db00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001db10: 2020 2020 2020 2020 2079 5f63 6c75 7374           y_clust
+0001db20: 5f63 7572 2c20 636f 626a 203d 2063 6c75  _cur, cobj = clu
+0001db30: 7374 6572 696e 675f 616c 6728 585f 7063  stering_alg(X_pc
+0001db40: 615f 6375 722c 2063 6c75 7374 5f61 6c67  a_cur, clust_alg
+0001db50: 6f20 3d20 436c 7573 7465 7269 6e67 5f61  o = Clustering_a
+0001db60: 6c67 6f2c 200a 2020 2020 2020 2020 2020  lgo, .          
+0001db70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001db80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001db90: 2020 2020 2020 2020 2020 2020 204e 5f63               N_c
+0001dba0: 6c75 7374 6572 7320 3d20 4e5f 636f 6d70  lusters = N_comp
+0001dbb0: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+0001dbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001dbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dbe0: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-0001dbf0: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
-0001dc00: 286d 6b72 5f6c 7374 290a 2020 2020 2020  (mkr_lst).      
-0001dc10: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0001dc20: 2075 7365 5f75 6e69 6f6e 3a0a 2020 2020   use_union:.    
-0001dc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dc40: 2020 2020 6466 5f70 6173 7320 3d20 4e6f      df_pass = No
-0001dc50: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
-0001dc60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001dc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dc80: 2020 2020 2073 7562 7365 7473 5f74 6f5f       subsets_to_
-0001dc90: 636f 6e73 6964 6572 203d 206c 6973 7428  consider = list(
-0001dca0: 6d6b 725f 6c73 742e 6b65 7973 2829 290a  mkr_lst.keys()).
-0001dcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dcc0: 2020 2020 2020 2020 2320 6466 5f70 6173          # df_pas
-0001dcd0: 7320 3d20 6466 5f47 5341 5f73 636f 7265  s = df_GSA_score
-0001dce0: 5f73 7562 7365 745f 616c 6c2e 6c6f 635b  _subset_all.loc[
-0001dcf0: 585f 7063 615f 6375 722e 696e 6465 782c  X_pca_cur.index,
-0001dd00: 2073 7562 7365 7473 5f74 6f5f 636f 6e73   subsets_to_cons
-0001dd10: 6964 6572 5d0a 2020 2020 2020 2020 2020  ider].          
-0001dd20: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0001dd30: 6466 6e5f 7375 6273 6574 203d 2064 666e  dfn_subset = dfn
-0001dd40: 5f73 7562 7365 745f 616c 6c2e 6c6f 635b  _subset_all.loc[
-0001dd50: 585f 7063 615f 6375 722e 696e 6465 782c  X_pca_cur.index,
-0001dd60: 2073 7562 7365 7473 5f74 6f5f 636f 6e73   subsets_to_cons
-0001dd70: 6964 6572 5d0a 0a20 2020 2020 2020 2020  ider]..         
-0001dd80: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0001dd90: 665f 7265 735f 7375 6273 6574 2c20 6466  f_res_subset, df
-0001dda0: 5f70 6173 732c 2064 666e 5f73 7562 7365  _pass, dfn_subse
-0001ddb0: 7420 3d20 5c0a 2020 2020 2020 2020 2020  t = \.          
-0001ddc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ddd0: 2020 4753 415f 6365 6c6c 5f73 7562 7479    GSA_cell_subty
-0001dde0: 7069 6e67 2820 585f 6375 722c 206d 6b72  ping( X_cur, mkr
-0001ddf0: 5f6c 7374 2c20 6d6b 725f 6c73 745f 6e65  _lst, mkr_lst_ne
-0001de00: 672c 2076 6572 626f 7365 203d 2076 6572  g, verbose = ver
-0001de10: 626f 7365 2029 0a20 2020 2020 2020 2020  bose ).         
-0001de20: 2020 2020 2020 2020 2020 2020 2020 200a                 .
-0001de30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001de40: 2020 2020 2323 2058 5f70 6361 5f63 7572      ## X_pca_cur
-0001de50: 2c20 636f 626a 2c20 795f 636c 7573 745f  , cobj, y_clust_
-0001de60: 6375 7220 6e6f 7420 7573 6564 2061 7320  cur not used as 
-0001de70: 7063 745f 6375 746f 6666 203d 2046 616c  pct_cutoff = Fal
-0001de80: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-0001de90: 2020 2020 2020 2064 665f 7265 735f 6375         df_res_cu
-0001dea0: 722c 2064 665f 7363 6f72 655f 6375 722c  r, df_score_cur,
-0001deb0: 2064 665f 4753 415f 7363 6f72 655f 6375   df_GSA_score_cu
-0001dec0: 7220 3d20 5c0a 2020 2020 2020 2020 2020  r = \.          
-0001ded0: 2020 2020 2020 2020 2020 2020 2020 7275                ru
-0001dee0: 6e5f 6773 615f 616e 645f 636c 6628 585f  n_gsa_and_clf(X_
-0001def0: 7063 615f 6375 722c 2058 5f63 7572 2c20  pca_cur, X_cur, 
-0001df00: 636f 626a 2c20 795f 636c 7573 745f 6375  cobj, y_clust_cu
-0001df10: 722c 206d 6b72 5f6c 7374 2c20 6d6b 725f  r, mkr_lst, mkr_
-0001df20: 6c73 745f 6e65 672c 200a 2020 2020 2020  lst_neg, .      
-0001df30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001df40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001df50: 2020 206d 6574 686f 6420 3d20 4e6f 6e65     method = None
-0001df60: 2c20 4e5f 636f 6d70 6f6e 656e 7473 203d  , N_components =
-0001df70: 204e 5f63 6f6d 706f 6e65 6e74 732c 2070   N_components, p
-0001df80: 7661 6c5f 7468 203d 2070 7661 6c5f 7468  val_th = pval_th
-0001df90: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-0001dfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dfb0: 2020 2020 2020 2020 2020 2020 7063 745f              pct_
-0001dfc0: 6669 745f 706e 7420 3d20 7074 685f 6669  fit_pnt = pth_fi
-0001dfd0: 745f 706e 742c 2070 6374 5f6d 696e 5f72  t_pnt, pct_min_r
-0001dfe0: 6620 3d20 7063 745f 7468 5f6d 696e 2c0a  f = pct_th_min,.
-0001dff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e010: 2020 2020 2020 2020 2054 6172 6765 745f           Target_
-0001e020: 4650 5220 3d20 5461 7267 6574 5f46 5052  FPR = Target_FPR
-0001e030: 2c20 706d 616a 203d 2070 5f6d 616a 5f74  , pmaj = p_maj_t
-0001e040: 6d70 2c20 6d69 6e6f 725f 6964 5f73 6570  mp, minor_id_sep
-0001e050: 203d 206d 696e 6f72 5f69 645f 7365 702c   = minor_id_sep,
-0001e060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e080: 2020 2020 2020 2020 2020 6d69 6e5f 6c6f            min_lo
-0001e090: 6750 5f64 6966 6620 3d20 6d69 6e5f 6c6f  gP_diff = min_lo
-0001e0a0: 6750 5f64 6966 662c 2074 6872 6573 686f  gP_diff, thresho
-0001e0b0: 6c64 696e 6720 3d20 7468 7265 7368 6f6c  lding = threshol
-0001e0c0: 6469 6e67 5f73 7562 7365 742c 0a20 2020  ding_subset,.   
-0001e0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e0f0: 2020 2020 2020 7063 745f 6375 746f 6666        pct_cutoff
-0001e100: 203d 2046 616c 7365 2c20 6362 635f 6375   = False, cbc_cu
-0001e110: 746f 6666 203d 2063 6263 5f63 7574 6f66  toff = cbc_cutof
-0001e120: 662c 2070 7269 6e74 5f72 6570 6f72 7420  f, print_report 
-0001e130: 3d20 7665 7262 6f73 652c 0a20 2020 2020  = verbose,.     
-0001e140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e160: 2020 2020 6466 5f47 5341 5f73 636f 7265      df_GSA_score
-0001e170: 203d 2064 665f 7061 7373 290a 0a20 2020   = df_pass)..   
+0001dbe0: 2020 2020 2020 2020 2020 7265 736f 6c75            resolu
+0001dbf0: 7469 6f6e 203d 2043 6c75 7374 6572 696e  tion = Clusterin
+0001dc00: 675f 7265 736f 6c75 7469 6f6e 290a 2020  g_resolution).  
+0001dc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dc20: 2020 2020 2020 705f 6d61 6a5f 746d 7020        p_maj_tmp 
+0001dc30: 3d20 302e 330a 2020 2020 2020 2020 2020  = 0.3.          
+0001dc40: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0001dc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dc60: 2020 2020 2020 2020 795f 636c 7573 745f          y_clust_
+0001dc70: 6375 725b 3a5d 203d 2030 0a20 2020 2020  cur[:] = 0.     
+0001dc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dc90: 2020 2070 5f6d 616a 5f74 6d70 203d 2030     p_maj_tmp = 0
+0001dca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001dcb0: 2020 2020 2023 2323 2323 2323 2323 2323       ###########
+0001dcc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001dcd0: 2323 2323 2323 0a20 2020 2020 2020 2020  ######.         
+0001dce0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+0001dcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dd00: 2320 7072 696e 7428 6d6b 725f 6c73 7429  # print(mkr_lst)
+0001dd10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001dd20: 2020 2020 2069 6620 7573 655f 756e 696f       if use_unio
+0001dd30: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+0001dd40: 2020 2020 2020 2020 2020 2064 665f 7061             df_pa
+0001dd50: 7373 203d 204e 6f6e 650a 2020 2020 2020  ss = None.      
+0001dd60: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0001dd70: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001dd80: 2020 2020 2020 2020 2020 2020 7375 6273              subs
+0001dd90: 6574 735f 746f 5f63 6f6e 7369 6465 7220  ets_to_consider 
+0001dda0: 3d20 6c69 7374 286d 6b72 5f6c 7374 2e6b  = list(mkr_lst.k
+0001ddb0: 6579 7328 2929 0a20 2020 2020 2020 2020  eys()).         
+0001ddc0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001ddd0: 2064 665f 7061 7373 203d 2064 665f 4753   df_pass = df_GS
+0001dde0: 415f 7363 6f72 655f 7375 6273 6574 5f61  A_score_subset_a
+0001ddf0: 6c6c 2e6c 6f63 5b58 5f70 6361 5f63 7572  ll.loc[X_pca_cur
+0001de00: 2e69 6e64 6578 2c20 7375 6273 6574 735f  .index, subsets_
+0001de10: 746f 5f63 6f6e 7369 6465 725d 0a20 2020  to_consider].   
+0001de20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001de30: 2020 2020 2023 2064 666e 5f73 7562 7365       # dfn_subse
+0001de40: 7420 3d20 6466 6e5f 7375 6273 6574 5f61  t = dfn_subset_a
+0001de50: 6c6c 2e6c 6f63 5b58 5f70 6361 5f63 7572  ll.loc[X_pca_cur
+0001de60: 2e69 6e64 6578 2c20 7375 6273 6574 735f  .index, subsets_
+0001de70: 746f 5f63 6f6e 7369 6465 725d 0a0a 2020  to_consider]..  
+0001de80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001de90: 2020 2020 2020 6466 5f72 6573 5f73 7562        df_res_sub
+0001dea0: 7365 742c 2064 665f 7061 7373 2c20 6466  set, df_pass, df
+0001deb0: 6e5f 7375 6273 6574 203d 205c 0a20 2020  n_subset = \.   
+0001dec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ded0: 2020 2020 2020 2020 2047 5341 5f63 656c           GSA_cel
+0001dee0: 6c5f 7375 6274 7970 696e 6728 2058 5f63  l_subtyping( X_c
+0001def0: 7572 2c20 6d6b 725f 6c73 742c 206d 6b72  ur, mkr_lst, mkr
+0001df00: 5f6c 7374 5f6e 6567 2c20 7665 7262 6f73  _lst_neg, verbos
+0001df10: 6520 3d20 7665 7262 6f73 6520 290a 2020  e = verbose ).  
+0001df20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001df30: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+0001df40: 2020 2020 2020 2020 2020 2023 2320 585f             ## X_
+0001df50: 7063 615f 6375 722c 2063 6f62 6a2c 2079  pca_cur, cobj, y
+0001df60: 5f63 6c75 7374 5f63 7572 206e 6f74 2075  _clust_cur not u
+0001df70: 7365 6420 6173 2070 6374 5f63 7574 6f66  sed as pct_cutof
+0001df80: 6620 3d20 4661 6c73 650a 2020 2020 2020  f = False.      
+0001df90: 2020 2020 2020 2020 2020 2020 2020 6466                df
+0001dfa0: 5f72 6573 5f63 7572 2c20 6466 5f73 636f  _res_cur, df_sco
+0001dfb0: 7265 5f63 7572 2c20 6466 5f47 5341 5f73  re_cur, df_GSA_s
+0001dfc0: 636f 7265 5f63 7572 203d 205c 0a20 2020  core_cur = \.   
+0001dfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dfe0: 2020 2020 2072 756e 5f67 7361 5f61 6e64       run_gsa_and
+0001dff0: 5f63 6c66 2858 5f70 6361 5f63 7572 2c20  _clf(X_pca_cur, 
+0001e000: 585f 6375 722c 2063 6f62 6a2c 2079 5f63  X_cur, cobj, y_c
+0001e010: 6c75 7374 5f63 7572 2c20 6d6b 725f 6c73  lust_cur, mkr_ls
+0001e020: 742c 206d 6b72 5f6c 7374 5f6e 6567 2c20  t, mkr_lst_neg, 
+0001e030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e050: 2020 2020 2020 2020 2020 6d65 7468 6f64            method
+0001e060: 203d 204e 6f6e 652c 204e 5f63 6f6d 706f   = None, N_compo
+0001e070: 6e65 6e74 7320 3d20 4e5f 636f 6d70 6f6e  nents = N_compon
+0001e080: 656e 7473 2c20 7076 616c 5f74 6820 3d20  ents, pval_th = 
+0001e090: 7076 616c 5f74 682c 200a 2020 2020 2020  pval_th, .      
+0001e0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e0c0: 2020 2070 6374 5f66 6974 5f70 6e74 203d     pct_fit_pnt =
+0001e0d0: 2070 7468 5f66 6974 5f70 6e74 2c20 7063   pth_fit_pnt, pc
+0001e0e0: 745f 6d69 6e5f 7266 203d 2070 6374 5f74  t_min_rf = pct_t
+0001e0f0: 685f 6d69 6e2c 0a20 2020 2020 2020 2020  h_min,.         
+0001e100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e120: 5461 7267 6574 5f46 5052 203d 2054 6172  Target_FPR = Tar
+0001e130: 6765 745f 4650 522c 2070 6d61 6a20 3d20  get_FPR, pmaj = 
+0001e140: 705f 6d61 6a5f 746d 702c 206d 696e 6f72  p_maj_tmp, minor
+0001e150: 5f69 645f 7365 7020 3d20 6d69 6e6f 725f  _id_sep = minor_
+0001e160: 6964 5f73 6570 2c0a 2020 2020 2020 2020  id_sep,.        
+0001e170: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001e180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e190: 2069 6620 6e6f 7420 7573 655f 756e 696f   if not use_unio
-0001e1a0: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
-0001e1b0: 2020 2020 2020 2020 2020 2069 6478 7320             idxs 
-0001e1c0: 3d20 6466 5f72 6573 5f63 7572 2e69 6e64  = df_res_cur.ind
-0001e1d0: 6578 2e76 616c 7565 730a 2020 2020 2020  ex.values.      
+0001e190: 206d 696e 5f6c 6f67 505f 6469 6666 203d   min_logP_diff =
+0001e1a0: 206d 696e 5f6c 6f67 505f 6469 6666 2c20   min_logP_diff, 
+0001e1b0: 7468 7265 7368 6f6c 6469 6e67 203d 2074  thresholding = t
+0001e1c0: 6872 6573 686f 6c64 696e 675f 7375 6273  hresholding_subs
+0001e1d0: 6574 2c0a 2020 2020 2020 2020 2020 2020  et,.            
 0001e1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e1f0: 2020 666f 7220 6b2c 2069 6478 2069 6e20    for k, idx in 
-0001e200: 656e 756d 6572 6174 6528 6c69 7374 2869  enumerate(list(i
-0001e210: 6478 7329 293a 0a20 2020 2020 2020 2020  dxs)):.         
-0001e220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e230: 2020 2063 7420 3d20 6466 5f72 6573 5f63     ct = df_res_c
-0001e240: 7572 2e6c 6f63 5b69 6478 2c20 2763 656c  ur.loc[idx, 'cel
-0001e250: 6c5f 7479 7065 2831 7374 2927 5d0a 2020  l_type(1st)'].  
-0001e260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e270: 2020 2020 2020 2020 2020 6466 5f72 6573            df_res
-0001e280: 5f63 7572 2e6c 6f63 5b69 6478 2c20 274f  _cur.loc[idx, 'O
-0001e290: 7665 726c 6170 275d 203d 2064 666e 5f73  verlap'] = dfn_s
-0001e2a0: 7562 7365 742e 6c6f 635b 6964 782c 6374  ubset.loc[idx,ct
-0001e2b0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0001e2c0: 2020 2020 2020 2020 2020 2020 2020 6374                ct
-0001e2d0: 203d 2064 665f 7265 735f 6375 722e 6c6f   = df_res_cur.lo
-0001e2e0: 635b 6964 782c 2027 6365 6c6c 5f74 7970  c[idx, 'cell_typ
-0001e2f0: 6528 326e 6429 275d 0a20 2020 2020 2020  e(2nd)'].       
-0001e300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e310: 2020 2020 2064 665f 7265 735f 6375 722e       df_res_cur.
-0001e320: 6c6f 635b 6964 782c 2027 4f76 6572 6c61  loc[idx, 'Overla
-0001e330: 7028 326e 6429 275d 203d 2064 666e 5f73  p(2nd)'] = dfn_s
-0001e340: 7562 7365 742e 6c6f 635b 6964 782c 6374  ubset.loc[idx,ct
-0001e350: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0001e360: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+0001e1f0: 2020 2020 2020 2020 2020 2020 2070 6374               pct
+0001e200: 5f63 7574 6f66 6620 3d20 4661 6c73 652c  _cutoff = False,
+0001e210: 2063 6263 5f63 7574 6f66 6620 3d20 6362   cbc_cutoff = cb
+0001e220: 635f 6375 746f 6666 2c20 7072 696e 745f  c_cutoff, print_
+0001e230: 7265 706f 7274 203d 2076 6572 626f 7365  report = verbose
+0001e240: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001e250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e260: 2020 2020 2020 2020 2020 2064 665f 4753             df_GS
+0001e270: 415f 7363 6f72 6520 3d20 6466 5f70 6173  A_score = df_pas
+0001e280: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
+0001e290: 2020 2020 2020 2020 6966 206e 6f74 2075          if not u
+0001e2a0: 7365 5f75 6e69 6f6e 3a0a 2020 2020 2020  se_union:.      
+0001e2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e2c0: 2020 6964 7873 203d 2064 665f 7265 735f    idxs = df_res_
+0001e2d0: 6375 722e 696e 6465 782e 7661 6c75 6573  cur.index.values
+0001e2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e2f0: 2020 2020 2020 2020 2066 6f72 206b 2c20           for k, 
+0001e300: 6964 7820 696e 2065 6e75 6d65 7261 7465  idx in enumerate
+0001e310: 286c 6973 7428 6964 7873 2929 3a0a 2020  (list(idxs)):.  
+0001e320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e330: 2020 2020 2020 2020 2020 6374 203d 2064            ct = d
+0001e340: 665f 7265 735f 6375 722e 6c6f 635b 6964  f_res_cur.loc[id
+0001e350: 782c 2027 6365 6c6c 5f74 7970 6528 3173  x, 'cell_type(1s
+0001e360: 7429 275d 0a20 2020 2020 2020 2020 2020  t)'].           
 0001e370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e380: 2020 2063 7473 203d 206c 6973 7428 6d6b     cts = list(mk
-0001e390: 725f 6c73 742e 6b65 7973 2829 290a 2020  r_lst.keys()).  
-0001e3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e3b0: 2020 6966 206c 656e 2863 7473 2920 3e20    if len(cts) > 
-0001e3c0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-0001e3d0: 2020 2020 2020 2020 2020 2062 7820 3d20             bx = 
-0001e3e0: 6466 5f72 6573 5f63 7572 5b27 2d6c 6f67  df_res_cur['-log
-0001e3f0: 5027 5d20 3c20 2d6e 702e 6c6f 6731 3028  P'] < -np.log10(
-0001e400: 2070 7661 6c5f 7468 5f73 7562 7365 7420   pval_th_subset 
-0001e410: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001e420: 2020 2020 2020 2020 2020 6466 5f72 6573            df_res
-0001e430: 5f63 7572 2e6c 6f63 5b62 782c 2027 6365  _cur.loc[bx, 'ce
-0001e440: 6c6c 5f74 7970 6527 5d20 3d20 2775 6e61  ll_type'] = 'una
-0001e450: 7373 6967 6e65 6427 2020 2020 200a 2020  ssigned'     .  
+0001e380: 2064 665f 7265 735f 6375 722e 6c6f 635b   df_res_cur.loc[
+0001e390: 6964 782c 2027 4f76 6572 6c61 7027 5d20  idx, 'Overlap'] 
+0001e3a0: 3d20 6466 6e5f 7375 6273 6574 2e6c 6f63  = dfn_subset.loc
+0001e3b0: 5b69 6478 2c63 745d 0a20 2020 2020 2020  [idx,ct].       
+0001e3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e3d0: 2020 2020 2063 7420 3d20 6466 5f72 6573       ct = df_res
+0001e3e0: 5f63 7572 2e6c 6f63 5b69 6478 2c20 2763  _cur.loc[idx, 'c
+0001e3f0: 656c 6c5f 7479 7065 2832 6e64 2927 5d0a  ell_type(2nd)'].
+0001e400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e410: 2020 2020 2020 2020 2020 2020 6466 5f72              df_r
+0001e420: 6573 5f63 7572 2e6c 6f63 5b69 6478 2c20  es_cur.loc[idx, 
+0001e430: 274f 7665 726c 6170 2832 6e64 2927 5d20  'Overlap(2nd)'] 
+0001e440: 3d20 6466 6e5f 7375 6273 6574 2e6c 6f63  = dfn_subset.loc
+0001e450: 5b69 6478 2c63 745d 0a20 2020 2020 2020  [idx,ct].       
 0001e460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e470: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
-0001e480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e490: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001e4a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001e4b0: 230a 2020 2020 2020 2020 2020 2020 2020  #.              
-0001e4c0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-0001e4d0: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-0001e4e0: 5f70 7265 645f 6375 7220 3d20 6466 5f72  _pred_cur = df_r
-0001e4f0: 6573 5f63 7572 5b27 6365 6c6c 5f74 7970  es_cur['cell_typ
-0001e500: 6527 5d0a 2020 2020 2020 2020 2020 2020  e'].            
-0001e510: 2020 2020 2020 2020 7973 5f63 7572 203d          ys_cur =
-0001e520: 2064 665f 7265 735f 6375 725b 2763 656c   df_res_cur['cel
-0001e530: 6c5f 7479 7065 2872 6576 2927 5d0a 0a20  l_type(rev)'].. 
-0001e540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e550: 2020 2069 6620 7573 655f 6d69 6e6f 723a     if use_minor:
-0001e560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e570: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
-0001e580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e590: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001e5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e5b0: 6966 2064 665f 4753 415f 7363 6f72 655f  if df_GSA_score_
-0001e5c0: 6375 7220 6973 206e 6f74 204e 6f6e 653a  cur is not None:
-0001e5d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e5e0: 2020 2020 2020 2020 2020 2020 200a 2020               .  
-0001e5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e600: 2020 2020 2020 2020 2020 636f 6c73 203d            cols =
-0001e610: 2064 665f 4753 415f 7363 6f72 655f 6375   df_GSA_score_cu
-0001e620: 722e 636f 6c75 6d6e 732e 7661 6c75 6573  r.columns.values
-0001e630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e640: 2020 2020 2020 2020 2020 2020 2069 6478               idx
-0001e650: 7320 3d20 6466 5f47 5341 5f73 636f 7265  s = df_GSA_score
-0001e660: 5f63 7572 2e69 6e64 6578 2e76 616c 7565  _cur.index.value
-0001e670: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0001e680: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
-0001e690: 6e6f 725f 7479 7065 5f6c 7374 5f61 6c6c  nor_type_lst_all
-0001e6a0: 203d 206c 6973 7428 6466 5f47 5341 5f73   = list(df_GSA_s
-0001e6b0: 636f 7265 5f6d 696e 6f72 5f61 6c6c 2e63  core_minor_all.c
-0001e6c0: 6f6c 756d 6e73 2e76 616c 7565 7329 0a20  olumns.values). 
-0001e6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e6e0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-0001e6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e700: 2020 2020 2020 2020 6d69 6e6f 725f 7479          minor_ty
-0001e710: 7065 5f6c 7374 5f63 7572 203d 205b 5d0a  pe_lst_cur = [].
-0001e720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e730: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0001e740: 6378 2069 6e20 6c69 7374 2863 6f6c 7329  cx in list(cols)
-0001e750: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001e760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e770: 2020 6d69 6e6f 725f 7479 7065 203d 206d    minor_type = m
-0001e780: 6170 5f64 6963 745f 7375 6232 6d69 6e5b  ap_dict_sub2min[
-0001e790: 6378 5d0a 2020 2020 2020 2020 2020 2020  cx].            
-0001e7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e7b0: 2020 2020 6966 206d 696e 6f72 5f74 7970      if minor_typ
-0001e7c0: 6520 696e 206d 696e 6f72 5f74 7970 655f  e in minor_type_
-0001e7d0: 6c73 745f 616c 6c3a 0a20 2020 2020 2020  lst_all:.       
+0001e470: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+0001e480: 2020 2020 2020 2020 2020 6374 7320 3d20            cts = 
+0001e490: 6c69 7374 286d 6b72 5f6c 7374 2e6b 6579  list(mkr_lst.key
+0001e4a0: 7328 2929 0a20 2020 2020 2020 2020 2020  s()).           
+0001e4b0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+0001e4c0: 6374 7329 203e 2031 3a0a 2020 2020 2020  cts) > 1:.      
+0001e4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e4e0: 2020 6278 203d 2064 665f 7265 735f 6375    bx = df_res_cu
+0001e4f0: 725b 272d 6c6f 6750 275d 203c 202d 6e70  r['-logP'] < -np
+0001e500: 2e6c 6f67 3130 2820 7076 616c 5f74 685f  .log10( pval_th_
+0001e510: 7375 6273 6574 2029 0a20 2020 2020 2020  subset ).       
+0001e520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e530: 2064 665f 7265 735f 6375 722e 6c6f 635b   df_res_cur.loc[
+0001e540: 6278 2c20 2763 656c 6c5f 7479 7065 275d  bx, 'cell_type']
+0001e550: 203d 2027 756e 6173 7369 676e 6564 2720   = 'unassigned' 
+0001e560: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+0001e570: 2020 2020 2020 2020 2020 2020 2070 6173               pas
+0001e580: 730a 0a20 2020 2020 2020 2020 2020 2020  s..             
+0001e590: 2020 2020 2020 2023 2323 2323 2323 2323         #########
+0001e5a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001e5b0: 2323 2323 2323 2323 0a20 2020 2020 2020  ########.       
+0001e5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e5d0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+0001e5e0: 2020 2020 2020 795f 7072 6564 5f63 7572        y_pred_cur
+0001e5f0: 203d 2064 665f 7265 735f 6375 725b 2763   = df_res_cur['c
+0001e600: 656c 6c5f 7479 7065 275d 0a20 2020 2020  ell_type'].     
+0001e610: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+0001e620: 735f 6375 7220 3d20 6466 5f72 6573 5f63  s_cur = df_res_c
+0001e630: 7572 5b27 6365 6c6c 5f74 7970 6528 7265  ur['cell_type(re
+0001e640: 7629 275d 0a0a 2020 2020 2020 2020 2020  v)']..          
+0001e650: 2020 2020 2020 2020 2020 6966 2075 7365            if use
+0001e660: 5f6d 696e 6f72 3a0a 2020 2020 2020 2020  _minor:.        
+0001e670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e680: 7061 7373 0a20 2020 2020 2020 2020 2020  pass.           
+0001e690: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0001e6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e6b0: 2020 2020 2020 2069 6620 6466 5f47 5341         if df_GSA
+0001e6c0: 5f73 636f 7265 5f63 7572 2069 7320 6e6f  _score_cur is no
+0001e6d0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0001e6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e6f0: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+0001e700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e710: 2063 6f6c 7320 3d20 6466 5f47 5341 5f73   cols = df_GSA_s
+0001e720: 636f 7265 5f63 7572 2e63 6f6c 756d 6e73  core_cur.columns
+0001e730: 2e76 616c 7565 730a 2020 2020 2020 2020  .values.        
+0001e740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e750: 2020 2020 6964 7873 203d 2064 665f 4753      idxs = df_GS
+0001e760: 415f 7363 6f72 655f 6375 722e 696e 6465  A_score_cur.inde
+0001e770: 782e 7661 6c75 6573 0a20 2020 2020 2020  x.values.       
+0001e780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e790: 2020 2020 206d 696e 6f72 5f74 7970 655f       minor_type_
+0001e7a0: 6c73 745f 616c 6c20 3d20 6c69 7374 2864  lst_all = list(d
+0001e7b0: 665f 4753 415f 7363 6f72 655f 6d69 6e6f  f_GSA_score_mino
+0001e7c0: 725f 616c 6c2e 636f 6c75 6d6e 732e 7661  r_all.columns.va
+0001e7d0: 6c75 6573 290a 2020 2020 2020 2020 2020  lues).          
 0001e7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e7f0: 2020 2020 2020 2020 2020 2020 206d 696e               min
-0001e800: 6f72 5f74 7970 655f 6c73 745f 6375 722e  or_type_lst_cur.
-0001e810: 6170 7065 6e64 286d 696e 6f72 5f74 7970  append(minor_typ
-0001e820: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-0001e830: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001e840: 696e 6f72 5f74 7970 655f 6c73 745f 6375  inor_type_lst_cu
-0001e850: 7220 3d20 6c69 7374 2873 6574 286d 696e  r = list(set(min
-0001e860: 6f72 5f74 7970 655f 6c73 745f 6375 7229  or_type_lst_cur)
-0001e870: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001e880: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-0001e890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e8a0: 2020 2020 2020 2020 2020 2023 2070 7269             # pri
-0001e8b0: 6e74 286d 696e 6f72 5f74 7970 655f 6c73  nt(minor_type_ls
-0001e8c0: 745f 6375 722c 2066 6c75 7368 203d 2054  t_cur, flush = T
-0001e8d0: 7275 6529 0a0a 2020 2020 2020 2020 2020  rue)..          
+0001e7f0: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
+0001e800: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0001e810: 696e 6f72 5f74 7970 655f 6c73 745f 6375  inor_type_lst_cu
+0001e820: 7220 3d20 5b5d 0a20 2020 2020 2020 2020  r = [].         
+0001e830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e840: 2020 2066 6f72 2063 7820 696e 206c 6973     for cx in lis
+0001e850: 7428 636f 6c73 293a 0a20 2020 2020 2020  t(cols):.       
+0001e860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e870: 2020 2020 2020 2020 206d 696e 6f72 5f74           minor_t
+0001e880: 7970 6520 3d20 6d61 705f 6469 6374 5f73  ype = map_dict_s
+0001e890: 7562 326d 696e 5b63 785d 0a20 2020 2020  ub2min[cx].     
+0001e8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e8b0: 2020 2020 2020 2020 2020 2069 6620 6d69             if mi
+0001e8c0: 6e6f 725f 7479 7065 2069 6e20 6d69 6e6f  nor_type in mino
+0001e8d0: 725f 7479 7065 5f6c 7374 5f61 6c6c 3a0a  r_type_lst_all:.
 0001e8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e8f0: 2020 2323 20ec 8898 eca0 9520 ed95 84ec    ## ...... ....
-0001e900: 9a94 0a20 2020 2020 2020 2020 2020 2020  ...             
-0001e910: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0001e920: 665f 4753 415f 7363 6f72 655f 6d69 6e6f  f_GSA_score_mino
-0001e930: 725f 6375 7220 3d20 6466 5f47 5341 5f73  r_cur = df_GSA_s
-0001e940: 636f 7265 5f6d 696e 6f72 5f61 6c6c 2e6c  core_minor_all.l
-0001e950: 6f63 5b69 6478 732c 206d 696e 6f72 5f74  oc[idxs, minor_t
-0001e960: 7970 655f 6c73 745f 6375 725d 2e63 6f70  ype_lst_cur].cop
-0001e970: 7928 6465 6570 203d 2054 7275 6529 0a20  y(deep = True). 
+0001e8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e900: 2020 2020 6d69 6e6f 725f 7479 7065 5f6c      minor_type_l
+0001e910: 7374 5f63 7572 2e61 7070 656e 6428 6d69  st_cur.append(mi
+0001e920: 6e6f 725f 7479 7065 290a 2020 2020 2020  nor_type).      
+0001e930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e940: 2020 2020 2020 6d69 6e6f 725f 7479 7065        minor_type
+0001e950: 5f6c 7374 5f63 7572 203d 206c 6973 7428  _lst_cur = list(
+0001e960: 7365 7428 6d69 6e6f 725f 7479 7065 5f6c  set(minor_type_l
+0001e970: 7374 5f63 7572 2929 0a20 2020 2020 2020  st_cur)).       
 0001e980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e990: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+0001e990: 2020 2020 200a 2020 2020 2020 2020 2020       .          
 0001e9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e9b0: 2020 2020 2020 2020 2323 2323 2323 2323          ########
-0001e9c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001e9d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001e9e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001e9f0: 230a 2020 2020 2020 2020 2020 2020 2020  #.              
-0001ea00: 2020 2020 2020 2020 2020 2020 2020 2323                ##
-0001ea10: 2055 7064 6174 6520 6d69 6e6f 7220 7479   Update minor ty
-0001ea20: 7065 2047 5341 2073 636f 7265 0a20 2020  pe GSA score.   
-0001ea30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ea40: 2020 2020 2020 2020 2027 2727 0a20 2020           '''.   
-0001ea50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ea60: 2020 2020 2020 2020 2064 665f 4753 415f           df_GSA_
-0001ea70: 7363 6f72 655f 6d69 6e6f 725f 6375 7220  score_minor_cur 
-0001ea80: 3d20 7064 2e44 6174 6146 7261 6d65 2869  = pd.DataFrame(i
-0001ea90: 6e64 6578 203d 2069 6478 732c 2063 6f6c  ndex = idxs, col
-0001eaa0: 756d 6e73 203d 206d 696e 6f72 5f74 7970  umns = minor_typ
-0001eab0: 655f 6c73 745f 6375 7229 0a20 2020 2020  e_lst_cur).     
-0001eac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ead0: 2020 2020 2020 2066 6f72 206d 696e 6f72         for minor
-0001eae0: 2069 6e20 6d61 705f 6469 6374 5f6d 696e   in map_dict_min
-0001eaf0: 3273 7562 2e6b 6579 7328 293a 0a20 2020  2sub.keys():.   
+0001e9b0: 2020 2320 7072 696e 7428 6d69 6e6f 725f    # print(minor_
+0001e9c0: 7479 7065 5f6c 7374 5f63 7572 2c20 666c  type_lst_cur, fl
+0001e9d0: 7573 6820 3d20 5472 7565 290a 0a20 2020  ush = True)..   
+0001e9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e9f0: 2020 2020 2020 2020 2023 2320 ec88 98ec           ## ....
+0001ea00: a095 20ed 9584 ec9a 940a 2020 2020 2020  .. .......      
+0001ea10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ea20: 2020 2020 2020 6466 5f47 5341 5f73 636f        df_GSA_sco
+0001ea30: 7265 5f6d 696e 6f72 5f63 7572 203d 2064  re_minor_cur = d
+0001ea40: 665f 4753 415f 7363 6f72 655f 6d69 6e6f  f_GSA_score_mino
+0001ea50: 725f 616c 6c2e 6c6f 635b 6964 7873 2c20  r_all.loc[idxs, 
+0001ea60: 6d69 6e6f 725f 7479 7065 5f6c 7374 5f63  minor_type_lst_c
+0001ea70: 7572 5d2e 636f 7079 2864 6565 7020 3d20  ur].copy(deep = 
+0001ea80: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+0001ea90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eaa0: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
+0001eab0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001eac0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001ead0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001eae0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001eaf0: 2323 2323 2323 2323 0a20 2020 2020 2020  ########.       
 0001eb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eb10: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001eb20: 6d69 6e6f 7220 696e 206d 696e 6f72 5f74  minor in minor_t
-0001eb30: 7970 655f 6c73 745f 6375 723a 0a20 2020  ype_lst_cur:.   
+0001eb10: 2020 2020 2023 2320 5570 6461 7465 206d       ## Update m
+0001eb20: 696e 6f72 2074 7970 6520 4753 4120 7363  inor type GSA sc
+0001eb30: 6f72 650a 2020 2020 2020 2020 2020 2020  ore.            
 0001eb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eb60: 2073 7562 5f6c 7374 203d 206d 6170 5f64   sub_lst = map_d
-0001eb70: 6963 745f 6d69 6e32 7375 625b 6d69 6e6f  ict_min2sub[mino
-0001eb80: 725d 0a20 2020 2020 2020 2020 2020 2020  r].             
-0001eb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eba0: 2020 2020 2020 2062 6573 745f 7363 6f72         best_scor
-0001ebb0: 6520 3d20 6466 5f47 5341 5f73 636f 7265  e = df_GSA_score
-0001ebc0: 5f63 7572 5b73 7562 5f6c 7374 5d2e 6d61  _cur[sub_lst].ma
-0001ebd0: 7828 6178 6973 203d 2031 290a 2020 2020  x(axis = 1).    
-0001ebe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ebf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ec00: 6466 5f47 5341 5f73 636f 7265 5f6d 696e  df_GSA_score_min
-0001ec10: 6f72 5f63 7572 5b6d 696e 6f72 5d20 3d20  or_cur[minor] = 
-0001ec20: 6265 7374 5f73 636f 7265 200a 2020 2020  best_score .    
-0001ec30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ec40: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0001eb50: 2727 270a 2020 2020 2020 2020 2020 2020  '''.            
+0001eb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eb70: 6466 5f47 5341 5f73 636f 7265 5f6d 696e  df_GSA_score_min
+0001eb80: 6f72 5f63 7572 203d 2070 642e 4461 7461  or_cur = pd.Data
+0001eb90: 4672 616d 6528 696e 6465 7820 3d20 6964  Frame(index = id
+0001eba0: 7873 2c20 636f 6c75 6d6e 7320 3d20 6d69  xs, columns = mi
+0001ebb0: 6e6f 725f 7479 7065 5f6c 7374 5f63 7572  nor_type_lst_cur
+0001ebc0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001ebd0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0001ebe0: 7220 6d69 6e6f 7220 696e 206d 6170 5f64  r minor in map_d
+0001ebf0: 6963 745f 6d69 6e32 7375 622e 6b65 7973  ict_min2sub.keys
+0001ec00: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0001ec10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ec20: 2020 2020 6966 206d 696e 6f72 2069 6e20      if minor in 
+0001ec30: 6d69 6e6f 725f 7479 7065 5f6c 7374 5f63  minor_type_lst_c
+0001ec40: 7572 3a0a 2020 2020 2020 2020 2020 2020  ur:.            
 0001ec50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ec60: 2020 2020 2020 2020 2079 5f70 7265 645f           y_pred_
-0001ec70: 6d69 6e6f 725f 6375 7220 3d20 6466 5f47  minor_cur = df_G
-0001ec80: 5341 5f73 636f 7265 5f6d 696e 6f72 5f63  SA_score_minor_c
-0001ec90: 7572 2e69 6478 6d61 7828 6178 6973 203d  ur.idxmax(axis =
-0001eca0: 2031 290a 2020 2020 2020 2020 2020 2020   1).            
-0001ecb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ecc0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0001ecd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ece0: 2020 2020 2079 5f63 6c75 7374 2c20 636f       y_clust, co
-0001ecf0: 626a 203d 2063 6c75 7374 6572 696e 675f  bj = clustering_
-0001ed00: 616c 6728 585f 7063 615f 6375 722c 2063  alg(X_pca_cur, c
-0001ed10: 6c75 7374 5f61 6c67 6f20 3d20 436c 7573  lust_algo = Clus
-0001ed20: 7465 7269 6e67 5f61 6c67 6f2c 200a 2020  tering_algo, .  
-0001ed30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ec60: 2020 2020 2020 2020 7375 625f 6c73 7420          sub_lst 
+0001ec70: 3d20 6d61 705f 6469 6374 5f6d 696e 3273  = map_dict_min2s
+0001ec80: 7562 5b6d 696e 6f72 5d0a 2020 2020 2020  ub[minor].      
+0001ec90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eca0: 2020 2020 2020 2020 2020 2020 2020 6265                be
+0001ecb0: 7374 5f73 636f 7265 203d 2064 665f 4753  st_score = df_GS
+0001ecc0: 415f 7363 6f72 655f 6375 725b 7375 625f  A_score_cur[sub_
+0001ecd0: 6c73 745d 2e6d 6178 2861 7869 7320 3d20  lst].max(axis = 
+0001ece0: 3129 0a20 2020 2020 2020 2020 2020 2020  1).             
+0001ecf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ed00: 2020 2020 2020 2064 665f 4753 415f 7363         df_GSA_sc
+0001ed10: 6f72 655f 6d69 6e6f 725f 6375 725b 6d69  ore_minor_cur[mi
+0001ed20: 6e6f 725d 203d 2062 6573 745f 7363 6f72  nor] = best_scor
+0001ed30: 6520 0a20 2020 2020 2020 2020 2020 2020  e .             
 0001ed40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ed50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ed60: 2020 2020 2020 2020 204e 5f63 6c75 7374           N_clust
-0001ed70: 6572 7320 3d20 4e5f 636f 6d70 2c20 0a20  ers = N_comp, . 
-0001ed80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ed90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001edb0: 2020 2020 2020 2020 2020 7265 736f 6c75            resolu
-0001edc0: 7469 6f6e 203d 2043 6c75 7374 6572 696e  tion = Clusterin
-0001edd0: 675f 7265 736f 6c75 7469 6f6e 290a 2020  g_resolution).  
-0001ede0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001edf0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-0001ee00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ee10: 2020 2020 2020 2061 646a 203d 206b 6e65         adj = kne
-0001ee20: 6967 6862 6f72 735f 6772 6170 6828 585f  ighbors_graph(X_
-0001ee30: 7063 615f 6375 722c 2069 6e74 284e 5f6e  pca_cur, int(N_n
-0001ee40: 6569 6768 626f 7273 5f6d 696e 6f72 292c  eighbors_minor),
-0001ee50: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+0001ed50: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+0001ed60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ed70: 795f 7072 6564 5f6d 696e 6f72 5f63 7572  y_pred_minor_cur
+0001ed80: 203d 2064 665f 4753 415f 7363 6f72 655f   = df_GSA_score_
+0001ed90: 6d69 6e6f 725f 6375 722e 6964 786d 6178  minor_cur.idxmax
+0001eda0: 2861 7869 7320 3d20 3129 0a20 2020 2020  (axis = 1).     
+0001edb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001edc0: 2020 2020 2020 2020 2020 2020 2020 200a                 .
+0001edd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ede0: 2020 2020 2020 2020 2020 2020 795f 636c              y_cl
+0001edf0: 7573 742c 2063 6f62 6a20 3d20 636c 7573  ust, cobj = clus
+0001ee00: 7465 7269 6e67 5f61 6c67 2858 5f70 6361  tering_alg(X_pca
+0001ee10: 5f63 7572 2c20 636c 7573 745f 616c 676f  _cur, clust_algo
+0001ee20: 203d 2043 6c75 7374 6572 696e 675f 616c   = Clustering_al
+0001ee30: 676f 2c20 0a20 2020 2020 2020 2020 2020  go, .           
+0001ee40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee50: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001ee60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ee70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ee80: 2020 2020 206d 6f64 653d 2763 6f6e 6e65       mode='conne
-0001ee90: 6374 6976 6974 7927 2c20 696e 636c 7564  ctivity', includ
-0001eea0: 655f 7365 6c66 3d54 7275 6529 0a20 2020  e_self=True).   
+0001ee70: 4e5f 636c 7573 7465 7273 203d 204e 5f63  N_clusters = N_c
+0001ee80: 6f6d 702c 200a 2020 2020 2020 2020 2020  omp, .          
+0001ee90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001eeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eec0: 2020 2020 2020 2020 2061 646a 203d 2061           adj = a
-0001eed0: 646a 2e74 6f64 656e 7365 2829 2e61 7374  dj.todense().ast
-0001eee0: 7970 6528 696e 7429 0a20 2020 2020 2020  ype(int).       
+0001eec0: 2072 6573 6f6c 7574 696f 6e20 3d20 436c   resolution = Cl
+0001eed0: 7573 7465 7269 6e67 5f72 6573 6f6c 7574  ustering_resolut
+0001eee0: 696f 6e29 0a20 2020 2020 2020 2020 2020  ion).           
 0001eef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef00: 2020 2020 2069 6478 5f61 7279 203d 206e       idx_ary = n
-0001ef10: 702e 6172 616e 6765 2858 5f70 6361 5f63  p.arange(X_pca_c
-0001ef20: 7572 2e73 6861 7065 5b30 5d2c 2064 7479  ur.shape[0], dty
-0001ef30: 7065 203d 2069 6e74 2920 2320 585f 7063  pe = int) # X_pc
-0001ef40: 612e 696e 6465 782e 7661 6c75 6573 0a20  a.index.values. 
-0001ef50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef60: 2020 2020 2020 2020 2020 206e 6569 5f69             nei_i
-0001ef70: 6e64 6963 6573 203d 206e 702e 7a65 726f  ndices = np.zero
-0001ef80: 7328 5b61 646a 2e73 6861 7065 5b30 5d2c  s([adj.shape[0],
-0001ef90: 204e 5f6e 6569 6768 626f 7273 5f6d 696e   N_neighbors_min
-0001efa0: 6f72 5d29 0a20 2020 2020 2020 2020 2020  or]).           
-0001efb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001efc0: 2066 6f72 206b 2069 6e20 7261 6e67 6528   for k in range(
-0001efd0: 6164 6a2e 7368 6170 655b 305d 293a 0a20  adj.shape[0]):. 
-0001efe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eff0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001f000: 6478 203d 206e 702e 6172 7261 7928 6164  dx = np.array(ad
-0001f010: 6a5b 6b2c 3a5d 203e 2030 290a 2020 2020  j[k,:] > 0).    
-0001f020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f030: 2020 2020 2020 2020 2020 2020 6e65 695f              nei_
-0001f040: 696e 6469 6365 735b 6b2c 3a5d 203d 2069  indices[k,:] = i
-0001f050: 6478 5f61 7279 5b69 6478 5b30 2c3a 5d5d  dx_ary[idx[0,:]]
-0001f060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f070: 2020 2020 2020 2020 2020 2020 206e 6569               nei
-0001f080: 5f69 6e64 6963 6573 203d 2070 642e 4461  _indices = pd.Da
-0001f090: 7461 4672 616d 6528 206e 6569 5f69 6e64  taFrame( nei_ind
-0001f0a0: 6963 6573 2c20 696e 6465 7820 3d20 585f  ices, index = X_
-0001f0b0: 7063 615f 6375 722e 696e 6465 782e 7661  pca_cur.index.va
-0001f0c0: 6c75 6573 2029 2020 2020 2020 0a20 2020  lues )      .   
-0001f0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f0f0: 2020 2020 2020 2020 2020 2020 200a 2020               .  
-0001f100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f110: 2020 2020 2020 2020 2020 6966 206b 6e6e            if knn
-0001f120: 5f74 7970 6520 3d3d 2030 3a0a 2020 2020  _type == 0:.    
+0001ef00: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+0001ef10: 2020 2020 2020 2020 2020 2020 2020 6164                ad
+0001ef20: 6a20 3d20 6b6e 6569 6768 626f 7273 5f67  j = kneighbors_g
+0001ef30: 7261 7068 2858 5f70 6361 5f63 7572 2c20  raph(X_pca_cur, 
+0001ef40: 696e 7428 4e5f 6e65 6967 6862 6f72 735f  int(N_neighbors_
+0001ef50: 6d69 6e6f 7229 2c20 0a20 2020 2020 2020  minor), .       
+0001ef60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef80: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+0001ef90: 3d27 636f 6e6e 6563 7469 7669 7479 272c  ='connectivity',
+0001efa0: 2069 6e63 6c75 6465 5f73 656c 663d 5472   include_self=Tr
+0001efb0: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
+0001efc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001efd0: 6164 6a20 3d20 6164 6a2e 746f 6465 6e73  adj = adj.todens
+0001efe0: 6528 292e 6173 7479 7065 2869 6e74 290a  e().astype(int).
+0001eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f000: 2020 2020 2020 2020 2020 2020 6964 785f              idx_
+0001f010: 6172 7920 3d20 6e70 2e61 7261 6e67 6528  ary = np.arange(
+0001f020: 585f 7063 615f 6375 722e 7368 6170 655b  X_pca_cur.shape[
+0001f030: 305d 2c20 6474 7970 6520 3d20 696e 7429  0], dtype = int)
+0001f040: 2023 2058 5f70 6361 2e69 6e64 6578 2e76   # X_pca.index.v
+0001f050: 616c 7565 730a 2020 2020 2020 2020 2020  alues.          
+0001f060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f070: 2020 6e65 695f 696e 6469 6365 7320 3d20    nei_indices = 
+0001f080: 6e70 2e7a 6572 6f73 285b 6164 6a2e 7368  np.zeros([adj.sh
+0001f090: 6170 655b 305d 2c20 4e5f 6e65 6967 6862  ape[0], N_neighb
+0001f0a0: 6f72 735f 6d69 6e6f 725d 290a 2020 2020  ors_minor]).    
+0001f0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f0c0: 2020 2020 2020 2020 666f 7220 6b20 696e          for k in
+0001f0d0: 2072 616e 6765 2861 646a 2e73 6861 7065   range(adj.shape
+0001f0e0: 5b30 5d29 3a0a 2020 2020 2020 2020 2020  [0]):.          
+0001f0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f100: 2020 2020 2020 6964 7820 3d20 6e70 2e61        idx = np.a
+0001f110: 7272 6179 2861 646a 5b6b 2c3a 5d20 3e20  rray(adj[k,:] > 
+0001f120: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
 0001f130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f140: 2020 2020 2020 2020 2020 2020 795f 7072              y_pr
-0001f150: 6564 5f6d 696e 6f72 5f63 7572 2c20 7363  ed_minor_cur, sc
-0001f160: 6f72 655f 7570 203d 2061 7070 6c79 5f6b  ore_up = apply_k
-0001f170: 6e6e 286e 6569 5f69 6e64 6963 6573 2c20  nn(nei_indices, 
-0001f180: 795f 7072 6564 5f6d 696e 6f72 5f63 7572  y_pred_minor_cur
-0001f190: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-0001f1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f1d0: 2020 2020 2020 2020 2020 6466 5f47 5341            df_GSA
-0001f1e0: 5f73 636f 7265 5f6d 696e 6f72 5f63 7572  _score_minor_cur
-0001f1f0: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-0001f200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f140: 2020 206e 6569 5f69 6e64 6963 6573 5b6b     nei_indices[k
+0001f150: 2c3a 5d20 3d20 6964 785f 6172 795b 6964  ,:] = idx_ary[id
+0001f160: 785b 302c 3a5d 5d0a 2020 2020 2020 2020  x[0,:]].        
+0001f170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f180: 2020 2020 6e65 695f 696e 6469 6365 7320      nei_indices 
+0001f190: 3d20 7064 2e44 6174 6146 7261 6d65 2820  = pd.DataFrame( 
+0001f1a0: 6e65 695f 696e 6469 6365 732c 2069 6e64  nei_indices, ind
+0001f1b0: 6578 203d 2058 5f70 6361 5f63 7572 2e69  ex = X_pca_cur.i
+0001f1c0: 6e64 6578 2e76 616c 7565 7320 2920 2020  ndex.values )   
+0001f1d0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+0001f1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f200: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
 0001f210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f230: 706d 616a 203d 206b 6e6e 5f70 6d61 6a2c  pmaj = knn_pmaj,
-0001f240: 206e 6c6f 675f 7076 616c 5f74 6820 3d20   nlog_pval_th = 
-0001f250: 2d6e 702e 6c6f 6731 3028 7076 616c 5f74  -np.log10(pval_t
-0001f260: 6829 2920 2020 2020 2020 200a 2020 2020  h))        .    
-0001f270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f280: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001f290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f2a0: 2020 2020 2020 2020 2020 2020 2020 795f                y_
-0001f2b0: 7072 6564 5f6d 696e 6f72 5f63 7572 2c20  pred_minor_cur, 
-0001f2c0: 7363 6f72 655f 7570 203d 2061 7070 6c79  score_up = apply
-0001f2d0: 5f6b 6e6e 3228 6e65 695f 696e 6469 6365  _knn2(nei_indice
-0001f2e0: 732c 2079 5f70 7265 645f 6d69 6e6f 725f  s, y_pred_minor_
-0001f2f0: 6375 722c 200a 2020 2020 2020 2020 2020  cur, .          
+0001f220: 2069 6620 6b6e 6e5f 7479 7065 203d 3d20   if knn_type == 
+0001f230: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0001f240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f250: 2020 2079 5f70 7265 645f 6d69 6e6f 725f     y_pred_minor_
+0001f260: 6375 722c 2073 636f 7265 5f75 7020 3d20  cur, score_up = 
+0001f270: 6170 706c 795f 6b6e 6e28 6e65 695f 696e  apply_knn(nei_in
+0001f280: 6469 6365 732c 2079 5f70 7265 645f 6d69  dices, y_pred_mi
+0001f290: 6e6f 725f 6375 722c 200a 2020 2020 2020  nor_cur, .      
+0001f2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f2e0: 2064 665f 4753 415f 7363 6f72 655f 6d69   df_GSA_score_mi
+0001f2f0: 6e6f 725f 6375 722c 200a 2020 2020 2020  nor_cur, .      
 0001f300: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001f310: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001f320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f330: 2020 2020 2020 2020 2020 2020 2020 6466                df
-0001f340: 5f47 5341 5f73 636f 7265 5f6d 696e 6f72  _GSA_score_minor
-0001f350: 5f63 7572 2c20 0a20 2020 2020 2020 2020  _cur, .         
-0001f360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f390: 2020 2020 2070 6d61 6a20 3d20 6b6e 6e5f       pmaj = knn_
-0001f3a0: 706d 616a 2c20 6e6c 6f67 5f70 7661 6c5f  pmaj, nlog_pval_
-0001f3b0: 7468 203d 202d 6e70 2e6c 6f67 3130 2870  th = -np.log10(p
-0001f3c0: 7661 6c5f 7468 2929 0a20 2020 2020 2020  val_th)).       
-0001f3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f3e0: 2020 2020 2020 2020 2064 665f 4753 415f           df_GSA_
-0001f3f0: 7363 6f72 655f 6d69 6e6f 725f 6375 7220  score_minor_cur 
-0001f400: 3d20 7363 6f72 655f 7570 0a20 2020 2020  = score_up.     
+0001f330: 2020 2020 2020 2070 6d61 6a20 3d20 6b6e         pmaj = kn
+0001f340: 6e5f 706d 616a 2c20 6e6c 6f67 5f70 7661  n_pmaj, nlog_pva
+0001f350: 6c5f 7468 203d 202d 6e70 2e6c 6f67 3130  l_th = -np.log10
+0001f360: 2870 7661 6c5f 7468 2929 2020 2020 2020  (pval_th))      
+0001f370: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
+0001f380: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0001f390: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001f3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f3b0: 2020 2020 2079 5f70 7265 645f 6d69 6e6f       y_pred_mino
+0001f3c0: 725f 6375 722c 2073 636f 7265 5f75 7020  r_cur, score_up 
+0001f3d0: 3d20 6170 706c 795f 6b6e 6e32 286e 6569  = apply_knn2(nei
+0001f3e0: 5f69 6e64 6963 6573 2c20 795f 7072 6564  _indices, y_pred
+0001f3f0: 5f6d 696e 6f72 5f63 7572 2c20 0a20 2020  _minor_cur, .   
+0001f400: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001f410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f420: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+0001f420: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001f430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f440: 2020 2020 2020 2020 6466 5f72 6573 5f6d          df_res_m
-0001f450: 696e 6f72 5f63 7572 203d 2067 6574 5f73  inor_cur = get_s
-0001f460: 7461 745f 6773 6128 2064 665f 4753 415f  tat_gsa( df_GSA_
-0001f470: 7363 6f72 655f 6d69 6e6f 725f 6375 7220  score_minor_cur 
-0001f480: 2920 2020 200a 2020 2020 2020 2020 2020  )    .          
-0001f490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f4a0: 2020 795f 7072 6564 5f6d 696e 6f72 5f63    y_pred_minor_c
-0001f4b0: 7572 203d 2064 665f 7265 735f 6d69 6e6f  ur = df_res_mino
-0001f4c0: 725f 6375 725b 2763 656c 6c5f 7479 7065  r_cur['cell_type
-0001f4d0: 275d 2e61 7374 7970 6528 7374 7229 0a20  '].astype(str). 
+0001f440: 2020 2020 2064 665f 4753 415f 7363 6f72       df_GSA_scor
+0001f450: 655f 6d69 6e6f 725f 6375 722c 200a 2020  e_minor_cur, .  
+0001f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f490: 2020 2020 2020 2020 2020 2020 706d 616a              pmaj
+0001f4a0: 203d 206b 6e6e 5f70 6d61 6a2c 206e 6c6f   = knn_pmaj, nlo
+0001f4b0: 675f 7076 616c 5f74 6820 3d20 2d6e 702e  g_pval_th = -np.
+0001f4c0: 6c6f 6731 3028 7076 616c 5f74 6829 290a  log10(pval_th)).
+0001f4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001f4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f4f0: 2020 2020 2020 2020 2020 2023 2070 7269             # pri
-0001f500: 6e74 2879 5f70 7265 645f 6d69 6e6f 725f  nt(y_pred_minor_
-0001f510: 6375 722e 7368 6170 652c 2069 6478 732e  cur.shape, idxs.
-0001f520: 7368 6170 652c 2064 665f 7265 735f 6d69  shape, df_res_mi
-0001f530: 6e6f 725f 6375 722e 7368 6170 6529 0a20  nor_cur.shape). 
-0001f540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f550: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-0001f560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f570: 2020 2020 2020 2020 6466 5f70 7265 642e          df_pred.
-0001f580: 6c6f 635b 6964 7873 2c20 2763 656c 6c5f  loc[idxs, 'cell_
-0001f590: 7479 7065 5f6d 696e 6f72 275d 203d 2079  type_minor'] = y
-0001f5a0: 5f70 7265 645f 6d69 6e6f 725f 6375 720a  _pred_minor_cur.
-0001f5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f5c0: 2020 2020 2020 2020 2020 2020 6466 5f70              df_p
-0001f5d0: 7265 642e 6c6f 635b 6964 7873 2c20 2763  red.loc[idxs, 'c
-0001f5e0: 656c 6c5f 7479 7065 5f6d 696e 6f72 2831  ell_type_minor(1
-0001f5f0: 7374 2927 5d20 3d20 6466 5f72 6573 5f6d  st)'] = df_res_m
-0001f600: 696e 6f72 5f63 7572 5b27 6365 6c6c 5f74  inor_cur['cell_t
-0001f610: 7970 6528 3173 7429 275d 2e61 7374 7970  ype(1st)'].astyp
-0001f620: 6528 7374 7229 0a20 2020 2020 2020 2020  e(str).         
-0001f630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f640: 2020 2064 665f 7072 6564 2e6c 6f63 5b69     df_pred.loc[i
-0001f650: 6478 732c 2027 436f 6e66 6964 656e 6365  dxs, 'Confidence
-0001f660: 5f6d 696e 6f72 2831 7374 2927 5d20 3d20  _minor(1st)'] = 
-0001f670: 6466 5f72 6573 5f6d 696e 6f72 5f63 7572  df_res_minor_cur
-0001f680: 5b27 2d6c 6f67 5027 5d2e 6173 7479 7065  ['-logP'].astype
-0001f690: 2866 6c6f 6174 290a 2020 2020 2020 2020  (float).        
-0001f6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f6b0: 2020 2020 6466 5f70 7265 642e 6c6f 635b      df_pred.loc[
-0001f6c0: 6964 7873 2c20 2763 656c 6c5f 7479 7065  idxs, 'cell_type
-0001f6d0: 5f6d 696e 6f72 2832 6e64 2927 5d20 3d20  _minor(2nd)'] = 
-0001f6e0: 6466 5f72 6573 5f6d 696e 6f72 5f63 7572  df_res_minor_cur
-0001f6f0: 5b27 6365 6c6c 5f74 7970 6528 326e 6429  ['cell_type(2nd)
-0001f700: 275d 2e61 7374 7970 6528 7374 7229 0a20  '].astype(str). 
-0001f710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f720: 2020 2020 2020 2020 2020 2064 665f 7072             df_pr
-0001f730: 6564 2e6c 6f63 5b69 6478 732c 2027 436f  ed.loc[idxs, 'Co
-0001f740: 6e66 6964 656e 6365 5f6d 696e 6f72 2832  nfidence_minor(2
-0001f750: 6e64 2927 5d20 3d20 6466 5f72 6573 5f6d  nd)'] = df_res_m
-0001f760: 696e 6f72 5f63 7572 5b27 2d6c 6f67 5028  inor_cur['-logP(
-0001f770: 326e 6429 275d 2e61 7374 7970 6528 666c  2nd)'].astype(fl
-0001f780: 6f61 7429 0a20 2020 2020 2020 2020 2020  oat).           
-0001f790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f7a0: 2023 2727 2720 2020 2020 2020 2020 2020   #'''           
-0001f7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f7c0: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-0001f7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f7e0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
-0001f7f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001f800: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001f810: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
+0001f4f0: 6466 5f47 5341 5f73 636f 7265 5f6d 696e  df_GSA_score_min
+0001f500: 6f72 5f63 7572 203d 2073 636f 7265 5f75  or_cur = score_u
+0001f510: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
+0001f520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f530: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
+0001f540: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001f550: 665f 7265 735f 6d69 6e6f 725f 6375 7220  f_res_minor_cur 
+0001f560: 3d20 6765 745f 7374 6174 5f67 7361 2820  = get_stat_gsa( 
+0001f570: 6466 5f47 5341 5f73 636f 7265 5f6d 696e  df_GSA_score_min
+0001f580: 6f72 5f63 7572 2029 2020 2020 0a20 2020  or_cur )    .   
+0001f590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f5a0: 2020 2020 2020 2020 2079 5f70 7265 645f           y_pred_
+0001f5b0: 6d69 6e6f 725f 6375 7220 3d20 6466 5f72  minor_cur = df_r
+0001f5c0: 6573 5f6d 696e 6f72 5f63 7572 5b27 6365  es_minor_cur['ce
+0001f5d0: 6c6c 5f74 7970 6527 5d2e 6173 7479 7065  ll_type'].astype
+0001f5e0: 2873 7472 290a 2020 2020 2020 2020 2020  (str).          
+0001f5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f600: 2020 2320 7072 696e 7428 795f 7072 6564    # print(y_pred
+0001f610: 5f6d 696e 6f72 5f63 7572 2e73 6861 7065  _minor_cur.shape
+0001f620: 2c20 6964 7873 2e73 6861 7065 2c20 6466  , idxs.shape, df
+0001f630: 5f72 6573 5f6d 696e 6f72 5f63 7572 2e73  _res_minor_cur.s
+0001f640: 6861 7065 290a 2020 2020 2020 2020 2020  hape).          
+0001f650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f660: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
+0001f670: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001f680: 665f 7072 6564 2e6c 6f63 5b69 6478 732c  f_pred.loc[idxs,
+0001f690: 2027 6365 6c6c 5f74 7970 655f 6d69 6e6f   'cell_type_mino
+0001f6a0: 7227 5d20 3d20 795f 7072 6564 5f6d 696e  r'] = y_pred_min
+0001f6b0: 6f72 5f63 7572 0a20 2020 2020 2020 2020  or_cur.         
+0001f6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f6d0: 2020 2064 665f 7072 6564 2e6c 6f63 5b69     df_pred.loc[i
+0001f6e0: 6478 732c 2027 6365 6c6c 5f74 7970 655f  dxs, 'cell_type_
+0001f6f0: 6d69 6e6f 7228 3173 7429 275d 203d 2064  minor(1st)'] = d
+0001f700: 665f 7265 735f 6d69 6e6f 725f 6375 725b  f_res_minor_cur[
+0001f710: 2763 656c 6c5f 7479 7065 2831 7374 2927  'cell_type(1st)'
+0001f720: 5d2e 6173 7479 7065 2873 7472 290a 2020  ].astype(str).  
+0001f730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f740: 2020 2020 2020 2020 2020 6466 5f70 7265            df_pre
+0001f750: 642e 6c6f 635b 6964 7873 2c20 2743 6f6e  d.loc[idxs, 'Con
+0001f760: 6669 6465 6e63 655f 6d69 6e6f 7228 3173  fidence_minor(1s
+0001f770: 7429 275d 203d 2064 665f 7265 735f 6d69  t)'] = df_res_mi
+0001f780: 6e6f 725f 6375 725b 272d 6c6f 6750 275d  nor_cur['-logP']
+0001f790: 2e61 7374 7970 6528 666c 6f61 7429 0a20  .astype(float). 
+0001f7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f7b0: 2020 2020 2020 2020 2020 2064 665f 7072             df_pr
+0001f7c0: 6564 2e6c 6f63 5b69 6478 732c 2027 6365  ed.loc[idxs, 'ce
+0001f7d0: 6c6c 5f74 7970 655f 6d69 6e6f 7228 326e  ll_type_minor(2n
+0001f7e0: 6429 275d 203d 2064 665f 7265 735f 6d69  d)'] = df_res_mi
+0001f7f0: 6e6f 725f 6375 725b 2763 656c 6c5f 7479  nor_cur['cell_ty
+0001f800: 7065 2832 6e64 2927 5d2e 6173 7479 7065  pe(2nd)'].astype
+0001f810: 2873 7472 290a 2020 2020 2020 2020 2020  (str).          
 0001f820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f830: 2020 2020 2020 2020 2323 2055 7064 6174          ## Updat
-0001f840: 6520 7375 6273 6574 2073 636f 7265 0a20  e subset score. 
-0001f850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f860: 2020 2020 2020 2020 2020 2023 2727 270a             #'''.
-0001f870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f880: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0001f890: 6378 2069 6e20 6c69 7374 2863 6f6c 7329  cx in list(cols)
-0001f8a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001f830: 2020 6466 5f70 7265 642e 6c6f 635b 6964    df_pred.loc[id
+0001f840: 7873 2c20 2743 6f6e 6669 6465 6e63 655f  xs, 'Confidence_
+0001f850: 6d69 6e6f 7228 326e 6429 275d 203d 2064  minor(2nd)'] = d
+0001f860: 665f 7265 735f 6d69 6e6f 725f 6375 725b  f_res_minor_cur[
+0001f870: 272d 6c6f 6750 2832 6e64 2927 5d2e 6173  '-logP(2nd)'].as
+0001f880: 7479 7065 2866 6c6f 6174 290a 2020 2020  type(float).    
+0001f890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f8a0: 2020 2020 2020 2020 2327 2727 2020 2020          #'''    
 0001f8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f8c0: 2020 6d69 6e6f 725f 7479 7065 203d 206d    minor_type = m
-0001f8d0: 6170 5f64 6963 745f 7375 6232 6d69 6e5b  ap_dict_sub2min[
-0001f8e0: 6378 5d0a 2020 2020 2020 2020 2020 2020  cx].            
-0001f8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f900: 2020 2020 6966 206d 696e 6f72 5f74 7970      if minor_typ
-0001f910: 6520 696e 206d 696e 6f72 5f74 7970 655f  e in minor_type_
-0001f920: 6c73 745f 616c 6c3a 0a20 2020 2020 2020  lst_all:.       
-0001f930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f940: 2020 2020 2020 2020 2020 2020 2023 2070               # p
-0001f950: 7269 6e74 286d 696e 6f72 5f74 7970 6529  rint(minor_type)
-0001f960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f980: 2020 2020 2064 665f 4753 415f 7363 6f72       df_GSA_scor
-0001f990: 655f 6375 725b 6378 5d20 3d20 5c0a 2020  e_cur[cx] = \.  
-0001f9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f8c0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0001f8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f8e0: 2020 2020 2020 2020 2023 2323 2323 2323           #######
+0001f8f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001f900: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001f910: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001f920: 2323 0a20 2020 2020 2020 2020 2020 2020  ##.             
+0001f930: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001f940: 2320 5570 6461 7465 2073 7562 7365 7420  # Update subset 
+0001f950: 7363 6f72 650a 2020 2020 2020 2020 2020  score.          
+0001f960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f970: 2020 2327 2727 0a20 2020 2020 2020 2020    #'''.         
+0001f980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f990: 2020 2066 6f72 2063 7820 696e 206c 6973     for cx in lis
+0001f9a0: 7428 636f 6c73 293a 0a20 2020 2020 2020  t(cols):.       
 0001f9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f9c0: 2020 2020 2020 2831 2d6d 696e 6f72 5f77        (1-minor_w
-0001f9d0: 6774 292a 6466 5f47 5341 5f73 636f 7265  gt)*df_GSA_score
-0001f9e0: 5f63 7572 5b63 785d 202b 206d 696e 6f72  _cur[cx] + minor
-0001f9f0: 5f77 6774 2a64 665f 4753 415f 7363 6f72  _wgt*df_GSA_scor
-0001fa00: 655f 6d69 6e6f 725f 6375 725b 6d69 6e6f  e_minor_cur[mino
-0001fa10: 725f 7479 7065 5d0a 2020 2020 2020 2020  r_type].        
-0001fa20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fa30: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001f9c0: 2020 2020 2020 2020 206d 696e 6f72 5f74           minor_t
+0001f9d0: 7970 6520 3d20 6d61 705f 6469 6374 5f73  ype = map_dict_s
+0001f9e0: 7562 326d 696e 5b63 785d 0a20 2020 2020  ub2min[cx].     
+0001f9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fa00: 2020 2020 2020 2020 2020 2069 6620 6d69             if mi
+0001fa10: 6e6f 725f 7479 7065 2069 6e20 6d69 6e6f  nor_type in mino
+0001fa20: 725f 7479 7065 5f6c 7374 5f61 6c6c 3a0a  r_type_lst_all:.
+0001fa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001fa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fa50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fa60: 2020 7072 696e 7428 2757 4152 4e49 4e47    print('WARNING
-0001fa70: 3a20 2573 2028 2573 2920 6e6f 7420 696e  : %s (%s) not in
-0001fa80: 2027 2025 2028 6d69 6e6f 725f 7479 7065   ' % (minor_type
-0001fa90: 2c20 6329 2c20 6d69 6e6f 725f 7479 7065  , c), minor_type
-0001faa0: 5f6c 7374 5f61 6c6c 2920 0a20 2020 2020  _lst_all) .     
+0001fa50: 2020 2020 2320 7072 696e 7428 6d69 6e6f      # print(mino
+0001fa60: 725f 7479 7065 290a 2020 2020 2020 2020  r_type).        
+0001fa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fa80: 2020 2020 2020 2020 2020 2020 6466 5f47              df_G
+0001fa90: 5341 5f73 636f 7265 5f63 7572 5b63 785d  SA_score_cur[cx]
+0001faa0: 203d 205c 0a20 2020 2020 2020 2020 2020   = \.           
 0001fab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fac0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-0001fad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fae0: 2020 2020 2020 2327 2727 0a20 2020 2020        #'''.     
-0001faf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fb00: 2020 2020 2020 2079 5f70 7265 7620 3d20         y_prev = 
-0001fb10: 6466 5f72 6573 5f63 7572 5b27 6365 6c6c  df_res_cur['cell
-0001fb20: 5f74 7970 6527 5d2e 636f 7079 2864 6565  _type'].copy(dee
-0001fb30: 7020 3d20 5472 7565 2920 2020 2020 2020  p = True)       
-0001fb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fb50: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-0001fb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fb70: 2020 6466 5f72 6573 5f74 6d70 203d 2064    df_res_tmp = d
-0001fb80: 665f 7265 735f 6375 722e 636f 7079 2864  f_res_cur.copy(d
-0001fb90: 6565 7020 3d20 5472 7565 290a 2020 2020  eep = True).    
-0001fba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fbb0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+0001fac0: 2020 2020 2020 2020 2020 2020 2028 312d               (1-
+0001fad0: 6d69 6e6f 725f 7767 7429 2a64 665f 4753  minor_wgt)*df_GS
+0001fae0: 415f 7363 6f72 655f 6375 725b 6378 5d20  A_score_cur[cx] 
+0001faf0: 2b20 6d69 6e6f 725f 7767 742a 6466 5f47  + minor_wgt*df_G
+0001fb00: 5341 5f73 636f 7265 5f6d 696e 6f72 5f63  SA_score_minor_c
+0001fb10: 7572 5b6d 696e 6f72 5f74 7970 655d 0a20  ur[minor_type]. 
+0001fb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fb30: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0001fb40: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001fb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fb60: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+0001fb70: 5741 524e 494e 473a 2025 7320 2825 7329  WARNING: %s (%s)
+0001fb80: 206e 6f74 2069 6e20 2720 2520 286d 696e   not in ' % (min
+0001fb90: 6f72 5f74 7970 652c 2063 292c 206d 696e  or_type, c), min
+0001fba0: 6f72 5f74 7970 655f 6c73 745f 616c 6c29  or_type_lst_all)
+0001fbb0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
 0001fbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fbd0: 2020 2020 2064 665f 7265 735f 6375 7220       df_res_cur 
-0001fbe0: 3d20 6765 745f 7374 6174 5f67 7361 2864  = get_stat_gsa(d
-0001fbf0: 665f 4753 415f 7363 6f72 655f 6375 7229  f_GSA_score_cur)
-0001fc00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fc10: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-0001fc20: 7265 735f 6375 725b 274f 7665 726c 6170  res_cur['Overlap
-0001fc30: 275d 203d 2064 665f 7265 735f 746d 705b  '] = df_res_tmp[
-0001fc40: 274f 7665 726c 6170 275d 0a20 2020 2020  'Overlap'].     
-0001fc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fc60: 2020 2020 2020 2064 665f 7265 735f 6375         df_res_cu
-0001fc70: 725b 274f 7665 726c 6170 2832 6e64 2927  r['Overlap(2nd)'
-0001fc80: 5d20 3d20 6466 5f72 6573 5f74 6d70 5b27  ] = df_res_tmp['
-0001fc90: 4f76 6572 6c61 7028 326e 6429 275d 0a20  Overlap(2nd)']. 
-0001fca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fcb0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+0001fbd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001fbe0: 2020 2020 2020 2020 2020 2020 2023 2727               #''
+0001fbf0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001fc00: 2020 2020 2020 2020 2020 2020 2020 795f                y_
+0001fc10: 7072 6576 203d 2064 665f 7265 735f 6375  prev = df_res_cu
+0001fc20: 725b 2763 656c 6c5f 7479 7065 275d 2e63  r['cell_type'].c
+0001fc30: 6f70 7928 6465 6570 203d 2054 7275 6529  opy(deep = True)
+0001fc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fc50: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0001fc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fc70: 2020 2020 2020 2020 2064 665f 7265 735f           df_res_
+0001fc80: 746d 7020 3d20 6466 5f72 6573 5f63 7572  tmp = df_res_cur
+0001fc90: 2e63 6f70 7928 6465 6570 203d 2054 7275  .copy(deep = Tru
+0001fca0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0001fcb0: 2020 2020 2020 2020 2020 2020 2020 200a                 .
 0001fcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fcd0: 2020 2020 2020 2020 795f 7072 6564 5f63          y_pred_c
-0001fce0: 7572 203d 2064 665f 7265 735f 6375 725b  ur = df_res_cur[
-0001fcf0: 2763 656c 6c5f 7479 7065 275d 2e63 6f70  'cell_type'].cop
-0001fd00: 7928 6465 6570 203d 2054 7275 6529 0a20  y(deep = True). 
+0001fcd0: 2020 2020 2020 2020 2020 2020 6466 5f72              df_r
+0001fce0: 6573 5f63 7572 203d 2067 6574 5f73 7461  es_cur = get_sta
+0001fcf0: 745f 6773 6128 6466 5f47 5341 5f73 636f  t_gsa(df_GSA_sco
+0001fd00: 7265 5f63 7572 290a 2020 2020 2020 2020  re_cur).        
 0001fd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fd20: 2020 2020 2020 2020 2020 2023 2070 7269             # pri
-0001fd30: 6e74 2827 5c6e 272c 2063 2c20 273a 2027  nt('\n', c, ': '
-0001fd40: 2c20 6e70 2e73 756d 2879 5f70 7265 7620  , np.sum(y_prev 
-0001fd50: 3d3d 2079 5f70 7265 645f 6375 7229 2c20  == y_pred_cur), 
-0001fd60: 2720 2f20 272c 206c 656e 2879 5f70 7265  ' / ', len(y_pre
-0001fd70: 7629 2c20 656e 6420 3d20 2727 290a 2020  v), end = '').  
-0001fd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fd90: 2020 2020 2020 2020 2020 2327 2727 0a20            #'''. 
-0001fda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fdb0: 2020 2020 2020 2020 2020 2023 2323 2323             #####
-0001fdc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001fdd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001fde0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001fdf0: 2323 2323 200a 2020 2020 2020 2020 2020  #### .          
-0001fe00: 2020 2020 2020 2020 2020 2323 2045 6e64            ## End
-0001fe10: 206f 6620 6966 2075 7365 5f6d 696e 6f72   of if use_minor
-0001fe20: 3a0a 2020 2020 0a20 2020 2020 2020 2020  :.    .         
-0001fe30: 2020 2020 2020 2020 2020 206e 5f74 6172             n_tar
-0001fe40: 6765 7473 203d 206c 656e 286c 6973 7428  gets = len(list(
-0001fe50: 6d6b 725f 6c73 742e 6b65 7973 2829 2929  mkr_lst.keys()))
-0001fe60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fe70: 2020 2020 2069 6620 284e 5f6e 6569 6768       if (N_neigh
-0001fe80: 626f 7273 5f73 7562 7365 7420 3e20 3229  bors_subset > 2)
-0001fe90: 2026 2028 6c65 6e28 795f 7072 6564 5f63   & (len(y_pred_c
-0001fea0: 7572 2920 3e3d 204e 5f6e 6569 6768 626f  ur) >= N_neighbo
-0001feb0: 7273 5f73 7562 7365 7429 2026 2028 6e5f  rs_subset) & (n_
-0001fec0: 7461 7267 6574 7320 3e20 3129 3a0a 2020  targets > 1):.  
-0001fed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fee0: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-0001fef0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001ff00: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0001ff10: 696e 7428 2741 7070 6c79 696e 6720 6b4e  int('Applying kN
-0001ff20: 4e20 746f 2063 6f72 7265 6374 2063 656c  N to correct cel
-0001ff30: 6c20 7479 7065 2073 7562 7365 7420 2e2e  l type subset ..
-0001ff40: 2027 2c20 656e 6420 3d20 2727 290a 0a20   ', end = '').. 
-0001ff50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ff60: 2020 2020 2020 2023 2320 4b4e 4e20 636f         ## KNN co
-0001ff70: 7272 6563 7469 6f6e 0a20 2020 2020 2020  rrection.       
-0001ff80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ff90: 2069 6620 6466 5f47 5341 5f73 636f 7265   if df_GSA_score
-0001ffa0: 5f63 7572 2069 7320 6e6f 7420 4e6f 6e65  _cur is not None
-0001ffb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001ffc0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-0001ffd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ffe0: 2020 2020 2020 2020 2020 2061 646a 203d             adj =
-0001fff0: 206b 6e65 6967 6862 6f72 735f 6772 6170   kneighbors_grap
-00020000: 6828 585f 7063 615f 6375 722c 2069 6e74  h(X_pca_cur, int
-00020010: 284e 5f6e 6569 6768 626f 7273 5f73 7562  (N_neighbors_sub
-00020020: 7365 7429 2c20 0a20 2020 2020 2020 2020  set), .         
-00020030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020050: 2020 2020 2020 2020 2020 6d6f 6465 3d27            mode='
-00020060: 636f 6e6e 6563 7469 7669 7479 272c 2069  connectivity', i
-00020070: 6e63 6c75 6465 5f73 656c 663d 5472 7565  nclude_self=True
-00020080: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00020090: 2020 2020 2020 2020 2020 2020 2020 6164                ad
-000200a0: 6a20 3d20 6164 6a2e 746f 6465 6e73 6528  j = adj.todense(
-000200b0: 292e 6173 7479 7065 2869 6e74 290a 2020  ).astype(int).  
+0001fd20: 2020 2020 6466 5f72 6573 5f63 7572 5b27      df_res_cur['
+0001fd30: 4f76 6572 6c61 7027 5d20 3d20 6466 5f72  Overlap'] = df_r
+0001fd40: 6573 5f74 6d70 5b27 4f76 6572 6c61 7027  es_tmp['Overlap'
+0001fd50: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0001fd60: 2020 2020 2020 2020 2020 2020 2020 6466                df
+0001fd70: 5f72 6573 5f63 7572 5b27 4f76 6572 6c61  _res_cur['Overla
+0001fd80: 7028 326e 6429 275d 203d 2064 665f 7265  p(2nd)'] = df_re
+0001fd90: 735f 746d 705b 274f 7665 726c 6170 2832  s_tmp['Overlap(2
+0001fda0: 6e64 2927 5d0a 2020 2020 2020 2020 2020  nd)'].          
+0001fdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fdc0: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
+0001fdd0: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+0001fde0: 5f70 7265 645f 6375 7220 3d20 6466 5f72  _pred_cur = df_r
+0001fdf0: 6573 5f63 7572 5b27 6365 6c6c 5f74 7970  es_cur['cell_typ
+0001fe00: 6527 5d2e 636f 7079 2864 6565 7020 3d20  e'].copy(deep = 
+0001fe10: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+0001fe20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fe30: 2020 2320 7072 696e 7428 275c 6e27 2c20    # print('\n', 
+0001fe40: 632c 2027 3a20 272c 206e 702e 7375 6d28  c, ': ', np.sum(
+0001fe50: 795f 7072 6576 203d 3d20 795f 7072 6564  y_prev == y_pred
+0001fe60: 5f63 7572 292c 2027 202f 2027 2c20 6c65  _cur), ' / ', le
+0001fe70: 6e28 795f 7072 6576 292c 2065 6e64 203d  n(y_prev), end =
+0001fe80: 2027 2729 0a20 2020 2020 2020 2020 2020   '').           
+0001fe90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fea0: 2023 2727 270a 2020 2020 2020 2020 2020   #'''.          
+0001feb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fec0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+0001fed0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001fee0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001fef0: 2323 2323 2323 2323 2323 2320 0a20 2020  ########### .   
+0001ff00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ff10: 2023 2320 456e 6420 6f66 2069 6620 7573   ## End of if us
+0001ff20: 655f 6d69 6e6f 723a 0a20 2020 200a 2020  e_minor:.    .  
+0001ff30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ff40: 2020 6e5f 7461 7267 6574 7320 3d20 6c65    n_targets = le
+0001ff50: 6e28 6c69 7374 286d 6b72 5f6c 7374 2e6b  n(list(mkr_lst.k
+0001ff60: 6579 7328 2929 290a 2020 2020 2020 2020  eys())).        
+0001ff70: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0001ff80: 4e5f 6e65 6967 6862 6f72 735f 7375 6273  N_neighbors_subs
+0001ff90: 6574 203e 2032 2920 2620 286c 656e 2879  et > 2) & (len(y
+0001ffa0: 5f70 7265 645f 6375 7229 203e 3d20 4e5f  _pred_cur) >= N_
+0001ffb0: 6e65 6967 6862 6f72 735f 7375 6273 6574  neighbors_subset
+0001ffc0: 2920 2620 286e 5f74 6172 6765 7473 203e  ) & (n_targets >
+0001ffd0: 2031 293a 0a20 2020 2020 2020 2020 2020   1):.           
+0001ffe0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001fff0: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+00020000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020010: 2020 2020 2070 7269 6e74 2827 4170 706c       print('Appl
+00020020: 7969 6e67 206b 4e4e 2074 6f20 636f 7272  ying kNN to corr
+00020030: 6563 7420 6365 6c6c 2074 7970 6520 7375  ect cell type su
+00020040: 6273 6574 202e 2e20 272c 2065 6e64 203d  bset .. ', end =
+00020050: 2027 2729 0a0a 2020 2020 2020 2020 2020   '')..          
+00020060: 2020 2020 2020 2020 2020 2020 2020 2323                ##
+00020070: 204b 4e4e 2063 6f72 7265 6374 696f 6e0a   KNN correction.
+00020080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020090: 2020 2020 2020 2020 6966 2064 665f 4753          if df_GS
+000200a0: 415f 7363 6f72 655f 6375 7220 6973 206e  A_score_cur is n
+000200b0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
 000200c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000200d0: 2020 2020 2020 2020 2020 6964 785f 6172            idx_ar
-000200e0: 7920 3d20 6e70 2e61 7261 6e67 6528 585f  y = np.arange(X_
-000200f0: 7063 615f 6375 722e 7368 6170 655b 305d  pca_cur.shape[0]
-00020100: 2c20 6474 7970 6520 3d20 696e 7429 2023  , dtype = int) #
-00020110: 2058 5f70 6361 2e69 6e64 6578 2e76 616c   X_pca.index.val
-00020120: 7565 730a 2020 2020 2020 2020 2020 2020  ues.            
+000200d0: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+000200e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000200f0: 2020 6164 6a20 3d20 6b6e 6569 6768 626f    adj = kneighbo
+00020100: 7273 5f67 7261 7068 2858 5f70 6361 5f63  rs_graph(X_pca_c
+00020110: 7572 2c20 696e 7428 4e5f 6e65 6967 6862  ur, int(N_neighb
+00020120: 6f72 735f 7375 6273 6574 292c 200a 2020  ors_subset), .  
 00020130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020140: 6e65 695f 696e 6469 6365 7320 3d20 6e70  nei_indices = np
-00020150: 2e7a 6572 6f73 285b 6164 6a2e 7368 6170  .zeros([adj.shap
-00020160: 655b 305d 2c20 4e5f 6e65 6967 6862 6f72  e[0], N_neighbor
-00020170: 735f 7375 6273 6574 5d29 0a20 2020 2020  s_subset]).     
-00020180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020190: 2020 2020 2020 2066 6f72 206b 2069 6e20         for k in 
-000201a0: 7261 6e67 6528 6164 6a2e 7368 6170 655b  range(adj.shape[
-000201b0: 305d 293a 0a20 2020 2020 2020 2020 2020  0]):.           
-000201c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000201d0: 2020 2020 2069 6478 7320 3d20 6e70 2e61       idxs = np.a
-000201e0: 7272 6179 2861 646a 5b6b 2c3a 5d20 3e20  rray(adj[k,:] > 
-000201f0: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
-00020200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020210: 2020 206e 6569 5f69 6e64 6963 6573 5b6b     nei_indices[k
-00020220: 2c3a 5d20 3d20 6964 785f 6172 795b 6964  ,:] = idx_ary[id
-00020230: 7873 5b30 2c3a 5d5d 0a20 2020 2020 2020  xs[0,:]].       
-00020240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020250: 2020 2020 206e 6569 5f69 6e64 6963 6573       nei_indices
-00020260: 203d 2070 642e 4461 7461 4672 616d 6528   = pd.DataFrame(
-00020270: 206e 6569 5f69 6e64 6963 6573 2c20 696e   nei_indices, in
-00020280: 6465 7820 3d20 585f 7063 615f 6375 722e  dex = X_pca_cur.
-00020290: 696e 6465 782e 7661 6c75 6573 2029 2020  index.values )  
-000202a0: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-000202b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020160: 206d 6f64 653d 2763 6f6e 6e65 6374 6976   mode='connectiv
+00020170: 6974 7927 2c20 696e 636c 7564 655f 7365  ity', include_se
+00020180: 6c66 3d54 7275 6529 0a20 2020 2020 2020  lf=True).       
+00020190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000201a0: 2020 2020 2061 646a 203d 2061 646a 2e74       adj = adj.t
+000201b0: 6f64 656e 7365 2829 2e61 7374 7970 6528  odense().astype(
+000201c0: 696e 7429 0a20 2020 2020 2020 2020 2020  int).           
+000201d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000201e0: 2069 6478 5f61 7279 203d 206e 702e 6172   idx_ary = np.ar
+000201f0: 616e 6765 2858 5f70 6361 5f63 7572 2e73  ange(X_pca_cur.s
+00020200: 6861 7065 5b30 5d2c 2064 7479 7065 203d  hape[0], dtype =
+00020210: 2069 6e74 2920 2320 585f 7063 612e 696e   int) # X_pca.in
+00020220: 6465 782e 7661 6c75 6573 0a20 2020 2020  dex.values.     
+00020230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020240: 2020 2020 2020 206e 6569 5f69 6e64 6963         nei_indic
+00020250: 6573 203d 206e 702e 7a65 726f 7328 5b61  es = np.zeros([a
+00020260: 646a 2e73 6861 7065 5b30 5d2c 204e 5f6e  dj.shape[0], N_n
+00020270: 6569 6768 626f 7273 5f73 7562 7365 745d  eighbors_subset]
+00020280: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00020290: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+000202a0: 7220 6b20 696e 2072 616e 6765 2861 646a  r k in range(adj
+000202b0: 2e73 6861 7065 5b30 5d29 3a0a 2020 2020  .shape[0]):.    
 000202c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000202d0: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-000202e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000202f0: 2020 2320 7072 696e 7428 6e65 695f 696e    # print(nei_in
-00020300: 6469 6365 732e 7368 6170 652c 2064 665f  dices.shape, df_
-00020310: 4753 415f 7363 6f72 655f 6375 722e 7368  GSA_score_cur.sh
-00020320: 6170 652c 2066 6c75 7368 203d 2054 7275  ape, flush = Tru
-00020330: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00020340: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00020350: 6620 6b6e 6e5f 7479 7065 203d 3d20 303a  f knn_type == 0:
-00020360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020380: 2079 5f70 7265 645f 6375 722c 2073 636f   y_pred_cur, sco
-00020390: 7265 5f75 7020 3d20 6170 706c 795f 6b6e  re_up = apply_kn
-000203a0: 6e28 6e65 695f 696e 6469 6365 732c 2079  n(nei_indices, y
-000203b0: 5f70 7265 645f 6375 722c 2064 665f 4753  _pred_cur, df_GS
-000203c0: 415f 7363 6f72 655f 6375 722c 200a 2020  A_score_cur, .  
-000203d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000202d0: 2020 2020 2020 2020 2020 2020 6964 7873              idxs
+000202e0: 203d 206e 702e 6172 7261 7928 6164 6a5b   = np.array(adj[
+000202f0: 6b2c 3a5d 203e 2030 290a 2020 2020 2020  k,:] > 0).      
+00020300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020310: 2020 2020 2020 2020 2020 6e65 695f 696e            nei_in
+00020320: 6469 6365 735b 6b2c 3a5d 203d 2069 6478  dices[k,:] = idx
+00020330: 5f61 7279 5b69 6478 735b 302c 3a5d 5d0a  _ary[idxs[0,:]].
+00020340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020350: 2020 2020 2020 2020 2020 2020 6e65 695f              nei_
+00020360: 696e 6469 6365 7320 3d20 7064 2e44 6174  indices = pd.Dat
+00020370: 6146 7261 6d65 2820 6e65 695f 696e 6469  aFrame( nei_indi
+00020380: 6365 732c 2069 6e64 6578 203d 2058 5f70  ces, index = X_p
+00020390: 6361 5f63 7572 2e69 6e64 6578 2e76 616c  ca_cur.index.val
+000203a0: 7565 7320 2920 2020 2020 200a 2020 2020  ues )      .    
+000203b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000203c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000203d0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
 000203e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000203f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020400: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00020410: 6d61 6a20 3d20 302e 352c 206e 6c6f 675f  maj = 0.5, nlog_
-00020420: 7076 616c 5f74 6820 3d20 2d6e 702e 6c6f  pval_th = -np.lo
-00020430: 6731 3028 7076 616c 5f74 6829 2920 2020  g10(pval_th))   
-00020440: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-00020450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020460: 2020 656c 6966 206b 6e6e 5f74 7970 6520    elif knn_type 
-00020470: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
-00020480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020490: 2020 2020 2020 795f 7072 6564 5f63 7572        y_pred_cur
-000204a0: 2c20 7363 6f72 655f 7570 203d 2061 7070  , score_up = app
-000204b0: 6c79 5f6b 6e6e 3128 6e65 695f 696e 6469  ly_knn1(nei_indi
-000204c0: 6365 732c 2079 5f70 7265 645f 6375 722c  ces, y_pred_cur,
-000204d0: 2064 665f 4753 415f 7363 6f72 655f 6375   df_GSA_score_cu
-000204e0: 722c 200a 2020 2020 2020 2020 2020 2020  r, .            
+000203f0: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
+00020400: 286e 6569 5f69 6e64 6963 6573 2e73 6861  (nei_indices.sha
+00020410: 7065 2c20 6466 5f47 5341 5f73 636f 7265  pe, df_GSA_score
+00020420: 5f63 7572 2e73 6861 7065 2c20 666c 7573  _cur.shape, flus
+00020430: 6820 3d20 5472 7565 290a 2020 2020 2020  h = True).      
+00020440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020450: 2020 2020 2020 6966 206b 6e6e 5f74 7970        if knn_typ
+00020460: 6520 3d3d 2030 3a0a 2020 2020 2020 2020  e == 0:.        
+00020470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020480: 2020 2020 2020 2020 795f 7072 6564 5f63          y_pred_c
+00020490: 7572 2c20 7363 6f72 655f 7570 203d 2061  ur, score_up = a
+000204a0: 7070 6c79 5f6b 6e6e 286e 6569 5f69 6e64  pply_knn(nei_ind
+000204b0: 6963 6573 2c20 795f 7072 6564 5f63 7572  ices, y_pred_cur
+000204c0: 2c20 6466 5f47 5341 5f73 636f 7265 5f63  , df_GSA_score_c
+000204d0: 7572 2c20 0a20 2020 2020 2020 2020 2020  ur, .           
+000204e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000204f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00020500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020520: 2020 2020 2020 706d 616a 203d 2030 2e35        pmaj = 0.5
-00020530: 2c20 6e6c 6f67 5f70 7661 6c5f 7468 203d  , nlog_pval_th =
-00020540: 202d 6e70 2e6c 6f67 3130 2870 7661 6c5f   -np.log10(pval_
-00020550: 7468 2929 2020 2020 2020 2020 0a20 2020  th))        .   
-00020560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020570: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00020510: 2020 2020 2020 706d 616a 203d 2030 2e35        pmaj = 0.5
+00020520: 2c20 6e6c 6f67 5f70 7661 6c5f 7468 203d  , nlog_pval_th =
+00020530: 202d 6e70 2e6c 6f67 3130 2870 7661 6c5f   -np.log10(pval_
+00020540: 7468 2929 2020 2020 2020 2020 0a20 2020  th))        .   
+00020550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020560: 2020 2020 2020 2020 2065 6c69 6620 6b6e           elif kn
+00020570: 6e5f 7479 7065 203d 3d20 313a 0a20 2020  n_type == 1:.   
 00020580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020590: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-000205a0: 5f70 7265 645f 6375 722c 2073 636f 7265  _pred_cur, score
-000205b0: 5f75 7020 3d20 6170 706c 795f 6b6e 6e32  _up = apply_knn2
-000205c0: 286e 6569 5f69 6e64 6963 6573 2c20 795f  (nei_indices, y_
-000205d0: 7072 6564 5f63 7572 2c20 6466 5f47 5341  pred_cur, df_GSA
-000205e0: 5f73 636f 7265 5f63 7572 2c20 0a20 2020  _score_cur, .   
+00020590: 2020 2020 2020 2020 2020 2020 2079 5f70               y_p
+000205a0: 7265 645f 6375 722c 2073 636f 7265 5f75  red_cur, score_u
+000205b0: 7020 3d20 6170 706c 795f 6b6e 6e31 286e  p = apply_knn1(n
+000205c0: 6569 5f69 6e64 6963 6573 2c20 795f 7072  ei_indices, y_pr
+000205d0: 6564 5f63 7572 2c20 6466 5f47 5341 5f73  ed_cur, df_GSA_s
+000205e0: 636f 7265 5f63 7572 2c20 0a20 2020 2020  core_cur, .     
 000205f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00020600: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00020610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020620: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00020630: 6d61 6a20 3d20 302e 352c 206e 6c6f 675f  maj = 0.5, nlog_
-00020640: 7076 616c 5f74 6820 3d20 2d6e 702e 6c6f  pval_th = -np.lo
-00020650: 6731 3028 7076 616c 5f74 6829 2920 0a20  g10(pval_th)) . 
-00020660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020670: 2020 2020 2020 2020 2020 2023 2320 7363             ## sc
-00020680: 6f72 655f 7570 206e 6f74 2077 6f72 6b69  ore_up not worki
-00020690: 6e67 0a20 2020 2020 2020 2020 2020 2020  ng.             
-000206a0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000206b0: 2320 6466 5f47 5341 5f73 636f 7265 5f63  # df_GSA_score_c
-000206c0: 7572 203d 2073 636f 7265 5f75 700a 2020  ur = score_up.  
-000206d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000206e0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-000206f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020700: 2020 2069 6620 7665 7262 6f73 653a 2070     if verbose: p
-00020710: 7269 6e74 2827 646f 6e65 2e20 2825 6929  rint('done. (%i)
-00020720: 2027 2025 2028 726f 756e 6428 7469 6d65   ' % (round(time
-00020730: 2e74 696d 6528 2920 2d20 7374 6172 745f  .time() - start_
-00020740: 7469 6d65 2929 290a 0a0a 2020 2020 2020  time)))...      
-00020750: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00020760: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+00020620: 2020 2020 2020 2020 2020 2020 2070 6d61               pma
+00020630: 6a20 3d20 302e 352c 206e 6c6f 675f 7076  j = 0.5, nlog_pv
+00020640: 616c 5f74 6820 3d20 2d6e 702e 6c6f 6731  al_th = -np.log1
+00020650: 3028 7076 616c 5f74 6829 2920 2020 2020  0(pval_th))     
+00020660: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+00020670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020680: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00020690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000206a0: 2020 2020 2020 795f 7072 6564 5f63 7572        y_pred_cur
+000206b0: 2c20 7363 6f72 655f 7570 203d 2061 7070  , score_up = app
+000206c0: 6c79 5f6b 6e6e 3228 6e65 695f 696e 6469  ly_knn2(nei_indi
+000206d0: 6365 732c 2079 5f70 7265 645f 6375 722c  ces, y_pred_cur,
+000206e0: 2064 665f 4753 415f 7363 6f72 655f 6375   df_GSA_score_cu
+000206f0: 722c 200a 2020 2020 2020 2020 2020 2020  r, .            
+00020700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020730: 2020 2020 2020 706d 616a 203d 2030 2e35        pmaj = 0.5
+00020740: 2c20 6e6c 6f67 5f70 7661 6c5f 7468 203d  , nlog_pval_th =
+00020750: 202d 6e70 2e6c 6f67 3130 2870 7661 6c5f   -np.log10(pval_
+00020760: 7468 2929 200a 2020 2020 2020 2020 2020  th)) .          
 00020770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020780: 2020 7072 696e 7428 2725 7320 7375 6273    print('%s subs
-00020790: 6574 2069 6465 6e74 6966 6963 6174 696f  et identificatio
-000207a0: 6e20 646f 6e65 2e20 2825 6929 2720 2520  n done. (%i)' % 
-000207b0: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
-000207c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000207d0: 2863 2c20 726f 756e 6428 7469 6d65 2e74  (c, round(time.t
-000207e0: 696d 6528 2920 2d20 7374 6172 745f 7469  ime() - start_ti
-000207f0: 6d65 2929 290a 2020 2020 2020 2020 2020  me))).          
-00020800: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00020810: 706c 6f74 5f72 6f63 5f72 6573 756c 7428  plot_roc_result(
-00020820: 6466 5f73 636f 7265 5f63 7572 2c20 7973  df_score_cur, ys
-00020830: 5f63 7572 2c20 6d65 7468 6f64 290a 2020  _cur, method).  
-00020840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020850: 2020 656c 7365 3a20 7072 696e 7428 272e    else: print('.
-00020860: 272c 2065 6e64 203d 2027 272c 2066 6c75  ', end = '', flu
-00020870: 7368 203d 2054 7275 6529 0a0a 2020 2020  sh = True)..    
-00020880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020890: 6466 5f72 6573 5f63 7572 5b27 6365 6c6c  df_res_cur['cell
-000208a0: 5f74 7970 6527 5d20 3d20 795f 7072 6564  _type'] = y_pred
-000208b0: 5f63 7572 0a0a 2020 2020 2020 2020 2020  _cur..          
-000208c0: 2020 2020 2020 2020 2020 6964 7820 3d20            idx = 
-000208d0: 6c69 7374 2858 5f63 7572 2e69 6e64 6578  list(X_cur.index
-000208e0: 2e76 616c 7565 7329 0a20 2020 2020 2020  .values).       
-000208f0: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-00020900: 7072 6564 2e6c 6f63 5b69 6478 2c27 6365  pred.loc[idx,'ce
-00020910: 6c6c 5f74 7970 655f 7375 6273 6574 275d  ll_type_subset']
-00020920: 203d 2079 5f70 7265 645f 6375 720a 2020   = y_pred_cur.  
-00020930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020940: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
-00020950: 2020 2020 2020 2069 6620 7573 655f 6d69         if use_mi
-00020960: 6e6f 723a 0a20 2020 2020 2020 2020 2020  nor:.           
-00020970: 2020 2020 2020 2020 2020 2020 2070 6620               pf 
-00020980: 3d20 635b 305d 0a20 2020 2020 2020 2020  = c[0].         
-00020990: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000209a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000209b0: 2020 2020 2020 2020 2070 6620 3d20 7463           pf = tc
-000209c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000209d0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-000209e0: 2020 2020 2020 2020 2020 2020 2020 795f                y_
-000209f0: 636c 7573 745f 6375 7220 3d20 5b27 2573  clust_cur = ['%s
-00020a00: 5f25 6927 2025 2028 7066 2c20 6378 2920  _%i' % (pf, cx) 
-00020a10: 666f 7220 6378 2069 6e20 6c69 7374 2879  for cx in list(y
-00020a20: 5f63 6c75 7374 5f63 7572 295d 0a20 2020  _clust_cur)].   
-00020a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020a40: 2023 2064 665f 7072 6564 2e6c 6f63 5b69   # df_pred.loc[i
-00020a50: 6478 2c27 636c 7573 7465 7227 5d20 3d20  dx,'cluster'] = 
-00020a60: 795f 636c 7573 745f 6375 720a 2020 2020  y_clust_cur.    
+00020780: 2020 2323 2073 636f 7265 5f75 7020 6e6f    ## score_up no
+00020790: 7420 776f 726b 696e 670a 2020 2020 2020  t working.      
+000207a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000207b0: 2020 2020 2020 2323 2064 665f 4753 415f        ## df_GSA_
+000207c0: 7363 6f72 655f 6375 7220 3d20 7363 6f72  score_cur = scor
+000207d0: 655f 7570 0a20 2020 2020 2020 2020 2020  e_up.           
+000207e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000207f0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+00020800: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
+00020810: 626f 7365 3a20 7072 696e 7428 2764 6f6e  bose: print('don
+00020820: 652e 2028 2569 2920 2720 2520 2872 6f75  e. (%i) ' % (rou
+00020830: 6e64 2874 696d 652e 7469 6d65 2829 202d  nd(time.time() -
+00020840: 2073 7461 7274 5f74 696d 6529 2929 0a0a   start_time)))..
+00020850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020860: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
+00020870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020880: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+00020890: 2573 2073 7562 7365 7420 6964 656e 7469  %s subset identi
+000208a0: 6669 6361 7469 6f6e 2064 6f6e 652e 2028  fication done. (
+000208b0: 2569 2927 2025 205c 0a20 2020 2020 2020  %i)' % \.       
+000208c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000208d0: 2020 2020 2020 2028 632c 2072 6f75 6e64         (c, round
+000208e0: 2874 696d 652e 7469 6d65 2829 202d 2073  (time.time() - s
+000208f0: 7461 7274 5f74 696d 6529 2929 0a20 2020  tart_time))).   
+00020900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020910: 2020 2020 2023 2070 6c6f 745f 726f 635f       # plot_roc_
+00020920: 7265 7375 6c74 2864 665f 7363 6f72 655f  result(df_score_
+00020930: 6375 722c 2079 735f 6375 722c 206d 6574  cur, ys_cur, met
+00020940: 686f 6429 0a20 2020 2020 2020 2020 2020  hod).           
+00020950: 2020 2020 2020 2020 2065 6c73 653a 2070           else: p
+00020960: 7269 6e74 2827 2e27 2c20 656e 6420 3d20  rint('.', end = 
+00020970: 2727 2c20 666c 7573 6820 3d20 5472 7565  '', flush = True
+00020980: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00020990: 2020 2020 2020 2064 665f 7265 735f 6375         df_res_cu
+000209a0: 725b 2763 656c 6c5f 7479 7065 275d 203d  r['cell_type'] =
+000209b0: 2079 5f70 7265 645f 6375 720a 0a20 2020   y_pred_cur..   
+000209c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000209d0: 2069 6478 203d 206c 6973 7428 585f 6375   idx = list(X_cu
+000209e0: 722e 696e 6465 782e 7661 6c75 6573 290a  r.index.values).
+000209f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020a00: 2020 2020 6466 5f70 7265 642e 6c6f 635b      df_pred.loc[
+00020a10: 6964 782c 2763 656c 6c5f 7479 7065 5f73  idx,'cell_type_s
+00020a20: 7562 7365 7427 5d20 3d20 795f 7072 6564  ubset'] = y_pred
+00020a30: 5f63 7572 0a20 2020 2020 2020 2020 2020  _cur.           
+00020a40: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+00020a50: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00020a60: 2075 7365 5f6d 696e 6f72 3a0a 2020 2020   use_minor:.    
 00020a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020a80: 6466 5f70 7265 6432 2e6c 6f63 5b69 6478  df_pred2.loc[idx
-00020a90: 2c27 636c 7573 7465 725f 7265 7627 5d20  ,'cluster_rev'] 
-00020aa0: 3d20 795f 636c 7573 745f 6375 720a 0a20  = y_clust_cur.. 
+00020a80: 2020 2020 7066 203d 2063 5b30 5d0a 2020      pf = c[0].  
+00020a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020aa0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
 00020ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020ac0: 2020 2064 665f 7072 6564 2e6c 6f63 5b69     df_pred.loc[i
-00020ad0: 6478 2c20 2763 656c 6c5f 7479 7065 5f73  dx, 'cell_type_s
-00020ae0: 7562 7365 7428 3173 7429 275d 203d 2064  ubset(1st)'] = d
-00020af0: 665f 7265 735f 6375 725b 2763 656c 6c5f  f_res_cur['cell_
-00020b00: 7479 7065 2831 7374 2927 5d2e 6173 7479  type(1st)'].asty
-00020b10: 7065 2873 7472 290a 2020 2020 2020 2020  pe(str).        
-00020b20: 2020 2020 2020 2020 2020 2020 6466 5f70              df_p
-00020b30: 7265 642e 6c6f 635b 6964 782c 2027 436f  red.loc[idx, 'Co
-00020b40: 6e66 6964 656e 6365 5f73 7562 7365 7428  nfidence_subset(
-00020b50: 3173 7429 275d 203d 2064 665f 7265 735f  1st)'] = df_res_
-00020b60: 6375 725b 272d 6c6f 6750 275d 2e61 7374  cur['-logP'].ast
-00020b70: 7970 6528 666c 6f61 7429 0a20 2020 2020  ype(float).     
-00020b80: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00020b90: 665f 7072 6564 2e6c 6f63 5b69 6478 2c20  f_pred.loc[idx, 
-00020ba0: 2763 656c 6c5f 7479 7065 5f73 7562 7365  'cell_type_subse
-00020bb0: 7428 326e 6429 275d 203d 2064 665f 7265  t(2nd)'] = df_re
-00020bc0: 735f 6375 725b 2763 656c 6c5f 7479 7065  s_cur['cell_type
-00020bd0: 2832 6e64 2927 5d2e 6173 7479 7065 2873  (2nd)'].astype(s
-00020be0: 7472 290a 2020 2020 2020 2020 2020 2020  tr).            
-00020bf0: 2020 2020 2020 2020 6466 5f70 7265 642e          df_pred.
-00020c00: 6c6f 635b 6964 782c 2027 436f 6e66 6964  loc[idx, 'Confid
-00020c10: 656e 6365 5f73 7562 7365 7428 326e 6429  ence_subset(2nd)
-00020c20: 275d 203d 2064 665f 7265 735f 6375 725b  '] = df_res_cur[
-00020c30: 272d 6c6f 6750 2832 6e64 2927 5d2e 6173  '-logP(2nd)'].as
-00020c40: 7479 7065 2866 6c6f 6174 290a 0a20 2020  type(float)..   
-00020c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020c60: 2069 6620 6466 5f72 6573 5f63 7572 2e73   if df_res_cur.s
-00020c70: 6861 7065 5b30 5d20 3e20 303a 0a20 2020  hape[0] > 0:.   
-00020c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020c90: 2020 2020 2064 6963 745f 7375 6d6d 6172       dict_summar
-00020ca0: 795f 7265 735b 2725 7320 7375 6273 6574  y_res['%s subset
-00020cb0: 2720 2520 7066 5d20 3d20 6466 5f72 6573  ' % pf] = df_res
-00020cc0: 5f63 7572 0a20 2020 2020 2020 2020 2020  _cur.           
-00020cd0: 2020 2020 2020 2020 2020 2020 2064 6963               dic
-00020ce0: 745f 7375 6d6d 6172 795f 7363 6f72 655b  t_summary_score[
-00020cf0: 2725 7320 7375 6273 6574 2720 2520 7066  '%s subset' % pf
-00020d00: 5d20 3d20 6466 5f73 636f 7265 5f63 7572  ] = df_score_cur
-00020d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020d20: 2020 2020 2020 2020 2064 6963 745f 7375           dict_su
-00020d30: 6d6d 6172 795f 7363 6f72 6532 5b27 2573  mmary_score2['%s
-00020d40: 2073 7562 7365 7427 2025 2070 665d 203d   subset' % pf] =
-00020d50: 2064 665f 4753 415f 7363 6f72 655f 6375   df_GSA_score_cu
-00020d60: 720a 0a20 2020 2020 2020 2062 5f63 7572  r..        b_cur
-00020d70: 203d 2079 5f70 7265 645f 636f 7272 6563   = y_pred_correc
-00020d80: 7420 3d3d 2027 756e 6173 7369 676e 6564  t == 'unassigned
-00020d90: 270a 2020 2020 2020 2020 6966 2076 6572  '.        if ver
-00020da0: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
-00020db0: 2020 7072 696e 7428 274e 756d 206f 6620    print('Num of 
-00020dc0: 756e 6173 7369 676e 6564 2063 656c 6c73  unassigned cells
-00020dd0: 3a20 2569 2061 6d6f 6e67 2025 6927 2025  : %i among %i' %
-00020de0: 2028 6e70 2e73 756d 2862 5f63 7572 292c   (np.sum(b_cur),
-00020df0: 206c 656e 2862 5f63 7572 2929 290a 2020   len(b_cur))).  
-00020e00: 2020 0a20 2020 2023 2320 656e 6420 6f66    .    ## end of
-00020e10: 2073 7562 7365 7420 6964 2e0a 0a20 2020   subset id...   
-00020e20: 2023 2323 2053 6574 206d 696e 6f72 2074   ### Set minor t
-00020e30: 7970 6520 6261 7365 6420 6f6e 2069 7473  ype based on its
-00020e40: 2073 7562 7365 740a 2020 2020 2327 2727   subset.    #'''
-00020e50: 0a20 2020 2069 6620 6e6f 7420 7573 655f  .    if not use_
-00020e60: 6d69 6e6f 723a 0a20 2020 2020 2020 2079  minor:.        y
-00020e70: 5f70 7265 645f 7375 6273 6574 203d 206c  _pred_subset = l
-00020e80: 6973 7428 6466 5f70 7265 645b 2763 656c  ist(df_pred['cel
-00020e90: 6c5f 7479 7065 5f73 7562 7365 7427 5d29  l_type_subset'])
-00020ea0: 0a20 2020 2020 2020 2079 5f70 7265 645f  .        y_pred_
-00020eb0: 6d69 6e6f 7220 3d20 5b5d 0a20 2020 2020  minor = [].     
-00020ec0: 2020 2066 6f72 2079 2069 6e20 795f 7072     for y in y_pr
-00020ed0: 6564 5f73 7562 7365 743a 0a20 2020 2020  ed_subset:.     
-00020ee0: 2020 2020 2020 2069 6620 7920 213d 2027         if y != '
-00020ef0: 756e 6173 7369 676e 6564 273a 0a20 2020  unassigned':.   
-00020f00: 2020 2020 2020 2020 2020 2020 2079 5f70               y_p
-00020f10: 7265 645f 6d69 6e6f 722e 6170 7065 6e64  red_minor.append
-00020f20: 2820 6d61 705f 6469 6374 5f73 7562 326d  ( map_dict_sub2m
-00020f30: 696e 5b79 5d20 290a 2020 2020 2020 2020  in[y] ).        
-00020f40: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00020f50: 2020 2020 2020 2020 2020 795f 7072 6564            y_pred
-00020f60: 5f6d 696e 6f72 2e61 7070 656e 6428 2027  _minor.append( '
-00020f70: 756e 6173 7369 676e 6564 2720 290a 2020  unassigned' ).  
-00020f80: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-00020f90: 2020 2020 2020 2023 2070 7269 6e74 2827         # print('
-00020fa0: 5c6e 272c 206e 702e 7375 6d28 6466 5f70  \n', np.sum(df_p
-00020fb0: 7265 645b 2763 656c 6c5f 7479 7065 5f6d  red['cell_type_m
-00020fc0: 696e 6f72 275d 203d 3d20 6e70 2e61 7272  inor'] == np.arr
-00020fd0: 6179 2879 5f70 7265 645f 6d69 6e6f 7229  ay(y_pred_minor)
-00020fe0: 292c 2027 202f 2027 2c20 6c65 6e28 795f  ), ' / ', len(y_
-00020ff0: 7072 6564 5f6d 696e 6f72 292c 2065 6e64  pred_minor), end
-00021000: 203d 2027 2729 0a20 2020 2020 2020 2064   = '').        d
-00021010: 665f 7072 6564 5b27 6365 6c6c 5f74 7970  f_pred['cell_typ
-00021020: 655f 6d69 6e6f 725f 6f72 6727 5d20 3d20  e_minor_org'] = 
-00021030: 6466 5f70 7265 645b 2763 656c 6c5f 7479  df_pred['cell_ty
-00021040: 7065 5f6d 696e 6f72 275d 2e63 6f70 7928  pe_minor'].copy(
-00021050: 6465 6570 203d 2054 7275 6529 0a20 2020  deep = True).   
-00021060: 2020 2020 2064 665f 7072 6564 5b27 6365       df_pred['ce
-00021070: 6c6c 5f74 7970 655f 6d69 6e6f 7227 5d20  ll_type_minor'] 
-00021080: 3d20 795f 7072 6564 5f6d 696e 6f72 0a20  = y_pred_minor. 
-00021090: 2020 2023 2727 270a 2020 2020 2020 2020     #'''.        
-000210a0: 2020 2020 0a20 2020 2023 2727 270a 2020      .    #'''.  
-000210b0: 2020 2323 2320 4964 656e 7469 6679 2063    ### Identify c
-000210c0: 7963 6c69 6e67 2063 656c 6c73 0a20 2020  ycling cells.   
-000210d0: 2069 6620 6379 636c 696e 675f 6365 6c6c   if cycling_cell
-000210e0: 2026 2028 274d 4b49 3637 2720 696e 206c   & ('MKI67' in l
-000210f0: 6973 7428 5873 2e63 6f6c 756d 6e73 2e76  ist(Xs.columns.v
-00021100: 616c 7565 7329 293a 0a20 2020 2020 2020  alues)):.       
-00021110: 2062 203d 2058 735b 274d 4b49 3637 275d   b = Xs['MKI67']
-00021120: 203e 2030 0a20 2020 2020 2020 200a 2020   > 0.        .  
-00021130: 2020 2020 2020 795f 6e65 7720 3d20 5b5d        y_new = []
-00021140: 0a20 2020 2020 2020 2023 2079 5f70 7265  .        # y_pre
-00021150: 645f 6d61 6a6f 7220 3d20 6c69 7374 2864  d_major = list(d
-00021160: 665f 7072 6564 2e6c 6f63 5b62 2c20 2763  f_pred.loc[b, 'c
-00021170: 656c 6c5f 7479 7065 5f6d 696e 6f72 275d  ell_type_minor']
-00021180: 290a 2020 2020 2020 2020 795f 7072 6564  ).        y_pred
-00021190: 5f6d 616a 6f72 203d 206c 6973 7428 6466  _major = list(df
-000211a0: 5f70 7265 642e 6c6f 635b 622c 2027 6365  _pred.loc[b, 'ce
-000211b0: 6c6c 5f74 7970 655f 6d61 6a6f 7227 5d29  ll_type_major'])
-000211c0: 0a20 2020 2020 2020 2066 6f72 2079 2069  .        for y i
-000211d0: 6e20 795f 7072 6564 5f6d 616a 6f72 3a0a  n y_pred_major:.
-000211e0: 2020 2020 2020 2020 2020 2020 6966 2079              if y
-000211f0: 2021 3d20 2775 6e61 7373 6967 6e65 6427   != 'unassigned'
-00021200: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00021210: 2020 795f 6e65 772e 6170 7065 6e64 2827    y_new.append('
-00021220: 2573 2043 7963 6c69 6e67 2720 2520 7929  %s Cycling' % y)
-00021230: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00021240: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00021250: 2020 2079 5f6e 6577 2e61 7070 656e 6428     y_new.append(
-00021260: 7929 0a20 2020 2020 2020 2020 2020 2020  y).             
-00021270: 2020 200a 2020 2020 2020 2020 6466 5f70     .        df_p
-00021280: 7265 642e 6c6f 635b 622c 2027 6365 6c6c  red.loc[b, 'cell
-00021290: 5f74 7970 655f 6d69 6e6f 7227 5d20 3d20  _type_minor'] = 
-000212a0: 795f 6e65 770a 2020 2020 2020 2020 6466  y_new.        df
-000212b0: 5f70 7265 642e 6c6f 635b 622c 2027 6365  _pred.loc[b, 'ce
-000212c0: 6c6c 5f74 7970 655f 7375 6273 6574 275d  ll_type_subset']
-000212d0: 203d 2079 5f6e 6577 0a20 2020 2023 2727   = y_new.    #''
-000212e0: 270a 2020 2020 6466 5f70 7265 645b 2763  '.    df_pred['c
-000212f0: 6c75 7374 6572 5f72 6576 275d 203d 2064  luster_rev'] = d
-00021300: 665f 7072 6564 325b 2763 6c75 7374 6572  f_pred2['cluster
-00021310: 5f72 6576 275d 2e61 7374 7970 6528 7374  _rev'].astype(st
-00021320: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-00021330: 2020 200a 2020 2020 6966 2076 6572 626f     .    if verbo
-00021340: 7365 3a20 0a20 2020 2020 2020 2070 7269  se: .        pri
-00021350: 6e74 2827 4869 4341 5420 646f 6e65 2e20  nt('HiCAT done. 
-00021360: 2825 6929 2720 2520 726f 756e 6428 7469  (%i)' % round(ti
-00021370: 6d65 2e74 696d 6528 2920 2d20 7374 6172  me.time() - star
-00021380: 745f 7469 6d65 2929 0a20 2020 2065 6c73  t_time)).    els
-00021390: 653a 0a20 2020 2020 2020 2065 7469 6d65  e:.        etime
-000213a0: 203d 2072 6f75 6e64 2874 696d 652e 7469   = round(time.ti
-000213b0: 6d65 2829 202d 2073 7461 7274 5f74 696d  me() - start_tim
-000213c0: 655f 6e65 7729 2020 2020 2020 2020 0a20  e_new)        . 
-000213d0: 2020 2020 2020 2073 7461 7274 5f74 696d         start_tim
-000213e0: 655f 6e65 7720 3d20 7469 6d65 2e74 696d  e_new = time.tim
-000213f0: 6528 290a 2020 2020 2020 2020 7072 696e  e().        prin
-00021400: 7428 2753 2569 2e27 2025 2065 7469 6d65  t('S%i.' % etime
-00021410: 2c20 656e 6420 3d20 2727 2c20 666c 7573  , end = '', flus
-00021420: 6820 3d20 5472 7565 290a 2020 2020 2020  h = True).      
-00021430: 2020 2320 7072 696e 7428 272e 272c 2065    # print('.', e
-00021440: 6e64 203d 2027 272c 2066 6c75 7368 203d  nd = '', flush =
-00021450: 2054 7275 6529 0a20 2020 2020 2020 2070   True).        p
-00021460: 7269 6e74 2827 2064 6f6e 652e 2028 2569  rint(' done. (%i
-00021470: 2927 2025 2072 6f75 6e64 2874 696d 652e  )' % round(time.
-00021480: 7469 6d65 2829 202d 2073 7461 7274 5f74  time() - start_t
-00021490: 696d 6529 290a 2020 2020 2020 2020 0a20  ime)).        . 
-000214a0: 2020 2064 6963 745f 7375 6d6d 6172 6965     dict_summarie
-000214b0: 7320 3d20 7b7d 0a20 2020 2064 6963 745f  s = {}.    dict_
-000214c0: 7375 6d6d 6172 6965 735b 2747 5341 5f73  summaries['GSA_s
-000214d0: 756d 6d61 7279 275d 203d 2064 6963 745f  ummary'] = dict_
-000214e0: 7375 6d6d 6172 795f 7265 730a 2020 2020  summary_res.    
-000214f0: 6469 6374 5f73 756d 6d61 7269 6573 5b27  dict_summaries['
-00021500: 4753 415f 7363 6f72 6573 275d 203d 2064  GSA_scores'] = d
-00021510: 6963 745f 7375 6d6d 6172 795f 7363 6f72  ict_summary_scor
-00021520: 6532 0a20 2020 2064 6963 745f 7375 6d6d  e2.    dict_summ
-00021530: 6172 6965 735b 2752 6566 5f73 636f 7265  aries['Ref_score
-00021540: 7327 5d20 3d20 6469 6374 5f73 756d 6d61  s'] = dict_summa
-00021550: 7279 5f73 636f 7265 330a 2020 2020 6469  ry_score3.    di
-00021560: 6374 5f73 756d 6d61 7269 6573 5b27 4964  ct_summaries['Id
-00021570: 656e 7469 6669 6361 7469 6f6e 5f6d 6f64  entification_mod
-00021580: 656c 5f73 636f 7265 7327 5d20 3d20 6469  el_scores'] = di
-00021590: 6374 5f73 756d 6d61 7279 5f73 636f 7265  ct_summary_score
-000215a0: 0a20 2020 2064 6963 745f 7375 6d6d 6172  .    dict_summar
-000215b0: 6965 735b 2770 6172 616d 6574 6572 7327  ies['parameters'
-000215c0: 5d20 3d20 5b70 7661 6c5f 7468 2c20 7074  ] = [pval_th, pt
-000215d0: 685f 6669 745f 706e 742c 2070 6374 5f74  h_fit_pnt, pct_t
-000215e0: 685f 6d69 6e5d 0a20 2020 2064 6963 745f  h_min].    dict_
-000215f0: 7375 6d6d 6172 6965 735b 2758 5f70 6361  summaries['X_pca
-00021600: 275d 203d 2058 5f70 6361 0a20 2020 200a  '] = X_pca.    .
-00021610: 2020 2020 2020 200a 2020 2020 7265 7475         .    retu
-00021620: 726e 2064 665f 7072 6564 2c20 6469 6374  rn df_pred, dict
-00021630: 5f73 756d 6d61 7269 6573 0a0a 0a23 2323  _summaries...###
-00021640: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00021650: 0a23 2323 2050 6c6f 745f 646f 7420 2323  .### Plot_dot ##
-00021660: 2323 2323 0a0a 696d 706f 7274 2077 6172  ####..import war
-00021670: 6e69 6e67 730a 0a64 6566 2072 656d 6f76  nings..def remov
-00021680: 655f 636f 6d6d 6f6e 2820 6d6b 725f 6469  e_common( mkr_di
-00021690: 6374 2c20 7072 6e20 3d20 5472 7565 2029  ct, prn = True )
-000216a0: 3a0a 0a20 2020 2063 7473 203d 206c 6973  :..    cts = lis
-000216b0: 7428 6d6b 725f 6469 6374 2e6b 6579 7328  t(mkr_dict.keys(
-000216c0: 2929 0a20 2020 206d 6b72 735f 616c 6c20  )).    mkrs_all 
-000216d0: 3d20 5b5d 0a20 2020 2066 6f72 2063 2069  = [].    for c i
-000216e0: 6e20 6374 733a 0a20 2020 2020 2020 206d  n cts:.        m
-000216f0: 6b72 735f 616c 6c20 3d20 6d6b 7273 5f61  krs_all = mkrs_a
-00021700: 6c6c 202b 206d 6b72 5f64 6963 745b 635d  ll + mkr_dict[c]
-00021710: 0a20 2020 206d 6b72 735f 616c 6c20 3d20  .    mkrs_all = 
-00021720: 6c69 7374 2873 6574 286d 6b72 735f 616c  list(set(mkrs_al
-00021730: 6c29 290a 2020 2020 6466 203d 2070 642e  l)).    df = pd.
-00021740: 4461 7461 4672 616d 6528 696e 6465 7820  DataFrame(index 
-00021750: 3d20 6d6b 7273 5f61 6c6c 2c20 636f 6c75  = mkrs_all, colu
-00021760: 6d6e 7320 3d20 6374 7329 0a20 2020 2064  mns = cts).    d
-00021770: 662e 6c6f 635b 3a2c 3a5d 203d 2030 0a0a  f.loc[:,:] = 0..
-00021780: 2020 2020 666f 7220 6320 696e 2063 7473      for c in cts
-00021790: 3a0a 2020 2020 2020 2020 6466 2e6c 6f63  :.        df.loc
-000217a0: 5b6d 6b72 5f64 6963 745b 635d 2c20 635d  [mkr_dict[c], c]
-000217b0: 203d 2031 0a20 2020 2053 756d 203d 2064   = 1.    Sum = d
-000217c0: 662e 7375 6d28 6178 6973 203d 2031 290a  f.sum(axis = 1).
-000217d0: 2020 2020 0a20 2020 2074 6f5f 6465 6c20      .    to_del 
-000217e0: 3d20 5b5d 0a20 2020 2073 203d 2027 270a  = [].    s = ''.
-000217f0: 2020 2020 666f 7220 6320 696e 2063 7473      for c in cts
-00021800: 3a0a 2020 2020 2020 2020 6220 3d20 2864  :.        b = (d
-00021810: 665b 635d 203e 2030 2920 2620 2853 756d  f[c] > 0) & (Sum
-00021820: 203d 3d20 3129 0a20 2020 2020 2020 206d   == 1).        m
-00021830: 6b72 7331 203d 206c 6973 7428 6466 2e69  krs1 = list(df.i
-00021840: 6e64 6578 2e76 616c 7565 735b 625d 290a  ndex.values[b]).
-00021850: 2020 2020 2020 2020 6966 2070 726e 2026          if prn &
-00021860: 2028 6c65 6e28 6d6b 725f 6469 6374 5b63   (len(mkr_dict[c
-00021870: 5d29 2021 3d20 6c65 6e28 6d6b 7273 3129  ]) != len(mkrs1)
-00021880: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-00021890: 203d 2073 202b 2027 2573 3a20 2569 203e   = s + '%s: %i >
-000218a0: 2025 692c 2027 2025 2028 632c 206c 656e   %i, ' % (c, len
-000218b0: 286d 6b72 5f64 6963 745b 635d 292c 206c  (mkr_dict[c]), l
-000218c0: 656e 286d 6b72 7331 2929 0a20 2020 2020  en(mkrs1)).     
-000218d0: 2020 200a 2020 2020 2020 2020 6966 206c     .        if l
-000218e0: 656e 286d 6b72 7331 2920 3d3d 2030 3a0a  en(mkrs1) == 0:.
-000218f0: 2020 2020 2020 2020 2020 2020 746f 5f64              to_d
-00021900: 656c 2e61 7070 656e 6428 6329 0a20 2020  el.append(c).   
-00021910: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00021920: 2020 2020 2020 206d 6b72 5f64 6963 745b         mkr_dict[
-00021930: 635d 203d 206d 6b72 7331 0a0a 2020 2020  c] = mkrs1..    
-00021940: 6966 2070 726e 2026 206c 656e 2873 2920  if prn & len(s) 
-00021950: 3e20 303a 0a20 2020 2020 2020 2070 7269  > 0:.        pri
-00021960: 6e74 2873 5b3a 2d32 5d29 0a0a 2020 2020  nt(s[:-2])..    
-00021970: 6966 206c 656e 2874 6f5f 6465 6c29 203e  if len(to_del) >
-00021980: 2030 3a0a 2020 2020 2020 2020 666f 7220   0:.        for 
-00021990: 6320 696e 2063 7473 3a0a 2020 2020 2020  c in cts:.      
-000219a0: 2020 2020 2020 6966 2063 2069 6e20 746f        if c in to
-000219b0: 5f64 656c 3a0a 2020 2020 2020 2020 2020  _del:.          
-000219c0: 2020 2020 2020 6465 6c20 6d6b 725f 6469        del mkr_di
-000219d0: 6374 5b63 5d0a 2020 2020 2020 2020 2020  ct[c].          
-000219e0: 2020 2020 2020 0a20 2020 2072 6574 7572        .    retur
-000219f0: 6e20 6d6b 725f 6469 6374 0a0a 0a64 6566  n mkr_dict...def
-00021a00: 2067 6574 5f6d 6172 6b65 7273 5f61 6c6c   get_markers_all
-00021a10: 3328 6d6b 725f 6669 6c65 2c20 7461 7267  3(mkr_file, targ
-00021a20: 6574 5f6c 7374 2c20 706e 7368 3132 2c20  et_lst, pnsh12, 
-00021a30: 6765 6e65 7320 3d20 4e6f 6e65 2c20 6c65  genes = None, le
-00021a40: 7665 6c20 3d20 312c 200a 2020 2020 2020  vel = 1, .      
-00021a50: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00021a60: 6d5f 636d 6e20 3d20 4661 6c73 652c 2063  m_cmn = False, c
-00021a70: 6f6d 625f 6d6b 7273 203d 2046 616c 7365  omb_mkrs = False
-00021a80: 2029 3a0a 2020 2020 0a20 2020 2023 2074   ):.    .    # t
-00021a90: 6172 6765 7420 3d20 274d 7965 6c6f 6964  arget = 'Myeloid
-00021aa0: 2063 656c 6c27 0a20 2020 2069 6620 6c65   cell'.    if le
-00021ab0: 7665 6c20 3d3d 2030 3a0a 2020 2020 2020  vel == 0:.      
-00021ac0: 2020 6d6b 725f 6469 6374 2c20 6d6b 725f    mkr_dict, mkr_
-00021ad0: 6469 6374 5f6e 6567 203d 205c 0a20 2020  dict_neg = \.   
-00021ae0: 2020 2020 2020 2020 2067 6574 5f6d 6172           get_mar
-00021af0: 6b65 7273 5f6d 616a 6f72 5f74 7970 6528  kers_major_type(
-00021b00: 6d6b 725f 6669 6c65 2c20 7461 7267 6574  mkr_file, target
-00021b10: 5f63 656c 6c73 203d 2074 6172 6765 745f  _cells = target_
-00021b20: 6c73 742c 200a 2020 2020 2020 2020 2020  lst, .          
-00021b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021b40: 2020 2020 2020 2020 2020 706e 7368 3132            pnsh12
-00021b50: 203d 2070 6e73 6831 322c 2072 656d 5f63   = pnsh12, rem_c
-00021b60: 6f6d 6d6f 6e20 3d20 4661 6c73 652c 2076  ommon = False, v
-00021b70: 6572 626f 7365 203d 2046 616c 7365 290a  erbose = False).
-00021b80: 2020 2020 656c 6966 206c 6576 656c 203d      elif level =
-00021b90: 3d20 313a 0a20 2020 2020 2020 206d 6b72  = 1:.        mkr
-00021ba0: 5f64 6963 742c 206d 6b72 5f64 6963 745f  _dict, mkr_dict_
-00021bb0: 6e65 6720 3d20 5c0a 2020 2020 2020 2020  neg = \.        
-00021bc0: 2020 2020 6765 745f 6d61 726b 6572 735f      get_markers_
-00021bd0: 6d69 6e6f 725f 7479 7065 3228 6d6b 725f  minor_type2(mkr_
-00021be0: 6669 6c65 2c20 7461 7267 6574 5f63 656c  file, target_cel
-00021bf0: 6c73 203d 2074 6172 6765 745f 6c73 742c  ls = target_lst,
-00021c00: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00021c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021c20: 2020 2020 2020 706e 7368 3132 203d 2070        pnsh12 = p
-00021c30: 6e73 6831 322c 2063 6f6d 625f 6d6b 7273  nsh12, comb_mkrs
-00021c40: 203d 2063 6f6d 625f 6d6b 7273 2c20 0a20   = comb_mkrs, . 
-00021c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021c70: 2020 2072 656d 5f63 6f6d 6d6f 6e20 3d20     rem_common = 
-00021c80: 4661 6c73 652c 2076 6572 626f 7365 203d  False, verbose =
-00021c90: 2046 616c 7365 290a 2020 2020 656c 7365   False).    else
-00021ca0: 3a0a 2020 2020 2020 2020 6d6b 725f 6469  :.        mkr_di
-00021cb0: 6374 2c20 6d6b 725f 6469 6374 5f6e 6567  ct, mkr_dict_neg
-00021cc0: 203d 205c 0a20 2020 2020 2020 2020 2020   = \.           
-00021cd0: 2067 6574 5f6d 6172 6b65 7273 5f63 656c   get_markers_cel
-00021ce0: 6c5f 7479 7065 286d 6b72 5f66 696c 652c  l_type(mkr_file,
-00021cf0: 2074 6172 6765 745f 6365 6c6c 7320 3d20   target_cells = 
-00021d00: 7461 7267 6574 5f6c 7374 2c20 706e 7368  target_lst, pnsh
-00021d10: 3132 203d 2070 6e73 6831 322c 0a20 2020  12 = pnsh12,.   
-00021d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021d30: 2020 2020 2020 2072 656d 5f63 6f6d 6d6f         rem_commo
-00021d40: 6e20 3d20 4661 6c73 652c 2076 6572 626f  n = False, verbo
-00021d50: 7365 203d 2046 616c 7365 290a 2020 2020  se = False).    
-00021d60: 2020 2020 0a20 2020 2069 6620 7265 6d5f      .    if rem_
-00021d70: 636d 6e3a 0a20 2020 2020 2020 206d 6b72  cmn:.        mkr
-00021d80: 5f64 6963 7420 3d20 7265 6d6f 7665 5f63  _dict = remove_c
-00021d90: 6f6d 6d6f 6e28 206d 6b72 5f64 6963 742c  ommon( mkr_dict,
-00021da0: 2070 726e 203d 2054 7275 6520 290a 2020   prn = True ).  
-00021db0: 2020 2020 2020 0a20 2020 206d 6b72 735f        .    mkrs_
-00021dc0: 616c 6c20 3d20 5b5d 2023 5b27 5345 4c4c  all = [] #['SELL
-00021dd0: 275d 0a20 2020 206d 6b72 735f 636d 6e20  '].    mkrs_cmn 
-00021de0: 3d20 5b5d 0a20 2020 2066 6f72 2063 7420  = [].    for ct 
-00021df0: 696e 206d 6b72 5f64 6963 742e 6b65 7973  in mkr_dict.keys
-00021e00: 2829 3a0a 2020 2020 2020 2020 6966 2067  ():.        if g
-00021e10: 656e 6573 2069 7320 6e6f 7420 4e6f 6e65  enes is not None
-00021e20: 3a0a 2020 2020 2020 2020 2020 2020 6d73  :.            ms
-00021e30: 203d 206c 6973 7428 7365 7428 6d6b 725f   = list(set(mkr_
-00021e40: 6469 6374 5b63 745d 292e 696e 7465 7273  dict[ct]).inters
-00021e50: 6563 7469 6f6e 2867 656e 6573 2929 0a20  ection(genes)). 
-00021e60: 2020 2020 2020 2065 6c73 653a 200a 2020         else: .  
-00021e70: 2020 2020 2020 2020 2020 6d73 203d 206d            ms = m
-00021e80: 6b72 5f64 6963 745b 6374 5d0a 2020 2020  kr_dict[ct].    
-00021e90: 2020 2020 6d6b 7273 5f61 6c6c 203d 206d      mkrs_all = m
-00021ea0: 6b72 735f 616c 6c20 2b20 6d73 0a20 2020  krs_all + ms.   
-00021eb0: 2020 2020 2069 6620 6c65 6e28 6d6b 7273       if len(mkrs
-00021ec0: 5f63 6d6e 2920 3d3d 2030 3a0a 2020 2020  _cmn) == 0:.    
-00021ed0: 2020 2020 2020 2020 6d6b 7273 5f63 6d6e          mkrs_cmn
-00021ee0: 203d 206d 730a 2020 2020 2020 2020 656c   = ms.        el
-00021ef0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00021f00: 6d6b 7273 5f63 6d6e 203d 206c 6973 7428  mkrs_cmn = list(
-00021f10: 7365 7428 6d6b 7273 5f63 6d6e 292e 696e  set(mkrs_cmn).in
-00021f20: 7465 7273 6563 7469 6f6e 286d 7329 290a  tersection(ms)).
-00021f30: 0a20 2020 206d 6b72 735f 616c 6c20 3d20  .    mkrs_all = 
-00021f40: 6c69 7374 2873 6574 286d 6b72 735f 616c  list(set(mkrs_al
-00021f50: 6c29 290a 2020 2020 6966 2067 656e 6573  l)).    if genes
-00021f60: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00021f70: 2020 2020 2020 6d6b 7273 5f61 6c6c 203d        mkrs_all =
-00021f80: 206c 6973 7428 7365 7428 6d6b 7273 5f61   list(set(mkrs_a
-00021f90: 6c6c 292e 696e 7465 7273 6563 7469 6f6e  ll).intersection
-00021fa0: 2867 656e 6573 2929 0a20 2020 200a 2020  (genes)).    .  
-00021fb0: 2020 7265 7475 726e 206d 6b72 735f 616c    return mkrs_al
-00021fc0: 6c2c 206d 6b72 5f64 6963 740a 0a0a 6465  l, mkr_dict...de
-00021fd0: 6620 7570 6461 7465 5f6d 6172 6b65 7273  f update_markers
-00021fe0: 5f64 6963 7428 6d6b 7273 5f61 6c6c 2c20  _dict(mkrs_all, 
-00021ff0: 6d6b 725f 6469 6374 2c20 582c 2079 2c20  mkr_dict, X, y, 
-00022000: 7265 6e64 203d 204e 6f6e 652c 2063 7574  rend = None, cut
-00022010: 6f66 6620 3d20 302e 332c 200a 2020 2020  off = 0.3, .    
-00022020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022030: 2020 2020 4e61 6c6c 203d 2032 302c 204e      Nall = 20, N
-00022040: 7074 203d 2032 3029 3a0a 2020 2020 0a20  pt = 20):.    . 
-00022050: 2020 2069 6620 7265 6e64 2069 7320 4e6f     if rend is No
-00022060: 6e65 3a0a 2020 2020 2020 2020 6c73 7420  ne:.        lst 
-00022070: 3d20 6c69 7374 286d 6b72 5f64 6963 742e  = list(mkr_dict.
-00022080: 6b65 7973 2829 290a 2020 2020 2020 2020  keys()).        
-00022090: 6c73 742e 736f 7274 2829 0a20 2020 2020  lst.sort().     
-000220a0: 2020 2072 656e 6420 3d20 6469 6374 287a     rend = dict(z
-000220b0: 6970 286c 7374 2c20 6c73 7429 290a 2020  ip(lst, lst)).  
-000220c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000220d0: 6c73 7420 3d20 6c69 7374 2872 656e 642e  lst = list(rend.
-000220e0: 6b65 7973 2829 290a 2020 2020 2020 2020  keys()).        
-000220f0: 0a20 2020 2064 6620 3d20 7064 2e44 6174  .    df = pd.Dat
-00022100: 6146 7261 6d65 2869 6e64 6578 203d 206c  aFrame(index = l
-00022110: 7374 2c20 636f 6c75 6d6e 7320 3d20 6d6b  st, columns = mk
-00022120: 7273 5f61 6c6c 290a 2020 2020 6466 2e6c  rs_all).    df.l
-00022130: 6f63 5b3a 2c3a 5d20 3d20 300a 2020 2020  oc[:,:] = 0.    
-00022140: 2020 2020 0a20 2020 2066 6f72 2063 7420      .    for ct 
-00022150: 696e 206c 7374 3a0a 2020 2020 2020 2020  in lst:.        
-00022160: 6220 3d20 7920 3d3d 2063 740a 2020 2020  b = y == ct.    
-00022170: 2020 2020 6d73 203d 206c 6973 7428 7365      ms = list(se
-00022180: 7428 6d6b 725f 6469 6374 5b63 745d 292e  t(mkr_dict[ct]).
-00022190: 696e 7465 7273 6563 7469 6f6e 286d 6b72  intersection(mkr
-000221a0: 735f 616c 6c29 290a 2020 2020 2020 2020  s_all)).        
-000221b0: 7065 203d 206c 6973 7428 2858 2e6c 6f63  pe = list((X.loc
-000221c0: 5b62 2c6d 735d 203e 2030 292e 6d65 616e  [b,ms] > 0).mean
-000221d0: 2861 7869 7320 3d20 3029 290a 2020 2020  (axis = 0)).    
-000221e0: 2020 2020 666f 7220 6a2c 206d 2069 6e20      for j, m in 
-000221f0: 656e 756d 6572 6174 6528 6d73 293a 0a20  enumerate(ms):. 
-00022200: 2020 2020 2020 2020 2020 2064 662e 6c6f             df.lo
-00022210: 635b 6374 2c20 6d5d 203d 2070 655b 6a5d  c[ct, m] = pe[j]
-00022220: 0a0a 2020 2020 6966 2064 662e 7368 6170  ..    if df.shap
-00022230: 655b 305d 203d 3d20 313a 0a20 2020 2020  e[0] == 1:.     
-00022240: 2020 206d 6b72 735f 616c 6c20 3d20 6c69     mkrs_all = li
-00022250: 7374 2864 662e 636f 6c75 6d6e 732e 7661  st(df.columns.va
-00022260: 6c75 6573 290a 2020 2020 2020 2020 6d6b  lues).        mk
-00022270: 7273 5f64 6963 7420 3d20 7b7d 0a20 2020  rs_dict = {}.   
-00022280: 2020 2020 200a 2020 2020 2020 2020 7065       .        pe
-00022290: 5f6c 7374 203d 205b 5d0a 2020 2020 2020  _lst = [].      
-000222a0: 2020 7065 785f 6c73 7420 3d20 5b5d 0a20    pex_lst = []. 
-000222b0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-000222c0: 666f 7220 6374 2069 6e20 6c73 743a 0a20  for ct in lst:. 
-000222d0: 2020 2020 2020 2020 2020 2062 203d 2079             b = y
-000222e0: 203d 3d20 6374 0a20 2020 2020 2020 2020   == ct.         
-000222f0: 2020 206d 7320 3d20 6c69 7374 2873 6574     ms = list(set
-00022300: 286d 6b72 5f64 6963 745b 6374 5d29 2e69  (mkr_dict[ct]).i
-00022310: 6e74 6572 7365 6374 696f 6e28 6d6b 7273  ntersection(mkrs
-00022320: 5f61 6c6c 2929 0a20 2020 2020 2020 2020  _all)).         
-00022330: 2020 2070 6520 3d20 6e70 2e61 7272 6179     pe = np.array
-00022340: 2828 582e 6c6f 635b 622c 6d73 5d20 3e20  ((X.loc[b,ms] > 
-00022350: 3029 2e6d 6561 6e28 6178 6973 203d 2030  0).mean(axis = 0
-00022360: 2929 0a20 2020 2020 2020 2020 2020 2070  )).            p
-00022370: 6578 203d 206e 702e 6172 7261 7928 2858  ex = np.array((X
-00022380: 2e6c 6f63 5b7e 622c 6d73 5d20 3e20 3029  .loc[~b,ms] > 0)
-00022390: 2e6d 6561 6e28 6178 6973 203d 2030 2929  .mean(axis = 0))
-000223a0: 0a20 2020 2020 2020 2020 2020 206f 6472  .            odr
-000223b0: 203d 206e 702e 6172 7261 7928 2d70 6529   = np.array(-pe)
-000223c0: 2e61 7267 736f 7274 2829 0a20 2020 2020  .argsort().     
-000223d0: 2020 2020 2020 206d 735f 6e65 7720 3d20         ms_new = 
-000223e0: 5b5d 0a20 2020 2020 2020 2020 2020 2066  [].            f
-000223f0: 6f72 206f 2069 6e20 6f64 723a 0a20 2020  or o in odr:.   
-00022400: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00022410: 2870 655b 6f5d 203e 3d20 6375 746f 6666  (pe[o] >= cutoff
-00022420: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00022430: 2020 2020 2020 206d 735f 6e65 772e 6170         ms_new.ap
-00022440: 7065 6e64 286d 735b 6f5d 290a 0a20 2020  pend(ms[o])..   
-00022450: 2020 2020 2020 2020 2070 6520 3d20 7065           pe = pe
-00022460: 5b7e 6e70 2e69 736e 616e 2870 6529 5d0a  [~np.isnan(pe)].
-00022470: 2020 2020 2020 2020 2020 2020 7065 7820              pex 
-00022480: 3d20 7065 785b 7e6e 702e 6973 6e61 6e28  = pex[~np.isnan(
-00022490: 7065 7829 5d0a 2020 2020 2020 2020 2020  pex)].          
-000224a0: 2020 7065 5f6c 7374 203d 2070 655f 6c73    pe_lst = pe_ls
-000224b0: 7420 2b20 6c69 7374 2870 6529 0a20 2020  t + list(pe).   
-000224c0: 2020 2020 2020 2020 2070 6578 5f6c 7374           pex_lst
-000224d0: 203d 2070 6578 5f6c 7374 202b 206c 6973   = pex_lst + lis
-000224e0: 7428 7065 7829 0a20 2020 2020 2020 2020  t(pex).         
-000224f0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-00022500: 6966 206c 656e 286d 735f 6e65 7729 203e  if len(ms_new) >
-00022510: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00022520: 2020 2020 6d6b 7273 5f64 6963 745b 7265      mkrs_dict[re
-00022530: 6e64 5b63 745d 5d20 3d20 6d73 5f6e 6577  nd[ct]] = ms_new
-00022540: 5b3a 6d69 6e28 4e70 742c 6c65 6e28 6d73  [:min(Npt,len(ms
-00022550: 5f6e 6577 2929 5d0a 2020 2020 2020 2020  _new))].        
-00022560: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00022570: 2020 2020 2020 2020 2020 6d6b 7273 5f64            mkrs_d
-00022580: 6963 745b 7265 6e64 5b63 745d 5d20 3d20  ict[rend[ct]] = 
-00022590: 6d73 5b3a 6d69 6e28 4e70 742c 6c65 6e28  ms[:min(Npt,len(
-000225a0: 6d73 2929 5d0a 2020 2020 656c 7365 3a0a  ms))].    else:.
-000225b0: 2020 2020 2020 2020 7031 203d 2064 662e          p1 = df.
-000225c0: 6d61 7828 6178 6973 203d 2030 290a 2020  max(axis = 0).  
-000225d0: 2020 2020 2020 7032 203d 2070 312e 636f        p2 = p1.co
-000225e0: 7079 2864 6565 7020 3d20 5472 7565 290a  py(deep = True).
-000225f0: 2020 2020 2020 2020 7032 5b3a 5d20 3d20          p2[:] = 
-00022600: 300a 2020 2020 2020 2020 6964 7820 3d20  0.        idx = 
-00022610: 6466 2e69 6e64 6578 2e76 616c 7565 730a  df.index.values.
-00022620: 2020 2020 2020 2020 666f 7220 6d20 696e          for m in
-00022630: 206c 6973 7428 6466 2e63 6f6c 756d 6e73   list(df.columns
-00022640: 2e76 616c 7565 7329 3a0a 2020 2020 2020  .values):.      
-00022650: 2020 2020 2020 6f64 7220 3d20 6e70 2e61        odr = np.a
-00022660: 7272 6179 282d 6466 5b6d 5d29 2e61 7267  rray(-df[m]).arg
-00022670: 736f 7274 2829 0a20 2020 2020 2020 2020  sort().         
-00022680: 2020 2070 325b 6d5d 203d 2064 662e 6c6f     p2[m] = df.lo
-00022690: 635b 6964 785b 6f64 725b 315d 5d2c 206d  c[idx[odr[1]], m
-000226a0: 5d0a 2020 2020 2020 2020 6e6e 203d 2028  ].        nn = (
-000226b0: 6466 203e 3d20 302e 3529 2e73 756d 2861  df >= 0.5).sum(a
-000226c0: 7869 7320 3d20 3029 0a0a 2020 2020 2020  xis = 0)..      
-000226d0: 2020 6230 203d 2070 3120 3e20 300a 2020    b0 = p1 > 0.  
-000226e0: 2020 2020 2020 6231 203d 2028 7032 2f28        b1 = (p2/(
-000226f0: 7031 202b 2030 2e30 3030 3129 2920 3c20  p1 + 0.0001)) < 
-00022700: 302e 350a 2020 2020 2020 2020 6232 203d  0.5.        b2 =
-00022710: 206e 6e20 3c20 340a 2020 2020 2020 2020   nn < 4.        
-00022720: 6220 3d20 6230 2023 2026 2062 3120 2620  b = b0 # & b1 & 
-00022730: 6232 0a20 2020 2020 2020 2064 6620 3d20  b2.        df = 
-00022740: 6466 2e6c 6f63 5b3a 2c62 5d0a 2020 2020  df.loc[:,b].    
-00022750: 2020 2020 6d6b 7273 5f61 6c6c 203d 206c      mkrs_all = l
-00022760: 6973 7428 6466 2e63 6f6c 756d 6e73 2e76  ist(df.columns.v
-00022770: 616c 7565 7329 0a0a 2020 2020 2020 2020  alues)..        
-00022780: 6d6b 7273 203d 205b 5d20 0a20 2020 2020  mkrs = [] .     
-00022790: 2020 2063 7473 203d 205b 5d20 0a20 2020     cts = [] .   
-000227a0: 2020 2020 2070 6573 203d 205b 5d20 0a20       pes = [] . 
-000227b0: 2020 2020 2020 206d 6b72 735f 6469 6374         mkrs_dict
-000227c0: 203d 207b 7d0a 2020 2020 2020 2020 7065   = {}.        pe
-000227d0: 5f6c 7374 203d 205b 5d0a 2020 2020 2020  _lst = [].      
-000227e0: 2020 7065 785f 6c73 7420 3d20 5b5d 0a20    pex_lst = []. 
-000227f0: 2020 2020 2020 2066 6f72 2063 7420 696e         for ct in
-00022800: 206c 7374 3a0a 2020 2020 2020 2020 2020   lst:.          
-00022810: 2020 6220 3d20 7920 3d3d 2063 740a 2020    b = y == ct.  
-00022820: 2020 2020 2020 2020 2020 6d73 203d 206c            ms = l
-00022830: 6973 7428 7365 7428 6d6b 725f 6469 6374  ist(set(mkr_dict
-00022840: 5b63 745d 292e 696e 7465 7273 6563 7469  [ct]).intersecti
-00022850: 6f6e 286d 6b72 735f 616c 6c29 290a 2020  on(mkrs_all)).  
-00022860: 2020 2020 2020 2020 2020 7032 7420 3d20            p2t = 
-00022870: 6e70 2e61 7272 6179 2870 325b 6d73 5d29  np.array(p2[ms])
-00022880: 0a20 2020 2020 2020 2020 2020 2070 3174  .            p1t
-00022890: 203d 206e 702e 6172 7261 7928 7031 5b6d   = np.array(p1[m
-000228a0: 735d 290a 2020 2020 2020 2020 2020 2020  s]).            
-000228b0: 7065 203d 206e 702e 6172 7261 7928 2858  pe = np.array((X
-000228c0: 2e6c 6f63 5b62 2c6d 735d 203e 2030 292e  .loc[b,ms] > 0).
-000228d0: 6d65 616e 2861 7869 7320 3d20 3029 290a  mean(axis = 0)).
-000228e0: 2020 2020 2020 2020 2020 2020 7065 7820              pex 
-000228f0: 3d20 6e70 2e61 7272 6179 2828 582e 6c6f  = np.array((X.lo
-00022900: 635b 7e62 2c6d 735d 203e 2030 292e 6d65  c[~b,ms] > 0).me
-00022910: 616e 2861 7869 7320 3d20 3029 290a 2020  an(axis = 0)).  
-00022920: 2020 2020 2020 2020 2020 6f64 7220 3d20            odr = 
-00022930: 6e70 2e61 7272 6179 282d 7065 292e 6172  np.array(-pe).ar
-00022940: 6773 6f72 7428 290a 2020 2020 2020 2020  gsort().        
-00022950: 2020 2020 6d73 5f6e 6577 203d 205b 5d0a      ms_new = [].
-00022960: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00022970: 6f20 696e 206f 6472 3a0a 2020 2020 2020  o in odr:.      
-00022980: 2020 2020 2020 2020 2020 6966 2028 7065            if (pe
-00022990: 5b6f 5d20 3e3d 2063 7574 6f66 6629 2026  [o] >= cutoff) &
-000229a0: 2028 7e6e 702e 6973 6e61 6e28 7065 5b6f   (~np.isnan(pe[o
-000229b0: 5d29 293a 0a20 2020 2020 2020 2020 2020  ])):.           
-000229c0: 2020 2020 2020 2020 206d 735f 6e65 772e           ms_new.
-000229d0: 6170 7065 6e64 286d 735b 6f5d 290a 0a20  append(ms[o]).. 
-000229e0: 2020 2020 2020 2020 2020 2070 6520 3d20             pe = 
-000229f0: 7065 5b7e 6e70 2e69 736e 616e 2870 6529  pe[~np.isnan(pe)
-00022a00: 5d0a 2020 2020 2020 2020 2020 2020 7065  ].            pe
-00022a10: 7820 3d20 7065 785b 7e6e 702e 6973 6e61  x = pex[~np.isna
-00022a20: 6e28 7065 7829 5d0a 2020 2020 2020 2020  n(pex)].        
-00022a30: 2020 2020 7065 5f6c 7374 203d 2070 655f      pe_lst = pe_
-00022a40: 6c73 7420 2b20 6c69 7374 2870 6529 0a20  lst + list(pe). 
-00022a50: 2020 2020 2020 2020 2020 2070 6578 5f6c             pex_l
-00022a60: 7374 203d 2070 6578 5f6c 7374 202b 206c  st = pex_lst + l
-00022a70: 6973 7428 7065 7829 0a0a 2020 2020 2020  ist(pex)..      
-00022a80: 2020 2020 2020 6966 206c 656e 286d 735f        if len(ms_
-00022a90: 6e65 7729 203e 2030 3a0a 2020 2020 2020  new) > 0:.      
-00022aa0: 2020 2020 2020 2020 2020 6d6b 7273 5f64            mkrs_d
-00022ab0: 6963 745b 7265 6e64 5b63 745d 5d20 3d20  ict[rend[ct]] = 
-00022ac0: 6d73 5f6e 6577 5b3a 6d69 6e28 4e70 742c  ms_new[:min(Npt,
-00022ad0: 6c65 6e28 6d73 5f6e 6577 2929 5d0a 2020  len(ms_new))].  
-00022ae0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00022af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022b00: 6d6b 7273 5f64 6963 745b 7265 6e64 5b63  mkrs_dict[rend[c
-00022b10: 745d 5d20 3d20 6d73 5b3a 6d69 6e28 4e70  t]] = ms[:min(Np
-00022b20: 742c 6c65 6e28 6d73 2929 5d0a 2020 2020  t,len(ms))].    
-00022b30: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-00022b40: 2072 6574 7572 6e20 6d6b 7273 5f64 6963   return mkrs_dic
-00022b50: 742c 2064 662c 2070 655f 6c73 742c 2070  t, df, pe_lst, p
-00022b60: 6578 5f6c 7374 0a0a 0a0a 6465 6620 7265  ex_lst....def re
-00022b70: 6d6f 7665 5f6d 6163 5f63 6f6d 6d6f 6e5f  move_mac_common_
-00022b80: 6d61 726b 6572 7328 6d6b 7273 5f64 6963  markers(mkrs_dic
-00022b90: 7429 3a20 2020 0a0a 2020 2020 6c73 7432  t):   ..    lst2
-00022ba0: 203d 206c 6973 7428 6d6b 7273 5f64 6963   = list(mkrs_dic
-00022bb0: 742e 6b65 7973 2829 290a 2020 2020 6c73  t.keys()).    ls
-00022bc0: 7420 3d20 5b5d 0a20 2020 204d 6f6e 6f20  t = [].    Mono 
-00022bd0: 3d20 4e6f 6e65 0a20 2020 2066 6f72 2069  = None.    for i
-00022be0: 7465 6d20 696e 206c 7374 323a 0a20 2020  tem in lst2:.   
-00022bf0: 2020 2020 2069 6620 6974 656d 5b3a 335d       if item[:3]
-00022c00: 203d 3d20 274d 6163 273a 0a20 2020 2020   == 'Mac':.     
-00022c10: 2020 2020 2020 206c 7374 2e61 7070 656e         lst.appen
-00022c20: 6428 6974 656d 290a 2020 2020 2020 2020  d(item).        
-00022c30: 6966 2069 7465 6d5b 3a34 5d20 3d3d 2027  if item[:4] == '
-00022c40: 4d6f 6e6f 273a 0a20 2020 2020 2020 2020  Mono':.         
-00022c50: 2020 204d 6f6e 6f20 3d20 6974 656d 0a20     Mono = item. 
-00022c60: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-00022c70: 6966 206c 656e 286c 7374 2920 3e20 313a  if len(lst) > 1:
-00022c80: 0a20 2020 2020 2020 206d 6163 5f63 6f6d  .        mac_com
-00022c90: 6d6f 6e20 3d20 6d6b 7273 5f64 6963 745b  mon = mkrs_dict[
-00022ca0: 6c73 745b 305d 5d0a 2020 2020 2020 2020  lst[0]].        
-00022cb0: 666f 7220 6974 656d 2069 6e20 6c73 745b  for item in lst[
-00022cc0: 313a 5d3a 0a20 2020 2020 2020 2020 2020  1:]:.           
-00022cd0: 206d 6163 5f63 6f6d 6d6f 6e20 3d20 6c69   mac_common = li
-00022ce0: 7374 2873 6574 286d 6163 5f63 6f6d 6d6f  st(set(mac_commo
-00022cf0: 6e29 2e69 6e74 6572 7365 6374 696f 6e28  n).intersection(
-00022d00: 6d6b 7273 5f64 6963 745b 6974 656d 5d29  mkrs_dict[item])
-00022d10: 290a 2020 2020 2020 2020 2020 2020 0a20  ).            . 
-00022d20: 2020 2020 2020 2066 6f72 2069 7465 6d20         for item 
-00022d30: 696e 206c 7374 3a0a 2020 2020 2020 2020  in lst:.        
-00022d40: 2020 2020 666f 7220 6d6b 7220 696e 206d      for mkr in m
-00022d50: 6163 5f63 6f6d 6d6f 6e3a 0a20 2020 2020  ac_common:.     
-00022d60: 2020 2020 2020 2020 2020 206d 6b72 735f             mkrs_
-00022d70: 6469 6374 5b69 7465 6d5d 2e72 656d 6f76  dict[item].remov
-00022d80: 6528 6d6b 7229 0a20 2020 2020 2020 2069  e(mkr).        i
-00022d90: 6620 4d6f 6e6f 2069 7320 6e6f 7420 4e6f  f Mono is not No
-00022da0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00022db0: 6d6f 6e6f 5f6c 7374 203d 206d 6b72 735f  mono_lst = mkrs_
-00022dc0: 6469 6374 5b4d 6f6e 6f5d 0a20 2020 2020  dict[Mono].     
-00022dd0: 2020 2020 2020 2064 656c 206d 6b72 735f         del mkrs_
-00022de0: 6469 6374 5b4d 6f6e 6f5d 0a20 2020 2020  dict[Mono].     
-00022df0: 2020 2020 2020 206d 6b72 735f 6469 6374         mkrs_dict
-00022e00: 5b4d 6f6e 6f5d 203d 206d 6f6e 6f5f 6c73  [Mono] = mono_ls
-00022e10: 740a 2020 2020 2020 2020 2020 2020 0a20  t.            . 
-00022e20: 2020 2072 6574 7572 6e20 6d6b 7273 5f64     return mkrs_d
-00022e30: 6963 740a 0a20 2020 200a 6465 6620 706c  ict..    .def pl
-00022e40: 6f74 5f64 6f74 5f73 2861 6461 7461 2c20  ot_dot_s(adata, 
-00022e50: 7461 7267 6574 5f6c 7374 2c20 7479 7065  target_lst, type
-00022e60: 5f6c 6576 656c 2c20 6d6b 725f 6669 6c65  _level, mkr_file
-00022e70: 2c20 7469 746c 6520 3d20 4e6f 6e65 2c20  , title = None, 
-00022e80: 7265 6e64 203d 204e 6f6e 652c 206c 6576  rend = None, lev
-00022e90: 656c 203d 2031 2c20 0a20 2020 2020 2020  el = 1, .       
-00022ea0: 2020 2020 2020 2063 7574 6f66 6620 3d20         cutoff = 
-00022eb0: 302c 2070 6e73 6831 3220 3d20 2731 3031  0, pnsh12 = '101
-00022ec0: 3030 3027 2c20 7265 6d5f 636d 6e20 3d20  000', rem_cmn = 
-00022ed0: 4661 6c73 652c 2064 6f74 5f6d 6178 203d  False, dot_max =
-00022ee0: 2030 2e35 2c20 7377 6170 5f61 7820 3d20   0.5, swap_ax = 
-00022ef0: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
-00022f00: 2020 2020 2074 6f5f 6578 636c 7564 6520       to_exclude 
-00022f10: 3d20 5b5d 2c20 4e70 7420 3d20 3135 2c20  = [], Npt = 15, 
-00022f20: 636f 6d62 5f6d 6b72 7320 3d20 4661 6c73  comb_mkrs = Fals
-00022f30: 652c 206d 696e 4e63 656c 6c73 203d 2032  e, minNcells = 2
-00022f40: 302c 2076 675f 726f 7420 3d20 3130 2c0a  0, vg_rot = 10,.
-00022f50: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-00022f60: 6773 697a 6520 3d20 2832 302c 2034 292c  gsize = (20, 4),
-00022f70: 2061 7820 3d20 4e6f 6e65 2c20 7265 745f   ax = None, ret_
-00022f80: 7065 203d 2046 616c 7365 2029 3a0a 0a20  pe = False ):.. 
-00022f90: 2020 2053 4341 4e50 5920 3d20 5472 7565     SCANPY = True
-00022fa0: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
-00022fb0: 2020 696d 706f 7274 2073 6361 6e70 7920    import scanpy 
-00022fc0: 6173 2073 630a 2020 2020 6578 6365 7074  as sc.    except
-00022fd0: 2049 6d70 6f72 7445 7272 6f72 3a0a 2020   ImportError:.  
-00022fe0: 2020 2020 2020 5343 414e 5059 203d 2046        SCANPY = F
-00022ff0: 616c 7365 0a20 2020 200a 2020 2020 6966  alse.    .    if
-00023000: 2028 6e6f 7420 5343 414e 5059 293a 0a20   (not SCANPY):. 
-00023010: 2020 2020 2020 2070 7269 6e74 2827 4552         print('ER
-00023020: 524f 523a 2073 6361 6e70 7920 6e6f 7420  ROR: scanpy not 
-00023030: 696e 7374 616c 6c65 642e 2027 2920 2020  installed. ')   
-00023040: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
-00023050: 2020 2020 0a20 2020 2074 6172 6765 7420      .    target 
-00023060: 3d20 272c 272e 6a6f 696e 2874 6172 6765  = ','.join(targe
-00023070: 745f 6c73 7429 0a20 2020 2067 656e 6573  t_lst).    genes
-00023080: 203d 206c 6973 7428 6164 6174 612e 7661   = list(adata.va
-00023090: 722e 696e 6465 782e 7661 6c75 6573 290a  r.index.values).
-000230a0: 2020 2020 6765 6e65 7320 3d20 6c69 7374      genes = list
-000230b0: 2873 6574 2867 656e 6573 2920 2d20 7365  (set(genes) - se
-000230c0: 7428 746f 5f65 7863 6c75 6465 2929 0a20  t(to_exclude)). 
-000230d0: 2020 206d 6b72 735f 616c 6c2c 206d 6b72     mkrs_all, mkr
-000230e0: 5f64 6963 7420 3d20 6765 745f 6d61 726b  _dict = get_mark
-000230f0: 6572 735f 616c 6c33 286d 6b72 5f66 696c  ers_all3(mkr_fil
-00023100: 652c 2074 6172 6765 745f 6c73 742c 200a  e, target_lst, .
-00023110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023130: 2020 2020 2020 2020 2070 6e73 6831 322c           pnsh12,
-00023140: 2067 656e 6573 2c20 6c65 7665 6c2c 200a   genes, level, .
-00023150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023170: 2020 2020 2020 2020 2072 656d 5f63 6d6e           rem_cmn
-00023180: 203d 2072 656d 5f63 6d6e 2c20 0a20 2020   = rem_cmn, .   
-00023190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000231a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000231b0: 2020 2020 2020 636f 6d62 5f6d 6b72 7320        comb_mkrs 
-000231c0: 3d20 636f 6d62 5f6d 6b72 7320 290a 2020  = comb_mkrs ).  
-000231d0: 2020 7461 7267 6574 5f6c 7374 3220 3d20    target_lst2 = 
-000231e0: 6c69 7374 286d 6b72 5f64 6963 742e 6b65  list(mkr_dict.ke
-000231f0: 7973 2829 290a 2020 2020 7920 3d20 6164  ys()).    y = ad
-00023200: 6174 612e 6f62 735b 7479 7065 5f6c 6576  ata.obs[type_lev
-00023210: 656c 5d0a 2020 2020 6220 3d20 7920 3d3d  el].    b = y ==
-00023220: 2074 6172 6765 745f 6c73 7432 5b30 5d0a   target_lst2[0].
-00023230: 2020 2020 666f 7220 7420 696e 2074 6172      for t in tar
-00023240: 6765 745f 6c73 7432 3a0a 2020 2020 2020  get_lst2:.      
-00023250: 2020 6220 3d20 6220 7c20 2879 203d 3d20    b = b | (y == 
-00023260: 7429 0a20 2020 2020 2020 200a 2020 2020  t).        .    
-00023270: 6e68 203d 2030 0a20 2020 2069 6620 6e70  nh = 0.    if np
-00023280: 2e73 756d 2862 2920 3e20 303a 206e 6820  .sum(b) > 0: nh 
-00023290: 3d20 310a 2020 2020 666f 7220 7420 696e  = 1.    for t in
-000232a0: 2074 6172 6765 745f 6c73 7432 3a0a 2020   target_lst2:.  
-000232b0: 2020 2020 2020 6274 203d 2079 203d 3d20        bt = y == 
-000232c0: 740a 2020 2020 2020 2020 6966 206e 702e  t.        if np.
-000232d0: 7375 6d28 6274 2920 3e20 303a 0a20 2020  sum(bt) > 0:.   
-000232e0: 2020 2020 2020 2020 2062 203d 2062 207c           b = b |
-000232f0: 2028 7920 3d3d 2074 290a 2020 2020 2020   (y == t).      
-00023300: 2020 2020 2020 6e68 202b 3d20 310a 0a20        nh += 1.. 
-00023310: 2020 2061 6461 7461 5f74 203d 2061 6461     adata_t = ada
-00023320: 7461 5b62 2c6d 6b72 735f 616c 6c5d 0a20  ta[b,mkrs_all]. 
-00023330: 2020 2058 203d 2061 6461 7461 5f74 2e74     X = adata_t.t
-00023340: 6f5f 6466 2829 0a20 2020 2079 203d 2061  o_df().    y = a
-00023350: 6461 7461 5f74 2e6f 6273 5b74 7970 655f  data_t.obs[type_
-00023360: 6c65 7665 6c5d 0a0a 2020 2020 6d6b 7273  level]..    mkrs
-00023370: 5f64 6963 742c 2064 662c 2070 655f 6c73  _dict, df, pe_ls
-00023380: 742c 2070 6578 5f6c 7374 203d 2075 7064  t, pex_lst = upd
-00023390: 6174 655f 6d61 726b 6572 735f 6469 6374  ate_markers_dict
-000233a0: 286d 6b72 735f 616c 6c2c 206d 6b72 5f64  (mkrs_all, mkr_d
-000233b0: 6963 742c 2058 2c20 792c 2072 656e 642c  ict, X, y, rend,
-000233c0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-000233d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000233e0: 2020 2020 2020 2020 2020 6375 746f 6666            cutoff
-000233f0: 203d 2063 7574 6f66 662c 204e 7074 203d   = cutoff, Npt =
-00023400: 204e 7074 290a 0a20 2020 206d 6b72 735f   Npt)..    mkrs_
-00023410: 6469 6374 203d 2072 656d 6f76 655f 6d61  dict = remove_ma
-00023420: 635f 636f 6d6d 6f6e 5f6d 6172 6b65 7273  c_common_markers
-00023430: 286d 6b72 735f 6469 6374 290a 2020 2020  (mkrs_dict).    
-00023440: 6966 2072 656e 6420 6973 206e 6f74 204e  if rend is not N
-00023450: 6f6e 653a 200a 2020 2020 2020 2020 6164  one: .        ad
-00023460: 6174 615f 742e 6f62 735b 7479 7065 5f6c  ata_t.obs[type_l
-00023470: 6576 656c 5d2e 7265 706c 6163 6528 7265  evel].replace(re
-00023480: 6e64 2c20 696e 706c 6163 6520 3d20 5472  nd, inplace = Tr
-00023490: 7565 290a 0a20 2020 206e 7720 3d20 300a  ue)..    nw = 0.
-000234a0: 2020 2020 666f 7220 6b65 7920 696e 206d      for key in m
-000234b0: 6b72 735f 6469 6374 2e6b 6579 7328 293a  krs_dict.keys():
-000234c0: 0a20 2020 2020 2020 206e 7720 2b3d 206c  .        nw += l
-000234d0: 656e 286d 6b72 735f 6469 6374 5b6b 6579  en(mkrs_dict[key
-000234e0: 5d29 0a20 2020 2020 2020 200a 2020 2020  ]).        .    
-000234f0: 706c 742e 7263 2827 666f 6e74 272c 2073  plt.rc('font', s
-00023500: 697a 653d 3132 2920 2020 2020 2020 2020  ize=12)         
-00023510: 200a 0a20 2020 2077 6974 6820 7761 726e   ..    with warn
-00023520: 696e 6773 2e63 6174 6368 5f77 6172 6e69  ings.catch_warni
-00023530: 6e67 7328 293a 0a20 2020 2020 2020 2077  ngs():.        w
-00023540: 6172 6e69 6e67 732e 7369 6d70 6c65 6669  arnings.simplefi
-00023550: 6c74 6572 2822 6967 6e6f 7265 2229 0a20  lter("ignore"). 
-00023560: 2020 2020 2020 2064 7020 3d20 7363 2e70         dp = sc.p
-00023570: 6c2e 646f 7470 6c6f 7428 6164 6174 615f  l.dotplot(adata_
-00023580: 742c 206d 6b72 735f 6469 6374 2c20 6772  t, mkrs_dict, gr
-00023590: 6f75 7062 7920 3d20 7479 7065 5f6c 6576  oupby = type_lev
-000235a0: 656c 2c20 0a20 2020 2020 2020 2020 2020  el, .           
-000235b0: 2020 2020 2020 2020 2020 2020 6361 7465              cate
-000235c0: 676f 7269 6573 5f6f 7264 6572 203d 206c  gories_order = l
-000235d0: 6973 7428 6d6b 7273 5f64 6963 742e 6b65  ist(mkrs_dict.ke
-000235e0: 7973 2829 292c 200a 2020 2020 2020 2020  ys()), .        
-000235f0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00023600: 2061 7820 3d20 6178 2c20 6669 6773 697a   ax = ax, figsiz
-00023610: 6520 3d20 286e 772a 302e 3336 2c20 6e68  e = (nw*0.36, nh
-00023620: 2a30 2e33 292c 0a20 2020 2020 2020 2020  *0.3),.         
-00023630: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00023640: 6720 3d20 5472 7565 2c20 7661 725f 6772  g = True, var_gr
-00023650: 6f75 705f 726f 7461 7469 6f6e 203d 2076  oup_rotation = v
-00023660: 675f 726f 742c 2073 686f 7720 3d20 4661  g_rot, show = Fa
-00023670: 6c73 652c 200a 2020 2020 2020 2020 2020  lse, .          
-00023680: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-00023690: 6e64 6172 645f 7363 616c 6520 3d20 2776  ndard_scale = 'v
-000236a0: 6172 272c 2064 6f74 5f6d 6178 203d 2064  ar', dot_max = d
-000236b0: 6f74 5f6d 6178 2c20 7377 6170 5f61 7865  ot_max, swap_axe
-000236c0: 7320 3d20 7377 6170 5f61 7820 2920 0a20  s = swap_ax ) . 
-000236d0: 2020 200a 2020 2020 6178 203d 2064 705b     .    ax = dp[
-000236e0: 276d 6169 6e70 6c6f 745f 6178 275d 0a20  'mainplot_ax']. 
-000236f0: 2020 2069 6620 7469 746c 6520 6973 206e     if title is n
-00023700: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00023710: 2061 782e 7365 745f 7469 746c 6528 7469   ax.set_title(ti
-00023720: 746c 652c 2070 6164 203d 2034 302c 2066  tle, pad = 40, f
-00023730: 6f6e 7473 697a 6520 3d20 3136 2920 0a20  ontsize = 16) . 
-00023740: 2020 2061 782e 7469 636b 5f70 6172 616d     ax.tick_param
-00023750: 7328 6c61 6265 6c73 697a 653d 3132 290a  s(labelsize=12).
-00023760: 2020 2020 6178 2e73 6574 5f79 6c61 6265      ax.set_ylabe
-00023770: 6c28 2741 6e6e 6f74 6174 6564 272c 2066  l('Annotated', f
-00023780: 6f6e 7473 697a 6520 3d20 3134 290a 2020  ontsize = 14).  
-00023790: 2020 0a20 2020 2069 6620 7265 745f 7065    .    if ret_pe
-000237a0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-000237b0: 2070 655f 6c73 742c 2070 6578 5f6c 7374   pe_lst, pex_lst
-000237c0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-000237d0: 2020 2072 6574 7572 6e0a 0a20 2020 200a     return..    .
-000237e0: 6465 6620 706c 6f74 5f64 6f74 2820 6164  def plot_dot( ad
-000237f0: 6174 612c 2074 6172 6765 745f 6c73 742c  ata, target_lst,
-00023800: 2074 7970 655f 6c65 7665 6c2c 206d 6b72   type_level, mkr
-00023810: 5f66 696c 652c 2074 6974 6c65 203d 204e  _file, title = N
-00023820: 6f6e 652c 2072 656e 6420 3d20 4e6f 6e65  one, rend = None
-00023830: 2c20 6c65 7665 6c20 3d20 312c 200a 2020  , level = 1, .  
-00023840: 2020 2020 2020 2020 2020 2020 6375 746f              cuto
-00023850: 6666 203d 2030 2c20 706e 7368 3132 203d  ff = 0, pnsh12 =
-00023860: 2027 3130 3130 3030 272c 2072 656d 5f63   '101000', rem_c
-00023870: 6d6e 203d 2046 616c 7365 2c20 646f 745f  mn = False, dot_
-00023880: 6d61 7820 3d20 302e 352c 2073 7761 705f  max = 0.5, swap_
-00023890: 6178 203d 2046 616c 7365 2c0a 2020 2020  ax = False,.    
-000238a0: 2020 2020 2020 2020 2020 746f 5f65 7863            to_exc
-000238b0: 6c75 6465 203d 205b 5d2c 204e 7074 203d  lude = [], Npt =
-000238c0: 2031 352c 2063 6f6d 625f 6d6b 7273 203d   15, comb_mkrs =
-000238d0: 2046 616c 7365 2c20 6d69 6e4e 6365 6c6c   False, minNcell
-000238e0: 7320 3d20 3230 2c20 7667 5f72 6f74 203d  s = 20, vg_rot =
-000238f0: 2031 302c 0a20 2020 2020 2020 2020 2020   10,.           
-00023900: 2020 2066 6967 7369 7a65 203d 2028 3230     figsize = (20
-00023910: 2c20 3429 2c20 6178 203d 204e 6f6e 652c  , 4), ax = None,
-00023920: 2072 6574 5f70 6520 3d20 4661 6c73 6520   ret_pe = False 
-00023930: 293a 0a0a 2020 2020 5343 414e 5059 203d  ):..    SCANPY =
-00023940: 2054 7275 650a 2020 2020 7472 793a 0a20   True.    try:. 
-00023950: 2020 2020 2020 2069 6d70 6f72 7420 7363         import sc
-00023960: 616e 7079 2061 7320 7363 0a20 2020 2065  anpy as sc.    e
-00023970: 7863 6570 7420 496d 706f 7274 4572 726f  xcept ImportErro
-00023980: 723a 0a20 2020 2020 2020 2053 4341 4e50  r:.        SCANP
-00023990: 5920 3d20 4661 6c73 650a 2020 2020 0a20  Y = False.    . 
-000239a0: 2020 2069 6620 286e 6f74 2053 4341 4e50     if (not SCANP
-000239b0: 5929 3a0a 2020 2020 2020 2020 7072 696e  Y):.        prin
-000239c0: 7428 2745 5252 4f52 3a20 7363 616e 7079  t('ERROR: scanpy
-000239d0: 206e 6f74 2069 6e73 7461 6c6c 6564 2e20   not installed. 
-000239e0: 2729 2020 200a 2020 2020 2020 2020 7265  ')   .        re
-000239f0: 7475 726e 0a20 2020 200a 2020 2020 7461  turn.    .    ta
-00023a00: 7267 6574 203d 2027 2c27 2e6a 6f69 6e28  rget = ','.join(
-00023a10: 7461 7267 6574 5f6c 7374 290a 2020 2020  target_lst).    
-00023a20: 6765 6e65 7320 3d20 6c69 7374 2861 6461  genes = list(ada
-00023a30: 7461 2e76 6172 2e69 6e64 6578 2e76 616c  ta.var.index.val
-00023a40: 7565 7329 0a20 2020 2067 656e 6573 203d  ues).    genes =
-00023a50: 206c 6973 7428 7365 7428 6765 6e65 7329   list(set(genes)
-00023a60: 202d 2073 6574 2874 6f5f 6578 636c 7564   - set(to_exclud
-00023a70: 6529 290a 2020 2020 6d6b 7273 5f61 6c6c  e)).    mkrs_all
-00023a80: 2c20 6d6b 725f 6469 6374 203d 2067 6574  , mkr_dict = get
-00023a90: 5f6d 6172 6b65 7273 5f61 6c6c 3328 6d6b  _markers_all3(mk
-00023aa0: 725f 6669 6c65 2c20 7461 7267 6574 5f6c  r_file, target_l
-00023ab0: 7374 2c20 0a20 2020 2020 2020 2020 2020  st, .           
-00023ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023ad0: 2020 2020 2020 2020 2020 2020 2020 706e                pn
-00023ae0: 7368 3132 2c20 6765 6e65 732c 206c 6576  sh12, genes, lev
-00023af0: 656c 2c20 0a20 2020 2020 2020 2020 2020  el, .           
-00023b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023b10: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00023b20: 6d5f 636d 6e20 3d20 7265 6d5f 636d 6e2c  m_cmn = rem_cmn,
-00023b30: 2063 6f6d 625f 6d6b 7273 203d 2063 6f6d   comb_mkrs = com
-00023b40: 625f 6d6b 7273 290a 2020 2020 0a20 2020  b_mkrs).    .   
-00023b50: 2074 6172 6765 745f 6c73 7432 203d 206c   target_lst2 = l
-00023b60: 6973 7428 6d6b 725f 6469 6374 2e6b 6579  ist(mkr_dict.key
-00023b70: 7328 2929 0a20 2020 2079 203d 2061 6461  s()).    y = ada
-00023b80: 7461 2e6f 6273 5b74 7970 655f 6c65 7665  ta.obs[type_leve
-00023b90: 6c5d 0a20 2020 2062 203d 2079 203d 3d20  l].    b = y == 
-00023ba0: 7461 7267 6574 5f6c 7374 325b 305d 0a20  target_lst2[0]. 
-00023bb0: 2020 2066 6f72 2074 2069 6e20 7461 7267     for t in targ
-00023bc0: 6574 5f6c 7374 323a 0a20 2020 2020 2020  et_lst2:.       
-00023bd0: 2062 203d 2062 207c 2028 7920 3d3d 2074   b = b | (y == t
-00023be0: 290a 2020 2020 0a20 2020 206e 6820 3d20  ).    .    nh = 
-00023bf0: 300a 2020 2020 6966 206e 702e 7375 6d28  0.    if np.sum(
-00023c00: 6229 203e 2030 3a20 6e68 203d 2031 0a20  b) > 0: nh = 1. 
-00023c10: 2020 2066 6f72 2074 2069 6e20 7461 7267     for t in targ
-00023c20: 6574 5f6c 7374 323a 0a20 2020 2020 2020  et_lst2:.       
-00023c30: 2062 7420 3d20 7920 3d3d 2074 0a20 2020   bt = y == t.   
-00023c40: 2020 2020 2069 6620 6e70 2e73 756d 2862       if np.sum(b
-00023c50: 7429 203e 2030 3a0a 2020 2020 2020 2020  t) > 0:.        
-00023c60: 2020 2020 6220 3d20 6220 7c20 2879 203d      b = b | (y =
-00023c70: 3d20 7429 0a20 2020 2020 2020 2020 2020  = t).           
-00023c80: 206e 6820 2b3d 2031 0a0a 2020 2020 6164   nh += 1..    ad
-00023c90: 6174 615f 7420 3d20 6164 6174 615b 622c  ata_t = adata[b,
-00023ca0: 206d 6b72 735f 616c 6c5d 0a20 2020 2058   mkrs_all].    X
-00023cb0: 203d 2061 6461 7461 5f74 2e74 6f5f 6466   = adata_t.to_df
-00023cc0: 2829 0a20 2020 2079 203d 2061 6461 7461  ().    y = adata
-00023cd0: 5f74 2e6f 6273 5b74 7970 655f 6c65 7665  _t.obs[type_leve
-00023ce0: 6c5d 0a0a 2020 2020 6d6b 7273 5f64 6963  l]..    mkrs_dic
-00023cf0: 742c 2064 662c 2070 655f 6c73 742c 2070  t, df, pe_lst, p
-00023d00: 6578 5f6c 7374 203d 2075 7064 6174 655f  ex_lst = update_
-00023d10: 6d61 726b 6572 735f 6469 6374 286d 6b72  markers_dict(mkr
-00023d20: 735f 616c 6c2c 206d 6b72 5f64 6963 742c  s_all, mkr_dict,
-00023d30: 2058 2c20 792c 2072 656e 642c 200a 2020   X, y, rend, .  
-00023d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023d60: 2020 2020 2020 6375 746f 6666 203d 2063        cutoff = c
-00023d70: 7574 6f66 662c 204e 7074 203d 204e 7074  utoff, Npt = Npt
-00023d80: 2a32 290a 2020 2020 0a20 2020 206d 6b72  *2).    .    mkr
-00023d90: 735f 6469 6374 203d 2072 656d 6f76 655f  s_dict = remove_
-00023da0: 6d61 635f 636f 6d6d 6f6e 5f6d 6172 6b65  mac_common_marke
-00023db0: 7273 286d 6b72 735f 6469 6374 290a 2020  rs(mkrs_dict).  
-00023dc0: 2020 6966 2072 656e 6420 6973 206e 6f74    if rend is not
-00023dd0: 204e 6f6e 653a 200a 2020 2020 2020 2020   None: .        
-00023de0: 6164 6174 615f 742e 6f62 735b 7479 7065  adata_t.obs[type
-00023df0: 5f6c 6576 656c 5d2e 7265 706c 6163 6528  _level].replace(
-00023e00: 7265 6e64 2c20 696e 706c 6163 6520 3d20  rend, inplace = 
-00023e10: 5472 7565 290a 2020 2020 2020 2020 0a20  True).        . 
-00023e20: 2020 206d 6b61 6c6c 203d 205b 5d0a 2020     mkall = [].  
-00023e30: 2020 666f 7220 6b65 7920 696e 206d 6b72    for key in mkr
-00023e40: 735f 6469 6374 2e6b 6579 7328 293a 0a20  s_dict.keys():. 
-00023e50: 2020 2020 2020 206d 6b61 6c6c 203d 206d         mkall = m
-00023e60: 6b61 6c6c 202b 206d 6b72 735f 6469 6374  kall + mkrs_dict
-00023e70: 5b6b 6579 5d0a 0a20 2020 2023 2320 4765  [key]..    ## Ge
-00023e80: 7420 6e75 6d62 6572 206f 6620 6d61 726b  t number of mark
-00023e90: 6572 2067 656e 6573 2066 6f72 2065 6163  er genes for eac
-00023ea0: 6820 6365 6c6c 2074 7970 650a 2020 2020  h cell type.    
-00023eb0: 6d6b 616c 6c20 3d20 6c69 7374 2873 6574  mkall = list(set
-00023ec0: 286d 6b61 6c6c 2929 0a20 2020 206e 6d6b  (mkall)).    nmk
-00023ed0: 7220 3d20 6469 6374 287a 6970 286d 6b61  r = dict(zip(mka
-00023ee0: 6c6c 2c20 5b30 5d2a 6c65 6e28 6d6b 616c  ll, [0]*len(mkal
-00023ef0: 6c29 2929 0a20 2020 2066 6f72 206b 6579  l))).    for key
-00023f00: 2069 6e20 6d6b 7273 5f64 6963 742e 6b65   in mkrs_dict.ke
-00023f10: 7973 2829 3a0a 2020 2020 2020 2020 666f  ys():.        fo
-00023f20: 7220 6d20 696e 206d 6b72 735f 6469 6374  r m in mkrs_dict
-00023f30: 5b6b 6579 5d3a 0a20 2020 2020 2020 2020  [key]:.         
-00023f40: 2020 206e 6d6b 725b 6d5d 202b 3d20 310a     nmkr[m] += 1.
-00023f50: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-00023f60: 2023 2320 7265 6d6f 7665 2074 6865 206d   ## remove the m
-00023f70: 6172 6b65 7220 6765 6e65 7320 6170 7065  arker genes appe
-00023f80: 7269 6e67 2069 6e20 3320 6f72 206d 6f72  ring in 3 or mor
-00023f90: 6520 6365 6c6c 2074 7970 6573 0a20 2020  e cell types.   
-00023fa0: 2074 6f5f 6465 6c20 3d20 5b5d 0a20 2020   to_del = [].   
-00023fb0: 2066 6f72 206b 6579 2069 6e20 6e6d 6b72   for key in nmkr
-00023fc0: 2e6b 6579 7328 293a 0a20 2020 2020 2020  .keys():.       
-00023fd0: 2069 6620 6e6d 6b72 5b6b 6579 5d20 3e20   if nmkr[key] > 
-00023fe0: 323a 2074 6f5f 6465 6c2e 6170 7065 6e64  2: to_del.append
-00023ff0: 286b 6579 290a 2020 2020 2020 2020 2020  (key).          
-00024000: 2020 0a20 2020 2069 6620 6c65 6e28 746f    .    if len(to
-00024010: 5f64 656c 2920 3e20 303a 0a20 2020 2020  _del) > 0:.     
-00024020: 2020 2066 6f72 206d 2069 6e20 746f 5f64     for m in to_d
-00024030: 656c 3a0a 2020 2020 2020 2020 2020 2020  el:.            
-00024040: 666f 7220 6b65 7920 696e 206d 6b72 735f  for key in mkrs_
-00024050: 6469 6374 2e6b 6579 7328 293a 0a20 2020  dict.keys():.   
-00024060: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00024070: 6d20 696e 206d 6b72 735f 6469 6374 5b6b  m in mkrs_dict[k
-00024080: 6579 5d3a 0a20 2020 2020 2020 2020 2020  ey]:.           
-00024090: 2020 2020 2020 2020 206d 6b72 735f 6469           mkrs_di
-000240a0: 6374 5b6b 6579 5d2e 7265 6d6f 7665 286d  ct[key].remove(m
-000240b0: 290a 2020 2020 2020 2020 2020 2020 0a20  ).            . 
-000240c0: 2020 2023 2320 5365 6c65 6374 206d 6172     ## Select mar
-000240d0: 6b65 7273 2075 7074 6f20 4e70 740a 2020  kers upto Npt.  
-000240e0: 2020 666f 7220 6b65 7920 696e 206d 6b72    for key in mkr
-000240f0: 735f 6469 6374 2e6b 6579 7328 293a 0a20  s_dict.keys():. 
-00024100: 2020 2020 2020 206d 7320 3d20 6d6b 7273         ms = mkrs
-00024110: 5f64 6963 745b 6b65 795d 0a20 2020 2020  _dict[key].     
-00024120: 2020 2069 6620 6c65 6e28 6d73 2920 3e20     if len(ms) > 
-00024130: 4e70 743a 0a20 2020 2020 2020 2020 2020  Npt:.           
-00024140: 206d 6b72 735f 6469 6374 5b6b 6579 5d20   mkrs_dict[key] 
-00024150: 3d20 6d73 5b3a 4e70 745d 0a20 2020 2020  = ms[:Npt].     
-00024160: 2020 2020 2020 200a 2020 2020 2323 2053         .    ## S
-00024170: 656c 6563 7420 6f6e 6c79 2074 6865 2063  elect only the c
-00024180: 656c 6c20 7479 7065 7320 7468 6174 2065  ell types that e
-00024190: 7869 7374 2069 6e20 7468 6520 6461 7461  xist in the data
-000241a0: 2061 6e64 2074 6865 206e 756d 6265 7220   and the number 
-000241b0: 6f66 2063 656c 6c73 203e 3d20 6d69 6e4e  of cells >= minN
-000241c0: 6365 6c6c 730a 2020 2020 7073 5f63 6e74  cells.    ps_cnt
-000241d0: 203d 2061 6461 7461 5f74 2e6f 6273 5b74   = adata_t.obs[t
-000241e0: 7970 655f 6c65 7665 6c5d 2e76 616c 7565  ype_level].value
-000241f0: 5f63 6f75 6e74 7328 290a 2020 2020 6c73  _counts().    ls
-00024200: 745f 7072 6163 203d 206c 6973 7428 7073  t_prac = list(ps
-00024210: 5f63 6e74 2e69 6e64 6578 2e76 616c 7565  _cnt.index.value
-00024220: 7329 2023 206c 6973 7428 6164 6174 615f  s) # list(adata_
-00024230: 742e 6f62 735b 7479 7065 5f6c 6576 656c  t.obs[type_level
-00024240: 5d2e 756e 6971 7565 2829 290a 2020 2020  ].unique()).    
-00024250: 6d6b 7273 5f64 6963 7432 203d 207b 7d0a  mkrs_dict2 = {}.
-00024260: 2020 2020 666f 7220 6d20 696e 206d 6b72      for m in mkr
-00024270: 735f 6469 6374 2e6b 6579 7328 293a 0a20  s_dict.keys():. 
-00024280: 2020 2020 2020 2069 6620 6d20 696e 206c         if m in l
-00024290: 7374 5f70 7261 633a 200a 2020 2020 2020  st_prac: .      
-000242a0: 2020 2020 2020 6966 2070 735f 636e 745b        if ps_cnt[
-000242b0: 6d5d 203e 3d20 6d69 6e4e 6365 6c6c 733a  m] >= minNcells:
-000242c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000242d0: 206d 6b72 735f 6469 6374 325b 6d5d 203d   mkrs_dict2[m] =
-000242e0: 206d 6b72 735f 6469 6374 5b6d 5d0a 2020   mkrs_dict[m].  
-000242f0: 2020 6d6b 7273 5f64 6963 7420 3d20 6d6b    mkrs_dict = mk
-00024300: 7273 5f64 6963 7432 2020 2020 2020 2020  rs_dict2        
-00024310: 0a0a 2020 2020 2323 2052 656d 6f76 6520  ..    ## Remove 
-00024320: 6365 6c6c 2074 7970 6573 2066 6f72 2077  cell types for w
-00024330: 6869 6368 2074 6865 206e 756d 6265 7220  hich the number 
-00024340: 6f66 2063 656c 6c73 2062 656c 6f77 206d  of cells below m
-00024350: 696e 4e63 656c 6c73 0a20 2020 2074 6172  inNcells.    tar
-00024360: 6765 745f 6c73 7432 203d 206c 6973 7428  get_lst2 = list(
-00024370: 6d6b 7273 5f64 6963 742e 6b65 7973 2829  mkrs_dict.keys()
-00024380: 290a 2020 2020 7920 3d20 6164 6174 615f  ).    y = adata_
-00024390: 742e 6f62 735b 7479 7065 5f6c 6576 656c  t.obs[type_level
-000243a0: 5d0a 2020 2020 6220 3d20 7920 3d3d 2074  ].    b = y == t
-000243b0: 6172 6765 745f 6c73 7432 5b30 5d0a 2020  arget_lst2[0].  
-000243c0: 2020 666f 7220 7420 696e 2074 6172 6765    for t in targe
-000243d0: 745f 6c73 7432 3a0a 2020 2020 2020 2020  t_lst2:.        
-000243e0: 6220 3d20 6220 7c20 2879 203d 3d20 7429  b = b | (y == t)
-000243f0: 0a20 2020 200a 2020 2020 6e68 203d 2030  .    .    nh = 0
-00024400: 0a20 2020 2069 6620 6e70 2e73 756d 2862  .    if np.sum(b
-00024410: 2920 3e20 303a 206e 6820 3d20 310a 2020  ) > 0: nh = 1.  
-00024420: 2020 666f 7220 7420 696e 2074 6172 6765    for t in targe
-00024430: 745f 6c73 7432 3a0a 2020 2020 2020 2020  t_lst2:.        
-00024440: 6274 203d 2079 203d 3d20 740a 2020 2020  bt = y == t.    
-00024450: 2020 2020 6966 206e 702e 7375 6d28 6274      if np.sum(bt
-00024460: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
-00024470: 2020 2062 203d 2062 207c 2028 7920 3d3d     b = b | (y ==
-00024480: 2074 290a 2020 2020 2020 2020 2020 2020   t).            
-00024490: 6e68 202b 3d20 310a 0a20 2020 2061 6461  nh += 1..    ada
-000244a0: 7461 5f74 203d 2061 6461 7461 5f74 5b62  ta_t = adata_t[b
-000244b0: 2c20 3a5d 0a20 2020 2069 6620 7265 6e64  , :].    if rend
-000244c0: 2069 7320 6e6f 7420 4e6f 6e65 3a20 0a20   is not None: . 
-000244d0: 2020 2020 2020 2061 6461 7461 5f74 2e6f         adata_t.o
-000244e0: 6273 5b74 7970 655f 6c65 7665 6c5d 2e72  bs[type_level].r
-000244f0: 6570 6c61 6365 2872 656e 642c 2069 6e70  eplace(rend, inp
-00024500: 6c61 6365 203d 2054 7275 6529 0a20 2020  lace = True).   
-00024510: 200a 2020 2020 6e77 203d 2030 0a20 2020   .    nw = 0.   
-00024520: 2066 6f72 206b 6579 2069 6e20 6d6b 7273   for key in mkrs
-00024530: 5f64 6963 742e 6b65 7973 2829 3a0a 2020  _dict.keys():.  
-00024540: 2020 2020 2020 6e77 202b 3d20 6c65 6e28        nw += len(
-00024550: 6d6b 7273 5f64 6963 745b 6b65 795d 290a  mkrs_dict[key]).
-00024560: 2020 2020 2020 2020 0a20 2020 2070 6c74          .    plt
-00024570: 2e72 6328 2766 6f6e 7427 2c20 7369 7a65  .rc('font', size
-00024580: 3d31 3229 2020 2020 0a20 2020 200a 2020  =12)    .    .  
-00024590: 2020 7769 7468 2077 6172 6e69 6e67 732e    with warnings.
-000245a0: 6361 7463 685f 7761 726e 696e 6773 2829  catch_warnings()
-000245b0: 3a0a 2020 2020 2020 2020 7761 726e 696e  :.        warnin
-000245c0: 6773 2e73 696d 706c 6566 696c 7465 7228  gs.simplefilter(
-000245d0: 2269 676e 6f72 6522 290a 2020 2020 2020  "ignore").      
-000245e0: 2020 6470 203d 2073 632e 706c 2e64 6f74    dp = sc.pl.dot
-000245f0: 706c 6f74 2861 6461 7461 5f74 2c20 6d6b  plot(adata_t, mk
-00024600: 7273 5f64 6963 742c 2067 726f 7570 6279  rs_dict, groupby
-00024610: 203d 2074 7970 655f 6c65 7665 6c2c 200a   = type_level, .
-00024620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024630: 2020 2020 2020 2063 6174 6567 6f72 6965         categorie
-00024640: 735f 6f72 6465 7220 3d20 6c69 7374 286d  s_order = list(m
-00024650: 6b72 735f 6469 6374 2e6b 6579 7328 2929  krs_dict.keys())
-00024660: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-00024670: 2020 2020 2020 2020 2020 2361 7820 3d20            #ax = 
-00024680: 6178 2c20 6669 6773 697a 6520 3d20 286e  ax, figsize = (n
-00024690: 772a 302e 3336 2c20 6e68 2a30 2e33 292c  w*0.36, nh*0.3),
-000246a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000246b0: 2020 2020 2020 2020 6c6f 6720 3d20 5472          log = Tr
-000246c0: 7565 2c20 7661 725f 6772 6f75 705f 726f  ue, var_group_ro
-000246d0: 7461 7469 6f6e 203d 2076 675f 726f 742c  tation = vg_rot,
-000246e0: 2073 686f 7720 3d20 4661 6c73 652c 200a   show = False, .
-000246f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024700: 2020 2020 2020 2073 7461 6e64 6172 645f         standard_
-00024710: 7363 616c 6520 3d20 2776 6172 272c 2064  scale = 'var', d
-00024720: 6f74 5f6d 6178 203d 2064 6f74 5f6d 6178  ot_max = dot_max
-00024730: 2c20 7377 6170 5f61 7865 7320 3d20 7377  , swap_axes = sw
-00024740: 6170 5f61 7820 2920 0a0a 2020 2020 6178  ap_ax ) ..    ax
-00024750: 203d 2064 705b 276d 6169 6e70 6c6f 745f   = dp['mainplot_
-00024760: 6178 275d 0a20 2020 2069 6620 7469 746c  ax'].    if titl
-00024770: 6520 6973 206e 6f74 204e 6f6e 653a 0a20  e is not None:. 
-00024780: 2020 2020 2020 2061 782e 7365 745f 7469         ax.set_ti
-00024790: 746c 6528 7469 746c 652c 2070 6164 203d  tle(title, pad =
-000247a0: 2034 302c 2066 6f6e 7473 697a 6520 3d20   40, fontsize = 
-000247b0: 3136 2920 0a20 2020 2061 782e 7469 636b  16) .    ax.tick
-000247c0: 5f70 6172 616d 7328 6c61 6265 6c73 697a  _params(labelsiz
-000247d0: 653d 3132 290a 2020 2020 6178 2e73 6574  e=12).    ax.set
-000247e0: 5f79 6c61 6265 6c28 2741 6e6e 6f74 6174  _ylabel('Annotat
-000247f0: 6564 272c 2066 6f6e 7473 697a 6520 3d20  ed', fontsize = 
-00024800: 3134 290a 2020 2020 0a20 2020 2069 6620  14).    .    if 
-00024810: 7265 745f 7065 3a0a 2020 2020 2020 2020  ret_pe:.        
-00024820: 7265 7475 726e 2070 655f 6c73 742c 2070  return pe_lst, p
-00024830: 6578 5f6c 7374 0a20 2020 2065 6c73 653a  ex_lst.    else:
-00024840: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
-00024850: 2020 2020 0a0a 6465 6620 706c 6f74 5f6d      ..def plot_m
-00024860: 6172 6b65 725f 6578 7072 6573 7369 6f6e  arker_expression
-00024870: 5f70 726f 6669 6c65 2820 6466 5f70 7265  _profile( df_pre
-00024880: 642c 2058 2c20 6d6b 725f 6669 6c65 2c20  d, X, mkr_file, 
-00024890: 706e 7368 3132 203d 2027 3130 3130 3030  pnsh12 = '101000
-000248a0: 272c 200a 2020 2020 2020 2020 2020 2020  ', .            
-000248b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000248c0: 2020 2020 2020 2020 4e70 7420 3d20 3135          Npt = 15
-000248d0: 2c20 636f 6d62 5f6d 6b72 7320 3d20 4661  , comb_mkrs = Fa
-000248e0: 6c73 652c 206d 696e 4e63 656c 6c73 203d  lse, minNcells =
-000248f0: 2032 302c 200a 2020 2020 2020 2020 2020   20, .          
-00024900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024910: 2020 2020 2020 2020 2020 7667 5f72 6f74            vg_rot
-00024920: 203d 2031 302c 2063 7574 6f66 6620 3d20   = 10, cutoff = 
-00024930: 302c 2064 6f74 5f6d 7820 3d20 302e 352c  0, dot_mx = 0.5,
-00024940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024960: 2020 2020 2074 6974 6c65 5f73 7566 6669       title_suffi
-00024970: 7820 3d20 2727 293a 0a0a 2020 2020 414e  x = ''):..    AN
-00024980: 4e44 4154 4120 3d20 5472 7565 0a20 2020  NDATA = True.   
-00024990: 2074 7279 3a0a 2020 2020 2020 2020 6672   try:.        fr
-000249a0: 6f6d 2061 6e6e 6461 7461 2069 6d70 6f72  om anndata impor
-000249b0: 7420 416e 6e44 6174 610a 2020 2020 6578  t AnnData.    ex
-000249c0: 6365 7074 2049 6d70 6f72 7445 7272 6f72  cept ImportError
-000249d0: 3a0a 2020 2020 2020 2020 414e 4e44 4154  :.        ANNDAT
-000249e0: 4120 3d20 4661 6c73 650a 0a20 2020 2069  A = False..    i
-000249f0: 6620 286e 6f74 2041 4e4e 4441 5441 293a  f (not ANNDATA):
-00024a00: 0a20 2020 2020 2020 2070 7269 6e74 2827  .        print('
-00024a10: 4552 524f 523a 2061 6e6e 6461 7461 206e  ERROR: anndata n
-00024a20: 6f74 2069 6e73 7461 6c6c 6564 2e20 2729  ot installed. ')
-00024a30: 2020 200a 2020 2020 2020 2020 7265 7475     .        retu
-00024a40: 726e 0a20 2020 2020 2020 200a 2020 2020  rn.        .    
-00024a50: 6164 6174 6120 3d20 416e 6e44 6174 6128  adata = AnnData(
-00024a60: 583d 2058 2c20 6f62 7320 3d20 6466 5f70  X= X, obs = df_p
-00024a70: 7265 6429 0a20 2020 2023 2061 6461 7461  red).    # adata
-00024a80: 200a 2020 2020 2320 646f 745f 6d78 203d   .    # dot_mx =
-00024a90: 2030 2e35 0a20 2020 2023 2063 7574 6f66   0.5.    # cutof
-00024aa0: 6620 3d20 300a 2020 2020 7265 6d5f 636d  f = 0.    rem_cm
-00024ab0: 6e20 3d20 4661 6c73 650a 2020 2020 7377  n = False.    sw
-00024ac0: 6170 5f61 7820 3d20 4661 6c73 650a 0a20  ap_ax = False.. 
-00024ad0: 2020 204d 616a 5f74 7970 6573 5f70 7265     Maj_types_pre
-00024ae0: 6420 3d20 6c69 7374 2873 6574 2864 665f  d = list(set(df_
-00024af0: 7072 6564 5b27 6365 6c6c 5f74 7970 655f  pred['cell_type_
-00024b00: 6d61 6a6f 7227 5d29 290a 0a20 2020 206d  major']))..    m
-00024b10: 6b72 5f64 6963 742c 206d 6b72 5f64 6963  kr_dict, mkr_dic
-00024b20: 745f 6e65 6720 3d20 5c0a 2020 2020 2020  t_neg = \.      
-00024b30: 2020 6765 745f 6d61 726b 6572 735f 6d61    get_markers_ma
-00024b40: 6a6f 725f 7479 7065 286d 6b72 5f66 696c  jor_type(mkr_fil
-00024b50: 652c 2074 6172 6765 745f 6365 6c6c 7320  e, target_cells 
-00024b60: 3d20 5b5d 2c20 706e 7368 3132 203d 2070  = [], pnsh12 = p
-00024b70: 6e73 6831 322c 0a20 2020 2020 2020 2020  nsh12,.         
-00024b80: 2020 2020 2020 2020 2020 2020 2072 656d               rem
-00024b90: 5f63 6f6d 6d6f 6e20 3d20 4661 6c73 652c  _common = False,
-00024ba0: 2076 6572 626f 7365 203d 2046 616c 7365   verbose = False
-00024bb0: 290a 0a20 2020 204d 616a 5f74 7970 6573  )..    Maj_types
-00024bc0: 203d 206c 6973 7428 6d6b 725f 6469 6374   = list(mkr_dict
-00024bd0: 2e6b 6579 7328 2929 0a20 2020 204d 616a  .keys()).    Maj
-00024be0: 5f74 7970 6573 203d 206c 6973 7428 7365  _types = list(se
-00024bf0: 7428 4d61 6a5f 7479 7065 7329 2e69 6e74  t(Maj_types).int
-00024c00: 6572 7365 6374 696f 6e28 4d61 6a5f 7479  ersection(Maj_ty
-00024c10: 7065 735f 7072 6564 2929 0a0a 2020 2020  pes_pred))..    
-00024c20: 6d6c 7374 5f73 203d 205b 5d0a 2020 2020  mlst_s = [].    
-00024c30: 6d6c 7374 5f6d 203d 205b 5d0a 2020 2020  mlst_m = [].    
-00024c40: 666f 7220 6d20 696e 204d 616a 5f74 7970  for m in Maj_typ
-00024c50: 6573 3a0a 0a20 2020 2020 2020 206d 6b72  es:..        mkr
-00024c60: 5f64 6963 745f 6d69 6e6f 722c 206d 6b72  _dict_minor, mkr
-00024c70: 5f64 6963 745f 6e65 6720 3d20 5c0a 2020  _dict_neg = \.  
-00024c80: 2020 2020 2020 2020 2020 6765 745f 6d61            get_ma
-00024c90: 726b 6572 735f 6365 6c6c 5f74 7970 6528  rkers_cell_type(
-00024ca0: 6d6b 725f 6669 6c65 2c20 7461 7267 6574  mkr_file, target
-00024cb0: 5f63 656c 6c73 203d 205b 6d5d 2c20 706e  _cells = [m], pn
-00024cc0: 7368 3132 203d 2070 6e73 6831 322c 0a20  sh12 = pnsh12,. 
-00024cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024ce0: 2020 2020 2020 2020 2072 656d 5f63 6f6d           rem_com
-00024cf0: 6d6f 6e20 3d20 4661 6c73 652c 2076 6572  mon = False, ver
-00024d00: 626f 7365 203d 2046 616c 7365 290a 0a20  bose = False).. 
-00024d10: 2020 2020 2020 204d 696e 5f74 7970 6573         Min_types
-00024d20: 203d 206c 6973 7428 6d6b 725f 6469 6374   = list(mkr_dict
-00024d30: 5f6d 696e 6f72 2e6b 6579 7328 2929 0a20  _minor.keys()). 
-00024d40: 2020 2020 2020 206d 6b72 5f64 6963 742c         mkr_dict,
-00024d50: 206d 6b72 5f64 6963 745f 6e65 6720 3d20   mkr_dict_neg = 
-00024d60: 5c0a 2020 2020 2020 2020 2020 2020 6765  \.            ge
-00024d70: 745f 6d61 726b 6572 735f 6d69 6e6f 725f  t_markers_minor_
-00024d80: 7479 7065 3228 6d6b 725f 6669 6c65 2c20  type2(mkr_file, 
-00024d90: 7461 7267 6574 5f63 656c 6c73 203d 204d  target_cells = M
-00024da0: 696e 5f74 7970 6573 2c20 706e 7368 3132  in_types, pnsh12
-00024db0: 203d 2070 6e73 6831 322c 0a20 2020 2020   = pnsh12,.     
-00024dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024dd0: 2072 656d 5f63 6f6d 6d6f 6e20 3d20 4661   rem_common = Fa
-00024de0: 6c73 652c 2063 6f6d 625f 6d6b 7273 203d  lse, comb_mkrs =
-00024df0: 2063 6f6d 625f 6d6b 7273 2c20 7665 7262   comb_mkrs, verb
-00024e00: 6f73 6520 3d20 4661 6c73 6529 0a20 2020  ose = False).   
-00024e10: 2020 2020 2069 6620 6c65 6e28 6d6b 725f       if len(mkr_
-00024e20: 6469 6374 2e6b 6579 7328 2929 203e 2031  dict.keys()) > 1
-00024e30: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00024e40: 7072 696e 7428 2725 733a 2025 6927 2025  print('%s: %i' %
-00024e50: 2028 6d2c 206c 656e 286d 6b72 5f64 6963   (m, len(mkr_dic
-00024e60: 742e 6b65 7973 2829 2929 290a 2020 2020  t.keys()))).    
-00024e70: 2020 2020 2020 2020 6d6c 7374 5f6d 2e61          mlst_m.a
-00024e80: 7070 656e 6428 6d29 0a20 2020 2020 2020  ppend(m).       
-00024e90: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00024ea0: 2020 2023 2070 7269 6e74 2827 2573 3a20     # print('%s: 
-00024eb0: 2569 2720 2520 286d 2c20 6c65 6e28 6d6b  %i' % (m, len(mk
-00024ec0: 725f 6469 6374 2e6b 6579 7328 2929 2929  r_dict.keys())))
-00024ed0: 0a20 2020 2020 2020 2020 2020 206d 6c73  .            mls
-00024ee0: 745f 732e 6170 7065 6e64 286d 290a 0a20  t_s.append(m).. 
-00024ef0: 2020 2023 2066 6967 2c20 6178 7320 3d20     # fig, axs = 
-00024f00: 706c 742e 7375 6270 6c6f 7473 286c 656e  plt.subplots(len
-00024f10: 286d 6c73 745f 7329 2b6c 656e 286d 6c73  (mlst_s)+len(mls
-00024f20: 745f 6d29 2c20 3129 0a20 2020 2061 636e  t_m), 1).    acn
-00024f30: 7420 3d20 300a 2020 2020 2323 204d 616a  t = 0.    ## Maj
-00024f40: 6f72 200a 2020 2020 7461 7267 6574 5f6c  or .    target_l
-00024f50: 7374 203d 206d 6c73 745f 730a 2020 2020  st = mlst_s.    
-00024f60: 7265 6e64 203d 204e 6f6e 6520 2320 6469  rend = None # di
-00024f70: 6374 287a 6970 286c 7374 2c20 6c73 7432  ct(zip(lst, lst2
-00024f80: 2929 0a20 2020 2074 7970 655f 6578 6320  )).    type_exc 
-00024f90: 3d20 5b5d 0a20 2020 2074 7970 655f 636f  = [].    type_co
-00024fa0: 6c20 3d20 2763 656c 6c5f 7479 7065 5f6d  l = 'cell_type_m
-00024fb0: 616a 6f72 270a 2020 2020 6c65 7665 6c20  ajor'.    level 
-00024fc0: 3d20 300a 0a20 2020 2069 6620 6c65 6e28  = 0..    if len(
-00024fd0: 7461 7267 6574 5f6c 7374 2920 3e20 303a  target_lst) > 0:
-00024fe0: 0a20 2020 2020 2020 2074 6974 6c65 203d  .        title =
-00024ff0: 2027 4d61 726b 6572 2065 7870 7265 7373   'Marker express
-00025000: 696f 6e20 6f66 2025 7327 2025 2074 6172  ion of %s' % tar
-00025010: 6765 745f 6c73 745b 305d 0a20 2020 2020  get_lst[0].     
-00025020: 2020 2066 6f72 2074 2069 6e20 7461 7267     for t in targ
-00025030: 6574 5f6c 7374 5b31 3a5d 3a20 7469 746c  et_lst[1:]: titl
-00025040: 6520 3d20 7469 746c 6520 2b20 272c 2573  e = title + ',%s
-00025050: 2720 2520 740a 2020 2020 2020 2020 6966  ' % t.        if
-00025060: 206c 656e 2874 6974 6c65 5f73 7566 6669   len(title_suffi
-00025070: 7829 203e 2030 3a0a 2020 2020 2020 2020  x) > 0:.        
-00025080: 2020 2020 7469 746c 6520 3d20 7469 746c      title = titl
-00025090: 6520 2b20 2720 666f 7220 2573 2720 2520  e + ' for %s' % 
-000250a0: 7469 746c 655f 7375 6666 6978 0a0a 2020  title_suffix..  
-000250b0: 2020 2020 2020 706c 6f74 5f64 6f74 2861        plot_dot(a
-000250c0: 6461 7461 2c20 7461 7267 6574 5f6c 7374  data, target_lst
-000250d0: 2c20 7479 7065 5f63 6f6c 2c20 6d6b 725f  , type_col, mkr_
-000250e0: 6669 6c65 2c20 7469 746c 652c 200a 2020  file, title, .  
-000250f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025100: 7265 6e64 203d 2072 656e 642c 206c 6576  rend = rend, lev
-00025110: 656c 203d 206c 6576 656c 2c20 2320 6178  el = level, # ax
-00025120: 203d 2061 7873 5b61 636e 745d 2c0a 2020   = axs[acnt],.  
-00025130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025140: 6375 746f 6666 203d 2063 7574 6f66 662c  cutoff = cutoff,
-00025150: 2070 6e73 6831 3220 3d20 706e 7368 3132   pnsh12 = pnsh12
-00025160: 2c20 7265 6d5f 636d 6e20 3d20 7265 6d5f  , rem_cmn = rem_
-00025170: 636d 6e2c 2064 6f74 5f6d 6178 203d 2064  cmn, dot_max = d
-00025180: 6f74 5f6d 782c 200a 2020 2020 2020 2020  ot_mx, .        
-00025190: 2020 2020 2020 2020 2020 7377 6170 5f61            swap_a
-000251a0: 7820 3d20 7377 6170 5f61 782c 2074 6f5f  x = swap_ax, to_
-000251b0: 6578 636c 7564 6520 3d20 7479 7065 5f65  exclude = type_e
-000251c0: 7863 2c20 4e70 7420 3d20 4e70 742c 2063  xc, Npt = Npt, c
-000251d0: 6f6d 625f 6d6b 7273 203d 2063 6f6d 625f  omb_mkrs = comb_
-000251e0: 6d6b 7273 2c0a 2020 2020 2020 2020 2020  mkrs,.          
-000251f0: 2020 2020 2020 2020 7667 5f72 6f74 203d          vg_rot =
-00025200: 2076 675f 726f 742c 206d 696e 4e63 656c   vg_rot, minNcel
-00025210: 6c73 203d 206d 696e 4e63 656c 6c73 290a  ls = minNcells).
-00025220: 2020 2020 2020 2020 6163 6e74 202b 3d20          acnt += 
-00025230: 310a 2020 2020 2020 2020 0a20 2020 2023  1.        .    #
-00025240: 2320 5375 6273 6574 200a 2020 2020 6c65  # Subset .    le
-00025250: 7665 6c20 3d20 310a 2020 2020 7479 7065  vel = 1.    type
-00025260: 5f63 6f6c 203d 2027 6365 6c6c 5f74 7970  _col = 'cell_typ
-00025270: 655f 7375 6273 6574 270a 0a20 2020 2066  e_subset'..    f
-00025280: 6f72 206d 2069 6e20 6d6c 7374 5f6d 3a0a  or m in mlst_m:.
-00025290: 2020 2020 2020 2020 6d6b 725f 6469 6374          mkr_dict
-000252a0: 5f6d 696e 6f72 2c20 6d6b 725f 6469 6374  _minor, mkr_dict
-000252b0: 5f6e 6567 203d 205c 0a20 2020 2020 2020  _neg = \.       
-000252c0: 2020 2020 2067 6574 5f6d 6172 6b65 7273       get_markers
-000252d0: 5f63 656c 6c5f 7479 7065 286d 6b72 5f66  _cell_type(mkr_f
-000252e0: 696c 652c 2074 6172 6765 745f 6365 6c6c  ile, target_cell
-000252f0: 7320 3d20 5b6d 5d2c 2070 6e73 6831 3220  s = [m], pnsh12 
-00025300: 3d20 706e 7368 3132 2c0a 2020 2020 2020  = pnsh12,.      
-00025310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025320: 2020 2020 7265 6d5f 636f 6d6d 6f6e 203d      rem_common =
-00025330: 2046 616c 7365 2c20 7665 7262 6f73 6520   False, verbose 
-00025340: 3d20 4661 6c73 6529 0a20 2020 2020 2020  = False).       
-00025350: 2069 6620 6d5b 305d 203d 3d20 2754 273a   if m[0] == 'T':
-00025360: 0a20 2020 2020 2020 2020 2020 2074 6172  .            tar
-00025370: 6765 745f 6c73 7420 3d20 6c69 7374 286d  get_lst = list(m
-00025380: 6b72 5f64 6963 745f 6d69 6e6f 722e 6b65  kr_dict_minor.ke
-00025390: 7973 2829 290a 2020 2020 2020 2020 2020  ys()).          
-000253a0: 2020 7431 203d 205b 5d0a 2020 2020 2020    t1 = [].      
-000253b0: 2020 2020 2020 7432 203d 205b 5d0a 2020        t2 = [].  
-000253c0: 2020 2020 2020 2020 2020 666f 7220 7420            for t 
-000253d0: 696e 2074 6172 6765 745f 6c73 743a 0a20  in target_lst:. 
-000253e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000253f0: 6620 2827 4e4b 2720 696e 2074 2e75 7070  f ('NK' in t.upp
-00025400: 6572 2829 2920 7c20 2827 494c 4327 2069  er()) | ('ILC' i
-00025410: 6e20 742e 7570 7065 7228 2929 3a0a 2020  n t.upper()):.  
-00025420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025430: 2020 7432 2e61 7070 656e 6428 7429 0a20    t2.append(t). 
-00025440: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00025450: 6c69 6620 2827 4344 3427 2069 6e20 742e  lif ('CD4' in t.
-00025460: 7570 7065 7228 2929 207c 2028 2743 4438  upper()) | ('CD8
-00025470: 2720 696e 2074 2e75 7070 6572 2829 2029  ' in t.upper() )
-00025480: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00025490: 2020 2020 2020 7431 2e61 7070 656e 6428        t1.append(
-000254a0: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
-000254b0: 6966 206c 656e 2874 3129 203e 2030 3a0a  if len(t1) > 0:.
-000254c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000254d0: 7461 7267 6574 5f6c 7374 203d 2074 310a  target_lst = t1.
-000254e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000254f0: 6966 206c 656e 2874 6172 6765 745f 6c73  if len(target_ls
-00025500: 7429 203e 2030 3a0a 2020 2020 2020 2020  t) > 0:.        
-00025510: 2020 2020 2020 2020 2020 2020 7469 746c              titl
-00025520: 6520 3d20 274d 6172 6b65 7220 6578 7072  e = 'Marker expr
-00025530: 6573 7369 6f6e 206f 6620 2573 2720 2520  ession of %s' % 
-00025540: 7461 7267 6574 5f6c 7374 5b30 5d0a 2020  target_lst[0].  
-00025550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025560: 2020 666f 7220 7420 696e 2074 6172 6765    for t in targe
-00025570: 745f 6c73 745b 313a 5d3a 2074 6974 6c65  t_lst[1:]: title
-00025580: 203d 2074 6974 6c65 202b 2027 2c25 7327   = title + ',%s'
-00025590: 2025 2074 0a20 2020 2020 2020 2020 2020   % t.           
-000255a0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-000255b0: 7469 746c 655f 7375 6666 6978 2920 3e20  title_suffix) > 
-000255c0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-000255d0: 2020 2020 2020 2020 2020 2074 6974 6c65             title
-000255e0: 203d 2074 6974 6c65 202b 2027 2066 6f72   = title + ' for
-000255f0: 2025 7327 2025 2074 6974 6c65 5f73 7566   %s' % title_suf
-00025600: 6669 780a 2020 2020 2020 2020 2020 2020  fix.            
-00025610: 2020 2020 2020 2020 706c 6f74 5f64 6f74          plot_dot
-00025620: 2861 6461 7461 2c20 7461 7267 6574 5f6c  (adata, target_l
-00025630: 7374 2c20 7479 7065 5f63 6f6c 2c20 6d6b  st, type_col, mk
-00025640: 725f 6669 6c65 2c20 7469 746c 652c 200a  r_file, title, .
-00025650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025660: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00025670: 6e64 203d 2072 656e 642c 206c 6576 656c  nd = rend, level
-00025680: 203d 206c 6576 656c 2c20 2320 6178 203d   = level, # ax =
-00025690: 2061 7873 5b61 636e 745d 2c0a 2020 2020   axs[acnt],.    
+00020ac0: 7066 203d 2074 630a 2020 2020 2020 2020  pf = tc.        
+00020ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020ae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020af0: 2020 2020 2079 5f63 6c75 7374 5f63 7572       y_clust_cur
+00020b00: 203d 205b 2725 735f 2569 2720 2520 2870   = ['%s_%i' % (p
+00020b10: 662c 2063 7829 2066 6f72 2063 7820 696e  f, cx) for cx in
+00020b20: 206c 6973 7428 795f 636c 7573 745f 6375   list(y_clust_cu
+00020b30: 7229 5d0a 2020 2020 2020 2020 2020 2020  r)].            
+00020b40: 2020 2020 2020 2020 2320 6466 5f70 7265          # df_pre
+00020b50: 642e 6c6f 635b 6964 782c 2763 6c75 7374  d.loc[idx,'clust
+00020b60: 6572 275d 203d 2079 5f63 6c75 7374 5f63  er'] = y_clust_c
+00020b70: 7572 0a20 2020 2020 2020 2020 2020 2020  ur.             
+00020b80: 2020 2020 2020 2064 665f 7072 6564 322e         df_pred2.
+00020b90: 6c6f 635b 6964 782c 2763 6c75 7374 6572  loc[idx,'cluster
+00020ba0: 5f72 6576 275d 203d 2079 5f63 6c75 7374  _rev'] = y_clust
+00020bb0: 5f63 7572 0a0a 2020 2020 2020 2020 2020  _cur..          
+00020bc0: 2020 2020 2020 2020 2020 6466 5f70 7265            df_pre
+00020bd0: 642e 6c6f 635b 6964 782c 2027 6365 6c6c  d.loc[idx, 'cell
+00020be0: 5f74 7970 655f 7375 6273 6574 2831 7374  _type_subset(1st
+00020bf0: 2927 5d20 3d20 6466 5f72 6573 5f63 7572  )'] = df_res_cur
+00020c00: 5b27 6365 6c6c 5f74 7970 6528 3173 7429  ['cell_type(1st)
+00020c10: 275d 2e61 7374 7970 6528 7374 7229 0a20  '].astype(str). 
+00020c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c30: 2020 2064 665f 7072 6564 2e6c 6f63 5b69     df_pred.loc[i
+00020c40: 6478 2c20 2743 6f6e 6669 6465 6e63 655f  dx, 'Confidence_
+00020c50: 7375 6273 6574 2831 7374 2927 5d20 3d20  subset(1st)'] = 
+00020c60: 6466 5f72 6573 5f63 7572 5b27 2d6c 6f67  df_res_cur['-log
+00020c70: 5027 5d2e 6173 7479 7065 2866 6c6f 6174  P'].astype(float
+00020c80: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00020c90: 2020 2020 2020 6466 5f70 7265 642e 6c6f        df_pred.lo
+00020ca0: 635b 6964 782c 2027 6365 6c6c 5f74 7970  c[idx, 'cell_typ
+00020cb0: 655f 7375 6273 6574 2832 6e64 2927 5d20  e_subset(2nd)'] 
+00020cc0: 3d20 6466 5f72 6573 5f63 7572 5b27 6365  = df_res_cur['ce
+00020cd0: 6c6c 5f74 7970 6528 326e 6429 275d 2e61  ll_type(2nd)'].a
+00020ce0: 7374 7970 6528 7374 7229 0a20 2020 2020  stype(str).     
+00020cf0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00020d00: 665f 7072 6564 2e6c 6f63 5b69 6478 2c20  f_pred.loc[idx, 
+00020d10: 2743 6f6e 6669 6465 6e63 655f 7375 6273  'Confidence_subs
+00020d20: 6574 2832 6e64 2927 5d20 3d20 6466 5f72  et(2nd)'] = df_r
+00020d30: 6573 5f63 7572 5b27 2d6c 6f67 5028 326e  es_cur['-logP(2n
+00020d40: 6429 275d 2e61 7374 7970 6528 666c 6f61  d)'].astype(floa
+00020d50: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
+00020d60: 2020 2020 2020 2020 6966 2064 665f 7265          if df_re
+00020d70: 735f 6375 722e 7368 6170 655b 305d 203e  s_cur.shape[0] >
+00020d80: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00020d90: 2020 2020 2020 2020 2020 2020 6469 6374              dict
+00020da0: 5f73 756d 6d61 7279 5f72 6573 5b27 2573  _summary_res['%s
+00020db0: 2073 7562 7365 7427 2025 2070 665d 203d   subset' % pf] =
+00020dc0: 2064 665f 7265 735f 6375 720a 2020 2020   df_res_cur.    
+00020dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020de0: 2020 2020 6469 6374 5f73 756d 6d61 7279      dict_summary
+00020df0: 5f73 636f 7265 5b27 2573 2073 7562 7365  _score['%s subse
+00020e00: 7427 2025 2070 665d 203d 2064 665f 7363  t' % pf] = df_sc
+00020e10: 6f72 655f 6375 720a 2020 2020 2020 2020  ore_cur.        
+00020e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020e30: 6469 6374 5f73 756d 6d61 7279 5f73 636f  dict_summary_sco
+00020e40: 7265 325b 2725 7320 7375 6273 6574 2720  re2['%s subset' 
+00020e50: 2520 7066 5d20 3d20 6466 5f47 5341 5f73  % pf] = df_GSA_s
+00020e60: 636f 7265 5f63 7572 0a0a 2020 2020 2020  core_cur..      
+00020e70: 2020 625f 6375 7220 3d20 795f 7072 6564    b_cur = y_pred
+00020e80: 5f63 6f72 7265 6374 203d 3d20 2775 6e61  _correct == 'una
+00020e90: 7373 6967 6e65 6427 0a20 2020 2020 2020  ssigned'.       
+00020ea0: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+00020eb0: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+00020ec0: 4e75 6d20 6f66 2075 6e61 7373 6967 6e65  Num of unassigne
+00020ed0: 6420 6365 6c6c 733a 2025 6920 616d 6f6e  d cells: %i amon
+00020ee0: 6720 2569 2720 2520 286e 702e 7375 6d28  g %i' % (np.sum(
+00020ef0: 625f 6375 7229 2c20 6c65 6e28 625f 6375  b_cur), len(b_cu
+00020f00: 7229 2929 0a20 2020 200a 2020 2020 2323  r))).    .    ##
+00020f10: 2065 6e64 206f 6620 7375 6273 6574 2069   end of subset i
+00020f20: 642e 0a0a 2020 2020 2323 2320 5365 7420  d...    ### Set 
+00020f30: 6d69 6e6f 7220 7479 7065 2062 6173 6564  minor type based
+00020f40: 206f 6e20 6974 7320 7375 6273 6574 0a20   on its subset. 
+00020f50: 2020 2023 2727 270a 2020 2020 6966 206e     #'''.    if n
+00020f60: 6f74 2075 7365 5f6d 696e 6f72 3a0a 2020  ot use_minor:.  
+00020f70: 2020 2020 2020 795f 7072 6564 5f73 7562        y_pred_sub
+00020f80: 7365 7420 3d20 6c69 7374 2864 665f 7072  set = list(df_pr
+00020f90: 6564 5b27 6365 6c6c 5f74 7970 655f 7375  ed['cell_type_su
+00020fa0: 6273 6574 275d 290a 2020 2020 2020 2020  bset']).        
+00020fb0: 795f 7072 6564 5f6d 696e 6f72 203d 205b  y_pred_minor = [
+00020fc0: 5d0a 2020 2020 2020 2020 666f 7220 7920  ].        for y 
+00020fd0: 696e 2079 5f70 7265 645f 7375 6273 6574  in y_pred_subset
+00020fe0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00020ff0: 2079 2021 3d20 2775 6e61 7373 6967 6e65   y != 'unassigne
+00021000: 6427 3a0a 2020 2020 2020 2020 2020 2020  d':.            
+00021010: 2020 2020 795f 7072 6564 5f6d 696e 6f72      y_pred_minor
+00021020: 2e61 7070 656e 6428 206d 6170 5f64 6963  .append( map_dic
+00021030: 745f 7375 6232 6d69 6e5b 795d 2029 0a20  t_sub2min[y] ). 
+00021040: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00021050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021060: 2079 5f70 7265 645f 6d69 6e6f 722e 6170   y_pred_minor.ap
+00021070: 7065 6e64 2820 2775 6e61 7373 6967 6e65  pend( 'unassigne
+00021080: 6427 2029 0a20 2020 2020 2020 2020 2020  d' ).           
+00021090: 2020 2020 200a 2020 2020 2020 2020 2320       .        # 
+000210a0: 7072 696e 7428 275c 6e27 2c20 6e70 2e73  print('\n', np.s
+000210b0: 756d 2864 665f 7072 6564 5b27 6365 6c6c  um(df_pred['cell
+000210c0: 5f74 7970 655f 6d69 6e6f 7227 5d20 3d3d  _type_minor'] ==
+000210d0: 206e 702e 6172 7261 7928 795f 7072 6564   np.array(y_pred
+000210e0: 5f6d 696e 6f72 2929 2c20 2720 2f20 272c  _minor)), ' / ',
+000210f0: 206c 656e 2879 5f70 7265 645f 6d69 6e6f   len(y_pred_mino
+00021100: 7229 2c20 656e 6420 3d20 2727 290a 2020  r), end = '').  
+00021110: 2020 2020 2020 6466 5f70 7265 645b 2763        df_pred['c
+00021120: 656c 6c5f 7479 7065 5f6d 696e 6f72 5f6f  ell_type_minor_o
+00021130: 7267 275d 203d 2064 665f 7072 6564 5b27  rg'] = df_pred['
+00021140: 6365 6c6c 5f74 7970 655f 6d69 6e6f 7227  cell_type_minor'
+00021150: 5d2e 636f 7079 2864 6565 7020 3d20 5472  ].copy(deep = Tr
+00021160: 7565 290a 2020 2020 2020 2020 6466 5f70  ue).        df_p
+00021170: 7265 645b 2763 656c 6c5f 7479 7065 5f6d  red['cell_type_m
+00021180: 696e 6f72 275d 203d 2079 5f70 7265 645f  inor'] = y_pred_
+00021190: 6d69 6e6f 720a 2020 2020 2327 2727 0a20  minor.    #'''. 
+000211a0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+000211b0: 2327 2727 0a20 2020 2023 2323 2049 6465  #'''.    ### Ide
+000211c0: 6e74 6966 7920 6379 636c 696e 6720 6365  ntify cycling ce
+000211d0: 6c6c 730a 2020 2020 6966 2063 7963 6c69  lls.    if cycli
+000211e0: 6e67 5f63 656c 6c20 2620 2827 4d4b 4936  ng_cell & ('MKI6
+000211f0: 3727 2069 6e20 6c69 7374 2858 732e 636f  7' in list(Xs.co
+00021200: 6c75 6d6e 732e 7661 6c75 6573 2929 3a0a  lumns.values)):.
+00021210: 2020 2020 2020 2020 6220 3d20 5873 5b27          b = Xs['
+00021220: 4d4b 4936 3727 5d20 3e20 300a 2020 2020  MKI67'] > 0.    
+00021230: 2020 2020 0a20 2020 2020 2020 2079 5f6e      .        y_n
+00021240: 6577 203d 205b 5d0a 2020 2020 2020 2020  ew = [].        
+00021250: 2320 795f 7072 6564 5f6d 616a 6f72 203d  # y_pred_major =
+00021260: 206c 6973 7428 6466 5f70 7265 642e 6c6f   list(df_pred.lo
+00021270: 635b 622c 2027 6365 6c6c 5f74 7970 655f  c[b, 'cell_type_
+00021280: 6d69 6e6f 7227 5d29 0a20 2020 2020 2020  minor']).       
+00021290: 2079 5f70 7265 645f 6d61 6a6f 7220 3d20   y_pred_major = 
+000212a0: 6c69 7374 2864 665f 7072 6564 2e6c 6f63  list(df_pred.loc
+000212b0: 5b62 2c20 2763 656c 6c5f 7479 7065 5f6d  [b, 'cell_type_m
+000212c0: 616a 6f72 275d 290a 2020 2020 2020 2020  ajor']).        
+000212d0: 666f 7220 7920 696e 2079 5f70 7265 645f  for y in y_pred_
+000212e0: 6d61 6a6f 723a 0a20 2020 2020 2020 2020  major:.         
+000212f0: 2020 2069 6620 7920 213d 2027 756e 6173     if y != 'unas
+00021300: 7369 676e 6564 273a 0a20 2020 2020 2020  signed':.       
+00021310: 2020 2020 2020 2020 2079 5f6e 6577 2e61           y_new.a
+00021320: 7070 656e 6428 2725 7320 4379 636c 696e  ppend('%s Cyclin
+00021330: 6727 2025 2079 290a 2020 2020 2020 2020  g' % y).        
+00021340: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00021350: 2020 2020 2020 2020 2020 795f 6e65 772e            y_new.
+00021360: 6170 7065 6e64 2879 290a 2020 2020 2020  append(y).      
+00021370: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+00021380: 2020 2064 665f 7072 6564 2e6c 6f63 5b62     df_pred.loc[b
+00021390: 2c20 2763 656c 6c5f 7479 7065 5f6d 696e  , 'cell_type_min
+000213a0: 6f72 275d 203d 2079 5f6e 6577 0a20 2020  or'] = y_new.   
+000213b0: 2020 2020 2064 665f 7072 6564 2e6c 6f63       df_pred.loc
+000213c0: 5b62 2c20 2763 656c 6c5f 7479 7065 5f73  [b, 'cell_type_s
+000213d0: 7562 7365 7427 5d20 3d20 795f 6e65 770a  ubset'] = y_new.
+000213e0: 2020 2020 2327 2727 0a20 2020 2064 665f      #'''.    df_
+000213f0: 7072 6564 5b27 636c 7573 7465 725f 7265  pred['cluster_re
+00021400: 7627 5d20 3d20 6466 5f70 7265 6432 5b27  v'] = df_pred2['
+00021410: 636c 7573 7465 725f 7265 7627 5d2e 6173  cluster_rev'].as
+00021420: 7479 7065 2873 7472 290a 2020 2020 2020  type(str).      
+00021430: 2020 2020 2020 2020 2020 0a20 2020 2069            .    i
+00021440: 6620 7665 7262 6f73 653a 200a 2020 2020  f verbose: .    
+00021450: 2020 2020 7072 696e 7428 2748 6943 4154      print('HiCAT
+00021460: 2064 6f6e 652e 2028 2569 2927 2025 2072   done. (%i)' % r
+00021470: 6f75 6e64 2874 696d 652e 7469 6d65 2829  ound(time.time()
+00021480: 202d 2073 7461 7274 5f74 696d 6529 290a   - start_time)).
+00021490: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000214a0: 2020 6574 696d 6520 3d20 726f 756e 6428    etime = round(
+000214b0: 7469 6d65 2e74 696d 6528 2920 2d20 7374  time.time() - st
+000214c0: 6172 745f 7469 6d65 5f6e 6577 2920 2020  art_time_new)   
+000214d0: 2020 2020 200a 2020 2020 2020 2020 7374       .        st
+000214e0: 6172 745f 7469 6d65 5f6e 6577 203d 2074  art_time_new = t
+000214f0: 696d 652e 7469 6d65 2829 0a20 2020 2020  ime.time().     
+00021500: 2020 2070 7269 6e74 2827 5325 692e 2720     print('S%i.' 
+00021510: 2520 6574 696d 652c 2065 6e64 203d 2027  % etime, end = '
+00021520: 272c 2066 6c75 7368 203d 2054 7275 6529  ', flush = True)
+00021530: 0a20 2020 2020 2020 2023 2070 7269 6e74  .        # print
+00021540: 2827 2e27 2c20 656e 6420 3d20 2727 2c20  ('.', end = '', 
+00021550: 666c 7573 6820 3d20 5472 7565 290a 2020  flush = True).  
+00021560: 2020 2020 2020 7072 696e 7428 2720 646f        print(' do
+00021570: 6e65 2e20 2825 6929 2720 2520 726f 756e  ne. (%i)' % roun
+00021580: 6428 7469 6d65 2e74 696d 6528 2920 2d20  d(time.time() - 
+00021590: 7374 6172 745f 7469 6d65 2929 0a20 2020  start_time)).   
+000215a0: 2020 2020 200a 2020 2020 6469 6374 5f73       .    dict_s
+000215b0: 756d 6d61 7269 6573 203d 207b 7d0a 2020  ummaries = {}.  
+000215c0: 2020 6469 6374 5f73 756d 6d61 7269 6573    dict_summaries
+000215d0: 5b27 4753 415f 7375 6d6d 6172 7927 5d20  ['GSA_summary'] 
+000215e0: 3d20 6469 6374 5f73 756d 6d61 7279 5f72  = dict_summary_r
+000215f0: 6573 0a20 2020 2064 6963 745f 7375 6d6d  es.    dict_summ
+00021600: 6172 6965 735b 2747 5341 5f73 636f 7265  aries['GSA_score
+00021610: 7327 5d20 3d20 6469 6374 5f73 756d 6d61  s'] = dict_summa
+00021620: 7279 5f73 636f 7265 320a 2020 2020 6469  ry_score2.    di
+00021630: 6374 5f73 756d 6d61 7269 6573 5b27 5265  ct_summaries['Re
+00021640: 665f 7363 6f72 6573 275d 203d 2064 6963  f_scores'] = dic
+00021650: 745f 7375 6d6d 6172 795f 7363 6f72 6533  t_summary_score3
+00021660: 0a20 2020 2064 6963 745f 7375 6d6d 6172  .    dict_summar
+00021670: 6965 735b 2749 6465 6e74 6966 6963 6174  ies['Identificat
+00021680: 696f 6e5f 6d6f 6465 6c5f 7363 6f72 6573  ion_model_scores
+00021690: 275d 203d 2064 6963 745f 7375 6d6d 6172  '] = dict_summar
+000216a0: 795f 7363 6f72 650a 2020 2020 6469 6374  y_score.    dict
+000216b0: 5f73 756d 6d61 7269 6573 5b27 7061 7261  _summaries['para
+000216c0: 6d65 7465 7273 275d 203d 205b 7076 616c  meters'] = [pval
+000216d0: 5f74 682c 2070 7468 5f66 6974 5f70 6e74  _th, pth_fit_pnt
+000216e0: 2c20 7063 745f 7468 5f6d 696e 5d0a 2020  , pct_th_min].  
+000216f0: 2020 6469 6374 5f73 756d 6d61 7269 6573    dict_summaries
+00021700: 5b27 585f 7063 6127 5d20 3d20 585f 7063  ['X_pca'] = X_pc
+00021710: 610a 2020 2020 0a20 2020 2020 2020 0a20  a.    .       . 
+00021720: 2020 2072 6574 7572 6e20 6466 5f70 7265     return df_pre
+00021730: 642c 2064 6963 745f 7375 6d6d 6172 6965  d, dict_summarie
+00021740: 730a 0a0a 2323 2323 2323 2323 2323 2323  s...############
+00021750: 2323 2323 2323 230a 2323 2320 506c 6f74  #######.### Plot
+00021760: 5f64 6f74 2023 2323 2323 230a 0a69 6d70  _dot ######..imp
+00021770: 6f72 7420 7761 726e 696e 6773 0a0a 6465  ort warnings..de
+00021780: 6620 7265 6d6f 7665 5f63 6f6d 6d6f 6e28  f remove_common(
+00021790: 206d 6b72 5f64 6963 742c 2070 726e 203d   mkr_dict, prn =
+000217a0: 2054 7275 6520 293a 0a0a 2020 2020 6374   True ):..    ct
+000217b0: 7320 3d20 6c69 7374 286d 6b72 5f64 6963  s = list(mkr_dic
+000217c0: 742e 6b65 7973 2829 290a 2020 2020 6d6b  t.keys()).    mk
+000217d0: 7273 5f61 6c6c 203d 205b 5d0a 2020 2020  rs_all = [].    
+000217e0: 666f 7220 6320 696e 2063 7473 3a0a 2020  for c in cts:.  
+000217f0: 2020 2020 2020 6d6b 7273 5f61 6c6c 203d        mkrs_all =
+00021800: 206d 6b72 735f 616c 6c20 2b20 6d6b 725f   mkrs_all + mkr_
+00021810: 6469 6374 5b63 5d0a 2020 2020 6d6b 7273  dict[c].    mkrs
+00021820: 5f61 6c6c 203d 206c 6973 7428 7365 7428  _all = list(set(
+00021830: 6d6b 7273 5f61 6c6c 2929 0a20 2020 2064  mkrs_all)).    d
+00021840: 6620 3d20 7064 2e44 6174 6146 7261 6d65  f = pd.DataFrame
+00021850: 2869 6e64 6578 203d 206d 6b72 735f 616c  (index = mkrs_al
+00021860: 6c2c 2063 6f6c 756d 6e73 203d 2063 7473  l, columns = cts
+00021870: 290a 2020 2020 6466 2e6c 6f63 5b3a 2c3a  ).    df.loc[:,:
+00021880: 5d20 3d20 300a 0a20 2020 2066 6f72 2063  ] = 0..    for c
+00021890: 2069 6e20 6374 733a 0a20 2020 2020 2020   in cts:.       
+000218a0: 2064 662e 6c6f 635b 6d6b 725f 6469 6374   df.loc[mkr_dict
+000218b0: 5b63 5d2c 2063 5d20 3d20 310a 2020 2020  [c], c] = 1.    
+000218c0: 5375 6d20 3d20 6466 2e73 756d 2861 7869  Sum = df.sum(axi
+000218d0: 7320 3d20 3129 0a20 2020 200a 2020 2020  s = 1).    .    
+000218e0: 746f 5f64 656c 203d 205b 5d0a 2020 2020  to_del = [].    
+000218f0: 7320 3d20 2727 0a20 2020 2066 6f72 2063  s = ''.    for c
+00021900: 2069 6e20 6374 733a 0a20 2020 2020 2020   in cts:.       
+00021910: 2062 203d 2028 6466 5b63 5d20 3e20 3029   b = (df[c] > 0)
+00021920: 2026 2028 5375 6d20 3d3d 2031 290a 2020   & (Sum == 1).  
+00021930: 2020 2020 2020 6d6b 7273 3120 3d20 6c69        mkrs1 = li
+00021940: 7374 2864 662e 696e 6465 782e 7661 6c75  st(df.index.valu
+00021950: 6573 5b62 5d29 0a20 2020 2020 2020 2069  es[b]).        i
+00021960: 6620 7072 6e20 2620 286c 656e 286d 6b72  f prn & (len(mkr
+00021970: 5f64 6963 745b 635d 2920 213d 206c 656e  _dict[c]) != len
+00021980: 286d 6b72 7331 2929 3a0a 2020 2020 2020  (mkrs1)):.      
+00021990: 2020 2020 2020 7320 3d20 7320 2b20 2725        s = s + '%
+000219a0: 733a 2025 6920 3e20 2569 2c20 2720 2520  s: %i > %i, ' % 
+000219b0: 2863 2c20 6c65 6e28 6d6b 725f 6469 6374  (c, len(mkr_dict
+000219c0: 5b63 5d29 2c20 6c65 6e28 6d6b 7273 3129  [c]), len(mkrs1)
+000219d0: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
+000219e0: 2020 2069 6620 6c65 6e28 6d6b 7273 3129     if len(mkrs1)
+000219f0: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
+00021a00: 2020 2074 6f5f 6465 6c2e 6170 7065 6e64     to_del.append
+00021a10: 2863 290a 2020 2020 2020 2020 656c 7365  (c).        else
+00021a20: 3a0a 2020 2020 2020 2020 2020 2020 6d6b  :.            mk
+00021a30: 725f 6469 6374 5b63 5d20 3d20 6d6b 7273  r_dict[c] = mkrs
+00021a40: 310a 0a20 2020 2069 6620 7072 6e20 2620  1..    if prn & 
+00021a50: 6c65 6e28 7329 203e 2030 3a0a 2020 2020  len(s) > 0:.    
+00021a60: 2020 2020 7072 696e 7428 735b 3a2d 325d      print(s[:-2]
+00021a70: 290a 0a20 2020 2069 6620 6c65 6e28 746f  )..    if len(to
+00021a80: 5f64 656c 2920 3e20 303a 0a20 2020 2020  _del) > 0:.     
+00021a90: 2020 2066 6f72 2063 2069 6e20 6374 733a     for c in cts:
+00021aa0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00021ab0: 6320 696e 2074 6f5f 6465 6c3a 0a20 2020  c in to_del:.   
+00021ac0: 2020 2020 2020 2020 2020 2020 2064 656c               del
+00021ad0: 206d 6b72 5f64 6963 745b 635d 0a20 2020   mkr_dict[c].   
+00021ae0: 2020 2020 2020 2020 2020 2020 200a 2020               .  
+00021af0: 2020 7265 7475 726e 206d 6b72 5f64 6963    return mkr_dic
+00021b00: 740a 0a0a 6465 6620 6765 745f 6d61 726b  t...def get_mark
+00021b10: 6572 735f 616c 6c33 286d 6b72 5f66 696c  ers_all3(mkr_fil
+00021b20: 652c 2074 6172 6765 745f 6c73 742c 2070  e, target_lst, p
+00021b30: 6e73 6831 322c 2067 656e 6573 203d 204e  nsh12, genes = N
+00021b40: 6f6e 652c 206c 6576 656c 203d 2031 2c20  one, level = 1, 
+00021b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021b60: 2020 2020 2072 656d 5f63 6d6e 203d 2046       rem_cmn = F
+00021b70: 616c 7365 2c20 636f 6d62 5f6d 6b72 7320  alse, comb_mkrs 
+00021b80: 3d20 4661 6c73 6520 293a 0a20 2020 200a  = False ):.    .
+00021b90: 2020 2020 2320 7461 7267 6574 203d 2027      # target = '
+00021ba0: 4d79 656c 6f69 6420 6365 6c6c 270a 2020  Myeloid cell'.  
+00021bb0: 2020 6966 206c 6576 656c 203d 3d20 303a    if level == 0:
+00021bc0: 0a20 2020 2020 2020 206d 6b72 5f64 6963  .        mkr_dic
+00021bd0: 742c 206d 6b72 5f64 6963 745f 6e65 6720  t, mkr_dict_neg 
+00021be0: 3d20 5c0a 2020 2020 2020 2020 2020 2020  = \.            
+00021bf0: 6765 745f 6d61 726b 6572 735f 6d61 6a6f  get_markers_majo
+00021c00: 725f 7479 7065 286d 6b72 5f66 696c 652c  r_type(mkr_file,
+00021c10: 2074 6172 6765 745f 6365 6c6c 7320 3d20   target_cells = 
+00021c20: 7461 7267 6574 5f6c 7374 2c20 0a20 2020  target_lst, .   
+00021c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021c50: 2070 6e73 6831 3220 3d20 706e 7368 3132   pnsh12 = pnsh12
+00021c60: 2c20 7265 6d5f 636f 6d6d 6f6e 203d 2046  , rem_common = F
+00021c70: 616c 7365 2c20 7665 7262 6f73 6520 3d20  alse, verbose = 
+00021c80: 4661 6c73 6529 0a20 2020 2065 6c69 6620  False).    elif 
+00021c90: 6c65 7665 6c20 3d3d 2031 3a0a 2020 2020  level == 1:.    
+00021ca0: 2020 2020 6d6b 725f 6469 6374 2c20 6d6b      mkr_dict, mk
+00021cb0: 725f 6469 6374 5f6e 6567 203d 205c 0a20  r_dict_neg = \. 
+00021cc0: 2020 2020 2020 2020 2020 2067 6574 5f6d             get_m
+00021cd0: 6172 6b65 7273 5f6d 696e 6f72 5f74 7970  arkers_minor_typ
+00021ce0: 6532 286d 6b72 5f66 696c 652c 2074 6172  e2(mkr_file, tar
+00021cf0: 6765 745f 6365 6c6c 7320 3d20 7461 7267  get_cells = targ
+00021d00: 6574 5f6c 7374 2c20 0a20 2020 2020 2020  et_lst, .       
+00021d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021d20: 2020 2020 2020 2020 2020 2020 2070 6e73               pns
+00021d30: 6831 3220 3d20 706e 7368 3132 2c20 636f  h12 = pnsh12, co
+00021d40: 6d62 5f6d 6b72 7320 3d20 636f 6d62 5f6d  mb_mkrs = comb_m
+00021d50: 6b72 732c 200a 2020 2020 2020 2020 2020  krs, .          
+00021d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021d70: 2020 2020 2020 2020 2020 7265 6d5f 636f            rem_co
+00021d80: 6d6d 6f6e 203d 2046 616c 7365 2c20 7665  mmon = False, ve
+00021d90: 7262 6f73 6520 3d20 4661 6c73 6529 0a20  rbose = False). 
+00021da0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00021db0: 206d 6b72 5f64 6963 742c 206d 6b72 5f64   mkr_dict, mkr_d
+00021dc0: 6963 745f 6e65 6720 3d20 5c0a 2020 2020  ict_neg = \.    
+00021dd0: 2020 2020 2020 2020 6765 745f 6d61 726b          get_mark
+00021de0: 6572 735f 6365 6c6c 5f74 7970 6528 6d6b  ers_cell_type(mk
+00021df0: 725f 6669 6c65 2c20 7461 7267 6574 5f63  r_file, target_c
+00021e00: 656c 6c73 203d 2074 6172 6765 745f 6c73  ells = target_ls
+00021e10: 742c 2070 6e73 6831 3220 3d20 706e 7368  t, pnsh12 = pnsh
+00021e20: 3132 2c0a 2020 2020 2020 2020 2020 2020  12,.            
+00021e30: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00021e40: 6d5f 636f 6d6d 6f6e 203d 2046 616c 7365  m_common = False
+00021e50: 2c20 7665 7262 6f73 6520 3d20 4661 6c73  , verbose = Fals
+00021e60: 6529 0a20 2020 2020 2020 200a 2020 2020  e).        .    
+00021e70: 6966 2072 656d 5f63 6d6e 3a0a 2020 2020  if rem_cmn:.    
+00021e80: 2020 2020 6d6b 725f 6469 6374 203d 2072      mkr_dict = r
+00021e90: 656d 6f76 655f 636f 6d6d 6f6e 2820 6d6b  emove_common( mk
+00021ea0: 725f 6469 6374 2c20 7072 6e20 3d20 5472  r_dict, prn = Tr
+00021eb0: 7565 2029 0a20 2020 2020 2020 200a 2020  ue ).        .  
+00021ec0: 2020 6d6b 7273 5f61 6c6c 203d 205b 5d20    mkrs_all = [] 
+00021ed0: 235b 2753 454c 4c27 5d0a 2020 2020 6d6b  #['SELL'].    mk
+00021ee0: 7273 5f63 6d6e 203d 205b 5d0a 2020 2020  rs_cmn = [].    
+00021ef0: 666f 7220 6374 2069 6e20 6d6b 725f 6469  for ct in mkr_di
+00021f00: 6374 2e6b 6579 7328 293a 0a20 2020 2020  ct.keys():.     
+00021f10: 2020 2069 6620 6765 6e65 7320 6973 206e     if genes is n
+00021f20: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00021f30: 2020 2020 206d 7320 3d20 6c69 7374 2873       ms = list(s
+00021f40: 6574 286d 6b72 5f64 6963 745b 6374 5d29  et(mkr_dict[ct])
+00021f50: 2e69 6e74 6572 7365 6374 696f 6e28 6765  .intersection(ge
+00021f60: 6e65 7329 290a 2020 2020 2020 2020 656c  nes)).        el
+00021f70: 7365 3a20 0a20 2020 2020 2020 2020 2020  se: .           
+00021f80: 206d 7320 3d20 6d6b 725f 6469 6374 5b63   ms = mkr_dict[c
+00021f90: 745d 0a20 2020 2020 2020 206d 6b72 735f  t].        mkrs_
+00021fa0: 616c 6c20 3d20 6d6b 7273 5f61 6c6c 202b  all = mkrs_all +
+00021fb0: 206d 730a 2020 2020 2020 2020 6966 206c   ms.        if l
+00021fc0: 656e 286d 6b72 735f 636d 6e29 203d 3d20  en(mkrs_cmn) == 
+00021fd0: 303a 0a20 2020 2020 2020 2020 2020 206d  0:.            m
+00021fe0: 6b72 735f 636d 6e20 3d20 6d73 0a20 2020  krs_cmn = ms.   
+00021ff0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00022000: 2020 2020 2020 206d 6b72 735f 636d 6e20         mkrs_cmn 
+00022010: 3d20 6c69 7374 2873 6574 286d 6b72 735f  = list(set(mkrs_
+00022020: 636d 6e29 2e69 6e74 6572 7365 6374 696f  cmn).intersectio
+00022030: 6e28 6d73 2929 0a0a 2020 2020 6d6b 7273  n(ms))..    mkrs
+00022040: 5f61 6c6c 203d 206c 6973 7428 7365 7428  _all = list(set(
+00022050: 6d6b 7273 5f61 6c6c 2929 0a20 2020 2069  mkrs_all)).    i
+00022060: 6620 6765 6e65 7320 6973 206e 6f74 204e  f genes is not N
+00022070: 6f6e 653a 0a20 2020 2020 2020 206d 6b72  one:.        mkr
+00022080: 735f 616c 6c20 3d20 6c69 7374 2873 6574  s_all = list(set
+00022090: 286d 6b72 735f 616c 6c29 2e69 6e74 6572  (mkrs_all).inter
+000220a0: 7365 6374 696f 6e28 6765 6e65 7329 290a  section(genes)).
+000220b0: 2020 2020 0a20 2020 2072 6574 7572 6e20      .    return 
+000220c0: 6d6b 7273 5f61 6c6c 2c20 6d6b 725f 6469  mkrs_all, mkr_di
+000220d0: 6374 0a0a 0a64 6566 2075 7064 6174 655f  ct...def update_
+000220e0: 6d61 726b 6572 735f 6469 6374 286d 6b72  markers_dict(mkr
+000220f0: 735f 616c 6c2c 206d 6b72 5f64 6963 742c  s_all, mkr_dict,
+00022100: 2058 2c20 792c 2072 656e 6420 3d20 4e6f   X, y, rend = No
+00022110: 6e65 2c20 6375 746f 6666 203d 2030 2e33  ne, cutoff = 0.3
+00022120: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+00022130: 2020 2020 2020 2020 2020 204e 616c 6c20             Nall 
+00022140: 3d20 3230 2c20 4e70 7420 3d20 3230 293a  = 20, Npt = 20):
+00022150: 0a20 2020 200a 2020 2020 6966 2072 656e  .    .    if ren
+00022160: 6420 6973 204e 6f6e 653a 0a20 2020 2020  d is None:.     
+00022170: 2020 206c 7374 203d 206c 6973 7428 6d6b     lst = list(mk
+00022180: 725f 6469 6374 2e6b 6579 7328 2929 0a20  r_dict.keys()). 
+00022190: 2020 2020 2020 206c 7374 2e73 6f72 7428         lst.sort(
+000221a0: 290a 2020 2020 2020 2020 7265 6e64 203d  ).        rend =
+000221b0: 2064 6963 7428 7a69 7028 6c73 742c 206c   dict(zip(lst, l
+000221c0: 7374 2929 0a20 2020 2065 6c73 653a 0a20  st)).    else:. 
+000221d0: 2020 2020 2020 206c 7374 203d 206c 6973         lst = lis
+000221e0: 7428 7265 6e64 2e6b 6579 7328 2929 0a20  t(rend.keys()). 
+000221f0: 2020 2020 2020 200a 2020 2020 6466 203d         .    df =
+00022200: 2070 642e 4461 7461 4672 616d 6528 696e   pd.DataFrame(in
+00022210: 6465 7820 3d20 6c73 742c 2063 6f6c 756d  dex = lst, colum
+00022220: 6e73 203d 206d 6b72 735f 616c 6c29 0a20  ns = mkrs_all). 
+00022230: 2020 2064 662e 6c6f 635b 3a2c 3a5d 203d     df.loc[:,:] =
+00022240: 2030 0a20 2020 2020 2020 200a 2020 2020   0.        .    
+00022250: 666f 7220 6374 2069 6e20 6c73 743a 0a20  for ct in lst:. 
+00022260: 2020 2020 2020 2062 203d 2079 203d 3d20         b = y == 
+00022270: 6374 0a20 2020 2020 2020 206d 7320 3d20  ct.        ms = 
+00022280: 6c69 7374 2873 6574 286d 6b72 5f64 6963  list(set(mkr_dic
+00022290: 745b 6374 5d29 2e69 6e74 6572 7365 6374  t[ct]).intersect
+000222a0: 696f 6e28 6d6b 7273 5f61 6c6c 2929 0a20  ion(mkrs_all)). 
+000222b0: 2020 2020 2020 2070 6520 3d20 6c69 7374         pe = list
+000222c0: 2828 582e 6c6f 635b 622c 6d73 5d20 3e20  ((X.loc[b,ms] > 
+000222d0: 3029 2e6d 6561 6e28 6178 6973 203d 2030  0).mean(axis = 0
+000222e0: 2929 0a20 2020 2020 2020 2066 6f72 206a  )).        for j
+000222f0: 2c20 6d20 696e 2065 6e75 6d65 7261 7465  , m in enumerate
+00022300: 286d 7329 3a0a 2020 2020 2020 2020 2020  (ms):.          
+00022310: 2020 6466 2e6c 6f63 5b63 742c 206d 5d20    df.loc[ct, m] 
+00022320: 3d20 7065 5b6a 5d0a 0a20 2020 2069 6620  = pe[j]..    if 
+00022330: 6466 2e73 6861 7065 5b30 5d20 3d3d 2031  df.shape[0] == 1
+00022340: 3a0a 2020 2020 2020 2020 6d6b 7273 5f61  :.        mkrs_a
+00022350: 6c6c 203d 206c 6973 7428 6466 2e63 6f6c  ll = list(df.col
+00022360: 756d 6e73 2e76 616c 7565 7329 0a20 2020  umns.values).   
+00022370: 2020 2020 206d 6b72 735f 6469 6374 203d       mkrs_dict =
+00022380: 207b 7d0a 2020 2020 2020 2020 0a20 2020   {}.        .   
+00022390: 2020 2020 2070 655f 6c73 7420 3d20 5b5d       pe_lst = []
+000223a0: 0a20 2020 2020 2020 2070 6578 5f6c 7374  .        pex_lst
+000223b0: 203d 205b 5d0a 2020 2020 2020 2020 0a20   = [].        . 
+000223c0: 2020 2020 2020 2066 6f72 2063 7420 696e         for ct in
+000223d0: 206c 7374 3a0a 2020 2020 2020 2020 2020   lst:.          
+000223e0: 2020 6220 3d20 7920 3d3d 2063 740a 2020    b = y == ct.  
+000223f0: 2020 2020 2020 2020 2020 6d73 203d 206c            ms = l
+00022400: 6973 7428 7365 7428 6d6b 725f 6469 6374  ist(set(mkr_dict
+00022410: 5b63 745d 292e 696e 7465 7273 6563 7469  [ct]).intersecti
+00022420: 6f6e 286d 6b72 735f 616c 6c29 290a 2020  on(mkrs_all)).  
+00022430: 2020 2020 2020 2020 2020 7065 203d 206e            pe = n
+00022440: 702e 6172 7261 7928 2858 2e6c 6f63 5b62  p.array((X.loc[b
+00022450: 2c6d 735d 203e 2030 292e 6d65 616e 2861  ,ms] > 0).mean(a
+00022460: 7869 7320 3d20 3029 290a 2020 2020 2020  xis = 0)).      
+00022470: 2020 2020 2020 7065 7820 3d20 6e70 2e61        pex = np.a
+00022480: 7272 6179 2828 582e 6c6f 635b 7e62 2c6d  rray((X.loc[~b,m
+00022490: 735d 203e 2030 292e 6d65 616e 2861 7869  s] > 0).mean(axi
+000224a0: 7320 3d20 3029 290a 2020 2020 2020 2020  s = 0)).        
+000224b0: 2020 2020 6f64 7220 3d20 6e70 2e61 7272      odr = np.arr
+000224c0: 6179 282d 7065 292e 6172 6773 6f72 7428  ay(-pe).argsort(
+000224d0: 290a 2020 2020 2020 2020 2020 2020 6d73  ).            ms
+000224e0: 5f6e 6577 203d 205b 5d0a 2020 2020 2020  _new = [].      
+000224f0: 2020 2020 2020 666f 7220 6f20 696e 206f        for o in o
+00022500: 6472 3a0a 2020 2020 2020 2020 2020 2020  dr:.            
+00022510: 2020 2020 6966 2028 7065 5b6f 5d20 3e3d      if (pe[o] >=
+00022520: 2063 7574 6f66 6629 3a0a 2020 2020 2020   cutoff):.      
+00022530: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
+00022540: 5f6e 6577 2e61 7070 656e 6428 6d73 5b6f  _new.append(ms[o
+00022550: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
+00022560: 7065 203d 2070 655b 7e6e 702e 6973 6e61  pe = pe[~np.isna
+00022570: 6e28 7065 295d 0a20 2020 2020 2020 2020  n(pe)].         
+00022580: 2020 2070 6578 203d 2070 6578 5b7e 6e70     pex = pex[~np
+00022590: 2e69 736e 616e 2870 6578 295d 0a20 2020  .isnan(pex)].   
+000225a0: 2020 2020 2020 2020 2070 655f 6c73 7420           pe_lst 
+000225b0: 3d20 7065 5f6c 7374 202b 206c 6973 7428  = pe_lst + list(
+000225c0: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
+000225d0: 7065 785f 6c73 7420 3d20 7065 785f 6c73  pex_lst = pex_ls
+000225e0: 7420 2b20 6c69 7374 2870 6578 290a 2020  t + list(pex).  
+000225f0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+00022600: 2020 2020 2020 2069 6620 6c65 6e28 6d73         if len(ms
+00022610: 5f6e 6577 2920 3e20 303a 0a20 2020 2020  _new) > 0:.     
+00022620: 2020 2020 2020 2020 2020 206d 6b72 735f             mkrs_
+00022630: 6469 6374 5b72 656e 645b 6374 5d5d 203d  dict[rend[ct]] =
+00022640: 206d 735f 6e65 775b 3a6d 696e 284e 7074   ms_new[:min(Npt
+00022650: 2c6c 656e 286d 735f 6e65 7729 295d 0a20  ,len(ms_new))]. 
+00022660: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00022670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022680: 206d 6b72 735f 6469 6374 5b72 656e 645b   mkrs_dict[rend[
+00022690: 6374 5d5d 203d 206d 735b 3a6d 696e 284e  ct]] = ms[:min(N
+000226a0: 7074 2c6c 656e 286d 7329 295d 0a20 2020  pt,len(ms))].   
+000226b0: 2065 6c73 653a 0a20 2020 2020 2020 2070   else:.        p
+000226c0: 3120 3d20 6466 2e6d 6178 2861 7869 7320  1 = df.max(axis 
+000226d0: 3d20 3029 0a20 2020 2020 2020 2070 3220  = 0).        p2 
+000226e0: 3d20 7031 2e63 6f70 7928 6465 6570 203d  = p1.copy(deep =
+000226f0: 2054 7275 6529 0a20 2020 2020 2020 2070   True).        p
+00022700: 325b 3a5d 203d 2030 0a20 2020 2020 2020  2[:] = 0.       
+00022710: 2069 6478 203d 2064 662e 696e 6465 782e   idx = df.index.
+00022720: 7661 6c75 6573 0a20 2020 2020 2020 2066  values.        f
+00022730: 6f72 206d 2069 6e20 6c69 7374 2864 662e  or m in list(df.
+00022740: 636f 6c75 6d6e 732e 7661 6c75 6573 293a  columns.values):
+00022750: 0a20 2020 2020 2020 2020 2020 206f 6472  .            odr
+00022760: 203d 206e 702e 6172 7261 7928 2d64 665b   = np.array(-df[
+00022770: 6d5d 292e 6172 6773 6f72 7428 290a 2020  m]).argsort().  
+00022780: 2020 2020 2020 2020 2020 7032 5b6d 5d20            p2[m] 
+00022790: 3d20 6466 2e6c 6f63 5b69 6478 5b6f 6472  = df.loc[idx[odr
+000227a0: 5b31 5d5d 2c20 6d5d 0a20 2020 2020 2020  [1]], m].       
+000227b0: 206e 6e20 3d20 2864 6620 3e3d 2030 2e35   nn = (df >= 0.5
+000227c0: 292e 7375 6d28 6178 6973 203d 2030 290a  ).sum(axis = 0).
+000227d0: 0a20 2020 2020 2020 2062 3020 3d20 7031  .        b0 = p1
+000227e0: 203e 2030 0a20 2020 2020 2020 2062 3120   > 0.        b1 
+000227f0: 3d20 2870 322f 2870 3120 2b20 302e 3030  = (p2/(p1 + 0.00
+00022800: 3031 2929 203c 2030 2e35 0a20 2020 2020  01)) < 0.5.     
+00022810: 2020 2062 3220 3d20 6e6e 203c 2034 0a20     b2 = nn < 4. 
+00022820: 2020 2020 2020 2062 203d 2062 3020 2320         b = b0 # 
+00022830: 2620 6231 2026 2062 320a 2020 2020 2020  & b1 & b2.      
+00022840: 2020 6466 203d 2064 662e 6c6f 635b 3a2c    df = df.loc[:,
+00022850: 625d 0a20 2020 2020 2020 206d 6b72 735f  b].        mkrs_
+00022860: 616c 6c20 3d20 6c69 7374 2864 662e 636f  all = list(df.co
+00022870: 6c75 6d6e 732e 7661 6c75 6573 290a 0a20  lumns.values).. 
+00022880: 2020 2020 2020 206d 6b72 7320 3d20 5b5d         mkrs = []
+00022890: 200a 2020 2020 2020 2020 6374 7320 3d20   .        cts = 
+000228a0: 5b5d 200a 2020 2020 2020 2020 7065 7320  [] .        pes 
+000228b0: 3d20 5b5d 200a 2020 2020 2020 2020 6d6b  = [] .        mk
+000228c0: 7273 5f64 6963 7420 3d20 7b7d 0a20 2020  rs_dict = {}.   
+000228d0: 2020 2020 2070 655f 6c73 7420 3d20 5b5d       pe_lst = []
+000228e0: 0a20 2020 2020 2020 2070 6578 5f6c 7374  .        pex_lst
+000228f0: 203d 205b 5d0a 2020 2020 2020 2020 666f   = [].        fo
+00022900: 7220 6374 2069 6e20 6c73 743a 0a20 2020  r ct in lst:.   
+00022910: 2020 2020 2020 2020 2062 203d 2079 203d           b = y =
+00022920: 3d20 6374 0a20 2020 2020 2020 2020 2020  = ct.           
+00022930: 206d 7320 3d20 6c69 7374 2873 6574 286d   ms = list(set(m
+00022940: 6b72 5f64 6963 745b 6374 5d29 2e69 6e74  kr_dict[ct]).int
+00022950: 6572 7365 6374 696f 6e28 6d6b 7273 5f61  ersection(mkrs_a
+00022960: 6c6c 2929 0a20 2020 2020 2020 2020 2020  ll)).           
+00022970: 2070 3274 203d 206e 702e 6172 7261 7928   p2t = np.array(
+00022980: 7032 5b6d 735d 290a 2020 2020 2020 2020  p2[ms]).        
+00022990: 2020 2020 7031 7420 3d20 6e70 2e61 7272      p1t = np.arr
+000229a0: 6179 2870 315b 6d73 5d29 0a20 2020 2020  ay(p1[ms]).     
+000229b0: 2020 2020 2020 2070 6520 3d20 6e70 2e61         pe = np.a
+000229c0: 7272 6179 2828 582e 6c6f 635b 622c 6d73  rray((X.loc[b,ms
+000229d0: 5d20 3e20 3029 2e6d 6561 6e28 6178 6973  ] > 0).mean(axis
+000229e0: 203d 2030 2929 0a20 2020 2020 2020 2020   = 0)).         
+000229f0: 2020 2070 6578 203d 206e 702e 6172 7261     pex = np.arra
+00022a00: 7928 2858 2e6c 6f63 5b7e 622c 6d73 5d20  y((X.loc[~b,ms] 
+00022a10: 3e20 3029 2e6d 6561 6e28 6178 6973 203d  > 0).mean(axis =
+00022a20: 2030 2929 0a20 2020 2020 2020 2020 2020   0)).           
+00022a30: 206f 6472 203d 206e 702e 6172 7261 7928   odr = np.array(
+00022a40: 2d70 6529 2e61 7267 736f 7274 2829 0a20  -pe).argsort(). 
+00022a50: 2020 2020 2020 2020 2020 206d 735f 6e65             ms_ne
+00022a60: 7720 3d20 5b5d 0a20 2020 2020 2020 2020  w = [].         
+00022a70: 2020 2066 6f72 206f 2069 6e20 6f64 723a     for o in odr:
+00022a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022a90: 2069 6620 2870 655b 6f5d 203e 3d20 6375   if (pe[o] >= cu
+00022aa0: 746f 6666 2920 2620 287e 6e70 2e69 736e  toff) & (~np.isn
+00022ab0: 616e 2870 655b 6f5d 2929 3a0a 2020 2020  an(pe[o])):.    
+00022ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022ad0: 6d73 5f6e 6577 2e61 7070 656e 6428 6d73  ms_new.append(ms
+00022ae0: 5b6f 5d29 0a0a 2020 2020 2020 2020 2020  [o])..          
+00022af0: 2020 7065 203d 2070 655b 7e6e 702e 6973    pe = pe[~np.is
+00022b00: 6e61 6e28 7065 295d 0a20 2020 2020 2020  nan(pe)].       
+00022b10: 2020 2020 2070 6578 203d 2070 6578 5b7e       pex = pex[~
+00022b20: 6e70 2e69 736e 616e 2870 6578 295d 0a20  np.isnan(pex)]. 
+00022b30: 2020 2020 2020 2020 2020 2070 655f 6c73             pe_ls
+00022b40: 7420 3d20 7065 5f6c 7374 202b 206c 6973  t = pe_lst + lis
+00022b50: 7428 7065 290a 2020 2020 2020 2020 2020  t(pe).          
+00022b60: 2020 7065 785f 6c73 7420 3d20 7065 785f    pex_lst = pex_
+00022b70: 6c73 7420 2b20 6c69 7374 2870 6578 290a  lst + list(pex).
+00022b80: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00022b90: 6c65 6e28 6d73 5f6e 6577 2920 3e20 303a  len(ms_new) > 0:
+00022ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022bb0: 206d 6b72 735f 6469 6374 5b72 656e 645b   mkrs_dict[rend[
+00022bc0: 6374 5d5d 203d 206d 735f 6e65 775b 3a6d  ct]] = ms_new[:m
+00022bd0: 696e 284e 7074 2c6c 656e 286d 735f 6e65  in(Npt,len(ms_ne
+00022be0: 7729 295d 0a20 2020 2020 2020 2020 2020  w))].           
+00022bf0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00022c00: 2020 2020 2020 206d 6b72 735f 6469 6374         mkrs_dict
+00022c10: 5b72 656e 645b 6374 5d5d 203d 206d 735b  [rend[ct]] = ms[
+00022c20: 3a6d 696e 284e 7074 2c6c 656e 286d 7329  :min(Npt,len(ms)
+00022c30: 295d 0a20 2020 2020 2020 2020 2020 2020  )].             
+00022c40: 2020 200a 2020 2020 7265 7475 726e 206d     .    return m
+00022c50: 6b72 735f 6469 6374 2c20 6466 2c20 7065  krs_dict, df, pe
+00022c60: 5f6c 7374 2c20 7065 785f 6c73 740a 0a0a  _lst, pex_lst...
+00022c70: 0a64 6566 2072 656d 6f76 655f 6d61 635f  .def remove_mac_
+00022c80: 636f 6d6d 6f6e 5f6d 6172 6b65 7273 286d  common_markers(m
+00022c90: 6b72 735f 6469 6374 293a 2020 200a 0a20  krs_dict):   .. 
+00022ca0: 2020 206c 7374 3220 3d20 6c69 7374 286d     lst2 = list(m
+00022cb0: 6b72 735f 6469 6374 2e6b 6579 7328 2929  krs_dict.keys())
+00022cc0: 0a20 2020 206c 7374 203d 205b 5d0a 2020  .    lst = [].  
+00022cd0: 2020 4d6f 6e6f 203d 204e 6f6e 650a 2020    Mono = None.  
+00022ce0: 2020 666f 7220 6974 656d 2069 6e20 6c73    for item in ls
+00022cf0: 7432 3a0a 2020 2020 2020 2020 6966 2069  t2:.        if i
+00022d00: 7465 6d5b 3a33 5d20 3d3d 2027 4d61 6327  tem[:3] == 'Mac'
+00022d10: 3a0a 2020 2020 2020 2020 2020 2020 6c73  :.            ls
+00022d20: 742e 6170 7065 6e64 2869 7465 6d29 0a20  t.append(item). 
+00022d30: 2020 2020 2020 2069 6620 6974 656d 5b3a         if item[:
+00022d40: 345d 203d 3d20 274d 6f6e 6f27 3a0a 2020  4] == 'Mono':.  
+00022d50: 2020 2020 2020 2020 2020 4d6f 6e6f 203d            Mono =
+00022d60: 2069 7465 6d0a 2020 2020 2020 2020 2020   item.          
+00022d70: 2020 0a20 2020 2069 6620 6c65 6e28 6c73    .    if len(ls
+00022d80: 7429 203e 2031 3a0a 2020 2020 2020 2020  t) > 1:.        
+00022d90: 6d61 635f 636f 6d6d 6f6e 203d 206d 6b72  mac_common = mkr
+00022da0: 735f 6469 6374 5b6c 7374 5b30 5d5d 0a20  s_dict[lst[0]]. 
+00022db0: 2020 2020 2020 2066 6f72 2069 7465 6d20         for item 
+00022dc0: 696e 206c 7374 5b31 3a5d 3a0a 2020 2020  in lst[1:]:.    
+00022dd0: 2020 2020 2020 2020 6d61 635f 636f 6d6d          mac_comm
+00022de0: 6f6e 203d 206c 6973 7428 7365 7428 6d61  on = list(set(ma
+00022df0: 635f 636f 6d6d 6f6e 292e 696e 7465 7273  c_common).inters
+00022e00: 6563 7469 6f6e 286d 6b72 735f 6469 6374  ection(mkrs_dict
+00022e10: 5b69 7465 6d5d 2929 0a20 2020 2020 2020  [item])).       
+00022e20: 2020 2020 200a 2020 2020 2020 2020 666f       .        fo
+00022e30: 7220 6974 656d 2069 6e20 6c73 743a 0a20  r item in lst:. 
+00022e40: 2020 2020 2020 2020 2020 2066 6f72 206d             for m
+00022e50: 6b72 2069 6e20 6d61 635f 636f 6d6d 6f6e  kr in mac_common
+00022e60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00022e70: 2020 6d6b 7273 5f64 6963 745b 6974 656d    mkrs_dict[item
+00022e80: 5d2e 7265 6d6f 7665 286d 6b72 290a 2020  ].remove(mkr).  
+00022e90: 2020 2020 2020 6966 204d 6f6e 6f20 6973        if Mono is
+00022ea0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00022eb0: 2020 2020 2020 206d 6f6e 6f5f 6c73 7420         mono_lst 
+00022ec0: 3d20 6d6b 7273 5f64 6963 745b 4d6f 6e6f  = mkrs_dict[Mono
+00022ed0: 5d0a 2020 2020 2020 2020 2020 2020 6465  ].            de
+00022ee0: 6c20 6d6b 7273 5f64 6963 745b 4d6f 6e6f  l mkrs_dict[Mono
+00022ef0: 5d0a 2020 2020 2020 2020 2020 2020 6d6b  ].            mk
+00022f00: 7273 5f64 6963 745b 4d6f 6e6f 5d20 3d20  rs_dict[Mono] = 
+00022f10: 6d6f 6e6f 5f6c 7374 0a20 2020 2020 2020  mono_lst.       
+00022f20: 2020 2020 200a 2020 2020 7265 7475 726e       .    return
+00022f30: 206d 6b72 735f 6469 6374 0a0a 2020 2020   mkrs_dict..    
+00022f40: 0a64 6566 2070 6c6f 745f 646f 745f 7328  .def plot_dot_s(
+00022f50: 6164 6174 612c 2074 6172 6765 745f 6c73  adata, target_ls
+00022f60: 742c 2074 7970 655f 6c65 7665 6c2c 206d  t, type_level, m
+00022f70: 6b72 5f66 696c 652c 2074 6974 6c65 203d  kr_file, title =
+00022f80: 204e 6f6e 652c 2072 656e 6420 3d20 4e6f   None, rend = No
+00022f90: 6e65 2c20 6c65 7665 6c20 3d20 312c 200a  ne, level = 1, .
+00022fa0: 2020 2020 2020 2020 2020 2020 2020 6375                cu
+00022fb0: 746f 6666 203d 2030 2c20 706e 7368 3132  toff = 0, pnsh12
+00022fc0: 203d 2027 3130 3130 3030 272c 2072 656d   = '101000', rem
+00022fd0: 5f63 6d6e 203d 2046 616c 7365 2c20 646f  _cmn = False, do
+00022fe0: 745f 6d61 7820 3d20 302e 352c 2073 7761  t_max = 0.5, swa
+00022ff0: 705f 6178 203d 2046 616c 7365 2c0a 2020  p_ax = False,.  
+00023000: 2020 2020 2020 2020 2020 2020 746f 5f65              to_e
+00023010: 7863 6c75 6465 203d 205b 5d2c 204e 7074  xclude = [], Npt
+00023020: 203d 2031 352c 2063 6f6d 625f 6d6b 7273   = 15, comb_mkrs
+00023030: 203d 2046 616c 7365 2c20 6d69 6e4e 6365   = False, minNce
+00023040: 6c6c 7320 3d20 3230 2c20 7667 5f72 6f74  lls = 20, vg_rot
+00023050: 203d 2031 302c 0a20 2020 2020 2020 2020   = 10,.         
+00023060: 2020 2020 2066 6967 7369 7a65 203d 2028       figsize = (
+00023070: 3230 2c20 3429 2c20 6178 203d 204e 6f6e  20, 4), ax = Non
+00023080: 652c 2072 6574 5f70 6520 3d20 4661 6c73  e, ret_pe = Fals
+00023090: 6520 293a 0a0a 2020 2020 5343 414e 5059  e ):..    SCANPY
+000230a0: 203d 2054 7275 650a 2020 2020 7472 793a   = True.    try:
+000230b0: 0a20 2020 2020 2020 2069 6d70 6f72 7420  .        import 
+000230c0: 7363 616e 7079 2061 7320 7363 0a20 2020  scanpy as sc.   
+000230d0: 2065 7863 6570 7420 496d 706f 7274 4572   except ImportEr
+000230e0: 726f 723a 0a20 2020 2020 2020 2053 4341  ror:.        SCA
+000230f0: 4e50 5920 3d20 4661 6c73 650a 2020 2020  NPY = False.    
+00023100: 0a20 2020 2069 6620 286e 6f74 2053 4341  .    if (not SCA
+00023110: 4e50 5929 3a0a 2020 2020 2020 2020 7072  NPY):.        pr
+00023120: 696e 7428 2745 5252 4f52 3a20 7363 616e  int('ERROR: scan
+00023130: 7079 206e 6f74 2069 6e73 7461 6c6c 6564  py not installed
+00023140: 2e20 2729 2020 200a 2020 2020 2020 2020  . ')   .        
+00023150: 7265 7475 726e 0a20 2020 200a 2020 2020  return.    .    
+00023160: 7461 7267 6574 203d 2027 2c27 2e6a 6f69  target = ','.joi
+00023170: 6e28 7461 7267 6574 5f6c 7374 290a 2020  n(target_lst).  
+00023180: 2020 6765 6e65 7320 3d20 6c69 7374 2861    genes = list(a
+00023190: 6461 7461 2e76 6172 2e69 6e64 6578 2e76  data.var.index.v
+000231a0: 616c 7565 7329 0a20 2020 2067 656e 6573  alues).    genes
+000231b0: 203d 206c 6973 7428 7365 7428 6765 6e65   = list(set(gene
+000231c0: 7329 202d 2073 6574 2874 6f5f 6578 636c  s) - set(to_excl
+000231d0: 7564 6529 290a 2020 2020 6d6b 7273 5f61  ude)).    mkrs_a
+000231e0: 6c6c 2c20 6d6b 725f 6469 6374 203d 2067  ll, mkr_dict = g
+000231f0: 6574 5f6d 6172 6b65 7273 5f61 6c6c 3328  et_markers_all3(
+00023200: 6d6b 725f 6669 6c65 2c20 7461 7267 6574  mkr_file, target
+00023210: 5f6c 7374 2c20 0a20 2020 2020 2020 2020  _lst, .         
+00023220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023240: 706e 7368 3132 2c20 6765 6e65 732c 206c  pnsh12, genes, l
+00023250: 6576 656c 2c20 0a20 2020 2020 2020 2020  evel, .         
+00023260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023280: 7265 6d5f 636d 6e20 3d20 7265 6d5f 636d  rem_cmn = rem_cm
+00023290: 6e2c 200a 2020 2020 2020 2020 2020 2020  n, .            
+000232a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000232b0: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+000232c0: 625f 6d6b 7273 203d 2063 6f6d 625f 6d6b  b_mkrs = comb_mk
+000232d0: 7273 2029 0a20 2020 2074 6172 6765 745f  rs ).    target_
+000232e0: 6c73 7432 203d 206c 6973 7428 6d6b 725f  lst2 = list(mkr_
+000232f0: 6469 6374 2e6b 6579 7328 2929 0a20 2020  dict.keys()).   
+00023300: 2079 203d 2061 6461 7461 2e6f 6273 5b74   y = adata.obs[t
+00023310: 7970 655f 6c65 7665 6c5d 0a20 2020 2062  ype_level].    b
+00023320: 203d 2079 203d 3d20 7461 7267 6574 5f6c   = y == target_l
+00023330: 7374 325b 305d 0a20 2020 2066 6f72 2074  st2[0].    for t
+00023340: 2069 6e20 7461 7267 6574 5f6c 7374 323a   in target_lst2:
+00023350: 0a20 2020 2020 2020 2062 203d 2062 207c  .        b = b |
+00023360: 2028 7920 3d3d 2074 290a 2020 2020 2020   (y == t).      
+00023370: 2020 0a20 2020 206e 6820 3d20 300a 2020    .    nh = 0.  
+00023380: 2020 6966 206e 702e 7375 6d28 6229 203e    if np.sum(b) >
+00023390: 2030 3a20 6e68 203d 2031 0a20 2020 2066   0: nh = 1.    f
+000233a0: 6f72 2074 2069 6e20 7461 7267 6574 5f6c  or t in target_l
+000233b0: 7374 323a 0a20 2020 2020 2020 2062 7420  st2:.        bt 
+000233c0: 3d20 7920 3d3d 2074 0a20 2020 2020 2020  = y == t.       
+000233d0: 2069 6620 6e70 2e73 756d 2862 7429 203e   if np.sum(bt) >
+000233e0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+000233f0: 6220 3d20 6220 7c20 2879 203d 3d20 7429  b = b | (y == t)
+00023400: 0a20 2020 2020 2020 2020 2020 206e 6820  .            nh 
+00023410: 2b3d 2031 0a0a 2020 2020 6164 6174 615f  += 1..    adata_
+00023420: 7420 3d20 6164 6174 615b 622c 6d6b 7273  t = adata[b,mkrs
+00023430: 5f61 6c6c 5d0a 2020 2020 5820 3d20 6164  _all].    X = ad
+00023440: 6174 615f 742e 746f 5f64 6628 290a 2020  ata_t.to_df().  
+00023450: 2020 7920 3d20 6164 6174 615f 742e 6f62    y = adata_t.ob
+00023460: 735b 7479 7065 5f6c 6576 656c 5d0a 0a20  s[type_level].. 
+00023470: 2020 206d 6b72 735f 6469 6374 2c20 6466     mkrs_dict, df
+00023480: 2c20 7065 5f6c 7374 2c20 7065 785f 6c73  , pe_lst, pex_ls
+00023490: 7420 3d20 7570 6461 7465 5f6d 6172 6b65  t = update_marke
+000234a0: 7273 5f64 6963 7428 6d6b 7273 5f61 6c6c  rs_dict(mkrs_all
+000234b0: 2c20 6d6b 725f 6469 6374 2c20 582c 2079  , mkr_dict, X, y
+000234c0: 2c20 7265 6e64 2c20 0a20 2020 2020 2020  , rend, .       
+000234d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000234e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000234f0: 2063 7574 6f66 6620 3d20 6375 746f 6666   cutoff = cutoff
+00023500: 2c20 4e70 7420 3d20 4e70 7429 0a0a 2020  , Npt = Npt)..  
+00023510: 2020 6d6b 7273 5f64 6963 7420 3d20 7265    mkrs_dict = re
+00023520: 6d6f 7665 5f6d 6163 5f63 6f6d 6d6f 6e5f  move_mac_common_
+00023530: 6d61 726b 6572 7328 6d6b 7273 5f64 6963  markers(mkrs_dic
+00023540: 7429 0a20 2020 2069 6620 7265 6e64 2069  t).    if rend i
+00023550: 7320 6e6f 7420 4e6f 6e65 3a20 0a20 2020  s not None: .   
+00023560: 2020 2020 2061 6461 7461 5f74 2e6f 6273       adata_t.obs
+00023570: 5b74 7970 655f 6c65 7665 6c5d 2e72 6570  [type_level].rep
+00023580: 6c61 6365 2872 656e 642c 2069 6e70 6c61  lace(rend, inpla
+00023590: 6365 203d 2054 7275 6529 0a0a 2020 2020  ce = True)..    
+000235a0: 6e77 203d 2030 0a20 2020 2066 6f72 206b  nw = 0.    for k
+000235b0: 6579 2069 6e20 6d6b 7273 5f64 6963 742e  ey in mkrs_dict.
+000235c0: 6b65 7973 2829 3a0a 2020 2020 2020 2020  keys():.        
+000235d0: 6e77 202b 3d20 6c65 6e28 6d6b 7273 5f64  nw += len(mkrs_d
+000235e0: 6963 745b 6b65 795d 290a 2020 2020 2020  ict[key]).      
+000235f0: 2020 0a20 2020 2070 6c74 2e72 6328 2766    .    plt.rc('f
+00023600: 6f6e 7427 2c20 7369 7a65 3d31 3229 2020  ont', size=12)  
+00023610: 2020 2020 2020 2020 0a0a 2020 2020 7769          ..    wi
+00023620: 7468 2077 6172 6e69 6e67 732e 6361 7463  th warnings.catc
+00023630: 685f 7761 726e 696e 6773 2829 3a0a 2020  h_warnings():.  
+00023640: 2020 2020 2020 7761 726e 696e 6773 2e73        warnings.s
+00023650: 696d 706c 6566 696c 7465 7228 2269 676e  implefilter("ign
+00023660: 6f72 6522 290a 2020 2020 2020 2020 6470  ore").        dp
+00023670: 203d 2073 632e 706c 2e64 6f74 706c 6f74   = sc.pl.dotplot
+00023680: 2861 6461 7461 5f74 2c20 6d6b 7273 5f64  (adata_t, mkrs_d
+00023690: 6963 742c 2067 726f 7570 6279 203d 2074  ict, groupby = t
+000236a0: 7970 655f 6c65 7665 6c2c 200a 2020 2020  ype_level, .    
+000236b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000236c0: 2020 2063 6174 6567 6f72 6965 735f 6f72     categories_or
+000236d0: 6465 7220 3d20 6c69 7374 286d 6b72 735f  der = list(mkrs_
+000236e0: 6469 6374 2e6b 6579 7328 2929 2c20 0a20  dict.keys()), . 
+000236f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023700: 2020 2020 2020 2320 6178 203d 2061 782c        # ax = ax,
+00023710: 2066 6967 7369 7a65 203d 2028 6e77 2a30   figsize = (nw*0
+00023720: 2e33 362c 206e 682a 302e 3329 2c0a 2020  .36, nh*0.3),.  
+00023730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023740: 2020 2020 206c 6f67 203d 2054 7275 652c       log = True,
+00023750: 2076 6172 5f67 726f 7570 5f72 6f74 6174   var_group_rotat
+00023760: 696f 6e20 3d20 7667 5f72 6f74 2c20 7368  ion = vg_rot, sh
+00023770: 6f77 203d 2046 616c 7365 2c20 0a20 2020  ow = False, .   
+00023780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023790: 2020 2020 7374 616e 6461 7264 5f73 6361      standard_sca
+000237a0: 6c65 203d 2027 7661 7227 2c20 646f 745f  le = 'var', dot_
+000237b0: 6d61 7820 3d20 646f 745f 6d61 782c 2073  max = dot_max, s
+000237c0: 7761 705f 6178 6573 203d 2073 7761 705f  wap_axes = swap_
+000237d0: 6178 2029 200a 2020 2020 0a20 2020 2061  ax ) .    .    a
+000237e0: 7820 3d20 6470 5b27 6d61 696e 706c 6f74  x = dp['mainplot
+000237f0: 5f61 7827 5d0a 2020 2020 6966 2074 6974  _ax'].    if tit
+00023800: 6c65 2069 7320 6e6f 7420 4e6f 6e65 3a0a  le is not None:.
+00023810: 2020 2020 2020 2020 6178 2e73 6574 5f74          ax.set_t
+00023820: 6974 6c65 2874 6974 6c65 2c20 7061 6420  itle(title, pad 
+00023830: 3d20 3430 2c20 666f 6e74 7369 7a65 203d  = 40, fontsize =
+00023840: 2031 3629 200a 2020 2020 6178 2e74 6963   16) .    ax.tic
+00023850: 6b5f 7061 7261 6d73 286c 6162 656c 7369  k_params(labelsi
+00023860: 7a65 3d31 3229 0a20 2020 2061 782e 7365  ze=12).    ax.se
+00023870: 745f 796c 6162 656c 2827 416e 6e6f 7461  t_ylabel('Annota
+00023880: 7465 6427 2c20 666f 6e74 7369 7a65 203d  ted', fontsize =
+00023890: 2031 3429 0a20 2020 200a 2020 2020 6966   14).    .    if
+000238a0: 2072 6574 5f70 653a 0a20 2020 2020 2020   ret_pe:.       
+000238b0: 2072 6574 7572 6e20 7065 5f6c 7374 2c20   return pe_lst, 
+000238c0: 7065 785f 6c73 740a 2020 2020 656c 7365  pex_lst.    else
+000238d0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+000238e0: 0a0a 2020 2020 0a64 6566 2070 6c6f 745f  ..    .def plot_
+000238f0: 646f 7428 2061 6461 7461 2c20 7461 7267  dot( adata, targ
+00023900: 6574 5f6c 7374 2c20 7479 7065 5f6c 6576  et_lst, type_lev
+00023910: 656c 2c20 6d6b 725f 6669 6c65 2c20 7469  el, mkr_file, ti
+00023920: 746c 6520 3d20 4e6f 6e65 2c20 7265 6e64  tle = None, rend
+00023930: 203d 204e 6f6e 652c 206c 6576 656c 203d   = None, level =
+00023940: 2031 2c20 0a20 2020 2020 2020 2020 2020   1, .           
+00023950: 2020 2063 7574 6f66 6620 3d20 302c 2070     cutoff = 0, p
+00023960: 6e73 6831 3220 3d20 2731 3031 3030 3027  nsh12 = '101000'
+00023970: 2c20 7265 6d5f 636d 6e20 3d20 4661 6c73  , rem_cmn = Fals
+00023980: 652c 2064 6f74 5f6d 6178 203d 2030 2e35  e, dot_max = 0.5
+00023990: 2c20 7377 6170 5f61 7820 3d20 4661 6c73  , swap_ax = Fals
+000239a0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+000239b0: 2074 6f5f 6578 636c 7564 6520 3d20 5b5d   to_exclude = []
+000239c0: 2c20 4e70 7420 3d20 3135 2c20 636f 6d62  , Npt = 15, comb
+000239d0: 5f6d 6b72 7320 3d20 4661 6c73 652c 206d  _mkrs = False, m
+000239e0: 696e 4e63 656c 6c73 203d 2032 302c 2076  inNcells = 20, v
+000239f0: 675f 726f 7420 3d20 3130 2c0a 2020 2020  g_rot = 10,.    
+00023a00: 2020 2020 2020 2020 2020 6669 6773 697a            figsiz
+00023a10: 6520 3d20 2832 302c 2034 292c 2061 7820  e = (20, 4), ax 
+00023a20: 3d20 4e6f 6e65 2c20 7265 745f 7065 203d  = None, ret_pe =
+00023a30: 2046 616c 7365 2029 3a0a 0a20 2020 2053   False ):..    S
+00023a40: 4341 4e50 5920 3d20 5472 7565 0a20 2020  CANPY = True.   
+00023a50: 2074 7279 3a0a 2020 2020 2020 2020 696d   try:.        im
+00023a60: 706f 7274 2073 6361 6e70 7920 6173 2073  port scanpy as s
+00023a70: 630a 2020 2020 6578 6365 7074 2049 6d70  c.    except Imp
+00023a80: 6f72 7445 7272 6f72 3a0a 2020 2020 2020  ortError:.      
+00023a90: 2020 5343 414e 5059 203d 2046 616c 7365    SCANPY = False
+00023aa0: 0a20 2020 200a 2020 2020 6966 2028 6e6f  .    .    if (no
+00023ab0: 7420 5343 414e 5059 293a 0a20 2020 2020  t SCANPY):.     
+00023ac0: 2020 2070 7269 6e74 2827 4552 524f 523a     print('ERROR:
+00023ad0: 2073 6361 6e70 7920 6e6f 7420 696e 7374   scanpy not inst
+00023ae0: 616c 6c65 642e 2027 2920 2020 0a20 2020  alled. ')   .   
+00023af0: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+00023b00: 0a20 2020 2074 6172 6765 7420 3d20 272c  .    target = ',
+00023b10: 272e 6a6f 696e 2874 6172 6765 745f 6c73  '.join(target_ls
+00023b20: 7429 0a20 2020 2067 656e 6573 203d 206c  t).    genes = l
+00023b30: 6973 7428 6164 6174 612e 7661 722e 696e  ist(adata.var.in
+00023b40: 6465 782e 7661 6c75 6573 290a 2020 2020  dex.values).    
+00023b50: 6765 6e65 7320 3d20 6c69 7374 2873 6574  genes = list(set
+00023b60: 2867 656e 6573 2920 2d20 7365 7428 746f  (genes) - set(to
+00023b70: 5f65 7863 6c75 6465 2929 0a20 2020 206d  _exclude)).    m
+00023b80: 6b72 735f 616c 6c2c 206d 6b72 5f64 6963  krs_all, mkr_dic
+00023b90: 7420 3d20 6765 745f 6d61 726b 6572 735f  t = get_markers_
+00023ba0: 616c 6c33 286d 6b72 5f66 696c 652c 2074  all3(mkr_file, t
+00023bb0: 6172 6765 745f 6c73 742c 200a 2020 2020  arget_lst, .    
+00023bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023be0: 2020 2020 2070 6e73 6831 322c 2067 656e       pnsh12, gen
+00023bf0: 6573 2c20 6c65 7665 6c2c 200a 2020 2020  es, level, .    
+00023c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023c20: 2020 2020 2072 656d 5f63 6d6e 203d 2072       rem_cmn = r
+00023c30: 656d 5f63 6d6e 2c20 636f 6d62 5f6d 6b72  em_cmn, comb_mkr
+00023c40: 7320 3d20 636f 6d62 5f6d 6b72 7329 0a20  s = comb_mkrs). 
+00023c50: 2020 200a 2020 2020 7461 7267 6574 5f6c     .    target_l
+00023c60: 7374 3220 3d20 6c69 7374 286d 6b72 5f64  st2 = list(mkr_d
+00023c70: 6963 742e 6b65 7973 2829 290a 2020 2020  ict.keys()).    
+00023c80: 7920 3d20 6164 6174 612e 6f62 735b 7479  y = adata.obs[ty
+00023c90: 7065 5f6c 6576 656c 5d0a 2020 2020 6220  pe_level].    b 
+00023ca0: 3d20 7920 3d3d 2074 6172 6765 745f 6c73  = y == target_ls
+00023cb0: 7432 5b30 5d0a 2020 2020 666f 7220 7420  t2[0].    for t 
+00023cc0: 696e 2074 6172 6765 745f 6c73 7432 3a0a  in target_lst2:.
+00023cd0: 2020 2020 2020 2020 6220 3d20 6220 7c20          b = b | 
+00023ce0: 2879 203d 3d20 7429 0a20 2020 200a 2020  (y == t).    .  
+00023cf0: 2020 6e68 203d 2030 0a20 2020 2069 6620    nh = 0.    if 
+00023d00: 6e70 2e73 756d 2862 2920 3e20 303a 206e  np.sum(b) > 0: n
+00023d10: 6820 3d20 310a 2020 2020 666f 7220 7420  h = 1.    for t 
+00023d20: 696e 2074 6172 6765 745f 6c73 7432 3a0a  in target_lst2:.
+00023d30: 2020 2020 2020 2020 6274 203d 2079 203d          bt = y =
+00023d40: 3d20 740a 2020 2020 2020 2020 6966 206e  = t.        if n
+00023d50: 702e 7375 6d28 6274 2920 3e20 303a 0a20  p.sum(bt) > 0:. 
+00023d60: 2020 2020 2020 2020 2020 2062 203d 2062             b = b
+00023d70: 207c 2028 7920 3d3d 2074 290a 2020 2020   | (y == t).    
+00023d80: 2020 2020 2020 2020 6e68 202b 3d20 310a          nh += 1.
+00023d90: 0a20 2020 2061 6461 7461 5f74 203d 2061  .    adata_t = a
+00023da0: 6461 7461 5b62 2c20 6d6b 7273 5f61 6c6c  data[b, mkrs_all
+00023db0: 5d0a 2020 2020 5820 3d20 6164 6174 615f  ].    X = adata_
+00023dc0: 742e 746f 5f64 6628 290a 2020 2020 7920  t.to_df().    y 
+00023dd0: 3d20 6164 6174 615f 742e 6f62 735b 7479  = adata_t.obs[ty
+00023de0: 7065 5f6c 6576 656c 5d0a 0a20 2020 206d  pe_level]..    m
+00023df0: 6b72 735f 6469 6374 2c20 6466 2c20 7065  krs_dict, df, pe
+00023e00: 5f6c 7374 2c20 7065 785f 6c73 7420 3d20  _lst, pex_lst = 
+00023e10: 7570 6461 7465 5f6d 6172 6b65 7273 5f64  update_markers_d
+00023e20: 6963 7428 6d6b 7273 5f61 6c6c 2c20 6d6b  ict(mkrs_all, mk
+00023e30: 725f 6469 6374 2c20 582c 2079 2c20 7265  r_dict, X, y, re
+00023e40: 6e64 2c20 0a20 2020 2020 2020 2020 2020  nd, .           
+00023e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023e60: 2020 2020 2020 2020 2020 2020 2063 7574               cut
+00023e70: 6f66 6620 3d20 6375 746f 6666 2c20 4e70  off = cutoff, Np
+00023e80: 7420 3d20 4e70 742a 3229 0a20 2020 200a  t = Npt*2).    .
+00023e90: 2020 2020 6d6b 7273 5f64 6963 7420 3d20      mkrs_dict = 
+00023ea0: 7265 6d6f 7665 5f6d 6163 5f63 6f6d 6d6f  remove_mac_commo
+00023eb0: 6e5f 6d61 726b 6572 7328 6d6b 7273 5f64  n_markers(mkrs_d
+00023ec0: 6963 7429 0a20 2020 2069 6620 7265 6e64  ict).    if rend
+00023ed0: 2069 7320 6e6f 7420 4e6f 6e65 3a20 0a20   is not None: . 
+00023ee0: 2020 2020 2020 2061 6461 7461 5f74 2e6f         adata_t.o
+00023ef0: 6273 5b74 7970 655f 6c65 7665 6c5d 2e72  bs[type_level].r
+00023f00: 6570 6c61 6365 2872 656e 642c 2069 6e70  eplace(rend, inp
+00023f10: 6c61 6365 203d 2054 7275 6529 0a20 2020  lace = True).   
+00023f20: 2020 2020 200a 2020 2020 6d6b 616c 6c20       .    mkall 
+00023f30: 3d20 5b5d 0a20 2020 2066 6f72 206b 6579  = [].    for key
+00023f40: 2069 6e20 6d6b 7273 5f64 6963 742e 6b65   in mkrs_dict.ke
+00023f50: 7973 2829 3a0a 2020 2020 2020 2020 6d6b  ys():.        mk
+00023f60: 616c 6c20 3d20 6d6b 616c 6c20 2b20 6d6b  all = mkall + mk
+00023f70: 7273 5f64 6963 745b 6b65 795d 0a0a 2020  rs_dict[key]..  
+00023f80: 2020 2323 2047 6574 206e 756d 6265 7220    ## Get number 
+00023f90: 6f66 206d 6172 6b65 7220 6765 6e65 7320  of marker genes 
+00023fa0: 666f 7220 6561 6368 2063 656c 6c20 7479  for each cell ty
+00023fb0: 7065 0a20 2020 206d 6b61 6c6c 203d 206c  pe.    mkall = l
+00023fc0: 6973 7428 7365 7428 6d6b 616c 6c29 290a  ist(set(mkall)).
+00023fd0: 2020 2020 6e6d 6b72 203d 2064 6963 7428      nmkr = dict(
+00023fe0: 7a69 7028 6d6b 616c 6c2c 205b 305d 2a6c  zip(mkall, [0]*l
+00023ff0: 656e 286d 6b61 6c6c 2929 290a 2020 2020  en(mkall))).    
+00024000: 666f 7220 6b65 7920 696e 206d 6b72 735f  for key in mkrs_
+00024010: 6469 6374 2e6b 6579 7328 293a 0a20 2020  dict.keys():.   
+00024020: 2020 2020 2066 6f72 206d 2069 6e20 6d6b       for m in mk
+00024030: 7273 5f64 6963 745b 6b65 795d 3a0a 2020  rs_dict[key]:.  
+00024040: 2020 2020 2020 2020 2020 6e6d 6b72 5b6d            nmkr[m
+00024050: 5d20 2b3d 2031 0a20 2020 2020 2020 2020  ] += 1.         
+00024060: 2020 200a 2020 2020 2323 2072 656d 6f76     .    ## remov
+00024070: 6520 7468 6520 6d61 726b 6572 2067 656e  e the marker gen
+00024080: 6573 2061 7070 6572 696e 6720 696e 2033  es appering in 3
+00024090: 206f 7220 6d6f 7265 2063 656c 6c20 7479   or more cell ty
+000240a0: 7065 730a 2020 2020 746f 5f64 656c 203d  pes.    to_del =
+000240b0: 205b 5d0a 2020 2020 666f 7220 6b65 7920   [].    for key 
+000240c0: 696e 206e 6d6b 722e 6b65 7973 2829 3a0a  in nmkr.keys():.
+000240d0: 2020 2020 2020 2020 6966 206e 6d6b 725b          if nmkr[
+000240e0: 6b65 795d 203e 2032 3a20 746f 5f64 656c  key] > 2: to_del
+000240f0: 2e61 7070 656e 6428 6b65 7929 0a20 2020  .append(key).   
+00024100: 2020 2020 2020 2020 200a 2020 2020 6966           .    if
+00024110: 206c 656e 2874 6f5f 6465 6c29 203e 2030   len(to_del) > 0
+00024120: 3a0a 2020 2020 2020 2020 666f 7220 6d20  :.        for m 
+00024130: 696e 2074 6f5f 6465 6c3a 0a20 2020 2020  in to_del:.     
+00024140: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+00024150: 6e20 6d6b 7273 5f64 6963 742e 6b65 7973  n mkrs_dict.keys
+00024160: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00024170: 2020 2020 6966 206d 2069 6e20 6d6b 7273      if m in mkrs
+00024180: 5f64 6963 745b 6b65 795d 3a0a 2020 2020  _dict[key]:.    
+00024190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000241a0: 6d6b 7273 5f64 6963 745b 6b65 795d 2e72  mkrs_dict[key].r
+000241b0: 656d 6f76 6528 6d29 0a20 2020 2020 2020  emove(m).       
+000241c0: 2020 2020 200a 2020 2020 2323 2053 656c       .    ## Sel
+000241d0: 6563 7420 6d61 726b 6572 7320 7570 746f  ect markers upto
+000241e0: 204e 7074 0a20 2020 2066 6f72 206b 6579   Npt.    for key
+000241f0: 2069 6e20 6d6b 7273 5f64 6963 742e 6b65   in mkrs_dict.ke
+00024200: 7973 2829 3a0a 2020 2020 2020 2020 6d73  ys():.        ms
+00024210: 203d 206d 6b72 735f 6469 6374 5b6b 6579   = mkrs_dict[key
+00024220: 5d0a 2020 2020 2020 2020 6966 206c 656e  ].        if len
+00024230: 286d 7329 203e 204e 7074 3a0a 2020 2020  (ms) > Npt:.    
+00024240: 2020 2020 2020 2020 6d6b 7273 5f64 6963          mkrs_dic
+00024250: 745b 6b65 795d 203d 206d 735b 3a4e 7074  t[key] = ms[:Npt
+00024260: 5d0a 2020 2020 2020 2020 2020 2020 0a20  ].            . 
+00024270: 2020 2023 2320 5365 6c65 6374 206f 6e6c     ## Select onl
+00024280: 7920 7468 6520 6365 6c6c 2074 7970 6573  y the cell types
+00024290: 2074 6861 7420 6578 6973 7420 696e 2074   that exist in t
+000242a0: 6865 2064 6174 6120 616e 6420 7468 6520  he data and the 
+000242b0: 6e75 6d62 6572 206f 6620 6365 6c6c 7320  number of cells 
+000242c0: 3e3d 206d 696e 4e63 656c 6c73 0a20 2020  >= minNcells.   
+000242d0: 2070 735f 636e 7420 3d20 6164 6174 615f   ps_cnt = adata_
+000242e0: 742e 6f62 735b 7479 7065 5f6c 6576 656c  t.obs[type_level
+000242f0: 5d2e 7661 6c75 655f 636f 756e 7473 2829  ].value_counts()
+00024300: 0a20 2020 206c 7374 5f70 7261 6320 3d20  .    lst_prac = 
+00024310: 6c69 7374 2870 735f 636e 742e 696e 6465  list(ps_cnt.inde
+00024320: 782e 7661 6c75 6573 2920 2320 6c69 7374  x.values) # list
+00024330: 2861 6461 7461 5f74 2e6f 6273 5b74 7970  (adata_t.obs[typ
+00024340: 655f 6c65 7665 6c5d 2e75 6e69 7175 6528  e_level].unique(
+00024350: 2929 0a20 2020 206d 6b72 735f 6469 6374  )).    mkrs_dict
+00024360: 3220 3d20 7b7d 0a20 2020 2066 6f72 206d  2 = {}.    for m
+00024370: 2069 6e20 6d6b 7273 5f64 6963 742e 6b65   in mkrs_dict.ke
+00024380: 7973 2829 3a0a 2020 2020 2020 2020 6966  ys():.        if
+00024390: 206d 2069 6e20 6c73 745f 7072 6163 3a20   m in lst_prac: 
+000243a0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000243b0: 7073 5f63 6e74 5b6d 5d20 3e3d 206d 696e  ps_cnt[m] >= min
+000243c0: 4e63 656c 6c73 3a0a 2020 2020 2020 2020  Ncells:.        
+000243d0: 2020 2020 2020 2020 6d6b 7273 5f64 6963          mkrs_dic
+000243e0: 7432 5b6d 5d20 3d20 6d6b 7273 5f64 6963  t2[m] = mkrs_dic
+000243f0: 745b 6d5d 0a20 2020 206d 6b72 735f 6469  t[m].    mkrs_di
+00024400: 6374 203d 206d 6b72 735f 6469 6374 3220  ct = mkrs_dict2 
+00024410: 2020 2020 2020 200a 0a20 2020 2023 2320         ..    ## 
+00024420: 5265 6d6f 7665 2063 656c 6c20 7479 7065  Remove cell type
+00024430: 7320 666f 7220 7768 6963 6820 7468 6520  s for which the 
+00024440: 6e75 6d62 6572 206f 6620 6365 6c6c 7320  number of cells 
+00024450: 6265 6c6f 7720 6d69 6e4e 6365 6c6c 730a  below minNcells.
+00024460: 2020 2020 7461 7267 6574 5f6c 7374 3220      target_lst2 
+00024470: 3d20 6c69 7374 286d 6b72 735f 6469 6374  = list(mkrs_dict
+00024480: 2e6b 6579 7328 2929 0a20 2020 2079 203d  .keys()).    y =
+00024490: 2061 6461 7461 5f74 2e6f 6273 5b74 7970   adata_t.obs[typ
+000244a0: 655f 6c65 7665 6c5d 0a20 2020 2062 203d  e_level].    b =
+000244b0: 2079 203d 3d20 7461 7267 6574 5f6c 7374   y == target_lst
+000244c0: 325b 305d 0a20 2020 2066 6f72 2074 2069  2[0].    for t i
+000244d0: 6e20 7461 7267 6574 5f6c 7374 323a 0a20  n target_lst2:. 
+000244e0: 2020 2020 2020 2062 203d 2062 207c 2028         b = b | (
+000244f0: 7920 3d3d 2074 290a 2020 2020 0a20 2020  y == t).    .   
+00024500: 206e 6820 3d20 300a 2020 2020 6966 206e   nh = 0.    if n
+00024510: 702e 7375 6d28 6229 203e 2030 3a20 6e68  p.sum(b) > 0: nh
+00024520: 203d 2031 0a20 2020 2066 6f72 2074 2069   = 1.    for t i
+00024530: 6e20 7461 7267 6574 5f6c 7374 323a 0a20  n target_lst2:. 
+00024540: 2020 2020 2020 2062 7420 3d20 7920 3d3d         bt = y ==
+00024550: 2074 0a20 2020 2020 2020 2069 6620 6e70   t.        if np
+00024560: 2e73 756d 2862 7429 203e 2030 3a0a 2020  .sum(bt) > 0:.  
+00024570: 2020 2020 2020 2020 2020 6220 3d20 6220            b = b 
+00024580: 7c20 2879 203d 3d20 7429 0a20 2020 2020  | (y == t).     
+00024590: 2020 2020 2020 206e 6820 2b3d 2031 0a0a         nh += 1..
+000245a0: 2020 2020 6164 6174 615f 7420 3d20 6164      adata_t = ad
+000245b0: 6174 615f 745b 622c 203a 5d0a 2020 2020  ata_t[b, :].    
+000245c0: 6966 2072 656e 6420 6973 206e 6f74 204e  if rend is not N
+000245d0: 6f6e 653a 200a 2020 2020 2020 2020 6164  one: .        ad
+000245e0: 6174 615f 742e 6f62 735b 7479 7065 5f6c  ata_t.obs[type_l
+000245f0: 6576 656c 5d2e 7265 706c 6163 6528 7265  evel].replace(re
+00024600: 6e64 2c20 696e 706c 6163 6520 3d20 5472  nd, inplace = Tr
+00024610: 7565 290a 2020 2020 0a20 2020 206e 7720  ue).    .    nw 
+00024620: 3d20 300a 2020 2020 666f 7220 6b65 7920  = 0.    for key 
+00024630: 696e 206d 6b72 735f 6469 6374 2e6b 6579  in mkrs_dict.key
+00024640: 7328 293a 0a20 2020 2020 2020 206e 7720  s():.        nw 
+00024650: 2b3d 206c 656e 286d 6b72 735f 6469 6374  += len(mkrs_dict
+00024660: 5b6b 6579 5d29 0a20 2020 2020 2020 200a  [key]).        .
+00024670: 2020 2020 706c 742e 7263 2827 666f 6e74      plt.rc('font
+00024680: 272c 2073 697a 653d 3132 2920 2020 200a  ', size=12)    .
+00024690: 2020 2020 0a20 2020 2077 6974 6820 7761      .    with wa
+000246a0: 726e 696e 6773 2e63 6174 6368 5f77 6172  rnings.catch_war
+000246b0: 6e69 6e67 7328 293a 0a20 2020 2020 2020  nings():.       
+000246c0: 2077 6172 6e69 6e67 732e 7369 6d70 6c65   warnings.simple
+000246d0: 6669 6c74 6572 2822 6967 6e6f 7265 2229  filter("ignore")
+000246e0: 0a20 2020 2020 2020 2064 7020 3d20 7363  .        dp = sc
+000246f0: 2e70 6c2e 646f 7470 6c6f 7428 6164 6174  .pl.dotplot(adat
+00024700: 615f 742c 206d 6b72 735f 6469 6374 2c20  a_t, mkrs_dict, 
+00024710: 6772 6f75 7062 7920 3d20 7479 7065 5f6c  groupby = type_l
+00024720: 6576 656c 2c20 0a20 2020 2020 2020 2020  evel, .         
+00024730: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+00024740: 7465 676f 7269 6573 5f6f 7264 6572 203d  tegories_order =
+00024750: 206c 6973 7428 6d6b 7273 5f64 6963 742e   list(mkrs_dict.
+00024760: 6b65 7973 2829 292c 200a 2020 2020 2020  keys()), .      
+00024770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024780: 2023 6178 203d 2061 782c 2066 6967 7369   #ax = ax, figsi
+00024790: 7a65 203d 2028 6e77 2a30 2e33 362c 206e  ze = (nw*0.36, n
+000247a0: 682a 302e 3329 2c0a 2020 2020 2020 2020  h*0.3),.        
+000247b0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+000247c0: 6f67 203d 2054 7275 652c 2076 6172 5f67  og = True, var_g
+000247d0: 726f 7570 5f72 6f74 6174 696f 6e20 3d20  roup_rotation = 
+000247e0: 7667 5f72 6f74 2c20 7368 6f77 203d 2046  vg_rot, show = F
+000247f0: 616c 7365 2c20 0a20 2020 2020 2020 2020  alse, .         
+00024800: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00024810: 616e 6461 7264 5f73 6361 6c65 203d 2027  andard_scale = '
+00024820: 7661 7227 2c20 646f 745f 6d61 7820 3d20  var', dot_max = 
+00024830: 646f 745f 6d61 782c 2073 7761 705f 6178  dot_max, swap_ax
+00024840: 6573 203d 2073 7761 705f 6178 2029 200a  es = swap_ax ) .
+00024850: 0a20 2020 2061 7820 3d20 6470 5b27 6d61  .    ax = dp['ma
+00024860: 696e 706c 6f74 5f61 7827 5d0a 2020 2020  inplot_ax'].    
+00024870: 6966 2074 6974 6c65 2069 7320 6e6f 7420  if title is not 
+00024880: 4e6f 6e65 3a0a 2020 2020 2020 2020 6178  None:.        ax
+00024890: 2e73 6574 5f74 6974 6c65 2874 6974 6c65  .set_title(title
+000248a0: 2c20 7061 6420 3d20 3430 2c20 666f 6e74  , pad = 40, font
+000248b0: 7369 7a65 203d 2031 3629 200a 2020 2020  size = 16) .    
+000248c0: 6178 2e74 6963 6b5f 7061 7261 6d73 286c  ax.tick_params(l
+000248d0: 6162 656c 7369 7a65 3d31 3229 0a20 2020  abelsize=12).   
+000248e0: 2061 782e 7365 745f 796c 6162 656c 2827   ax.set_ylabel('
+000248f0: 416e 6e6f 7461 7465 6427 2c20 666f 6e74  Annotated', font
+00024900: 7369 7a65 203d 2031 3429 0a20 2020 200a  size = 14).    .
+00024910: 2020 2020 6966 2072 6574 5f70 653a 0a20      if ret_pe:. 
+00024920: 2020 2020 2020 2072 6574 7572 6e20 7065         return pe
+00024930: 5f6c 7374 2c20 7065 785f 6c73 740a 2020  _lst, pex_lst.  
+00024940: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00024950: 7265 7475 726e 0a20 2020 200a 0a64 6566  return.    ..def
+00024960: 2070 6c6f 745f 6d61 726b 6572 5f65 7870   plot_marker_exp
+00024970: 7265 7373 696f 6e5f 7072 6f66 696c 6528  ression_profile(
+00024980: 2064 665f 7072 6564 2c20 582c 206d 6b72   df_pred, X, mkr
+00024990: 5f66 696c 652c 2070 6e73 6831 3220 3d20  _file, pnsh12 = 
+000249a0: 2731 3031 3030 3027 2c20 0a20 2020 2020  '101000', .     
+000249b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000249c0: 2020 2020 2020 2020 2020 2020 2020 204e                 N
+000249d0: 7074 203d 2031 352c 2063 6f6d 625f 6d6b  pt = 15, comb_mk
+000249e0: 7273 203d 2046 616c 7365 2c20 6d69 6e4e  rs = False, minN
+000249f0: 6365 6c6c 7320 3d20 3230 2c20 0a20 2020  cells = 20, .   
+00024a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024a20: 2076 675f 726f 7420 3d20 3130 2c20 6375   vg_rot = 10, cu
+00024a30: 746f 6666 203d 2030 2c20 646f 745f 6d78  toff = 0, dot_mx
+00024a40: 203d 2030 2e35 2c0a 2020 2020 2020 2020   = 0.5,.        
+00024a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024a60: 2020 2020 2020 2020 2020 2020 7469 746c              titl
+00024a70: 655f 7375 6666 6978 203d 2027 2729 3a0a  e_suffix = ''):.
+00024a80: 0a20 2020 2041 4e4e 4441 5441 203d 2054  .    ANNDATA = T
+00024a90: 7275 650a 2020 2020 7472 793a 0a20 2020  rue.    try:.   
+00024aa0: 2020 2020 2066 726f 6d20 616e 6e64 6174       from anndat
+00024ab0: 6120 696d 706f 7274 2041 6e6e 4461 7461  a import AnnData
+00024ac0: 0a20 2020 2065 7863 6570 7420 496d 706f  .    except Impo
+00024ad0: 7274 4572 726f 723a 0a20 2020 2020 2020  rtError:.       
+00024ae0: 2041 4e4e 4441 5441 203d 2046 616c 7365   ANNDATA = False
+00024af0: 0a0a 2020 2020 6966 2028 6e6f 7420 414e  ..    if (not AN
+00024b00: 4e44 4154 4129 3a0a 2020 2020 2020 2020  NDATA):.        
+00024b10: 7072 696e 7428 2745 5252 4f52 3a20 616e  print('ERROR: an
+00024b20: 6e64 6174 6120 6e6f 7420 696e 7374 616c  ndata not instal
+00024b30: 6c65 642e 2027 2920 2020 0a20 2020 2020  led. ')   .     
+00024b40: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+00024b50: 2020 0a20 2020 2061 6461 7461 203d 2041    .    adata = A
+00024b60: 6e6e 4461 7461 2858 3d20 582c 206f 6273  nnData(X= X, obs
+00024b70: 203d 2064 665f 7072 6564 290a 2020 2020   = df_pred).    
+00024b80: 2320 6164 6174 6120 0a20 2020 2023 2064  # adata .    # d
+00024b90: 6f74 5f6d 7820 3d20 302e 350a 2020 2020  ot_mx = 0.5.    
+00024ba0: 2320 6375 746f 6666 203d 2030 0a20 2020  # cutoff = 0.   
+00024bb0: 2072 656d 5f63 6d6e 203d 2046 616c 7365   rem_cmn = False
+00024bc0: 0a20 2020 2073 7761 705f 6178 203d 2046  .    swap_ax = F
+00024bd0: 616c 7365 0a0a 2020 2020 4d61 6a5f 7479  alse..    Maj_ty
+00024be0: 7065 735f 7072 6564 203d 206c 6973 7428  pes_pred = list(
+00024bf0: 7365 7428 6466 5f70 7265 645b 2763 656c  set(df_pred['cel
+00024c00: 6c5f 7479 7065 5f6d 616a 6f72 275d 2929  l_type_major']))
+00024c10: 0a0a 2020 2020 6d6b 725f 6469 6374 2c20  ..    mkr_dict, 
+00024c20: 6d6b 725f 6469 6374 5f6e 6567 203d 205c  mkr_dict_neg = \
+00024c30: 0a20 2020 2020 2020 2067 6574 5f6d 6172  .        get_mar
+00024c40: 6b65 7273 5f6d 616a 6f72 5f74 7970 6528  kers_major_type(
+00024c50: 6d6b 725f 6669 6c65 2c20 7461 7267 6574  mkr_file, target
+00024c60: 5f63 656c 6c73 203d 205b 5d2c 2070 6e73  _cells = [], pns
+00024c70: 6831 3220 3d20 706e 7368 3132 2c0a 2020  h12 = pnsh12,.  
+00024c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024c90: 2020 2020 7265 6d5f 636f 6d6d 6f6e 203d      rem_common =
+00024ca0: 2046 616c 7365 2c20 7665 7262 6f73 6520   False, verbose 
+00024cb0: 3d20 4661 6c73 6529 0a0a 2020 2020 4d61  = False)..    Ma
+00024cc0: 6a5f 7479 7065 7320 3d20 6c69 7374 286d  j_types = list(m
+00024cd0: 6b72 5f64 6963 742e 6b65 7973 2829 290a  kr_dict.keys()).
+00024ce0: 2020 2020 4d61 6a5f 7479 7065 7320 3d20      Maj_types = 
+00024cf0: 6c69 7374 2873 6574 284d 616a 5f74 7970  list(set(Maj_typ
+00024d00: 6573 292e 696e 7465 7273 6563 7469 6f6e  es).intersection
+00024d10: 284d 616a 5f74 7970 6573 5f70 7265 6429  (Maj_types_pred)
+00024d20: 290a 0a20 2020 206d 6c73 745f 7320 3d20  )..    mlst_s = 
+00024d30: 5b5d 0a20 2020 206d 6c73 745f 6d20 3d20  [].    mlst_m = 
+00024d40: 5b5d 0a20 2020 2066 6f72 206d 2069 6e20  [].    for m in 
+00024d50: 4d61 6a5f 7479 7065 733a 0a0a 2020 2020  Maj_types:..    
+00024d60: 2020 2020 6d6b 725f 6469 6374 5f6d 696e      mkr_dict_min
+00024d70: 6f72 2c20 6d6b 725f 6469 6374 5f6e 6567  or, mkr_dict_neg
+00024d80: 203d 205c 0a20 2020 2020 2020 2020 2020   = \.           
+00024d90: 2067 6574 5f6d 6172 6b65 7273 5f63 656c   get_markers_cel
+00024da0: 6c5f 7479 7065 286d 6b72 5f66 696c 652c  l_type(mkr_file,
+00024db0: 2074 6172 6765 745f 6365 6c6c 7320 3d20   target_cells = 
+00024dc0: 5b6d 5d2c 2070 6e73 6831 3220 3d20 706e  [m], pnsh12 = pn
+00024dd0: 7368 3132 2c0a 2020 2020 2020 2020 2020  sh12,.          
+00024de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024df0: 7265 6d5f 636f 6d6d 6f6e 203d 2046 616c  rem_common = Fal
+00024e00: 7365 2c20 7665 7262 6f73 6520 3d20 4661  se, verbose = Fa
+00024e10: 6c73 6529 0a0a 2020 2020 2020 2020 4d69  lse)..        Mi
+00024e20: 6e5f 7479 7065 7320 3d20 6c69 7374 286d  n_types = list(m
+00024e30: 6b72 5f64 6963 745f 6d69 6e6f 722e 6b65  kr_dict_minor.ke
+00024e40: 7973 2829 290a 2020 2020 2020 2020 6d6b  ys()).        mk
+00024e50: 725f 6469 6374 2c20 6d6b 725f 6469 6374  r_dict, mkr_dict
+00024e60: 5f6e 6567 203d 205c 0a20 2020 2020 2020  _neg = \.       
+00024e70: 2020 2020 2067 6574 5f6d 6172 6b65 7273       get_markers
+00024e80: 5f6d 696e 6f72 5f74 7970 6532 286d 6b72  _minor_type2(mkr
+00024e90: 5f66 696c 652c 2074 6172 6765 745f 6365  _file, target_ce
+00024ea0: 6c6c 7320 3d20 4d69 6e5f 7479 7065 732c  lls = Min_types,
+00024eb0: 2070 6e73 6831 3220 3d20 706e 7368 3132   pnsh12 = pnsh12
+00024ec0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00024ed0: 2020 2020 2020 2020 7265 6d5f 636f 6d6d          rem_comm
+00024ee0: 6f6e 203d 2046 616c 7365 2c20 636f 6d62  on = False, comb
+00024ef0: 5f6d 6b72 7320 3d20 636f 6d62 5f6d 6b72  _mkrs = comb_mkr
+00024f00: 732c 2076 6572 626f 7365 203d 2046 616c  s, verbose = Fal
+00024f10: 7365 290a 2020 2020 2020 2020 6966 206c  se).        if l
+00024f20: 656e 286d 6b72 5f64 6963 742e 6b65 7973  en(mkr_dict.keys
+00024f30: 2829 2920 3e20 313a 0a20 2020 2020 2020  ()) > 1:.       
+00024f40: 2020 2020 2023 2070 7269 6e74 2827 2573       # print('%s
+00024f50: 3a20 2569 2720 2520 286d 2c20 6c65 6e28  : %i' % (m, len(
+00024f60: 6d6b 725f 6469 6374 2e6b 6579 7328 2929  mkr_dict.keys())
+00024f70: 2929 0a20 2020 2020 2020 2020 2020 206d  )).            m
+00024f80: 6c73 745f 6d2e 6170 7065 6e64 286d 290a  lst_m.append(m).
+00024f90: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00024fa0: 2020 2020 2020 2020 2020 2320 7072 696e            # prin
+00024fb0: 7428 2725 733a 2025 6927 2025 2028 6d2c  t('%s: %i' % (m,
+00024fc0: 206c 656e 286d 6b72 5f64 6963 742e 6b65   len(mkr_dict.ke
+00024fd0: 7973 2829 2929 290a 2020 2020 2020 2020  ys()))).        
+00024fe0: 2020 2020 6d6c 7374 5f73 2e61 7070 656e      mlst_s.appen
+00024ff0: 6428 6d29 0a0a 2020 2020 2320 6669 672c  d(m)..    # fig,
+00025000: 2061 7873 203d 2070 6c74 2e73 7562 706c   axs = plt.subpl
+00025010: 6f74 7328 6c65 6e28 6d6c 7374 5f73 292b  ots(len(mlst_s)+
+00025020: 6c65 6e28 6d6c 7374 5f6d 292c 2031 290a  len(mlst_m), 1).
+00025030: 2020 2020 6163 6e74 203d 2030 0a20 2020      acnt = 0.   
+00025040: 2023 2320 4d61 6a6f 7220 0a20 2020 2074   ## Major .    t
+00025050: 6172 6765 745f 6c73 7420 3d20 6d6c 7374  arget_lst = mlst
+00025060: 5f73 0a20 2020 2072 656e 6420 3d20 4e6f  _s.    rend = No
+00025070: 6e65 2023 2064 6963 7428 7a69 7028 6c73  ne # dict(zip(ls
+00025080: 742c 206c 7374 3229 290a 2020 2020 7479  t, lst2)).    ty
+00025090: 7065 5f65 7863 203d 205b 5d0a 2020 2020  pe_exc = [].    
+000250a0: 7479 7065 5f63 6f6c 203d 2027 6365 6c6c  type_col = 'cell
+000250b0: 5f74 7970 655f 6d61 6a6f 7227 0a20 2020  _type_major'.   
+000250c0: 206c 6576 656c 203d 2030 0a0a 2020 2020   level = 0..    
+000250d0: 6966 206c 656e 2874 6172 6765 745f 6c73  if len(target_ls
+000250e0: 7429 203e 2030 3a0a 2020 2020 2020 2020  t) > 0:.        
+000250f0: 7469 746c 6520 3d20 274d 6172 6b65 7220  title = 'Marker 
+00025100: 6578 7072 6573 7369 6f6e 206f 6620 2573  expression of %s
+00025110: 2720 2520 7461 7267 6574 5f6c 7374 5b30  ' % target_lst[0
+00025120: 5d0a 2020 2020 2020 2020 666f 7220 7420  ].        for t 
+00025130: 696e 2074 6172 6765 745f 6c73 745b 313a  in target_lst[1:
+00025140: 5d3a 2074 6974 6c65 203d 2074 6974 6c65  ]: title = title
+00025150: 202b 2027 2c25 7327 2025 2074 0a20 2020   + ',%s' % t.   
+00025160: 2020 2020 2069 6620 6c65 6e28 7469 746c       if len(titl
+00025170: 655f 7375 6666 6978 2920 3e20 303a 0a20  e_suffix) > 0:. 
+00025180: 2020 2020 2020 2020 2020 2074 6974 6c65             title
+00025190: 203d 2074 6974 6c65 202b 2027 2066 6f72   = title + ' for
+000251a0: 2025 7327 2025 2074 6974 6c65 5f73 7566   %s' % title_suf
+000251b0: 6669 780a 0a20 2020 2020 2020 2070 6c6f  fix..        plo
+000251c0: 745f 646f 7428 6164 6174 612c 2074 6172  t_dot(adata, tar
+000251d0: 6765 745f 6c73 742c 2074 7970 655f 636f  get_lst, type_co
+000251e0: 6c2c 206d 6b72 5f66 696c 652c 2074 6974  l, mkr_file, tit
+000251f0: 6c65 2c20 0a20 2020 2020 2020 2020 2020  le, .           
+00025200: 2020 2020 2020 2072 656e 6420 3d20 7265         rend = re
+00025210: 6e64 2c20 6c65 7665 6c20 3d20 6c65 7665  nd, level = leve
+00025220: 6c2c 2023 2061 7820 3d20 6178 735b 6163  l, # ax = axs[ac
+00025230: 6e74 5d2c 0a20 2020 2020 2020 2020 2020  nt],.           
+00025240: 2020 2020 2020 2063 7574 6f66 6620 3d20         cutoff = 
+00025250: 6375 746f 6666 2c20 706e 7368 3132 203d  cutoff, pnsh12 =
+00025260: 2070 6e73 6831 322c 2072 656d 5f63 6d6e   pnsh12, rem_cmn
+00025270: 203d 2072 656d 5f63 6d6e 2c20 646f 745f   = rem_cmn, dot_
+00025280: 6d61 7820 3d20 646f 745f 6d78 2c20 0a20  max = dot_mx, . 
+00025290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000252a0: 2073 7761 705f 6178 203d 2073 7761 705f   swap_ax = swap_
+000252b0: 6178 2c20 746f 5f65 7863 6c75 6465 203d  ax, to_exclude =
+000252c0: 2074 7970 655f 6578 632c 204e 7074 203d   type_exc, Npt =
+000252d0: 204e 7074 2c20 636f 6d62 5f6d 6b72 7320   Npt, comb_mkrs 
+000252e0: 3d20 636f 6d62 5f6d 6b72 732c 0a20 2020  = comb_mkrs,.   
+000252f0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+00025300: 675f 726f 7420 3d20 7667 5f72 6f74 2c20  g_rot = vg_rot, 
+00025310: 6d69 6e4e 6365 6c6c 7320 3d20 6d69 6e4e  minNcells = minN
+00025320: 6365 6c6c 7329 0a20 2020 2020 2020 2061  cells).        a
+00025330: 636e 7420 2b3d 2031 0a20 2020 2020 2020  cnt += 1.       
+00025340: 200a 2020 2020 2323 2053 7562 7365 7420   .    ## Subset 
+00025350: 0a20 2020 206c 6576 656c 203d 2031 0a20  .    level = 1. 
+00025360: 2020 2074 7970 655f 636f 6c20 3d20 2763     type_col = 'c
+00025370: 656c 6c5f 7479 7065 5f73 7562 7365 7427  ell_type_subset'
+00025380: 0a0a 2020 2020 666f 7220 6d20 696e 206d  ..    for m in m
+00025390: 6c73 745f 6d3a 0a20 2020 2020 2020 206d  lst_m:.        m
+000253a0: 6b72 5f64 6963 745f 6d69 6e6f 722c 206d  kr_dict_minor, m
+000253b0: 6b72 5f64 6963 745f 6e65 6720 3d20 5c0a  kr_dict_neg = \.
+000253c0: 2020 2020 2020 2020 2020 2020 6765 745f              get_
+000253d0: 6d61 726b 6572 735f 6365 6c6c 5f74 7970  markers_cell_typ
+000253e0: 6528 6d6b 725f 6669 6c65 2c20 7461 7267  e(mkr_file, targ
+000253f0: 6574 5f63 656c 6c73 203d 205b 6d5d 2c20  et_cells = [m], 
+00025400: 706e 7368 3132 203d 2070 6e73 6831 322c  pnsh12 = pnsh12,
+00025410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025420: 2020 2020 2020 2020 2020 2072 656d 5f63             rem_c
+00025430: 6f6d 6d6f 6e20 3d20 4661 6c73 652c 2076  ommon = False, v
+00025440: 6572 626f 7365 203d 2046 616c 7365 290a  erbose = False).
+00025450: 2020 2020 2020 2020 6966 206d 5b30 5d20          if m[0] 
+00025460: 3d3d 2027 5427 3a0a 2020 2020 2020 2020  == 'T':.        
+00025470: 2020 2020 7461 7267 6574 5f6c 7374 203d      target_lst =
+00025480: 206c 6973 7428 6d6b 725f 6469 6374 5f6d   list(mkr_dict_m
+00025490: 696e 6f72 2e6b 6579 7328 2929 0a20 2020  inor.keys()).   
+000254a0: 2020 2020 2020 2020 2074 3120 3d20 5b5d           t1 = []
+000254b0: 0a20 2020 2020 2020 2020 2020 2074 3220  .            t2 
+000254c0: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+000254d0: 2066 6f72 2074 2069 6e20 7461 7267 6574   for t in target
+000254e0: 5f6c 7374 3a0a 2020 2020 2020 2020 2020  _lst:.          
+000254f0: 2020 2020 2020 6966 2028 274e 4b27 2069        if ('NK' i
+00025500: 6e20 742e 7570 7065 7228 2929 207c 2028  n t.upper()) | (
+00025510: 2749 4c43 2720 696e 2074 2e75 7070 6572  'ILC' in t.upper
+00025520: 2829 293a 0a20 2020 2020 2020 2020 2020  ()):.           
+00025530: 2020 2020 2020 2020 2074 322e 6170 7065           t2.appe
+00025540: 6e64 2874 290a 2020 2020 2020 2020 2020  nd(t).          
+00025550: 2020 2020 2020 656c 6966 2028 2743 4434        elif ('CD4
+00025560: 2720 696e 2074 2e75 7070 6572 2829 2920  ' in t.upper()) 
+00025570: 7c20 2827 4344 3827 2069 6e20 742e 7570  | ('CD8' in t.up
+00025580: 7065 7228 2920 293a 0a20 2020 2020 2020  per() ):.       
+00025590: 2020 2020 2020 2020 2020 2020 2074 312e               t1.
+000255a0: 6170 7065 6e64 2874 290a 0a20 2020 2020  append(t)..     
+000255b0: 2020 2020 2020 2069 6620 6c65 6e28 7431         if len(t1
+000255c0: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
+000255d0: 2020 2020 2020 2074 6172 6765 745f 6c73         target_ls
+000255e0: 7420 3d20 7431 0a20 2020 2020 2020 2020  t = t1.         
+000255f0: 2020 2020 2020 2069 6620 6c65 6e28 7461         if len(ta
+00025600: 7267 6574 5f6c 7374 2920 3e20 303a 0a20  rget_lst) > 0:. 
+00025610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025620: 2020 2074 6974 6c65 203d 2027 4d61 726b     title = 'Mark
+00025630: 6572 2065 7870 7265 7373 696f 6e20 6f66  er expression of
+00025640: 2025 7327 2025 2074 6172 6765 745f 6c73   %s' % target_ls
+00025650: 745b 305d 0a20 2020 2020 2020 2020 2020  t[0].           
+00025660: 2020 2020 2020 2020 2066 6f72 2074 2069           for t i
+00025670: 6e20 7461 7267 6574 5f6c 7374 5b31 3a5d  n target_lst[1:]
+00025680: 3a20 7469 746c 6520 3d20 7469 746c 6520  : title = title 
+00025690: 2b20 272c 2573 2720 2520 740a 2020 2020  + ',%s' % t.    
 000256a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000256b0: 2020 2020 2020 2020 2020 6375 746f 6666            cutoff
-000256c0: 203d 2063 7574 6f66 662c 2070 6e73 6831   = cutoff, pnsh1
-000256d0: 3220 3d20 706e 7368 3132 2c20 7265 6d5f  2 = pnsh12, rem_
-000256e0: 636d 6e20 3d20 7265 6d5f 636d 6e2c 2064  cmn = rem_cmn, d
-000256f0: 6f74 5f6d 6178 203d 2064 6f74 5f6d 782c  ot_max = dot_mx,
-00025700: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00025710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025720: 7377 6170 5f61 7820 3d20 7377 6170 5f61  swap_ax = swap_a
-00025730: 782c 2074 6f5f 6578 636c 7564 6520 3d20  x, to_exclude = 
-00025740: 7479 7065 5f65 7863 2c20 4e70 7420 3d20  type_exc, Npt = 
-00025750: 4e70 742c 200a 2020 2020 2020 2020 2020  Npt, .          
+000256b0: 6966 206c 656e 2874 6974 6c65 5f73 7566  if len(title_suf
+000256c0: 6669 7829 203e 2030 3a0a 2020 2020 2020  fix) > 0:.      
+000256d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000256e0: 2020 7469 746c 6520 3d20 7469 746c 6520    title = title 
+000256f0: 2b20 2720 666f 7220 2573 2720 2520 7469  + ' for %s' % ti
+00025700: 746c 655f 7375 6666 6978 0a20 2020 2020  tle_suffix.     
+00025710: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00025720: 6c6f 745f 646f 7428 6164 6174 612c 2074  lot_dot(adata, t
+00025730: 6172 6765 745f 6c73 742c 2074 7970 655f  arget_lst, type_
+00025740: 636f 6c2c 206d 6b72 5f66 696c 652c 2074  col, mkr_file, t
+00025750: 6974 6c65 2c20 0a20 2020 2020 2020 2020  itle, .         
 00025760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025770: 2020 2020 636f 6d62 5f6d 6b72 7320 3d20      comb_mkrs = 
-00025780: 636f 6d62 5f6d 6b72 732c 2076 675f 726f  comb_mkrs, vg_ro
-00025790: 7420 3d20 7667 5f72 6f74 2c20 6d69 6e4e  t = vg_rot, minN
-000257a0: 6365 6c6c 7320 3d20 6d69 6e4e 6365 6c6c  cells = minNcell
-000257b0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-000257c0: 2020 2020 2020 2061 636e 7420 2b3d 2031         acnt += 1
-000257d0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000257e0: 6c65 6e28 7432 2920 3e20 303a 0a20 2020  len(t2) > 0:.   
-000257f0: 2020 2020 2020 2020 2020 2020 2074 6172               tar
-00025800: 6765 745f 6c73 7420 3d20 7432 0a20 2020  get_lst = t2.   
-00025810: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00025820: 6c65 6e28 7461 7267 6574 5f6c 7374 2920  len(target_lst) 
-00025830: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-00025840: 2020 2020 2020 2020 2074 6974 6c65 203d           title =
-00025850: 2027 4d61 726b 6572 2065 7870 7265 7373   'Marker express
-00025860: 696f 6e20 6f66 2025 7327 2025 2074 6172  ion of %s' % tar
-00025870: 6765 745f 6c73 745b 305d 0a20 2020 2020  get_lst[0].     
-00025880: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00025890: 6f72 2074 2069 6e20 7461 7267 6574 5f6c  or t in target_l
-000258a0: 7374 5b31 3a5d 3a20 7469 746c 6520 3d20  st[1:]: title = 
-000258b0: 7469 746c 6520 2b20 272c 2573 2720 2520  title + ',%s' % 
-000258c0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-000258d0: 2020 2020 2020 6966 206c 656e 2874 6974        if len(tit
-000258e0: 6c65 5f73 7566 6669 7829 203e 2030 3a0a  le_suffix) > 0:.
-000258f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025900: 2020 2020 2020 2020 7469 746c 6520 3d20          title = 
-00025910: 7469 746c 6520 2b20 2720 666f 7220 2573  title + ' for %s
-00025920: 2720 2520 7469 746c 655f 7375 6666 6978  ' % title_suffix
-00025930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025940: 2020 2020 2070 6c6f 745f 646f 7428 6164       plot_dot(ad
-00025950: 6174 612c 2074 6172 6765 745f 6c73 742c  ata, target_lst,
-00025960: 2074 7970 655f 636f 6c2c 206d 6b72 5f66   type_col, mkr_f
-00025970: 696c 652c 2074 6974 6c65 2c20 0a20 2020  ile, title, .   
-00025980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025990: 2020 2020 2020 2020 2020 2072 656e 6420             rend 
-000259a0: 3d20 7265 6e64 2c20 6c65 7665 6c20 3d20  = rend, level = 
-000259b0: 6c65 7665 6c2c 2023 2061 7820 3d20 6178  level, # ax = ax
-000259c0: 735b 6163 6e74 5d2c 0a20 2020 2020 2020  s[acnt],.       
-000259d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000259e0: 2020 2020 2020 2063 7574 6f66 6620 3d20         cutoff = 
-000259f0: 6375 746f 6666 2c20 706e 7368 3132 203d  cutoff, pnsh12 =
-00025a00: 2070 6e73 6831 322c 2072 656d 5f63 6d6e   pnsh12, rem_cmn
-00025a10: 203d 2072 656d 5f63 6d6e 2c20 646f 745f   = rem_cmn, dot_
-00025a20: 6d61 7820 3d20 646f 745f 6d78 2c20 0a20  max = dot_mx, . 
-00025a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025a40: 2020 2020 2020 2020 2020 2020 2073 7761               swa
-00025a50: 705f 6178 203d 2073 7761 705f 6178 2c20  p_ax = swap_ax, 
-00025a60: 746f 5f65 7863 6c75 6465 203d 2074 7970  to_exclude = typ
-00025a70: 655f 6578 632c 204e 7074 203d 204e 7074  e_exc, Npt = Npt
-00025a80: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+00025770: 2020 2020 2072 656e 6420 3d20 7265 6e64       rend = rend
+00025780: 2c20 6c65 7665 6c20 3d20 6c65 7665 6c2c  , level = level,
+00025790: 2023 2061 7820 3d20 6178 735b 6163 6e74   # ax = axs[acnt
+000257a0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000257b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000257c0: 2063 7574 6f66 6620 3d20 6375 746f 6666   cutoff = cutoff
+000257d0: 2c20 706e 7368 3132 203d 2070 6e73 6831  , pnsh12 = pnsh1
+000257e0: 322c 2072 656d 5f63 6d6e 203d 2072 656d  2, rem_cmn = rem
+000257f0: 5f63 6d6e 2c20 646f 745f 6d61 7820 3d20  _cmn, dot_max = 
+00025800: 646f 745f 6d78 2c20 0a20 2020 2020 2020  dot_mx, .       
+00025810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025820: 2020 2020 2020 2073 7761 705f 6178 203d         swap_ax =
+00025830: 2073 7761 705f 6178 2c20 746f 5f65 7863   swap_ax, to_exc
+00025840: 6c75 6465 203d 2074 7970 655f 6578 632c  lude = type_exc,
+00025850: 204e 7074 203d 204e 7074 2c20 0a20 2020   Npt = Npt, .   
+00025860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025870: 2020 2020 2020 2020 2020 2063 6f6d 625f             comb_
+00025880: 6d6b 7273 203d 2063 6f6d 625f 6d6b 7273  mkrs = comb_mkrs
+00025890: 2c20 7667 5f72 6f74 203d 2076 675f 726f  , vg_rot = vg_ro
+000258a0: 742c 206d 696e 4e63 656c 6c73 203d 206d  t, minNcells = m
+000258b0: 696e 4e63 656c 6c73 290a 2020 2020 2020  inNcells).      
+000258c0: 2020 2020 2020 2020 2020 2020 2020 6163                ac
+000258d0: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
+000258e0: 2020 2020 6966 206c 656e 2874 3229 203e      if len(t2) >
+000258f0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00025900: 2020 2020 7461 7267 6574 5f6c 7374 203d      target_lst =
+00025910: 2074 320a 2020 2020 2020 2020 2020 2020   t2.            
+00025920: 2020 2020 6966 206c 656e 2874 6172 6765      if len(targe
+00025930: 745f 6c73 7429 203e 2030 3a0a 2020 2020  t_lst) > 0:.    
+00025940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025950: 7469 746c 6520 3d20 274d 6172 6b65 7220  title = 'Marker 
+00025960: 6578 7072 6573 7369 6f6e 206f 6620 2573  expression of %s
+00025970: 2720 2520 7461 7267 6574 5f6c 7374 5b30  ' % target_lst[0
+00025980: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00025990: 2020 2020 2020 666f 7220 7420 696e 2074        for t in t
+000259a0: 6172 6765 745f 6c73 745b 313a 5d3a 2074  arget_lst[1:]: t
+000259b0: 6974 6c65 203d 2074 6974 6c65 202b 2027  itle = title + '
+000259c0: 2c25 7327 2025 2074 0a20 2020 2020 2020  ,%s' % t.       
+000259d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000259e0: 6c65 6e28 7469 746c 655f 7375 6666 6978  len(title_suffix
+000259f0: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
+00025a00: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00025a10: 6974 6c65 203d 2074 6974 6c65 202b 2027  itle = title + '
+00025a20: 2066 6f72 2025 7327 2025 2074 6974 6c65   for %s' % title
+00025a30: 5f73 7566 6669 780a 2020 2020 2020 2020  _suffix.        
+00025a40: 2020 2020 2020 2020 2020 2020 706c 6f74              plot
+00025a50: 5f64 6f74 2861 6461 7461 2c20 7461 7267  _dot(adata, targ
+00025a60: 6574 5f6c 7374 2c20 7479 7065 5f63 6f6c  et_lst, type_col
+00025a70: 2c20 6d6b 725f 6669 6c65 2c20 7469 746c  , mkr_file, titl
+00025a80: 652c 200a 2020 2020 2020 2020 2020 2020  e, .            
 00025a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025aa0: 2020 636f 6d62 5f6d 6b72 7320 3d20 636f    comb_mkrs = co
-00025ab0: 6d62 5f6d 6b72 732c 2076 675f 726f 7420  mb_mkrs, vg_rot 
-00025ac0: 3d20 7667 5f72 6f74 2c20 6d69 6e4e 6365  = vg_rot, minNce
-00025ad0: 6c6c 7320 3d20 6d69 6e4e 6365 6c6c 7329  lls = minNcells)
-00025ae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025af0: 2020 2020 2061 636e 7420 2b3d 2031 0a0a       acnt += 1..
-00025b00: 2020 2020 666f 7220 6d20 696e 206d 6c73      for m in mls
-00025b10: 745f 6d3a 0a20 2020 2020 2020 206d 6b72  t_m:.        mkr
-00025b20: 5f64 6963 745f 6d69 6e6f 722c 206d 6b72  _dict_minor, mkr
-00025b30: 5f64 6963 745f 6e65 6720 3d20 5c0a 2020  _dict_neg = \.  
-00025b40: 2020 2020 2020 2020 2020 6765 745f 6d61            get_ma
-00025b50: 726b 6572 735f 6365 6c6c 5f74 7970 6528  rkers_cell_type(
-00025b60: 6d6b 725f 6669 6c65 2c20 7461 7267 6574  mkr_file, target
-00025b70: 5f63 656c 6c73 203d 205b 6d5d 2c20 706e  _cells = [m], pn
-00025b80: 7368 3132 203d 2070 6e73 6831 322c 0a20  sh12 = pnsh12,. 
+00025aa0: 2020 7265 6e64 203d 2072 656e 642c 206c    rend = rend, l
+00025ab0: 6576 656c 203d 206c 6576 656c 2c20 2320  evel = level, # 
+00025ac0: 6178 203d 2061 7873 5b61 636e 745d 2c0a  ax = axs[acnt],.
+00025ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025ae0: 2020 2020 2020 2020 2020 2020 2020 6375                cu
+00025af0: 746f 6666 203d 2063 7574 6f66 662c 2070  toff = cutoff, p
+00025b00: 6e73 6831 3220 3d20 706e 7368 3132 2c20  nsh12 = pnsh12, 
+00025b10: 7265 6d5f 636d 6e20 3d20 7265 6d5f 636d  rem_cmn = rem_cm
+00025b20: 6e2c 2064 6f74 5f6d 6178 203d 2064 6f74  n, dot_max = dot
+00025b30: 5f6d 782c 200a 2020 2020 2020 2020 2020  _mx, .          
+00025b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025b50: 2020 2020 7377 6170 5f61 7820 3d20 7377      swap_ax = sw
+00025b60: 6170 5f61 782c 2074 6f5f 6578 636c 7564  ap_ax, to_exclud
+00025b70: 6520 3d20 7479 7065 5f65 7863 2c20 4e70  e = type_exc, Np
+00025b80: 7420 3d20 4e70 742c 200a 2020 2020 2020  t = Npt, .      
 00025b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025ba0: 2020 2020 2020 2020 2072 656d 5f63 6f6d           rem_com
-00025bb0: 6d6f 6e20 3d20 4661 6c73 652c 2076 6572  mon = False, ver
-00025bc0: 626f 7365 203d 2046 616c 7365 290a 2020  bose = False).  
-00025bd0: 2020 2020 2020 6966 206d 5b30 5d20 213d        if m[0] !=
-00025be0: 2027 5427 3a0a 2020 2020 2020 2020 2020   'T':.          
-00025bf0: 2020 7461 7267 6574 5f6c 7374 203d 206c    target_lst = l
-00025c00: 6973 7428 6d6b 725f 6469 6374 5f6d 696e  ist(mkr_dict_min
-00025c10: 6f72 2e6b 6579 7328 2929 0a20 2020 2020  or.keys()).     
-00025c20: 2020 2020 2020 2069 6620 6c65 6e28 7461         if len(ta
-00025c30: 7267 6574 5f6c 7374 2920 3e20 303a 0a20  rget_lst) > 0:. 
-00025c40: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00025c50: 6974 6c65 203d 2027 4d61 726b 6572 2065  itle = 'Marker e
-00025c60: 7870 7265 7373 696f 6e20 6f66 2025 7327  xpression of %s'
-00025c70: 2025 2074 6172 6765 745f 6c73 745b 305d   % target_lst[0]
-00025c80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025c90: 2066 6f72 2074 2069 6e20 7461 7267 6574   for t in target
-00025ca0: 5f6c 7374 5b31 3a5d 3a20 7469 746c 6520  _lst[1:]: title 
-00025cb0: 3d20 7469 746c 6520 2b20 272c 2573 2720  = title + ',%s' 
-00025cc0: 2520 740a 2020 2020 2020 2020 2020 2020  % t.            
-00025cd0: 2020 2020 6966 206c 656e 2874 6974 6c65      if len(title
-00025ce0: 5f73 7566 6669 7829 203e 2030 3a0a 2020  _suffix) > 0:.  
-00025cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025d00: 2020 7469 746c 6520 3d20 7469 746c 6520    title = title 
-00025d10: 2b20 2720 666f 7220 2573 2720 2520 7469  + ' for %s' % ti
-00025d20: 746c 655f 7375 6666 6978 0a20 2020 2020  tle_suffix.     
-00025d30: 2020 2020 2020 2020 2020 2070 6c6f 745f             plot_
-00025d40: 646f 7428 6164 6174 612c 2074 6172 6765  dot(adata, targe
-00025d50: 745f 6c73 742c 2074 7970 655f 636f 6c2c  t_lst, type_col,
-00025d60: 206d 6b72 5f66 696c 652c 2074 6974 6c65   mkr_file, title
-00025d70: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-00025d80: 2020 2020 2020 2020 2020 2020 2072 656e               ren
-00025d90: 6420 3d20 7265 6e64 2c20 6c65 7665 6c20  d = rend, level 
-00025da0: 3d20 6c65 7665 6c2c 2023 2061 7820 3d20  = level, # ax = 
-00025db0: 6178 735b 6163 6e74 5d2c 0a20 2020 2020  axs[acnt],.     
-00025dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025dd0: 2020 2020 2063 7574 6f66 6620 3d20 6375       cutoff = cu
-00025de0: 746f 6666 2c20 706e 7368 3132 203d 2070  toff, pnsh12 = p
-00025df0: 6e73 6831 322c 2072 656d 5f63 6d6e 203d  nsh12, rem_cmn =
-00025e00: 2072 656d 5f63 6d6e 2c20 646f 745f 6d61   rem_cmn, dot_ma
-00025e10: 7820 3d20 646f 745f 6d78 2c20 0a20 2020  x = dot_mx, .   
-00025e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025e30: 2020 2020 2020 2073 7761 705f 6178 203d         swap_ax =
-00025e40: 2073 7761 705f 6178 2c20 746f 5f65 7863   swap_ax, to_exc
-00025e50: 6c75 6465 203d 2074 7970 655f 6578 632c  lude = type_exc,
-00025e60: 204e 7074 203d 204e 7074 2c20 0a20 2020   Npt = Npt, .   
-00025e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025e80: 2020 2020 2020 2020 636f 6d62 5f6d 6b72          comb_mkr
-00025e90: 7320 3d20 636f 6d62 5f6d 6b72 732c 2076  s = comb_mkrs, v
-00025ea0: 675f 726f 7420 3d20 7667 5f72 6f74 2c20  g_rot = vg_rot, 
-00025eb0: 6d69 6e4e 6365 6c6c 7320 3d20 6d69 6e4e  minNcells = minN
-00025ec0: 6365 6c6c 7329 0a20 2020 2020 2020 2020  cells).         
-00025ed0: 2020 2020 2020 2061 636e 7420 2b3d 2031         acnt += 1
-00025ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025f50: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00025f60: 2020 2020 2020 2020 200a 6465 6620 6765           .def ge
-00025f70: 745f 7065 7266 5f65 7874 2820 6466 5f70  t_perf_ext( df_p
-00025f80: 7265 642c 2063 656c 6c5f 7479 7065 735f  red, cell_types_
-00025f90: 6e6f 745f 636f 6e73 6964 6572 2c20 7472  not_consider, tr
-00025fa0: 7574 6820 3d20 2763 656c 6c5f 7479 7065  uth = 'cell_type
-00025fb0: 5f74 7275 6527 2029 3a0a 2020 2020 0a20  _true' ):.    . 
-00025fc0: 2020 2063 656c 6c5f 7479 7065 203d 2064     cell_type = d
-00025fd0: 665f 7072 6564 5b74 7275 7468 5d0a 2020  f_pred[truth].  
-00025fe0: 2020 6263 203d 206e 702e 6675 6c6c 286c    bc = np.full(l
-00025ff0: 656e 2863 656c 6c5f 7479 7065 292c 2046  en(cell_type), F
-00026000: 616c 7365 290a 2020 2020 666f 7220 6374  alse).    for ct
-00026010: 2069 6e20 6365 6c6c 5f74 7970 6573 5f6e   in cell_types_n
-00026020: 6f74 5f63 6f6e 7369 6465 723a 0a20 2020  ot_consider:.   
-00026030: 2020 2020 2062 6320 3d20 6263 207c 2028       bc = bc | (
-00026040: 6365 6c6c 5f74 7970 6520 3d3d 2063 7429  cell_type == ct)
-00026050: 0a20 2020 2064 665f 7072 6564 203d 2064  .    df_pred = d
-00026060: 665f 7072 6564 2e6c 6f63 5b7e 6263 2c3a  f_pred.loc[~bc,:
-00026070: 5d0a 2020 2020 2020 2020 0a20 2020 2063  ].        .    c
-00026080: 6f6c 7320 3d20 6c69 7374 2864 665f 7072  ols = list(df_pr
-00026090: 6564 2e63 6f6c 756d 6e73 2e76 616c 7565  ed.columns.value
-000260a0: 7329 0a20 2020 2069 6620 2774 6172 6765  s).    if 'targe
-000260b0: 745f 6365 6c6c 5f74 7970 6573 2720 696e  t_cell_types' in
-000260c0: 2063 6f6c 733a 0a20 2020 2020 2020 2063   cols:.        c
-000260d0: 6f6c 732e 7265 6d6f 7665 2827 7461 7267  ols.remove('targ
-000260e0: 6574 5f63 656c 6c5f 7479 7065 7327 290a  et_cell_types').
-000260f0: 2020 2020 6966 2074 7275 7468 2069 6e20      if truth in 
-00026100: 636f 6c73 3a0a 2020 2020 2020 2020 636f  cols:.        co
-00026110: 6c73 2e72 656d 6f76 6528 7472 7574 6829  ls.remove(truth)
-00026120: 0a20 2020 200a 2020 2020 6466 5f70 6572  .    .    df_per
-00026130: 6620 3d20 7064 2e44 6174 6146 7261 6d65  f = pd.DataFrame
-00026140: 2869 6e64 6578 203d 205b 2743 272c 2027  (index = ['C', '
-00026150: 4355 4127 2c20 2745 5541 272c 2027 4541  CUA', 'EUA', 'EA
-00026160: 272c 2027 4527 5d29 0a20 2020 2074 6374  ', 'E']).    tct
-00026170: 7320 3d20 6c69 7374 2873 6574 2864 665f  s = list(set(df_
-00026180: 7072 6564 5b27 7461 7267 6574 5f63 656c  pred['target_cel
-00026190: 6c5f 7479 7065 7327 5d29 290a 2020 2020  l_types'])).    
-000261a0: 0a20 2020 2062 7420 3d20 6e70 2e66 756c  .    bt = np.ful
-000261b0: 6c28 2064 665f 7072 6564 2e73 6861 7065  l( df_pred.shape
-000261c0: 5b30 5d2c 2046 616c 7365 2029 0a20 2020  [0], False ).   
-000261d0: 2066 6f72 206b 2c20 7463 7420 696e 2065   for k, tct in e
-000261e0: 6e75 6d65 7261 7465 2874 6374 7329 3a0a  numerate(tcts):.
-000261f0: 2020 2020 2020 2020 6231 203d 2064 665f          b1 = df_
-00026200: 7072 6564 5b27 7461 7267 6574 5f63 656c  pred['target_cel
-00026210: 6c5f 7479 7065 7327 5d20 3d3d 2074 6374  l_types'] == tct
-00026220: 0a20 2020 2020 2020 2074 6374 5f6c 7374  .        tct_lst
-00026230: 203d 2074 6374 2e73 706c 6974 2827 2c27   = tct.split(','
-00026240: 290a 2020 2020 2020 2020 666f 7220 6374  ).        for ct
-00026250: 2069 6e20 7463 745f 6c73 743a 0a20 2020   in tct_lst:.   
-00026260: 2020 2020 2020 2020 2062 3220 3d20 6466           b2 = df
-00026270: 5f70 7265 645b 7472 7574 685d 203d 3d20  _pred[truth] == 
-00026280: 6374 0a20 2020 2020 2020 2020 2020 2062  ct.            b
-00026290: 7420 3d20 6274 207c 2028 6231 2662 3229  t = bt | (b1&b2)
-000262a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000262b0: 200a 2020 2020 627a 203d 2064 665f 7072   .    bz = df_pr
-000262c0: 6564 5b74 7275 7468 5d20 213d 2027 556e  ed[truth] != 'Un
-000262d0: 6b6e 6f77 6e27 0a20 2020 2064 665f 7065  known'.    df_pe
-000262e0: 7266 5b27 6964 6561 6c27 5d20 3d20 5b6e  rf['ideal'] = [n
-000262f0: 702e 7375 6d28 627a 2662 7429 2f6e 702e  p.sum(bz&bt)/np.
-00026300: 7375 6d28 627a 292c 205c 0a20 2020 2020  sum(bz), \.     
-00026310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026320: 2020 206e 702e 7375 6d28 627a 2628 7e62     np.sum(bz&(~b
-00026330: 7429 292f 6e70 2e73 756d 2862 7a29 2c20  t))/np.sum(bz), 
-00026340: 302c 302c 305d 0a20 2020 2020 2020 200a  0,0,0].        .
-00026350: 2020 2020 666f 7220 6320 696e 2063 6f6c      for c in col
-00026360: 733a 0a20 2020 2020 2020 2074 636f 6c20  s:.        tcol 
-00026370: 3d20 6320 2020 2020 2020 200a 2020 2020  = c        .    
-00026380: 2020 2020 6261 203d 206e 702e 6675 6c6c      ba = np.full
-00026390: 2820 6466 5f70 7265 642e 7368 6170 655b  ( df_pred.shape[
-000263a0: 305d 2c20 4661 6c73 6520 290a 2020 2020  0], False ).    
-000263b0: 2020 2020 666f 7220 6b2c 2074 6374 2069      for k, tct i
-000263c0: 6e20 656e 756d 6572 6174 6528 7463 7473  n enumerate(tcts
-000263d0: 293a 0a20 2020 2020 2020 2020 2020 2062  ):.            b
-000263e0: 3120 3d20 6466 5f70 7265 645b 2774 6172  1 = df_pred['tar
-000263f0: 6765 745f 6365 6c6c 5f74 7970 6573 275d  get_cell_types']
-00026400: 203d 3d20 7463 740a 2020 2020 2020 2020   == tct.        
-00026410: 2020 2020 7463 745f 6c73 7420 3d20 7463      tct_lst = tc
-00026420: 742e 7370 6c69 7428 272c 2729 0a20 2020  t.split(',').   
-00026430: 2020 2020 2020 2020 2066 6f72 2063 7420           for ct 
-00026440: 696e 2074 6374 5f6c 7374 3a0a 2020 2020  in tct_lst:.    
-00026450: 2020 2020 2020 2020 2020 2020 6232 203d              b2 =
-00026460: 2064 665f 7072 6564 5b74 636f 6c5d 203d   df_pred[tcol] =
-00026470: 3d20 6374 0a20 2020 2020 2020 2020 2020  = ct.           
-00026480: 2020 2020 2062 6120 3d20 6261 207c 2028       ba = ba | (
-00026490: 6231 2662 3229 2020 2020 2020 2020 2020  b1&b2)          
-000264a0: 2020 2020 2020 0a20 2020 2020 2020 2062        .        b
-000264b0: 7561 203d 207e 6261 0a20 2020 2020 2020  ua = ~ba.       
-000264c0: 2062 5f63 7561 203d 2028 2862 7a29 2026   b_cua = ((bz) &
-000264d0: 2028 7e62 7429 2026 2028 6275 6129 290a   (~bt) & (bua)).
-000264e0: 2020 2020 2020 2020 625f 6561 203d 2028          b_ea = (
-000264f0: 2862 7a29 2026 2028 7e62 7429 2026 2028  (bz) & (~bt) & (
-00026500: 6261 2929 0a20 2020 2020 2020 2062 5f65  ba)).        b_e
-00026510: 7561 203d 2028 2862 7a29 2026 2028 6274  ua = ((bz) & (bt
-00026520: 2920 2620 2862 7561 2929 0a20 2020 2020  ) & (bua)).     
-00026530: 2020 2062 5f65 203d 2028 2862 7a29 2026     b_e = ((bz) &
-00026540: 2028 6274 2920 2620 287e 6275 6129 2026   (bt) & (~bua) &
-00026550: 2028 6466 5f70 7265 645b 7463 6f6c 5d20   (df_pred[tcol] 
-00026560: 213d 2064 665f 7072 6564 5b74 7275 7468  != df_pred[truth
-00026570: 5d29 290a 2020 2020 2020 2020 625f 6320  ])).        b_c 
-00026580: 3d20 2828 627a 2920 2620 2862 7429 2026  = ((bz) & (bt) &
-00026590: 2028 7e62 7561 2920 2620 2864 665f 7072   (~bua) & (df_pr
-000265a0: 6564 5b74 636f 6c5d 203d 3d20 6466 5f70  ed[tcol] == df_p
-000265b0: 7265 645b 7472 7574 685d 2929 0a20 2020  red[truth])).   
-000265c0: 2020 2020 200a 2020 2020 2020 2020 6e5f       .        n_
-000265d0: 636f 7272 6563 746c 795f 756e 6173 7369  correctly_unassi
-000265e0: 676e 6564 203d 206e 702e 7375 6d28 625f  gned = np.sum(b_
-000265f0: 6375 6129 2f6e 702e 7375 6d28 627a 290a  cua)/np.sum(bz).
-00026600: 2020 2020 2020 2020 6e5f 696e 636f 7272          n_incorr
-00026610: 6563 746c 795f 6173 7369 676e 6564 203d  ectly_assigned =
-00026620: 206e 702e 7375 6d28 625f 6561 292f 6e70   np.sum(b_ea)/np
-00026630: 2e73 756d 2862 7a29 0a20 2020 2020 2020  .sum(bz).       
-00026640: 206e 5f69 6e63 6f72 7265 6374 6c79 5f75   n_incorrectly_u
-00026650: 6e61 7373 6967 6e65 6420 3d20 6e70 2e73  nassigned = np.s
-00026660: 756d 2862 5f65 7561 292f 6e70 2e73 756d  um(b_eua)/np.sum
-00026670: 2862 7a29 0a20 2020 2020 2020 206e 5f69  (bz).        n_i
-00026680: 6e63 6f72 7265 6374 203d 206e 702e 7375  ncorrect = np.su
-00026690: 6d28 625f 6529 2f6e 702e 7375 6d28 627a  m(b_e)/np.sum(bz
-000266a0: 290a 2020 2020 2020 2020 6e5f 636f 7272  ).        n_corr
-000266b0: 6563 7420 3d20 6e70 2e73 756d 2862 5f63  ect = np.sum(b_c
-000266c0: 292f 6e70 2e73 756d 2862 7a29 0a20 2020  )/np.sum(bz).   
-000266d0: 2020 2020 200a 2020 2020 2020 2020 6466       .        df
-000266e0: 5f70 6572 665b 635d 203d 205b 6e5f 636f  _perf[c] = [n_co
-000266f0: 7272 6563 742c 206e 5f63 6f72 7265 6374  rrect, n_correct
-00026700: 6c79 5f75 6e61 7373 6967 6e65 642c 206e  ly_unassigned, n
-00026710: 5f69 6e63 6f72 7265 6374 6c79 5f75 6e61  _incorrectly_una
-00026720: 7373 6967 6e65 642c 205c 0a20 2020 2020  ssigned, \.     
-00026730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026740: 206e 5f69 6e63 6f72 7265 6374 6c79 5f61   n_incorrectly_a
-00026750: 7373 6967 6e65 642c 206e 5f69 6e63 6f72  ssigned, n_incor
-00026760: 7265 6374 5d0a 0a20 2020 2064 665f 7065  rect]..    df_pe
-00026770: 7266 203d 2064 665f 7065 7266 2a31 3030  rf = df_perf*100
-00026780: 0a20 2020 2064 665f 7065 7266 203d 2064  .    df_perf = d
-00026790: 665f 7065 7266 2e6c 6f63 5b5b 2743 272c  f_perf.loc[['C',
-000267a0: 2027 4555 4127 2c20 2745 272c 2027 4541   'EUA', 'E', 'EA
-000267b0: 272c 2027 4355 4127 5d2c 3a5d 0a20 2020  ', 'CUA'],:].   
-000267c0: 2064 665f 7065 7266 2e6c 6f63 5b27 4d65   df_perf.loc['Me
-000267d0: 7468 6f64 272c 3a5d 203d 206c 6973 7428  thod',:] = list(
-000267e0: 6466 5f70 6572 662e 636f 6c75 6d6e 732e  df_perf.columns.
-000267f0: 7661 6c75 6573 290a 2020 2020 6466 5f70  values).    df_p
-00026800: 6572 6620 3d20 6466 5f70 6572 662e 540a  erf = df_perf.T.
-00026810: 0a20 2020 2072 6574 7572 6e20 6466 5f70  .    return df_p
-00026820: 6572 660a                                erf.
+00025ba0: 2020 2020 2020 2020 2063 6f6d 625f 6d6b           comb_mk
+00025bb0: 7273 203d 2063 6f6d 625f 6d6b 7273 2c20  rs = comb_mkrs, 
+00025bc0: 7667 5f72 6f74 203d 2076 675f 726f 742c  vg_rot = vg_rot,
+00025bd0: 206d 696e 4e63 656c 6c73 203d 206d 696e   minNcells = min
+00025be0: 4e63 656c 6c73 290a 2020 2020 2020 2020  Ncells).        
+00025bf0: 2020 2020 2020 2020 2020 2020 6163 6e74              acnt
+00025c00: 202b 3d20 310a 0a20 2020 2066 6f72 206d   += 1..    for m
+00025c10: 2069 6e20 6d6c 7374 5f6d 3a0a 2020 2020   in mlst_m:.    
+00025c20: 2020 2020 6d6b 725f 6469 6374 5f6d 696e      mkr_dict_min
+00025c30: 6f72 2c20 6d6b 725f 6469 6374 5f6e 6567  or, mkr_dict_neg
+00025c40: 203d 205c 0a20 2020 2020 2020 2020 2020   = \.           
+00025c50: 2067 6574 5f6d 6172 6b65 7273 5f63 656c   get_markers_cel
+00025c60: 6c5f 7479 7065 286d 6b72 5f66 696c 652c  l_type(mkr_file,
+00025c70: 2074 6172 6765 745f 6365 6c6c 7320 3d20   target_cells = 
+00025c80: 5b6d 5d2c 2070 6e73 6831 3220 3d20 706e  [m], pnsh12 = pn
+00025c90: 7368 3132 2c0a 2020 2020 2020 2020 2020  sh12,.          
+00025ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025cb0: 7265 6d5f 636f 6d6d 6f6e 203d 2046 616c  rem_common = Fal
+00025cc0: 7365 2c20 7665 7262 6f73 6520 3d20 4661  se, verbose = Fa
+00025cd0: 6c73 6529 0a20 2020 2020 2020 2069 6620  lse).        if 
+00025ce0: 6d5b 305d 2021 3d20 2754 273a 0a20 2020  m[0] != 'T':.   
+00025cf0: 2020 2020 2020 2020 2074 6172 6765 745f           target_
+00025d00: 6c73 7420 3d20 6c69 7374 286d 6b72 5f64  lst = list(mkr_d
+00025d10: 6963 745f 6d69 6e6f 722e 6b65 7973 2829  ict_minor.keys()
+00025d20: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00025d30: 206c 656e 2874 6172 6765 745f 6c73 7429   len(target_lst)
+00025d40: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
+00025d50: 2020 2020 2020 7469 746c 6520 3d20 274d        title = 'M
+00025d60: 6172 6b65 7220 6578 7072 6573 7369 6f6e  arker expression
+00025d70: 206f 6620 2573 2720 2520 7461 7267 6574   of %s' % target
+00025d80: 5f6c 7374 5b30 5d0a 2020 2020 2020 2020  _lst[0].        
+00025d90: 2020 2020 2020 2020 666f 7220 7420 696e          for t in
+00025da0: 2074 6172 6765 745f 6c73 745b 313a 5d3a   target_lst[1:]:
+00025db0: 2074 6974 6c65 203d 2074 6974 6c65 202b   title = title +
+00025dc0: 2027 2c25 7327 2025 2074 0a20 2020 2020   ',%s' % t.     
+00025dd0: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+00025de0: 6e28 7469 746c 655f 7375 6666 6978 2920  n(title_suffix) 
+00025df0: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
+00025e00: 2020 2020 2020 2020 2074 6974 6c65 203d           title =
+00025e10: 2074 6974 6c65 202b 2027 2066 6f72 2025   title + ' for %
+00025e20: 7327 2025 2074 6974 6c65 5f73 7566 6669  s' % title_suffi
+00025e30: 780a 2020 2020 2020 2020 2020 2020 2020  x.              
+00025e40: 2020 706c 6f74 5f64 6f74 2861 6461 7461    plot_dot(adata
+00025e50: 2c20 7461 7267 6574 5f6c 7374 2c20 7479  , target_lst, ty
+00025e60: 7065 5f63 6f6c 2c20 6d6b 725f 6669 6c65  pe_col, mkr_file
+00025e70: 2c20 7469 746c 652c 200a 2020 2020 2020  , title, .      
+00025e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025e90: 2020 2020 7265 6e64 203d 2072 656e 642c      rend = rend,
+00025ea0: 206c 6576 656c 203d 206c 6576 656c 2c20   level = level, 
+00025eb0: 2320 6178 203d 2061 7873 5b61 636e 745d  # ax = axs[acnt]
+00025ec0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00025ed0: 2020 2020 2020 2020 2020 2020 6375 746f              cuto
+00025ee0: 6666 203d 2063 7574 6f66 662c 2070 6e73  ff = cutoff, pns
+00025ef0: 6831 3220 3d20 706e 7368 3132 2c20 7265  h12 = pnsh12, re
+00025f00: 6d5f 636d 6e20 3d20 7265 6d5f 636d 6e2c  m_cmn = rem_cmn,
+00025f10: 2064 6f74 5f6d 6178 203d 2064 6f74 5f6d   dot_max = dot_m
+00025f20: 782c 200a 2020 2020 2020 2020 2020 2020  x, .            
+00025f30: 2020 2020 2020 2020 2020 2020 2020 7377                sw
+00025f40: 6170 5f61 7820 3d20 7377 6170 5f61 782c  ap_ax = swap_ax,
+00025f50: 2074 6f5f 6578 636c 7564 6520 3d20 7479   to_exclude = ty
+00025f60: 7065 5f65 7863 2c20 4e70 7420 3d20 4e70  pe_exc, Npt = Np
+00025f70: 742c 200a 2020 2020 2020 2020 2020 2020  t, .            
+00025f80: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00025f90: 6f6d 625f 6d6b 7273 203d 2063 6f6d 625f  omb_mkrs = comb_
+00025fa0: 6d6b 7273 2c20 7667 5f72 6f74 203d 2076  mkrs, vg_rot = v
+00025fb0: 675f 726f 742c 206d 696e 4e63 656c 6c73  g_rot, minNcells
+00025fc0: 203d 206d 696e 4e63 656c 6c73 290a 2020   = minNcells).  
+00025fd0: 2020 2020 2020 2020 2020 2020 2020 6163                ac
+00025fe0: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
+00025ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026050: 2020 2020 2020 2020 2020 2020 2020 200a                 .
+00026060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026070: 0a64 6566 2067 6574 5f70 6572 665f 6578  .def get_perf_ex
+00026080: 7428 2064 665f 7072 6564 2c20 6365 6c6c  t( df_pred, cell
+00026090: 5f74 7970 6573 5f6e 6f74 5f63 6f6e 7369  _types_not_consi
+000260a0: 6465 722c 2074 7275 7468 203d 2027 6365  der, truth = 'ce
+000260b0: 6c6c 5f74 7970 655f 7472 7565 2720 293a  ll_type_true' ):
+000260c0: 0a20 2020 200a 2020 2020 6365 6c6c 5f74  .    .    cell_t
+000260d0: 7970 6520 3d20 6466 5f70 7265 645b 7472  ype = df_pred[tr
+000260e0: 7574 685d 0a20 2020 2062 6320 3d20 6e70  uth].    bc = np
+000260f0: 2e66 756c 6c28 6c65 6e28 6365 6c6c 5f74  .full(len(cell_t
+00026100: 7970 6529 2c20 4661 6c73 6529 0a20 2020  ype), False).   
+00026110: 2066 6f72 2063 7420 696e 2063 656c 6c5f   for ct in cell_
+00026120: 7479 7065 735f 6e6f 745f 636f 6e73 6964  types_not_consid
+00026130: 6572 3a0a 2020 2020 2020 2020 6263 203d  er:.        bc =
+00026140: 2062 6320 7c20 2863 656c 6c5f 7479 7065   bc | (cell_type
+00026150: 203d 3d20 6374 290a 2020 2020 6466 5f70   == ct).    df_p
+00026160: 7265 6420 3d20 6466 5f70 7265 642e 6c6f  red = df_pred.lo
+00026170: 635b 7e62 632c 3a5d 0a20 2020 2020 2020  c[~bc,:].       
+00026180: 200a 2020 2020 636f 6c73 203d 206c 6973   .    cols = lis
+00026190: 7428 6466 5f70 7265 642e 636f 6c75 6d6e  t(df_pred.column
+000261a0: 732e 7661 6c75 6573 290a 2020 2020 6966  s.values).    if
+000261b0: 2027 7461 7267 6574 5f63 656c 6c5f 7479   'target_cell_ty
+000261c0: 7065 7327 2069 6e20 636f 6c73 3a0a 2020  pes' in cols:.  
+000261d0: 2020 2020 2020 636f 6c73 2e72 656d 6f76        cols.remov
+000261e0: 6528 2774 6172 6765 745f 6365 6c6c 5f74  e('target_cell_t
+000261f0: 7970 6573 2729 0a20 2020 2069 6620 7472  ypes').    if tr
+00026200: 7574 6820 696e 2063 6f6c 733a 0a20 2020  uth in cols:.   
+00026210: 2020 2020 2063 6f6c 732e 7265 6d6f 7665       cols.remove
+00026220: 2874 7275 7468 290a 2020 2020 0a20 2020  (truth).    .   
+00026230: 2064 665f 7065 7266 203d 2070 642e 4461   df_perf = pd.Da
+00026240: 7461 4672 616d 6528 696e 6465 7820 3d20  taFrame(index = 
+00026250: 5b27 4327 2c20 2743 5541 272c 2027 4555  ['C', 'CUA', 'EU
+00026260: 4127 2c20 2745 4127 2c20 2745 275d 290a  A', 'EA', 'E']).
+00026270: 2020 2020 7463 7473 203d 206c 6973 7428      tcts = list(
+00026280: 7365 7428 6466 5f70 7265 645b 2774 6172  set(df_pred['tar
+00026290: 6765 745f 6365 6c6c 5f74 7970 6573 275d  get_cell_types']
+000262a0: 2929 0a20 2020 200a 2020 2020 6274 203d  )).    .    bt =
+000262b0: 206e 702e 6675 6c6c 2820 6466 5f70 7265   np.full( df_pre
+000262c0: 642e 7368 6170 655b 305d 2c20 4661 6c73  d.shape[0], Fals
+000262d0: 6520 290a 2020 2020 666f 7220 6b2c 2074  e ).    for k, t
+000262e0: 6374 2069 6e20 656e 756d 6572 6174 6528  ct in enumerate(
+000262f0: 7463 7473 293a 0a20 2020 2020 2020 2062  tcts):.        b
+00026300: 3120 3d20 6466 5f70 7265 645b 2774 6172  1 = df_pred['tar
+00026310: 6765 745f 6365 6c6c 5f74 7970 6573 275d  get_cell_types']
+00026320: 203d 3d20 7463 740a 2020 2020 2020 2020   == tct.        
+00026330: 7463 745f 6c73 7420 3d20 7463 742e 7370  tct_lst = tct.sp
+00026340: 6c69 7428 272c 2729 0a20 2020 2020 2020  lit(',').       
+00026350: 2066 6f72 2063 7420 696e 2074 6374 5f6c   for ct in tct_l
+00026360: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
+00026370: 6232 203d 2064 665f 7072 6564 5b74 7275  b2 = df_pred[tru
+00026380: 7468 5d20 3d3d 2063 740a 2020 2020 2020  th] == ct.      
+00026390: 2020 2020 2020 6274 203d 2062 7420 7c20        bt = bt | 
+000263a0: 2862 3126 6232 290a 2020 2020 2020 2020  (b1&b2).        
+000263b0: 2020 2020 2020 2020 0a20 2020 2062 7a20          .    bz 
+000263c0: 3d20 6466 5f70 7265 645b 7472 7574 685d  = df_pred[truth]
+000263d0: 2021 3d20 2755 6e6b 6e6f 776e 270a 2020   != 'Unknown'.  
+000263e0: 2020 6466 5f70 6572 665b 2769 6465 616c    df_perf['ideal
+000263f0: 275d 203d 205b 6e70 2e73 756d 2862 7a26  '] = [np.sum(bz&
+00026400: 6274 292f 6e70 2e73 756d 2862 7a29 2c20  bt)/np.sum(bz), 
+00026410: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+00026420: 2020 2020 2020 2020 2020 6e70 2e73 756d            np.sum
+00026430: 2862 7a26 287e 6274 2929 2f6e 702e 7375  (bz&(~bt))/np.su
+00026440: 6d28 627a 292c 2030 2c30 2c30 5d0a 2020  m(bz), 0,0,0].  
+00026450: 2020 2020 2020 0a20 2020 2066 6f72 2063        .    for c
+00026460: 2069 6e20 636f 6c73 3a0a 2020 2020 2020   in cols:.      
+00026470: 2020 7463 6f6c 203d 2063 2020 2020 2020    tcol = c      
+00026480: 2020 0a20 2020 2020 2020 2062 6120 3d20    .        ba = 
+00026490: 6e70 2e66 756c 6c28 2064 665f 7072 6564  np.full( df_pred
+000264a0: 2e73 6861 7065 5b30 5d2c 2046 616c 7365  .shape[0], False
+000264b0: 2029 0a20 2020 2020 2020 2066 6f72 206b   ).        for k
+000264c0: 2c20 7463 7420 696e 2065 6e75 6d65 7261  , tct in enumera
+000264d0: 7465 2874 6374 7329 3a0a 2020 2020 2020  te(tcts):.      
+000264e0: 2020 2020 2020 6231 203d 2064 665f 7072        b1 = df_pr
+000264f0: 6564 5b27 7461 7267 6574 5f63 656c 6c5f  ed['target_cell_
+00026500: 7479 7065 7327 5d20 3d3d 2074 6374 0a20  types'] == tct. 
+00026510: 2020 2020 2020 2020 2020 2074 6374 5f6c             tct_l
+00026520: 7374 203d 2074 6374 2e73 706c 6974 2827  st = tct.split('
+00026530: 2c27 290a 2020 2020 2020 2020 2020 2020  ,').            
+00026540: 666f 7220 6374 2069 6e20 7463 745f 6c73  for ct in tct_ls
+00026550: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00026560: 2020 2062 3220 3d20 6466 5f70 7265 645b     b2 = df_pred[
+00026570: 7463 6f6c 5d20 3d3d 2063 740a 2020 2020  tcol] == ct.    
+00026580: 2020 2020 2020 2020 2020 2020 6261 203d              ba =
+00026590: 2062 6120 7c20 2862 3126 6232 2920 2020   ba | (b1&b2)   
+000265a0: 2020 2020 2020 2020 2020 2020 200a 2020               .  
+000265b0: 2020 2020 2020 6275 6120 3d20 7e62 610a        bua = ~ba.
+000265c0: 2020 2020 2020 2020 625f 6375 6120 3d20          b_cua = 
+000265d0: 2828 627a 2920 2620 287e 6274 2920 2620  ((bz) & (~bt) & 
+000265e0: 2862 7561 2929 0a20 2020 2020 2020 2062  (bua)).        b
+000265f0: 5f65 6120 3d20 2828 627a 2920 2620 287e  _ea = ((bz) & (~
+00026600: 6274 2920 2620 2862 6129 290a 2020 2020  bt) & (ba)).    
+00026610: 2020 2020 625f 6575 6120 3d20 2828 627a      b_eua = ((bz
+00026620: 2920 2620 2862 7429 2026 2028 6275 6129  ) & (bt) & (bua)
+00026630: 290a 2020 2020 2020 2020 625f 6520 3d20  ).        b_e = 
+00026640: 2828 627a 2920 2620 2862 7429 2026 2028  ((bz) & (bt) & (
+00026650: 7e62 7561 2920 2620 2864 665f 7072 6564  ~bua) & (df_pred
+00026660: 5b74 636f 6c5d 2021 3d20 6466 5f70 7265  [tcol] != df_pre
+00026670: 645b 7472 7574 685d 2929 0a20 2020 2020  d[truth])).     
+00026680: 2020 2062 5f63 203d 2028 2862 7a29 2026     b_c = ((bz) &
+00026690: 2028 6274 2920 2620 287e 6275 6129 2026   (bt) & (~bua) &
+000266a0: 2028 6466 5f70 7265 645b 7463 6f6c 5d20   (df_pred[tcol] 
+000266b0: 3d3d 2064 665f 7072 6564 5b74 7275 7468  == df_pred[truth
+000266c0: 5d29 290a 2020 2020 2020 2020 0a20 2020  ])).        .   
+000266d0: 2020 2020 206e 5f63 6f72 7265 6374 6c79       n_correctly
+000266e0: 5f75 6e61 7373 6967 6e65 6420 3d20 6e70  _unassigned = np
+000266f0: 2e73 756d 2862 5f63 7561 292f 6e70 2e73  .sum(b_cua)/np.s
+00026700: 756d 2862 7a29 0a20 2020 2020 2020 206e  um(bz).        n
+00026710: 5f69 6e63 6f72 7265 6374 6c79 5f61 7373  _incorrectly_ass
+00026720: 6967 6e65 6420 3d20 6e70 2e73 756d 2862  igned = np.sum(b
+00026730: 5f65 6129 2f6e 702e 7375 6d28 627a 290a  _ea)/np.sum(bz).
+00026740: 2020 2020 2020 2020 6e5f 696e 636f 7272          n_incorr
+00026750: 6563 746c 795f 756e 6173 7369 676e 6564  ectly_unassigned
+00026760: 203d 206e 702e 7375 6d28 625f 6575 6129   = np.sum(b_eua)
+00026770: 2f6e 702e 7375 6d28 627a 290a 2020 2020  /np.sum(bz).    
+00026780: 2020 2020 6e5f 696e 636f 7272 6563 7420      n_incorrect 
+00026790: 3d20 6e70 2e73 756d 2862 5f65 292f 6e70  = np.sum(b_e)/np
+000267a0: 2e73 756d 2862 7a29 0a20 2020 2020 2020  .sum(bz).       
+000267b0: 206e 5f63 6f72 7265 6374 203d 206e 702e   n_correct = np.
+000267c0: 7375 6d28 625f 6329 2f6e 702e 7375 6d28  sum(b_c)/np.sum(
+000267d0: 627a 290a 2020 2020 2020 2020 0a20 2020  bz).        .   
+000267e0: 2020 2020 2064 665f 7065 7266 5b63 5d20       df_perf[c] 
+000267f0: 3d20 5b6e 5f63 6f72 7265 6374 2c20 6e5f  = [n_correct, n_
+00026800: 636f 7272 6563 746c 795f 756e 6173 7369  correctly_unassi
+00026810: 676e 6564 2c20 6e5f 696e 636f 7272 6563  gned, n_incorrec
+00026820: 746c 795f 756e 6173 7369 676e 6564 2c20  tly_unassigned, 
+00026830: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+00026840: 2020 2020 2020 2020 6e5f 696e 636f 7272          n_incorr
+00026850: 6563 746c 795f 6173 7369 676e 6564 2c20  ectly_assigned, 
+00026860: 6e5f 696e 636f 7272 6563 745d 0a0a 2020  n_incorrect]..  
+00026870: 2020 6466 5f70 6572 6620 3d20 6466 5f70    df_perf = df_p
+00026880: 6572 662a 3130 300a 2020 2020 6466 5f70  erf*100.    df_p
+00026890: 6572 6620 3d20 6466 5f70 6572 662e 6c6f  erf = df_perf.lo
+000268a0: 635b 5b27 4327 2c20 2745 5541 272c 2027  c[['C', 'EUA', '
+000268b0: 4527 2c20 2745 4127 2c20 2743 5541 275d  E', 'EA', 'CUA']
+000268c0: 2c3a 5d0a 2020 2020 6466 5f70 6572 662e  ,:].    df_perf.
+000268d0: 6c6f 635b 274d 6574 686f 6427 2c3a 5d20  loc['Method',:] 
+000268e0: 3d20 6c69 7374 2864 665f 7065 7266 2e63  = list(df_perf.c
+000268f0: 6f6c 756d 6e73 2e76 616c 7565 7329 0a20  olumns.values). 
+00026900: 2020 2064 665f 7065 7266 203d 2064 665f     df_perf = df_
+00026910: 7065 7266 2e54 0a0a 2020 2020 7265 7475  perf.T..    retu
+00026920: 726e 2064 665f 7065 7266 0a              rn df_perf.
```

### Comparing `mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/icnv.py` & `mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/icnv.py`

 * *Files identical despite different names*

### Comparing `mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib/misc.py` & `mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib/misc.py`

 * *Files identical despite different names*

### Comparing `mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib.egg-info/PKG-INFO` & `mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: mlbi-at-dku-lib
-Version: 0.2.9
+Version: 0.3.0
 Summary: Toolkits for single-cell RNA-Seq data analysis. (Wrapper functions for CellPhoneDB, GSEApy and InferCNVpy)
 Author-email: Seokhyun Yoon <syoon@dku.edu>
 License:                     GNU GENERAL PUBLIC LICENSE
                                Version 3, 29 June 2007
         
          Copyright (C) 2007 Free Software Foundation, Inc. <https://fsf.org/>
          Everyone is permitted to copy and distribute verbatim copies
```

### Comparing `mlbi_at_dku_lib-0.2.9/src/mlbi_at_dku_lib.egg-info/SOURCES.txt` & `mlbi_at_dku_lib-0.3.0/src/mlbi_at_dku_lib.egg-info/SOURCES.txt`

 * *Files identical despite different names*

